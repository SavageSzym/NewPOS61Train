/** 
* NP6majorversion=6.1.17
* NP6build=B193
* NP6scriptversion=2.58.02
* CreationDate=20.07.2011
*
* Copyright (c) 2009-2010 McDonald's IT Europe
*
* reports.nps
* This NPS file implements routines for generating reports.
*
* SOTEC History Changes
*
* Version		Date			Name			Detail Description
* 2.50.00		25.01.2010	Olga Illenseer		Take over from 6.1.16 Scripts	
* 2.50.01		01.02.2010	Olga Illenseer		Change the flow in reportPickList to add an additional text.
* 2.50.02		05.02.2010	Mihai Secareanu	Change the lenght of the retunArray in getOperationKindId
* 2.50.03		19.02.2010	Mihai Secareanu	remove the spaces from MSG_RECEIPT_TAX_AMMOUNT_TAX in receipt format
* 2.51.00		10.03.2010	Mihai Secaraenu	show gross amount for discount on cash report on POS
*										print  second receipt with product that will be delivred later
* 2.52.00		08.04.2010	Mihai Secareanu	HSA report reset varibles in all cases.
*										substract gift cert from breakfast amount,  dual point support
* 2.53.00		30.04.2010	Mihai Secareanu	coin dispenser  modification  + additional  float   fix  for computed cash and tender analise
*		    								HSA report with rush hour intervals and different cutting
* 2.53.01		11.05.2010 	Mihai Secareanu	correct ORB order number in case orderNumberRage is set to 2
* 2.54.00		28.05.2010	Mihai Secareanu
* 			18.05.2010	Olga Illenseer		fix for printing of the big order number on receipt
*			18.05.2010	Mihai Secareanu	HSA sale report for store wide request form POS and waystation website, calcualte the day offset 
*			25.05.2010	Mihai Secareanu	Read all receipt formating parameters from store-db just one time and store the value in global variables
* 2.54.03		25.06.2010 	Mihai Secareanu
*			22.06.2010	Olga Illenseer		Add PT dual point settings
*			23.06.2010	Mihai Secaraenu	add fix for value meal consolidate , remove this feauter efor UK and IE ( country ttat have bConsolidate seto to  true)		
*			23.06.2010 	Mihai Secareanu	Uk reports (still not tested for grill slip ) not officially delivered
* 2.54.05		02.07.2010	Mihai Secareanu
*										hide grill price not show the value meals's sandwich if is having just grill option
*							 			show gross aamount in tax section of the receipt for Ireland
* 2.54.07		19.07.2010	Mihai Secareanu   	remove redeclaration of xmlstoredb
* 2.55.00		29.07.2010 	Mihai Secareanu 	fix the breakfast sale amount
*
* 2.55.01		12.08.2010 	Mihai Secareanu	
*			09.08.2010 	Mihai Secarenu 	reportSosD10Fcr correct one wrong message , display total amount on 4 digits, display average with just one decimal point
*			12.08.2010 	Mihai Secareanu 	add past midnigth segments in SOS reportss
*			12.08.2010 	Mihai Secareanu 	ACSP8453854 solve issue raised
* 2.56.00		07.09.2010	Olga Illenseer		Implement the ORB number on receipt in function genericReceipt
*
* 2.56.02		07.10.2010	Mihai Secareanu	AT receipt problem Unit and total header line and tax header line 
*
* 2.56.08		17.12.2010	Mihai Secareanu	
*			08.12.2010	Olga Illenseer		Implement the ORB Image on receipt in function genericReceipt
*			16.122010	Mihai Secareanu	new grill receipt format for UK	
*			16.12.2010 	Mihai Secareanu	PT sign receipt 
* 2.56.09		20.12.2010	Mihai Secareanu	print deliver later receipt for picklist 
* 2.56.10 	11.01.2011	Mihai Secareanu	add secon receipt signature for refund for other coutries then Portugal (portugal already has this option) 
* 2.56.11		21.01.2011	Mihai Secareanu	add refund information for tender
* 2.56.17		24.03.2011	Mihai Secareanu 	do not print receipt in case fiscal printer is used (receipt will be automatically generated)
* 2.56.18		20.04.2011	Mihai Secareanu
*										customer e-cash receipt combine with order receipt
*			08.04.2011 	Flaviu Cibu 		grill label reverse fond for some special products 
*						Mihai Secareanu	PMIX report in case FVM set to true 	
*			23.05.2011 	Olga Illenseer	 	replaced Number by BigDecimal because of ACSP9198776 	
*2.56.21		30.05.2011	Mihai Secareanu		add 6.1.16 implmentation for printing reduction receipts
			01.06.2011	Mihai Secareanu		implment a parameter that will enable/disable the count of 100%  discount emp meals in GC for cash and HSA report
*2.58.00		22.06.2011	Mihai Secareanu	 	update detachChoice according to 6.1.17 RC20 release
*									ACSP9279745 6.1.17 RC12 HF6 SW Product Mix script error				
*/


 
 //***********REPORT_ISP**************
var MAX_TENDER_TYPES=50;
var CASHLESS_RANGE_INIT=21;
var CASHLESS_RANGE_END=40;	// it can't be greater thatn MAX_TENDER_TYPES
var ROUND_MODE_PERCENT=6;   // ROUND_HALF_EVEN
var ROUND_MODE_TC_AC=1;     // ROUND_DOWN

//*************************************
 
//******COMMON *********************
/** Output buffer used to generate report */
var outputBuffer 	= null;

/* Root node of XMLs */
var rootConfig		= null;
var rootCash		= null;
var rootPmix		= null;
var rootHourlySales	= null;
var rootView		= null;
var rootSOS			= null;
var rootCustom		= null;
var rootProduct		= null;
var rootOpenOrders	= null;

var rootSOSFC		= null;
var rootSOSDT		= null;
var rootSOSWT		= null;
var rootSOSMFY		= null;

var flagTypePos		= "";

var flagTypePodDT	= false;
var flagTypePodWT	= false;
var flagTypePodFC	= false;

var isRcpKiosk		= false;
var isKioskTPUI		= false; //PLE-94

/** Holds Language */
var LANG = null;

var productPMIXFamilyName =""; //need for FR Pmixfamily group
var uaildeCodesNumber =0; //needed for PT marketing contest
// start addition js for ACSP8002684 Newpos 6.1 Script Change Request for Drive Marketing Campaign Code
var driveCodesNumber =0; //needed for PT marketing contest DT
var PTCodesList = new Array();
// end addition js for ACSP8002684 Newpos 6.1 Script Change Request for Drive Marketing Campaign Code

// Temporary functions to prevent errors
function reportDummy(config) { return config; };
function reportOverring (config) { return config; };



/*JMARRARA*/
/**
 * Initialize all global data to be used by reports.nps
 *
 */
var orderIDLength = 4;
var displayShort = false;
var GrillItemsDisabled = false;
var consolidatePickList = "";
var displayShort_PickList =false;
var OrderNumberBigger = "";
var vmConsolidate = "";
var VATonKioskReceipt ="";
var printLaterReceipt=false;
var printLaterReceiptOnPickList  =false;
var commentCode = "";
var hideGrillPrice = false;
var DuplicateReceipt = "";
var DuplicateReceiptWithBarCode = "";
var Picklist = "";
var PicklistWithBarCode = "";
var OrderNumberFormatKiosk  ="";
var OrderNumberFormatPos  ="";
var crewMealReieverSignature  = "";
var newRefund ="";
var contest = "";
var signReceiptEnable = false;
//var certNumber ="00000";
var privatekeyPath ="";
var publickeyPath ="";
var isFiscalEnable=false;
var combineOrderEcashReceipt=false;
var storeDB_choices = "";
var printReductionReceipt = false;
var notCount100ValueMealGC = false;

initReportGlobals();


API.dbg("orderIDLength "+ orderIDLength);
API.dbg("displayShort "+ displayShort);
API.dbg("GrillItemsDisabled "+ GrillItemsDisabled);
API.dbg("consolidatePickList "+ consolidatePickList);
API.dbg("displayShort_PickList "+ displayShort_PickList);
API.dbg("OrderNumberBigger "+ OrderNumberBigger);
API.dbg(" vmConsolidate "+ vmConsolidate);
API.dbg("VATonKioskReceipt "+ VATonKioskReceipt);
API.dbg("printLaterReceipt "+ printLaterReceipt);
API.dbg("printLaterReceiptOnPickList "+ printLaterReceiptOnPickList);
API.dbg("commentCode "+ commentCode);
API.dbg("hideGrillPrice "+ hideGrillPrice);
API.dbg("DuplicateReceipt "+ DuplicateReceipt);
API.dbg("DuplicateReceiptWithBarCode "+ DuplicateReceiptWithBarCode);
API.dbg("Picklist "+ Picklist);
API.dbg("PicklistWithBarCode "+ PicklistWithBarCode);
API.dbg("OrderNumberFormatKiosk "+ OrderNumberFormatKiosk);
API.dbg("OrderNumberFormatPos  "+ OrderNumberFormatPos);
API.dbg("crewMealReieverSignature  "+ crewMealReieverSignature);
API.dbg("newRefund  "+ newRefund);
API.dbg("contest "+ contest);
API.dbg("signReceiptEnable "+ signReceiptEnable);
//API.dbg("certNumber "+ certNumber);
API.dbg("publickeyPath "+ publickeyPath);
API.dbg("privatekeyPath "+ privatekeyPath);
API.dbg("isFiscalEnable "+ isFiscalEnable);
API.dbg("combineOrderEcashReceipt " + combineOrderEcashReceipt);
API.dbg("storeDB_choices " + storeDB_choices);
API.dbg("PrintReductionReceipt " + printReductionReceipt);
API.dbg("notCount100ValueMealGC " + notCount100ValueMealGC);

function initReportGlobals() {
    if(typeof(xmlStoreDB) =="undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}

    storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"OrderNumberRange\").@value";
    posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"OrderNumberRange\").@value";
    orderIDLength = getConfigValue(storedbPath , posdbPath);

    API.dbg("initReportGlobals orderIDLength: " + orderIDLength + "");
    if(orderIDLength == "") {
        //is default
        orderIDLength  = 4;
    }
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"receiptDisplayShortName\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"receiptDisplayShortName\").@value";
	displayShort = getConfigValue(storedbPath , posdbPath) == "true";
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillItemsDisabled\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillItemsDisabled\").@value";
	GrillItemsDisabled = getConfigValue(storedbPath , posdbPath) == "true";
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"ConsolidatedReportPickList\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"ConsolidatedReportPickList\").@value";
	consolidatePickList = getConfigValue(storedbPath , posdbPath);
		
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"pickListDisplayShortName\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"pickListDisplayShortName\").@value";
	displayShort_PickList = getConfigValue(storedbPath , posdbPath) == "true";

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberBigger\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberBigger\").@value";
	OrderNumberBigger = getConfigValue(storedbPath, posdbPath);
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"ValueMeal\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"ValueMeal\").@value"
 	vmConsolidate = getConfigValue(storedbPath, posdbPath);
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"VATNumberOnKioskReceipt\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"VATNumberOnKioskReceipt\").@value";
 	VATonKioskReceipt = getConfigValue(storedbPath, posdbPath);
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"PrintLaterReceipt\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"PrintLaterReceipt\").@value";
	printLaterReceipt = getConfigValue(storedbPath, posdbPath)=="true";
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"PrintLaterReceiptOnPickList\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"PrintLaterReceiptOnPickList\").@value";
	printLaterReceiptOnPickList = getConfigValue(storedbPath, posdbPath)=="true";
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CommentCode\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CommentCode\").@value";
	commentCode = getConfigValue(storedbPath, posdbPath);
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"hideGrillItemPrice\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"hideGrillItemPrice\").@value";
	hideGrillPrice = getConfigValue(storedbPath , posdbPath) == "true";
	
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"DuplicateReceipt\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"DuplicateReceipt\").@value";
	DuplicateReceipt = getConfigValue(storedbPath, posdbPath);

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"DuplicateReceiptWithBarCode\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"DuplicateReceiptWithBarCode\").@value";
	DuplicateReceiptWithBarCode = getConfigValue(storedbPath, posdbPath);

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"Picklist\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"Picklist\").@value";
	Picklist = getConfigValue(storedbPath, posdbPath);

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"PicklistWithBarCode\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"PicklistWithBarCode\").@value";
	PicklistWithBarCode = getConfigValue(storedbPath, posdbPath);
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderNumberFormat\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderNumberFormat\").@value";
	OrderNumberFormatKiosk = getConfigValue(storedbPath, posdbPath);
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberFormat\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberFormat\").@value";
	OrderNumberFormatPos = getConfigValue(storedbPath, posdbPath);
	
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CrewMealReceiverSignature\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CrewMealReceiverSignature\").@value";
 	crewMealReieverSignature = getConfigValue(storedbPath, posdbPath);
	
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"EnableRefundSignaturesControl\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"EnableRefundSignaturesControl\").@value";
 	newRefund = getConfigValue(storedbPath, posdbPath) =="true";
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"UaildeContest\").Parameter.(@name==\"Active\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"UaildeContest\").Parameter.(@name==\"Active\").@value";
 	contest = getConfigValue(storedbPath, posdbPath);
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"SignReceipt\").Parameter.(@name==\"signReceiptEnable\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"SignReceipt\").Parameter.(@name==\"signReceiptEnable\").@value";
 	signReceiptEnable = getConfigValue(storedbPath, posdbPath) == "true";
	
	/*storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"SignReceipt\").Parameter.(@name==\"CertificateNumber\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"SignReceipt\").Parameter.(@name==\"CertificateNumber\").@value";
 	certNumber = getConfigValue(storedbPath, posdbPath);*/
			
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"SignReceipt\").Parameter.(@name==\"signaturePublicFile\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"SignReceipt\").Parameter.(@name==\"signaturePublicFile\").@value";
 	publickeyPath = getConfigValue(storedbPath, posdbPath);
	if(publickeyPath  =="")
	{
		publickeyPath= "..\\\\PosData\\\\public.pem";
	}
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"SignReceipt\").Parameter.(@name==\"signaturePrivateFile\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"SignReceipt\").Parameter.(@name==\"signaturePrivateFile\").@value";
 	privatekeyPath= getConfigValue(storedbPath, posdbPath);
	if(privatekeyPath =="")
	{
		privatekeyPath = "..\\\\PosData\\\\private.pem";
	}
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Fiscal\").Parameter.(@name==\"IsFiscalEnable\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Fiscal\").Parameter.(@name==\"IsFiscalEnable\").@value";
 	isFiscalEnable= getConfigValue(storedbPath, posdbPath) == "true";
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Cashless\").Parameter.(@name==\"CombineOrderEcashReceipt\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Cashless\").Parameter.(@name==\"CombineOrderEcashReceipt\").@value";
 	combineOrderEcashReceipt= getConfigValue(storedbPath, posdbPath) == "true"; 
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OperationMode\").Parameter.(@name==\"SolveOpenChoices\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OperationMode\").Parameter.(@name==\"SolveOpenChoices\").@value";
 	storeDB_choices= getConfigValue(storedbPath, posdbPath); 
		
	//MS 27.04.2011 add receipt for reduction operation
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OperationMode\").Parameter.(@name==\"PrintReductionReceipt\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OperationMode\").Parameter.(@name==\"PrintReductionReceipt\").@value";
 	printReductionReceipt = getConfigValue(storedbPath, posdbPath) == "true"; 
	
	//MS 30.05.2011 add receipt for reduction operation
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"DoNotCountEM100TC\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"DoNotCountEM100TC\").@value";
 	notCount100ValueMealGC = getConfigValue(storedbPath, posdbPath) == "true"; 	

   /*
    * Helper function  this is already declared in businessCOmponentsLocal but is not seen at production level so it needs to be declare in here too.
    * Parameters: storeDbPath - path to the desired parameter in store-db
    *			  psoDbpath -path to the desired parameter in pos-db
    * Returns the value of a configuration parameter
    */
     function getConfigValue(storeDbPath, posDbPath)
     {
		if(posDbPath!="" && posDbPath !=null)
		{
			var value = eval("xmlPosDB."+posDbPath);
			if(value+""!="")
			{
				return  value;
			}
		}
		return  eval("xmlStoreDB."+storeDbPath)+"";
     }
}

/*Author Mihai Secareanu
//Description write the private key
*/
function writesPublicKey()
{
	var publicKey = "-----BEGIN PUBLIC KEY-----\n\
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDIRUZKB8crjHD1NXD1UTcafpYc\n\
/eKqjFrdcayoN9CUb+qQobZrlUpg811DCz0jdCuidj672wRlRXThROKqlKxnMSI6\n\
PV1aDD7wltCTDYlVIyNdrA9/7glBQfLdSThaxdgXG805t68sgaNDSnuXtBB4KJHC\n\
NGaq/xZXN6m9NhiaHwIDAQAB\n\
-----END PUBLIC KEY-----\n\
"
	var file = new File(publickeyPath);
	file.open("w");
	file.write(publicKey);
}

/*Author Mihai Secareanu
//Description write the public key
*/
function writesPrivateKey()
{
	var privateKey = "-----BEGIN RSA PRIVATE KEY-----\n\
MIICXAIBAAKBgQDIRUZKB8crjHD1NXD1UTcafpYc/eKqjFrdcayoN9CUb+qQobZr\n\
lUpg811DCz0jdCuidj672wRlRXThROKqlKxnMSI6PV1aDD7wltCTDYlVIyNdrA9/\n\
7glBQfLdSThaxdgXG805t68sgaNDSnuXtBB4KJHCNGaq/xZXN6m9NhiaHwIDAQAB\n\
AoGBALs6cGUDcoNXD79ej9T4cXCWiZZfEIprHwPJoyW80IYFPyCp3lYjwt5yhm0I\n\
U8cSczy2GR4curZGwedcNCBPUACc3gBuEAmSb7ojSUQSAthsiEVgYDkbKwDaaEPL\n\
Dm59xJYFIU9eO07PkEwbfuMzBma5NKdwtd0gklYEvBCNAPQZAkEA8aK8WLncfaFB\n\
UsFVM/dAEAd0jFbFLnNjfZTXZqay1AwQ+io54jOgXFlRcaCwQeU1KOVAE89v1Q9Z\n\
NFH5jrk+TQJBANQtCTn6dpTfsOH/V3lmLu662WX13lRAveSvl0FE491YCQyNOWM+\n\
w/5ItIPG0xCKZOpkaLv54rH+15OdZxmfKBsCQCfFlGC6PtuCxkC7x61k/etlfr52\n\
rb/miDKsZAPmXjrevZCfkKV1v+hTXz9npntCIczYZwKbuxmDjDg7Yesm/GUCQDZP\n\
HMh5Yrbylu0SFcreK+8xZoohp/n65GBPzbCIOKckbJSI5YKQw0woQgRk9QuL0Q7q\n\
CqDq8mrLJ1UCeixlv7cCQG+SPICwL+G2SHo20LnBH682lMaRdAHGDMkKLcrxYLI9\n\
sQccu0HrPP3Vw22EF0S8QGTSp5bvfzIPpzvIeaEqznE=\n\
-----END RSA PRIVATE KEY-----\n\
"
	var file = new File(privatekeyPath);
	file.open("w");
	file.write(privateKey);
	
}

function writesSignFiles()
{
	if(signReceiptEnable ==true)
	{
		 writesPublicKey();
		 writesPrivateKey();
	}	
}


function initGlobalt()
{
	/** Output buffer used to generate report */
	outputBuffer = new StringBuffer();
	//outputBuffer.append("<@MarginOn>");


	/* Root node of XMLs */
	rootConfig		= null;
	rootCash		= null;
	rootPmix		= null;
	rootHourlySales	= null;
	rootView		= null;
	rootSOS			= null;
	rootCustom		= null;
	rootProduct		= null;
	rootOpenOrders  = null;

	rootSOSFC		= null;
	rootSOSDT		= null;
	rootSOSWT		= null;
	rootSOSMFY		= null;

	flagTypePos		= "";
	flagTypePodDT	= false;
	flagTypePodWT	= false;
	flagTypePodFC	= false;
}

function initXMLCashReport()
{
	/* Root node of XMLs */
	rootConfig		= null;
	rootCash		= null;
	rootPmix		= null;
	rootHourlySales	= null;
	rootView		= null;
	rootSOS			= null;
	rootCustom		= null;
	rootProduct		= null;
	rootOpenOrders  = null;

	rootSOSFC		= null;
	rootSOSDT		= null;
	rootSOSWT		= null;
	rootSOSMFY		= null;

	flagTypePos		= "";
	flagTypePodDT	= false;
	flagTypePodWT	= false;
	flagTypePodFC	= false;
}

/***************************************/
/***************************************/

/**
 * PUBLIC
 * Implements the customer receipt
 * Needed data types: orderId
 * @author Celso
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function orderIdBigger(orderId) 
{
	if(typeof(xmlStoreDB) =="undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}
	var Country = (xmlStoreDB.StoreDB.StoreProfile.StoreDetails.Country).toUpperCase();
	if(Country =="UK")
	{
		outputBuffer.append(API.getLocalMsg("MSG_RECEIPT_ORDER_NO")+"   ");
		outputBuffer.append("<@DoubleReverseOn>");
		outputBuffer.append(API.center(orderId, 4));
		outputBuffer.append("<@DoubleReverseOff>");
		outputBuffer.append("\n");
		addLine();
	}
	else
	{
		outputBuffer.append("<@DoubleReverseOn>");
		addLine(API.center(orderId, 8));
		outputBuffer.append("<@DoubleReverseOff>");
	}
	
}

/**
 * PRIVATE
 * Calculate mod 43 check digit for bar code
 * @author fernando.vicente
 */
function code39CheckDigit(varBarcode)
{
	var charSet = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-. $/+%";
	var subtotal = 0;
	var pos = 0;
	var str = "" + varBarcode.toString();
	for(var i = 0; i < str.length; i++) {
		var ch = "" + str[i];
		pos = charSet.indexOf(ch);
		if(pos > -1) {
			subtotal += pos;
		}
	}
	subtotal = subtotal % 43;
	return charSet[subtotal];
}

/**
 * PUBLIC
 * Implements the barCode
 * Needed data types: VIEW
 * @author Celso
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function barCode(varBarcode)
{
	var varBarcodeFormat = API.formatNumber(Number(varBarcode), "00", 2);
	startBarCode();
	outputBuffer.append(varBarcodeFormat);
	outputBuffer.append(code39CheckDigit(varBarcodeFormat));
	endBarCode();
}
/**
 * PUBLIC
 * Implements the barCode with a concentrated number from Order ID and POS ID
 * Needed data types: VIEW
 * Return: -
 * @author Olga Illenseer
 */
function barCodeWithPOSID(view)
{
	var varBarcodeFormat =GetConcentratedPOSAndOrderID(view);
	API.dbg("barCodeWithPOSID varBarcodeFormat: " + varBarcodeFormat);
	startBarCode();
	outputBuffer.append(varBarcodeFormat);
	outputBuffer.append(code39CheckDigit(varBarcodeFormat));
	endBarCode();
}

/**
 * PUBLIC
 * Generate a concentrated number from Order ID and POS ID
 * Needed data types: VIEW
 * Return: The number as string
 * @author Olga Illenseer
 */
var OrderNumberFormat = "";
var PosIdFormat = "";
var OrderIdFormat = "";
var OrderNumberSeparator = "";
var getConfiguratioValue = true;
function GetConcentratedPOSAndOrderID(view)
{
	var ONumber = "0";
	var OrderNumber = view.@orderId;
	var POSID =  toInt(view.@orderKey.substring(3, 7));
	
	var PODCSO = 8;
	var isFromKiosk 	= (Number(view.@pod) == PODCSO);

	//08.03.2010 OI replaced all BusinessObjectHelper parts
	if(getConfiguratioValue == true) //(MS) get the configuration value just once
	{
		getConfiguratioValue = false;
		storedbPath = "";
		posdbPath = "";
		OrderNumberFormat = "";
		PosIdFormat = "";
		OrderIdFormat = "";
		OrderNumberSeparator = "";
		var storedbPath = "";
		var posdbPath = "";
		if(isFromKiosk)
		{
			storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderNumberFormat\").@value";
			posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderNumberFormat\").@value";
			OrderNumberFormat = getConfigValue(storedbPath, posdbPath);

			storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"PosIdFormat\").@value";
			posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"PosIdFormat\").@value";
			PosIdFormat = getConfigValue(storedbPath, posdbPath);

			storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderIdFormat\").@value";
			posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderIdFormat\").@value";
			OrderIdFormat = getConfigValue(storedbPath, posdbPath);

			storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderNumberSeperator\").@value";
			posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderNumberSeperator\").@value";
			OrderNumberSeparator = getConfigValue(storedbPath, posdbPath);
		}

		if(OrderNumberFormat == "")
		{
			storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberFormat\").@value";
			posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberFormat\").@value";
			OrderNumberFormat = getConfigValue(storedbPath, posdbPath);
		}

		if(PosIdFormat == "")
		{
			storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"PosIdFormat\").@value";
			posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"PosIdFormat\").@value";
			PosIdFormat = getConfigValue(storedbPath, posdbPath);
		}

		if(OrderIdFormat == "")
		{
			storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderIdFormat\").@value";
			posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderIdFormat\").@value";
			OrderIdFormat = getConfigValue(storedbPath, posdbPath);
		}

		if(OrderNumberSeparator == "")
		{
			storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberSeperator\").@value";
			posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberSeperator\").@value";
			OrderNumberSeparator = getConfigValue(storedbPath, posdbPath);
		}
	}
	API.dbg("GetConcentratedPOSAndOrderID OrderNumber: " + OrderNumber + " POSID: " + POSID + " isFromKiosk: " + isFromKiosk + " OrderNumberFormat: " + OrderNumberFormat + " PosIdFormat: " + PosIdFormat + " OrderIdFormat: " + OrderIdFormat + " OrderNumberSeparator: " + OrderNumberSeparator);
	//Check for order number format
	API.dbg("GetConcentratedPOSAndOrderID OrderNumberlength " + OrderNumber.length() +" OrderIdFormatlength "+OrderIdFormat.length);

	
	
	
	
	//Check for order number format
	if(OrderNumberFormat == "1")
	{
		API.dbg("GetConcentratedPOSAndOrderID entering if");
		//get the POS ID in the correct format
		var PosIdStr = API.formatNumber(Number(POSID), "00", 2).toString();
		if(PosIdFormat != null && PosIdFormat.length > 0 && toInt(PosIdFormat) == 0)
		{
			PosIdStr = API.formatNumber(Number(POSID), PosIdFormat, PosIdFormat.length).toString();
		}

		// get the Order Number in the correct format
		var OrderIdStr = API.formatNumber(Number(OrderNumber), "0000", 4).toString(); //default 4 digit order number
		API.dbg("GetConcentratedPOSAndOrderID OrderIdFormat "+ OrderIdFormat +" OrderIdFormatlength "+OrderIdFormat.length+ " toIntOrderIdFormat "+toInt(OrderIdFormat)); 
		if(OrderIdFormat != null && OrderIdFormat.length > 0 && toInt(OrderIdFormat) == 0) // if the order format is different  ( less then 4 digits)
		{
			//18.05.2010 OI replaced OrderIdStr creation because the privious doesn't work
			OrderIdStr = API.formatNumber(Number(OrderNumber), OrderIdFormat, OrderIdFormat.length).toString(); 
			/*if(Number(OrderNumber.length()) > Number(OrderIdFormat.length))
			{   //we must trim it 
				API.dbg("Sotec orderNumber "+ OrderNumber);
				OrderIdStr = OrderNumber.substr((OrderNumber+"").length-OrderIdFormat.length,Number((OrderNumber+"").length));
				API.dbg("Sotec orderNumber "+ OrderIdStr);
			}
			if(Number(OrderNumber.length()) == Number(OrderIdFormat.length))
			{
				OrderIdStr = OrderNumber+"";
				API.dbg("Sotec orderNumber "+ OrderIdStr);
			}*/
		}

		if(OrderNumberSeparator != null)
		{
			// Pos ID + Seperator	+	Order Number
			ONumber = PosIdStr + OrderNumberSeparator + OrderIdStr;
		}
		else
		{
			//The number without seperator
			ONumber = PosIdStr + OrderIdStr;
		}
		
		
	}
	else
	{
		API.dbg("GetConcentratedPOSAndOrderID without formating stuff");
		//we have no order format so we print a simple order number like for a normal picklist
		ONumber = API.formatNumber(Number(OrderNumber), "00", 2);
	}
	
	return ONumber;
}
//****************** END COMMON*************

//******************report_IPS.nps**************
/**
 * PUBLIC
 * Implements the Salad - Wrap Claim receipt
 * Needed data types: VIEW
 * @author Celso
  */
//the  message properties are  taken from report.nps 
//the   variable thereIsNotSalads is taken from report_isp.nps
function reportSaladWrapClaim(config, data) {


	
	var SALADS = 10;
	var LIGHT  = 1;
	var ONLY   = 2;
	if(init(config, data, Array("VIEW"), "RECPT") != 0){
		return getResponse();
	}	
	
	// Order information
	var showCanceledItems="false";	
	var prnPickList = true;
	
	var view = rootView.View;
	// Check Refund
	var isRefund = (view.@transactionKind == TRANS_KIND_REFUND);
	var thereIsNotSalads = (rootView.View.ItemView.(familyGroup==SALADS && quantity > 0).length() == 0);  //report.nps without quantity>0
	if(isRefund || thereIsNotSalads) {
		return getResponse();	
	}
	
	addLine(SEP_UL);
	addLine();
	startBoldSize2();
		addLine(API.center(API.getLocalMsg("MSG_RECEIPT_SALAD_WRAP"), 19));
		addLine(API.center(API.getLocalMsg("MSG_RECEIPT_CLAIM"), 19));
	endBoldSize2();
	addLine();	
	
	var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
	var kvsOrder = "#ORD " +majorMinor;
	
	var posId = " " + API.getLocalMsg("MSG_RECEIPT_REG")  + " " + toInt(view.@orderKey.substring(3, 7)) + "-"; // Eg: POS0001:89 - > KS#1
	var date = API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss");
	var strLine = kvsOrder + posId;
	addLine(strLine + API.setOnRight(date, COLS-strLine.length));
	addLine();

	var flagdisplayOrder=false;
	// Create array to seach duplicate displayOrder
	var displayOrderArray = new Array();
	for each (var item in view.ItemView) {
		if (Number(item.level) == 0) {
			displayOrderArray.push({id:Number(item.displayOrder)});
		}
	}
	// Sort displayOrder Array
	displayOrderArray.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));})		
	//Seach duplicate displayOrder
	for(var i = 1; i < displayOrderArray.length; i++) {
		if(displayOrderArray[i-1].id == displayOrderArray[i].id){
			// There is duplicate displayOrder
			flagdisplayOrder=true;
			break;
		}
	}
	
	// Create array with sale items
	var newViewArray = new Array();
	var key = "000000000";
	var displayOrder = "000000000";
	var productCode = "";
	for each (var item in view.ItemView) {
	
		if (Number(item.familyGroup) != SALADS) {
			continue;
		}
	
		if (Number(item.level) == 0) {
			key = API.formatNumber(Number(item.displayOrder), "000000000", 9)
		}
		displayOrder = API.formatNumber(Number(item.displayOrder), "000000000", 9)
		if (flagdisplayOrder==true) {
			productCode = API.formatNumber(Number(item.productCode), "00000", 5)
		}
		// Create key to sort
//		var aux = String(displayOrder)+Number(item.level)+String(productCode);
		var aux = String(key) + Number(item.level) + String(displayOrder)+ String(productCode);		
		newViewArray.push({id:String(aux), item:String(item)});
	}
	// Sort array with sale items
	newViewArray.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));});		
	
	var sortView = new XML("<View/>");
	for(var i = 0; i < newViewArray.length; i++) {
		var ItemView = new XML(newViewArray[i].item);
		sortView.ItemView+=ItemView;
	}
	
	// Adds sale items
	var qtyLevelZero=1;
	var qtyViewItem = sortView.ItemView.length();
	var iItem = 0;
	for each (var item in sortView.ItemView) {
		iItem++;
		if (item.level == 0) {
			qtyLevelZero = Number(item.quantity);
		}
		if((showCanceledItems == "true") || (Number(item.quantity) != 0) || (item.specialModifiers == LIGHT) || (item.specialModifiers == ONLY)) {
			if (qtyLevelZero != 0) {
				var childNode = false;
				for(var i = iItem; i < qtyViewItem; i++) {
					var childView = sortView.ItemView[i];
					if(Number(item.level) > Number(childView.level)) {
						break;
					}
					if(childView.isGrillLine == "true") {
						childNode = true;
					}
				}
				if(!((Number(item.level) != 0) && (item.isGrillLine == "false") && (item.productType == 2)) || (childNode == true)) {
					addItemLine(item,qtyLevelZero);
				}
			}
		}
	}
	
	addLine();
	addLine(center(API.getLocalMsg("MSG_RECEIPT_PRESENT_THIS_CLAIM_TO")));
	addLine(center(API.getLocalMsg("MSG_RECEIPT_THE_CUSTOM_SALAD_CHEF")));
	addLine(SEP_UL);

	addLine();
	addLine();
	addLine();
	addLine();
	addLine();
	addLine();	
	return getResponse();
		
	/** Adds an item description given an <ItemView> tag */
	function addItemLine(item, qtyLevelZero) 
	{
		if(item.tbdStatus =="2")
		{
			return;
		}
		var ident = "";
		var level = toInt(item.level);
		
		var itemClass = item.productType.length();
		if (itemClass != 0) {
			if (item.productType == 4) {
				return;
			}
		}
		
		for(var i=1; i<level; i++) {
			ident += " ";
		}
		if (item.level == 0) {
			qtyLevelZero = 1;
		}
		var aux = item.quantity  * qtyLevelZero;
		var qty = API.setOnRight(aux, 3);
		var name = item.longName;
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"receiptDisplayShortName\").@value"; 
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"receiptDisplayShortName\").@value";
		var displayShort = getConfigValue(storedbPath , posdbPath);
		*/
		if (displayShort==true) {
			name = item.description; //PLE-94
		}
		var compl = "";
		if(toInt(item.quantityPromo) != 0) {
			compl = item.quantityPromo + "P";
		}
		var line = null;
		if(item.isGrillLine == "true") {
			line = "    " + ident + getGrillDescription(item, true);
		}else {
			line = ident + qty + " " + name;
		}
		line = API.setOnLeft(line, COLS-compl.length) + compl;
		//last test if is grill line and we do not want to display grill item on the receipt that we should not add the line
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillItemsDisabled\").@value"; 
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillItemsDisabled\").@value";
		var GrillItemsDisabled = getConfigValue(storedbPath , posdbPath) == "true";
		*/
		if(GrillItemsDisabled == true)
		{
			if(item.isGrillLine == "true")
			{
				return;
			}
			else // no grill line
			{
				//in case of sadwich for the value meal we do not have to display it  because is only added because of the grill instruction
				//get the first product with the same itemCode
				if(Number(item.prodAction) == 0 && Number(item.level) !=0 &&  Number(item.productType)  == 2) //is the sandwich of a value meal 
				{
					//check all subitems of the current product.
					//get the value meal
					var products = view.ItemView.(itemCode == item.itemCode);
					var foundProduct = false;
					var showLine = false;
					for(var t= 0; t < products.length();t++)
					{
						if(foundProduct ==true)
						{
							//get sub items
							if(Number(products[t].level) > Number(item.level))
							{
								 //if is not a grill line then we should show the current product
								 if(products[t].isGrillLine !="true")
								 {
									showLine = true;
									break;
								 }
							}
							else
							{
								break;
							}
						}
						if(products[t].productCode == item.productCode) //we found the current product
						{
							foundProduct =true;
						}
					}
					if(showLine == true)
					{
						addLine(line);
					}
					return;
				}
				else
				{
					addLine(line);
				}
			}
		}
		else
		{
			addLine(line);
		}
	}
};

//*************REPORT_ISP.nps**************************
// Detach the choices of the view
function detachChoice (view, newViewArray, showAsSinglePrice) {
    // Create array with sale items
    var itemChoice=new Array();
    var qtyPromoLevelZero=0;
    var qtyLevelZero=0;
    var qtyViewItem=view.ItemView.length();
	var lastlevel = 0;
	var accumulatedPromoQty=0;
    var accumulatedQty=0;
    
    for(var i=0; i < qtyViewItem; i++) {
        var item=view.ItemView[i];
		var itemLevel = Number(item.level);
        if(Number(item.level) == 0) {
            qtyLevelZero=Number(item.quantity);
            qtyPromoLevelZero=Number(item.quantityPromo);
			accumulatedQty = qtyLevelZero;
			accumulatedPromoQty = qtyPromoLevelZero;
			lastlevel = 0;
        }
		
		if(itemLevel > lastlevel) {
			accumulatedQty *= Number(item.quantity);
			// The promo quantity of items in level different from zero need to be calculated according to the quantity 
			accumulatedPromoQty *= Number(item.quantity);
        }
		else {
			accumulatedQty = qtyLevelZero;
			accumulatedPromoQty = qtyPromoLevelZero;
		}
		
        // Verify Choice
        if((Number(item.level) > 0) && (Number(item.prodAction) == 3)) {
            if(Number(item.productType) != 4) {
                // This is Choice
                item.quantityPromo=accumulatedPromoQty;
                item.quantity=accumulatedQty;
                var levelChoice=Number(item.level);
                item.level=0;
                item.choiceLevel = levelChoice;
                if(showAsSinglePrice==true) {
                    newViewArray.push({item:XML(item)});
                } else {
                    itemChoice.push({item:XML(item)});
                }
                for(var j=i+1; j < qtyViewItem; j++) {
                    var itemChoiceB=view.ItemView[j];
                    if(itemChoiceB.level > levelChoice) {
                        itemChoiceB.level-=levelChoice;
                        itemChoiceB.quantity*=item.quantity;
                        if((Number(itemChoiceB.prodAction) == 3) && (Number(itemChoiceB.productType) != 4)) {
                            break;
                        }
                        else {
                            // This is a grill that should go with the original choice
                            if(showAsSinglePrice==true) {
                                newViewArray.push({item:XML(itemChoiceB)});
                            } else {
                                itemChoice.push({item:XML(itemChoiceB)});
                            }
                        }
                    }
                    else {
                        break;
                    }
                }
                i=(j-1);
            }
        }
        else {
            // This is not Choice
            newViewArray.push({item:XML(item)});
        }
		lastlevel = itemLevel;
    }
    // Put Choice Itens in the finish of the array
    for(var i=0; i < itemChoice.length; i++) {
        var iInd=newViewArray.length;
        newViewArray.push({item:XML(itemChoice[i].item)});
    }
}


//*************COMMON*********************************
/** Create a consolidated view*/
function creatConsView(viewArray,newView) 
{
	//Recreate Original XML
	var auxXML=new XML("<View/>");
	for(var i=0; i < viewArray.length; i++) {
		var ItemXML=XML(viewArray[i].item);
		auxXML.ItemView+=ItemXML;
	}
	
	var szViewArray=new Array();
	var szAux="";	
	var i=0;
	// Create  line array with the same iItemCode
	while(i < viewArray.length) {
		var ItemView=viewArray[i].item;
		var iItemCode = ItemView.itemCode.toString();
		szAux =szAux + ItemView.productCode + ItemView.grilledQuantity;
		for(var j=i+1; j < viewArray.length; j++) {
			var nextItemView=viewArray[j].item;
			if((iItemCode!=nextItemView.itemCode) || (nextItemView.level==0)){
				break;
			}
			szAux=szAux + nextItemView.productCode + nextItemView.grilledQuantity;
		}
		szViewArray.push({id:String(i), item:String(szAux)});
		szAux="";
		i=j;
	}	

//		addLine("szViewArray.length->\n"+szViewArray.length);	
//		for(var i = 0; i < szViewArray.length; i++) {
//			addLine(szViewArray[i].id);
//			addLine(szViewArray[i].item);
//		}
//		addLine("auxXML ->\n" + auxXML);

	// Search igual itens
	for(var i = 0; i < szViewArray.length; i++) {
		var ItemArray = szViewArray[i].item;
		var iInd = Number(szViewArray[i].id);
//			addLine("szViewArray["+i+"].item " +  szViewArray[i].item );
		for(var j = i+1; j < szViewArray.length; j++) {
			if(ItemArray == szViewArray[j].item) { // Igual Item
//					addLine("IGUAL szViewArray["+j+"].item " +  szViewArray[j].item );
				// Item already used in table	
				var jInd = Number(szViewArray[j].id);
				szViewArray[j].item = -j;  
//					addLine("iInd: " +  iInd + " jInd: " + jInd );

				auxXML.ItemView[iInd].quantity=Number(auxXML.ItemView[iInd].quantity.toString()) + Number(auxXML.ItemView[jInd].quantity.toString());
				auxXML.ItemView[iInd].quantityPromo=Number(auxXML.ItemView[iInd].quantityPromo.toString()) + Number(auxXML.ItemView[jInd].quantityPromo.toString());
// Jon Smith 2009-02-26 amendment not to add unit information starts					
//				auxXML.ItemView[iInd].unitPrice=Number(auxXML.ItemView[iInd].unitPrice.toString())+ Number(auxXML.ItemView[jInd].unitPrice.toString());					
//				auxXML.ItemView[iInd].netUnitPrice=Number(auxXML.ItemView[iInd].netUnitPrice.toString())+ Number(auxXML.ItemView[jInd].netUnitPrice.toString());					
//				auxXML.ItemView[iInd].unitTax=Number(auxXML.ItemView[iInd].unitTax.toString())+ Number(auxXML.ItemView[jInd].unitTax.toString());			
// Jon Smith 2009-02-26 debug code not to add unit information starts		
				auxXML.ItemView[iInd].totalPrice=Number(auxXML.ItemView[iInd].totalPrice.toString()) + Number(auxXML.ItemView[jInd].totalPrice.toString());					
				auxXML.ItemView[iInd].netTotalPrice=Number(auxXML.ItemView[iInd].netTotalPrice.toString()) + Number(auxXML.ItemView[jInd].netTotalPrice.toString());					
				auxXML.ItemView[iInd].totalTax=Number(auxXML.ItemView[iInd].totalTax.toString()) + Number(auxXML.ItemView[jInd].totalTax.toString());					
				auxXML.ItemView[iInd].ADTotalPrice=Number(auxXML.ItemView[iInd].ADTotalPrice.toString()) + Number(auxXML.ItemView[jInd].ADTotalPrice.toString());					
				auxXML.ItemView[iInd].ADNetTotalPrice=Number(auxXML.ItemView[iInd].ADNetTotalPrice.toString()) + Number(auxXML.ItemView[jInd].ADNetTotalPrice.toString());					
				auxXML.ItemView[iInd].ADTotalTax=Number(auxXML.ItemView[iInd].ADTotalTax.toString()) + Number(auxXML.ItemView[jInd].ADTotalTax.toString());					
				
				auxXML.ItemView[jInd].quantity=0;
			}
		}
	}

	for each (var item in auxXML.ItemView) {
		if ((Number(item.quantity) > 0) || item.isGrillLine) {
			newView.ItemView+=item;
		}
	}
}

//Sort the Consolidated View
function sortConsView(newViewCons)
{
	var flagdisplayOrder=false;
	// Create array to seach duplicate displayOrder
	var displayOrderArray = new Array();
	for each (var item in newViewCons.ItemView) {
		if (Number(item.level) == 0) {
			displayOrderArray.push({id:Number(item.displayOrder)});
		}
	}
	// Sort displayOrder Array
	displayOrderArray.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));})		
	//Seach duplicate displayOrder
	for(var i=1; i < displayOrderArray.length; i++) {
		if(displayOrderArray[i-1].id == displayOrderArray[i].id){
			// There is duplicate displayOrder
			flagdisplayOrder=true;
			break;
		}
	}
	
	// Create array with sale items
	var newViewArray = new Array();
	var key = "000000000";
	var displayOrder = "000000000";
	var productCode = "";
	for each (var item in newViewCons.ItemView) {
		if (Number(item.level) == 0) {
			key = API.formatNumber(Number(item.displayOrder), "000000000", 9)
		}
		displayOrder = API.formatNumber(Number(item.displayOrder), "000000000", 9)
		if (flagdisplayOrder==true) {
			productCode = API.formatNumber(Number(item.productCode), "00000", 5)
		}
		// Create key to sort
		var aux = String(key) + Number(item.level) + String(displayOrder)+ String(productCode);		
		newViewArray.push({id:String(aux), item:String(item)});
	}
	// Sort array with sale items
	newViewArray.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));});		
	
	var sortViewCons = new XML("<View/>");
	for(var i = 0; i < newViewArray.length; i++) {
		var ItemView = new XML(newViewArray[i].item);
		sortViewCons.ItemView+=ItemView;
	}
	
	newViewCons = sortViewCons;

//	addLine("newViewCons->\n" + newViewCons);

}
//*********************End COMMON********************

//*********************report_isp.nps********************
//not defined in report.nps
/**
 * Normalizes a view that comes with quantities already multiplied
 */
function divideItemQuantities(view) {
	var len = view.ItemView.length();
	for (var i = len-1; i>=0; i--) {
		var item = view.ItemView[i];
		if (Number(item.level) == 0) {
			continue; // Ignore level0 items
		}
		var previousLevel = (Number(item.level) - 1);
		for (var j=i-1; j>=0; j--) {
			if (Number(view.ItemView[j].level) == previousLevel) {
				// Found our parent item, so we need to divide our quantity
				if (Number(view.ItemView[j].quantity) > 0) {
					item.quantity = String(Number(item.quantity) / Number(view.ItemView[j].quantity));
				}
				break;
			}
		}
	}
}
/*********************************************************/
/*********************************************************/




//************report_isp.nps*****************
//there is the case where we can have view with qunatities already multiplied.
//can be a problem with sale types thare are not taken from message_properties ()maybe the view has not the local names for eat in etc).
/**
 * PUBLIC
 * Implements the Pick List receipt
 * Needed data types: VIEW
 * @author Celso
  */
function reportPickList(config, data)
{

	var hlp = new BusinessObjectHelper;
	var PickListForORB = PosCheckSessionProperty ("PickListForORB", "1");
	API.dbg("reportPickList PickListForORB: " + PickListForORB);

	return genericPickList(config, data, PosCheckSessionProperty ("SecondPrintOutWithBarCode", "1"), PickListForORB);

}
function genericPickList(config, data, bPrintBarCode, PickListForORB)
{ 
	var LIGHT  = 1;
	var ONLY   = 2;
	if(init(config, data, Array("VIEW"), "RECPT") != 0){
		return getResponse();
	} else {
		// Part of feature PLE-194 : Auto condiment - By KFG
		lConsolidateACItems("picklist");
	}	
	
	
	// Order information
	var showCanceledItems="false";	
	var prnPickList = true;
	var cashlessFailedMsg = null;
	var custom 	 = rootConfig.CustomData[0];
	if(custom != null) {	
		var fields = String(custom).split(":");
		if(fields.length>=1) {
			showCanceledItems = fields[0];
			if(fields.length>=2) {
				prnPickList = (fields[1] != "1");
				if(fields.length>=3) {
					cashlessFailedMsg = fields[2]; //PLE-94
				}
			}
		}
	}
	
	var view = rootView.View;
	// Check Refund
	var isRefund = (view.@transactionKind == TRANS_KIND_REFUND);
	if (view.@vmChildrenMultiplied == "true") {
		// KVS view comes with quantities already multiplied
		divideItemQuantities(view);
	}
	if(isRefund) {
		return getResponse();	
	}
	
	// Check pod!=FC
	if(Number(view.@pod)!=0) {
		// Check whether idPos of the Store is the same of the Tender
		if (!PickListForORB && prnPickList && (Number(rootConfig.PosId.substring(3, 7)) == Number(view.@orderKey.substring(3, 7)))){
			return getResponse();	
		}
	}

	addLine(SEP_UL);
	if(PickListForORB)
	{
		//print the order number with formating
		orderIdBigger(GetConcentratedPOSAndOrderID(view));
	}
	else
	{
		orderIdBigger(view.@orderId);
	}
	addLine();	
	
	var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
	var kvsOrder = "#ORD " +majorMinor;
	
	var posId = " " + API.getLocalMsg("MSG_RECEIPT_REG")  + " "  + toInt(view.@orderKey.substring(3, 7)) + "-"; // Eg: POS0001:89 - > KS#1
	var date = API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss");
	var strLine = kvsOrder + posId;
	addLine(strLine + API.setOnRight(date, COLS-strLine.length));
	addLine();

	var flagdisplayOrder=false;
	// Create array to seach duplicate displayOrder
	var displayOrderArray = new Array();
	for each (var item in view.ItemView) {
		if (Number(item.level) == 0) {
			displayOrderArray.push({id:Number(item.displayOrder)});
		}
	}
	// Sort displayOrder Array
	displayOrderArray.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));})		
	//Seach duplicate displayOrder
	for(var i = 1; i < displayOrderArray.length; i++) {
		if(displayOrderArray[i-1].id == displayOrderArray[i].id){
			// There is duplicate displayOrder
			flagdisplayOrder=true;
			break;
		}
	}
	
	/*
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"ConsolidatedReportPickList\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"ConsolidatedReportPickList\").@value";
	var consolidate = getConfigValue(storedbPath , posdbPath);
	*/
	if(consolidatePickList == "false") //we will display just like in a normal receipt
	{		
		var qtyLevelZero=1;
		var promoLevelZero=false;
		var qtyViewItem = view.ItemView.length();
		for(var iItem = 0; iItem < qtyViewItem; iItem++) {
			var item = view.ItemView[iItem];
			if (item.level == 0) {
				qtyLevelZero = item.quantity;
				promoLevelZero = (toInt(item.quantityPromo) != 0);
			}
			if((item.quantity != 0) || (item.specialModifiers == LIGHT) || (item.specialModifiers == ONLY)) {
				if((qtyLevelZero != 0) && ((toInt(item.fvmSts) == 0))) {
					var curLevel=item.level-1;
					var curQtty=qtyLevelZero;
					for(var i=iItem-1; i>=0 && view.ItemView[i].level != 0; i--) {
						if(curLevel == view.ItemView[i].level) {
							curQtty*=view.ItemView[i].quantity;
							curLevel--;
						}
					}
					addItemLine(item,curQtty);
				}
			}
		}
	}
	else //the default behavior; the list of product will have the value meal decompose
	{
	// Create array with sale items
		var newViewArray = new Array();
		detachChoice(view,newViewArray);

		// Create the consolidated view
		var sortView = new XML("<View/>");
		creatConsView(newViewArray,sortView);

		// Sort the Consolidated View
		sortConsView(sortView);

		// Adds sale items
		var qtyLevelZero=1;
		var qtyViewItem = sortView.ItemView.length();
		var iItem = 0;
		for each (var item in sortView.ItemView) {
			iItem++;
			if (item.level == 0) {
				qtyLevelZero = Number(item.quantity);
			}
			if((showCanceledItems == "true") || (Number(item.quantity) != 0) || (item.specialModifiers == LIGHT) || (item.specialModifiers == ONLY)) {
				if (qtyLevelZero != 0) {
					var childNode = false;
					for(var i = iItem; i < qtyViewItem; i++) {
						var childView = sortView.ItemView[i];
						if(Number(item.level) > Number(childView.level)) {
							break;
						}
						if(childView.isGrillLine == "true") {
							childNode = true;
						}
					}
					if(!((Number(item.level) != 0) && (item.isGrillLine == "false") && (item.productType == 2)) || (childNode == true)) {
						addItemLine(item,qtyLevelZero);
					}
				}
			}
		}
	}	
	//here can be a problem it depends how the view is generated if it has the Country message.
	var saleTypes	= Array(API.getLocalMsg("MSG_RECEIPT_IN"), API.getLocalMsg("MSG_RECEIPT_OUT"), API.getLocalMsg("MSG_RECEIPT_OTHER"));
	//var saleTypes	= Array("Eat-In", "Take-Out", "Other");
	var saleType	= toInt(view.@type);
	addLine();
	addLine(saleTypes[saleType] + " " + API.getLocalMsg("MSG_RECEIPT_TOTAL"));
	
	addLine(SEP_UL);
	if(!PickListForORB)
	{
		barCode(view.@orderId);
		//print additional text if needed
		var additionalText = API.getLocalMsg("MSG_PICKLST_CASHLESS_FAILED1");
		if(additionalText != "MSG_PICKLST_CASHLESS_FAILED1")
		{
			addLine(); 
			addLine(additionalText); 
		}
		if (cashlessFailedMsg != null) {
			
			addLine(); 
			addLine(cashlessFailedMsg); //PLE-94
		}	
		addLine();
		addLine();
		addLine();	
	}
	
	//print bar code if needed
	if (bPrintBarCode && PickListForORB)
	{
		barCodeWithPOSID(view);
		addLine();
		addLine();
		addLine();
	}

	printReceiptLater();
	return getResponse();
	

	function printReceiptLater()
	{
		//France request receipt with product that will be delivered later 
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"PrintLaterReceipt\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"PrintLaterReceipt\").@value";
		var printLaterReceipt = getConfigValue(storedbPath, posdbPath)=="true";
		*/
		if(printLaterReceiptOnPickList == true)
		{
			var foundLaterProduct =false;  //set to true if we need to print  an additioanl receipt
			var isOverring		= ((Number(view.@saleStatus) == SALE_STATUS_LAST_SALE_VOIDED) || (Number(view.@saleStatus) == SALE_STATUS_CURRENT_SALE_VOIDED));
			if((view.@transactionKind == TRANS_KIND_SALE || view.@transactionKind == TRANS_KIND_MANAGER_MEAL || view.@transactionKind == TRANS_KIND_CREW_MEAL || view.@transactionKind == "5") && !isOverring)
			{
				//check if we must print an additioanl reeipt
				
				//get the list of comments that must be defined as components for the products that will be delivered later
				/*
				storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CommentCode\").@value";
				posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CommentCode\").@value";
				commentCode = getConfigValue(storedbPath, posdbPath);
				*/
				if(commentCode.length!=0 && commentCode!="")		
				{
					if(view.ItemView.(productCode == commentCode)+""!="")
					{
						foundLaterProduct =true;
					}				
				}
				if(foundLaterProduct ==true)
				{
					addLine();addLine();addLine();addLine();addLine();addLine();
					cutPaper();
					
					//add custom header
					addLine();
					addLine();
					addLine(SEP_UL);		
					startBold(); {
					var messageHeader = API.getLocalMsg("MSG_RECEIPT_LATER_TITLE");
					var arrMessageHeader = messageHeader.split("||");
					for(var i=0; i < arrMessageHeader.length; i++)
					{
						addLine(center(arrMessageHeader[i]));
					}
					}endBold();
					
					addLine();
					//var cashierLine = API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") +" "+ operatorID;
					//var storeLine = API.getLocalMsg("MSG_RECEIPT_STORE_ID") +" "+ storeID;
					//strLine = "#"+API.getLocalMsg("MSG_RECEIPT_ORDER_NO") + " " + majorMinor; //order naumber
					
					var strLine = API.getLocalMsg("MSG_RECEIPT_REG")  + " " + toInt(view.@orderKey.substring(3, 7)); //pos ID
					strLine +=" - "+ rootView.View.@operatorName + " - ";
				  	var strLineDate = API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss"); //business date
					strLine += " -"+strLineDate;
					addLine(strLine);
					addLine();

					addLine(API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_PROD").substring(0,30), 30) + API.setOnRight(API.getLocalMsg("MSG_RECEIPT_QTY"), 10));
					listOfLaterProducts(commentCode);
					// add product line to the receipt
				}
			}
			if(foundLaterProduct == true)
			{
				addLine();
				//custom footer
				startBold(); {
				var messageFooter = API.getLocalMsg("MSG_RECEIPT_LATER_FOOTER1");
				var arrMessageFooter = messageFooter.split("||");
				for(var i=0; i < arrMessageFooter.length; i++)
				{
					addLine(center(arrMessageFooter[i]));
				}
				addLine(SEP_DL);	
				
				messageFooter = API.getLocalMsg("MSG_RECEIPT_LATER_FOOTER2");
				arrMessageFooter = messageFooter.split("||");
				for(var i=0; i < arrMessageFooter.length; i++)
				{
					addLine(center(arrMessageFooter[i]));
				}
				addLine();
				addLine(SEP_UL);
				}endBold();
			}
		}
	}

	function listOfLaterProducts(productCode)
	{
		for(var i=0; i<view.ItemView.length();i++)
		{
			  var item  = view.ItemView[i];
			  var j=0;
		      if(Number(item.productCode) == Number(productCode))
			  {
					//the product must be delivred plus tard
					//get the root product
					var productServedLater;
					if(Number(item.level) == 1) //if the grill level is 1 then we will have a normal product that was grilled
					{
						var arrProductServed = view.ItemView.(itemCode == item.itemCode); 
						productServedLater= arrProductServed[0]; //the first one in the view is the root product
						addReceiptLaterLine(productServedLater,1);
						//get other grill instruction for the product
						//API.DbgMessageBox(view.ItemView.(itemCode == item.itemCode).length());
						//API.DbgMessageBox(productServedLater.longName);
						for(var j=1; j< arrProductServed.length();j++) //the fist one is the root product
						{
							//API.DbgMessageBox("grill "+arrProductServed[j].longName+ " " +arrProductServed[j].isGrillLine);
							if(arrProductServed[j].isGrillLine == "true"  && Number(arrProductServed[j].level) == (Number(item.level)) &&  arrProductServed[j].productCode != item.productCode && Number(arrProductServed[j].itemCode) == Number(item.itemCode))
							{
								//API.DbgMessageBox(arrProductServed[j].longName);
								addReceiptLaterLine(arrProductServed[j]);
							}
							if(arrProductServed[j].isGrillLine != "true" ) //first time we not have a grill item we exit
							{
								break;
							}
						}
					}
					else //we have a vale meal or a value meal into another value meal 
					{
						//get all product with that itemCode and the level one less.
						var j=i;
						for(j=i-1; j>=0;j--)
						{
							if(view.ItemView[j].isGrillLine != "true"  && Number(view.ItemView[j].level) == (Number(item.level)-1) && Number(view.ItemView[j].itemCode) == Number(item.itemCode))
							{
								//in this case if there is a value meal then we need to send the qty from the root product
								productServedLater= view.ItemView[j];
								var rootProduct;
								var qtyVM = 1;
								if(productServedLater.productType == "2")
								{
									rootProduct = view.ItemView.(itemCode == productServedLater.itemCode);
									qtyVM = rootProduct[0].quantity;
								}
								
								addReceiptLaterLine(productServedLater, qtyVM, true);
								break;
							}
						}
						
						//get the grill instruction for the product that is delivred later if there are any
						for(j=j+1;j<view.ItemView.length();j++)
						{
							if(view.ItemView[j].isGrillLine != "true" ) //first time we not have a grill item we exit
							{
								break;
							}
							if(view.ItemView[j].isGrillLine+"" == "true"  && Number(view.ItemView[j].level) == (Number(item.level)) && Number(view.ItemView[j].itemCode) == Number(item.itemCode) && view.ItemView[j].productCode != item.productCode)
							{
								addReceiptLaterLine(view.ItemView[j]);
							}
						}
					}
			  }
		}
	}
	
	
	function addReceiptLaterLine(item, qtyVM, isValueMeal)
	{
		if(item.tbdStatus !="2")
		{
			if(item.isGrillLine !="true")
			{
				if(isValueMeal == true)
				{
					addLine(API.setOnLeft((item.longName).substring(0,26), 24)+" (VM) " + API.setOnRight(Number(item.quantity)*qtyVM, 10))	
				}
				else
				{
					addLine(API.setOnLeft((item.longName).substring(0,30), 30) + API.setOnRight(Number(item.quantity)*qtyVM, 10))	
				}
			}
			else
			{
				addLine("     " + getGrillDescription(item, true));
			}
		}
	}
	
	/** Adds an item description given an <ItemView> tag */
	function addItemLine(item, qtyLevelZero) 
	{
		if(item.tbdStatus =="2")
		{
			return;
		}
		var ident = "";
		var level = toInt(item.level);
		
		var itemClass = item.productType.length();
		if (itemClass != 0) {
			if (item.productType == 4) {
				return;
			}
		}
		
		for(var i=0; i<level; i++) {
			ident += " ";
		}
		if (item.level == 0) {
			qtyLevelZero = 1;
		}
		var aux = item.quantity  * qtyLevelZero;
		var qty = API.setOnRight(aux, 3);
		var name = item.longName;
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"pickListDisplayShortName\").@value"; 
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"pickListDisplayShortName\").@value";
		var displayShort = getConfigValue(storedbPath , posdbPath);
		*/
		
		if (cashlessFailedMsg != null  && displayShort_PickList==true) {
			name = item.description; //PLE-94
		}
		var compl = "";
		if(toInt(item.quantityPromo) != 0) {
			compl = item.quantityPromo + "P";
		}
		var line = null;
		if(item.isGrillLine == "true") {
			line = "    " + ident + getGrillDescription(item, true);
		}else {
			line = ident + qty + " " + name;
		}
		line = API.setOnLeft(line, COLS-compl.length) + compl;
		
		//last test if is grill line and we do not want to display grill item on the receipt that we should not add the line
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillItemsDisabled\").@value"; 
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillItemsDisabled\").@value";
		var GrillItemsDisabled = getConfigValue(storedbPath , posdbPath) == "true";
		*/
		if(GrillItemsDisabled == true)
		{
			if(item.isGrillLine == "true")
			{
				return;
			}
			else // no grill line
			{
				//in case of sadwich for the value meal we do not have to display it  because is only added because of the grill instruction
				//get the first product with the same itemCode
				if(Number(item.prodAction) == 0 && Number(item.level) !=0 &&  Number(item.productType)  == 2) //is the sandwich of a value meal 
				{
					//check all subitems of the current product.
					//get the value meal
					var products = view.ItemView.(itemCode == item.itemCode);
					var foundProduct = false;
					var showLine = false;
					for(var t= 0; t < products.length();t++)
					{
						if(foundProduct ==true)
						{
							//get sub items
							if(Number(products[t].level) > Number(item.level))
							{
								 //if is not a grill line then we should show the current product
								 if(products[t].isGrillLine !="true")
								 {
									showLine = true;
									break;
								 }
							}
							else
							{
								break;
							}
						}
						if(products[t].productCode == item.productCode) //we found the current product
						{
							foundProduct =true;
						}
					}
					if(showLine == true)
					{
						addLine(line);
					}
					return;
				}
				else
				{
					addLine(line);
				}
			}
		}
		else
		{
			addLine(line);
		}
	}
}

/**
 * PUBLIC
 * Implements the customer receipt
 * Needed data types: VIEW
 * @author Celso
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function receiptkioskTPUI(config, data) 
{
	isKioskTPUI = true;
	isRcpKiosk = true;
	return(receipt(config, data));
}


//****************COMMON*****************
/**
 * PUBLIC
 * Implements the customer receipt
 * Needed data types: VIEW
 * @author Celso
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function receiptkiosk(config, data) 
{
	isRcpKiosk = true;
	return(receipt(config, data));
}

//**************report.nps****************
//just the property message
/**
 * Receipt for HOT
 *
 */
function receiptHHOT(config, data)
{
	if(init(config, data, Array("VIEW"), "RECPT") != 0){
		return getResponse();
	}	
	var view = rootView.View;
	addLine(SEP_UL);
	addDefaultHeader();
	addLine(center("TEL# " + rootConfig.StorePhoneNumber + " " + API.getLocalMsg("MSG_RECEIPT_STORE") +"# " + rootConfig.StoreId));
	addLine();
	var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
	var kvsOrder = API.getLocalMsg("MSG_RECEUPT_ORDER_NOR") +" #" + majorMinor;
	addLine(center(kvsOrder));		
	addLine();
	addLine(SEP_UL);	
	return getResponse();
}


//*************** combined ******************
//report_isp prototype it has the bConsolidated parameter
/**
 * PUBLIC
 * Implements the customer genericReceipt
 * Needed data types: VIEW
 * @author Celso Fernandes
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function genericReceipt(config, data, bPrintBarCode, bConsolidate) 
{
	/*needed for production*/
	if(typeof(xmlStoreDB) =="undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}
	var Country = (xmlStoreDB.StoreDB.StoreProfile.StoreDetails.Country).toUpperCase();
	//addLine(API.getLocalMsg("MSG_SPECIAL_CHAR"));
	//return getResponse();

	//var boHelper		= new BusinessObjectHelper;
	//API.dbg("1111generic receipt");
	
	var LIGHT  = 1;
	var ONLY   = 2;
	var PODFC = 0;
	var PODDT  = 1;
	var PODWT = 2;
	var PODDLV = 3;
	var PODCK= 4;
	var PODMCC = 5;	
	var PODCSO = 8;
	var PODHOT = 9;
		
	var separateChasLess = false;
	if(init(config, data, Array("VIEW"), "RECPT") != 0){
		return getResponse();
	} else {
		// Part of feature PLE-194 : Auto condiment - By KFG
		lConsolidateACItems("receipt");
	}	
	
	// Order information
	var operatorID		= rootView.View.@operatorId;
	var storeID 		= rootView.@storeId;
	var operatorName	= rootView.View.@operatorName;
	
	var view			= rootView.View;
	var isRefund		= view.@transactionKind == TRANS_KIND_REFUND;
	var isBillableSale	= ((view.ItemTenderView.(code == TENDER_KIND_BILLABLEREFUND)).length() != 0);	
	var isWaste			= view.@transactionKind == TRANS_KIND_WASTE;
	var isOverring		= ((Number(view.@saleStatus) == SALE_STATUS_LAST_SALE_VOIDED) || (Number(view.@saleStatus) == SALE_STATUS_CURRENT_SALE_VOIDED));
	var isInProgress	= (Number(view.@saleStatus) == SALE_STATUS_CURRENT_SALE_VOIDED);
	var isKiosk     	= false; // DES-30 // var isKiosk     = (Number(view.@pod) == PODCSO) || isRcpKiosk;
	var isFromKiosk 	= (Number(view.@pod) == PODCSO);
	var isDTorMCC		= (Number(view.@pod) == PODDT || Number(view.@pod) == PODMCC);
	var custom 			= rootConfig.CustomData[0];
	var printWithAlias	=	Number(rootConfig.ReportFlags.indexOf(API.getLocalMsg("ALIAS")));
	var errKiosk 		= 0;
	var prnKiosk 		= 0;
	uaildeCodesNumber	= 0; //each time we enter this function we reset the number of codes that must be printed for PT marketing contest	
	// start addition js for ACSP8002684 Newpos 6.1 Script Change Request for Drive Marketing Campaign Code
	driveCodesNumber	= 0; //each time we enter this function we reset the number of codes that must be printed for PT marketing contest DT
	PTCodesList = {};
    // end addition js for ACSP8002684 Newpos 6.1 Script Change Request for Drive Marketing Campaign Code

	API.dbg("Sotec view " + view);
	if(Country =="NL")
	{
		addLine("<@McLogoPart1><@McLogoPart2>");
	}
	else
	{
		addLine(SEP_UL);
	}	
	//18.12.2008 oi need the order id bigger only for the kiosk
	//if(!isDTorMCC) {
   /* if(Country =="UK" || Country =="IE")
	{
		if(!isDTorMCC)
		{
			orderIdBigger(view.@orderId);
		} else 
		{
			addLine(API.center(view.@orderId, 40));
		}
		addLine();
	}
	else
	{*/
		//08.03.2010 do we need to print the Order ID bigger
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberBigger\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberBigger\").@value";
		var OrderNumberBigger = getConfigValue(storedbPath, posdbPath);
		*/
		//18.05.2010 OI we need the order id bigger for UK and IE but we need also the DP implementation
		if(Country =="UK" || Country =="IE")
		{
			if(!isDTorMCC)
			{
				OrderNumberBigger = "1";
			} 
		}

		API.dbg("genericReceipt OrderNumberBigger: " + OrderNumberBigger + "");

		var FirstReceiptEmpty = false;
		if(typeof(PosCheckSessionProperty)== "function" && PosCheckSessionProperty ("FirstReceiptEmpty", "1"))
		{
			FirstReceiptEmpty = true;
		}
		//18.12.2008 oi need the order id bigger only for the kiosk
		if(FirstReceiptEmpty == false && (isFromKiosk || OrderNumberBigger == "1")) 
		{
			//08.03.2010 replace the BusinessObjectHelper
			var OrderNumberFormat = "";
			if(isFromKiosk)
			{
				/*
				storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderNumberFormat\").@value";
				posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintFromKioskOnCounter\").Parameter.(@name==\"OrderNumberFormat\").@value";
				OrderNumberFormat = getConfigValue(storedbPath, posdbPath);
				*/
				OrderNumberFormat = OrderNumberFormatKiosk;
			}

			if(OrderNumberFormat == "")
			{
				/*
				storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberFormat\").@value";
				posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrderNumber\").Parameter.(@name==\"OrderNumberFormat\").@value";
				OrderNumberFormat = getConfigValue(storedbPath, posdbPath);
				*/
				OrderNumberFormat= OrderNumberFormatPos;
			}
			
			API.dbg("genericReceipt OrderNumberFormat: " + OrderNumberFormat + "");

			//var hlp = new BusinessObjectHelper;
			//Check for order number format
			if(OrderNumberFormat == "1")
			{
				//print the order number with formating
				orderIdBigger(GetConcentratedPOSAndOrderID(view));
			}
			else
			{
				API.dbg("genericReceipt view.@orderId: " + view.@orderId + "");
				orderIdBigger(view.@orderId);
			}

			//07.09.2010 OI search for the production side and decide which text will be displayed 
			//<Section name="OrbMatch">
		     	//	<Parameter name="ShowORBNumberOnReceipt" value="true">
		     	//	<Parameter name="ORBNumber" value="CSO-P|1; FC-P|2">
			//</Section>
			//08.12.2010 OI searchr for the production side and decide which image will be displayed
			//<Section name="OrbMatch">
     			//	<Parameter name="ShowORBImageOnReceipt" value="true">
     			//	<Parameter name="ORBNumber" value="CSO-P|1; FC-P|2">
			//</Section>
			if(typeof(BusinessObjectHelper) != "undefined")
			{
				var hlp = new BusinessObjectHelper;
				var showORBNumber = hlp.findParamInSectionWide("ShowORBNumberOnReceipt","OrbMatch");
				if(showORBNumber != null)
				{
					showORBNumber = showORBNumber.toLowerCase();
				}

				API.dbg("genericReceipt ShowORBNumberOnReceipt: " + showORBNumber + "");
				
				if(showORBNumber == "true")
				{
					var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrbMatch\").Parameter.(@name==\"ORBNumber\").@value";
					var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrbMatch\").Parameter.(@name==\"ORBNumber\").@value";
					var sStoredbValue = getConfigValue(storedbPath, posdbPath);
					API.dbg("SOTEC sStoredbValue: " + sStoredbValue + "");
					var sValues = sStoredbValue.split(";");
					if(sValues != null)
					{
						for(var i=0; i < sValues.length; i++) 
						{
							API.dbg("SOTEC sValues[i]: " + sValues[i] + "");
							var sValuesvalues = sValues[i].split("|");
							if(sValuesvalues != null)
							{
								API.dbg("SOTEC view.@productionSide " + view.@productionSide + "");
								API.dbg("SOTEC sValuesvalues[0] " + sValuesvalues[0] + "");
								var ps = trim(view.@productionSide + "");
								var sv = trim(sValuesvalues[0] + "");
								if( ps == sv )
								{
									addLine();
									addBoldSize2Line(API.center(API.getLocalMsg("RECEIPT_ORB_SCREEN_"  +  sValuesvalues[1]), 20));
									addLine();
									addLine();
									
								}
							}
						}
					}
				}
				
				var showORBImage = hlp.findParamInSectionWide("ShowORBImageOnReceipt","OrbMatch");
				if(showORBImage != null)
				{
					showORBImage = showORBImage.toLowerCase();
				}
				
				API.dbg("genericReceipt ShowORBImageOnReceipt: " + showORBImage + "");

				if(showORBImage == "true")
				{
					var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"OrbMatch\").Parameter.(@name==\"ORBNumber\").@value";
					var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"OrbMatch\").Parameter.(@name==\"ORBNumber\").@value";
					var sStoredbValue = getConfigValue(storedbPath, posdbPath);
					API.dbg("SOTEC sStoredbValue: " + sStoredbValue + "");
					var sValues = sStoredbValue.split(";");
					if(sValues != null)
					{
						for(var i=0; i < sValues.length; i++) 
						{
							API.dbg("SOTEC sValues[i]: " + sValues[i] + "");
							var sValuesvalues = sValues[i].split("|");
							if(sValuesvalues != null)
							{
								API.dbg("SOTEC view.@productionSide " + view.@productionSide + "");
								API.dbg("SOTEC sValuesvalues[0] " + sValuesvalues[0] + "");
								var ps = trim(view.@productionSide + "");
								var sv = trim(sValuesvalues[0] + "");
								if( ps == sv )
								{
									addLine();
									addLine("<@Image"  +  sValuesvalues[1] + ">");
									addLine();
									addLine();
									
								}
							}
						}
					}
				}
			}
		} 

		
		
	//}
	// DES-163 Changed by Lindomar Araujo in 29/02/2008 in Germany
	// addLine();	
	
	startBold();{
		// Adds the default receipt header from store-db
		addDefaultHeader();
	} endBold();
	addLine();
	
	//missing tax invoce message from report.nps
	if(Country =="UK" || Country =="IE")
	{
		addLine(API.center(API.getLocalMsg("MSG_RECEIPT_TAX_INVOICE"), 39));
	}
	if(isOverring) {
		if(Country != "PT")
		{
			startBoldSize2();
			addLine(API.center(API.getLocalMsg("MSG_RECEIPT_OVERRING"), 19));
			endBoldSize2();
		}
		else
		{	
			startBold();
			addLine(API.center(API.getLocalMsg("MSG_RECEIPT_OVERRING"), 39));
			endBold();
		}
	}else {
		if(Country !="FR") //they already have this defiend in the header
		{
			if(printWithAlias >=0)
			{
				if(Country != "PT")
				{
					startBoldSize2();
					addLine(API.center(API.getLocalMsg("MSG_WFL_DUPLICATE_REPRINT_MESSAGE"),19));
					endBoldSize2();
				}
				else
				{
					startBold();
					addLine(API.center(API.getLocalMsg("MSG_WFL_DUPLICATE_REPRINT_MESSAGE"),39));
					endBold();
				}
			}else
			{
				if(Country != "PT")
				{
					startBoldSize2();
					addLine(API.center(API.getLocalMsg("MSG_RECEIPT_RECEIPT"),19));
					endBoldSize2();
				}
				else
				{
					startBold();
					addLine(API.center(API.getLocalMsg("MSG_RECEIPT_RECEIPT"),39));
					endBold();
				}
			}
		}
	}
	if(Country =="FR" || Country =="UK" || Country =="IE")
	{
		addLine();
	}
	else
	{
		addLine(SEP_UL);
	}
	
	var vatNumber="";
	if((isKiosk) && (custom != null)) {	
		var fields = String(custom).split(":");
		if(fields.length>=1) {
			errKiosk = fields[0];
			if(fields.length>=2) {
				prnKiosk = fields[1];
				if(prnKiosk==1) {
					addLine(center((isFromKiosk)?"kiosk duplicate":"duplicate"));
				}
				if(fields.length>=3) {
					vatNumber = fields[2];
					if(vatNumber == null) {
						//vatNumber="--------------------";
						var vatNumber = (xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="VAT").Parameter.(@name=="VatNumber")).@value;
						}
				}
			}
		}
	}
	else {
		vatNumber = custom;
		if(vatNumber == null) {
			//vatNumber="--------------------";
			var vatNumber = (xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="VAT").Parameter.(@name=="VatNumber")).@value;
			//boHelper.findParamInSectionWide("VatNumber","VAT");
		}
	}

	if(isRefund) {
		if(isBillableSale) {
			var billableSaleRefund = view.ItemTenderView;
			startInvertedColor();
				startBold();
				addLine(center(API.getLocalMsg("MSG_RECEIPT_BILLABLE_SALE_ADJUSTMENT_HEADER")));
				endBold();
				addLine();
			endInvertedColor();
			startBold(); {
				addLine(center(API.getLocalMsg("MSG_RECEIPT_NOTICE")));
				addLine(center(API.getLocalMsg("MSG_RECEIPT_THIS_BILLABLE_SALE_ADJUSTMENT_IS_FOR")));
				addLine(center(API.getLocalMsg("MSG_RECEIPT_ACCOUNTING_PURPOSES_ONLY")));
				addLine(center(API.getLocalMsg("MSG_RECEIPT_DO_NOT_GIVE_CASH")));
				addLine();
				addLine(API.getLocalMsg("MSG_RECEIPT_ORIG_BILLABLE_SALE_ORDER")+ view.@LSOrderId + "  $"+ API.formatNumber(view.@LSTotAmount, "##0.00", 6));
			} endBold();
		}
		else {
			//for UK  02.04.2009 OI we don't need to seperate between e-cash and cash refunds 		
			separateChasLess = !(view.Cashless.length() == 0);
			if(Country == "UK" || Country =="IE") 
			{
				separateChasLess =false;
			}
			if((isRefund) && !separateChasLess) {		
				startInvertedColor();
					startBoldSize2();
					addLine(API.getLocalMsg("MSG_RECEIPT_REFUND"));
					endBoldSize2();
				endInvertedColor();
			}
			else {
				addLine(center(API.getLocalMsg("MSG_RECEIPT_REFUND")));
			}
		}
		addLine();
	}

	var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
	var kvsOrder = "#";
	kvsOrder = kvsOrder +  getPODText(temPOD);
	
	//API.dbg("genericReceipt POD " + view.@pod);
	var temPOD = Number(view.@pod)
	
	var strLine ="";
	//API.dbg("mihai majorMinor"+ majorMinor);
	if(Country =="FR")
	{
	  var cashierLine = API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") +" "+ operatorID;
	  var storeLine = API.getLocalMsg("MSG_RECEIPT_STORE_ID") +" "+ storeID;
	  //display the order number
	  //we need to display the suborder too in case of multiorder ticket
	  /*if(toInt(view.@minor) !=0)
	  {*/
		strLine = "#"+API.getLocalMsg("MSG_RECEIPT_ORDER_NO") + " " + majorMinor; //order naumber
	  /*}
	  else
	  {
		strLine = "#"+API.getLocalMsg("MSG_RECEIPT_ORDER_NO") + " " + API.formatNumber(Number(majorMinor), "00", 2); //order naumber
	  }
	  */
	  strLine +=" -"+ API.getLocalMsg("MSG_RECEIPT_REG")  + " " + toInt(view.@orderKey.substring(3, 7)); //pos ID
	  
	  var strLineDate = API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss"); //business date
	  strLine += " -"+strLineDate;
	  addLine(cashierLine);
	  addLine(storeLine);
	  addLine(strLine);
	  //addLine(strLineDate);
	  addLine();
	}
	else if (Country =="DE")
    {
		var kvsOrder = "#ORD " + majorMinor;
		
		var posId = " -KS. " + toInt(view.@orderKey.substring(3, 7)) + " -"; // Eg: POS0001:89 - > KS#1
		var date = API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss");
		var strLine = kvsOrder + posId;
		addLine(strLine + API.setOnRight(date, COLS-strLine.length));

    }
	else if (Country == "PT")
	{
		var cashierLine = API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") +" "+ operatorID + " "+ operatorName;
		addLine(cashierLine);
		if(typeof(PosCheckSessionProperty)== "function") //not from production
		{
			//portugal,  global order number stored in tlog properties
			//each time we enter this function we need to increment the oder number. 
			
			//we need to reset the counters when a new day starts
			checkBusinessDay();
			
			// Jon Smith 2009-07-01 PT change for handling receipt/refund/waste order numbers starts
			var key = "normalOrder"; // default
			if(isRefund)
			{
				key = "refundOrder";
			}
			else if (isWaste)
			{
				key = "wasteOrder";
			}
			var newOrder =false;
			//OI 22.06.2010 Set this only if we have a fiscal receipt
			if(!PosCheckSessionProperty("orderid",view.@orderId+"")&& !PosCheckSessionProperty ("CopyForDualPoint", "1")) //We increment the counter just if there is a new order.
			{	//untill now from what i know we do not call for the same order the genericReceipt twice, this test is done just to be sure that all cases are cover
				newOrder = true;
				PosSetSessionProperty("orderId",view.@orderId+"","true"); //update the current order id
			}
			var nrOrder = PosGetSetIncSessionPropertyJS(key,newOrder && !isOverring);
			if (nrOrder < 10000)
			{
				nrOrder = API.formatNumber(nrOrder, "0000", 4);
			}
			var posId = toInt(view.@orderKey.substring(3, 7));
			var line = API.getLocalMsg("MSG_RECEIPT_ORDER_NO") +" "+ posId+""+nrOrder +" "+API.getLocalMsg("MSG_RECEIPT_REG") +" "+ posId;
			line += "   "+ API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss");
			addLine(line);
			addLine();
		}
		else
		{
			var posId = toInt(view.@orderKey.substring(3, 7));
			var line = API.getLocalMsg("MSG_RECEIPT_ORDER_NO") +" "+ posId+""+API.formatNumber(Number(view.@orderId), "0000", 4) +" "+API.getLocalMsg("MSG_RECEIPT_REG") +" "+ posId;
			line += "   "+ API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss");
			addLine(line);
			addLine();
		}
	}
	else
	{
		
		kvsOrder =kvsOrder + " " + API.getLocalMsg("MSG_RECEIPT_ORDER_NO") + " " + majorMinor;
		
		strLine = kvsOrder;
		if(Country !="AT" && Country !="NL")
		{
			strLine += " " + API.getLocalMsg("MSG_RECEIPT_POS_EJ_ORDER");
			//addLine(strLine + API.setOnRight(date, COLS-strLine.length));
			//TODO Hermann: insert POS/EJ Number
		}
		
		if(Country !="UK")
		{
			addLine(strLine);
		}
		var date = API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss");
		if(Country !="AT")
		{
			var posId = API.getLocalMsg("MSG_RECEIPT_REG")  + " " + toInt(view.@orderKey.substring(3, 7)); // Eg: POS0001:89 - > KS#1
			if(Country== "UK")
			{
				var arrdate = date.split(" ");
				var dateUK = arrdate[0];
				var timeUK = arrdate[1];
				addLine(API.setOnRight(posId + "  "+ API.getLocalMsg("MSG_RECEIPT_DATE")+" "+ dateUK+ " "+API.getLocalMsg("MSG_RECEIPT_TIME")+" "+ timeUK, COLS));
			}
			else
			{
				posId = posId + "-";
				addLine(API.setOnRight(posId + "     " + date, COLS));
			}
		}
		else
		{
			var posId = API.getLocalMsg("MSG_RECEIPT_REG")  + " " + toInt(view.@orderKey.substring(3, 7));
			addLine(posId + "     " + date);
		}
		addLine();
		
		//addLine();
	}
	var mfySide = "";
	var strSide = String(view.@productionSide);
	var str_1 = strSide.replace(" ","");
	if(str_1.length != 0) {
		if(isRefund) {
			mfySide = "";
		}else {
			var szSide =  (view.@productionSide.substring(0,4) + " " + view.@productionSide.substring(4,5)).toUpperCase();
			mfySide = "MFY " + szSide + " ";
		}
	}
	if(isWaste) {	
		kvsOrder = "";
	}
	var saleTypes	= Array(API.getLocalMsg("MSG_RECEIPT_IN"), API.getLocalMsg("MSG_RECEIPT_OUT"), API.getLocalMsg("MSG_RECEIPT_OTHER"));
	//var saleTypes	= Array("Eat-In", "Take-Out", "Other");
	var saleType	= toInt(view.@type);
	if(isKiosk) {	
		var totalDue = Number(view.@totalDue);
		addLine(kvsOrder+"   "+saleTypes[saleType]);
		addLine(" ");		
		addLine(SEP_UL);		
	}
	var line = API.getLocalMsg("MSG_RECEIPT_NUMBER_OF_GOODS")+"";
	if (Country =="FR" || Country == "AT")
	{
		line = API.setOnLeft(line.substring(0,16),19) + API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_UNIT"),7) + API.setOnRight(API.getLocalMsg("MSG_RECEIPT_TOTAL"), 13);
	}
	else if(Country =="PT")
	{
		line = API.setOnLeft(line,21) + API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_UNIT"),5) + API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_TAX"),3) + API.setOnRight(API.getLocalMsg("MSG_RECEIPT_TOTAL"), 11);
	}
	else
	{
		line = line + API.setOnRight(API.getLocalMsg("MSG_RECEIPT_TOTAL"), COLS-line.length);
	}
	addLine(line);
	
	if(bConsolidate) {
		// Detach the choices of the view
		var newViewArray=new Array();
		detachChoice(view,newViewArray);
		  
		// Create the consolidated view
		var newViewCons = new XML("<View/>");	
		creatConsView(newViewArray,newViewCons);
		   
		//Sort the Consolidated View
		sortConsView(newViewCons);
			
		// Adds sale items
		var qtyLevelZero=1;
		var promoLevelZero=false;
		var qtyViewItem = newViewCons.ItemView.length();
		var iItem = -1;
		for each (var item in newViewCons.ItemView) {
			iItem++;
			if (item.level == 0) {
				qtyLevelZero = item.quantity;
				promoLevelZero = (toInt(item.quantityPromo) != 0);
			}
			if((item.quantity != 0) || (item.specialModifiers == LIGHT) || (item.specialModifiers == ONLY)) {
				if (qtyLevelZero != 0) {
					var childNode = false;
					for(var i = iItem; i < qtyViewItem; i++) {
						var childView = newViewCons.ItemView[i];
						if(promoLevelZero) {
							childNode = true;
						}
						if(item.level > childView.level) {
							break;
						}
						if(childView.isGrillLine == "true") {
							childNode = true;
						}
					}
					if(!((item.level != 0) && (item.isGrillLine == "false") && (item.productType == 2)) || (childNode == true)) {
						addItemLine(item,qtyLevelZero,0);
					}
				}
			}
		}
	}
	else {
		// Adds sale items
		var qtyLevelZero=1;
		var promoLevelZero=false;
		var qtyViewItem = view.ItemView.length();
		for(var iItem = 0; iItem < qtyViewItem; iItem++) {
			var item = view.ItemView[iItem];
			if (item.level == 0) {
				qtyLevelZero = item.quantity;
				promoLevelZero = (toInt(item.quantityPromo) != 0);
				var totalPrice=0;
				/*
				var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"ValueMeal\").@value";
				var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"ValueMeal\").@value"
 				var vmConsolidate = getConfigValue(storedbPath, posdbPath);
				*/
				if(Number(item.productType) == 3 && vmConsolidate == "1") //value meal we must have the total price
				{			
					//API.DbgMessageBox("VALUE MEAL");
					var line = view.ItemView[iItem].itemCode;
					var compItems =  view.ItemView.(Number(itemCode) == Number(line));
					
					for each (var compItem in compItems)
					{
						totalPrice = Number(totalPrice)+ Number(compItem.totalPrice);
					}
					//API.DbgMessageBox("total "+totalPrice);
				}
				
			}
			if((item.quantity != 0) || (item.specialModifiers == LIGHT) || (item.specialModifiers == ONLY)) {
				if((qtyLevelZero != 0) && ((toInt(item.fvmSts) == 0))) {
					var curLevel=item.level-1;
					var curQtty=qtyLevelZero;
					for(var i=iItem-1; i>=0 && view.ItemView[i].level != 0; i--) {
						if(curLevel == view.ItemView[i].level) {
							curQtty*=view.ItemView[i].quantity;
							curLevel--;
						}
					}
					addItemLine(item,curQtty,totalPrice);
				}
			}
		}
	}

	addLine();
	
	// Adds sub-total, tax an total information
	var totalAmt	= Number(view.@grossAmount);
	var taxAmt		= Number(view.@totalTax);
	var subTotalAmt	= Number(view.@totalAmount);        //totalAmt - taxAmt;
	var tenders		= view.ItemTenderView;
	var specialTend = tenders.(kind == TENDER_KIND_MANAGER_MEAL || kind == TENDER_KIND_CREW_MEAL || kind == TENDER_KIND_ALLOWANCE);
	var discounts	= tenders.(kind == TENDER_KIND_DISCOUNT_COUPON);
	if(specialTend.length() != 0) {
		// We have special tenders
		var mgrMeal = tenders.(kind == TENDER_KIND_MANAGER_MEAL)[0];
		var crwMeal = tenders.(kind == TENDER_KIND_CREW_MEAL)[0];
		var discount = tenders.(kind == TENDER_KIND_ALLOWANCE)[0];
//		var toAdd = (mgrMeal ? +mgrMeal.value : 0) + (crwMeal ? +crwMeal.value : 0) + (discount ? +discount.value : 0);
		addDetailLine(API.getLocalMsg("MSG_RECEIPT_SUBTOTAL"),  Number(view.@BDTotalAmount));
		if(mgrMeal) {
			addTenderLine(mgrMeal);
			delete(tenders.(kind == TENDER_KIND_MANAGER_MEAL)[0]);
		}
		if(crwMeal) {
			addTenderLine(crwMeal);
			delete(tenders.(kind == TENDER_KIND_CREW_MEAL)[0]);
		}
		if(discount) {
			addTenderLine(discount);
			delete(tenders.(kind == TENDER_KIND_ALLOWANCE)[0]);
		}
		addLine();
	}
	if(discounts.length() != 0) {
		// We have discount coupons that must go before Subtotal
		for each (var tender in discounts) {
			addTenderLine(tender);
		}
		for(var i = discounts.length() - 1; i >= 0; i--) {
			delete(tenders.(kind == TENDER_KIND_DISCOUNT_COUPON)[i]);
		}
	}
//	addDetailLine("Subtotal",	subTotalAmt);
//	addDetailLine("Tax",		taxAmt);
	if(isRefund) {
		if(isBillableSale)
			addDetailLine(API.getLocalMsg("MSG_RECEIPT_BILLABLE_SALE_ADJUSTMENT"),	totalAmt);
		else
			addDetailLine(API.getLocalMsg("MSG_RECEIPT_TOTAL_REFUND"),	totalAmt);
		addLine();			
		if(isBillableSale) {
			startBold(); {
				addLine(center(API.getLocalMsg("MSG_RECEIPT_DO_NOT_GIVE_CASH")));
			} endBold();
		}
	} 
	else {
		if(isWaste) {
			addDetailLine(API.getLocalMsg("MSG_RECEIPT_WASTE"),	totalAmt);
			addLine();
			addDetailLine(API.getLocalMsg("MSG_RECEIPT_TOTAL"), 0);
		}
		else {
			addDetailLine(saleTypes[saleType] + " " +API.getLocalMsg("MSG_RECEIPT_TOTAL_INCL_VAT"),	totalAmt);
			if(specialTend.length() != 0) {
				var rabatt =  Number(view.@BDTotalAmount) - totalAmt;
				addDetailLine(API.getLocalMsg("MSG_RECEIPT_DISCOUNT"),  rabatt );
			}
			// Jon Smith REMOVED 2008-10-01 starts
//			else {
//				if(totalAmt==0) { 
//					//addDetailLine(getCurrency(), 0);
//					addDetailLine(description, 0);
//				}
//			}
// Jon Smith REMOVED 2008-10-01 ends
		}	
//		addLine();
	}
	if((errKiosk!=2) && (!(isRefund && isBillableSale)) && !isWaste) {
		// Adds all tenders
		var hasChange	= false;
		var hasCash		= false;
		if(!isRefund) {
			var tenderItems = (isInProgress) ? view.ItemTenderView.(kind == "9") : view.ItemTenderView.(kind != "9");
			for each (var tender in tenderItems) {
				addTenderLine(tender);
			}
		}
		if(!hasChange) { // If we don't have any change add the default 0.00
//			addDetailLine("EUR", 0);
		}
	}
	if(isKiosk) {	
		var totalDue = Number(view.@totalDue);
		
		addLine();		
		if(errKiosk==2) {
			startBoldSize2(); { // Big  line		
				 addLine(API.getLocalMsg("MSG_RECEIPT_BALANCE_DUE") + API.formatNumber(Number(totalAmt), "##,##0.00", 9));
			} endBoldSize2();
			startBold(); {
				addLine();
				addLine();
				addLine(API.getLocalMsg("MSG_RECEIPT_SORRY_YOU_WERE"));
				addLine(API.getLocalMsg("MSG_RECEIPT_HAVING_TROUBLE"));
				addLine();
				addLine();
				addLine(API.getLocalMsg("MSG_RECEIPT_PLEASE_PRESENT_THIS"));
				addLine(API.getLocalMsg("MSG_RECEIPT_CREDIT_RECEIPT_AT"));
				addLine(API.getLocalMsg("MSG_RECEIPT_THE_PICKUP_COUNTER"));
				addLine();
			} endBold();		
			
			startBoldSize2(); { // Big  line		
				var credBalance = Number(totalAmt-totalDue);
				addLine(API.getLocalMsg("MSG_RECEIPT_CREDIT_BALANCE") + API.formatNumber(credBalance, "#0.00", 6));
			} endBoldSize2();
		}
		else {
			if(totalDue>0) {
				startBoldSize2(); { // Big  line		
					 addLine(API.getLocalMsg("MSG_RECEIPT_BALANCE_DUE") + API.formatNumber(totalDue, "##,##0.00", 9));
				} endBoldSize2();
			}
		}
		if(prnKiosk==1) {
			addLine(center((isFromKiosk)?"kiosk duplicate":"duplicate"));
		}
	}

	addLine();
//	addCashlessInfo(isRefund);
//	if(isOverring) {
//		var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
//		addLine("**** Last Sale # " + majorMinor + " VOIDED****");
//		addLine("    ADJUSTMENT NOTE - OVERRING");
//	}
	if(isInProgress) {
		addLine();
		var value=new BigDecimal("0.00");
		for each (var tender in tenderItems) {
			value=value.add(tender.value);
		}
		var line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_TOTAL_REFUND"), 26)
			+ " "
			+ API.formatNumber(value, NUMBER_FORMAT, 12);
		addLine(line);
		var secondCopy = outputBuffer + "";
		addLine(SEP_UL);
		addLine();addLine();addLine();addLine();addLine();addLine();
		cutPaper();
		addLine(secondCopy);
	}
	if((isRefund) && !separateChasLess) {
		if(signReceiptEnable == true && typeof(PosCheckSessionProperty)== "function") //in production this is not supported
		{
			API.dbg("rsa_signReceipt refund");
			var ctx = new SessionContext;
			if(!PosCheckSessionProperty ("CopyForDualPoint", "1")) //generate the signature just for the first receipt
			{
				orderId = ctx.get("refundOrder");
				var previousSignature = ctx.get("receipt_signature_refund");
				rsa_signReceipt("NDb", storeID, view.@orderKey.substring(5, 7), orderId, view.@grossAmount, view.@businessDay, view.@saleDate,  view.@saleTime, previousSignature, true);
			}
			else
			{
				if(PosCheckSessionProperty("rsa_sign_ok","1") == true)  //just if the loriginal receipt has a ignature 
				{
					var resultTlog = ctx.get("receipt_signature_refund");
					addLine(center(resultTlog[0]+""+resultTlog[10]+""+resultTlog[20]+""+resultTlog[30]));
					//addLine(center(API.getLocalMsg("SIGN_MESSAGE")));
					//addLine(center(certNumber));
					addLine();
				}
			}
		}
		if(Country == "PT")
		{
			checkDuplicate("RefundReason", "RefundSignature", "RefundSecondReceipt", false);
		}
		else
		{
		
			 if(newRefund ==true) // cannot put it along with portugal setup because we have a different receitp format
			 {
				addSignature(xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="Receipt").Parameter.(@name=="RefundSignature").@value, xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="Receipt").Parameter.(@name=="RefundReason").@value == "true", false);
				addLine(API.getLocalMsg("MSG_RECEIPT_ADDRESS"));
				addLine("___________________________________");
				addLine();
				addLine(API.getLocalMsg("MSG_RECEIPT_PHONE"));
				addLine("___________________________________");	
			}
			else
			{
			
				addLine(API.getLocalMsg("MSG_RECEIPT_AUTORIZED"));
				addLine(API.getLocalMsg("MSG_RECEIPT_SIGNATURE"));
				addLine();
				addLine(API.getLocalMsg("MSG_RECEIPT_ADDRESS"));
				addLine("___________________________________");
				addLine();
				addLine(API.getLocalMsg("MSG_RECEIPT_PHONE"));
				addLine("___________________________________");
				addLine();
				addLine(API.getLocalMsg("MSG_RECEIPT_REASON"));
				addLine("___________________________________");
			}	
			var secondCopy = outputBuffer + "";
			addLine();
			addLine(SEP_UL);
			addLine();addLine();addLine();addLine();addLine();addLine();
			cutPaper();
			addLine(secondCopy);
		}
	}

	if(!isWaste) {
		if(!isOverring)
		{
			if(signReceiptEnable == true && typeof(PosCheckSessionProperty)== "function") //in production this is not supported
			{
				var ctx = new SessionContext;
				
				if(!isRefund)
				{
					
					if(!PosCheckSessionProperty ("CopyForDualPoint", "1")) //generate the signature just for the first receipt
					{
						orderId = ctx.get("normalOrder");
						var previousSignature = ctx.get("receipt_signature");
						rsa_signReceipt("NVD", storeID, view.@orderKey.substring(5, 7), orderId, view.@grossAmount, view.@businessDay, view.@saleDate,  view.@saleTime, previousSignature, false);
					}
					else
					{
						if(PosCheckSessionProperty("rsa_sign_ok","1") == true)  //just if the original receipt has a signature 
						{
							var resultTlog = ctx.get("receipt_signature");
							addLine(center(resultTlog[0]+""+resultTlog[10]+""+resultTlog[20]+""+resultTlog[30]));
							//addLine(center(API.getLocalMsg("SIGN_MESSAGE")));
							//addLine(center(certNumber));
							addLine();
						}
					}	
				}
			}
		}
		if(Country == "FR")
		{
			for each (var taxItem in view.taxItem) {
				var szAmount=(taxItem.@ADAmount.toString().length != 0) ? taxItem.@ADAmount.toString() : taxItem.@amount.toString();
				var szBaseAmt=(taxItem.@ADBaseAmt.toString().length != 0) ? taxItem.@ADBaseAmt.toString() : taxItem.@baseAmt.toString();
				var taxBaseAmt=new BigDecimal(szBaseAmt);
				taxBaseAmt=taxBaseAmt.add(new BigDecimal(szAmount));
				var szrate   = API.formatNumber(Number(taxItem.@rate), "#0.00", 5);	
				szBaseAmt= API.formatNumber(Number(taxBaseAmt), "##,##0.00", 9);		
				szAmount = API.formatNumber(Number(szAmount), "##,##0.00", 9);
				addLine(API.setOnLeft("0"+taxItem.@id,3) + API.setOnLeft(ltrim(szBaseAmt),6) +" "+ " TVA A   "+ ltrim(szrate) + "% INCL. = " + API.setOnLeft(ltrim(szAmount),6));
				
			}
		}
		else if (Country =="PT")
		{
			for each (var taxItem in view.taxItem) {
				var szAmount=(taxItem.@ADAmount.toString().length != 0) ? taxItem.@ADAmount.toString() : taxItem.@amount.toString();
				var szBaseAmt=(taxItem.@ADBaseAmt.toString().length != 0) ? taxItem.@ADBaseAmt.toString() : taxItem.@baseAmt.toString();
				var szrate   = API.formatNumber(Number(taxItem.@rate), "#0.00", 5);	
				szAmount = API.formatNumber(Number(szAmount), "##,##0.00", 9);
				addLine(API.getLocalMsg("MSG_TVA_LIST_TEXT")+" "+ szrate+"%: "+ API.setOnLeft(ltrim(szAmount),6));
				}
		}
		else  
		{
			//18.02.2010 OI add parameter for VAT line on Kiosk Receipt
			/*
			var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"VATNumberOnKioskReceipt\").@value";
			var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"VATNumberOnKioskReceipt\").@value";
 			var VATonKioskReceipt = getConfigValue(storedbPath, posdbPath);
			*/
			API.dbg("VATNumberOnKioskReceipt: " +  VATonKioskReceipt);
			if(!isFromKiosk || VATonKioskReceipt == "true")
			{
				addLine(API.getLocalMsg("MSG_RECEIPT_VAT_NUMBER") + " " + vatNumber);
			}
			
			if(Number(view.taxItem.length()) !=0)
			{
				if(Country == "AT")
				{
					var len = (API.getLocalMsg("MSG_RECEIPT_INCL_TAX")+"A ").length;
					var msg="";
					for(var j=0; j<len; j++)
					{
						msg +=" ";
					}
					addLine(msg+API.getLocalMsg("MSG_RECEIPT_TAX_AMMOUNT_TAX"));	
				}
				else
				{
					addLine(API.getLocalMsg("MSG_RECEIPT_TAX_AMMOUNT_TAX"));	
				}	
			}	
			for each (var taxItem in view.taxItem) {
				var szAmount=(taxItem.@ADAmount.toString().length != 0) ? taxItem.@ADAmount.toString() : taxItem.@amount.toString();
				var szBaseAmt=(taxItem.@ADBaseAmt.toString().length != 0) ? taxItem.@ADBaseAmt.toString() : taxItem.@baseAmt.toString();
				var taxBaseAmt=new BigDecimal(szBaseAmt);
				if(Country !="UK") //for uk we have net price
				{
					taxBaseAmt=taxBaseAmt.add(new BigDecimal(szAmount));
				}
				var szrate   = API.formatNumber(Number(taxItem.@rate), "#0.00", 5);	
				szBaseAmt= API.formatNumber(Number(taxBaseAmt), "##,##0.00", 9);		
				szAmount = API.formatNumber(Number(szAmount), "##,##0.00", 9);
				if(Country == "AT")
				{
					if(Number(taxItem.@id) ==1)
					{
						addLine(API.getLocalMsg("MSG_RECEIPT_INCL_TAX")+"A " + szrate + "%  " + szBaseAmt + " " + szAmount);
					}
					else
					{
						addLine(API.getLocalMsg("MSG_RECEIPT_INCL_TAX")+"B " + szrate + "%  " + szBaseAmt + " " + szAmount);
					}
				}
				else
				{
					addLine( API.getLocalMsg("MSG_RECEIPT_INCL_TAX")+ szrate + "%  " + szBaseAmt + " " + szAmount);
				}
				
			}
			/*
			if(Country =="UK" || Country =="IE")
			{
				addLine();
				var PhoneNumber = rootConfig.StorePhoneNumber;
				addLine(API.getLocalMsg("MSG_RECEIPT_PHONE_NUMBER") + "     " + PhoneNumber);
				var vatNumber = (xmlStore.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="VAT").Parameter.(@name=="VatNumber")).@value;
				addLine(API.getLocalMsg("MSG_RECEIPT_VAT_NUMBER") + "     " + vatNumber);
			}
			*/
		}
		// DES-163 Changed by Lindomar Araujo in 29/02/2008 in Germany
		addLine();
	}
	
	if(isOverring) {
		addLine();
		addLine();
		var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
		addDetailLine(API.getLocalMsg("MSG_RECEIPT_TOTAL") , totalAmt);
		addLine();		
		addLine(API.getLocalMsg("MSG_RECEIPT_ORDER") + " # "+ majorMinor + " " + API.getLocalMsg("MSG_RECEIPT_OVERRING_END"));
		addLine(center(API.getLocalMsg("MSG_RECEIPT_OVERRING_NOTES")));
		checkDuplicate("OverringReason", "OverringSignature", "OverringSecondReceipt", false);
	}
	
	else if(view.@transactionKind == TRANS_KIND_CREW_MEAL) //crew meal orders
	{
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CrewMealReceiverSignature\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CrewMealReceiverSignature\").@value";
 		var crewMealReieverSignature = getConfigValue(storedbPath, posdbPath);		
		*/
		checkDuplicate("CrewMealReason", "CrewMealSignature", "CrewMealPrintSecondReceipt", crewMealReieverSignature == "true");
	}
	else if(view.@transactionKind == TRANS_KIND_MANAGER_MEAL) //mgr meal orders
	{
		checkDuplicate("ManagerMealReason", "ManagerMealSignature", "ManagerMealPrintSecondReceipt", false);
	}
	else if(checkPromoInOrder())  //promo in order
	{	
		checkDuplicate("PromoReason", "PromoSignature", "PromoPrintSecondReceipt", false);
	}
	else if(view.@transactionKind == "5") //discount
	{
		checkDuplicate("DiscountReason", "DiscountSignature", "DiscountPrintSecondReceipt", false);
	}
	
	
	//MS 28.03.2011 add the client cashless receipt if required
	if(combineOrderEcashReceipt == true && typeof(PosCheckSessionProperty)== "function") //if is enable and we do not print it from production
	{
		var ctx = new SessionContext;
		if(PosCheckSessionProperty("IsClientEcashReceipt", "true") ==true)
		{
			var ecashContent= ctx.get("cashlessReceiptBuffer");
			ctx.set("cashlessReceiptBuffer", "", true);
			ctx.set("IsClientEcashReceipt", "", true);
			if(ecashContent!= "")
			{
				addLine();
				outputBuffer.append(ecashContent);
			}
		}
	}
	
	addFooter();  //add Footer for normal receipts.

	//22.06.2010 OI dont print the PT stuff for copies CopyForDualPoint
	//in case of portugal we may need to print another receipt with contest code
	if(Country == "PT" && view.@transactionKind == TRANS_KIND_SALE && !isOverring && typeof(PosCheckSessionProperty)== "function"  && !PosCheckSessionProperty("CopyForDualPoint", "1"))
	{
		//test if contest is active
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"UaildeContest\").Parameter.(@name==\"Active\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"UaildeContest\").Parameter.(@name==\"Active\").@value";
 		var contest = getConfigValue(storedbPath, posdbPath);
		*/

			//se how many codes we need to generate
			searchContestProduct();
			// start change js 20100408 for ACSP8002684 Newpos 6.1 Script Change Request for Drive Marketing Campaign Code
			var systemDateTime = new Date;
			var systemDate = systemDateTime.getFullYear() + API.setZerosOnLeft(Number(systemDateTime.getMonth())+1, 2) + API.setZerosOnLeft(systemDateTime.getDate(), 2);
			if(Number(uaildeCodesNumber) > 0) //we only print codes for Ualide based on system date and parameters
			{
				storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"UaildeContest\").Parameter.(@name==\"StartDate\").@value";
				posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"UaildeContest\").Parameter.(@name==\"StartDate\").@value";
				var UCStartDate = getConfigValue(storedbPath, posdbPath);
				storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"UaildeContest\").Parameter.(@name==\"EndDate\").@value";
				posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"UaildeContest\").Parameter.(@name==\"EndDate\").@value";
				var UCEndDate = getConfigValue(storedbPath, posdbPath);
				// API.DbgMessageBox("System: " + systemDate + " UCStart: "+ UCStartDate + " UCEnd: " + UCEndDate);
				// Missing StartDate/EndDate are not valid
				if (!(systemDate >= UCStartDate && systemDate <= UCEndDate)) {
					uaildeCodesNumber = 0;	// no Uailde codes as not in date range
				}
			}
			// end change js 20100408 for ACSP8002684 Newpos 6.1 Script Change Request for Drive Marketing Campaign Code
			if(Number(uaildeCodesNumber) > 0) //we need to print codes 
			{
				addLine();addLine();addLine();addLine();addLine();addLine();
				cutPaper();
				var arrHeader= API.getLocalMsg("UAILDE_HEADER").split("||");  //each line is separately by || this is needed because otherwise we cannot center the line 
				for each (line in arrHeader)
				{
					addLine(API.center(line,42));
				}
				addLine();
			}
			var ctx = new SessionContext;
			for(var i = 0 ; i< Number(uaildeCodesNumber); i++)
			{
				
                var count = ctx.get("contestCount");
                if (undefined == count || null == count || 99 == count) //the counter is reseted at 99 
                {
                    count = 0;
                }
                ++count;
                ctx.set("contestCount", count, true);
				var code = generateContestCode(count, storeID, view.@orderKey.substring(5, 7), false); //each time we call the function we have another counter this is not change once per order
				addLine(API.center(code,42));
				addLine();
			}
			ctx= null;
			if(Number(uaildeCodesNumber) > 0) //we need to print codes 
			{
				startBold(); {
					addLine(API.center(API.getLocalMsg("UAILDE_PREMIOS"),42));
					addLine(API.center(API.getLocalMsg("UAILDE_SITE"),42));
				} endBold();				
				addLine();
				var arrFooter= API.getLocalMsg("UAILDE_FOOTER").split("||"); //each line is separately by || this is needed because otherwise we cannot center the line 
				for each (line in arrFooter)
				{
					addLine(API.center(line,42));
				}
				addLine();
				addLine(SEP_UL);
			}
			// start addition js 20100408 for ACSP8002684 Newpos 6.1 Script Change Request for Drive Marketing Campaign Code
			if(Number(driveCodesNumber) > 0) //we only print codes for DT based on system date and parameters
			{
				storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"DriveContest\").Parameter.(@name==\"StartDate\").@value";
				posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"DriveContest\").Parameter.(@name==\"StartDate\").@value";
				var DTStartDate = getConfigValue(storedbPath, posdbPath);
				storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"DriveContest\").Parameter.(@name==\"EndDate\").@value";
				posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"DriveContest\").Parameter.(@name==\"EndDate\").@value";
				var DTEndDate = getConfigValue(storedbPath, posdbPath);
				// API.DbgMessageBox("System: " + systemDate + " DTStart: "+ DTStartDate + " DTEnd: " + DTEndDate);
				// Missing StartDate/EndDate are not valid
				if (!(systemDate >= DTStartDate && systemDate <= DTEndDate)) {
					driveCodesNumber = 0;	// no DT codes as not in date range
				}
			}
			if(Number(driveCodesNumber) > 0) //we need to print codes for DT
			{
				addLine();addLine();addLine();addLine();addLine();addLine();
				cutPaper();
				startBold();
				var arrHeader= API.getLocalMsg("PT_DT_CONTEST_HEADER").split("||");  //each line is separately by || this is needed because otherwise we cannot center the line 
				for each (line in arrHeader)
				{
					//addLine(API.center(line,42));
					addLine(line);
				}
				endBold();
				addLine();
			}
			var ctx = new SessionContext;
			for(var i = 0 ; i< Number(driveCodesNumber); i++)
			{
				
                var count = ctx.get("contestCount");
                if (undefined == count || null == count || 99 == count) //the counter is reseted at 99 
                {
                    count = 0;
                }
                ++count;
                ctx.set("contestCount", count, true);
				var code = generateContestCode(count, storeID, view.@orderKey.substring(5, 7), true); //each time we call the function we have another counter this is not change once per order
				addLine(API.center(code,42));
//				addLine();
			}
			ctx= null;
			if(Number(driveCodesNumber) > 0) //we need to print codes for DT
			{
				var arrHeader= API.getLocalMsg("PT_DT_CONTEST_PREMIOS").split("||"); //each line is separately by || this is needed because otherwise we cannot center the line
				for each (line in arrHeader)
				{
				//	addLine(API.center(line,42));
					addLine(line);
				}
				
				var arrHeader= API.getLocalMsg("PT_DT_CONTEST_SITE").split("||"); //each line is separately by || this is needed because otherwise we cannot center the line
				for each (line in arrHeader)
				{
				//	addLine(API.center(line,42));
					addLine(line);
				}
				
				var arrFooter= API.getLocalMsg("PT_DT_CONTEST_FOOTER").split("||"); //each line is separately by || this is needed because otherwise we cannot center the line 
				for each (line in arrFooter)
				{
					//addLine(API.center(line,42));
					addLine(line);
				}
				addLine();
				addLine(SEP_UL);
			}
			// end addition js 20100408 for ACSP8002684 Newpos 6.1 Script Change Request for Drive Marketing Campaign Code
		
		
	}

	printReceiptLater();	
	return getResponse();

	function printReceiptLater()
	{
		//France request receipt with product that will be delivered later 
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"PrintLaterReceipt\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"PrintLaterReceipt\").@value";
		var printLaterReceipt = getConfigValue(storedbPath, posdbPath)=="true";
		*/
		if(printLaterReceipt == true)
		{
			var foundLaterProduct =false;  //set to true if we need to print  an additioanl receipt
			if((view.@transactionKind == TRANS_KIND_SALE || view.@transactionKind == TRANS_KIND_MANAGER_MEAL || view.@transactionKind == TRANS_KIND_CREW_MEAL || view.@transactionKind == "5") && !isOverring)
			{
				//check if we must print an additioanl reeipt
				
				//get the list of comments that must be defined as components for the products that will be delivered later
				/*
				storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CommentCode\").@value";
				posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"CommentCode\").@value";
				commentCode = getConfigValue(storedbPath, posdbPath);
				*/
				if(commentCode.length!=0 && commentCode!="")		
				{
					if(view.ItemView.(productCode == commentCode)+""!="")
					{
						foundLaterProduct =true;
					}				
				}
				if(foundLaterProduct ==true)
				{
					addLine();addLine();addLine();addLine();addLine();addLine();
					cutPaper();
					
					//add custom header
					addLine();
					addLine();
					addLine(SEP_UL);		
					startBold(); {
					var messageHeader = API.getLocalMsg("MSG_RECEIPT_LATER_TITLE");
					var arrMessageHeader = messageHeader.split("||");
					for(var i=0; i < arrMessageHeader.length; i++)
					{
						addLine(center(arrMessageHeader[i]));
					}
					}endBold();
					
					addLine();
					//var cashierLine = API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") +" "+ operatorID;
					//var storeLine = API.getLocalMsg("MSG_RECEIPT_STORE_ID") +" "+ storeID;
					//strLine = "#"+API.getLocalMsg("MSG_RECEIPT_ORDER_NO") + " " + majorMinor; //order naumber
					
					var strLine = API.getLocalMsg("MSG_RECEIPT_REG")  + " " + toInt(view.@orderKey.substring(3, 7)); //pos ID
					strLine +=" - "+ operatorName + " - ";
				  	var strLineDate = API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss"); //business date
					strLine += " -"+strLineDate;
					addLine(strLine);
					addLine();

					addLine(API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_PROD").substring(0,30), 30) + API.setOnRight(API.getLocalMsg("MSG_RECEIPT_QTY"), 10));
					listOfLaterProducts(commentCode);
					// add product line to the receipt
				}
			}
			if(foundLaterProduct == true)
			{
				addLine();
				//custom footer
				startBold(); {
				var messageFooter = API.getLocalMsg("MSG_RECEIPT_LATER_FOOTER1");
				var arrMessageFooter = messageFooter.split("||");
				for(var i=0; i < arrMessageFooter.length; i++)
				{
					addLine(center(arrMessageFooter[i]));
				}
				addLine(SEP_DL);	
				
				messageFooter = API.getLocalMsg("MSG_RECEIPT_LATER_FOOTER2");
				arrMessageFooter = messageFooter.split("||");
				for(var i=0; i < arrMessageFooter.length; i++)
				{
					addLine(center(arrMessageFooter[i]));
				}
				addLine();
				addLine(SEP_UL);
				}endBold();
			}
		}
	}
	
	/*
	this function will search for  products that must be delivred later includiong grill instructions
	*/
	function listOfLaterProducts(productCode)
	{
		for(var i=0; i<view.ItemView.length();i++)
		{
			  var item  = view.ItemView[i];
			  var j=0;
		      if(Number(item.productCode) == Number(productCode))
			  {
					//the product must be delivred plus tard
					//get the root product
					var productServedLater;
					if(Number(item.level) == 1) //if the grill level is 1 then we will have a normal product that was grilled
					{
						var arrProductServed = view.ItemView.(itemCode == item.itemCode); 
						productServedLater= arrProductServed[0]; //the first one in the view is the root product
						addReceiptLaterLine(productServedLater,1);
						//get other grill instruction for the product
						//API.DbgMessageBox(view.ItemView.(itemCode == item.itemCode).length());
						//API.DbgMessageBox(productServedLater.longName);
						for(var j=1; j< arrProductServed.length();j++) //the fist one is the root product
						{
							//API.DbgMessageBox("grill "+arrProductServed[j].longName+ " " +arrProductServed[j].isGrillLine);
							if(arrProductServed[j].isGrillLine == "true"  && Number(arrProductServed[j].level) == (Number(item.level)) &&  arrProductServed[j].productCode != item.productCode && Number(arrProductServed[j].itemCode) == Number(item.itemCode))
							{
								//API.DbgMessageBox(arrProductServed[j].longName);
								addReceiptLaterLine(arrProductServed[j]);
							}
							if(arrProductServed[j].isGrillLine != "true" ) //first time we not have a grill item we exit
							{
								break;
							}
						}
					}
					else //we have a vale meal or a value meal into another value meal 
					{
						//get all product with that itemCode and the level one less.
						var j=i;
						for(j=i-1; j>=0;j--)
						{
							if(view.ItemView[j].isGrillLine != "true"  && Number(view.ItemView[j].level) == (Number(item.level)-1) && Number(view.ItemView[j].itemCode) == Number(item.itemCode))
							{
								//in this case if there is a value meal then we need to send the qty from the root product
								productServedLater= view.ItemView[j];
								var rootProduct;
								var qtyVM = 1;
								if(productServedLater.productType == "2")
								{
									rootProduct = view.ItemView.(itemCode == productServedLater.itemCode);
									qtyVM = rootProduct[0].quantity;
								}
								
								addReceiptLaterLine(productServedLater, qtyVM, true);
								break;
							}
						}
						
						//get the grill instruction for the product that is delivred later if there are any
						for(j=j+1;j<view.ItemView.length();j++)
						{
							if(view.ItemView[j].isGrillLine != "true" ) //first time we not have a grill item we exit
							{
								break;
							}
							if(view.ItemView[j].isGrillLine+"" == "true"  && Number(view.ItemView[j].level) == (Number(item.level)) && Number(view.ItemView[j].itemCode) == Number(item.itemCode) && view.ItemView[j].productCode != item.productCode)
							{
								addReceiptLaterLine(view.ItemView[j]);
							}
						}
					}
			  }
		}
	}
	
	function addReceiptLaterLine(item, qtyVM, isValueMeal)
	{
		if(item.tbdStatus !="2")
		{
			if(item.isGrillLine !="true")
			{
				if(isValueMeal == true)
				{
					addLine(API.setOnLeft((item.longName).substring(0,26), 24)+" (VM) " + API.setOnRight(Number(item.quantity)*qtyVM, 10))	
				}
				else
				{
					addLine(API.setOnLeft((item.longName).substring(0,30), 30) + API.setOnRight(Number(item.quantity)*qtyVM, 10))	
				}
			}
			else
			{
				addLine("     " + getGrillDescription(item, true));
			}
		}
	}

	function checkDuplicate(reason, signature, duplicate, receiversign)
	{
		//check if we need the manager signature
		addSignature(xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="Receipt").Parameter.(@name==signature).@value, xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="Receipt").Parameter.(@name==reason).@value == "true", receiversign);
		//check if we need to print two receipts
		if(xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="Receipt").Parameter.(@name==duplicate).@value == "true") //need to print the second receipt
		{
			var backupBuffer = outputBuffer +"";
			addFooter(); //addFooter for the first receipt
			addLine();addLine();addLine();addLine();addLine();addLine();
			cutPaper();
			addLine(API.getLocalMsg("RECEIPT_DUPLICATE"));
			addLine(backupBuffer);
//			PosPrintPreview(backupBuffer);
//			PosPrintPreview(outputBuffer);
		}
	}
	
	/*Mihai Secareanu 08.07.2009
	* this function is used for Portugal Uailde Contest. It will compare the products sold with the products that are part of the contest.
	*the function will set the global variable uaildeCodesNumber, the total number of codes that need to be printed
	*/	
	function searchContestProduct()
	{
		var hlp = new BusinessObjectHelper;
		currView = hlp.getLastSaleView();

		xmlView= new XML(currView);
		var items = xmlView.ItemView;
		for each (item in items)
		{
			var prodCode = item.productCode+ "";
			arrProdCode= new Array();
			arrProdCode[0]= prodCode;
			//get the product information and update the number of codes if necessary
			hlp.iterateProductDB(arrProdCode, prodCode);
		}
	}
	/*
	* the function will check if the current order is a promo order 
	*/
	function checkPromoOrder()
	{
		for each (var item in view.ItemView)
		{
			if(Number(item.quantityPromo) != Number(item.quantity) && Number(item.level) == 0)
			{
				return false;
			}
		}
		return true;
	}
	/*
	* the function will check if the current order has any promo items 
	*/
	function checkPromoInOrder()
	{
		for each (var item in view.ItemView)
		{
			if((toInt(item.quantityPromo) != 0))
			{
				return true;
			}
		}
		return false;
	}
	function addFooter()
	{
		startBold(); {
			addDefaultFooter();
		} endBold();

		addLine(SEP_UL);	
		addLine();
		if(bPrintBarCode) {
			barCodeWithPOSID(view);
			addLine();
			addLine();
			addLine();
		}
	}
	/*@param 
	*	code: 1 =show manager name
	*		2= show manager name and crewn name
	*		else requier manager signature but do not show any name
	*	showReason: will hide reason tag 
	*	receiversign: just for crew meal signed for the crew
	*/
	function addSignature(code, showReason, receiversign)
	{
		//check to see if the mananger id and name should be displayed
		
		//default is true
		var hideIdName = xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="Receipt").Parameter.(@name=="dispalyNameId").@value == "false"; 
		if(showReason == true)
		{
			addLine(API.getLocalMsg("MSG_RECEIPT_REASON"));
			addLine();
		}
		if(code == "manager" || code == "both") //print the manager name
		{
			if(hideIdName == false)
			{
				addLine(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID")+": "+rootConfig.Manager.@id +" "+ rootConfig.Manager.@name);
			}
			else
			{
				addLine(API.getLocalMsg("MSG_RECEIPT_MANAGER_SIGNATURE"));
			}
			addLine();
			addLine(API.getLocalMsg("MSG_RECEIPT_SIGNATURE"));
			addLine();
		}
		if(code == "crew" || code == "both") //print the crew name
		{
			if(hideIdName == false)
			{
				addLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID")+" "+operatorID+ " "+ operatorName);
			}
			else
			{
				addLine(API.getLocalMsg("MSG_RECEIPT_CREW_SIGNATURE"));
			}
			addLine();
			addLine(API.getLocalMsg("MSG_RECEIPT_SIGNATURE"));
			addLine();
		}
		if (receiversign)
		{
			addLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_RECEIVER"));
			addLine();
			addLine(API.getLocalMsg("MSG_RECEIPT_SIGNATURE"));
			addLine();
		}
	}
	
	/*
	* this function will check if we have a new day . For a new day we reset the counters and we return true
	*/
	function checkBusinessDay()
	{
		//take the current business day. The getPosState does not return a valid xml so we need to parse it 
		var hlp = new BusinessObjectHelper;
		var posinfo = hlp.getPOSState()+"";
		var arrPos = posinfo.split("busDate=");
		var arrBussDate = arrPos[1].split("\""); // "20080915">
		var bussDate = arrBussDate[1];
		
		var ctx = new SessionContext;
		if(!PosCheckSessionProperty("businessDate",bussDate)) //we do not have the same date we need to reset the counters 
		{
			ctx.set("refundOrder", "0", true);
			ctx.set("wasteOrder", "0", true);
			ctx.set("normalOrder", "0", true);	
			ctx.set("orderId","-1",true); //reset orderid
			ctx.set("businessDate",bussDate,true); //set the new date
		}
		ctx = null;
	}

	// Increment a numeric session property, return the incemented number
	function PosGetSetIncSessionPropertyJS(key, newOrder)
	{
		var ctx = new SessionContext;
		var count = ctx.get(key);
		if (undefined == count || null == count || "" == count) {
			count = 0;
		}
		if(newOrder) //just if is a newOrder we need to increment the counter
		{
			++count;
			ctx.set(key, count, true);
		}
		ctx = null;
		return count;
	}

	/** Adds Cashless information (if any) and returns true if signature is required */
	function addCashlessInfo(isRefund) 
	{
	    API.dbg("addCashlessInfo");
		if(view.Cashless.length() == 0 ) {
			return;
		}
		var custom = view.Cashless;
		var lines = String(custom).split("CASHLESS:");
		var msg="";
		for(var i = 1; i < lines.length; i++) {
			var providerSale;
			var fields = String(lines[i]).split("@");
			var provider = fields[0].replace("CASHLESS:", ""); // + " SALE";
			if(isRefund) {
				providerSale = provider  + " REFUND";
			}else {
				providerSale = provider  + " SALE";
			}
			var card = " " + fields[1]; // Card #
			var expires = fields[2];	// Card expiration date
			var auth = fields[3];		// Authorization code
			var seq = fields[6];		// Sequence #
			var mer = fields[7];		// Merchant id
			var balance = API.formatNumber(Number(fields[8]), NUMBER_FORMAT, 12);	// Balance #
			var amt = fields[10];		// Operation amount
			if(fields[12].length!=0) {
				msg = fields[12];		    // Message
			}
			
			addLine("MER# " + mer);
			
			var firstCopy = "";
			var secondCopy = "";
			var needsSignature = fields[5] == "1";
			
			var line = "CARD ISSUER          ACCOUNT#";
			firstCopy = firstCopy + line + "\n";
			
			if(isRefund) {
				secondCopy = secondCopy + line + "\n";
			}else {
				secondCopy = secondCopy + line + "  EXP DATE" + "\n";
			}			
			
			line = API.setOnLeft(providerSale, 14) + card;
			firstCopy = firstCopy + line + "\n";
			if(isRefund) {
				secondCopy = secondCopy + line + "\n";
			}else {
				secondCopy = secondCopy + line + "  " + expires + "\n";
			}			
			
			if(provider == "Gift Card") {
				line = "TRANSACTION AMOUNT" + API.setOnRight(amt, COLS-18);
				firstCopy = firstCopy + line + "\n";
				secondCopy = secondCopy + line + "\n";				
			}
			
			line = "AUTHORIZATION CODE - " + auth + " SEQ# " + seq + "\n";
			firstCopy = firstCopy + line;
			secondCopy = secondCopy + line;
			
			if(provider == "Gift Card") {
				var trimBalance="$"+trim(balance)
				line = "\n<@BoldOn> GIFT CARD BALANCE\n      " + trimBalance + "<@BoldOff>";
				firstCopy = firstCopy + line;
				secondCopy = secondCopy + line;
			}
			
			firstCopy = firstCopy + "\n";
			secondCopy = secondCopy + "\n";
			if((needsSignature) || (isRefund)) {
				var auxQutputsecondCopy = outputBuffer + secondCopy;
				addLine(firstCopy);				
				if(needsSignature) {
					addLine(msg);
				}else {				
					/* Is refund */
					addLine();addLine();addLine();
					addLine(API.getLocalMsg("MSG_RECEIPT_AUTORIZED"));
					addLine(API.getLocalMsg("MSG_RECEIPT_SIGNATURE"));
					addLine();
					addLine(API.getLocalMsg("MSG_RECEIPT_ADDRESS"));
					addLine("___________________________________");
					addLine();
					addLine(API.getLocalMsg("MSG_RECEIPT_PHONE"));
					addLine("___________________________________");
					addLine();
					addLine(API.getLocalMsg("MSG_RECEIPT_REASON"));
					addLine("___________________________________");
				}
				
				addLine();
				addLine(SEP_UL);
				addLine();addLine();addLine();addLine();addLine();addLine();
				if(!isKiosk) {	
					cutPaper();
				}
				addLine(auxQutputsecondCopy);				
				if(needsSignature) {
					addLine();
					addLine();
					addLine("___________________________________");
					addLine(API.getLocalMsg("MSG_RECEIPT_AUTHORIZED_SIGNATURE"));
					addLine();
					addLine(msg);
					msg="";
				}else {
					/* Is refund */
					addLine();addLine();addLine();
					addLine(API.getLocalMsg("MSG_RECEIPT_AUTORIZED"));
					addLine(API.getLocalMsg("MSG_RECEIPT_SIGNATURE"));
					addLine();
					addLine(API.getLocalMsg("MSG_RECEIPT_ADDRESS"));
					addLine("___________________________________");
					addLine();
					addLine(API.getLocalMsg("MSG_RECEIPT_PHONE"));
					addLine("___________________________________");
					addLine();
					addLine(API.getLocalMsg("MSG_RECEIPT_REASON"));
					addLine("___________________________________");
				}			
			}else {
				addLine(firstCopy);
			}
		}
		addLine(msg);
	}
	
	/** Adds a tender line from an <ItemTenderView> tag */
	function addTenderLine(tender) 
	{
		var isKiosk     = (Number(view.@pod) == PODCSO) || isRcpKiosk;
		var isFromKiosk = (Number(view.@pod) == PODCSO);
		var description =  tender.description;
		if(Country == "UK")
		{
			description = API.getLocalMsg("MSG_RECEIPT_PAID")+" "+tender.description;
		}
		var code = toInt(tender.code);
		var kind = toInt(tender.kind); 
		var amount;
		var conversion = new BigDecimal("1.00");;
		if(tender.cat.toString() == "TENDER_FOREIGN_CURRENCY" && kind !=TENDER_KIND_CHANGE ) //is foreing currency and is not change
		{
			amount = Number(tender.fValue);
			conversion = Number(tender.value);	
		}
		else
		{
			amount = Number(tender.value);
		}
		if((kind == TENDER_KIND_PAYMENT) || (kind == TENDER_KIND_ORIGINAL_PAYMENT)) {
			switch (code) {
				case 0: 
					if(Country =="DE")
					{
						description = "EUR";
					}
					hasCash=true; 
					break;
				case 10: 
					// Falls thru
				case 11: 
					hasCash=true; 
					// Falls thru
				default: 
					if(Country =="DE")
					{
						description = tender.description + ((toInt(tender.qty) > 1)? " " + tender.qty : " "); 
					}	
					if(Country == "UK")
					{
						description = API.getLocalMsg("MSG_RECEIPT_PAID")+" "+tender.description;
					}
					break;
			}
		}else if(kind == TENDER_KIND_CHANGE) {
			description = API.getLocalMsg("MSG_RECEIPT_CHANGE");
			hasChange = true;
		}else if(kind == TENDER_KIND_MANAGER_MEAL) {
			//description = boHelper.getSysMessage("MSG_RECEIPT_MANAGER_MEAL");
			amount = -amount;
		}else if(kind == TENDER_KIND_CREW_MEAL) {
			//description = boHelper.getSysMessage("MSG_RECEIPT_EMPLOYEE_MEAL");
			amount = -amount;
		}else if(kind == TENDER_KIND_ALLOWANCE) {
			//description = boHelper.getSysMessage("MSG_RECEIPT_DISCOUNT");
			amount = -amount;
		}else if(kind == TENDER_KIND_DISCOUNT_COUPON) {
				if(Country =="DE")
				{
					description = tender.description + ((tender.qty > 1)? " " + tender.qty : " ");
				}	
				amount = amount;
		}else if(kind == TENDER_KIND_KEEP_CHANGE) {
			description = API.getLocalMsg("MSG_RECEIPT_EXCESS");
			amount = amount;
		}else {
			return;
		}

		if(isFromKiosk) {	
			if((view.@orderKey.substring(0, 7) == tender.srcPOSId)) {
				description=API.getLocalMsg("MSG_RECEIPT_KIOSK") + " " + description;
			}
			if(description == API.getLocalMsg("MSG_RECEIPT_KIOSK_CASH_TENDERED")) {
				if (amount != 0) {
					var pAmount = Number(tender.pValue);
					if(pAmount != amount) {
						addDetailLine(description, pAmount);
						description=API.getLocalMsg("MSG_RECEIPT_CASH_TENDERED");
						var v1=new BigDecimal(amount);
						var v2=new BigDecimal(pAmount);
						v2=v1.subtract(v2);
						amount=v2.toString();
					}
					addDetailLine(description, amount);
				}
			}else {
				if(description == API.getLocalMsg("MSG_RECEIPT_CHANGE")) {
					addLine();
					startBoldSize2(); { // Big  line	
						addLine(description + " due " + API.formatNumber(amount, "##,##0.00", 9));						
					} endBoldSize2();			
				}
				else {
					addDetailLine(description, amount);
				}
			}
		}
		else {
			if(description == API.getLocalMsg("MSG_RECEIPT_CASH_TENDERED")) {
				if (amount != 0) 
					addDetailLine(description, amount);
			}else {
				addDetailLine(description, amount);
			}
		}
		//for forigin currency we show also the covnersion rate
		if(tender.cat.toString() == "TENDER_FOREIGN_CURRENCY" && kind != TENDER_KIND_CHANGE)
		{
			addDetailLine(API.getLocalMsg("MSG_RECEIPT_CNV"), conversion);
		}
	}
	/** Adds a detail line given a description (string) and amount (number) */
	function addDetailLine(description, amount) 
	{
		var sig = "";
		var sizeAmount = 12;
		if(amount < 0) {
			amount = -amount;
			var sizeAmount = 10;
			sig = "- ";
		}
		addLine(API.setOnLeft(description, COLS-sizeAmount-sig.length) + sig + API.formatNumber(amount, NUMBER_FORMAT, sizeAmount));
	}
	/** Adds an item description given an <ItemView> tag */
	function addItemLine(item, qtyLevelZero, totalPrice) 
	{
		if(item.tbdStatus =="2")
		{
			return;
		}
	    //API.dbg("additemline "+ item);
		var ident = "";
		var level = toInt(item.level);
		
		var itemClass = item.productType.length();
		if (itemClass != 0) {
			if (item.productType == 4) {
				return;
			}
		}
		
		for(var i=0; i<level; i++) {
			ident += "  ";
		}
		if (item.level == 0) {
			qtyLevelZero = 1;
		}
		var aux = item.quantity  * qtyLevelZero;
		var qty = API.setOnRight(aux, 3);
		var name = item.longName;
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"receiptDisplayShortName\").@value"; 
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"receiptDisplayShortName\").@value";
		var displayShort = getConfigValue(storedbPath , posdbPath);
		*/
		if (isKioskTPUI && displayShort ==true) {
			name = item.description; //PLE-94
		}
		var price= Number(item.totalPrice);
		if(level > 0 && Number(totalPrice) !=0 && bConsolidate == false)
		{
			price = 0;
		}
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"hideGrillItemPrice\").@value"; 
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"hideGrillItemPrice\").@value";
		var hideGrillPrice = getConfigValue(storedbPath , posdbPath) == "true";
		*/
		if(item.isGrillLine == "true" && hideGrillPrice)
		{
			price = 0;
		}
		
		if(Number(item.productType) == 3 && level ==0 && vmConsolidate== "1" && bConsolidate == false)
		{
			price = totalPrice;
		}
		if(level > 0 && price == 0) {
			price = ""; // SDO-274 / SDO-300
		}else {
			price = API.formatNumber(price, NUMBER_FORMAT, 8);
		}
		if(toInt(item.quantityPromo) != 0) {
			// js - change requested by PT to align Promo indicators in a column
			if (Country =="PT")
			{
				price = API.setOnRight(item.quantityPromo + "P", 3) + API.formatNumber(ltrim(price), NUMBER_FORMAT, 7);
			}
			else
			{
				price = item.quantityPromo + "P " + ltrim(price);
			}
		}
		price = " " + price;
		var line = null;
		if(item.isGrillLine == "true") {
			line = "    " + ident + getGrillDescription(item, true);
		}else {
			line = ident + qty + " " + name;
		}
		
		var unitPrice= Number(item.unitPrice);
		unitPrice = API.formatNumber(unitPrice, "#0.00", 5);
		if (Country =="FR")
		{
			if(Number(unitPrice) ==0)
			{
				unitPrice="";
			}
			line = API.setOnLeft(line.substring(0,18), 18) + API.setOnLeft(unitPrice,7) +API.setOnRight(price,14);
		}
		else if (Country =="AT")
		{
			if(Number(item.taxChain.tax.@id) ==1)
			{
				price +="A";
			}
			else
			{
				price +="B";
			}
			line = API.setOnLeft(line.substring(0,18), 18) + API.setOnLeft(unitPrice, 7) +API.setOnRight(price,14);
		}
		else if (Country =="PT")
		{
			unitPrice = API.formatNumber(Number(unitPrice), "0.00",4);
			line = API.setOnLeft(line.substring(0,20), 21) + API.setOnLeft(unitPrice,5)+API.setOnLeft(item.taxChain.tax.@rate+"%",3)+API.setOnRight(price,11);	
		}
		else
		{
			line = API.setOnLeft(line, COLS-price.length) + price;
		}
		
		//last test if is grill line and we do not want to display grill item on the receipt that we should not add the line
		/*
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillItemsDisabled\").@value"; 
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillItemsDisabled\").@value";
		var GrillItemsDisabled = getConfigValue(storedbPath , posdbPath) == "true";
		*/
		if(GrillItemsDisabled == true)
		{
			if(item.isGrillLine == "true")
			{
				return;
			}
			else // no grill line
			{
				//in case of sadwich for the value meal we do not have to display it  because is only added because of the grill instruction
				//get the first product with the same itemCode
				if(Number(item.prodAction) == 0 && Number(item.level) !=0 &&  Number(item.productType)  == 2) //is the sandwich of a value meal 
				{
					//check all subitems of the current product.
					//get the value meal
					var products = view.ItemView.(itemCode == item.itemCode);
					var foundProduct = false;
					var showLine = false;
					for(var t= 0; t < products.length();t++)
					{
						if(foundProduct ==true)
						{
							//get sub items
							if(Number(products[t].level) > Number(item.level))
							{
								 //if is not a grill line then we should show the current product
								 if(products[t].isGrillLine !="true")
								 {
									showLine = true;
									break;
								 }
							}
							else
							{
								break;
							}
						}
						if(products[t].productCode == item.productCode) //we found the current product
						{
							foundProduct =true;
						}
					}
					if(showLine == true)
					{
						addLine(line);
					}
					return;
				}
				else
				{
					addLine(line);
				}
			}
		}
		else
		{
			addLine(line);
		}	
	}
}	

/*
* Helper function  this is already declared in businessCOmponentsLocal but is not seen at production level so it needs to be declare in here too.
* Parameters: storeDbPath - path to the desired parameter in store-db
*			  psoDbpath -path to the desired parameter in pos-db
* Returns the value of a configuration parameter
*/
 function getConfigValue(storeDbPath, posDbPath)
 {
	if(typeof(xmlStoreDB) =="undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}

	if(typeof(xmlPosDB) =="undefined")
	{
		xmlPosDB = new XML(API.getPosdb());
	}
	if(xmlPosDB == null)
	{
		xmlPosDB = new XML(API.getPosdb());
	}
	
	if(posDbPath!="" && posDbPath !=null)
	{
		var value = eval("xmlPosDB."+posDbPath);
		if(value+""!="")
		{
			return  value;
		}
	}
	return  eval("xmlStoreDB."+storeDbPath)+"";
		
 }




//***************** report_isp.nps*****************
/**
 * PUBLIC
 * Implements the customer receipt
 * Needed data types: VIEW
 * @author Celso Fernandes
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function receipt(config, data) {
		
	/*needed for production*/
	if(typeof(xmlStoreDB) == "undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	var Country = (xmlStoreDB.StoreDB.StoreProfile.StoreDetails.Country).toUpperCase();
	
	// Mihai Secareanu 22.03.2011 in case fiscal printer are used no receipt must be printed here
	if(isFiscalEnable == true)
	{
		outputBuffer = new StringBuffer();
		return  outputBuffer;
	}
	
	if(Country =="UK" || Country =="IE") //UK have a consoldiated receipt
	{
		return genericReceipt(config, data, PosCheckSessionProperty ("SecondPrintOutWithBarCode", "1"), true);
	}
	else
	{
		return genericReceipt(config, data, PosCheckSessionProperty ("SecondPrintOutWithBarCode", "1"), false);
	}
}

//***************** report_isp.nps*****************
/**
 * PUBLIC
 * Implements the expo receipt
 * Needed data types: VIEW
 * @author Celso Fernandes
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function expoReceipt(config, data) {
	
	/*needed for production*/
	if(typeof(xmlStoreDB) == "undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	
	//08.03.2010 OI print second receipt or picklist on network printer
	/*
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"DuplicateReceipt\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"DuplicateReceipt\").@value";
	var DuplicateReceipt = getConfigValue(storedbPath, posdbPath);

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"DuplicateReceiptWithBarCode\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"DuplicateReceiptWithBarCode\").@value";
	var DuplicateReceiptWithBarCode = getConfigValue(storedbPath, posdbPath);

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"Picklist\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"Picklist\").@value";
	var Picklist = getConfigValue(storedbPath, posdbPath);

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"PicklistWithBarCode\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"PrintOnServe\").Parameter.(@name==\"PicklistWithBarCode\").@value";
	var PicklistWithBarCode = getConfigValue(storedbPath, posdbPath);
	*/
	
	var Country = (xmlStoreDB.StoreDB.StoreProfile.StoreDetails.Country).toUpperCase();
	if(Country =="UK" || Country =="IE") //UK have a consoldiated receipt
	{
		if (DuplicateReceipt == "1" && DuplicateReceiptWithBarCode == "1")
		{
			return(genericReceipt(config, data, true, true));
		}else if (DuplicateReceipt == "1")
		{
			return(genericReceipt(config, data, false, true));
		}

		if (Picklist == "1" && PicklistWithBarCode == "1")
		{
			return(genericPickList(config, data, true, true));
		}
		else if (Picklist == "1")
		{
			return(genericPickList(config, data, false, true));
		}
	
	
		return(genericReceipt(config, data, true, true));
	}
	else
	{
		if (DuplicateReceipt == "1" && DuplicateReceiptWithBarCode == "1")
		{
			return(genericReceipt(config, data, true, false));
		}else if (DuplicateReceipt == "1")
		{
			return(genericReceipt(config, data, false, false));
		}

		if (Picklist == "1" && PicklistWithBarCode == "1")
		{
			return(genericPickList(config, data, true, true));
		}
		else if (Picklist == "1")
		{
			return(genericPickList(config, data, false, true));
		}
	
		return(genericReceipt(config, data, true, false));
	}
	
	
}

//**************report.nps*************************

/**
 * PUBLIC
 * Implements the customer receipt
 * Needed data types: VIEW
 * @author Celso Fernandes
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function receiptGift(config, data) 
{
	/*needed for production*/
	if(typeof(xmlStoreDB) == "undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	
	// Mihai Secareanu 22.03.2011 in case fiscal printer are used no receipt must be printed here
	if(isFiscalEnable == true)
	{
		outputBuffer = new StringBuffer();
		return  outputBuffer;
	}
	
	var Country = (xmlStoreDB.StoreDB.StoreProfile.StoreDetails.Country).toUpperCase();
	if(init(config, data, Array("VIEW"), "RTGFT") != 0) {
		return getResponse();
	}	
	if(rootConfig.CustomData.length() == 0) {
		return new StringBuffer();
	}
	// Order information
	var view		= rootView.View;
	addLine(SEP_UL);
	startBold(); {
		// Adds the default receipt header from store-db
		addDefaultHeader();
	} endBold();

	addLine();
	var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
	var kvsOrder = "Order " + majorMinor + " ";
	var posId = kvsOrder + "KS# " + toInt(view.@orderKey.substring(3, 7)); // Eg: POS0001:89 - > KS#1
	var date = API.formatDateTime(rootView.@creationDate, RECEIPT_DATE_FORMAT);
	addLine(posId + API.setOnRight(date, COLS-posId.length));
	addGiftInfo();
	addLine();
	addLine(SEP_UL);
	outputBuffer = addFlag(outputBuffer);
	return getResponse();
	
	/** Adds Cashless information (if any) and returns true if signature is required */
	function addGiftInfo() 
	{
		var custom = rootConfig.CustomData[0];
		var lines = String(custom).split("CASHLESS_GC:");
		for(var i = 1; i < lines.length; i++) {
			var fields = String(lines[i]).split("@");
			var provider = fields[0].replace("CASHLESS_GC", ""); // + " SALE";
			var providerSale = provider  + " SALE";
			var card = fields[1]; 		// Card #
			var expires = fields[2];	// Card expiration date
			var auth = fields[3];		// Authorization code
			var printFlag = fields[5];	// 
			var seq = fields[6];		// Sequence #
			var mer = fields[7];		// Merchant id
			var balance = API.formatNumber(Number(fields[8]), NUMBER_FORMAT, 12);	// Balance #			
			var amt = fields[9];		// Operation amount
			var vlr = fields[10];		// value
			var store = rootConfig.StoreId;
			var msg = fields[12];		// Mensagem
				
			if(i == 1) {
				addLine(API.center("STORE# " + store, 15)+"   "+API.center("MER# " + mer, 21));
			}
			
			startBold(); {
			addLine();
			addLine(center("GIFT CARD"));
			addLine(center("ACTIVATION RECEIPT"));
			} endBold();
			
			addLine();

			addLine("ACCOUNT# " + card);
			addLine("AUTH CODE " + auth  + "   SEQ# " + seq);
			if(provider == "Gift Card") {
				startBold(); {
				addLine();
				addLine(center("GIFT CARD BALANCE"));
				var trimBalance="$"+trim(balance)
				addLine(center(trimBalance));
				} endBold();
			}
			addLine();		
		}
		addLine(msg);
		addLine();		
		addLine(center("Keep this receipt for your records"));
	}	
}


// Author: Flaviu
// Description: Returns an array containing the codes of the grilled products specified on GrillDisplayReverseProductCodes.
function getGrillProductCodes()
{
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillDisplayReverseProductCodes\").@value";
	var values = getConfigValue( storedbPath, "");
    return ( values != null) ? values.split( ';') : null;
}

// Author: Flaviu
// Date: 08.04.2011
// Description: Checks if a product is in the array containing the codes of the grilled products specified on GrillDisplayReverseProductCodes. 
function isSpecialGrillProduct( grillProductCodes, item)
{
    for each ( var code in grillProductCodes)
    {
        if ( code == item.productCode)
        {
            return true;
        }
    }

    return false;
}

// Author: Flaviu
// Date: 08.04.2011
// Description: Reverses the color of a text.
function reverseColor( itemName)
{
	return "<@ReverseOn>" + itemName + "<@ReverseOff>";
}

// Author: Flaviu
// Date: 08.04.2011
// Description: Reverses the color of a text ensuring the resulted string to have the width specified.
function formatReverseColor( itemName, width)
{
    var itemNameAsString = itemName.toString();
    var itemLength = itemNameAsString.length;
    if ( itemLength < width)
    {
        return reverseColor( itemName) + API.replicate(" ", (width - itemLength).toString());
    }
	
    return reverseColor( itemName.substring( 0, width));
}

// Date: 08.04.2011
// Description: Tries to format the product name if the product code is specified in the special grilled products from GrillDisplayReverseProductCodes.
// The resulted string is trimmed or space-padded on right to ensure the length/width specified.
function getGrillFormattedItemName( grillProductCodes, item, itemName, width)
{
    if ( grillProductCodes != null && isSpecialGrillProduct( grillProductCodes, item) == true)
    { 
        return formatReverseColor( itemName, width);
    }

    if ( itemName.length < width)
	{
		return API.setOnLeft( itemName, width);
	}

    return itemName.substring( 0, width);
}



/*
Author Mihai Secareanu
Date: 13.12.2010
Description: new grill slip format for star printers requested by UK 
*/
function IntGrillSlipStarNew()
{
	if(typeof(xmlStoreDB) == "undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
	}

	var Country = (xmlStoreDB.StoreDB.StoreProfile.StoreDetails.Country).toUpperCase();
	
	var enableCut =  xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="printer").Parameter.(@name=="GrillPrinterEnableCutForLables").@value == "true"; 

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillDisplayLongName\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillDisplayLongName\").@value";
	var displayLong = getConfigValue(storedbPath , posdbPath) == "true";
	
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillStickerRows\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillStickerRows\").@value";
	var grillStickerRows = getConfigValue(storedbPath , posdbPath);
	
	
	if(grillStickerRows+"" =="")
	{
		grillStickerRows =3;
	}
	else
	{
		grillStickerRows = toInt(grillStickerRows)%10;
		if(grillStickerRows < 3)
		{
			grillStickerRows =3;
		}
	}

	var nodesView = rootView.View;
	outputBuffer.append("<@MarginOn>");
	addLine();
	//addLine("a "+nodesView.ItemView.length()+" "+nodesView.ItemView[0].level+" rows "  +grillStickerRows );
	
	var grillProductCodes = getGrillProductCodes();

	//add the header
	for each (var item in nodesView.ItemView)
	{
		if(toInt(item.level) == 0)
		{
			var isCancel = nodesView.@kind == "-1";
			var productName = item.description;
			var line ="";
			if(displayLong == true)
			{
				productName = item.longName;
			}
			
						
			if(isCancel == true)
			{
				var qty =0;
				if(toInt(item.quantity) == -1)
				{
					qty = -1* toInt(item.quantity);
				}
				line =  API.setOnRight(qty,2) + " " + getGrillFormattedItemName( grillProductCodes, item, productName, 18)
                        +" <@DoubleHorizontalOn>CANCELLED<@DoubleHorizontalOff>";	
			}
			else
			{
				line = API.setOnRight(item.quantity,2) + " ";
				
				if ( isSpecialGrillProduct( grillProductCodes, item))
                {
                    // reverse the color for the items specified in GrillDisplayReverseProductCodes and limit string width to 18
                    line += "<@DoubleHorizontalOn>" + formatReverseColor( productName, 18) + "<@DoubleHorizontalOff>";
                }
				else
                {
			        if(productName.length < 18)
			        {
				        productName = API.setOnLeft(productName, 18);
			        }
			        else
			        {
				        productName = productName.substring(0,18);
			        }

                    line += formatProduct(productName);
                }
			}
			addLine(line);
		}
	}
	
		
	var arrayBodyLines = new Array();
	//to do initialise array 
	for(var i=0; i< toInt(grillStickerRows);i++)
	{
		arrayBodyLines[i]="                ";
	}
	

	var line = "";
	//get the remPOD type
	line = API.setOnLeft(getRemPOD(nodesView),6);
	
	//get the production side
	line += API.setOnLeft((API.getLocalMsg("MSG_GRILL_STAR_KS")+nodesView.@orderKey.substring(5, 7)),10);
	arrayBodyLines[0] = line;
	
	//get time
	line = API.setOnLeft(API.getLocalMsg("MSG_GRILL_STAR_TIME"),6)+ API.setOnLeft(API.formatDateTime(rootView.@creationDate, "HH:mm"),10);
	arrayBodyLines[1] = line;
	
	//get order number
	var majorMinor = fnMountOrderId(String(nodesView.@orderId),String(nodesView.@orderKey),String(nodesView.@major),String(nodesView.@minor));		
	line = API.setOnLeft(API.getLocalMsg("MSG_GRILL_STAR_ORDER"), 6)+ API.setOnLeft(majorMinor,10);
	arrayBodyLines[2] = line;

	//first get the number of grill items
	var numberOfGrills = 0;
	for each (var item in nodesView.ItemView) 
	{
		if(Number(item.level) != 0 && item.isGrillLine =="true")
		{
			numberOfGrills++;	
		}
	}
	
	var grillsLeft = numberOfGrills - grillStickerRows+1;
	
	
	
	//add grill instruction
	var cntLine=0;
	var lines = 3;
	for each (var item in nodesView.ItemView) 
	{
		if(toInt(item.level) != 0)
		{
			if(displayLong == true)
			{
				arrayBodyLines[cntLine] +=  getGrillDescription(item,true).substring(0,26);
				addLine(arrayBodyLines[cntLine]);
			}
			else
			{
				arrayBodyLines[cntLine] += getGrillDescription(item,false).substring(0,26);
				addLine(arrayBodyLines[cntLine]);
			}
			cntLine++;
			if(cntLine  == grillStickerRows-1 && grillsLeft !=1) //if is the last line available and more then one grill left
			{
			
				if(grillsLeft == 0)   //just display the line no grill available
				{
					addLine(arrayBodyLines[cntLine]);
				}
				else  //how many grills were left
				{
					
					var params  = new Array();
					params[0]=grillsLeft;
					arrayBodyLines[cntLine] +=  API.getLocalMsg("MSG_GRILL_STAR_GRILLLEFT",params); // "(+"+ grillsLeft+ " more grills !)";
					addLine(arrayBodyLines[cntLine]);
				}
				cntLine++; // increment again because we  displayed the line
				break;
			}
			
		}
	}
	
	//if we have less grills then 3 lines 
	for(var i=cntLine; i<3;i++)
	{
		addLine(arrayBodyLines[i]);
	}

	
	function formatProduct(prodName)
	{
		var description  = "<@DoubleHorizontalOn>" + prodName.substr(0,18) + "<@DoubleHorizontalOff>";
		return description;
		
	}	
		
		
	function getRemPOD(view)
	{
	
	
		var varTypePod = Number(view.@pod);
		if(view.@remPod.length()>0){
			var varTypeRemPod = view.@remPod;
			if(varTypeRemPod != "11" && varTypeRemPod != "") {
				varTypePod = Number(varTypeRemPod);
			}
		}
		switch(varTypePod) {
			case 0: return "FC";
			case 1: return "DT";
			case 2: return "WT";
			case 8: return "CSO";
			default:
					return "NS";;
		}
	}
		
	return getResponse();	
}

/**
 * PUBLIC
 * Responsible for formating the grill slip (printed at production)
 * Needed data types: VIEW
 * @author Rodrigo
 */
function IntGrillSlip() 
{
	//addLine(API.getLocalMsg("MSG_SPECIAL_CHAR"));
	//return getResponse();
	if(typeof(xmlStoreDB) == "undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
	}

	var Country = (xmlStoreDB.StoreDB.StoreProfile.StoreDetails.Country).toUpperCase();
	
	var enableCut =  xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="printer").Parameter.(@name=="GrillPrinterEnableCutForLables").@value == "true"; 

	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillDisplayLongName\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Kiosk\").Parameter.(@name==\"GrillDisplayLongName\").@value";
	var displayLong = getConfigValue(storedbPath , posdbPath) == "true";
	
	var view = rootView.View;
	
	addLine(SEP_UL);
	addLine();
	
	if(Country =="IE")  //14.06.2010 UK wants now a different format
	{
		startBoldSize2();
		addLine(API.center(API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP"), 19));
        endBoldSize2();
	}
	var varTypePod = Number(view.@pod);
	if(view.@remPod.length()>0){
		var varTypeRemPod = view.@remPod;
		if(varTypeRemPod != "11" && varTypeRemPod != "") {
			varTypePod = Number(varTypeRemPod);
		}
	}
		switch(varTypePod) {
		case 0: RptFC(view, Country);
			 	break;
		case 1: RptDT(view, Country);
			 	break;
		case 2: RptWT(view, Country);
			 	break;
		case 8: RptCSO(view, Country);
			 	break;
		default:
				RptOther(Country);
	}
 	
	addLine();
	addLine(SEP_UL);
	addLine();
	addLine();
	
	
	if(Country =="NL" || Country =="UK" || Country =="IE") //WE FINISHED THE GRILL SLEEP SO WE MUST BUZZ
	{
		outputBuffer.append("<@GrillBuzzer>");
	}
	
	if(enableCut == true)
	{
		//mz 30.04.2009: append form feed and cut command at the end of grillprinter
		outputBuffer.append("<@FormFeed>");
		outputBuffer.append("<@Cut>");
	}
	
 	return getResponse();
	
	function formatGrillSlipUkHeader(nodesView)
	{
		var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
		var register = API.formatNumber(toInt(view.@orderKey.substring(3, 7)), "00",  2) ;
		
		
		var message ="";
		var isCancel = view.@kind == "-1";
		var isChange = view.@kind == "-2";
		//Header start
		if(isCancel) 
		{
			message ="CANCEL";
		}
		else
		{
			message ="      ";
		}
		if(isChange) 
		{
			message ="CHANGE";
		}
		
		API.dbg("Grill canceled");	
		addLine();
		outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+"  ");
		startBold();
		outputBuffer.append(message);
		endBold();
		outputBuffer.append("  TIME ");
		outputBuffer.append(""+API.formatDateTime(rootView.@creationDate, "HH:mm"));
		addLine();
		
		outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_REG")+" ");
		outputBuffer.append(""+register);
		outputBuffer.append("    "+API.getLocalMsg("MSG_RECEIPT_ORDER_NO")+ " ");
		outputBuffer.append(""+majorMinor);
		addLine();	
			
	}	
		
	/** creat report Front Counter **/
	function RptFC(nodesView, Country) 
	{
	    
		if(Country =="FR")
		{
			startBoldSize2(); { // Big empty line	
				addLine("     "+API.getLocalMsg("MSG_RECEIPT_GRILL_TITLE")); //title
				addLine(API.getLocalMsg("MSG_RECEIPT_REG")+" "+toInt(view.@orderKey.substring(3, 7))); //pos id
			} endBoldSize2();
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			addLine(API.getLocalMsg("MSG_RECEUPT_ORDER_NOR")+" # " + majorMinor);  //order number
			addLine();
			addLine(API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss"));
			startInvertedColor(); {
			addLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") + " "+view.@operatorId);//cassier id
			} endInvertedColor();
			addLine();
		}
		else if(Country =="UK")
		{
			formatGrillSlipUkHeader(nodesView);	
		}
		else
		{
			startBoldSize2(); { // Big empty line	
				var szSide =  (nodesView.@productionSide.substring(0,4) + " " + nodesView.@productionSide.substring(4,5)).toUpperCase();
				var szLine =  "       " + szSide;	
				addLine(szLine);
			} endBoldSize2();			
			
			szLine = API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+"     Time: " +  API.formatDateTime(rootView.@creationDate, "HH:mm")
			addLine(center(szLine));
			addLine();
			
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));		
			var register = "# " + toInt(view.@orderKey.substring(3, 7)); // Eg: POS0001:89 - > 1
			var order = "FC # " + majorMinor; // Eg: POS0001:89 - > 89		
			szLine = "KS " + API.setOnLeft(register, 4) + "    " + API.setOnRight(order, 8);
			if(Country =="IE")
			{
				addLine(szLine);
				addLine();
			}
			else
			{
				startBoldSize2(); { // Big empty line			
					addLine(szLine);
					addLine();
				}endBoldSize2();
			}
				
		}
		//items
			startBoldSize2();
			{ 
				 var grillProductCodes = getGrillProductCodes();
				 
				for each (var item in nodesView.ItemView) {
					if(Number(item.level) == 0) {
						var isCancel = nodesView.@kind == "-1";
						var productName = item.description;
						if(displayLong == true)
						{
							productName = item.longName;
						}
    				     // reverse the color for the items specified in GrillDisplayReverseProductCodes and limit string width to 17
                        productName = getGrillFormattedItemName( grillProductCodes, item, productName, 17);


						if(isCancel) {
							addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
							if(Country !="UK")
							{
								addLine("*** CANCEL GRILL ***");	
							}							
						}
						else {
						  if(Country =="FR" || Country =="UK")
						  {	 
							addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						  }
						  else
						  {
							addLine(" " + productName);
						  }
						}
						
						var isChange = nodesView.@kind == "-2";
						if(isChange) {
							if(Country =="UK")
							{
								addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
							}
							else
							{
								addLine("   *** CHANGE ***");	
							}							
						}
					}else {
						if(Country =="UK")
						{
							endBoldSize2();
							startBold();
							if(displayLong == true)
							{
								addLine("          " + getGrillDescription(item,true));
							}
							else
							{
								addLine("          " + getGrillDescription(item,false));
							}
							endBold();
							startBoldSize2();
						}
						else
						{
							if(displayLong == true)
							{
								addLine("    " + getGrillDescription(item,true));
							}
							else
							{
								addLine("    " + getGrillDescription(item,false));
							}
						}
						
					}
				}
			} endBoldSize2();						
		
	}
	/** creat report Drive Thru **/
	function RptDT(nodesView, Country) 
	{
	
		if(Country =="FR")
		{
			startBoldSize2(); { // Big empty line	
				addLine("     "+API.getLocalMsg("MSG_RECEIPT_GRILL_TITLE")); //title
				addLine(API.getLocalMsg("MSG_RECEIPT_REG")+" "+toInt(view.@orderKey.substring(3, 7))); //pos id
			} endBoldSize2();
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			addLine(API.getLocalMsg("MSG_RECEUPT_ORDER_NOR")+" # " + majorMinor);  //order number
			addLine();
			addLine(API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss"));
			startInvertedColor(); {
			addLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") + " "+view.@operatorId);//cassier id
			} endInvertedColor();
			addLine();
			
			
		}
		else if(Country =="UK")
		{
			formatGrillSlipUkHeader(nodesView);	
		}
		else
		{
	
			startBoldSize2(); { // Big empty line
				addLine("DT                DT");
				var szSide =  (nodesView.@productionSide.substring(0,4) + " " + nodesView.@productionSide.substring(4,5)).toUpperCase();
				var szLine =  "       " + szSide;	
				addLine(szLine);
			} endBoldSize2();		
			
			szLine = API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+"     Time: " +  API.formatDateTime(rootView.@creationDate, "HH:mm")
			addLine(center(szLine));
			addLine();
		
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			var order = "   # " + majorMinor; // Eg: POS0001:89 - > 89		
			if(Country == "UK" || Country =="IE")
			{
				addLine(order);
				addLine();
			}
			else
			{
				startBoldSize2(); { // Big empty line			
					addLine(order);
					addLine();
				}endBoldSize2();
			}	
		}
		startBoldSize2(); 
		{
		    var grillProductCodes = getGrillProductCodes();

			for each (var item in nodesView.ItemView) {
				if(Number(item.level) == 0) {
					var isCancel = nodesView.@kind == "-1";
					var productName = item.description;
					if(displayLong == true)
					{
						productName = item.longName;
					}
					 // reverse the color for the items specified in GrillDisplayReverseProductCodes and limit string width to 17
                    productName = getGrillFormattedItemName( grillProductCodes, item, productName, 17);


					if(isCancel) {
						addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						if(Country !="UK")
						{
							addLine("*** CANCEL GRILL ***");	
						}						
					}
					else {
						if(Country =="FR" || Country =="UK")
						  {	 
							addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						  }
						  else
						  {
							addLine("  " + productName);
						  }
					}
					
					var isChange = nodesView.@kind == "-2";
					if(isChange) {
						if(Country =="UK")
						{
							addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						}
						else
						{
							addLine("   *** CHANGE ***");	
						}							
					}
				}else {
					if(Country =="UK")
					{
						endBoldSize2();
						startBold();
						if(displayLong == true)
						{
							addLine("          " + getGrillDescription(item,true));
						}
						else
						{
							addLine("          " + getGrillDescription(item,false));
						}
						endBold();
						startBoldSize2();
					}
					else
					{
						if(displayLong == true)
						{
							addLine("    " + getGrillDescription(item,true));
						}
						else
						{
							addLine("    " + getGrillDescription(item,false));
						}
					}
				}
			}	
			if(Country !="FR" && Country !="UK")
			{			
				addLine("DT                DT");
			}
		} endBoldSize2();
	}
	
	/** creat report Walk Thru **/
	function RptWT(nodesView, Country) 
	{
		if(Country =="FR")
		{
			startBoldSize2(); { // Big empty line	
				addLine("     "+API.getLocalMsg("MSG_RECEIPT_GRILL_TITLE")); //title
				addLine(API.getLocalMsg("MSG_RECEIPT_REG")+" "+toInt(view.@orderKey.substring(3, 7))); //pos id
			} endBoldSize2();
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			addLine(API.getLocalMsg("MSG_RECEUPT_ORDER_NOR")+" # " + majorMinor);  //order number
			addLine();
			addLine(API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss"));
			startInvertedColor(); {
			addLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") + " "+view.@operatorId);//cassier id
			} endInvertedColor();
			addLine();
			
			
		}
		else if(Country =="UK")
		{
			formatGrillSlipUkHeader(nodesView);	
		}
		else
		{
			startBoldSize2(); { // Big empty line	
				var szSide =  (nodesView.@productionSide.substring(0,4) + " " + nodesView.@productionSide.substring(4,5)).toUpperCase();
				var szLine =  "       " + szSide;	
				addLine(szLine);
			} endBoldSize2();			
			
			szLine = API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+"     Time: " +  API.formatDateTime(rootView.@creationDate, "HH:mm")
			addLine(center(szLine));
			addLine();
			
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));		
			var register = "# " + toInt(view.@orderKey.substring(3, 7)); // Eg: POS0001:89 - > 1
			var order = "WT # " + majorMinor; // Eg: POS0001:89 - > 89		

			szLine = "KS " + API.setOnLeft(register, 4) + "    " + API.setOnRight(order, 8);
			if(Country == "UK" || Country =="IE")
			{
				addLine(szLine);
				addLine();
			}
			else
			{
				startBoldSize2(); { // Big empty line			
					addLine(szLine);
					addLine();
				}endBoldSize2();
			}
		}
		startBoldSize2(); 
		{
            var grillProductCodes = getGrillProductCodes();

			for each (var item in nodesView.ItemView) {
				if(Number(item.level) == 0) {
					var isCancel = nodesView.@kind == "-1";
					var productName = item.description;
					if(displayLong == true)
					{
						productName = item.longName;
					}
				    // reverse the color for the items specified in GrillDisplayReverseProductCodes and limit string width to 17
                    productName = getGrillFormattedItemName( grillProductCodes, item, productName, 17);

					if(isCancel) {
						addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						if(Country !=="UK")
						{
							addLine("*** CANCEL GRILL ***");
						}						
					}
					else {
					  if(Country =="FR" || Country =="UK")
					  {	 
						addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
					  }
					  else
					  {
						addLine("  " + productName);
					  }
					}
					
					var isChange = nodesView.@kind == "-2";
					if(isChange) {
						if(Country =="UK")
						{
							addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						}
						else
						{
							addLine("   *** CHANGE ***");		
						}			
					}
				}else {
					if(Country =="UK")
					{
						endBoldSize2();
						startBold();
						if(displayLong == true)
						{
							addLine("          " + getGrillDescription(item,true));
						}
						else
						{
							addLine("          " + getGrillDescription(item,false));
						}
						endBold();
						startBoldSize2();
					}
					else
					{
						if(displayLong == true)
						{
							addLine("    " + getGrillDescription(item,true));
						}
						else
						{
							addLine("    " + getGrillDescription(item,false));
						}
					}
				}
			}
		} endBoldSize2();						
	}
	
	
	/** creat report CSO - Kiosk **/
	function RptCSO(nodesView, Country) 
	{
		if(Country =="FR")
		{
			startBoldSize2(); { // Big empty line	
				addLine("     "+API.getLocalMsg("MSG_RECEIPT_GRILL_TITLE")); //title
				addLine(API.getLocalMsg("MSG_RECEIPT_REG")+" "+toInt(view.@orderKey.substring(3, 7))); //pos id
			} endBoldSize2();
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			addLine(API.getLocalMsg("MSG_RECEUPT_ORDER_NOR")+" # " + majorMinor);  //order number
			addLine();
			addLine(API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss"));
			startInvertedColor(); {
			addLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") + " "+view.@operatorId);//cassier id
			} endInvertedColor();
			addLine();
			
			
		}
		else if(Country =="UK")
		{
			formatGrillSlipUkHeader(nodesView);	
		}
		else
		{
			startBoldSize2(); { // Big empty line
				addLine("CSO              CSO");
				var szSide =  (nodesView.@productionSide.substring(0,4) + " " + nodesView.@productionSide.substring(4,5)).toUpperCase();
				var szLine =  "       " + szSide;	
				addLine(szLine);
			} endBoldSize2();		
			
			szLine = API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+"     Time: " +  API.formatDateTime(rootView.@creationDate, "HH:mm")
			addLine(center(szLine));
			addLine();
			
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			var order = "   # " + majorMinor; // Eg: POS0001:89 - > 89		
			if(Country == "UK" || Country =="IE")
			{
				addLine(order);
				addLine();
			}
			else
			{
				startBoldSize2(); { // Big empty line			
					addLine(order);
					addLine();
				}endBoldSize2();
			}	
		}
		startBoldSize2();
		{
		    var grillProductCodes = getGrillProductCodes();

			for each (var item in nodesView.ItemView) {
				if(Number(item.level) == 0) {
					var isCancel = nodesView.@kind == "-1";
					var productName = item.description;
					if(displayLong == true)
					{
						productName = item.longName;
					}
					// reverse the color for the items specified in GrillDisplayReverseProductCodes and limit string width to 17
                    productName = getGrillFormattedItemName( grillProductCodes, item, productName, 17);

					if(isCancel) {
						addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						if(Country !=="UK")
						{
							addLine("*** CANCEL GRILL ***");
						}						
					}
					else {
						if(Country =="FR" || Country =="UK")
						  {	 
							addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						  }
						  else
						  {
							addLine("  " + productName);
						  }
					}
					
					var isChange = nodesView.@kind == "-2";
					if(isChange) {
						if(Country =="UK")
						{
							addLine("  " + Math.abs(toInt(item.quantity)) + " " + productName);
						}
						else
						{
							addLine("   *** CHANGE ***");		
						}					
					}
				}else {
					if(Country =="UK")
					{
						endBoldSize2();
						startBold();
						if(displayLong == true)
						{
							addLine("          " + getGrillDescription(item,true));
						}
						else
						{
							addLine("          " + getGrillDescription(item,false));
						}
						endBold();
						startBoldSize2();
					}
					else
					{
						if(displayLong == true)
						{
							addLine("    " + getGrillDescription(item,true));
						}
						else
						{
							addLine("    " + getGrillDescription(item,false));
						}
					}
				}
			}		
			if(Country !="FR" && Country !="UK")
			{			
				addLine("CSO              CSO");
			}
		} endBoldSize2();
	}
	
	function RptOther(Country) 
	{	
		API.dbg("IntGrillSlip RptOther");
		var view = rootView.View;
		var isCancel = view.@kind == "-1";
		var line = "";
		var temPOD = Number(view.@pod);
		
		if(isCancel) {
			startInvertedColor(); {
				addBoldSize2Line("### CANCEL GRILL ###");
			} endInvertedColor();
		}

		if(Country =="FR")
		{
			startBoldSize2(); { // Big empty line	
				addLine("     "+API.getLocalMsg("MSG_RECEIPT_GRILL_TITLE")); //title
				addLine(API.getLocalMsg("MSG_RECEIPT_REG")+" "+toInt(view.@orderKey.substring(3, 7))); //pos id
			} endBoldSize2();
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			addLine(API.getLocalMsg("MSG_RECEUPT_ORDER_NOR")+" # " + majorMinor);  //order number
			addLine();
			addLine(API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss"));
			startInvertedColor(); {
			addLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID") + " "+view.@operatorId);//cassier id
			} endInvertedColor();
			addLine();
			
			
		}
		else if(Country =="UK")
		{
			formatGrillSlipUkHeader(nodesView);	
		}
		else if (Country =="DE")
		{
			startBoldSize2(); {
				addLine(); // Big empty line
				addLine("**** GRILL SLIP ****");
				addLine(); // Big empty line
			} endBoldSize2();
			addLine("MFY " + view.@productionSide);
			var register = toInt(view.@orderKey.substring(3, 7)); // Eg: POS0001:89 - > 1
			var order = toInt(view.@orderKey.substring(8)); // Eg: POS0001:89 - > 89
			startInvertedColor(); {
				addLine("Register " + register + " - Order # " + order);
			} endInvertedColor();
			var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			addLine("DRIVE-THRU Order " + majorMinor);
			addLine();
			addLine(API.formatDateTime(rootView.@creationDate, RECEIPT_DATE_FORMAT));
			addLine();
		}
		else
		{
		
			line = getPODText(temPOD) + " " + API.getLocalMsg("MSG_RECEIPT_KS") + "#" + toInt(view.@orderKey.substring(3, 7)); //register
			line = line + " " + API.getLocalMsg("MSG_RECEIPT_SLP") + "#" +  fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor)); //slip number
			var time = API.formatTime(rootView.@creationDate.substring(9, 17), "HH:mm");
			line = line + " " + API.getLocalMsg("MSG_RECEIPT_TIME") + " " +  time;
			addLine();
			addLine(line);
			/*startBoldSize2(); {
				addLine(); // Big empty line
				addLine("**** GRILL SLIP ****");
				addLine(); // Big empty line
			} endBoldSize2();*/
			//addLine("MFY " + view.@productionSide);
			//var register = toInt(view.@orderKey.substring(3, 7)); // Eg: POS0001:89 - > 1
			//var order = toInt(view.@orderKey.substring(8)); // Eg: POS0001:89 - > 89
			//startInvertedColor(); {
				//addLine("Register " + register + " - Order # " + order);	
			//} endInvertedColor();
			//var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
			//addLine("DRIVE-THRU Order " + majorMinor);
			//addLine();
			//addLine(API.formatDateTime(rootView.@creationDate, RECEIPT_DATE_FORMAT));	//TODO: anderes Datum
			addLine();
		}
	
    	var grillProductCodes = getGrillProductCodes();

		for each (var item in view.ItemView) {
			if(Number(item.level) == 0) {
					var productName = item.description;
					if(displayLong == true)
					{
						productName = item.longName;
					}
					
					// reverse the color for the items specified in GrillDisplayReverseProductCodes and limit string width to 17
					productName = getGrillFormattedItemName( grillProductCodes, item, productName, 17);

					
				startBoldSize2();
				addLine(API.setZerosOnLeft(item.quantity, 2) + " " + productName);
				endBoldSize2();
			}else {
				if(Country =="UK")
				{
					endBoldSize2();
					startBold();
					if(displayLong == true)
					{
						addLine("          " + getGrillDescription(item,true));
					}
					else
					{
						addLine("          " + getGrillDescription(item,false));
					}
					endBold();
					startBoldSize2();
				}
				else
				{
					if(displayLong == true)
					{
						addLine("    " + getGrillDescription(item,true));
					}
					else
					{
						addLine("    " + getGrillDescription(item,false));
					}
				}
			}
		}
		addLine();
		if(isCancel && Country!="UK") {
			startInvertedColor(); {
				addBoldSize2Line("### CANCEL GRILL ###");
			} endInvertedColor();
		}
	}
	/*
	if(Country =="UK" || Country =="IE")
	{
		//mz 30.04.2009: append form feed and cut command at the end of grillprinter
		outputBuffer.append("<@FormFeed>");
		outputBuffer.append("<@Cut>");
	}
	*/
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the grill slip (printed at production) for Zebra printers
 * Needed data types: VIEW
 * @author Markus Ziegler
 */
function IntGrillSlipZebraStar(zebra) 
{
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillDisplayLongName\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillDisplayLongName\").@value";
	var displayLong = getConfigValue(storedbPath , posdbPath) == "true";

	var view = rootView.View;

   	var glo_CancelGrillOn = "0";
	var szRegType = "";

	
	//ordernumber. The ordernumber has to be 5 characters long.
	//var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
	var majorMinor = toInt(view.@orderKey.substring(3, 7));
	/*
	if(majorMinor.length < 8)
	{
		while(majorMinor.length < 8) 
		{
			majorMinor="0"+majorMinor;
		}
	}
	else
	{
		majorMinor = majorMinor.substring(0,8);
	}
	*/
	//set register type
	/* 
	var varTypePod = Number(view.@pod);
	if(view.@remPod.length()>0)
	{
		var varTypeRemPod = view.@remPod;
		if(varTypeRemPod != "11" && varTypeRemPod != "") 
		{
			varTypePod = Number(varTypeRemPod);
		}
	}
	MS 14.06.2010 not required anymore
	switch(varTypePod) 
	{
		case 0: szRegType = "FC";
			 	break;
		case 1: szRegType = "DT";
			 	break;
		default:
			szRegType = "  ";
	}
	*/
	//register number
	var register = API.formatNumber(toInt(view.@orderKey.substring(3, 7)), "00",  2) ; // Eg: POS0001:89 - > 01
	
	//i know the logging is not working but maybe one day it will...
	API.dbg("IntGrillSlipZebraStar called. Ordernumber: "+majorMinor+" registertype: "+szRegType+"/"+" register number: "+register+ " Zebra: "+zebra);
	
	//GrillBuzzer before printing:
	//outputBuffer.append("<@GrillBuzzer>"); not suported for star and zebra printer
    var grillProductCodes = getGrillProductCodes();

	for each (var item in view.ItemView) 
	{//the production should only send one item with level=0
		if(Number(item.level) == 0) 
		{//this is the main grill item
			var isCancel = view.@kind == "-1";
			//Header start
			
			if(isCancel) 
			{
				API.dbg("Grill canceled");	
				if(zebra)
				{		
					outputBuffer.append("_______________________________________\r\n");
					outputBuffer.append("<@ZebraDoubleCharOff>");
					outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+" ");
					outputBuffer.append("<@ZebraDoubleCharOn>");
					outputBuffer.append("CANCEL  ");
					outputBuffer.append("<@ZebraSpecialSequence>");
					outputBuffer.append("<@ZebraDoubleCharOff>");
					//MS added 14.06.2010  
					outputBuffer.append("  TIME ");
					outputBuffer.append(""+API.formatDateTime(rootView.@creationDate, "HH:mm"));
					outputBuffer.append("\n");
					
				}
				else
				{	
					outputBuffer.append("\r\n");
					outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+" ");
					outputBuffer.append("<@DoubleCharOn>");
					outputBuffer.append("CANCEL  ");
					outputBuffer.append("<@DoubleCharOff>");
					
					outputBuffer.append("  TIME ");
					outputBuffer.append(""+API.formatDateTime(rootView.@creationDate, "HH:mm"));
					
					outputBuffer.append("\r\n");
				}
			}
			else 
			{				
				API.dbg("Grill slip");
				if(zebra)
				{
					outputBuffer.append("\n\r\n_______________________________________\r\n");
					outputBuffer.append("<@ZebraDoubleCharOff>");
					outputBuffer.append("<@ZebraDoubleCharOn>");
					outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+"                ");
					outputBuffer.append("<@ZebraSpecialSequence>");
					outputBuffer.append("<@ZebraDoubleCharOff>");	
					//MS added 14.06.2010  
					outputBuffer.append("  TIME ");
					outputBuffer.append(""+API.formatDateTime(rootView.@creationDate, "HH:mm"));
					outputBuffer.append("\n");
				}
				else
				{
					outputBuffer.append("\r\n");
					outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+"                 ");
					outputBuffer.append("  TIME ");
					outputBuffer.append(""+API.formatDateTime(rootView.@creationDate, "HH:mm"));
					outputBuffer.append("\r\n");
				}
			}
			var isChange = view.@kind == "-2";
			if(isChange) 
			{//THIS is just a try
				API.dbg("Grill change");
				if(zebra)
				{
					outputBuffer.append("\n\r\n_______________________________________\r\n");
					outputBuffer.append("<@ZebraDoubleCharOff>");
					outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+" ");
					outputBuffer.append("<@ZebraDoubleCharOn>");
					outputBuffer.append("CHANGE  ");
					outputBuffer.append("<@ZebraSpecialSequence>");
					outputBuffer.append("\n");
					outputBuffer.append("<@ZebraDoubleCharOff>");
					//MS added 14.06.2010  
					outputBuffer.append("  TIME ");
					outputBuffer.append(""+API.formatDateTime(rootView.@creationDate, "HH:mm"));					
				}
				else
				{
					outputBuffer.append("\r\n");
					outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_GRILL_SLIP")+" ");
					outputBuffer.append("<@DoubleCharOn> ");
					outputBuffer.append("CHANGE  ");
					outputBuffer.append("<@DoubleCharOff> ");
					outputBuffer.append("  TIME ");
					outputBuffer.append(""+API.formatDateTime(rootView.@creationDate, "HH:mm"));
					outputBuffer.append("\r\n");	
				}
			}

			if(zebra)
			{
				//outputBuffer.append(szRegType);

				outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_REG")+" ");
				outputBuffer.append(""+register);
				outputBuffer.append("<@ZebraBinNull>  ");
				outputBuffer.append("          "+API.getLocalMsg("MSG_RECEIPT_ORDER_NO")+ " ");
				outputBuffer.append(""+majorMinor);
				//outputBuffer.append("-");
				//outputBuffer.append(""+ minor);
				outputBuffer.append("<@ZebraBinNull> ");
				/*
				outputBuffer.append("TIME ");
				outputBuffer.append(""+API.formatDateTime(rootView.@creationDate, "HH:mm"));
				*/
				outputBuffer.append("<@ZebraSpecialSequence>");
				outputBuffer.append("\n");
				//Header finished

				//Main Item description
				var qty = API.formatNumber(Math.abs(toInt(item.quantity)), "#0", 2);
				var descr = item.description;
				if(displayLong == true)
				{
					descr = item.longName;
				}
				 // reverse the color for the items specified in GrillDisplayReverseProductCodes and limit string width to 17
                descr = getGrillFormattedItemName( grillProductCodes, item, descr, 17);


				 API.dbg("Grilled item QTY and name: "+qty+ " " +descr);
				 outputBuffer.append("<@ZebraDoubleCharOff>");
				 outputBuffer.append("<@ZebraBinNull>");
				 outputBuffer.append("<@ZebraDoubleCharOn>");
				 outputBuffer.append(""+qty);
				 outputBuffer.append(""+ descr);
				 outputBuffer.append("\n");
				 outputBuffer.append("<@ZebraDoubleCharOff>"); 
				//end Main Item description
			}
			else
			{
				

				outputBuffer.append("   "+API.getLocalMsg("MSG_RECEIPT_REG")+" ");
				outputBuffer.append(""+register);
				outputBuffer.append("           ");
				outputBuffer.append("  "+API.getLocalMsg("MSG_RECEIPT_ORDER_NO")+ " ");
				outputBuffer.append(""+majorMinor);
				outputBuffer.append("\r\n");
				//outputBuffer.append("-");
				//outputBuffer.append(""+ minor);
				//Header finished

				//Main Item description
				var qty = API.formatNumber(Math.abs(toInt(item.quantity)), "#0", 2);
				var descr = item.description;
				if(displayLong == true)
				{
					descr = item.longName;
				}
				 // reverse the color for the items specified in GrillDisplayReverseProductCodes and limit string width to 17
                descr = getGrillFormattedItemName( grillProductCodes, item, descr, 17);


				 API.dbg("Grilled item QTY and name: "+qty+ " " +descr);
				 outputBuffer.append("<@DoubleCharOff>");
				 outputBuffer.append("<@DoubleCharOn>");
				 outputBuffer.append(""+qty);
				 outputBuffer.append(" "+ descr);
				 outputBuffer.append("\n");
				 outputBuffer.append("<@DoubleCharOff>"); 
				//end Main Item description
			}	
		}
		else 
		{//grill modification
			if(!zebra)
			{
				outputBuffer.append("<@BoldOn>");
			}	
			outputBuffer.append("                       "+getGrillDescription(item, false) + "\n");
			if(zebra)
			{
				outputBuffer.append("<@ZebraDoubleCharOff>");
			}
			else
			{
				outputBuffer.append("<@BoldOff>");
			}	
		}		
	}
	//footer
	if(zebra)
	{
		outputBuffer.append("                      \n");
		outputBuffer.append("<@ZebraDoubleCharOff>");
		outputBuffer.append("<@ZebraEndSequence>");
		outputBuffer.append("<@ZebraEndSequence2>");
		outputBuffer.append("<@ZebraEndSequence2>");
		outputBuffer.append("<@ZebraEndSequence2>");
		outputBuffer.append("\n\r\n_______________________________________\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n");
		outputBuffer.append("<@ZPF>");
	}
	else
	{
		outputBuffer.append("                          ");
		outputBuffer.append("<@DoubleCharOff>");
		outputBuffer.append("<@StarEndSequence>");
		outputBuffer.append("<@StarEndSequence2>");
		/*outputBuffer.append("<@StarEndSequence2>");
		outputBuffer.append("<@StarEndSequence2>");
		outputBuffer.append("<@StarEndSequence2>");*/
	}
		
 	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the grill slip (printed at production)
 * Needed data types: VIEW
 * @author Rodrigo
 */
function grillSlip(config, data) 
{
	if(init(config, data, Array("VIEW"), "GLSLP") != 0) {
		return getResponse();
	}	
	if(String(rootView.View.@orderId)=="") {
		var view=rootView.View;
		view.@orderId=PosMountOrderIdJS("1",String(view.@orderKey),String(view.@major),String(view.@minor));
	}
	return(IntGrillSlip());
}

function grillSlip1(config, data) 
{
	if(init(config, data, Array("VIEW"), "GLSLP") != 0) {
		return getResponse();
	}	
	if(String(rootView.View.@orderId)=="") {
		var view=rootView.View;
		view.@orderId=PosMountOrderIdJS("1",String(view.@orderKey),String(view.@major),String(view.@minor));
	}
	return(IntGrillSlip());
}

function grillSlip2(config, data) 
{
	if(init(config, data, Array("VIEW"), "GLSLP") != 0) {
		return getResponse();
	}	
	if(String(rootView.View.@orderId)=="") {
		var view=rootView.View;
		view.@orderId=PosMountOrderIdJS("2",String(view.@orderKey),String(view.@major),String(view.@minor));
	}
	return(IntGrillSlip());
}

/**
 * PUBLIC
 * Responsible for formating the grill slip (printed at production) for Zebra printers
 * Needed data types: VIEW
 * @author Markus Ziegler
 */
function grillSlipZebra(config, data) 
{
	if(init(config, data, Array("VIEW"), "GLSLP") != 0) 
	{
		return getResponse();
	}	
	if(String(rootView.View.@orderId)=="") 
	{
		var view=rootView.View;
		view.@orderId=PosMountOrderIdJS("2",String(view.@orderKey),String(view.@major),String(view.@minor));
	}
	var bZebra = true;
	return(IntGrillSlipZebraStar(bZebra));
}

/**
 * PUBLIC
 * Responsible for formating the grill slip (printed at production) for Star printers
 * Needed data types: VIEW
 * @author Markus Ziegler
 */
function grillSlipStar(config, data) 
{
	if(init(config, data, Array("VIEW"), "GLSLP") != 0) 
	{
		return getResponse();
	}	
	if(String(rootView.View.@orderId)=="") 
	{
		var view=rootView.View;
		view.@orderId=PosMountOrderIdJS("2",String(view.@orderKey),String(view.@major),String(view.@minor));
	}
	var bZebra = false;
	
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillStickerEnable\").@value"; 
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"GrillStickerEnable\").@value";
	var oldStar = getConfigValue(storedbPath , posdbPath) == "0";   //if is disabled

	if(oldStar == true)
	{
		return(IntGrillSlipZebraStar(bZebra));	
	}
	else //by defautl we are entering here
	{
		return(IntGrillSlipStarNew());
	}
}


/**
 * PUBLIC
 * Responsible for formating the open day result report.
 * Needed data types: CASH
 * @author Rodrigo
 */
function reportDayOpen(config, data) 
{
	if(init(config, data, Array("CASH"), "RDOPN") != 0) {
		return getResponse();
	}	
	var nodesPOS		= rootCash.POS;
	
	addHeader(rootCash, API.getLocalMsg("DAY_OPEN"), RPTDUMMY);
	addLine();
	addLine("POS                      Opening reading");
	addPOS(nodesPOS);
	addFooter(rootCash);
	return getResponse();
	
	/** Adds all included POS */
	function addPOS(nodesPOS) 
	{
		for each (i in nodesPOS) {
			var posId	= i.@id;
			var gt		= Number(i.@initialGT);
			var line	= API.setOnLeft(String(posId), 4) + "               " +  API.setOnRight(API.formatNumber(gt, NUMBER_FORMAT, 20), 21);
			addLine(line);
		}
	}
}

/**
 * PUBLIC
 * Responsible for formating the Open Close Store Wide result report.
 * Needed data types: config, data (XML with data of the POS)
 * @author Celso
 */
function reportOpenCloseSW(configParam) 
{
	initGlobalt();
	config = new XML(configParam);

	var storeId			= Number(config.StoreId);
	var posId = "N/A";
	if(config.PosId[0] != null) {
		posId =  Number(config.PosId[0].substring(3, 8));
	}
	var storeName		= config.StoreName;
	var managerId		= Number(config.Manager.@id);	
	
	var indStruct = 0;
	var i = 0;
	
	var data 		    = config.CustomData.commandResponse;

	// SW_OPENDAY or SW_CLOSEDAY
	var cmdName  		= String(data.params.param.value.struct.member.(name=="command").value.string);
	// 0 or 1
	var isForced 		= Number(data.params.param.value.struct.member.(name=="isForced").value.i4);
	// YYYYMMDD
	var businessDate 	= String(data.params.param.value.struct.member.(name=="BusinessDate").value.string);
	
	if(businessDate != "N/A") {
		businessDate	= API.formatDate(businessDate, "MM/dd/yyyy");
	}
	
	// 0 or 1
	var canOpenClose 	= Number(data.params.param.value.struct.member.(name=="CanOpenClose").value.i4);
	// 
	var numberOfPos 	= Number(data.params.param.value.struct.member.(name=="NumberOfPos").value.i4);
	// 
	var rootPosList 	= data.params.param.value.struct.member.(name=="POSLIST").value.array.data;
	
	// Create of Header
	addLine(SEP_DL);
    if(posId==0) {
		addLine(center(API.getLocalMsg("MSG_RECEIPT_STORE")+"# " + storeId));
    } 
    else {
		addLine(center(API.getLocalMsg("MSG_RECEIPT_STORE")+"# " + storeId +" "+ API.getLocalMsg("MSG_RECEIPT_POS")+"# " + posId));
    }

	addLine(center(storeName));
	addLine();
	addLine(center(API.getLocalMsg("MSG_RECEIPT_BUSINESS_DATE")+": " + businessDate));
	addLine();
	addLine(center(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID")+": " + managerId));
	addLine();
	addLine("SUP-SIGN     MGR.SIGN    ASST/CREW-SIGN");
	addLine();
	addLine();
	addLine(SEP_DL);
	if(cmdName == "SW_OPENDAY"){
      if(isForced==1) {
			addLine(center(API.getLocalMsg("DAY_OPEN_ALL_POS_FORCED")));
      }
     else {
			addLine(center(API.getLocalMsg("DAY_OPEN_ALL_POS")));
     }
	}
	else {
      if(isForced==1) {
			addLine(center(API.getLocalMsg("DAY_CLOSE_ALL_POS_FORCED")));
      }
     else {
			addLine(center(API.getLocalMsg("DAY_CLOSE_ALL_POS")));
     }
	}

   var allOpenClose=1;
   var oneOpenClose=0;
	if(canOpenClose == 1) {
		var item;
      for each (item in rootPosList.value) {
			var varCanOpenClose = Number(item.struct.member.(name=="CanOpenClose").value.i4);
         if(varCanOpenClose==0) {
            allOpenClose=0;
         }
         else {
            oneOpenClose=1;
         }
		}
   }
   if(oneOpenClose==0) {
     canOpenClose=0;
   }

	if(canOpenClose == 1){
      if(allOpenClose==1) {
			addLine("============== SUCCEEDED ==============");
      }
      else {
   		addLine("========= PARTIALLY SUCCEEDED =========");
		}
		if(cmdName == "SW_OPENDAY"){
			addLine("POS#                    Opening reading");
			addLine("----                    ---------------");					
		}
	}
	else {
		addLine("=============== FAILED ================");
		addLine("POS#               MESSAGE             ");
		addLine("----   --------------------------------");		
	}

// Create of Body
   for each (var item in rootPosList.value) {
		
		var varPosId  		= String(item.struct.member.(name=="PosId").value.string);
		var varOnline 		= Number(item.struct.member.(name=="Online").value.i4);
		var varCanOpenClose = Number(item.struct.member.(name=="CanOpenClose").value.i4);
		var varReason 		= Number(item.struct.member.(name=="Reason").value.i4);
		var varState 		= String(item.struct.member.(name=="State").value.string);
		var varOpeningReading = String(item.struct.member.(name=="OpeningReading").value.string);
		
		if(varCanOpenClose == 1) {
			// POS SUCCEEDED
         if(canOpenClose && (cmdName == "SW_OPENDAY")) {
				var line = varPosId.substring(3, 8) + 
   	                 "                    " +
      	              API.setOnRight(varOpeningReading, 15);
				addLine(line);
			}
		}
		else {
			// POS FAILED
			var line = varPosId.substring(3, 8)
			+ "   "
			+ "Operation cannot be performed";

			addLine(line);
			
			var description = "";
			switch (varReason) {
				// 		5: POSNN, 2: sep, 30: message
				case 1: addLine("     "+"  "+"Communication error.");
					 	break;
				case 2: addLine("     "+"  "+"Invalid Date.");
					 	break;
				case 3: addLine("     "+"  "+"POS is already Opened.");
					 	break;
				case 4: addLine("     "+"  "+"POS is already closed.");
					 	break;
				case 5: addLine("     "+"  "+"Cannot close a POS that is not");
						addLine("     "+"  "+"opened or Blocked.");
					 	break;
				case 6: addLine("     "+"  "+"Cannot open a POS that is not");
						addLine("     "+"  "+"closed.");
					 	break;
				case 7: addLine("     "+"  "+"Error executing workflow.");
					 	break;	
				case 8: addLine("     " + API.getLocalMsg("LMSG_SL_ERR_OPEN_ORDERS"));
					 	break;	
				default:addLine("     "+"  "+"Error undetermined.");
         }
		}
	}
	addLine(SEP_DL);
	addLine(center(API.getLocalMsg("MSG_RECEIPT_PRINTEDON") + " " + API.formatDateTime(config.@creationDate)));
	addLine(SEP_DL);
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Status of the POSOpen Close Store Wide result report.
 * Needed data types: config, data (XML with data of the POS)
 * @author Celso
 */
function reportPOSStatesSW(configParam, data)
{
	initGlobalt();
//	PosShowMessage(teste);

	iAux = String(data[0]).indexOf("?>") + 2;    // remove <?xml version="1.0" encoding="UTF-8" ?> 
	var newData = String(data[0]).slice(iAux);
	config = new XML(configParam.toString());
	posStates = new XML(newData);

	var storeId			= Number(config.StoreId);
	var posId = "N/A";
	if(config.PosId[0] != null) {
		posId =  Number(config.PosId[0].substring(3, 8));
	}
	var storeName		= config.StoreName;
	var managerId		= Number(config.Manager.@id);	

	// Create of Header
	addLine(SEP_DL);
    if(posId==0) {
		addLine(center(API.getLocalMsg("MSG_RECEIPT_STORE")+"# " + storeId));
    } 
    else {
		addLine(center(API.getLocalMsg("MSG_RECEIPT_STORE")+"# " + storeId + " "+ API.getLocalMsg("MSG_RECEIPT_POS")+ "# " + posId));
    }

	addLine(center(storeName));
	addLine();
	addLine(center(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID")+": " + managerId));
	addLine();
	addLine("SUP-SIGN     MGR.SIGN    ASST/CREW-SIGN");
	addLine();
	addLine();
	addLine(SEP_DL);
	addLine(center("Register Status"));	
	addLine(SEP_DL);
	addLine("Station    Status    Version   Package");
	var nodesPos = posStates.PosList.Pos;	
	if(nodesPos != null) {
		for each (i in nodesPos) {
			var station = i.@id;
			var status	= (i.@state!="Detached")?"Active":"Detached";
			var version	= (i.@state=="Unknown")?"------":i.@version;
			var pkg	= (i.@state=="Unknown")?"------":i.@pkg;
			{   // Format new line
				var line = API.setOnRight(station, 7)
				+ "    " 
				+ API.setOnRight(status, 6)
				+ "    "
				+ API.setOnRight(version, 7)
				+ "   "
				+ API.setOnRight(pkg, 7)
				addLine(line);
			}
		}
	}

	addLine(SEP_DL);
	addLine(center(API.getLocalMsg("MSG_RECEIPT_PRINTEDON")+" "+ API.formatDateTime(config.@creationDate)));
	addLine(SEP_DL);
	return getResponse();

}

/**
 * PUBLIC
 * Responsible for formating the operator login report.
 * Needed data types: CASH
 * @author Rodrigo
 */
function reportOperatorLogin(config, data) 
{
	if(init(config, data, Array("CASH"), "OPRLG") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var nodeTenders		= currentOperator.CashDetails.Tenders[0];
	var initialFloat	= calculateInitialFloat(nodeTenders);
	
	var nodesRcp		= currentOperator.CashDetails.TransfersIn.(@type=="ADDITIONAL_FLOAT");
	var lastValue		= "";
	if(nodesRcp !=null)
	{
		lastValue		= getLastValueTimestamp(nodesRcp);
	}
	
	var managerId		= Number(rootConfig.Manager.@id);

	initialFloat = API.formatNumber(initialFloat, NUMBER_FORMAT, 19);	

	//addHeader(rootCash, "Cashier Login", RPTOPERATORLOGIN);
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_CASHIER_LOGIN"), RPTOPERATORLOGIN);
	//addOperation("Manager",			managerId,		false);
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	{
	// 18: name, 2: sep, 19: value
	//var line = API.setOnLeft("Cashier", 18)
	var line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_CASHIER"), 18)
	+ ":" + " "
	+ API.setOnRight(operatorName, 19);
	addLine(line);
	}
	
	//addOperation("Operator Id",		operatorId,		false);
	addOperation(API.getLocalMsg("MSG_RECEIPT_OPERATOR_ID"),		operatorId,		false);
	//addOperation("Initial Float",	initialFloat,	false);
	addOperation(API.getLocalMsg("MSG_RECEIPT_INITIAL_FLOAT"),	initialFloat,	false);
	if(lastValue !="")
	{
		var additionalFloat = API.formatNumber(lastValue, NUMBER_FORMAT, 19);	
		addOperation(API.getLocalMsg("MSG_RECEIPT_ADDITIONAL_FLOAT"),	additionalFloat,	false);
	}
	addLine();
	addFooter(rootCash);
	
	return getResponse();
	
	/** Calculate total inital float on the given node */
	function calculateInitialFloat(nodeTenders) 
	{
		var total = 0;
		if(nodeTenders != null) {
			var nodesTender = nodeTenders.Tender;
			for each (i in nodesTender) {
				total += i.@initialFloat;
			}
		}
		return Number(total);
	}
}
//*********************end report.nps***************************

//*********************report_isp.nps***************************
/**
 * PUBLIC
 * Responsible for formating the End of Day report.
 * Needed data types: CASH, PMIX
 * @author Rodrigo
 */
function reportEndOfDay(config, data) 
{
	if(init(config, data, Array("CASH", "PMIX"), "ENDDY") != 0) {
		return getResponse();
	}	
	
	var reportType = RPTENDOFDAY;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
}
	
/**
 * PUBLIC
 * Responsible for formating the Cahier Logout report.
 * Needed data types: CASH, PMIX
 * @author Rodrigo
 */
function reportOperatorLogout(config, data) 
{
	if(init(config, data, Array("CASH", "PMIX"), "OPLGT") != 0) {
		return getResponse();
	}	
	
	var reportType = RPTOPERATRORLOGOUT;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Remote Drawer Change report.
 * Needed data types: CASH, PMIX
 * @author Rodrigo
 */
function reportRemoteDrawerChange(config, data) 
{
	if(init(config, data, Array("CASH", "PMIX"), "OPLGT") != 0) {
		return getResponse();
	}	

	var reportType = RPTOPERATRORLOGOUT;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	reportType = RPTREMDRWCHANGE;
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	addLine("  Accomplished on "+rootConfig.CustomData.regSrc+" for "+rootConfig.CustomData.regDst);
	addLine(SEP_DL);
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Remote Login report.
 * Needed data types: CASH, PMIX
 * @author Rodrigo
 */
function reportRemoteLogin(config, data) 
{
	if(init(config, data, Array("CASH"), "OPRLG") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var managerId		= Number(rootConfig.Manager.@id);

	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_LOGINHEADER"), RPTOPERATORLOGIN);
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	{
	// 18: name, 2: sep, 19: value
	var line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_CASHIER"), 18)
	+ ":" + " "
	+ API.setOnRight(operatorName, 19);
	addLine(line);
	}
	addOperation(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID"),		operatorId,		false);
	addLine();
	addFooter(rootCash);
	
	addLine("  Accomplished on "+rootConfig.CustomData.regSrc+" for "+rootConfig.CustomData.regDst);
	addLine(SEP_DL);
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Other Receipts result report.
 * Needed data types: CASH
 * @author Celso Fernandes
 */
function reportTransfer (config, data) 
{
	if(init(config, data, Array("CASH"), "RTRNF") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var managerId		= Number(rootConfig.Manager.@id);
	var nodeOtherRcp	= currentOperator.CashDetails.TransfersIn.(@type=="OTHER_RECEIPTS");
	var otherValue		= getLastValueTimestamp(nodeOtherRcp);

	otherValue = API.formatNumber(otherValue, NUMBER_FORMAT, 19);	
	
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_OTHER_RECEIPTS"), RPTDUMMY);
	addLine();
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	addLine();
	addOperation(API.getLocalMsg("MSG_RECEIPT_OTHER_RECEIPTS"),	otherValue,	false);
	addLine();
	addLine();
	addFooter(rootCash);
	
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Skim report.
 * Needed data types: CASH
 * @author Celso Fernandes
 */
function reportSkimSlip (config, data) 
{
	if(init(config, data, Array("CASH"), "SKMSL") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var nodeSkim		= currentOperator.CashDetails.TransfersOut.(@type=="SKIM");
	var skimValue		= getLastValueTimestamp(nodeSkim);
	var managerId		= Number(rootConfig.Manager.@id);

	skimValue = API.formatNumber(skimValue, NUMBER_FORMAT, 19);	
	
	addHeader(rootCash, "Skim", RPTDUMMY);
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	
	{
	// 18: name, 2: sep, 19: value
	var line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_CASHIER"), 18)
	+ ":" + " "
	+ API.setOnRight(operatorName, 19);
	addLine(line);
	}
	
	addOperation(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID"),		operatorId,		false);
	
	{
	// 17: name, 3: sep, 20: value
	var line = API.setOnLeft("Skim Type", 17);
	addLine(line);
	}
	
	addOperation("Cash",	skimValue,	false);
	addLine();
	addFooter(rootCash);
	
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Other Payments report.
 * Needed data types: CASH
 * @author Celso Fernandes
 */
function reportOtherPayments (config, data) 
{
	if(init(config, data, Array("CASH"), "OTPMN") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var managerId		= Number(rootConfig.Manager.@id);
	var nodesRcp		= currentOperator.CashDetails.TransfersOut.(@type=="OTHER_PAYMENT");
	var lastValue		= getLastValueTimestamp(nodesRcp);

	lastValue = API.formatNumber(lastValue, NUMBER_FORMAT, 19);	
	
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_OTHER_PAYMENT"), RPTDUMMY);
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	addLine();
	addOperation(API.getLocalMsg("MSG_RECEIPT_OTHER_PAYMENT"),	lastValue,	false);
	addLine();
	addLine();
	addFooter(rootCash);
	
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Other Payments report.
 * Needed data types: CASH
 * @author Celso Fernandes
 */
function reportSpecialReceipts (config, data) 
{
	if(init(config, data, Array("CASH"), "SPRPT") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var managerId		= Number(rootConfig.Manager.@id);
	var nodesRcp		= currentOperator.CashDetails.TransfersIn.(@type=="SPECIAL_RECEIPTS");
	var lastValue		= getLastValueTimestamp(nodesRcp);

	lastValue = API.formatNumber(lastValue, NUMBER_FORMAT, 19);	
	
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_SPECIAL_RECEIPTS"), RPTDUMMY);
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	addLine();
	addOperation(API.getLocalMsg("MSG_RECEIPT_SPECIAL_RECEIPTS"),	lastValue,	false);
	addLine();
	addLine();
	addFooter(rootCash);
	
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Cash Transfer In report.
 * Needed data types: CASH
 * @author Celso Fernandes
 */
function reportCashTransferIn (config, data) 
{
	if(init(config, data, Array("CASH"), "TRNSI") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var managerId		= Number(rootConfig.Manager.@id);
	var nodesRcp		= currentOperator.CashDetails.TransfersIn.(@type=="TRANSFER");
	var lastValue		= getLastValueTimestamp(nodesRcp);

	lastValue = API.formatNumber(lastValue, NUMBER_FORMAT, 19);	
	
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_CASH_TRANSFER_IN"), RPTDUMMY);
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	addLine();
	addOperation(API.getLocalMsg("MSG_RECEIPT_CASH_TRANSFER_IN"),	lastValue,	false);
	addLine();
	addLine();
	addFooter(rootCash);
	
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Cash Transfer Out report.
 * Needed data types: CASH
 * @author Celso Fernandes
 */
function reportCashTransferOut (config, data) 
{
	if(init(config, data, Array("CASH"), "TRNSO") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var managerId		= Number(rootConfig.Manager.@id);
	var nodesRcp		= currentOperator.CashDetails.TransfersOut.(@type=="TRANSFER");
	var lastValue		= getLastValueTimestamp(nodesRcp);

	lastValue = API.formatNumber(lastValue, NUMBER_FORMAT, 19);	
	
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_CASH_TRANSFER_OUT"), RPTDUMMY);
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	addLine();
	addOperation(API.getLocalMsg("MSG_RECEIPT_CASH_TRANSFER_OUT"),	lastValue,	false);
	addLine();
	addLine();
	addFooter(rootCash);
	
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the Additional Float report.
 * Needed data types: CASH
 * @author Celso Fernandes
 */
function reportAdditionalFloat (config, data) 
{
	if(init(config, data, Array("CASH"), "ADFLT") != 0) {
		return getResponse();
	}	
	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= currentOperator.@name;
	var operatorId		= Number(currentOperator.@id);
	var managerId		= Number(rootConfig.Manager.@id);
	var nodesRcp		= currentOperator.CashDetails.TransfersIn.(@type=="ADDITIONAL_FLOAT");
	var lastValue		= getLastValueTimestamp(nodesRcp);

	lastValue = API.formatNumber(lastValue, NUMBER_FORMAT, 19);	
	
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_ADDITIONAL_FLOAT"), RPTDUMMY);
	addOperation(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),			managerId,		false);
	addLine();
	addOperation(API.getLocalMsg("MSG_RECEIPT_ADDITIONAL_FLOAT"),	lastValue,	false);
	addLine();
	addLine();
	addFooter(rootCash);
	
	return getResponse();
}

/** Adds an operation line */
function addOperation(name, value, left) 
{
	var line = API.setOnLeft(name, 18) + ": ";
	if(left) {
		line += API.setOnLeft(value, 19);
	}else {
		line += API.setOnRight(value, 19);
	}
	addLine(line);
}

/** Calculate total inital float on the given node */
function getLastValueTimestamp(nodes) 
{
	var value = 0;
	var timestamp = "20000101 00:00:00";
	var nodesTransfer = nodes.Transfer;
	if(nodesTransfer != null) {
		for each (i in nodesTransfer) {
			if(String(i.@timestamp) > String(timestamp)){
				timestamp = String(i.@timestamp);
				value = Number(i.@amount);
			}
		}
	}
	return Number(value);
}
//###########################################################
//Cash Reports
//###########################################################
/**
 * PUBLIC
 * Responsible for formating the Cashier Flash result report.
 * Needed data types: CASH
 * @author Celso Fernandes
 */
function reportCashierFlash	(config, data) 
{
	//CASHIER FLASH REPORT
	if(init(config, data, Array("CASH", "PMIX"), "CFLSH") != 0) {
		return getResponse();
	}	
	
	var reportType = RPTCASHIERFLASH;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Drawer Change report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportDrawerChange	(config, data) 
{
	//DRAWER CHANGE REPORT
	if(init(config, data, Array("CASH", "PMIX"), "DRCHG") != 0) {
		return getResponse();
	}	
	var reportType = RPTCASHDRAWERCHANGE;
	var root = rootCash.POS;  
	if(String(root.OperatorSession.@logout) != ""){				    
		for each (i in root) {
			flagTypePos     = String(i.@podShort);	
			flagTypePodDT	= (String(i.@podShort)=="DT");
			flagTypePodWT	= (String(i.@podShort)=="WT");
			flagTypePodFC	= (String(i.@podShort)=="FC");
			var countDrawer = 0;
			for each (j in i.OperatorSession) {
				if(String(j.@logout) != "") { 
					countDrawer = countDrawer + 1;	
					var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, j, reportType, countDrawer);
					if(XMLCashRpt==null) {
						return getResponse();
					}
					addLine(SEP_RR);
					if(Country =="FR")
					{
						genericCashReportFR(XMLCashRpt, reportType);
					}
					else
					{
						genericCashReport(XMLCashRpt, reportType);
					}
					addLine(SEP_ER);		
					addLine();
				}
			}
		}
	}
	else{
		addLine("ERROR:There is not an Operator Session Closed");
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Cashier Close By Date report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportCashierCloseByDate(config, data) 
{
 	if(init(config, data, Array("CASH", "PMIX"), "CNCSH") != 0){
		return getResponse();
	}	

	var root = rootCash.POS;
	var reportType = RPTCASHIERCLOSEBYDATE;
	for each (j in root) {
		if(j.@status != "CLOSED"){
			addLine("ERROR:Day not close.");				    
			return getResponse();
		}
		var rootnew = j.OperatorSession;    			
		if(rootnew.length() == 0){
			addLine("ERROR:There is no data for business date entered.");				    
			return getResponse();
		}
		var countDrawer = 0;
		for each (i in rootnew) {
			countDrawer = countDrawer +1;
			var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, i, reportType, countDrawer);
			if(XMLCashRpt==null) {
				return getResponse();
			}
			addLine(SEP_RR);
			if(Country =="FR")
			{
				genericCashReportFR(XMLCashRpt, reportType);
			}
			else
			{
				genericCashReport(XMLCashRpt, reportType);
			}
			addLine(SEP_ER);		
			addLine();
		}
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Cashier By Period report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportCashByPeriod	(config, data) 
{
	//CASH REPORT BY PERIOD
	if(init(config, data, Array("CASH", "PMIX"), "CSPRD") != 0) {
		return getResponse();
	}	

	var reportType = RPTCASHBYPERIOD;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Cashier By Period StoreWide report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportCashByPeriodStoreWide(config, data) 
{
	//CASH REPORT BY PERIOD
 	if(init(config, data, Array("CASH", "PMIX"), "CSPSW") != 0){
		return getResponse();
	}	
	
	var reportType = RPTCASHBYPERIODSW;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Cashier Close By Date report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportDailyCloseByDate(config, data) 
{
	//DAILY CLOSE RPT BY DATE
	if(init(config, data, Array("CASH", "PMIX"), "DLCDT") != 0) {
		return getResponse();
	}	
	
	var reportType = RPTCASHDAILYCLOSEBYDATE;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the EndDay StoreWide report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportEndDayStoreWide(config, data) 
{
	//END DAY REPORT STORE WIDE
 	if(init(config, data, Array("CASH", "PMIX"), "EDDSW") != 0){
		return getResponse();
	}	

	var reportType = RPTCASHENDDAYSTOREWIDE;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Accumulated report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportAccumulatedCash(config, data) 
{
	//ACCUMULATED CASH REPORT
	if(init(config, data, Array("CASH", "PMIX"), "ACCSH") != 0) {
		return getResponse();
	}	
	
	var reportType = RPTCASHACCUMULATED;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Consolidated report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportConsolidatedCash(config, data) 
{
	//CONSOLIDATED CASH REPORT
 	if(init(config, data, Array("CASH", "PMIX"), "CNCSH") != 0){
		return getResponse();
	}	

	var reportType = RPTCASHCONSOLIDATED;
	var XMLCashRpt = XMLCashReport(rootConfig, rootCash, rootPmix, null, reportType);
	if(XMLCashRpt==null) {
		return getResponse();
	}
	if(Country =="FR")
	{
		genericCashReportFR(XMLCashRpt, reportType);
	}
	else
	{
		genericCashReport(XMLCashRpt, reportType);
	}
	return getResponse();
};

//*****************************end report_isp.nps*********************************************

//****************************report.nps*****************************************************
/**
 * PRIVATE
 * This function implements a generic CASH report for France
 * Needed data types: CASH, PMIX
 * @author Celso Fernandes
 */
function genericCashReportFR(XMLCashRpt, reportType) 
{
	API.dbg("genericCashReport XMLCashRpt: " + XMLCashRpt);
	API.dbg("genericCashReport rootCash: " + rootCash);
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"displayPromoItemCount\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"displayPromoItemCount\").@value";
	var promoLineItemCount = getConfigValue(storedbPath , posdbPath);
	

	var putDataCashier = false;
	var title;
	//var boHelper		= new BusinessObjectHelper;
    //var boHelper = BusinessObjectHelper;
	//arrProdCode= new Array();
	//get the product information
	//boHelper.iterateProductDB(arrProdCode, "1011");
    //API.dbg(boHelper.iterateProductDB(arrProdCode, "1011");
	
	switch(reportType) 
	{
		case RPTCASHIERFLASH:
	    		title 	       = API.getLocalMsg("MSG_RECEIPT_CASHIER_FLASH_REPORT");
    			putDataCashier = true;
       		 break;
		case RPTCASHDRAWERCHANGE:
    		case RPTOPERATRORLOGOUT:       	 
		case RPTCASHIERCLOSEBYDATE:
	    		title = API.getLocalMsg("MSG_RECEIPT_CASHIER_REPORT");
    			putDataCashier = true;
       		break;
		case RPTREMDRWCHANGE:
	    		title = API.getLocalMsg("MSG_RECEIPT_REMOTE") + " " + rootConfig.CustomData.online + " " + API.getLocalMsg("MSG_RECEIPT_DRAWER_CHANGE");
    			putDataCashier = true;
       	 	break;
		case RPTREMLOGIN:
	    		title = API.getLocalMsg("MSG_RECEIPT_REMOTE") + " " + rootConfig.CustomData.online+API.getLocalMsg("MSG_RECEIPT_CASHIER_LOGIN");
    			putDataCashier = true;
       	 	break;
		case RPTCASHBYPERIOD:
		case RPTCASHACCUMULATED:	
   		case RPTCASHBYPERIODSW:       	
		case RPTCASHCONSOLIDATED:
	    		title =  API.getLocalMsg("MSG_RECEIPT_CASHIER_REPORT");
	    		putDataCashier = false;
   			break;	    	
    		case RPTENDOFDAY:
    		case RPTCASHDAILYCLOSEBYDATE:
    		case RPTCASHENDDAYSTOREWIDE:
	    		title = API.getLocalMsg("MSG_RECEIPT_END_OF_DAY");
	    		putDataCashier = false;
   			break;		    	
    		default:
   	    		title = "ERROR";
		    	putDataCashier = true;
       	 	break;
	}
	
	addHeader(rootCash, title, reportType);
	
	//addOperationLine(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),				":", "",							XMLCashRpt.Manager.@value+"");
	if(putDataCashier) {
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_CASHIER_REPORT"), null, null, 							XMLCashRpt.CashierReport.@value + "");
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_CASHIER_ID"),		null, null,							XMLCashRpt.CashierID.@value+"");
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_CASHIER"),		null, null,							XMLCashRpt.Cashier.@value+"");
		
		
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_INITIAL_FLOAT"),	null, null,							API.formatNumber(XMLCashRpt.InitialFloat.@value, NUMBER_FORMAT, 12));
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_FLOAT_ADDITIONS"), " ", XMLCashRpt.AdditionalFloat.@tc, 							XMLCashRpt.AdditionalFloat.@amount);
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_TOTAL_FLOAT"), null, null, API.formatNumber(Number(XMLCashRpt.InitialFloat.@value) + Number(XMLCashRpt.AdditionalFloat.@amount), NUMBER_FORMAT, 12))
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_OPEN_TIME"),		null, null,							String(XMLCashRpt.Opentime.@value));
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_CLOSE_TIME"),		null, null,							String(XMLCashRpt.Closetime.@value));
		addLine();
	}
	
	addLine();
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_CLOSE_READING"),		" ", "",							XMLCashRpt.Closereading.@value);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_OPENING_READING"),	"-", "",							XMLCashRpt.Openingreading.@value);
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_DIFFERENCE"),			"=", "",							XMLCashRpt.DIFFERENCE.@value);
	addLine();
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_OVERRING"),			"-", XMLCashRpt.Overring.@tc,		XMLCashRpt.Overring.@amount);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_CASH_REFUNDS"),		"-", XMLCashRpt.CashRefunds.@tc,	XMLCashRpt.CashRefunds.@amount);	
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_CASHLESS_REFUNDS"),	"-", XMLCashRpt.CashlessRefunds.@tc,XMLCashRpt.CashlessRefunds.@amount);
	/*
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_OTHER_RECEIPTS"),		"-", XMLCashRpt.OtherReceipts.@tc,	XMLCashRpt.OtherReceipts.@amount);
	//27.01.2009 OI  add Gift Certf. to the report.
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_GIFT_CERT_SOLD"),		"-", XMLCashRpt.GiftCertASold.@tc,	XMLCashRpt.GiftCertASold.@amount);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_GIFT_CARD_SOLD"),		"-", XMLCashRpt.GiftCertBSold.@tc,	XMLCashRpt.GiftCertBSold.@amount);
	*/
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_GROSS_SALES"),			"", "",							XMLCashRpt.GROSSSALES.@value);
	addLine();
		
	//add the VAT tax  
	//addVATinfo;
	{
	   //add header
	   var line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_TAUX_TVA"),19)  + API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_TVA"),8) + API.setOnRight(API.getLocalMsg("MSG_RECEIPT_BRUT"),12);
	   addBoldLine(line);
	   
	   
	  
	  var arrayTax = new Array(); //taxrate, taxamount, total
	  var currentIndex =0;
	  for each (tax in XMLCashRpt.Cash.Tax)
	  {
		 var found =false;
		 var i=0;
		 for each (value in arrayTax)
		 {
		    var information = value.split(",")
			if(Number(information[0]) ==Number(tax.@id) ) //already in we must just add the amount
			{
			   var totaltax =Number(information[2])+ Number(tax.@taxAmount);
			   var total= Number(tax.@baseTaxAmount) + Number(tax.@taxAmount);
			   var totalAmtBrut =Number(information[3])+ total;
			   information = information[0] +","+information[1] +","+ totaltax +","+ totalAmtBrut; 
			   arrayTax[i]=  information;
			   found=true;
			   break; 
			}
			i++;
		 }
		 if(found == false)  //information is not on there
		 {
		    var total = Number(tax.@baseTaxAmount) +Number(tax.@taxAmount);
			arrayTax[currentIndex] = tax.@id+","+xmlStoreDB.StoreDB.TaxTable.TaxType.(TaxId==tax.@id).TaxRate+","+tax.@taxAmount+","+ total;
			currentIndex++;
		 }
	  }
		  
	  
	   
	   //add info
	    var totalAmtBrut =0;
	   var totalTaxAmt = 0;
	   for each (tax in arrayTax)
	   {
	     var taxInfo= tax.split(",");
		 taxValue = taxInfo[1];
		 var taxAmount = taxInfo[2];
		 var amtTotal = taxInfo[3];
		 totalAmtBrut += Number(amtTotal);
		 totalTaxAmt += Number(taxAmount);
		 line = API.setOnLeft(API.formatNumber(taxValue, "#0.00",5)+"%",15)  + API.setOnLeft(API.formatNumber(Number(taxAmount), "####0.00",8),12) + API.setOnRight(API.formatNumber(amtTotal, "####0.00",8) ,12);
	     addLine(line);
	   }
	   //add total line
	   line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_TOTAL"),15)  + API.setOnLeft( API.formatNumber(totalTaxAmt, "####0.00",8),12) + API.setOnRight(API.formatNumber(totalAmtBrut, "####0.00",8),12);
	   addBoldLine(line);
	}
	
	addLine();
	var grossSales = Number(XMLCashRpt.TOTALNETSALES.@value) +Number( XMLCashRpt.TOTALTAX.@value);
	var grossNoProducts = Number(XMLCashRpt.NonProductSales.@value) + Number(XMLCashRpt.NonProductTax.@value);
	var grossProducts = Number(XMLCashRpt.ProductSales.@value) + Number(XMLCashRpt.ProductTax.@value);
	
	
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_TOTAL_NET_SALES"),		"=", "",							Number(XMLCashRpt.TOTALNETSALES.@value)); 
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_NO_PRODUCT_SALES"),		"-", "",					Number(XMLCashRpt.NonProductSales.@value));		
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_PRODUCT_SALES"),		"=", "",						Number(XMLCashRpt.ProductSales.@value));	
	
	addLine();
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_TOTAL_TC_AC"),		" ", XMLCashRpt.TotalTCAC.@tc,		XMLCashRpt.TotalTCAC.@amount);
	
	addLine();
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_COMPUTED_CASH"),		"=", "",							XMLCashRpt.COMPUTEDCASH.@value);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_INITIAL_FLOAT"),			"+", "",							API.formatNumber(XMLCashRpt.InitialFloat.@value, NUMBER_FORMAT, 12));
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_CASH_SKIMS"),			"-", "",							XMLCashRpt.CashSkims.@value);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_EXPECTED_CASH"),		"=", "",							XMLCashRpt.Expectedcash.@value);
	
	
	//*********************** TENDER ANALYSE SECTION ***********************************************************
	
	addLine();
	addBoldLine(API.getLocalMsg("MSG_RECEIPT_TENDER_ANALYSIS") + " ");

	var summDrawerAmount = 0;
	var summExceeddAmount = 0;
	var tcExcess = 0;
	var length = rootCash.TenderTable.TenderType.length();
	var tender = rootCash.TenderTable.TenderType;
	for (var i = 0 ; i <length; i++)
	{
		var found =false; //flag to see if cateogry was already displayed.
	    for (var j =0; j<i;j++)
		{
			if (tender[i].@category == tender[j].@category)
			{
				found= true;
				break;
			}
		}
		if(found ==false) //we do not have this category 
		{
			addOperationLineByTenderType(tender[i].@category);
		}
	}
	/*
	addOperationLineByTenderType("TENDER_NATIVE");
	addOperationLineByTenderType("TENDER_OTHER_PAYMENT");
	addOperationLineByTenderType("TENDER_FOREIGHN_CURRENCY");
	addOperationLineByTenderType("TENDER_GIFT_COUPON");
	//27.01.2009 OI add e-cash 
	addOperationLineByTenderType("TENDER_ELECTRONIC_PAYMENT");
	*/
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_TOTAL_TENDERED"),		"=", "",							summDrawerAmount);
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_EXCESS"),		"-", tcExcess,			   summExceeddAmount);
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_COMPUTED_TENDERED"),		"=", "",							summDrawerAmount - summExceeddAmount);

    //********************* END TENDER ANLYSE SECTION************************************************************	

	addLine();
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_NET_SALES_D_THRU"),	" ", XMLCashRpt.NetsalesDThru.@tc,	XMLCashRpt.NetsalesDThru.@amount);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_D_THRU_PR"),			" ", "",							XMLCashRpt.PercentDThru.@value);
	//addOperationLine(API.getLocalMsg("MSG_RECEIPT_CARS"),				" ", XMLCashRpt.Cars.@value,		null);
	
	if(flagTypePodWT) {
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_NET_SALES_W_THRU"),	" ", XMLCashRpt.NetsalesWThru.@tc,	XMLCashRpt.NetsalesWThru.@amount);
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_W_THRU_PR"),			" ", "",							XMLCashRpt.PercentWThru.@value);
	}
	
	addLine();
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_NET_SALES_EAT_IN"),	" ", XMLCashRpt.NetsalesEatIn.@tc,	XMLCashRpt.NetsalesEatIn.@amount);
	//addOperationLine(API.getLocalMsg("MSG_RECEIPT_EAT_IN_TAX"),			" ", "",							XMLCashRpt.EatIntax.@value);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_NET_SALES_TEKE_OUT"),	" ", XMLCashRpt.NetsalesTakeOut.@tc,XMLCashRpt.NetsalesTakeOut.@amount);
	//addOperationLine(API.getLocalMsg("MSG_RECEIPT_TAKE_OUT_TAX"),		" ", "",							XMLCashRpt.TakeOuttax.@value);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_TAKE_OUT_PR"),			" ", "",							XMLCashRpt.TakeOutPercent.@value);
	
	addLine();
	//addOperationLine(API.getLocalMsg("MSG_RECEIPT_WASTE"),				" ", XMLCashRpt.Waste.@tc,			XMLCashRpt.Waste.@amount);
	if(promoLineItemCount == "true") 
	{
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_PROMO"),				" ", XMLCashRpt.PROMO.@items,			XMLCashRpt.PROMO.@amount);
	}
	else
	{
		addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_PROMO"),				" ", XMLCashRpt.PROMO.@tc,			XMLCashRpt.PROMO.@amount);
	}
	
	
	//addOperationLine(API.getLocalMsg("MSG_RECEIPT_AMOUNT_DISCOUNT"),		" ", XMLCashRpt.Amountdiscount.@tc, XMLCashRpt.Amountdiscount.@amount);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_EMP_MEAL_DISCOUNT"),	" ", XMLCashRpt.EmpMealdiscount.@tc,XMLCashRpt.EmpMealdiscount.@amount);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_MGR_MEAL_DISCOUNT"),	" ", XMLCashRpt.MgrMealdiscount.@tc,XMLCashRpt.MgrMealdiscount.@amount);
	addLine();
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_RED_BEFORE_TOTAL"),	"=", XMLCashRpt.RedBeforeTotal.@tc,	XMLCashRpt.RedBeforeTotal.@amount);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_AVERAGE_REDUCTION_BEF_TOT"), null, null,					XMLCashRpt.AvgRedBeforeTotal.@value);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_RED_AFTER_TOTAL"),		"=", XMLCashRpt.RedAfterTotal.@tc,	XMLCashRpt.RedAfterTotal.@amount);
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_AVERAGE_REDUCTION_AFT_TOT"), null, null,					XMLCashRpt.AvgRedAfterTotal.@value);
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_DRAWER_OPENS"),		 " ", " ", XMLCashRpt.Draweropens.@value, "");
	addLine();
	
	addFooter(rootCash);
	return;
	
	function addArrayDiffLine(lineDiff_array,id,name, charSeparator, qty, value, numberFormat) 
	{
		if(!numberFormat) {
			numberFormat = NUMBER_FORMAT; // Default value
		}
		if(numberFormat != "" && typeof(value) != "string" && value != null) {
			value = API.formatNumber(Number(value), numberFormat);
		}else if(value == null) {
			value = "";
		}

		if(charSeparator == null && qty == null) { // Gives more space to 'name'
			// 26: name, 1: nothing, 12: value
			var line = API.setOnLeft(name, 26)
				+ ":"
				+ API.setOnRight(value, 12);
		}else {
			// 17: name, 3: sep, 6: qtd, 1: nothing, 12: value
			var line = API.setOnLeft(name, 17)
			+ " " + API.setOnRight(qty, 6) + " :"
			+ API.setOnRight(charSeparator+" "+value,13);
		}
		
		lineDiff_array.push({id:Number(id), text:String(line)});
	}
	
	function addDiffLine(lineDiff_array) 
	{
		lineDiff_array.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));})		
		for(var i = 0; i < lineDiff_array.length; i++) {
			addLine(String(lineDiff_array[i].text));
		}
	}
	
	/**
	 * Adds an operation line like this:
	 * "TOTAL ITEMS       =     114    6,145,756"
	 * @param name operation name ("TOTAL ITEMS")
	 * @param charSeparator separator char ("=")
	 * @param qty quantity ("114")
	 * @param value value ("6,145,756")
	 * @param numberFormat (optional) pass "" if you dont want to format the number, or any number format to use
	 */
	function addOperationLine(bold, name, charSeparator, qty, value, numberFormat) 
	{
	
		if(numberFormat == null) {
			numberFormat = NUMBER_FORMAT; // Default value
		}
		if(numberFormat != "" && typeof(value) != "string" && value != null) {
			value = API.formatNumber(Number(value), numberFormat);
		}else if(value == null) {
			value = "";
		}
		value= ltrim(value);
		if(charSeparator == null && qty == null) { // Gives more space to 'name'
			// 26: name, 1: nothing, 12: value
			var line = API.setOnLeft(name, 26)
				+ ":"
				+ API.setOnRight(value, 12);
		}else {
			// 17: name, 3: sep, 6: qtd, 1: nothing, 12: value
			var line = API.setOnLeft(name, 17)
			+ " " + API.setOnRight(qty, 6) + " :"
			+ API.setOnRight(charSeparator+" "+value,13);
		}
		if(bold ==true)
		{
			addBoldLine(line);
		}
		else
		{
			addLine(line);
		}
	}

	function addOperationLineByTenderType(tenderTypeName)
	{
		var cashTenderSize = rootCash.TenderTable.TenderType.length();
		var substractAdditionalFloat = true;
		for(var i=0; i<cashTenderSize; i++)
		{
			var tenderName = rootCash.TenderTable.TenderType[i].@category;
			var tenderID = rootCash.TenderTable.TenderType[i].@id;
			if(tenderName == tenderTypeName)
			{
				var xmlCashTenderSize = XMLCashRpt.Tender.length();
				var isin =false; //flag to verify if tender was used , if the tender was not used then it doens't appear in the xmlCashTender.
				for(var j=0; j<xmlCashTenderSize; j++)
				{
					var xmlTenderID =  XMLCashRpt.Tender[j].@id;
					if(tenderID == xmlTenderID)
					{
						summExceeddAmount = summExceeddAmount + Number(XMLCashRpt.Tender[j].@excessAmount);
						tcExcess = Number(tcExcess) + Number(XMLCashRpt.Tender[j].@excessCount);
						if(tenderTypeName == "TENDER_NATIVE")
						{
							summDrawerAmount = summDrawerAmount + Number(XMLCashRpt.Tender[j].@drawerAmount -XMLCashRpt.InitialFloat.@value);
							var amount  =  new BigDecimal(XMLCashRpt.Tender[j].@drawerAmount);
							amount = amount.subtract(XMLCashRpt.InitialFloat.@value);
							amount= amount.subtract(XMLCashRpt.AdditionalFloat.@amount)
							addOperationLine(false, rootCash.TenderTable.TenderType[i].@name.substring(0,14),		"+", XMLCashRpt.Tender[j].@tc,		amount.toString());
							if(substractAdditionalFloat ==true) //in case of multiple native tender entries we must subtracte just once
							{
								summDrawerAmount = summDrawerAmount-Number(XMLCashRpt.AdditionalFloat.@amount);
								substractAdditionalFloat =false;
							}
						}
						else if( tenderTypeName == "TENDER_FOREIGN_CURRENCY")
						{
							summDrawerAmount = summDrawerAmount +	Number(XMLCashRpt.Tender[j].@drawerAmount);
							addOperationLine(false,rootCash.TenderTable.TenderType[i].@name,		"+", XMLCashRpt.Tender[j].@tc,		XMLCashRpt.Tender[j].@fDrawerAmount);	
							//calculate the exchange rate 
							//this can be readed from store-db but in case of website reports we do not have access to store-db.xml
							//first try to read it from store-db
							var exchange = new BigDecimal("1.00");
							var storedbPath = "StoreDB.TenderTypes.TenderType.(TenderId==\""+rootCash.TenderTable.TenderType[i].@id+"\").ForeignCurrency.Orientation";
							var orientation = getConfigValue(storedbPath , null);
							var storedbOrientation = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"ForeignRate\").@value";
							var posDbOrientation = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"ForeignRate\").@value";
							var rateOrConversion =  getConfigValue(storedbOrientation , posDbOrientation);
							if(orientation!="") //we have the information is not from waystation website
							{
								storedbPath = "StoreDB.TenderTypes.TenderType.(TenderId==\""+rootCash.TenderTable.TenderType[i].@id+"\").ForeignCurrency.ExchangeRate";
								//get the desired orientation for the conversion					
								if(orientation.toString() == "NATIVE_FOREIGN")  //default
								{
									exchange = new BigDecimal(getConfigValue(storedbPath , null));
								}
								else
								{
									//exchange = new BigDecimal(getConfigValue(storedbPath , null));
									exchange = new BigDecimal("1.00").divide(new BigDecimal(getConfigValue(storedbPath , null)),ROUND_MODE_PERCENT);
								}
							}
							//else just make the calcualtion (it can be wrong because of the rounding)
							else
							{
								exchange = new BigDecimal(XMLCashRpt.Tender[j].@drawerAmount).divide(new BigDecimal(XMLCashRpt.Tender[j].@fDrawerAmount),ROUND_MODE_PERCENT);
							}
							arrParam = new Array();
							if(rateOrConversion.toString() == "rate") //is from waystation screen  or is exchange rate
							{
								arrParam[0]= rootCash.TenderTable.TenderType[i].@name;
								addOperationLine(API.getLocalMsg("MSG_RECEIPT_EXCHANGE",arrParam),		null, null,		exchange);	
							}
							else //conversion
							{
								addOperationLine(API.getLocalMsg("MSG_RECEIPT_CNV"),		null, null,		XMLCashRpt.Tender[j].@drawerAmount);	
							}
						}
						else
						{
							summDrawerAmount = summDrawerAmount + Number(XMLCashRpt.Tender[j].@drawerAmount);
							addOperationLine(false, rootCash.TenderTable.TenderType[i].@name.substring(0,14),		"+", XMLCashRpt.Tender[j].@tc,		XMLCashRpt.Tender[j].@drawerAmount);	
						}
						isin = true;
					}
				}
				if(isin ==false) //the tender was not display 
				{
					addOperationLine(false, String(rootCash.TenderTable.TenderType[i].@name).substring(0,14),		"+", 0,		0.0);
				}
			}
		}
	}
}


/**
 * PRIVATE
 * This function implements a generic CASH report
 * Needed data types: CASH, PMIX
 * @author Celso Fernandes
 */
function genericCashReport(XMLCashRpt, reportType) 
{
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"displayPromoItemCount\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"displayPromoItemCount\").@value";
	var promoLineItemCount = getConfigValue(storedbPath , posdbPath);
	
	//show discount in gross amount?
	storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"ShowGrossDiscount\").@value";
	posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"ShowGrossDiscount\").@value";
	var showGrossDiscount = getConfigValue(storedbPath , posdbPath);

	
	API.dbg("genericCashReport XMLCashRpt: " + XMLCashRpt);
	API.dbg("genericCashReport rootCash: " + rootCash);
	var putDataCashier = false;
	var title;
	//var boHelper		= new BusinessObjectHelper;

	switch(reportType) 
	{
		case RPTCASHIERFLASH:
	    		title 	       = API.getLocalMsg("MSG_RECEIPT_CASHIER_FLASH_REPORT");
    			putDataCashier = true;
       		 break;
		case RPTCASHDRAWERCHANGE:
    		case RPTOPERATRORLOGOUT:       	 
		case RPTCASHIERCLOSEBYDATE:
	    		title = API.getLocalMsg("MSG_RECEIPT_CASHIER_REPORT");
    			putDataCashier = true;
       		break;
		case RPTREMDRWCHANGE:
	    		title = API.getLocalMsg("MSG_RECEIPT_REMOTE") + " " + rootConfig.CustomData.online + " " + API.getLocalMsg("MSG_RECEIPT_DRAWER_CHANGE");
    			putDataCashier = true;
       	 	break;
		case RPTREMLOGIN:
	    		title = API.getLocalMsg("MSG_RECEIPT_REMOTE") + " " + rootConfig.CustomData.online+API.getLocalMsg("MSG_RECEIPT_CASHIER_LOGIN");
    			putDataCashier = true;
       	 	break;
		case RPTCASHBYPERIOD:
		case RPTCASHACCUMULATED:	
   		case RPTCASHBYPERIODSW:       	
		case RPTCASHCONSOLIDATED:
	    		title =  API.getLocalMsg("MSG_RECEIPT_CASHIER_REPORT");
	    		putDataCashier = false;
   			break;	    	
    		case RPTENDOFDAY:
    		case RPTCASHDAILYCLOSEBYDATE:
    		case RPTCASHENDDAYSTOREWIDE:
	    		title = API.getLocalMsg("MSG_RECEIPT_END_OF_DAY");
	    		putDataCashier = false;
   			break;		    	
    		default:
   	    		title = "ERROR";
		    	putDataCashier = true;
       	 	break;
	}
	
	addHeader(rootCash, title, reportType);
	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID"),				":", "",							XMLCashRpt.Manager.@value+"");
	if(putDataCashier) {
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_REPORT"), ":", "", 							XMLCashRpt.CashierReport.@value + "");
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASHIER_ID"),		":", "",							XMLCashRpt.CashierID.@value+"");
		{
		// 18: name, 2: sep, 19: value
		var line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_CASHIER"), 18)
		+ ":" + " "
		+ XMLCashRpt.Cashier.@value;
		addLine(line);
		}
		
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_INITIAL_FLOAT"),	":", "",							API.formatNumber(XMLCashRpt.InitialFloat.@value, NUMBER_FORMAT, 12));
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_FLOAT_ADDITIONS"), ":",XMLCashRpt.AdditionalFloat.@tc, 							XMLCashRpt.AdditionalFloat.@amount);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_TOTAL_FLOAT"), ":", "", API.formatNumber(Number(XMLCashRpt.InitialFloat.@value) + Number(XMLCashRpt.AdditionalFloat.@amount), NUMBER_FORMAT, 12))
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_OPEN_TIME"),		":", "",							String(XMLCashRpt.Opentime.@value));
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_CLOSE_TIME"),		":", "",							String(XMLCashRpt.Closetime.@value));
		addLine();
	}
	addLine();
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CLOSE_READING"),		" ", "",							XMLCashRpt.Closereading.@value);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_OPENING_READING"),	"-", "",							XMLCashRpt.Openingreading.@value);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_DIFFERENCE"),			"=", "",							XMLCashRpt.DIFFERENCE.@value);
	addLine();
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_OVERRING"),			"-", XMLCashRpt.Overring.@tc,		XMLCashRpt.Overring.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASH_REFUNDS"),		"-", XMLCashRpt.CashRefunds.@tc,	XMLCashRpt.CashRefunds.@amount);	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASHLESS_REFUNDS"),	"-", XMLCashRpt.CashlessRefunds.@tc,XMLCashRpt.CashlessRefunds.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_OTHER_RECEIPTS"),		"-", XMLCashRpt.OtherReceipts.@tc,	XMLCashRpt.OtherReceipts.@amount);
	
	if(Country !="UK" && Country !="IE")
	{
		/*
		//27.01.2009 OI  add Gift Certf. to the report.
		for(var nr =0; nr< XMLCashRpt.csh_GCertSoldNo; nr++)
		{
			var cmd = "addOperationLine(API.getLocalMsg(\"MSG_RECEIPT_GIFT_CERT_SOLD\"),		\"-\", XMLCashRpt.GiftCert"+Number(nr+1)+"Sold.@tc,	XMLCashRpt.GiftCert"+Number(nr+1)+"Sold.@amount)";
			eval(cmd);
		}*/
		/*
		if(Country != "AT")
		{
			addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CERT_SOLD"),		"-", XMLCashRpt.GiftCertASold.@tc,	XMLCashRpt.GiftCertASold.@amount);
		}
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CARD_SOLD"),		"-", XMLCashRpt.GiftCertBSold.@tc,	XMLCashRpt.GiftCertBSold.@amount);
		*/
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CERT_SOLD"),		"-", XMLCashRpt.GiftCertSold.@tc,	XMLCashRpt.GiftCertSold.@amount);
	//addOperationLine(boHelper.getSysMessage("MSG_RECEIPT_GIFT_CARD_SOLD"),		"-", XMLCashRpt.GiftCardSold.@tc,	XMLCashRpt.GiftCardSold.@amount);
	
	}
	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_GROSS_SALES"),			":", "",							XMLCashRpt.GROSSSALES.@value);
	addLine();
	if(Country == "DE")
	{
		addOperationLine("",					" ", API.getLocalMsg("MSG_RECEIPT_TAX"),							API.getLocalMsg("MSG_RECEIPT_NET"), "");
	}
	else
	{
		addOperationLine("",					" ", API.getLocalMsg("MSG_RECEIPT_TAX"),							API.getLocalMsg("MSG_RECEIPT_BRUT"), "");
	}
	
	if(Country == "DE")
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NO_TAX_SALES"),		" ", "",							XMLCashRpt.NOTAXSALES.@value);
	}
	if(Country !="AT")
	{
	// 20: name, 8: sep, 12: value
	var line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_NON_TAXABLE_SALES"), 19)
	+ "        " 
	+ API.setOnRight(API.formatNumber(XMLCashRpt.NONTAXABLESALES.@value, NUMBER_FORMAT, 12), 12);
	addLine(line);
	}
	{   // Format new line
		// 16: name, 1: sep, 9: qtd, 1: nothing, 12: value
		var line = API.setOnLeft(API.getLocalMsg("MSG_RECEIPT_TAXABLE_SALES"), 16)
		+ " " 
		+ API.setOnRight(API.formatNumber(XMLCashRpt.TAXABLESALES.@tc, "##,##0.00", 9), 9)
		+ " "
		+ API.setOnRight(API.formatNumber(XMLCashRpt.TAXABLESALES.@amount, NUMBER_FORMAT, 12), 12);
		addLine(line);
	}
	
	// 05.01.2009 OI we need the Tax calculation by Tax Rate. We insert it hardcoded for AT but need later a better solution
	// 09.02.2009 OI modify with differen values for POS, Operators and ALL
	if(Country =="AT")
	{
		var taxValues = rootCash.TaxRateTable.TaxRate;
		var taxNodes = XMLCashRpt.Cash.Tax;
		var tax10Gross = 0;
		var tax20Gross = 0;
		var tax10Tax = 0;
		var tax20Tax = 0;

		for(var i=0; i<Number(taxValues.length());  i++)
		{
			for(var j=0; j<Number(taxNodes.length()); j++)
			{
				if(Number(taxValues[i].@id) == 1 && Number(taxNodes[j].@id) == 1)
				{
					tax10Gross = tax10Gross + Number(taxNodes[j].@baseTaxAmount);
					tax10Tax = tax10Tax + Number(taxNodes[j].@taxAmount);
					tax10Gross = tax10Gross + Number(taxNodes[j].@taxAmount);
				}

				if(Number(taxValues[i].@id) == 2  && Number(taxNodes[j].@id) == 2)
				{
					tax20Gross = tax20Gross + Number(taxNodes[j].@baseTaxAmount);
					tax20Tax = tax20Tax + Number(taxNodes[j].@taxAmount);
					tax20Gross = tax20Gross + Number(taxNodes[j].@taxAmount);
				}
			}
		}
		
		//TaxRate 10
		var line = API.setOnLeft("10% TAX", 16)
		+ " " 
		+ API.setOnRight(API.formatNumber(tax10Tax, "##,##0.00", 9), 9)
		+ " "
		+ API.setOnRight(API.formatNumber(tax10Gross, NUMBER_FORMAT, 12), 12);
		addLine(line);

		//TaxRate 20
		var line = API.setOnLeft("20% TAX", 16)
		+ " " 
		+ API.setOnRight(API.formatNumber(tax20Tax, "##,##0.00", 9), 9)
		+ " "
		+ API.setOnRight(API.formatNumber(tax20Gross, NUMBER_FORMAT, 12), 12);
		addLine(line);
	}
	
	addLine();
	var grossSales = Number(XMLCashRpt.TOTALNETSALES.@value) +Number( XMLCashRpt.TOTALTAX.@value);
	var grossNoProducts = Number(XMLCashRpt.NonProductSales.@value) + Number(XMLCashRpt.NonProductTax.@value);
	var grossProducts = Number(XMLCashRpt.ProductSales.@value) + Number(XMLCashRpt.ProductTax.@value);
	
	if(Country =="DE" || Country =="UK" || Country =="IE" || Country =="PT")
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_TOTAL_NET_SALES"),		"=", "",							Number(XMLCashRpt.TOTALNETSALES.@value));
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NO_PRODUCT_SALES"),		"-", "",							Number(XMLCashRpt.NonProductSales.@value));
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_PRODUCT_SALES"),		"=", "",							Number(XMLCashRpt.ProductSales.@value));
	}
	else
	{ //is gross sales
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_TOTAL_GROSS_SALES"),		"=", "",							grossSales);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NO_PRODUCT_SALES"),		"-", "",							grossNoProducts);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_PRODUCT_SALES"),		"=", "",							grossProducts);
	}
	addLine();
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_DIFFERENCE"),			"=", "",							XMLCashRpt.DIFFERENCE.@value);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_OVERRING"),				"-", XMLCashRpt.Overring.@tc,		XMLCashRpt.Overring.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASH_REFUNDS"),			"-", XMLCashRpt.CashRefunds.@tc,	XMLCashRpt.CashRefunds.@amount);	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASHLESS_REFUNDS"),		"-", XMLCashRpt.CashlessRefunds.@tc,	XMLCashRpt.CashlessRefunds.@amount);	
	//addOperationLine(boHelper.getSysMessage("MSG_RECEIPT_GIFT_CARD_REDEEM"),		"-", XMLCashRpt.GiftCardRedeem.@tc,	XMLCashRpt.GiftCardRedeem.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASHLESS_SALES"),		"-", XMLCashRpt.CashlessSales.@tc,	XMLCashRpt.CashlessSales.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CARD_CASHOUT"),	" ", XMLCashRpt.Giftcardcashout.@tc,XMLCashRpt.Giftcardcashout.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASH_TRANSFER_IN"),		"+", XMLCashRpt.CashTransferIn.@tc,	XMLCashRpt.CashTransferIn.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASH_TRANSFER_OUT"),	"-", XMLCashRpt.CashTransferOut.@tc,XMLCashRpt.CashTransferOut.@amount);
	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_COUPON"),	"-", XMLCashRpt.GiftCouponSales.@tc, XMLCashRpt.GiftCouponSales.@amount);
	if(Number(XMLCashRpt.GiftCouponSales.@excess) !=0)
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_COUPON_EXCESS"),	"+", XMLCashRpt.GiftCouponSales.@tc, XMLCashRpt.GiftCouponSales.@excess);
	}
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CERTIFICATE"),	"-", XMLCashRpt.GiftCertificateSales.@tc, XMLCashRpt.GiftCertificateSales.@amount);
	if(Number(XMLCashRpt.GiftCertificateSales.@excess) !=0)
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CERTIFICATE_EXCESS"),	"+", XMLCashRpt.GiftCertificateSales.@tc, XMLCashRpt.GiftCertificateSales.@excess);
	}
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CARD"),	"-", XMLCashRpt.GiftCardSales.@tc, XMLCashRpt.GiftCardSales.@amount);
	if(Number(XMLCashRpt.GiftCardSales.@excess) !=0)
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CARD_EXCESS"),	"+", XMLCashRpt.GiftCardSales.@tc, XMLCashRpt.GiftCardSales.@excess);
	}
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_OTHER_PAYMENT"),	"-", XMLCashRpt.OtherPaymentSales.@tc,XMLCashRpt.OtherPaymentSales.@amount);
	if(Number(XMLCashRpt.OtherPaymentSales.@excess) != 0)
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_OTHER_PAYMENT_EXCESS"),	"+", XMLCashRpt.OtherPaymentSales.@tc,XMLCashRpt.OtherPaymentSales.@excess);
	}
	
	//addOperationLine(boHelper.getSysMessage("MSG_RECEIPT_BILLABLE_SALES"),			"-", XMLCashRpt.BillableSales.@tc,	XMLCashRpt.BillableSales.@amount);
	//addOperationLine(getCurrency() +boHelper.getSysMessage( "MSG_RECEIPT_1_GIFT_CERTIF"),			"-", XMLCashRpt.GiftCertif.@tc,		XMLCashRpt.GiftCertif.@amount);
	//addOperationLine(getCurrency() + boHelper.getSysMessage("MSG_RECEIPT_5_GIFT_BOOK"),			"-", XMLCashRpt.GiftBook.@tc,		XMLCashRpt.GiftBook.@amount);
	addLine();
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_COMPUTED_CASH"),		"=", "",							XMLCashRpt.COMPUTEDCASH.@value);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_INITIAL_FLOAT"),			"+", "",							API.formatNumber(XMLCashRpt.InitialFloat.@value, NUMBER_FORMAT, 12));
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_ADDITIONAL_FLOAT"),			"+", "",							API.formatNumber(XMLCashRpt.AdditionalFloat.@amount, NUMBER_FORMAT, 12));

	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASH_SKIMS"),			"-", "",							XMLCashRpt.CashSkims.@value);
	// OI 27.01.2010 add for 6.1.17
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CHANGE_ROUNDING"),		"-", XMLCashRpt.ChangeRounding.@tc,	XMLCashRpt.ChangeRounding.@value);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_EXPECTED_CASH"),		"=", "",							XMLCashRpt.Expectedcash.@value);
	addLine();
	addLine(API.getLocalMsg("MSG_RECEIPT_TENDER_ANALYSIS") + ":");

	var summDrawerAmount = 0;
	var summExceeddAmount = 0;
    var	cashTenderSize = rootCash.TenderTable.TenderType.length();
	
	addOperationLineByTenderType("TENDER_NATIVE");
	addOperationLineByTenderType("TENDER_OTHER_PAYMENT");
	addOperationLineByTenderType("TENDER_FOREIGN_CURRENCY");
	addOperationLineByTenderType("TENDER_GIFT_COUPON");
	//27.01.2009 OI add e-cash 
	addOperationLineByTenderType("TENDER_ELECTRONIC_PAYMENT");
	addOperationLineByTenderType("TENDER_CREDIT_SALES");
	
	if(Country !="DE" && Country !="UK" && Country !="IE")
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_TOTAL_TENDERED"),		"=", "",							summDrawerAmount);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_COMPUTED_TENDERED"),		"=", "",							summDrawerAmount - summExceeddAmount);
	}
	/*addOperationLineAPI.getLocalMsg("MSG_RECEIPT_COUPON_A"),			"+", XMLCashRpt.CouponA.@tc,		XMLCashRpt.CouponA.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_COUPON_B"),			"+", XMLCashRpt.CouponB.@tc,		XMLCashRpt.CouponB.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_COUPON_C"),			"+", XMLCashRpt.CouponC.@tc,		XMLCashRpt.CouponC.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_COUPON_D"),			"+", XMLCashRpt.CouponD.@tc,		XMLCashRpt.CouponD.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_COUPON_E"),			"+", XMLCashRpt.CouponE.@tc,		XMLCashRpt.CouponE.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_BILLABLE_SALES"),		"+", XMLCashRpt.BillableSales.@tc,	XMLCashRpt.BillableSales.@amount);
	addOperationLine(getCurrency() + API.getLocalMsg("MSG_RECEIPT_1_GIFT_CERTIF"),		"+", XMLCashRpt.GiftCertif.@tc,		XMLCashRpt.GiftCertif.@amount);
	addOperationLine(getCurrency() + API.getLocalMsg("MSG_RECEIPT_5_GIFT_BOOK"),		"+", XMLCashRpt.GiftBook.@tc,		XMLCashRpt.GiftBook.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CASHLESS_SALES"),		"+", XMLCashRpt.CashlessSales.@tc,	XMLCashRpt.CashlessSales.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_GIFT_CARD_REDEEM"),	"+", XMLCashRpt.GiftCardRedeem.@tc,	XMLCashRpt.GiftCardRedeem.@amount);*/
	
 	// Get tender information
	/*if(XMLCashRpt.nodesTender != null) {
		lineDiff_array = new Array();
		var nodesTender = XMLCashRpt.nodesTender;
		var nodesTenderSize = nodesTender.length();

		for(var i = 0; i < nodesTenderSize; i++) {
			var nodeTender = nodesTender[i];
		    var tcTenderId				= getNumberAttribute(nodeTender, "id");
			var	excessCount				= getNumberAttribute(nodeTender, "excessCount");
			var	excessAmount			= getBigDecimalAttribute(nodeTender, "excessAmount");
			if (excessCount != 0) {
				addArrayDiffLine(lineDiff_array, i, "Dif " + rootCash.TenderTable.TenderType.(@id==tcTenderId).@name,	"-", excessCount,	excessAmount);			
			}
		}
		addDiffLine(lineDiff_array);
	}

	addLine();*/
	
	addLine();
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_TOTAL_TC_AC"),		" ", XMLCashRpt.TotalTCAC.@tc,		XMLCashRpt.TotalTCAC.@amount);

	addLine();
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_NET_SALES_D_THRU"),	" ", XMLCashRpt.NetsalesDThru.@tc,	XMLCashRpt.NetsalesDThru.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_D_THRU_PR"),			" ", "",							XMLCashRpt.PercentDThru.@value);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_CARS"),				" ", XMLCashRpt.Cars.@value,		null);
	
	if(flagTypePodWT) {
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NET_SALES_W_THRU"),	" ", XMLCashRpt.NetsalesWThru.@tc,	XMLCashRpt.NetsalesWThru.@amount);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_W_THRU_PR"),			" ", "",							XMLCashRpt.PercentWThru.@value);
	}
	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_NET_SALES_BFAST"),	" ", XMLCashRpt.NetsalesBfast.@tc,	XMLCashRpt.NetsalesBfast.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_BREAK_FAST_PR"),			" ", "",							XMLCashRpt.BreakfastPercent.@value);
	addLine();
	if(Country =="AT")
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NET_SALES_EAT_IN"),	" ", XMLCashRpt.NetsalesEatIn.@tc,	Number(XMLCashRpt.NetsalesEatIn.@amount) + Number(XMLCashRpt.EatIntax.@value));
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NET_SALES_TEKE_OUT"),	" ", XMLCashRpt.NetsalesTakeOut.@tc,Number(XMLCashRpt.NetsalesTakeOut.@amount)+Number(XMLCashRpt.TakeOuttax.@value) );

	}
	else
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NET_SALES_EAT_IN"),	" ", XMLCashRpt.NetsalesEatIn.@tc,	XMLCashRpt.NetsalesEatIn.@amount);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_EAT_IN_TAX"),			" ", "",							XMLCashRpt.EatIntax.@value);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NET_SALES_TEKE_OUT"),	" ", XMLCashRpt.NetsalesTakeOut.@tc,XMLCashRpt.NetsalesTakeOut.@amount);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_TAKE_OUT_TAX"),		" ", "",							XMLCashRpt.TakeOuttax.@value);
	}
	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_TAKE_OUT_PR"),			" ", "",							XMLCashRpt.TakeOutPercent.@value);
	
	if(Country !="AT")
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_NET_SALES_GARDEN"),	" ", XMLCashRpt.NetsalesGarden.@tc,	XMLCashRpt.NetsalesGarden.@amount);
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_GARDEN_TAX"),			" ", "",							XMLCashRpt.Gardentax.@tc);
	}
	addLine();
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_WASTE"),				" ", XMLCashRpt.Waste.@tc,			XMLCashRpt.Waste.@amount);
	if(promoLineItemCount == "true") //Country == "DE")
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_PROMO"),				" ", XMLCashRpt.PROMO.@items,			XMLCashRpt.PROMO.@amount);
	}
	else
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_PROMO"),				" ", XMLCashRpt.PROMO.@tc,			XMLCashRpt.PROMO.@amount);
	}
	
	if(showGrossDiscount == "true") //gross price
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_AMOUNT_DISCOUNT"),		" ", XMLCashRpt.Amountdiscount.@tc, Number(XMLCashRpt.Amountdiscount.@amount) + Number(XMLCashRpt.Amountdiscount.@tax));
	}
	else
	{
		addOperationLine(API.getLocalMsg("MSG_RECEIPT_AMOUNT_DISCOUNT"),		" ", XMLCashRpt.Amountdiscount.@tc, XMLCashRpt.Amountdiscount.@amount)
	}

	addOperationLine(API.getLocalMsg("MSG_RECEIPT_EMP_MEAL_DISCOUNT"),	" ", XMLCashRpt.EmpMealdiscount.@tc,XMLCashRpt.EmpMealdiscount.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_MGR_MEAL_DISCOUNT"),	" ", XMLCashRpt.MgrMealdiscount.@tc,XMLCashRpt.MgrMealdiscount.@amount);
	addLine();
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_RED_BEFORE_TOTAL"),	"=", XMLCashRpt.RedBeforeTotal.@tc,	XMLCashRpt.RedBeforeTotal.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_AVERAGE_REDUCTION_BEF_TOT"), null, null,					XMLCashRpt.AvgRedBeforeTotal.@value);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_RED_AFTER_TOTAL"),		"=", XMLCashRpt.RedAfterTotal.@tc,	XMLCashRpt.RedAfterTotal.@amount);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_AVERAGE_REDUCTION_AFT_TOT"), null, null,					XMLCashRpt.AvgRedAfterTotal.@value);
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_DRAWER_OPENS"),		" ", XMLCashRpt.Draweropens.@value,	null);
	addLine();
	
	addFooter(rootCash);
	return;
	
	function addArrayDiffLine(lineDiff_array,id,name, charSeparator, qty, value, numberFormat) 
	{
		if(!numberFormat) {
			numberFormat = NUMBER_FORMAT; // Default value
		}
		if(numberFormat != "" && typeof(value) != "string" && value != null) {
			value = API.formatNumber(Number(value), numberFormat, 12);
		}else if(value == null) {
			value = "";
		}

		if(charSeparator == null && qty == null) { // Gives more space to 'name'
			// 26: name, 1: nothing, 12: value
			var line = API.setOnLeft(name, 26)
				+ " "
				+ API.setOnRight(value, 12);
		}else {
			// 17: name, 3: sep, 6: qtd, 1: nothing, 12: value
			var line = API.setOnLeft(name, 17)
			+ " " + charSeparator + " "
			+ API.setOnRight(qty, 6)
			+ " "
			+ API.setOnRight(value, 12);
		}
		
		lineDiff_array.push({id:Number(id), text:String(line)});
	}
	
	function addDiffLine(lineDiff_array) 
	{
		lineDiff_array.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));})		
		for(var i = 0; i < lineDiff_array.length; i++) {
			addLine(String(lineDiff_array[i].text));
		}
	}
	
	/**
	 * Adds an operation line like this:
	 * "TOTAL ITEMS       =     114    6,145,756"
	 * @param name operation name ("TOTAL ITEMS")
	 * @param charSeparator separator char ("=")
	 * @param qty quantity ("114")
	 * @param value value ("6,145,756")
	 * @param numberFormat (optional) pass "" if you dont want to format the number, or any number format to use
	 */
	function addOperationLine(name, charSeparator, qty, value, numberFormat) 
	{
		if(!numberFormat) {
			numberFormat = NUMBER_FORMAT; // Default value
		}
		if(numberFormat != "" && typeof(value) != "string" && value != null) {
			value = API.formatNumber(Number(value), numberFormat, 12);
		}else if(value == null) {
			value = "";
		}
		if(charSeparator == null && qty == null) { // Gives more space to 'name'
			// 26: name, 1: nothing, 12: value
			var line = API.setOnLeft(name.substring(0,17), 26)
				+ " "
				+ API.setOnRight(value, 12);
		}else {
			// 17: name, 3: sep, 6: qtd, 1: nothing, 12: value
			var line = API.setOnLeft(name.substring(0,17), 17)
			+ " " + charSeparator + " "
			+ API.setOnRight(qty, 6)
			+ " "
			+ API.setOnRight(value, 12);
		}
		addLine(line);
	}

	function addOperationLineByTenderType(tenderTypeName)
	{
		var cashTenderSize = rootCash.TenderTable.TenderType.length();
		var substractAdditionalFloat = true;
		for(var i=0; i<cashTenderSize; i++)
		{
			var tenderName = rootCash.TenderTable.TenderType[i].@category;
			var tenderID = rootCash.TenderTable.TenderType[i].@id;
			if(tenderName == tenderTypeName)
			{
				var xmlCashTenderSize = XMLCashRpt.Tender.length();
				for(var j=0; j<xmlCashTenderSize; j++)
				{
					var xmlTenderID =  XMLCashRpt.Tender[j].@id;
					if(tenderID == xmlTenderID)
					{
						summExceeddAmount = summExceeddAmount + Number(XMLCashRpt.Tender[j].@excessAmount);
						if(tenderTypeName == "TENDER_NATIVE")
						{
							summDrawerAmount = summDrawerAmount + Number(XMLCashRpt.Tender[j].@drawerAmount -XMLCashRpt.InitialFloat.@value);
							var amount  =  new BigDecimal(XMLCashRpt.Tender[j].@drawerAmount);
							amount = amount.subtract(XMLCashRpt.InitialFloat.@value);
							amount= amount.subtract(XMLCashRpt.AdditionalFloat.@amount)
							addOperationLine(rootCash.TenderTable.TenderType[i].@name.substring(0,14),		"+", XMLCashRpt.Tender[j].@tc,		amount.toString());	
							if(substractAdditionalFloat ==true) //in case of multiple native tender entries we must subtracte just once
							{
								summDrawerAmount = summDrawerAmount-Number(XMLCashRpt.AdditionalFloat.@amount);
								substractAdditionalFloat =false;
							}
						}
						else if( tenderTypeName == "TENDER_FOREIGN_CURRENCY")
						{
							summDrawerAmount = summDrawerAmount +	Number(XMLCashRpt.Tender[j].@drawerAmount);
							addOperationLine(rootCash.TenderTable.TenderType[i].@name,		"+", XMLCashRpt.Tender[j].@tc,		XMLCashRpt.Tender[j].@fDrawerAmount);	
							//calculate the exchange rate 
							//this can be readed from store-db but in case of website reports we do not have access to store-db.xml
							//first try to read it from store-db
							var exchange = new BigDecimal("1.00");
							var storedbPath = "StoreDB.TenderTypes.TenderType.(TenderId==\""+rootCash.TenderTable.TenderType[i].@id+"\").ForeignCurrency.Orientation";
							var orientation = getConfigValue(storedbPath , null);
							var storedbOrientation = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"ForeignRate\").@value";
							var posDbOrientation = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"ForeignRate\").@value";
							var rateOrConversion =  getConfigValue(storedbOrientation , posDbOrientation);
							if(orientation!="") //we have the information is not from waystation website
							{
								storedbPath = "StoreDB.TenderTypes.TenderType.(TenderId==\""+rootCash.TenderTable.TenderType[i].@id+"\").ForeignCurrency.ExchangeRate";
								//get the desired orientation for the conversion
								
							
								if(orientation.toString() == "NATIVE_FOREIGN")  //default
								{
									exchange = new BigDecimal(getConfigValue(storedbPath , null));
								}
								else
								{
									//exchange = new BigDecimal(getConfigValue(storedbPath , null));
									exchange = new BigDecimal("1.00").divide(new BigDecimal(getConfigValue(storedbPath , null)),ROUND_MODE_PERCENT);
								}
							}
							//else just make the calcualtion (it can be wrong because of the rounding)
							else
							{
								exchange = new BigDecimal(XMLCashRpt.Tender[j].@drawerAmount).divide(new BigDecimal(XMLCashRpt.Tender[j].@fDrawerAmount),ROUND_MODE_PERCENT);
							}
							arrParam = new Array();
							if(rateOrConversion.toString() == "rate") //is from waystation screen  or is exchange rate
							{
								arrParam[0]= rootCash.TenderTable.TenderType[i].@name;
								addOperationLine(API.getLocalMsg("MSG_RECEIPT_EXCHANGE",arrParam),		null, null,		exchange);	
							}
							else //conversion
							{
								addOperationLine(API.getLocalMsg("MSG_RECEIPT_CNV"),		null, null,		XMLCashRpt.Tender[j].@drawerAmount);	
							}
						}
						else
						{
							summDrawerAmount = summDrawerAmount + Number(XMLCashRpt.Tender[j].@drawerAmount);
							addOperationLine(rootCash.TenderTable.TenderType[i].@name,		"+", XMLCashRpt.Tender[j].@tc,		XMLCashRpt.Tender[j].@drawerAmount);	
						}
					}
				}
			}
		}
	}
}


/**
 * PRIVATE
 * Get the POD type
 * Needed data types: complete root cash, operator Id and operator login time
 * @author MY
 */
function GetPODType(rootCash, operatorId, opLoginTime) {
	var podType="FC";
	for each (indPOS in rootCash.POS.(@podShort=="DT")) {
		for each (indOperator in indPOS.OperatorSession) {
			if((Number(indOperator.@id)==Number(operatorId)) && (indOperator.@login==opLoginTime)) {
				podType="DT";
				break;
			}
		}
	}
	return (podType);
}

//*********end report.nps********************************************


//*******************COMBINED************************************

/**
 * PRIVATE
 * This function create a XML CASH report data
 * Needed data types: CASH, PMIX
 * rootTaxTable is optional 
 * @author Celso Fernandes
 */
function XMLCashReport(rootConfig, rootCash, rootPmix, root, reportType, rootTaxTable)
{

	API.dbg("XMLCashReport rootConfig: " + rootConfig);
	API.dbg("XMLCashReport rootCash: " + rootCash);
	API.dbg("XMLCashReport rootPmix: " + rootPmix);
	API.dbg("XMLCashReport root: " + root);
	API.dbg("XMLCashReport reportType: " + reportType);
	API.dbg("XMLCashReport rootTaxTable: " + rootTaxTable);
	
	

	/* infomation added in version 6.1.3
	var qtyCashout					= Array();
          var amountCashout				= Array();
		  */
		  
  
	//MS  21.01.2011 - enable refund information per tender
    var qtyRefund					= Array();
    var refundCashout	          	= Array();
	
	var XMLCashRpt;

	// variables necessary to generate a zeroed xml output.
	// do not change from here ...
	var tcTenderIdArray 			= Array();
	var qtyTenderIdArray 			= Array();
	var drawerAmountTenderIdArray 	= Array();
    	var changeDifferenceAmountTenderIdArray = Array();
    	var excessAmountTenderIdArray = Array();
    	var sumExcessAmount = new BigDecimal("0.00");
	var iReportNumber = rootTaxTable;
	// OI 27.01.2010 add for 6.1.17
	var cashoutTc = Array();
	var cashoutAmount = Array();
	var sumChangeRounding = 0;
	var qtyChangeRounding = 0;
	
    	API.dbg ("XMLCashReport START");
	// Clean array to tender
    	for(var i=0;i<MAX_TENDER_TYPES;i++){
	     	tcTenderIdArray[i]						=0;
	     	qtyTenderIdArray[i]					=0;
			//MS 21.01.2011 - enable refund information per tender
			qtyRefund[i]							=0;
			refundCashout[i]							=new BigDecimal("0.00");
			
	     	drawerAmountTenderIdArray[i]			=new BigDecimal("0.00");
	    	changeDifferenceAmountTenderIdArray[i]	=new BigDecimal("0.00");
	     	excessAmountTenderIdArray[i]			=new BigDecimal("0.00");
	     	// OI 27.01.2010 add for 6.1.17
	     	cashoutTc[i]							=0;
		cashoutAmount[i]						=0;
    	}

	if(null==root) {
		root=rootCash;
	}
	var bConsolidated=false;
    // ... up to here

	if(reportType == -1) {
		return(GenXMLCashRpt());
	}

	// Defines      report_isp.nps CODES
	var GIFT_CERT_1$	= "8492";	// DES-17 - gift certificate product id is hard coded
	var GIFT_CERT_5$	= "937";

	var  CASH_US		= 0;
	var  COUPON_A		= 1;
	var  COUPON_B		= 2;
	var  COUPON_C		= 3;
	var  COUPON_D		= 4;
	var  COUPON_E		= 5;
	var  WME_SALES		= 6;		// Lindomar Araujo: Changed to fix Germany reports old BILL_SALE
	var  SHE_SALES		= 7;		
	var  REC_SALES		= 8;
	var  ESM_SALES		= 10;
	var  WSE_IN			= 13;		// DES-17
	var  CASHLESS_SALES	= 21;		// range from 21 to 40

	var  SPEEDPASS		= 9;
	var  GIFT_CARD		= 11;

	// Waiting better definition
	var  MCCARD_1		= 19; // 19: McCard 200
	var  MCCARD_2		= 20; // 20: McCard 500

	//03.02.2009 OI new constants for e-cash
	var E_CASH_A		= 21;
	var E_CASH_B		= 22;
	var E_CASH_C		= 23;
	var E_CASH_D		= 24;
	var E_CASH_E		= 25;

	var pod = rootCash.@requestPod;
	flagTypePodDT	= (String(rootCash.POS.@podShort).search("DT")== -1)?false:true;
	flagTypePodWT	= (String(rootCash.POS.@podShort).search("WT")== -1)?false:true;
	flagTypePodFC	= (String(rootCash.POS.@podShort).search("FC")== -1)?false:true;
	if (flagTypePos==""){
		//28.01.2009 OI we only need the type from the current POS.
		for each (rootPos in rootCash.POS){
			if(Number(rootPos.@id) == Number(rootConfig.CustomData.PosId)){
				flagTypePos 	= (String(rootPos.@podShort).search("DT")== -1)?"FC":"DT";
				break;
			}
		}

		if (flagTypePos==""){
			flagTypePos 	= (String(rootCash.POS.@podShort).search("DT")== -1)?"FC":"DT";
		}
	} 
	var openingReading		= new BigDecimal("0.00");
	var	closingReading		= new BigDecimal("0.00");
	var unauthDrawerOpenings= 0;
	
	switch(reportType) {
	case RPTENDOFDAY:
			root = rootCash.POS;
			openingReading		= summNodesAttributeBigDecimalValues(root, "initialGT");
			closingReading		= summNodesAttributeBigDecimalValues(root, "finalGT");	
			unauthDrawerOpenings= summNodesAttributeValues(root.OperatorSession, "unauthorizedDrawerOpenings");
			bConsolidated=true;
		break;
	case RPTCASHDAILYCLOSEBYDATE:
			root = rootCash.POS;
			for each (i in root) {
				if(i.@status != "CLOSED"){
					addLine("ERROR:Day not close.");
					return;
				}
			}
			openingReading		= summNodesAttributeBigDecimalValues(root, "initialGT");
			closingReading		= summNodesAttributeBigDecimalValues(root, "finalGT");
			unauthDrawerOpenings= summNodesAttributeValues(root.OperatorSession, "unauthorizedDrawerOpenings");
			bConsolidated=true;
		break;
	case RPTCASHENDDAYSTOREWIDE:
	//     szStatus="CLOSED";   THE POS CANNOT EXECUTE THE REQUESTED ACTION. REASON: THE POS <POSNUMBER> IS CLOSED.
	//     szStatus="OPENED";   THE POS CANNOT EXECUTE THE REQUESTED ACTION. REASON: THE POS <POSNUMBER> IS OPENED.
	//     szStatus="OPLOGGED"; THE POS CANNOT EXECUTE THE REQUESTED ACTION. REASON: THE POS <POSNUMBER> HAS A LOGGED OPERATOR.
	//     szStatus="BLOCKED";  THE POS CANNOT EXECUTE THE REQUESTED ACTION. REASON: THE POS <POSNUMBER> IS BLOCKED.
	//     szStatus="BLOCKOP";  THE POS CANNOT EXECUTE THE REQUESTED ACTION. REASON: THE POS <POSNUMBER> IS BLOCKED AND HAS A LOGGED OPERATOR.

			for each (rootPos in rootCash.POS){
				if(rootPos.@status != "CLOSED") {
					if(rootPos.@status == "OPLOGGED")
						addLine("ERROR:THE POS CANNOT EXECUTE THE REQUESTED ACTION. REASON:\n THE POS " +  rootPos.@id + " HAS A LOGGED OPERATOR");
					else {
						if(rootPos.@status == "BLOCKOP")
							addLine("ERROR:THE POS CANNOT EXECUTE THE REQUESTED ACTION. REASON:\n THE POS " +  rootPos.@id + " IS BLOCKED AND HAS A LOGGED OPERATOR");
						else
							addLine("ERROR:THE POS CANNOT EXECUTE THE REQUESTED ACTION. REASON:\n THE POS " +  rootPos.@id + " IS " + rootPos.@status + ".");
					}
					return;
				}
			}

			root = rootCash.POS;
			var opLogged	="";
			for each (i in root) {
				if(String(i.@businessDate) != "") {
					if(opLogged.search(i.@id) == -1) {
						opLogged 		= opLogged + " " + i.@id;
						openingReading	= openingReading.add(new BigDecimal(i.@initialGT));
						closingReading	= closingReading.add(new BigDecimal(i.@finalGT));
					}
				}
			}
			unauthDrawerOpenings= summNodesAttributeValues(root.OperatorSession, "unauthorizedDrawerOpenings");
			bConsolidated=true;
		break;
	case RPTOPERATRORLOGOUT:
			root = findLastOperator(rootCash);
			iReportNumber = findLastOperatorReportNumber(rootCash);
			openingReading		= summNodesAttributeBigDecimalValues(root, "initialGT");
			closingReading		= summNodesAttributeBigDecimalValues(root, "finalGT");
			unauthDrawerOpenings= summNodesAttributeValues(root, "unauthorizedDrawerOpenings");
			bConsolidated=false;
		 break;
	case RPTCASHDRAWERCHANGE:
	case RPTCASHIERCLOSEBYDATE:
	
			openingReading		= summNodesAttributeBigDecimalValues(root, "initialGT");
			closingReading		= summNodesAttributeBigDecimalValues(root, "finalGT");
			unauthDrawerOpenings= summNodesAttributeValues(root, "unauthorizedDrawerOpenings");
			//iReportNumber = findLastOperatorReportNumber(rootCash);
			bConsolidated=false;
			API.dbg("xmlcashreport type switch");
		 break;
	case RPTCASHIERFLASH:
			root = findCurrentOperator(rootCash);
			iReportNumber = findLastOperatorReportNumber(rootCash);
			if(root == null){
				addLine("ERROR:There is not an Operator Session Opened");
				return;
			}
			openingReading		= summNodesAttributeBigDecimalValues(root, "initialGT");
			closingReading		= summNodesAttributeBigDecimalValues(root, "finalGT");
			unauthDrawerOpenings= summNodesAttributeValues(root, "unauthorizedDrawerOpenings");
			flagTypePos    		= (String(rootCash.POS.(@podShort=="DT").OperatorSession.(@logout==""))=="")?"FC":"DT";
			
			flagTypePodDT	= (String(rootCash.POS.(@podShort=="DT").OperatorSession.(@logout==""))=="")?false:true;
			flagTypePodWT	= (String(rootCash.POS.(@podShort=="WT").OperatorSession.(@logout==""))=="")?false:true;
			flagTypePodFC	= (String(rootCash.POS.(@podShort=="FC").OperatorSession.(@logout==""))=="")?false:true;
			bConsolidated=false;
		 break;
	case RPTCASHBYPERIOD:
	case RPTCASHACCUMULATED:
			root = rootCash.POS;
			openingReading		= summNodesAttributeBigDecimalValues(root[0], "initialGT");
			closingReading		= summNodesAttributeBigDecimalValues(root[0], "finalGT");
			unauthDrawerOpenings= summNodesAttributeValues(root.OperatorSession, "unauthorizedDrawerOpenings");
			bConsolidated		=true;
		break;
	case RPTCASHBYPERIODSW:
	case RPTCASHCONSOLIDATED:
	case RPTINTCASHCONSOLIDATED:
			if(0==root.POS.length()) {
				// single POS report
				var opLogged="";
				if(String(root.@businessDate) != "") {
					if(opLogged.search(root.@id) == -1) {
						opLogged 		= opLogged + " " + root.@id;
						openingReading	= openingReading.add(new BigDecimal(root.@initialGT));	
						closingReading	= closingReading.add(new BigDecimal(root.@finalGT));
					}
					flagTypePos = String(root.@podShort);
					flagTypePodDT	= (String(root.@podShort)=="DT");
					flagTypePodWT	= (String(root.@podShort)=="WT");
					flagTypePodFC	= (String(root.@podShort)=="FC");
				}
				unauthDrawerOpenings= summNodesAttributeValues(root.OperatorSession, "unauthorizedDrawerOpenings");
				bConsolidated=false;
			}
			else {
				root = rootCash.POS;
				var opLogged="";
				for each (i in root) {
					if(String(i.@businessDate) != "") {
						if(opLogged.search(i.@id) == -1) {
							opLogged 		= opLogged + " " + i.@id;
							openingReading	= openingReading.add(new BigDecimal(i.@initialGT));	
							closingReading	= closingReading.add(new BigDecimal(i.@finalGT));
						}
					}
				}
				unauthDrawerOpenings= summNodesAttributeValues(root.OperatorSession, "unauthorizedDrawerOpenings");
				bConsolidated=true;
			}
		break;
	default:
			addLine("ERROR:Undefined Report.");
			return;
		 break;
	}
	
	// Children CashDetails "CD"
	var nodeCashDetails			= root.CashDetails;
	var nodeVoid				= nodeCashDetails.Void;
	var nodeCashOut				= nodeCashDetails.CashOut;
	var nodeReduction			= nodeCashDetails.Reduction;
	var nodePromotions			= nodeCashDetails.Promotions;

	// children CashTotals (CT)
	var nodeCashTotals			= root.CashTotals;
	var nodeCash				= nodeCashTotals.Cash;
	var nodeProductSales		= nodeCashTotals.ProductSales;
	var nodeNonProductSales		= nodeCashTotals.NonProductSales;

	// children CashTotals (CS)
	var nodeCashStatistics		= root.CashStatistics;
	var nodeOperationKindSale	= nodeCashStatistics.SaleType.OperationKind.(@id=="SALE");
	var nodeOperationKindRefund	= nodeCashStatistics.SaleType.OperationKind.(@id=="REFUND");
	var nodeOperationKindDiscount = nodeCashStatistics.SaleType.OperationKind.(@id=="DISCOUNT");
	var nodeOperationKindCashlessRefund	= nodeCashStatistics.SaleType.OperationKind.(@id=="CASHLESS_REFUND");
	var nodeOperationKindPromo	= nodeCashStatistics.SaleType.OperationKind.(@id=="PROMO");

	// children node Sale
	var nodeSaleTypeEatIn		= nodeCashStatistics.SaleType.(@name=="EAT_IN");
	var nodeSaleTypeTakeOut		= nodeCashStatistics.SaleType.(@name=="TAKE_OUT");
	var nodeSaleTypeOther		= nodeCashStatistics.SaleType.(@name=="OTHER");

	// children node Skim
	var nodeTransfersOutSkim	  = nodeCashDetails.TransfersOut.(@type=="SKIM");
	var nodeTransfersOutskimCount = summNodesAttributeValues(nodeTransfersOutSkim, "count");
	var nodeTransfersOutskimAmount= summNodesAttributeBigDecimalValues(nodeTransfersOutSkim, "amount");

	// children node Transfer Out
	var nodeTransfersOutTransfer	  = nodeCashDetails.TransfersOut.(@type=="TRANSFER");
	var nodeTransfersOutTransferCout  = summNodesAttributeValues(nodeTransfersOutTransfer, "count");
	var nodeTransfersOutTransferAmount= summNodesAttributeBigDecimalValues(nodeTransfersOutTransfer, "amount");

	// children node Transfer In		
	var nodeTransfersInTransfer	     = nodeCashDetails.TransfersIn.(@type=="TRANSFER");
	var nodeTransfersInTransferCout  = summNodesAttributeValues(nodeTransfersInTransfer, "count");
	var nodeTransfersInTransferAmount= summNodesAttributeBigDecimalValues(nodeTransfersInTransfer, "amount");

	//addition float
	var nodeAdditionalFloat	  = nodeCashDetails.TransfersIn.(@type=="ADDITIONAL_FLOAT");
	var nodeAdditionalFloatCount  = summNodesAttributeValues(nodeAdditionalFloat, "count");
	var nodeAdditionalFloatAmount= summNodesAttributeValues(nodeAdditionalFloat, "amount");
	
	// children node OTHER_RECEIP
	var nodeTransfersInOtherReceipts	 = nodeCashDetails.TransfersIn.(@type=="OTHER_RECEIPTS");
	var nodeTransfersInOtherReceiptsCout = summNodesAttributeValues(nodeTransfersInOtherReceipts, "count");	
	var nodeTransfersInOtherReceiptsAmount =summNodesAttributeBigDecimalValues(nodeTransfersInOtherReceipts, "amount");	

	var wasteArray 				=  getOperationKindId(nodeCashStatistics,"","WASTE");
	var wastenodesCashTc		=  wasteArray[0];
	var wastenodesCashnetAmount =  wasteArray[1];

	var promoArray 				=  getOperationKindId(nodeCashStatistics,"","PROMO");
	var promonodesCashTc 		=  promoArray[0];
	//(MS) 10.12.2009 the problem was fixed in 6.1.16 rc3
	var promonodesCashnetAmount =  promoArray[1];
	var promonodesCashTaxAmount =  promoArray[4];

	var discountArray 			=  getOperationKindId(nodeCashStatistics,"","DISCOUNT");
	//oi 26.01.2010 add for 6.1.17
	var discountnodesCashTc = discountArray[0] - discountArray[6]; // NVS-70 - Remove the Coupon TCs
	//var discountnodesCashTc 	=  discountArray[0];
	var discountnodesCashnetAmount = discountArray[1];
	var discountnodesCashnetBeforeDiscount = discountArray[2];
	var discountnodesCashCouponDiscount    = discountArray[3];
	
	var discountDiscount 		= discountnodesCashnetBeforeDiscount;
	discountDiscount			= discountDiscount.subtract(discountnodesCashnetAmount);
	discountDiscount			= discountDiscount.subtract(discountnodesCashCouponDiscount);
	var discountDiscountTax		= Number(discountArray[5]) - Number(discountArray[4]);


	var EatInDiscountArray 				=  getOperationKindId(nodeCashStatistics,"EAT_IN","DISCOUNT");
	var EatInDiscountTc 						= EatInDiscountArray[0];
	var EatInDiscountNetAmount					= EatInDiscountArray[1];
	var EatInDiscountNetAmountBeforeDiscount	= EatInDiscountArray[2];
	var EatInDiscountCouponAmount				= EatInDiscountArray[3];
	var EatInDiscountTaxAmount					= EatInDiscountArray[4];
	var EatInDiscountTaxAmountBeforeDiscount	= EatInDiscountArray[5];
	var EatInDiscountAmount	= 	EatInDiscountNetAmountBeforeDiscount.subtract(EatInDiscountNetAmount);
		EatInDiscountAmount	= 	EatInDiscountAmount.subtract(EatInDiscountCouponAmount);
	var EatInTaxDiscount	= 	EatInDiscountTaxAmountBeforeDiscount.subtract(EatInDiscountTaxAmount);

	var TakeOutDiscountArray 				=  getOperationKindId(nodeCashStatistics,"TAKE_OUT","DISCOUNT");
	var TakeOutDiscountTc 						= TakeOutDiscountArray[0];
	var TakeOutDiscountNetAmount				= TakeOutDiscountArray[1];
	var TakeOutDiscountNetAmountBeforeDiscount	= TakeOutDiscountArray[2];
	var TakeOutDiscountCouponAmount				= TakeOutDiscountArray[3];
	var TakeOutDiscountTaxAmount				= TakeOutDiscountArray[4];
	var TakeOutDiscountTaxAmountBeforeDiscount	= TakeOutDiscountArray[5];
	var TakeOutDiscountAmount	= 	TakeOutDiscountNetAmountBeforeDiscount.subtract(TakeOutDiscountNetAmount)
		TakeOutDiscountAmount	= 	TakeOutDiscountAmount.subtract(TakeOutDiscountCouponAmount);
	var TakeOutTaxDiscount		= 	TakeOutDiscountTaxAmountBeforeDiscount.subtract(TakeOutDiscountTaxAmount);

	var OtherDiscountArray 				=  getOperationKindId(nodeCashStatistics,"OTHER","DISCOUNT");
	var OtherDiscountTc 						= OtherDiscountArray[0];
	var OtherDiscountNetAmount					= OtherDiscountArray[1];
	var OtherDiscountNetAmountBeforeDiscount	= OtherDiscountArray[2];
	var OtherDiscountCouponAmount				= OtherDiscountArray[3];
	var OtherDiscountTaxAmount					= OtherDiscountArray[4];
	var OtherDiscountTaxAmountBeforeDiscount	= OtherDiscountArray[5];
	var OtherDiscountAmount	= 	OtherDiscountNetAmountBeforeDiscount.subtract(OtherDiscountNetAmount)
		OtherDiscountAmount	= 	OtherDiscountAmount.subtract(OtherDiscountCouponAmount);
	var OtherTaxDiscount	= 	OtherDiscountTaxAmountBeforeDiscount.subtract(OtherDiscountTaxAmount);

	var managerArray 			=  getOperationKindId(nodeCashStatistics,"","MANAGER");
	var managernodesCashTc 		=  managerArray[0];
	var managernodesCashnetAmount = managerArray[1];
	var managernodesCashnetBeforeDiscount = managerArray[2];
	var managernodesCashCouponDiscount    = managerArray[3];
	var managernodesCashTaxAmount = managerArray[4];
	var managernodesCashTaxBeforeDiscount = managerArray[5];
	var managerDiscount 		= managernodesCashnetBeforeDiscount.subtract(managernodesCashnetAmount);
		managerDiscount 		= managerDiscount.subtract(managernodesCashCouponDiscount);
	var managerTaxDiscount 		= managernodesCashTaxBeforeDiscount.subtract(managernodesCashTaxAmount);

	var crewArray 				=  getOperationKindId(nodeCashStatistics,"","CREW");
	var crewnodesCashTc 		=  crewArray[0];
	var crewnodesCashnetAmount  =  crewArray[1];
	var crewnodesCashnetBeforeDiscount = crewArray[2];
	var crewnodesCashCouponDiscount    = crewArray[3];
	var crewnodesCashTaxAmount  =  crewArray[4];
	var crewnodesCashTaxBeforeDiscount  =  crewArray[5];
	var crewDiscount 			= crewnodesCashnetBeforeDiscount.subtract(crewnodesCashnetAmount);
		crewDiscount 			= crewDiscount.subtract(crewnodesCashCouponDiscount);
	var crewTaxDiscount 		= crewnodesCashTaxBeforeDiscount.subtract(crewnodesCashTaxAmount);

	var saleArray 				= getOperationKindId(nodeCashStatistics,"","SALE");
	var salenodesCashTc 		= saleArray[0];
	var salenodesCashnetAmount 	= saleArray[1];
	var salenodesCashnetBeforeDiscount = saleArray[2];

	var dayMenuArray 			= getDayPartId(nodeCashStatistics,"DAY_MENU");
	var dayMenunodesCashTc 		= dayMenuArray[0];
	var dayMenunodesCashnetAmount = dayMenuArray[1];
	var dayMenudesCashnetBeforeDiscount = dayMenuArray[2];

	var breakFastDayMenuArray 		= getDayPartId(nodeCashStatistics,"BREAKFAST_MENU");
	var breakFastDayMenunodesCashTc = breakFastDayMenuArray[0];
	var breakFastDayMenunodesCashnetAmount = breakFastDayMenuArray[1];
	var breakFastDayMenudesCashnetBeforeDiscount = breakFastDayMenuArray[2]; 
	
	var nodeTransfersInOtherReceipts = nodeCashDetails.TransfersOut.(@type=="OTHER_RECEIPTS");

	var cashierId				= getNumberAttribute(root, "id");
	var cashierName				= getAttribute(root, "name");
	var nodeTenders				= root.CashDetails.Tenders;		
	if(bConsolidated /*Number(reportType) == RPTCASHBYPERIODSW  || Number(reportType) == RPTCASHACCUMULATED ||Number(reportType) == RPTINTCASHCONSOLIDATED*/)
	{
			nodeTenders				= rootCash.CashDetails.Tenders;		
	}
	var initialFloat			= calculateInitialFloat(nodeTenders);	
	var cashierOpenTime			= getAttribute(root, "login").substring(9, 14);
	var cashierCloseTime		= getAttribute(root, "logout").substring(9, 14);
	var nodeCashTotalsRefund	= nodeOperationKindRefund.CashTotals;
	var nodeCashRefund			= nodeCashTotalsRefund.Cash;	

	var nodeCashTotalsCashlessRefund	= nodeOperationKindCashlessRefund.CashTotals;
	var nodeCashCashlessRefund			= nodeCashTotalsCashlessRefund.Cash;	

	var nodeCashTotalsTaxSale			= nodeOperationKindSale.(@subType=="TAX").CashTotals;
	var nodeCashTotalsTaxExemptSale		= nodeOperationKindSale.(@subType=="TAX_EXEMPT").CashTotals;
	var nodeCashTotalsNoTaxSale			= nodeOperationKindSale.(@subType=="NO_TAX").CashTotals;
	var nodeCashTotalsNeverTaxSale		= nodeOperationKindSale.(@subType=="NEVER_TAX").CashTotals;

	var nodeCashTotalsTaxRefund			= nodeOperationKindRefund.(@subType=="TAX").CashTotals;
	var nodeCashTotalsTaxExemptRefund	= nodeOperationKindRefund.(@subType=="TAX_EXEMPT").CashTotals;
	var nodeCashTotalsNoTaxRefund		= nodeOperationKindRefund.(@subType=="NO_TAX").CashTotals;
	var nodeCashTotalsNeverTaxRefund	= nodeOperationKindRefund.(@subType=="NEVER_TAX").CashTotals;
	
	var nodeCashTotalsTaxDiscount		= nodeOperationKindDiscount.(@subType=="TAX").CashTotals;
	var nodeCashTotalsTaxExemptDiscount	= nodeOperationKindDiscount.(@subType=="TAX_EXEMPT").CashTotals;
	var nodeCashTotalsNoTaxDiscount		= nodeOperationKindDiscount.(@subType=="NO_TAX").CashTotals;
	var nodeCashTotalsNeverTaxDiscount	= nodeOperationKindDiscount.(@subType=="NEVER_TAX").CashTotals;

	var nodeCashTotalsSale				= nodeOperationKindSale.CashTotals;
	var nodeCashSale					= nodeOperationKindSale.Cash;	

	// Total Refunds
	var refundsTC				= summNodesAttributeValues(nodeCashRefund,"tc");
	var refundsAmount			= summNodesAttributeBigDecimalValues(nodeCashRefund,"netAmount");
	var refundsTaxAmount		= summNodesAttributeBigDecimalValues(nodeCashRefund,"taxAmount");
	// TAX Refunds
	var taxRefundTC				= summNodesAttributeValues(nodeCashTotalsTaxRefund.Cash, "tc");
	var taxRefundNetAmount		= summNodesAttributeBigDecimalValues(nodeCashTotalsTaxRefund.Cash, "netAmount");
	var taxRefundtaxAmount		= summNodesAttributeBigDecimalValues(nodeCashTotalsTaxRefund.Cash, "taxAmount");
	// TAX Exempt Refunds
	var taxExemptRefundTC		= summNodesAttributeValues(nodeCashTotalsTaxExemptRefund.Cash, "tc");
	var taxExemptRefundNetAmount= summNodesAttributeBigDecimalValues(nodeCashTotalsTaxExemptRefund.Cash, "netAmount");
	var taxExemptRefundtaxAmount= summNodesAttributeBigDecimalValues(nodeCashTotalsTaxExemptRefund.Cash, "taxAmount");
	// No Tax Refunds		
	var noTaxRefundtc			= summNodesAttributeValues(nodeCashTotalsNoTaxRefund.Cash, "tc");
	var noTaxRefundNetAmount	= summNodesAttributeBigDecimalValues(nodeCashTotalsNoTaxRefund.Cash, "netAmount");
	var noTaxRefundtaxAmount	= summNodesAttributeBigDecimalValues(nodeCashTotalsNoTaxRefund.Cash, "taxAmount");
	// Never Tax Refunds
	var neverTaxRefundtc		= summNodesAttributeValues(nodeCashTotalsNeverTaxRefund.Cash, "tc");
	var neverTaxRefundNetAmount	= summNodesAttributeBigDecimalValues(nodeCashTotalsNeverTaxRefund.Cash, "netAmount");
	var neverTaxRefundtaxAmount	= summNodesAttributeBigDecimalValues(nodeCashTotalsNeverTaxRefund.Cash, "taxAmount");
	// Cashless Refund
	var cashlessRefundsTC		= summNodesAttributeValues(nodeCashCashlessRefund,"tc");		
	var cashlessRefundsAmount	= summNodesAttributeBigDecimalValues(nodeCashCashlessRefund,"netAmount");
	var cashlessRefundsTaxAmount= summNodesAttributeBigDecimalValues(nodeCashCashlessRefund,"taxAmount");

	var netSalesTcDiscountTaxExempt 	= summNodesAttributeValues(nodeCashTotalsTaxExemptDiscount.Cash,"tc");
	var netSalesTcDiscountNoTax     	= summNodesAttributeValues(nodeCashTotalsNoTaxDiscount.Cash,"tc");
	var netSalesAmountDiscountTax       = summNodesAttributeBigDecimalValues(nodeCashTotalsTaxDiscount.Cash,"netAmount");
	var netSalesAmountDiscountTaxExempt = summNodesAttributeBigDecimalValues(nodeCashTotalsTaxExemptDiscount.Cash,"netAmount");
	
	var netSalesTcTaxExempt 	= summNodesAttributeValues(nodeCashTotalsTaxExemptSale.Cash,"tc") -
								  taxExemptRefundTC;
	var netSalesTcNoTax     	= summNodesAttributeValues(nodeCashTotalsNoTaxSale.Cash,"tc") -
								  noTaxRefundtc	
	var netSalesAmountTax       = (summNodesAttributeBigDecimalValues(nodeCashTotalsTaxSale.Cash,"netAmount")).subtract(taxRefundNetAmount);
	var netSalesAmountTaxExempt = (summNodesAttributeBigDecimalValues(nodeCashTotalsTaxExemptSale.Cash,"netAmount")).subtract(taxExemptRefundNetAmount);
								  
	var netSalesAmountNoTax     = (summNodesAttributeBigDecimalValues(nodeCashTotalsNoTaxSale.Cash,"netAmount")).subtract(noTaxRefundNetAmount);

	var netSalesAmountNeverTax  = (summNodesAttributeBigDecimalValues(nodeCashTotalsNeverTaxSale.Cash,"netAmount")).subtract(neverTaxRefundNetAmount);

	var nodeProductSalesCash	= nodeProductSales.Cash;
	var nodeNonProductSalesCash	= nodeNonProductSales.Cash;	

	var nodeEatInOperationKind	= nodeSaleTypeEatIn.OperationKind;
	var nodeTakeOutOperationKind= nodeSaleTypeTakeOut.OperationKind;
	var nodeOtherOperationKind	= nodeSaleTypeOther.OperationKind;

	var nodeEatInCashTotals		= nodeSaleTypeEatIn.CashTotals;
	var nodeTakeOutCashTotals	= nodeSaleTypeTakeOut.CashTotals;
	var nodeOtherCashTotals		= nodeSaleTypeOther.CashTotals;
	var nodePromo				= nodePromotions == null ? null : nodePromotions.Promo.(@type=="0"); // Promo type 0 is normal promo
	var managerId				= getNumberAttribute(rootConfig.Manager, "id");
	var taxEatIn				= getTotalTaxAmount(nodeCashStatistics, "EAT_IN");
	var taxTakeOut				= getTotalTaxAmount(nodeCashStatistics, "TAKE_OUT");
	var taxTotal				= taxEatIn.add(taxTakeOut);

	var operatorId			  = Number(root.@id);
	var ind 				  = rootPmix.POS.OperatorSession.(@id==operatorId).length()-1;
	var PMixOperatorSession;
	var PMixOperatorSessionDT;
	var PMixOperatorSessionWT;
	var rootPmixPOS = null;
	if(false==bConsolidated) {
		rootPmixPOS=rootPmix.POS.(@id==root.@id && @podShort==root.@podShort);
		PMixOperatorSessionDT = rootPmixPOS.(@podShort=="DT").FamilyGroup.(@groupName=="GIFT_COUPON");
		PMixOperatorSessionWT = rootPmixPOS.(@podShort=="WT").FamilyGroup.(@groupName=="GIFT_COUPON");
	}
	else {
		rootPmixPOS=rootPmix;
		PMixOperatorSessionDT = rootPmix.POS.(@podShort=="DT").FamilyGroup.(@groupName=="GIFT_COUPON");
		PMixOperatorSessionWT = rootPmix.POS.(@podShort=="WT").FamilyGroup.(@groupName=="GIFT_COUPON");
	}
	// Drive Thru
	var PMixProductCertRefDT  = 0;
	var PMixProductCertDT	  = 0;
	var PMixProductCardRefDT  = 0;
	var PMixProductCardDT	  = 0;
	// Walk Thru
	var PMixProductCertRefWT  = 0;
	var PMixProductCertWT	  = 0;
	var PMixProductCardRefWT  = 0;
	var PMixProductCardWT	  = 0;
	
	if(reportType == RPTCASHIERFLASH){
		 PMixOperatorSession   = rootPmix.POS.OperatorSession.(@id==operatorId)[ind];
		 PMixOperatorSessionDT = rootPmix.POS.(@podShort=="DT").OperatorSession.(@logout=="" && @id==operatorId)[ind];
		 PMixOperatorSessionWT = rootPmix.POS.(@podShort=="WT").OperatorSession.(@logout=="" && @id==operatorId)[ind];
	}
	else{
		if((reportType == RPTCASHDRAWERCHANGE)  || (reportType == RPTOPERATRORLOGOUT) || (reportType == RPTCASHIERCLOSEBYDATE)) {
			//15.01.2009 OI check for the Operator Session
			if(PMixOperatorSession   = rootPmix.POS.OperatorSession.length() > 0)
			{
				PMixOperatorSession   = rootPmix.POS.OperatorSession.(@id==cashierId && @login==root.@login);
				PMixOperatorSessionDT = rootPmix.POS.(@podShort=="DT").OperatorSession.(@logout!="" && @id==operatorId)[ind];
				PMixOperatorSessionWT = rootPmix.POS.(@podShort=="WT").OperatorSession.(@logout!="" && @id==operatorId)[ind];
			}else
			{
				PMixOperatorSession = null;
				PMixOperatorSessionDT = null;
				PMixOperatorSessionWT = null;
			}
		}
		else {
			//if(0==root.POS.length()) {
			if(false==bConsolidated) {
				PMixOperatorSession = rootPmixPOS.FamilyGroup.(@groupName=="GIFT_COUPON");
			}
			else {
				if((reportType == RPTCASHCONSOLIDATED) || (reportType == RPTINTCASHCONSOLIDATED) ||  (reportType == RPTCASHIERCLOSEBYDATE) || (reportType == RPTCASHCONSOLIDATED ) || (reportType == RPTCASHENDDAYSTOREWIDE) || (reportType == RPTCASHBYPERIODSW)) {
					PMixOperatorSession = rootPmix.FamilyGroup.(@groupName=="GIFT_COUPON");
				}
				else {
					PMixOperatorSession = rootPmix.FamilyGroup.(@groupName=="GIFT_COUPON" || @groupName=="REDEEMABLE_ITEMS"); /*MS - 12.10.2009 it was rootPmix.POS do not know why*/
				}
			}
		}
	} 
	var certSoldProduct = <root />;
	var cardSoldProduct = <root />;
	
	if(PMixOperatorSessionDT!=null) { 
		//get the list of porducts sold
		var certRef = <root />;
		var certSold = <root />;
		var cardRef = <root />;
		var cardSold = <root />;
		for(var i=0;i<PMixOperatorSessionDT.Product.length();i++)
		{
			var product = PMixOperatorSessionDT.Product[i];
			
			//in case of grill slip this will return an error because of the word class , this is why i used the eval.
			var value;
			eval("value = rootPmix.ProductTable.ProductInfo.(@id==product.@id && @familyGroup==\"GIFT_COUPON\").@class.toString()");
			if( value =="COUPONS" )
			{
				certRef.appendChild(product.OperationType.(@operationType=="REFUND").PMix);
				certSold.appendChild(product.OperationType.(@operationType=="SALE").PMix);
			}
			if( value =="NON_FOOD_PRODUCT")
			{
				cardRef.appendChild(product.OperationType.(@operationType=="REFUND").PMix);
				cardSold.appendChild(product.OperationType.(@operationType=="SALE").PMix);
			}
		}
		PMixProductCertRefDT = certRef;
		PMixProductCertDT = certSold;
		PMixProductCardRefDT = cardRef;
		PMixProductCardDT = cardSold;
		/*		
		PMixProductCertRefDT  = PMixOperatorSessionDT.Product.(@id==GIFT_CERT_1$ || @id==GIFT_CERT_5$).OperationType.(@operationType=="REFUND").PMix;
		PMixProductCertDT	  = PMixOperatorSessionDT.Product.(@id==GIFT_CERT_1$ || @id==GIFT_CERT_5$).OperationType.(@operationType=="SALE").PMix;
		PMixProductCardRefDT  = PMixOperatorSessionDT.Product.(@id!=GIFT_CERT_1$ && @id!=GIFT_CERT_5$).OperationType.(@operationType=="REFUND").PMix;
		PMixProductCardDT	  = PMixOperatorSessionDT.Product.(@id!=GIFT_CERT_1$ && @id!=GIFT_CERT_5$).OperationType.(@operationType=="SALE").PMix;
		*/
	}
	
	if(PMixOperatorSessionWT!=null) { 
		//get the list of porducts sold*/
		var certRef = <root />;
		var certSold = <root />;
		var cardRef = <root />;
		var cardSold = <root />;
		for(var i=0;i<PMixOperatorSessionWT.Product.length();i++)
		{
			var product = PMixOperatorSessionWT.Product[i];
			
			//in case of grill slip this will return an error because of the word class , this is why i used the eval.
			var value;
			eval("value=rootPmix.ProductTable.ProductInfo.(@id== product.@id && @familyGroup == \"GIFT_COUPON\").@class.toString()");
			if( value =="COUPONS" )
			{
				certRef.appendChild(product.OperationType.(@operationType=="REFUND").PMix);
				certSold.appendChild(product.OperationType.(@operationType=="SALE").PMix);
			}
			if( value =="NON_FOOD_PRODUCT")
			{
				cardRef .appendChild(product.OperationType.(@operationType=="REFUND").PMix);
				cardSold.appendChild(product.OperationType.(@operationType=="SALE").PMix);
			}
		}
	
		PMixProductCertRefWT = certRef;
		PMixProductCertWT = certSold;
		PMixProductCardRefWT = cardRef;
		PMixProductCardWT = cardSold;
		/*
		PMixProductCertRefWT  = PMixOperatorSessionWT.Product.(@id==GIFT_CERT_1$ || @id==GIFT_CERT_5$).OperationType.(@operationType=="REFUND").PMix;
		PMixProductCertWT	  = PMixOperatorSessionWT.Product.(@id==GIFT_CERT_1$ || @id==GIFT_CERT_5$).OperationType.(@operationType=="SALE").PMix;
		PMixProductCardRefWT  = PMixOperatorSessionWT.Product.(@id!=GIFT_CERT_1$ && @id!=GIFT_CERT_5$).OperationType.(@operationType=="REFUND").PMix;
		PMixProductCardWT	  = PMixOperatorSessionWT.Product.(@id!=GIFT_CERT_1$ && @id!=GIFT_CERT_5$).OperationType.(@operationType=="SALE").PMix;
		*/
	}
   // API.dbg("xmlcashreport pmixOperationsession");
	//15.01.2009 OI check for the Operator Session
	if(PMixOperatorSession != null)
	{
		// Get all Product Cert
		var certRef = <root />;
		var certSold = <root />;
		var cardRef = <root />;
		var cardSold = <root />;
		
		for(var i=0;i<PMixOperatorSession.Product.length();i++)
		{
			var product = PMixOperatorSession.Product[i];
			//in case of grill slip this will return an error because of the word class , this is why i used the eval.
			var value;
			eval("value=rootPmix.ProductTable.ProductInfo.(@id== product.@id && @familyGroup == \"GIFT_COUPON\").@class.toString()");
			if( value =="COUPONS" )
			{
				certRef.appendChild(product.OperationType.(@operationType=="REFUND").PMix);
				certSold.appendChild(product.OperationType.(@operationType=="SALE").PMix);
				certSoldProduct.appendChild(product);
			}
			if( value =="NON_FOOD_PRODUCT")
			{
				cardRef.appendChild(product.OperationType.(@operationType=="REFUND").PMix);
				cardSold.appendChild(product.OperationType.(@operationType=="SALE").PMix);
				cardSoldProduct.appendChild(product);
			}
		}
		
		var PMixProductCertRef	     = certRef;
		var PMixProductCert	    	 = certSold;
		var mcCertSalesRefundCount	 = getPMixTotalQty(PMixProductCertRef); //total gift cert refund
		var mcCertSalesCount	     = getPMixTotalQty(PMixProductCert); //  - mcCertSalesRefundCount;
		var mcCertSalesRefundAmount  = getPMixTotalnetAmount(PMixProductCertRef);
		var mcCertSalesAmount	     = getPMixTotalnetAmount(PMixProductCert);

		//to do array for every gift certificate and every gift card
		var arrGiftCertProdId = new Array();
		var arrGiftCertSoldQty = new Array();
		var arrGiftCertSoldAmt = new Array();
		var arrGiftCertRefAmt = new Array();
		var arrGiftCertRefQty = new Array();
		
		var arrGiftCardProdId = new Array();
		var arrGiftCardSoldQty = new Array();
		var arrGiftCardSoldAmt = new Array();
		var arrGiftCardRefQty = new Array();
		var arrGiftCardRefAmt = new Array();
		
		
		//MS 08.04.2011
		//the pmix report contains information only about gift certificate that are sold.
		//we need to load all gift certificates
		if(typeof(giftCertCodes) == "undefined")  //giftCertCodes is now a global variable
		{ 
			API.dbg("get the gift certificate codes from product-db.xml");
		    giftCertCodes = new Array();
			var j=0;
			//get the product-db.xml
			var file = new File("../POSDATA/product-db.xml");
			file.open("r");
			var productFile = file.read();
			file.close();
			var indexOfProductDB = productFile.indexOf("<ProductDb");
			var productDataBase = productFile.substring(indexOfProductDB);
			var productdbXML = new XML(productDataBase);
			var giftCoupons = productdbXML.Product.(FamilyGroup == "GIFT_COUPON");
			if(giftCoupons != null && giftCoupons+"" !="" && giftCoupons != "undefined") //if gift coupons are defined in product-db
			{
				for(var i = 0 ; i<giftCoupons.length(); i++)
				{
					if(giftCoupons[i].@productClass=="COUPONS" && giftCoupons[i].@statusCode =="ACTIVE")
					{
						giftCertCodes[j] = giftCoupons[i].ProductCode;
						API.dbg("Gift certificate code "+ giftCertCodes[j] +" found on position "+j);
						j++;
					}
				}	
			}			
		}
		
		//informations for gift certificates		
		
		//look in store-db to see on what location should this be put
		storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Reports\").Parameter.(@name==\"GiftCertificateTranslation\").@value"; 
		posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Reports\").Parameter.(@name==\"GiftCertificateTranslation\").@value";
		giftCertificateTranslation = getConfigValue(storedbPath , posdbPath);
		API.dbg("giftCertificateTranslation "+giftCertificateTranslation);
		orderGiftCertificate();
		
		for(var i=0; i<giftCertCodes.length; i++)
		{
			//get the index that should be send to back office
			var j=0;
			var index = getGiftIndex(giftCertCodes[i], giftCertificateTranslation); //check to see if there is a product translation in store-db
			if(index !=-1)  //product translation found
			{
				j= index;
			}
			else  //we did not find the product so we must put it in the first available location
			{
				j = getAvailableGiftArrayIndex();
			}
			
			//check to see if the product was sold 
			var indexPMIX = getGiftCertPmixIndex(giftCertCodes[i]);
			if(indexPMIX != -1)
			{
				arrGiftCertProdId[j] = giftCertCodes[i];
				var product = certSoldProduct.Product[indexPMIX];
				arrGiftCertRefQty[j] = getPMixTotalQty(product.OperationType.(@operationType=="REFUND").PMix);
				arrGiftCertRefAmt[j] = getPMixTotalnetAmount(product.OperationType.(@operationType=="REFUND").PMix);
			
				arrGiftCertSoldQty[j] = getPMixTotalQty(product.OperationType.(@operationType=="SALE").PMix);
				arrGiftCertSoldAmt[j] = getPMixTotalnetAmount(product.OperationType.(@operationType=="SALE").PMix) ;
			}
			else
			{
				arrGiftCertProdId[j] = giftCertCodes[i];
				arrGiftCertRefQty[j] = 0;
				arrGiftCertRefAmt[j] = 0;
				arrGiftCertSoldQty[j] = 0;
				arrGiftCertSoldAmt[j] = 0;
			}
		}
		
		//information for gift card  no need to fix this because is not used in europe, just gift certificate needs to be send on backoffice at the same possition always
		for(var i=0; i< cardSoldProduct.Product.length(); i++)
		{
			var product = cardSoldProduct.Product[i];
			arrGiftCardProdId[i] = product.@id;
			
			arrGiftCardRefQty[i] = getPMixTotalQty(product.OperationType.(@operationType=="REFUND").PMix);
			arrGiftCardRefAmt[i] = getPMixTotalnetAmount(product.OperationType.(@operationType=="REFUND").PMix);
			
			arrGiftCardSoldQty[i] = getPMixTotalQty(product.OperationType.(@operationType=="SALE").PMix);
			arrGiftCardSoldAmt[i] = getPMixTotalnetAmount(product.OperationType.(@operationType=="SALE").PMix); 
		}
		
/*		
		// Gift cert 1$
		var PMixProductCertRefA	     = PMixOperatorSession.Product.(@id==GIFT_CERT_1$).OperationType.(@operationType=="REFUND").PMix;
		var PMixProductCertA	     = PMixOperatorSession.Product.(@id==GIFT_CERT_1$).OperationType.(@operationType=="SALE").PMix;
		var mcCertASalesRefundCount	 = getPMixTotalQty(PMixProductCertRefA);
		var mcCertASalesCount	     = getPMixTotalQty(PMixProductCertA); // - mcCardSalesRefundCount;
		var mcCertASalesRefundAmount = getPMixTotalnetAmount(PMixProductCertRefA); 
		var mcCertASalesAmount	     = getPMixTotalnetAmount(PMixProductCertA); 

		// Gift cert 5$
		var PMixProductCertRefB	     = PMixOperatorSession.Product.(@id==GIFT_CERT_5$).OperationType.(@operationType=="REFUND").PMix;
		var PMixProductCertB	     = PMixOperatorSession.Product.(@id==GIFT_CERT_5$).OperationType.(@operationType=="SALE").PMix;
		var mcCertBSalesRefundCount	 = getPMixTotalQty(PMixProductCertRefB);
		var mcCertBSalesCount	     = getPMixTotalQty(PMixProductCertB); // - mcCardSalesRefundCount;
		var mcCertBSalesRefundAmount = getPMixTotalnetAmount(PMixProductCertRefB); 
		var mcCertBSalesAmount	     = getPMixTotalnetAmount(PMixProductCertB); 
*/
		// Get all Product without Cert
		var PMixProductCardRef	     = cardRef;
		var PMixProductCard	     	 = cardSold;
		var mcCardSalesRefundCount	 = getPMixTotalQty(PMixProductCardRef);
		var mcCardSalesCount	     = getPMixTotalQty(PMixProductCard); // - mcCardSalesRefundCount;
		var mcCardSalesRefundAmount  = getPMixTotalnetAmount(PMixProductCardRef); 
		var mcCardSalesAmount	     = getPMixTotalnetAmount(PMixProductCard); 
		
		//netSalesAmountNeverTax 	= netSalesAmountNeverTax - (mcCertSalesAmount-mcCertSalesRefundAmount) - (mcCardSalesAmount-mcCardSalesRefundAmount);
	}else
	{

	var mcCertSalesRefundCount	 = new BigDecimal("0.00"); 
	var mcCertSalesCount	     = new BigDecimal("0.00"); 
	var mcCertSalesRefundAmount  = new BigDecimal("0.00");
	var mcCertSalesAmount	     = new BigDecimal("0.00");
	/*
	var mcCertASalesRefundCount	= new BigDecimal("0.00");
	var mcCertASalesCount	    = new BigDecimal("0.00");
	var mcCertASalesRefundAmount = new BigDecimal("0.00");
	var mcCertASalesAmount	     = new BigDecimal("0.00");

	var mcCertBSalesRefundCount	 = new BigDecimal("0.00");
	var mcCertBSalesCount	     = new BigDecimal("0.00");
	var mcCertBSalesRefundAmount = new BigDecimal("0.00");
	var mcCertBSalesAmount	    = new BigDecimal("0.00");
	*/
	var mcCardSalesRefundCount	= new BigDecimal("0.00");
	var mcCardSalesCount	    = new BigDecimal("0.00");
	var mcCardSalesRefundAmount = new BigDecimal("0.00");
	var mcCardSalesAmount	   = new BigDecimal("0.00");
	}
	
	//calculate the amount of gift cert and gift card sold  in breakfast day part.
	var substractGiftCardFromBreakfast 	 = 0;
	var substractGiftCertFromBreakfast 	 = 0;
	for(var g=0; g<certSoldProduct.Product.length(); g++)
	{
		for(var opType =0; opType < certSoldProduct.Product[g].OperationType.length(); opType++)
		{
			for(var iPrice =0; iPrice < certSoldProduct.Product[g].OperationType[opType].Price.length();iPrice++)
			{
				if(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].@dayPart=="BREAKFAST_MENU")
				{
					if(certSoldProduct.Product[g].OperationType[opType].@operationType=="SALE")
					{
						if(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtTakeOut !="")
						{
							substractGiftCertFromBreakfast= Number(substractGiftCertFromBreakfast) + Number(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtTakeOut);
						}
						if(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtEatIn !="")
						{
							substractGiftCertFromBreakfast= Number(substractGiftCertFromBreakfast) + Number(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtEatIn);
						}
					}
					if(certSoldProduct.Product[g].OperationType[opType].@operationType=="REFUND")
					{
						if(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtTakeOut !="")
						{
							substractGiftCertFromBreakfast= Number(substractGiftCertFromBreakfast) - Number(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtTakeOut);
						}
						if(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtEatIn !="")
						{
							substractGiftCertFromBreakfast= Number(substractGiftCertFromBreakfast) - Number(certSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtEatIn);
						}
					}
				}
			}			
		}
	}
	
	
	for(var g=0; g<cardSoldProduct.Product.length(); g++)
	{
		for(var opType =0; opType < cardSoldProduct.Product[g].OperationType.length(); opType++)
		{
			for(var iPrice =0; iPrice < cardSoldProduct.Product[g].OperationType[opType].Price.length();iPrice++)
			{
				if(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].@dayPart=="BREAKFAST_MENU")
				{
					if(cardSoldProduct.Product[g].OperationType[opType].@operationType=="SALE")
					{
						if(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtTakeOut !="")
						{
							substractGiftCardFromBreakfast= Number(substractGiftCardFromBreakfast) + Number(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtTakeOut);
						}
						if(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtEatIn !="")
						{
							substractGiftCardFromBreakfast= Number(substractGiftCardFromBreakfast) + Number(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtEatIn);
						}
					}
					if(cardSoldProduct.Product[g].OperationType[opType].@operationType=="REFUND")
					{
						if(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtTakeOut !="")
						{
							substractGiftCardFromBreakfast= Number(substractGiftCardFromBreakfast) - Number(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtTakeOut);
						}
						if(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtEatIn !="")
						{
							substractGiftCardFromBreakfast= Number(substractGiftCardFromBreakfast) - Number(cardSoldProduct.Product[g].OperationType[opType].Price[iPrice].PMix.@netAmtEatIn);
						}
					}
				}
			}			
		}
	}
	API.dbg(substractGiftCardFromBreakfast+" "+substractGiftCertFromBreakfast);
	
	
		//netSalesAmountNeverTax 	= netSalesAmountNeverTax - (mcCertSalesAmount-mcCertSalesRefundAmount) - (mcCardSalesAmount-mcCardSalesRefundAmount);
	// DES-167
	/*netSalesAmountNeverTax 	= netSalesAmountNeverTax.subtract(mcCertSalesAmount);
	netSalesAmountNeverTax 	= netSalesAmountNeverTax.add(mcCertSalesRefundAmount);*/
	netSalesAmountNeverTax 	= netSalesAmountNeverTax.subtract(mcCardSalesAmount);
	netSalesAmountNeverTax 	= netSalesAmountNeverTax.add(mcCardSalesRefundAmount);
	if(Country == "UK" || Country =="IE")
	{
		netSalesAmountNeverTax 	= netSalesAmountNeverTax.subtract(mcCertSalesAmount);
		netSalesAmountNeverTax 	= netSalesAmountNeverTax.add(mcCertSalesRefundAmount);
	}

	var mcCardRedeemedAmount= getMcCardRedeemedAmount(root/*Cash*/);

	var netSalesAmount		= summNodesAttributeBigDecimalValues(nodeCash, "netAmount");
		netSalesAmount		= netSalesAmount.subtract(mcCertSalesAmount);
		netSalesAmount		= netSalesAmount.add(mcCertSalesRefundAmount);
		netSalesAmount		= netSalesAmount.subtract(mcCardSalesAmount);
		netSalesAmount		= netSalesAmount.add(mcCardSalesRefundAmount);
	var taxAmount			= summNodesAttributeBigDecimalValues(nodeCash, "taxAmount");
	var taxAmount_P			= summNodesAttributeBigDecimalValues(nodeProductSalesCash, "taxAmount");	// D10
	var taxAmount_NP		= summNodesAttributeBigDecimalValues(nodeNonProductSalesCash, "taxAmount");	// D10

	var totalNonProductSales= summNodesAttributeBigDecimalValues(nodeNonProductSalesCash, "netAmount");
							  
	// Get tender information
	if(nodeTenders != null) {
		var nodesTender = nodeTenders.Tender;
		var nodesTenderSize = nodesTender.length();
		for(var i = 0; i < nodesTenderSize; i++) {
			var nodeTender = nodesTender[i];
			var tcTenderId				= getNumberAttribute(nodeTender, "id");
			
			tcTenderIdArray[tcTenderId] += summNodesAttributeValues(nodeTender, "tc");
			//get the tender category
			var tender_category = rootCash.TenderTable.TenderType.(@id ==tcTenderId).@category;
			qtyTenderIdArray[tcTenderId] += summNodesAttributeValues(nodeTender, "qty");
			if(tender_category.toString() == "TENDER_FOREIGN_CURRENCY")
			{
				drawerAmountTenderIdArray[tcTenderId]=drawerAmountTenderIdArray[tcTenderId].add(summNodesAttributeBigDecimalValues(nodeTender, "fDrawerAmount"));
				changeDifferenceAmountTenderIdArray[tcTenderId]=changeDifferenceAmountTenderIdArray[tcTenderId].add(summNodesAttributeBigDecimalValues(nodeTender, "fChangeDifferenceAmount"));
				excessAmountTenderIdArray[tcTenderId]=excessAmountTenderIdArray[tcTenderId].add(summNodesAttributeBigDecimalValues(nodeTender, "fExcessAmount"));
			}
			else
			{
				drawerAmountTenderIdArray[tcTenderId]=drawerAmountTenderIdArray[tcTenderId].add(summNodesAttributeBigDecimalValues(nodeTender, "drawerAmount"));
				changeDifferenceAmountTenderIdArray[tcTenderId]=changeDifferenceAmountTenderIdArray[tcTenderId].add(summNodesAttributeBigDecimalValues(nodeTender, "changeDifferenceAmount"));
				excessAmountTenderIdArray[tcTenderId]=excessAmountTenderIdArray[tcTenderId].add(summNodesAttributeBigDecimalValues(nodeTender, "excessAmount"));
			}
			sumExcessAmount = sumExcessAmount.add(summNodesAttributeBigDecimalValues(nodeTender, "excessAmount")); //is in native currency
			//sumExcessAmount=sumExcessAmount.add(excessAmountTenderIdArray[tcTenderId]);
			/* information added in version 6.1.3
			qtyCashout[tcTenderId] += summNodesAttributeValues(nodeTender, "CashOutCount");
			amountCashout[tcTenderId]=amountCashout[tcTenderId].add(summNodesAttributeBigDecimalValues(nodeTender, "CashOutAmount"));
			*/
			//MS 21.01.2011 - enable refund inforation per tender
			qtyRefund[tcTenderId] += summNodesAttributeValues(nodeTender, "refundCount");
			refundCashout[tcTenderId]=refundCashout[tcTenderId].add(summNodesAttributeBigDecimalValues(nodeTender, "refundAmount"));
			

			// OI 27.01.2010 add for 6.1.17
			if(0==tcTenderId) {
				sumChangeRounding += summNodesAttributeValues(nodeTender,"changeRounding");
				qtyChangeRounding += summNodesAttributeValues(nodeTender,"changeRoundingCount");
			}
	    		cashoutTc[tcTenderId] += summNodesAttributeValues(nodeTender, "CashOutCount");
			cashoutAmount[tcTenderId] += summNodesAttributeValues(nodeTender, "CashOutAmount");
			
		}
	}
	
	// cashless & other payment total 
	var CashlessTC=0;
	var CashlessQty=0;
	var CashlessAmount=new BigDecimal("0.00");
	
	
	var totalOtherPaymentQty =0;
	var totalOtherPaymentAmount =new BigDecimal("0.00");
	var totalOtherPaymentExcess = new BigDecimal("0.00");
	
	var totalCreditSaleQty =0;
	var totalCreditSaleAmount =new BigDecimal("0.00");
	var totalCreditSaleExcess = new BigDecimal("0.00");
	
	var totalGiftCouponQty =0;
	var totalGiftCouponAmount =new BigDecimal("0.00");
	var totalGiftCouponExcess = new BigDecimal("0.00");
	
	var totalGiftCertificateQty =0;
	var totalGiftCertificateAmount =new BigDecimal("0.00");
	var totalGiftCertificateExcess = new BigDecimal("0.00");
	
	var totalGiftCardQty =0;
	var totalGiftCardAmount =new BigDecimal("0.00");
	var totalGiftCardExcess = new BigDecimal("0.00");
	
	if(nodeTenders != null) {
		var nodesTender = nodeTenders.Tender;
		var nodesTenderSize = nodesTender.length();
		for(var i = 0; i < nodesTenderSize; i++) {
			var nodeTender = nodesTender[i];
			var tcTenderId = getNumberAttribute(nodeTender, "id");
			var tender_category = rootCash.TenderTable.TenderType.(@id ==tcTenderId).@category;
			if(tender_category.toString() == "TENDER_ELECTRONIC_PAYMENT")
			{
				CashlessTC += tcTenderIdArray[tcTenderId];
				CashlessQty += qtyTenderIdArray[tcTenderId];
				CashlessAmount=CashlessAmount.add(drawerAmountTenderIdArray[tcTenderId]);
			}
			if(tender_category.toString() =="TENDER_OTHER_PAYMENT")
			{
				totalOtherPaymentQty += qtyTenderIdArray[tcTenderId];
				totalOtherPaymentAmount = totalOtherPaymentAmount.add(drawerAmountTenderIdArray[tcTenderId]);
				totalOtherPaymentExcess = totalOtherPaymentExcess.add(excessAmountTenderIdArray[tcTenderId]);
			}
			if(tender_category.toString() =="TENDER_CREDIT_SALES")
			{
				totalCreditSaleQty += qtyTenderIdArray[tcTenderId];
				totalCreditSaleAmount = totalCreditSaleAmount.add(drawerAmountTenderIdArray[tcTenderId]);
				totalCreditSaleExcess = totalCreditSaleExcess.add(excessAmountTenderIdArray[tcTenderId]);
			}
			if(tender_category.toString() =="TENDER_GIFT_COUPON")
			{
				//get the tender legacy  , this will be disponible in cash xml starting with 6.1.17
				var storedbPath = "StoreDB.TenderTypes.TenderType.(TenderId==\""+tcTenderId+"\").GiftCoupon.LegacyId";
				var type = getConfigValue(storedbPath , "");
	
				if(type.toString() =="GIFTCERTIFICATE")
				{
					totalGiftCertificateQty += qtyTenderIdArray[tcTenderId];
					totalGiftCertificateAmount = totalGiftCertificateAmount.add(drawerAmountTenderIdArray[tcTenderId]);
					totalGiftCertificateExcess = totalGiftCertificateExcess.add(excessAmountTenderIdArray[tcTenderId]);
				}
				else if(type.toString() =="GIFTCARD")
				{
					totalGiftCardQty += qtyTenderIdArray[tcTenderId];
					totalGiftCardAmount = totalGiftCardAmount.add(drawerAmountTenderIdArray[tcTenderId]);
					totalGiftCardExcess = totalGiftCardExcess.add(excessAmountTenderIdArray[tcTenderId]);
				}
				else
				{
					totalGiftCouponQty += qtyTenderIdArray[tcTenderId];
					totalGiftCouponAmount = totalGiftCouponAmount.add(drawerAmountTenderIdArray[tcTenderId]);
					totalGiftCouponExcess = totalGiftCouponExcess.add(excessAmountTenderIdArray[tcTenderId]);
				}
				
			}
		}	
	}
	
	/*
	for(var iIndex = CASHLESS_RANGE_INIT; iIndex < CASHLESS_RANGE_END; iIndex++) {
		CashlessTC += tcTenderIdArray[iIndex];
		CashlessQty += qtyTenderIdArray[iIndex];
		CashlessAmount=CashlessAmount.add(drawerAmountTenderIdArray[iIndex]);
	}
           */
	/*
	var CouponsQtty=qtyTenderIdArray[COUPON_A]+qtyTenderIdArray[COUPON_B]+qtyTenderIdArray[COUPON_C]+qtyTenderIdArray[COUPON_D]+tcTenderIdArray[COUPON_E];
	var CouponsAmount=((((drawerAmountTenderIdArray[COUPON_A].add(drawerAmountTenderIdArray[COUPON_B])).add(drawerAmountTenderIdArray[COUPON_C])).add(drawerAmountTenderIdArray[COUPON_D])).add(tcTenderIdArray[COUPON_E]));
	*/
	var CouponsTax=new BigDecimal("0.00");

	var inProgressTC		= summNodesAttributeValues(nodeVoid, "inProgressTC");	
	var inProgressAmount		= summNodesAttributeBigDecimalValues(nodeVoid, "inProgressAmount");	
	var inProgressEatinTC		= summNodesAttributeValues(nodeVoid, "inProgressEatinTC");	
	var inProgressEatinAmount	= summNodesAttributeBigDecimalValues(nodeVoid, "inProgressEatinAmount");	
	var inProgressTakeoutTC		= summNodesAttributeValues(nodeVoid, "inProgressTakeoutTC");	
	var inProgressTakeoutAmount	= summNodesAttributeBigDecimalValues(nodeVoid, "inProgressTakeoutAmount");	

	var inProgressProdTC		= summNodesAttributeValues(nodeVoid, "inProgressProdTC");	
	var inProgressNonProdTC		= summNodesAttributeValues(nodeVoid, "inProgressNonProdTC");	
	
	var overringsTC				= inProgressTC + summNodesAttributeValues(nodeVoid, "overringTC");
	var overringsAmount			= inProgressAmount.add(summNodesAttributeBigDecimalValues(nodeVoid, "overringAmount"));

	var nodeCashOutTC			= summNodesAttributeValues(nodeCashOut,"tc");
	var nodeCashOutAmount		= summNodesAttributeBigDecimalValues(nodeCashOut,"amount");

	var difference				= closingReading.subtract(openingReading);
	var pettyCashCount			= getPettyCashCount(nodeCashDetails);
	var pettyCashAmount			= getPettyCashAmount(nodeCashDetails);

	// OI 27.01.2010 change for 6.1.17
	//var totTcCashRefunds 	 	= refundsTC-cashlessRefundsTC+nodeCashOutTC;
	var totTcCashRefunds 	 	= refundsTC-cashlessRefundsTC;
	/*
	var totAmountCashRefunds 	= (refundsAmount + refundsTaxAmount + nodeCashOutAmount) - 
								  (cashlessRefundsAmount + cashlessRefundsTaxAmount);
	*/
	var totAmountCashRefunds 	= refundsAmount;
		totAmountCashRefunds	= totAmountCashRefunds.add(refundsTaxAmount);
		//totAmountCashRefunds	= totAmountCashRefunds.add(nodeCashOutAmount);
		totAmountCashRefunds	= totAmountCashRefunds.subtract(cashlessRefundsAmount);
		totAmountCashRefunds	= totAmountCashRefunds.subtract(cashlessRefundsTaxAmount);
	/*
	var grossSalesAmount		= 	difference  - 
									overringsAmount - 
									totAmountCashRefunds - 
									(cashlessRefundsAmount + cashlessRefundsTaxAmount) - 
									nodeTransfersInOtherReceiptsAmount - 
									(mcCertSalesAmount - mcCertSalesRefundAmount) -
									(mcCardSalesAmount - mcCardSalesRefundAmount);
	*/
	var grossSalesAmount		= difference;
		grossSalesAmount		= grossSalesAmount.subtract(overringsAmount);
		grossSalesAmount		= grossSalesAmount.subtract(totAmountCashRefunds);
		grossSalesAmount		= grossSalesAmount.subtract(cashlessRefundsAmount);
		grossSalesAmount		= grossSalesAmount.subtract(cashlessRefundsTaxAmount);
		grossSalesAmount		= grossSalesAmount.subtract(nodeTransfersInOtherReceiptsAmount);
		grossSalesAmount		= grossSalesAmount.subtract(mcCertSalesAmount);
		grossSalesAmount		= grossSalesAmount.add(mcCertSalesRefundAmount);
		grossSalesAmount		= grossSalesAmount.subtract(mcCardSalesAmount);
		grossSalesAmount		= grossSalesAmount.add(mcCardSalesRefundAmount);
	var totalnetSalesAmount		= netSalesAmount;
	var totTaxAmount 			= taxAmount;
	var totProductTaxAmount 	= taxAmount_P;	// D10
	var totNonProductTaxAmount 	= taxAmount_NP;	// D10

	var qtdTCDiscard = root.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
	var qtdTCDiscard_P = root.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.ProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
	var qtdTCDiscard_NP = root.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.NonProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10

	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"countOverringTC\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"countOverringTC\").@value";
	var countOverring = getConfigValue(storedbPath , posdbPath);
	
	var GC100ValueMeal=summNodesAttributeValues(qtdTCDiscard,"tc");
	var GC100ValueMeal_P=summNodesAttributeValues(qtdTCDiscard_P,"tc");
	var GC100ValueMeal_NP=summNodesAttributeValues(qtdTCDiscard_NP,"tc");
	
	if(notCount100ValueMealGC == false)
	{
		GC100ValueMeal = 0;
		GC100ValueMeal_P = 0;
		GC100ValueMeal_NP = 0;
	}
	var totalTc 				= summNodesAttributeValues(root.CashTotals.Cash,"tc") - 
								  GC100ValueMeal + inProgressTC;
	if(countOverring != "true") //this is the default behavior we do not consider overring as transaction
	{
		totalTc = totalTc - overringsTC;
	}							  
								  
	var totalTcP 				= summNodesAttributeValues(root.CashTotals.ProductSales.Cash,"tc") - 
								  GC100ValueMeal_P + inProgressProdTC;	// D10
	var totalTcNP 				= summNodesAttributeValues(root.CashTotals.NonProductSales.Cash,"tc") - 
								  GC100ValueMeal_NP + inProgressNonProdTC;	// D10

	var tredsTC					= summNodesAttributeValues(nodeReduction, "tc");
	var tredsAfterTotal			= summNodesAttributeValues(nodeReduction, "redsAfterTotal");
	var tredsAmtAfterTotal		= summNodesAttributeBigDecimalValues(nodeReduction, "redsAmtAfterTotal");
	var tredAmtBeforeTl			= summNodesAttributeBigDecimalValues(nodeReduction, "amountBeforeTotal");
	var tredItemsBeforeTl		= summNodesAttributeValues(nodeReduction, "itemsBeforeTotal");
	var tredAmtAfterTl			= summNodesAttributeBigDecimalValues(nodeReduction, "amountAfterTotal");
	var tredItemsAfterTl		= summNodesAttributeValues(nodeReduction, "itemsAfterTotal");
	var tredAverageBeforeTl		= tredItemsBeforeTl > 0 ? (tredAmtBeforeTl / tredItemsBeforeTl) : 0;
	var tredAverageAfterTl		= tredsAfterTotal > 0 ? (tredsAmtAfterTotal / tredsAfterTotal) : 0;//tredItemsAfterTl > 0 ? (tredsAmtAfterTotal / tredItemsAfterTl) : 0;
	var promoItems				= summNodesAttributeValues(nodePromo, "items");
	var promoItemsAmount		= summNodesAttributeBigDecimalValues(nodePromo, "amount");
	var promoTc					= summNodesAttributeValues(nodePromo, "tc");
	var promoTcNetAmount		= summNodesAttributeBigDecimalValues(nodePromo, "tcNetAmount");
	var promoTcTaxAmount		= summNodesAttributeBigDecimalValues(nodePromo, "tcTaxAmount");
	var promoTcTotalAmount		= promoTcNetAmount.add(promoTcTaxAmount);

	// Drive-Thru values
	var dtinProgress			=0;
	var	dtTc					=0;
	var	dtTc_P					=0;
	var	dtTc_NP					=0;
	var	dtNetAmount				=new BigDecimal("0.00");
	var	dtProductNetAmount		=new BigDecimal("0.00");
	var	dtProductTaxAmount		=new BigDecimal("0.00");
	var	dtCars					=0;
	var dtDiscard				=null;
	var qtdTCDiscard			=null;
	var qtdTCDiscard_P			=null;
	var qtdTCDiscard_NP			=null;
	
	// Walk-Thru values
	var wtinProgress			=0;
	var	wtTc					=0;
	var	wtTc_P					=0;
	var	wtTc_NP					=0;
	var	wtNetAmount				=new BigDecimal("0.00");
	var	wtProductNetAmount		=new BigDecimal("0.00");
	var	wtProductTaxAmount		=new BigDecimal("0.00");
	var wtDiscard				=null;
	var qtdWtTCDiscard			=null;
	var qtdWtTCDiscard_P		=null;
	var qtdWtTCDiscard_NP		=null;
	//API.dbg("xmlcashreport before rptcashconsolidated if");
	if((reportType == RPTCASHCONSOLIDATED) || (reportType == RPTINTCASHCONSOLIDATED)){
		// consolidated can receive partial cash report from ISP script
		dtinProgress			= summNodesAttributeValues(root.(@podShort=="DT").CashDetails.Void,"inProgressTakeoutTC");			
		qtdTCDiscard			= root.(@podShort=="DT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
		qtdTCDiscard_P			= root.(@podShort=="DT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.ProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
		qtdTCDiscard_NP			= root.(@podShort=="DT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.NonProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
		
		//MS 31.05.2011 parameter to display 0 amount crew meals
		var GC100ValueMeal=summNodesAttributeValues(qtdTCDiscard,"tc");
		var GC100ValueMeal_P=summNodesAttributeValues(qtdTCDiscard_P,"tc");
		var GC100ValueMeal_NP=summNodesAttributeValues(qtdTCDiscard_NP,"tc");
		
		if(notCount100ValueMealGC == false)
		{
			GC100ValueMeal = 0;
			GC100ValueMeal_P = 0;
			GC100ValueMeal_NP = 0;
		}
		
		dtTc					= getPodCashAttribute(root, "DT", "tc")-GC100ValueMeal + dtinProgress;
		dtTc_P					= getPodCashAttribute(root, "DT", "tc", "P")-GC100ValueMeal_P;// + dtinProgress;
		dtTc_NP					= getPodCashAttribute(root, "DT", "tc", "NP")-GC100ValueMeal_NP;// + dtinProgress;
		dtNetAmount				= getBigDecPodCashAttribute(root, "DT", "netAmount");
		dtCars					= getPodCashAttribute(root, "DT", "cars");
		dtProductNetAmount		= getBigDecPodCashAttribute(root, "DT", "netAmount","P");
		dtProductTaxAmount		= getBigDecPodCashAttribute(root, "DT", "taxAmount","P");

		if(flagTypePodWT) {		
			wtinProgress 		= summNodesAttributeValues(root.(@podShort=="WT").CashDetails.Void,"inProgressTakeoutTC");			
			qtdWtTCDiscard 		= root.(@podShort=="WT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
			qtdWtTCDiscard_P	= root.(@podShort=="WT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.ProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
			qtdWtTCDiscard_NP 	= root.(@podShort=="WT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.NonProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
			
			//MS 31.05.2011 parameter to display 0 amount crew meals
			var GCW100ValueMeal=summNodesAttributeValues(qtdWtTCDiscard,"tc");
			var GCW100ValueMeal_P=summNodesAttributeValues(qtdWtTCDiscard_P,"tc");
			var GCW100ValueMeal_NP=summNodesAttributeValues(qtdWtTCDiscard_NP ,"tc");
			
			if(notCount100ValueMealGC == false)
			{
				GCW100ValueMeal = 0;
				GCW100ValueMeal_P = 0;
				GCW100ValueMeal_NP = 0;
			}
			wtTc				= getPodCashAttribute(root, "WT", "tc")-GCW100ValueMeal + wtinProgress;
			dtTc_P				= getPodCashAttribute(root, "WT", "tc", "P")-GCW100ValueMeal_P;// + dtinProgress;
			dtTc_NP				= getPodCashAttribute(root, "WT", "tc", "NP")-GCW100ValueMeal_NP;// + dtinProgress;
			wtNetAmount			= getBigDecPodCashAttribute(root, "WT", "netAmount");
			wtProductNetAmount	= getBigDecPodCashAttribute(root, "WT", "netAmount","P");
			wtProductTaxAmount	= getBigDecPodCashAttribute(root, "DT", "taxAmount","P");
		}
	}
	else {
		// keep others report types as it was...
		dtinProgress			= summNodesAttributeValues(rootCash.POS.(@podShort=="DT").CashDetails.Void,"inProgressTakeoutTC");
		qtdTCDiscard			= rootCash.POS.(@podShort=="DT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
		qtdTCDiscard_P			= root.POS.(@podShort=="DT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.ProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
		qtdTCDiscard_NP			= root.POS.(@podShort=="DT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.NonProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
		//MS 31.05.2011 parameter to display 0 amount crew meals
		var GC100ValueMeal=summNodesAttributeValues(qtdTCDiscard,"tc");
		var GC100ValueMeal_P=summNodesAttributeValues(qtdTCDiscard_P,"tc");
		var GC100ValueMeal_NP=summNodesAttributeValues(qtdTCDiscard_NP,"tc");
		
		if(notCount100ValueMealGC == false)
		{
			GC100ValueMeal = 0;
			GC100ValueMeal_P = 0;
			GC100ValueMeal_NP = 0;
		}
		
		dtTc					= getPodCashAttribute(rootCash, "DT", "tc")-GC100ValueMeal + dtinProgress;
		dtTc_P					= getPodCashAttribute(rootCash, "DT", "tc", "P")-GC100ValueMeal_P;// + dtinProgress;
		dtTc_NP					= getPodCashAttribute(rootCash, "DT", "tc", "NP")-GC100ValueMeal_NP;// + dtinProgress;
		dtNetAmount				= getBigDecPodCashAttribute(rootCash, "DT", "netAmount");
		dtCars					= getPodCashAttribute(rootCash, "DT", "cars");
		dtProductNetAmount		= getBigDecPodCashAttribute(rootCash, "DT", "netAmount","P");
		dtProductTaxAmount		= getBigDecPodCashAttribute(rootCash, "DT", "taxAmount","P");

		if(flagTypePodWT) {			
			wtinProgress 		= summNodesAttributeValues(rootCash.POS.(@podShort=="WT").CashDetails.Void,"inProgressTakeoutTC");
			qtdWtTCDiscard 		= rootCash.POS.(@podShort=="WT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
			qtdWtTCDiscard_P	= rootCash.POS.(@podShort=="WT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.ProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
			qtdWtTCDiscard_NP 	= rootCash.POS.(@podShort=="WT").CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.NonProductSales.Cash.(@netAmount=="0.00");//.@tc	// D10
			
			//MS 31.05.2011 parameter to display 0 amount crew meals
			var GCW100ValueMeal=summNodesAttributeValues(qtdWtTCDiscard,"tc");
			var GCW100ValueMeal_P=summNodesAttributeValues(qtdWtTCDiscard_P,"tc");
			var GCW100ValueMeal_NP=summNodesAttributeValues(qtdWtTCDiscard_NP,"tc");
			
			if(notCount100ValueMealGC == false)
			{
				GCW100ValueMeal = 0;
				GCW100ValueMeal_P = 0;
				GCW100ValueMeal_NP = 0;
			}
			
			wtTc				= getPodCashAttribute(rootCash, "WT", "tc")-GCW100ValueMeal + wtinProgress;
			dtTc_P				= getPodCashAttribute(rootCash, "WT", "tc", "P")-GCW100ValueMeal_P;// + dtinProgress;
			dtTc_NP				= getPodCashAttribute(rootCash, "WT", "tc", "NP")-GCW100ValueMeal_NP;// + dtinProgress;
			wtNetAmount			= getBigDecPodCashAttribute(rootCash, "WT", "netAmount");
			wtProductNetAmount	= getBigDecPodCashAttribute(rootCash, "WT", "netAmount","P");
			wtProductTaxAmount	= getBigDecPodCashAttribute(rootCash, "DT", "taxAmount","P");
		}
	}
	if ((reportType == RPTCASHIERFLASH) ||	(reportType == RPTCASHDRAWERCHANGE)  || (reportType == RPTOPERATRORLOGOUT) || (reportType == RPTCASHIERCLOSEBYDATE)) {	
		if (flagTypePos == "DT") {
			var nodeCashTotals 	= root.CashTotals[0];
			var nodeCash 		= findFirst(nodeCashTotals, "Cash");
			var nodeCashDetails	= root.CashDetails[0];		
			dtinProgress 		= 0;
			var nodeVoid 		= findFirst(nodeCashDetails, "Void");				
			if(nodeVoid != null) {
				dtinProgress 	= getNumberAttribute(nodeVoid, "inProgressTakeoutTC");
			}
			if(nodeCash != null) {
				qtdTCDiscard 	= nodeCash.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
				
				//MS 31.05.2011 parameter to display 0 amount crew meals
				var GC100ValueMeal=summNodesAttributeValues(qtdTCDiscard,"tc");
				
				if(notCount100ValueMealGC == false)
				{
					GC100ValueMeal = 0;
				}
				dtTc 		 	= getNumberAttribute(nodeCash, "tc")-GC100ValueMeal + dtinProgress;
				dtNetAmount  	= getBigDecimalAttribute(nodeCash, "netAmount");
				dtCars		 	= getNumberAttribute(nodeCash, "cars");
			} else {
				dtTc 		 	= 0;
				dtNetAmount  	= new BigDecimal("0.00");
				dtCars		 	= 0;
			}
		} else {
			dtTc 		 		= 0;
			dtNetAmount  		= new BigDecimal("0.00");
			dtCars		 		= 0;
		}
		
		
		if(flagTypePodWT) {
			var nodeCashTotals 	= root.CashTotals[0];
			var nodeCash 		= findFirst(nodeCashTotals, "Cash");
			var nodeCashDetails	= root.CashDetails[0];		
			dtinProgress 		=0;
			var nodeVoid 		= findFirst(nodeCashDetails, "Void");				
			if(nodeVoid != null) {
				dtinProgress 	= getNumberAttribute(nodeVoid, "inProgressTakeoutTC");
			}
			if(nodeCash != null) {
				qtdWtTCDiscard	= nodeCash.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
				//MS 31.05.2011 parameter to display 0 amount crew meals
				var GCW100ValueMeal=summNodesAttributeValues(qtdWtTCDiscard,"tc");
				
				if(notCount100ValueMealGC == false)
				{
					GCW100ValueMeal = 0;
				}
				
				wtTc 		 	= getNumberAttribute(nodeCash, "tc")-GCW100ValueMeal + dtinProgress;
				wtNetAmount  	= getBigDecimalAttribute(nodeCash, "netAmount");
			} else {
				wtTc 		 	= 0;
				wtNetAmount  	= new BigDecimal("0.00");
				wtCars		 	= 0;
			}
		} else {
			wtTc 		 		= 0;
			wtNetAmount  		= new BigDecimal("0.00");
		}
		
	}
	dtNetAmount					= dtNetAmount.subtract(getPMixTotalnetAmount(PMixProductCardDT));
	dtNetAmount					= dtNetAmount.subtract(getPMixTotalnetAmount(PMixProductCertDT));
	dtNetAmount					= dtNetAmount.add(getPMixTotalnetAmount(PMixProductCertRefDT));
	dtNetAmount					= dtNetAmount.add(getPMixTotalnetAmount(PMixProductCardRefDT));
	var dtPercent				= calculatePercentage(dtNetAmount, netSalesAmount);
	wtNetAmount					= wtNetAmount.subtract(getPMixTotalnetAmount(PMixProductCardWT));
	wtNetAmount					= wtNetAmount.subtract(getPMixTotalnetAmount(PMixProductCertWT)); 	
	wtNetAmount					= wtNetAmount.add(getPMixTotalnetAmount(PMixProductCertRefWT));
	wtNetAmount					= wtNetAmount.add(getPMixTotalnetAmount(PMixProductCardRefWT));
	var wtPercent				= calculatePercentage(wtNetAmount, netSalesAmount);
	API.dbg("sotec "+ breakFastDayMenunodesCashnetAmount+ " " +substractGiftCardFromBreakfast +" " +substractGiftCertFromBreakfast);
	
	breakFastDayMenunodesCashnetAmount = new BigDecimal(breakFastDayMenunodesCashnetAmount);
	breakFastDayMenunodesCashnetAmount = breakFastDayMenunodesCashnetAmount.subtract(substractGiftCardFromBreakfast);
	breakFastDayMenunodesCashnetAmount = breakFastDayMenunodesCashnetAmount.subtract(substractGiftCertFromBreakfast);

	// Breakfast values
	var breakFastDayMenuPercent	= calculatePercentage(breakFastDayMenunodesCashnetAmount, totalnetSalesAmount);
    //API.dbg("xmlCashReport before calculatePercentage function");
	// Eat in values	
	var eiqtdTCDiscard 			= root.CashStatistics.SaleType.(@name=="EAT_IN").OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
	var eiTc					= summNodesAttributeValues(nodeEatInCashTotals.Cash, "tc"); 
	if(notCount100ValueMealGC == true)
	{
		eiTc = eiTc - (summNodesAttributeValues(eiqtdTCDiscard,"tc")<=0 ? 0 : summNodesAttributeValues(eiqtdTCDiscard,"tc"));
	}
	
	var eiTc					= eiTc + inProgressEatinTC;
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"countOverringTC\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"countOverringTC\").@value";
	var countOverring = getConfigValue(storedbPath , posdbPath);
	if(countOverring != "true") //this is the default behavior we do not consider overring as transaction
	{
		eiTc = eiTc - summNodesAttributeValues(nodeVoid, "overringEatinTC");
	}								  
	var eiNetAmount				= summNodesAttributeBigDecimalValues(nodeEatInCashTotals.Cash, "netAmount");
	eiNetAmount					= eiNetAmount.subtract(summNodesAttributeBigDecimalValues(PMixProductCard.PMix,"netAmtEatIn"));
	eiNetAmount					= eiNetAmount.subtract(summNodesAttributeBigDecimalValues(PMixProductCert.PMix,"netAmtEatIn"));    //(getPMixTotalnetAmount(PMixProductCert));
	eiNetAmount					= eiNetAmount.add(summNodesAttributeBigDecimalValues(PMixProductCertRef.PMix,"netAmtEatIn"));   //(getPMixTotalnetAmount(PMixProductCertRef));
	eiNetAmount					= eiNetAmount.add(summNodesAttributeBigDecimalValues(PMixProductCardRef.PMix,"netAmtEatIn"));
		
	var eiPercent				= calculatePercentage(eiNetAmount, netSalesAmount);
	var eiTax					= summNodesAttributeBigDecimalValues(nodeEatInCashTotals.Cash,"taxAmount"); 
	eiTax						= eiTax.subtract(summNodesAttributeBigDecimalValues(PMixProductCard.PMix,"taxEatIn"));
	eiTax						= eiTax.subtract(summNodesAttributeBigDecimalValues(PMixProductCert.PMix,"taxEatIn"));
	eiTax						= eiTax.add(summNodesAttributeBigDecimalValues(PMixProductCertRef.PMix,"taxEatIn"));
	eiTax						= eiTax.add(summNodesAttributeBigDecimalValues(PMixProductCardRef.PMix,"taxEatIn"));
	
	// Take out values
	var toqtdTCDiscard 			= root.CashStatistics.SaleType.(@name=="TAKE_OUT").OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc
	var toTc					= summNodesAttributeValues(nodeTakeOutCashTotals.Cash, "tc");

	if(notCount100ValueMealGC == true)
	{
		 toTc =  toTc -	 (summNodesAttributeValues(toqtdTCDiscard,"tc")<=0 ? 0 : summNodesAttributeValues(toqtdTCDiscard,"tc")) 
	}
	toTc = toTc+inProgressTakeoutTC;
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"countOverringTC\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"countOverringTC\").@value";
	var countOverring = getConfigValue(storedbPath , posdbPath);
	if(countOverring != "true") //this is the default behavior we do not consider overring as transaction
	{
		toTc = toTc - summNodesAttributeValues(nodeVoid, "overringTakeoutTC");
	}	
	/*
	var toNetAmount				= summNodesAttributeBigDecimalValues(nodeTakeOutCashTotals.Cash, "netAmount")
								   - summNodesAttributeBigDecimalValues(PMixProductCard,"netAmtTakeOut")
								   - summNodesAttributeBigDecimalValues(PMixProductCert,"netAmtTakeOut")
								   + summNodesAttributeBigDecimalValues(PMixProductCertRef,"netAmtTakeOut")
								   + summNodesAttributeBigDecimalValues(PMixProductCardRef,"netAmtTakeOut");
	*/
	

	var toNetAmount				= summNodesAttributeBigDecimalValues(nodeTakeOutCashTotals.Cash, "netAmount");
	toNetAmount					= toNetAmount.subtract(summNodesAttributeBigDecimalValues(PMixProductCard.PMix,"netAmtTakeOut"));
	toNetAmount					= toNetAmount.subtract(summNodesAttributeBigDecimalValues(PMixProductCert.PMix,"netAmtTakeOut"));
	toNetAmount					= toNetAmount.add(summNodesAttributeBigDecimalValues(PMixProductCertRef.PMix,"netAmtTakeOut"));
	toNetAmount					= toNetAmount.add(summNodesAttributeBigDecimalValues(PMixProductCardRef.PMix,"netAmtTakeOut"));
	//var toPercent				= calculatePercentage(toNetAmount, totalnetSalesAmount);
	var toTax				= summNodesAttributeBigDecimalValues(nodeTakeOutCashTotals.Cash, "taxAmount");
	toTax					= toTax.subtract(summNodesAttributeBigDecimalValues(PMixProductCard.PMix,"taxTakeOut"));
	toTax					= toTax.subtract(summNodesAttributeBigDecimalValues(PMixProductCert.PMix,"taxTakeOut"));
	toTax					= toTax.add(summNodesAttributeBigDecimalValues(PMixProductCertRef.PMix,"taxTakeOut"));
	toTax					= toTax.add(summNodesAttributeBigDecimalValues(PMixProductCardRef.PMix,"taxTakeOut"));
	var toPercent 				= calculatePercentage((toNetAmount.add(toTax)), (totalnetSalesAmount.add(totTaxAmount)));
	
	if (Country == "DE" || Country =="UK" || Country =="IE")
	{
		toPercent 				= calculatePercentage(toNetAmount, totalnetSalesAmount);
	}
	
	// Take out values
	var otherqtdTCDiscard 		= root.CashStatistics.SaleType.(@name=="OTHER").OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");//.@tc	
	var otherTc					= summNodesAttributeValues(nodeOtherCashTotals.Cash, "tc");	
	if(notCount100ValueMealGC == true)
	{
		 otherTc =  otherTc -	 (summNodesAttributeValues(otherqtdTCDiscard,"tc")<=0 ? 0 : summNodesAttributeValues(otherqtdTCDiscard,"tc")); 
	}
	
	/*
	var otherNetAmount			= summNodesAttributeBigDecimalValues(nodeOtherCashTotals.Cash, "netAmount")
								   - summNodesAttributeBigDecimalValues(PMixProductCard,"netAmtOther")
								   - summNodesAttributeBigDecimalValues(PMixProductCert,"netAmtOther")
								   + summNodesAttributeBigDecimalValues(PMixProductCertRef,"netAmtOther")
								   + summNodesAttributeBigDecimalValues(PMixProductCardRef,"netAmtOther");
	*/
	var otherNetAmount			= summNodesAttributeBigDecimalValues(nodeOtherCashTotals.Cash, "netAmount");
	otherNetAmount				= otherNetAmount.subtract(summNodesAttributeBigDecimalValues(PMixProductCard,"netAmtOther"));
	otherNetAmount				= otherNetAmount.subtract(summNodesAttributeBigDecimalValues(PMixProductCert,"netAmtOther"));
	otherNetAmount				= otherNetAmount.add(summNodesAttributeBigDecimalValues(PMixProductCertRef,"netAmtOther"));
	otherNetAmount				= otherNetAmount.add(summNodesAttributeBigDecimalValues(PMixProductCardRef,"netAmtOther"));
	var otherPercent			= calculatePercentage(otherNetAmount, netSalesAmount);
	var otherTax				= summNodesAttributeBigDecimalValues(nodeOtherCashTotals.Cash, "taxAmount");

	
	
   //API.dbg ("XMLCashReport END - before GenXMLCashRpt()");
	return(GenXMLCashRpt());
	
	
	//****************************************
	function GenXMLCashRpt() {

      API.dbg ("GenXMLCashRpt START");
		// D10 changes - block init
		switch(reportType) {
		case RPTINTCASHCONSOLIDATED:	// D10
			ExecRptIntCashConsolidated();
			break;
		case RPTCASHCONSOLIDATED:
			// fall thru
		default:
			ExecRptCashConsolidated();
			break;
		}
		// D10 changes - block end
		API.dbg(XMLCashRpt);
      API.dbg ("GenXMLCashRpt END");		
		return XMLCashRpt;
		
		function ExecRptIntCashConsolidated() {
			var iCount;
         
         API.dbg ("ExecRptIntCashConsolidated START");         
			XMLCashRpt = new XML("<dailyinternationalcashfile/>");
			var initialFloats = nodeCashDetails.TransfersIn.(@type=="INITIAL_FLOAT").Transfer;
			var initialFloatsSize = initialFloats.length();

			for(iCount=0; iCount<initialFloatsSize; iCount++) {
				var cmd = "XMLCashRpt.csh_InitAmount_ttype_" + iCount + "=Str2Currency(initialFloats[" + iCount + "].@amount)";
				var evaluate = eval(cmd);
			}
			XMLCashRpt.csh_OpeningForeverReading=BigDec2Currency(openingReading);
			XMLCashRpt.csh_CurrentForeverReading=BigDec2Currency(closingReading);

			XMLCashRpt.csh_TransactionCount=Number(totalTcP);
			XMLCashRpt.csh_TransactionCountAll=Number(totalTc);
			XMLCashRpt.csh_TransactionCountNP=Number(totalTcNP);

			XMLCashRpt.csh_OverringQuantity=Number(overringsTC);
			XMLCashRpt.csh_OverringAmount=BigDec2Currency(overringsAmount);
			XMLCashRpt.csh_RefundQuantity=Number(totTcCashRefunds);
			XMLCashRpt.csh_RefundAmount=BigDec2Currency(totAmountCashRefunds);
			XMLCashRpt.csh_RefundTax=BigDec2Currency(taxRefundtaxAmount);
			XMLCashRpt.csh_OtherReceiptsQuantity=Number(nodeTransfersInOtherReceiptsCout);
			XMLCashRpt.csh_OtherReceiptsAmount=BigDec2Currency(nodeTransfersInOtherReceiptsAmount);
			/*	DES-128 implement this only under change request
						XMLCashRpt.csh_CashlessSalesQuantity=CashlessQty;
						XMLCashRpt.csh_CashlessSalesAmount=(CashlessAmount.add(grossCashlessRefundsAmount)).toString();
			*/
			//giftcert
			//MS 08.04.2011 change to have the same number for a given cert product code
			for(var i =0; i< 20;i++)   //arrGiftCertProdId.length
			{
				//var j=i+1;
				/* not for cash upload
				var cmd = "XMLCashRpt.GiftCert"+j+"Sold.@prodId ="+arrGiftCertProdId[i];
				eval(cmd);
				var cmd = "XMLCashRpt.GiftCert"+j+"Sold.@tc ="+arrGiftCertSoldQty[i]+"-"+arrGiftCertRefQty[i];
				eval(cmd);
				var cmd = "XMLCashRpt.GiftCert"+j+"Sold.@amount ="+arrGiftCertSoldAmt+"-"+arrGiftCertRefAmt[i];
				eval(cmd);
				//var cmd = "XMLCashRpt.GiftCert"+j+"Sold.@refundTc ="+arrGiftCertRefQty[i];
				//eval(cmd);
				//var cmd = "XMLCashRpt.GiftCert"+j+"Sold.@refundAmount ="+arrGiftCertRefAmt[i];
				//eval(cmd);
				*/
				if(arrGiftCertProdId[i] !=undefined)
				{
					var cmd = "XMLCashRpt.csh_GiftCert"+i+"ProductId ="+arrGiftCertProdId[i];
					eval(cmd);
					var cmd = "XMLCashRpt.csh_GiftCert"+i+"Quantity ="+arrGiftCertSoldQty[i]+"-"+arrGiftCertRefQty[i];
					eval(cmd);
					var cmd = "XMLCashRpt.csh_GiftCert"+i+"Sold ="+arrGiftCertSoldAmt[i]+"-"+arrGiftCertRefAmt[i];
					eval(cmd);
				}
				//var cmd = "XMLCashRpt.csh_GiftCert"+j+"refundQuantity ="+arrGiftCertRefQty[i];
				//eval(cmd);
				//var cmd = "XMLCashRpt.csh_GiftCert"+j+"refundAmount ="+arrGiftCertRefAmt[i];
				//eval(cmd);				
			}
			//giftcard
			for(var i=0; i< arrGiftCardProdId.length; i++)
			{
				var j=i+1;
				/*not for cash upload
				var cmd = "XMLCashRpt.GiftCard"+j+"Sold.@prodId ="+arrGiftCardProdId[i];
				eval(cmd);
				var cmd = "XMLCashRpt.GiftCard"+j+"Sold.@tc ="+arrGiftCardSoldQty[i]+"-"+arrGiftCardRefQty[i];
				eval(cmd);
				var cmd = "XMLCashRpt.GiftCard"+j+"Sold.@amount ="+arrGiftCardSoldAmt[i]+"-"+arrGiftCardRefAmt[i];
				eval(cmd);
				//var cmd = "XMLCashRpt.GiftCard"+j+"Sold.@refundTc ="+arrGiftCardRefQty[i];
				//eval(cmd);
				//var cmd = "XMLCashRpt.GiftCard"+j+"Sold.@refundAmount ="+arrGiftCardRefAmt[i];
				//eval(cmd);
				*/
				var cmd = "XMLCashRpt.csh_GiftCard"+j+"ProductId ="+arrGiftCardProdId[i];
				eval(cmd);
				var cmd = "XMLCashRpt.csh_GiftCard"+j+"Quantity ="+arrGiftCardSoldQty[i]+"-"+arrGiftCardRefQty[i];
				eval(cmd);
				var cmd = "XMLCashRpt.csh_GiftCard"+j+"Sold ="+arrGiftCardSoldAmt[i]+"-"+arrGiftCardRefAmt[i];
				eval(cmd);
				//var cmd = "XMLCashRpt.csh_GiftCard"+j+"refundQuantity ="+arrGiftCardRefQty[i];
				//eval(cmd);
				//var cmd = "XMLCashRpt.csh_GiftCard"+j+"refundAmount ="+arrGiftCardRefAmt[i];
				//eval(cmd);
			}
			
			
			/* add individual tags for every tender*/
			//counters for number of tenders per category
			var arrayGroupTenders = new Array();
			arrayGroupTenders["TENDER_NATIVE"] = 1;
			arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"] = 1;
			arrayGroupTenders["TENDER_GIFT_COUPON"] = 1;
			arrayGroupTenders["TENDER_GIFT_CERT"] = 1;
			arrayGroupTenders["TENDER_GIFT_CARD"] = 1;
			arrayGroupTenders["TENDER_FOREIGN_CURRENCY"] = 1;
			arrayGroupTenders["TENDER_CREDIT_SALES"] = 1;
			arrayGroupTenders["TENDER_OTHER_PAYMENT"] = 1;
			arrayGroupTenders["TENDER_BOG"] = 1;
			
			var nodesTender = rootCash.TenderTable.TenderType; //take all tenders defined in the store
			var nodesTenderSize = nodesTender.length();
			for(var i = 0; i < nodesTenderSize; i++) 
			{
				var nodeTender = nodesTender[i];
				var tenderCategory = nodeTender.@category;
				switch (tenderCategory.toString())
				{
					case "TENDER_NATIVE":
					{
						/*not for cash upload
						//add drawer change tag
						XMLCashRpt.NativeCurrency.@tc=qtyTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.NativeCurrency.@amount=drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						XMLCashRpt.NativeCurrency.@excess= excessAmountTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.NativeCurrency.@change= changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						*/
						//add csh_TenderCategory tags
						XMLCashRpt.csh_NativeCurrencyQuantity = qtyTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.csh_NativeCurrencyAmount = drawerAmountTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.csh_NativeCurrencyChange = changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.csh_NativeCurrencyExcess = excessAmountTenderIdArray[Number(nodeTender.@id)];
						arrayGroupTenders["TENDER_NATIVE"]++;
						break;
					}
					case "TENDER_ELECTRONIC_PAYMENT":
					{
						/*not for cash upload
						//add drawer change tag
						var cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						eval(cmd);
						var cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						*/
						//add csh_TenderCategory tags
						var cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+"Quantity ="+ qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+"Amount ="+ drawerAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+"Change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+"Excess ="+ excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]++;
						break;
					}
					case "TENDER_GIFT_COUPON":
					{
						//get the tender legacy  , this will be disponible in cash xml starting with 6.1.17
						var storedbPath = "StoreDB.TenderTypes.TenderType.(TenderId==\""+nodeTender.@id+"\").GiftCoupon.LegacyId";
						var type = getConfigValue(storedbPath , "");
	
						if(type.toString() =="GIFTCERTIFICATE")
						{
							/*not for cash upload
							var cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"Redeem.@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"Redeem.@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
							eval(cmd);
							var cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"Redeem.@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"Redeem.@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							*/
							//add csh_TenderCategory tags
							cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"RedeemQuantity = "+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"RedeemAmount="+drawerAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"RedeemChange= "+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"RedeemExcess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							arrayGroupTenders["TENDER_GIFT_CERT"]++;				
						}
						else if (type.toString() =="GIFTCARD")
						{
							/*not for cash upload
							var cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"Redeem.@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"Redeem.@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
							eval(cmd);
							var cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"Redeem.@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"Redeem.@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							*/
							//add csh_TenderCategory tags
							cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"RedeemQuantity = "+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"RedeemAmount="+drawerAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"RedeemChange= "+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"RedeemExcess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							arrayGroupTenders["TENDER_GIFT_CARD"]++;	
						}
						else //coupon
						{	
							/*not for cash upload
							//add drawer change tag
							var cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
							eval(cmd);
							var cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							*/
							//add csh_TenderCategory tags
							var cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+"Quantity = "+ qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+"Amount = "+drawerAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+"Change = "+ changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+"Excess = "+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							arrayGroupTenders["TENDER_GIFT_COUPON"]++;
						}
						break;
					}
					case "TENDER_FOREIGN_CURRENCY":
					{
						/*not for cash upload
						//add drawer change tag
						var cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						eval(cmd);
						var cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						*/
						//add csh_TenderCategory tags
						var cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+"Quantity = "+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+"Amount = "+drawerAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+"Change ="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+"Excess = "+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]++;
						break;
					}
					case "TENDER_CREDIT_SALES":
					{
						/*not for cash upload
						//add drawer change tag
						var cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						eval(cmd);
						var cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						*/
						
						cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+"Quantity = "+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+"Amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+"Change= "+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+"Excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
					
						arrayGroupTenders["TENDER_CREDIT_SALES"]++;
						break;
					}
					case "TENDER_OTHER_PAYMENT":
					{
						/*not for cash upload
						//add drawer change tag
						var cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						eval(cmd);
						var cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						*/	
						//if(Country !="DE")
						//{
							//add csh_TenderCategory tags
							var cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Quantity="+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Change ="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
						//}
						/*
						else
						{
							//add csh_TenderCategory tags
							var cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Quantity=0";
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Amount=0.00";
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Excess =0.00";
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Change=0.00";
							eval(cmd);
						}
						*/
						
						arrayGroupTenders["TENDER_OTHER_PAYMENT"]++;
						break;
					}
					default : 
							break;
				}
			}
			XMLCashRpt.csh_TenderElectronicPayment	= arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"];
			XMLCashRpt.csh_TenderCouponNo 	= arrayGroupTenders["TENDER_GIFT_COUPON"];
			XMLCashRpt.csh_TenderForeignCurrencyNo	= arrayGroupTenders["TENDER_FOREIGN_CURRENCY"];
			XMLCashRpt.csh_TenderCreditSaleNo	=	arrayGroupTenders["TENDER_CREDIT_SALES"];
			XMLCashRpt.csh_TenderOtherPaymentNo =	arrayGroupTenders["TENDER_OTHER_PAYMENT"];
			XMLCashRpt.csh_GCertRedeemNo =	arrayGroupTenders["TENDER_GIFT_CERT"];
			XMLCashRpt.csh_GCardRedeemNo =	arrayGroupTenders["TENDER_GIFT_CARD"];
			XMLCashRpt.csh_GCSoldNo =	arrGiftCardProdId.length;
			XMLCashRpt.csh_GCertSoldNo =	arrGiftCertProdId.length;
			/*
			XMLCashRpt.csh_GCSoldAQuantity=Number(mcCertASalesCount - mcCertASalesRefundCount);
			XMLCashRpt.csh_GCSoldAAmount=BigDec2Currency(mcCertASalesAmount.subtract(mcCertASalesRefundAmount));
			XMLCashRpt.csh_GCSoldBQuantity=Number(mcCertBSalesCount - mcCertBSalesRefundCount);
			XMLCashRpt.csh_GCSoldBAmount=BigDec2Currency(mcCertBSalesAmount.subtract(mcCertBSalesRefundAmount));
			*/
			XMLCashRpt.csh_ProductSalesTaxAmount=BigDec2Currency(totProductTaxAmount);
			XMLCashRpt.csh_NonProductSalesTaxAmount=BigDec2Currency(totNonProductTaxAmount);
			XMLCashRpt.csh_OtherTaxAmount=Nmb2Currency(0);	// ??
			XMLCashRpt.csh_AllNetSalesAmount=BigDec2Currency(totalnetSalesAmount);
			/*
			XMLCashRpt.csh_CouponAQuantity=Number(qtyTenderIdArray[COUPON_A]);
			XMLCashRpt.csh_CouponAAmount=BigDec2Currency(drawerAmountTenderIdArray[COUPON_A]);
			XMLCashRpt.csh_CouponBQuantity=Number(qtyTenderIdArray[COUPON_B]);
			XMLCashRpt.csh_CouponBAmount=BigDec2Currency(drawerAmountTenderIdArray[COUPON_B]);
			XMLCashRpt.csh_CouponCQuantity=Number(qtyTenderIdArray[COUPON_C]);
			XMLCashRpt.csh_CouponCAmount=BigDec2Currency(drawerAmountTenderIdArray[COUPON_C]);
			XMLCashRpt.csh_CouponDQuantity=Number(qtyTenderIdArray[COUPON_D]);
			XMLCashRpt.csh_CouponDAmount=BigDec2Currency(drawerAmountTenderIdArray[COUPON_D]);
			XMLCashRpt.csh_CouponEQuantity=Number(qtyTenderIdArray[COUPON_E]);
			XMLCashRpt.csh_CouponEAmount=BigDec2Currency(drawerAmountTenderIdArray[COUPON_E]);
			*/
			// we wont deal with it this time
			XMLCashRpt.csh_nonWWSCouponAQuantity=Number(0);
			XMLCashRpt.csh_nonWWSCouponAAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessAQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessAAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimAQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimAAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponBQuantity=Number(0);
			XMLCashRpt.csh_nonWWSCouponBAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessBQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessBAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimBQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimBAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponCQuantity=Number(0);
			XMLCashRpt.csh_nonWWSCouponCAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessCQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessCAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimCQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimCAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponDQuantity=Number(0);
			XMLCashRpt.csh_nonWWSCouponDAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessDQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessDAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimDQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimDAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponEQuantity=Number(0);
			XMLCashRpt.csh_nonWWSCouponEAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessEQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponExcessEAmount=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimEQuantity=Nmb2Currency(0);
			XMLCashRpt.csh_nonWWSCouponSkimEAmount=Nmb2Currency(0);

			XMLCashRpt.csh_DiscountSalesQuantity=Number(discountnodesCashTc);
			XMLCashRpt.csh_DiscountSalesAmount=BigDec2Currency(discountDiscount);
			XMLCashRpt.csh_DiscountTax = BigDec2Currency(discountDiscountTax); //not added in business componentsWeb

			XMLCashRpt.csh_DiscountSalesTax=BigDec2Currency(netSalesAmountDiscountTax);

			XMLCashRpt.csh_DiscountSalesCouponQuantity=Number(totalGiftCouponQty); //CouponsQtty);
			XMLCashRpt.csh_DiscountSalesCouponAmount=BigDec2Currency(totalGiftCouponAmount); //CouponsAmount);
			XMLCashRpt.csh_DiscountSalesCouponTax=BigDec2Currency(CouponsTax);
			/*
			XMLCashRpt.csh_GCARedeemQuantity=Number(qtyTenderIdArray[WSE_IN]);
			XMLCashRpt.csh_GCARedeemAmount=BigDec2Currency(drawerAmountTenderIdArray[WSE_IN]);
			XMLCashRpt.csh_GCARedeemExcess=BigDec2Currency(excessAmountTenderIdArray[WSE_IN]);
			XMLCashRpt.csh_GCBRedeemQuantity=Number(qtyTenderIdArray[REC_SALES]);
			XMLCashRpt.csh_GCBRedeemAmount=BigDec2Currency(drawerAmountTenderIdArray[REC_SALES]);
			XMLCashRpt.csh_GCBRedeemExcess=BigDec2Currency(excessAmountTenderIdArray[REC_SALES]);
			*/
			/*
			if(Country == "DE")
			{
				XMLCashRpt.csh_CreditSalesQuantity=Number(qtyTenderIdArray[WME_SALES]);
				XMLCashRpt.csh_CreditSalesAmount=BigDec2Currency(drawerAmountTenderIdArray[WME_SALES]);
			}
			else
			{
				//03.02.2009 OI false tender type
				XMLCashRpt.csh_CreditSalesQuantity=Number(0);
				XMLCashRpt.csh_CreditSalesAmount=BigDec2Currency(0);
			}
			*/
			XMLCashRpt.csh_NonProductSalesAmount=BigDec2Currency(totalNonProductSales);
			XMLCashRpt.csh_NonProductSalesTax=BigDec2Currency(totNonProductTaxAmount);

			XMLCashRpt.csh_NoTaxSalesQuantity=Number(netSalesTcTaxExempt+netSalesTcNoTax);
			XMLCashRpt.csh_GSTAmount=Nmb2Currency(0);	// Australian specific Report.c line 4533
			//XMLCashRpt.csh_NoTaxSalesAmount=BigDec2Currency(netSalesAmountNoTax + netSalesAmountTaxExempt +  netSalesAmountDiscountTaxExempt);
			var AuxBigDec=netSalesAmountNoTax;
			AuxBigDec=AuxBigDec.add( netSalesAmountTaxExempt);
			AuxBigDec=AuxBigDec.add( netSalesAmountDiscountTaxExempt);
			XMLCashRpt.csh_NoTaxSalesAmount=BigDec2Currency(AuxBigDec);
			XMLCashRpt.csh_PromoSalesQuantity=Number(promonodesCashTc);
			XMLCashRpt.csh_PromoSalesAmount=BigDec2Currency(promonodesCashnetAmount);
			XMLCashRpt.csh_PromoSalesTax=BigDec2Currency(promonodesCashTaxAmount);

			// Tax break calculations
			FormatByTaxChain(rootTaxTable, "csh_PromoTax_", nodeCashStatistics, "", "PROMO", "");
			FormatByTaxChain(rootTaxTable, "csh_EatInSalesBrack_", nodeCashStatistics, "EAT_IN", "SALE", "");
			FormatByTaxChain(rootTaxTable, "csh_TakeOutSalesBrack_", nodeCashStatistics, "TAKE_OUT", "SALE", "");
			FormatByTaxChain(rootTaxTable, "csh_OtherSalesBrack_", nodeCashStatistics, "OTHER", "SALE", "");
			FormatByTaxChain(rootTaxTable, "csh_RefundBrack_", nodeCashStatistics, "", "REFUND", "");
			FormatByTaxChain(rootTaxTable, "csh_OverringBrack_", nodeCashStatistics, "", "OVERRING", "");
			FormatByTaxChain(rootTaxTable, "csh_PromoBrack_", nodeCashStatistics, "", "PROMO", "");
			FormatByTaxChain(rootTaxTable, "csh_WasteBrack_", nodeCashStatistics, "", "WASTE", "");
			FormatByTaxChain(rootTaxTable, "csh_ManagerMealBrack_", nodeCashStatistics, "", "MANAGER", "");
			FormatByTaxChain(rootTaxTable, "csh_EmployeeMealBrack_", nodeCashStatistics, "", "CREW", "");
			FormatByTaxChain(rootTaxTable, "csh_EatInProductSalesBrack_", nodeCashStatistics, "EAT_IN", "SALE", "P");
			FormatByTaxChain(rootTaxTable, "csh_EatInNonProductSalesBrack_", nodeCashStatistics, "EAT_IN", "SALE", "NP");
			FormatByTaxChain(rootTaxTable, "csh_TakeOutProductSalesBrack_", nodeCashStatistics, "TAKE_OUT", "SALE", "P");
			FormatByTaxChain(rootTaxTable, "csh_TakeOutNonProductSalesBrack_", nodeCashStatistics, "TAKE_OUT", "SALE", "NP");
			FormatByTaxChain(rootTaxTable, "csh_OtherProductSalesBrack_", nodeCashStatistics, "OTHER", "SALE", "P");
			FormatByTaxChain(rootTaxTable, "csh_OtherNonProductSalesBrack_", nodeCashStatistics, "OTHER", "SALE", "NP");
			FormatByTaxChain(rootTaxTable, "csh_ManagerMealTotalBrack_", nodeCashStatistics, "", "MANAGER", "");	// is it equal to csh_ManagerMealBrack_ ?
			FormatByTaxChain(rootTaxTable, "csh_EmployeeMealTotalBrack_", nodeCashStatistics, "", "CREW", "");	// is it equal to csh_EmployeeMealBrack_ ?
			FormatByTaxChain(rootTaxTable, "csh_ProductPromoBrack_", nodeCashStatistics, "", "PROMO", "P");
			FormatByTaxChain(rootTaxTable, "csh_NonProductPromoBrack_", nodeCashStatistics, "", "PROMO", "NP");
			FormatByTaxChain(rootTaxTable, "csh_ProductEmployeeMealBrack_", nodeCashStatistics, "", "CREW", "P");
			FormatByTaxChain(rootTaxTable, "csh_NonProductEmployeeMealBrack_", nodeCashStatistics, "", "CREW", "NP");
			FormatByTaxChain(rootTaxTable, "csh_ProductManagerMealBrack_", nodeCashStatistics, "", "MANAGER", "P");
			FormatByTaxChain(rootTaxTable, "csh_NonProductManagerMealBrack_", nodeCashStatistics, "", "MANAGER", "NP");
			FormatByTaxChain(rootTaxTable, "csh_ProductRefundBrack_", nodeCashStatistics, "", "REFUND", "P");
			FormatByTaxChain(rootTaxTable, "csh_NonProductRefundBrack_", nodeCashStatistics, "", "REFUND", "NP");
			FormatByTaxChain(rootTaxTable, "csh_ProductOverringBrack_", nodeCashStatistics, "", "OVERRING", "P");
			FormatByTaxChain(rootTaxTable, "csh_NonProductOverringBrack_", nodeCashStatistics, "", "OVERRING", "NP");
			
			//31.03.2009	OI	add Discount Tags for Tax calculation
			FormatByTaxChain(rootTaxTable, "csh_EatInProductDiscountBrack_", nodeCashStatistics, "EAT_IN", "DISCOUNT", "P");
			FormatByTaxChain(rootTaxTable, "csh_EatInNonProductDiscountBrack_", nodeCashStatistics, "EAT_IN", "DISCOUNT", "NP");
			FormatByTaxChain(rootTaxTable, "csh_TakeOutProductDiscountBrack_", nodeCashStatistics, "TAKE_OUT", "DISCOUNT", "P");
			FormatByTaxChain(rootTaxTable, "csh_TakeOutNonProductDiscountBrack_", nodeCashStatistics, "TAKE_OUT", "DISCOUNT", "NP");
			FormatByTaxChain(rootTaxTable, "csh_OtherProductDiscountBrack_", nodeCashStatistics, "OTHER", "DISCOUNT", "P");
			FormatByTaxChain(rootTaxTable, "csh_OtherNonProductDiscountBrack_", nodeCashStatistics, "OTHER", "DISCOUNT", "NP");			


			XMLCashRpt.csh_TcEmpMeal=Number(crewnodesCashTc);
			XMLCashRpt.csh_TcMgrMeal=Number(managernodesCashTc);
			XMLCashRpt.csh_TcOverring=Number(overringsTC);
			XMLCashRpt.csh_TcRefund=Number(refundsTC);
			XMLCashRpt.csh_TcOtherReceipt=Number(nodeTransfersInOtherReceiptsCout);
			XMLCashRpt.csh_TcSkim=Number(nodeTransfersOutskimCount);
			XMLCashRpt.csh_TcWaste=Number(wastenodesCashTc);

			XMLCashRpt.csh_EmployeeMealQuantity=Number(crewnodesCashTc);
			XMLCashRpt.csh_EmployeeMealAmount=BigDec2Currency(crewDiscount);
			XMLCashRpt.csh_EmployeeMealTax=BigDec2Currency(crewTaxDiscount);
			XMLCashRpt.csh_ManagerMealQuantity=Number(managernodesCashTc);
			XMLCashRpt.csh_ManagerMealAmount=BigDec2Currency(managerDiscount);
			XMLCashRpt.csh_ManagerMealTax=BigDec2Currency(managerTaxDiscount);

			XMLCashRpt.csh_TRedsBeforeTotalQuantity=Number(tredItemsBeforeTl);
			XMLCashRpt.csh_TRedsBeforeTotalAmount=BigDec2Currency(tredAmtBeforeTl);
			XMLCashRpt.csh_TRedsAfterTotalQuantity=Number(tredsAfterTotal);
			XMLCashRpt.csh_TRedsAfterTotalAmount=BigDec2Currency(tredsAmtAfterTotal);

			XMLCashRpt.csh_EatInNetSalesQuantity=Number(eiTc);
			XMLCashRpt.csh_EatInNetSalesAmount=BigDec2Currency(eiNetAmount);
			XMLCashRpt.csh_EatInNetSalesTax=BigDec2Currency(eiTax);
			XMLCashRpt.csh_EatInNetSalesDiscQuantity=Number(EatInDiscountTc);
			XMLCashRpt.csh_EatInNetSalesDiscAmount=BigDec2Currency(EatInDiscountAmount);
			XMLCashRpt.csh_EatInNetSalesDiscTax=BigDec2Currency(EatInTaxDiscount);

			XMLCashRpt.csh_TakeOutNetSalesQuantity=Number(toTc);
			XMLCashRpt.csh_TakeOutNetSalesAmount=BigDec2Currency(toNetAmount);
			XMLCashRpt.csh_TakeOutNetSalesTax=BigDec2Currency(toTax);
			XMLCashRpt.csh_TakeOutNetSalesDiscQuantity=Number(TakeOutDiscountTc);
			XMLCashRpt.csh_TakeOutNetSalesDiscAmount=BigDec2Currency(TakeOutDiscountAmount);
			XMLCashRpt.csh_TakeOutNetSalesDiscTax=BigDec2Currency(TakeOutTaxDiscount);

			XMLCashRpt.csh_OtherNetSalesQuantity=Number(otherTc);
			XMLCashRpt.csh_OtherNetSalesAmount=BigDec2Currency(otherNetAmount);
			XMLCashRpt.csh_OtherNetSalesTax=BigDec2Currency(otherTax);
			XMLCashRpt.csh_OtherNetSalesDiscQuantity=Number(OtherDiscountTc);
			XMLCashRpt.csh_OtherNetSalesDiscAmount=BigDec2Currency(OtherDiscountAmount);
			XMLCashRpt.csh_OtherNetSalesDiscTax=BigDec2Currency(OtherTaxDiscount);

			// 3.x Report.c line 4776 to 4778
			XMLCashRpt.csh_SuggestiveSalesTryQuantity=Number(0);
			XMLCashRpt.csh_SuggestiveSalesQuantity=Number(0);
			XMLCashRpt.csh_SuggestiveSalesAmount=Nmb2Currency(0);

			// MYTODO
			/*
			XMLCashRpt.csh_ForeignCurrencyAAmount=Nmb2Currency(0);
			XMLCashRpt.csh_ForeignCurrencyBAmount=Nmb2Currency(0);
			XMLCashRpt.csh_ForeignCurrencyCAmount=Nmb2Currency(0);
			XMLCashRpt.csh_ForeignCurrencyDAmount=Nmb2Currency(0);
			XMLCashRpt.csh_ForeignCurrencyEAmount=Nmb2Currency(0);
			*/
			XMLCashRpt.csh_DTTransactionCount=Number(dtTc_P);
			XMLCashRpt.csh_DTTransactionCountNP=Number(dtTc_NP);
			XMLCashRpt.csh_DTTransactionCountAll=Number(dtTc);

			XMLCashRpt.csh_DTAllNetProductSalesAmount=BigDec2Currency(dtProductNetAmount);
			XMLCashRpt.csh_DTAllTaxProductSalesAmount=BigDec2Currency(dtProductTaxAmount);
			XMLCashRpt.csh_TotalSkimAmount=BigDec2Currency(nodeTransfersOutskimAmount);

			// 3.x Report.c line 4847 and 4847
			XMLCashRpt.csh_OfflineSalesDayCloseAmount=Nmb2Currency(0);
			XMLCashRpt.csh_OffLineSalesMonthCloseAmount=Nmb2Currency(0);
			/*
			// MYTODO
			if(Country =="DE")
			{
				XMLCashRpt.csh_OtherPaymentAQuantity=Number(0);
				XMLCashRpt.csh_OtherPaymentAAmount=Nmb2Currency(0);
			}
			else
			{	//03.02.2009 OI we need the other payment
				XMLCashRpt.csh_OtherPaymentAQuantity=Number(qtyTenderIdArray[WME_SALES]);
				XMLCashRpt.csh_OtherPaymentAAmount=BigDec2Currency(drawerAmountTenderIdArray[WME_SALES]);
			}
			
			XMLCashRpt.csh_OtherPaymentAExcess=Nmb2Currency(0);
						
			XMLCashRpt.csh_OtherPaymentBQuantity=Number(0);
			XMLCashRpt.csh_OtherPaymentBAmount=Nmb2Currency(0);
			XMLCashRpt.csh_OtherPaymentBExcess=Nmb2Currency(0);
			XMLCashRpt.csh_OtherPaymentCQuantity=Number(0);
			XMLCashRpt.csh_OtherPaymentCAmount=Nmb2Currency(0);
			XMLCashRpt.csh_OtherPaymentCExcess=Nmb2Currency(0);
			XMLCashRpt.csh_OtherPaymentDQuantity=Number(0);
			XMLCashRpt.csh_OtherPaymentDAmount=Nmb2Currency(0);
			XMLCashRpt.csh_OtherPaymentDExcess=Nmb2Currency(0);
			XMLCashRpt.csh_OtherPaymentEQuantity=Number(0);
			XMLCashRpt.csh_OtherPaymentEAmount=Nmb2Currency(0);
			XMLCashRpt.csh_OtherPaymentEExcess=Nmb2Currency(0);
			*/
			XMLCashRpt.csh_WTTransactionCount=Number(wtTc_P);
			XMLCashRpt.csh_WTTransactionCountNP=Number(wtTc_NP);
			XMLCashRpt.csh_WTTransactionCountAll=Number(wtTc);
			XMLCashRpt.csh_WTAllNetProductSalesAmount=BigDec2Currency(wtProductNetAmount);

			XMLCashRpt.csh_BreakfastSalesaQuantity=Number(breakFastDayMenunodesCashTc);
			XMLCashRpt.csh_BreakfastSalesAmount=BigDec2Currency(breakFastDayMenunodesCashnetAmount);
			/*			
			XMLCashRpt.csh_CashlessSalesTC=CashlessQty;
			XMLCashRpt.csh_CashlessSalesAmount=(CashlessAmount.add(grossCashlessRefundsAmount)).toString();
			*/
			XMLCashRpt.csh_GiftCouponSalesTc = totalGiftCouponQty;
			XMLCashRpt.csh_GiftCouponSalesAmount = totalGiftCouponAmount;
			XMLCashRpt.csh_GiftCouponSalesExcess = totalGiftCouponExcess;
			
			XMLCashRpt.csh_GiftCertificateSalesTc = totalGiftCertificateQty;
			XMLCashRpt.csh_GiftCertificateSalesAmount = totalGiftCertificateAmount;
			XMLCashRpt.csh_GiftCertificateSalesExcess = totalGiftCertificateExcess;
			
			XMLCashRpt.csh_GiftCardSalesTc = totalGiftCardQty;
			XMLCashRpt.csh_GiftCardSalesAmount = totalGiftCardAmount;
			XMLCashRpt.csh_GiftCardSalesExcess = totalGiftCardExcess;
			
			XMLCashRpt.csh_OtherPaymentSalesTc = totalOtherPaymentQty;
			XMLCashRpt.csh_OtherPaymentSalesAmount = totalOtherPaymentAmount;
			XMLCashRpt.csh_OtherPaymentSalesExcess = totalOtherPaymentExcess;
			// tax table
			var taxTable = rootTaxTable.TaxTable;
			var taxTableSize = taxTable.length();

			if(Country =="DE")
			{
				for(var iCount=0; iCount<taxTableSize; iCount ++) {
					var cmd;
					var evaluate;
					var taxId = Number(taxTable[iCount].TaxType);
					var baseTaxAmount_TaxChain;
					var taxAmount_TaxChain;

					if(false==bConsolidated) {
						baseTaxAmount_TaxChain = root.CashTotals.Cash.Tax.(@id==taxId).@baseTaxAmount;
						taxAmount_TaxChain = root.CashTotals.Cash.Tax.(@id==taxId).@taxAmount;
					}
					else {
						baseTaxAmount_TaxChain = rootCash.CashTotals.Cash.Tax.(@id==taxId).@baseTaxAmount;
						taxAmount_TaxChain = rootCash.CashTotals.Cash.Tax.(@id==taxId).@taxAmount;
					}

					var taxIdFmt = API.formatNumber(Number(iCount+1), "00", 2);
					//var taxIdFmt = API.formatNumber(Number(taxId), "00", 2);

					cmd = "XMLCashRpt.csh_TaxType" + taxIdFmt + "=Number(taxTable[" + iCount + "].TaxRateId)";
					evaluate = eval(cmd);
					cmd = "XMLCashRpt.csh_TaxRate" + taxIdFmt + "=Number(taxTable[" + iCount + "].TaxRate)";
					evaluate = eval(cmd);
					cmd = "XMLCashRpt.csh_TaxBasis" + taxIdFmt + "=" + Str2Currency(baseTaxAmount_TaxChain);
					evaluate = eval(cmd);
					cmd = "XMLCashRpt.csh_Tax" + taxIdFmt + "=" + Str2Currency(taxAmount_TaxChain);
					evaluate = eval(cmd);
				 }
			}
			
			else
			{
				//16.01.2008 OI we need tags for all tax types from id 1 to 15 and not only implemented.
				for(var iTCount=1; iTCount<16; iTCount++)
				{
					var boolActive = false;
					var taxIdFmt = API.formatNumber(Number(iTCount), "00", 2);
					var cmd;
					
					for(var iCount=0; iCount<taxTableSize; iCount ++) {
						var evaluate;
						var taxId = Number(taxTable[iCount].TaxType);
						var baseTaxAmount_TaxChain;
						var taxAmount_TaxChain;

						if(taxId == iTCount)
						{
							boolActive = true;
							if(false==bConsolidated) {
								baseTaxAmount_TaxChain = root.CashTotals.Cash.Tax.(@id==taxId).@baseTaxAmount;
								taxAmount_TaxChain = root.CashTotals.Cash.Tax.(@id==taxId).@taxAmount;
							}
							else {
								baseTaxAmount_TaxChain = rootCash.CashTotals.Cash.Tax.(@id==taxId).@baseTaxAmount;
								taxAmount_TaxChain = rootCash.CashTotals.Cash.Tax.(@id==taxId).@taxAmount;
							}

							//var taxIdFmt = API.formatNumber(Number(iCount+1), "00", 2);
							//var taxIdFmt = API.formatNumber(Number(taxId), "00", 2);

							cmd = "XMLCashRpt.csh_TaxType" + taxIdFmt + "=Number(taxTable[" + iCount + "].TaxRateId)";
							evaluate = eval(cmd);
							cmd = "XMLCashRpt.csh_TaxRate" + taxIdFmt + "=Number(taxTable[" + iCount + "].TaxRate)";
							evaluate = eval(cmd);
							/*
							//06.02.2009 OI correction for GiftCertificates Sold
							if(iCount == 0)
							{
								baseTaxAmount_TaxChain= baseTaxAmount_TaxChain - (mcCertSalesAmount-mcCertSalesRefundAmount); //(mcCertBSalesAmount - mcCertBSalesRefundAmount) - (mcCertASalesAmount - mcCertASalesRefundAmount);
							}
							*/
							cmd = "XMLCashRpt.csh_TaxBasis" + taxIdFmt + "=" + Str2Currency(baseTaxAmount_TaxChain);
							evaluate = eval(cmd);
							cmd = "XMLCashRpt.csh_Tax" + taxIdFmt + "=" + Str2Currency(taxAmount_TaxChain);
							evaluate = eval(cmd);
							break;
						}	
					}
				 }

				 if(boolActive == false)
				 {
				 	cmd = "XMLCashRpt.csh_TaxType" + taxIdFmt + "=Number(" + iTCount + ")";
					evaluate = eval(cmd);
					cmd = "XMLCashRpt.csh_TaxRate" + taxIdFmt + "=Number(0)";
					evaluate = eval(cmd);
					cmd = "XMLCashRpt.csh_TaxBasis" + taxIdFmt + "= 0.00";
					evaluate = eval(cmd);
					cmd = "XMLCashRpt.csh_Tax" + taxIdFmt + "= 0.00";
					evaluate = eval(cmd);
				 }
				 
			}

			// PLE-168 - must get consolidated  = group multiple entry for the same tender 
			if(nodeTenders != null) {
				var nodesTender = nodeTenders.Tender;
				var nodesTenderSize = nodesTender.length();
				var iLoop;
				for(var iIndex = 0; iIndex < nodesTenderSize; iIndex++) {
					// look for tender id in previous
					for(iLoop = 0; iLoop < iIndex; iLoop++) {
						if(nodesTender[iIndex].@id==nodesTender[iLoop].@id) {
							// already counted
							break;
						}
					}
					if(iLoop >= iIndex) {
						// not counted before
						var resp=<csh_Tender/>;
						var nodeTender = nodesTender[iIndex];	
					    var tcTenderId = getNumberAttribute(nodeTender, "id");
					    var tenderName = rootCash.TenderTable.TenderType.(@id==nodeTender.@id).@name;
						resp.csh_TenderName=tenderName.toString();
						resp.csh_TenderCategory = rootCash.TenderTable.TenderType.(@id==nodeTender.@id).@category.toString();
						resp.csh_TenderId=tcTenderId;
						resp.csh_TenderAmount=BigDec2Currency(drawerAmountTenderIdArray[tcTenderId]);
						resp.csh_TenderQty=Number(qtyTenderIdArray[tcTenderId]);
						/* add in version 6.1.3
						//resp.csh_TenderCashoutAmount=BigDec2Currency(amountCashout[tcTenderId]);
						//resp.csh_TenderCashoutQty=Number(qtyCashout[tcTenderId]);
						*/
						//MS - 21.01.2011 enable refund information
						resp.csh_TenderRefundAmount=BigDec2Currency(refundCashout[tcTenderId]);
						resp.csh_TenderRefundQty=Number(qtyRefund[tcTenderId]);
						
						XMLCashRpt.appendChild(resp);
					}
				}
			}
			
         API.dbg ("ExecRptIntCashConsolidated END");                  
		}

		function ExecRptCashConsolidated()
		{
			// generate the XML output
			XMLCashRpt = new XML("<XMLCashRpt/>");

			XMLCashRpt.Manager.@value=managerId;
			XMLCashRpt.CashierReport.@value=iReportNumber;
			XMLCashRpt.CashierID.@value=cashierId;
			XMLCashRpt.Cashier.@value=API.setOnRight(cashierName, 19);
			XMLCashRpt.InitialFloat.@value=initialFloat.toString();
			XMLCashRpt.AdditionalFloat.@tc=nodeAdditionalFloatCount;
			XMLCashRpt.AdditionalFloat.@amount=nodeAdditionalFloatAmount;
			XMLCashRpt.Opentime.@value=cashierOpenTime;
			XMLCashRpt.Closetime.@value=cashierCloseTime;
			XMLCashRpt.Closereading.@value=closingReading.toString();
			XMLCashRpt.Openingreading.@value=openingReading.toString();
			XMLCashRpt.DIFFERENCE.@value=difference;
			XMLCashRpt.Overring.@tc=overringsTC;
			XMLCashRpt.Overring.@amount=overringsAmount.toString();
			XMLCashRpt.CashRefunds.@tc=totTcCashRefunds;
			XMLCashRpt.CashRefunds.@amount=totAmountCashRefunds.toString();
			var grossCashlessRefundsAmount = (cashlessRefundsAmount.add(cashlessRefundsTaxAmount)).toString();
			XMLCashRpt.CashlessRefunds.@tc=cashlessRefundsTC;
			XMLCashRpt.CashlessRefunds.@amount=grossCashlessRefundsAmount.toString();
			XMLCashRpt.OtherReceipts.@tc=nodeTransfersInOtherReceiptsCout;
			XMLCashRpt.OtherReceipts.@amount=nodeTransfersInOtherReceiptsAmount.toString();
			XMLCashRpt.GiftCertSold.@tc=mcCertSalesCount - mcCertSalesRefundCount;
			XMLCashRpt.GiftCertSold.@amount=(mcCertSalesAmount.subtract(mcCertSalesRefundAmount)).toString();
			XMLCashRpt.GiftCardSold.@tc=mcCardSalesCount - mcCardSalesRefundCount;
			XMLCashRpt.GiftCardSold.@amount=(mcCardSalesAmount.subtract(mcCardSalesRefundAmount)).toString();
			
			//giftcert
			//MS 08.04.2011 need to have the same position for a given gift certificate product code
			for(var i =0; i< 20;i++) //arrGiftCertProdId.length
			{
				
				if(arrGiftCertProdId[i] !=undefined)
				{
					var cmd = "XMLCashRpt.GiftCert"+i+"Sold.@prodId ="+arrGiftCertProdId[i];
					eval(cmd);
					cmd = "XMLCashRpt.GiftCert"+i+"Sold.@tc ="+arrGiftCertSoldQty[i]+"-"+arrGiftCertRefQty[i];
					eval(cmd);
					cmd = "XMLCashRpt.GiftCert"+i+"Sold.@amount ="+arrGiftCertSoldAmt[i]+"-"+arrGiftCertRefAmt[i];
					eval(cmd);
				}
				//cmd = "XMLCashRpt.GiftCert"+j+"Sold.@refundTc ="+arrGiftCertRefQty[i];
				//eval(cmd);
				//cmd = "XMLCashRpt.GiftCert"+j+"Sold.@refundAmount ="+arrGiftCertRefAmt[i];
				//eval(cmd);
				
				/*not for drawer change
				cmd = "XMLCashRpt.csh_GiftCert"+j+"ProductId ="+arrGiftCertProdId[i];
				eval(cmd);
				cmd = "XMLCashRpt.csh_GiftCert"+j+"Quantity ="+arrGiftCertSoldQty[i]+"-"+arrGiftCertRefQty[i];
				eval(cmd);
				cmd = "XMLCashRpt.csh_GiftCert"+j+"Sold ="+arrGiftCertSoldAmt[i]+"-"+arrGiftCertRefAmt[i];
				eval(cmd);
				//cmd = "XMLCashRpt.csh_GiftCert"+j+"refundQuantity ="+arrGiftCertRefQty[i];
				//eval(cmd);
				//cmd = "XMLCashRpt.csh_GiftCert"+j+"refundAmount ="+arrGiftCertRefAmt[i];
				//eval(cmd);	
*/				
			}
			//giftcard
			for(var i=0; i< arrGiftCardProdId.length; i++)
			{
				var j= i+1;
				var cmd = "XMLCashRpt.GiftCard"+j+"Sold.@prodId ="+arrGiftCardProdId[i];
				eval(cmd);
				cmd = "XMLCashRpt.GiftCard"+j+"Sold.@tc ="+arrGiftCardSoldQty[i]+"-"+arrGiftCardRefQty[i];
				eval(cmd);
				cmd = "XMLCashRpt.GiftCard"+j+"Sold.@amount ="+arrGiftCardSoldAmt[i]+"-"+arrGiftCardRefAmt[i];
				eval(cmd);
				//cmd = "XMLCashRpt.GiftCard"+j+"Sold.@refundTc ="+arrGiftCardRefQty[i];
				//eval(cmd);
				//cmd = "XMLCashRpt.GiftCard"+j+"Sold.@refundAmount ="+arrGiftCardRefAmt[i];
				//eval(cmd);
				
				/*not for drawer change
				cmd = "XMLCashRpt.csh_GiftCard"+j+"ProductId ="+arrGiftCardProdId[i];
				eval(cmd);
				cmd = "XMLCashRpt.csh_GiftCard"+j+"Quantity ="+arrGiftCardSoldQty[i]+"-"+arrGiftCardRefQty[i];;
				eval(cmd);
				cmd = "XMLCashRpt.csh_GiftCard"+j+"Sold ="+arrGiftCardSoldAmt[i]+"-"+arrGiftCardRefAmt[i];
				eval(cmd);
				//cmd = "XMLCashRpt.csh_GiftCard"+j+"refundQuantity ="+arrGiftCardRefQty[i];
				//eval(cmd);
				//cmd = "XMLCashRpt.csh_GiftCard"+j+"refundAmount ="+arrGiftCardRefAmt[i];
				//eval(cmd);
				*/
			}
			/*
			XMLCashRpt.GiftCertASold.@tc=mcCertASalesCount - mcCertASalesRefundCount;
			XMLCashRpt.GiftCertASold.@amount=(mcCertASalesAmount.subtract(mcCertASalesRefundAmount)).toString();
			XMLCashRpt.GiftCertBSold.@tc=mcCertBSalesCount - mcCertBSalesRefundCount;
			XMLCashRpt.GiftCertBSold.@amount=(mcCertBSalesAmount.subtract(mcCertBSalesRefundAmount)).toString();
			*/
			XMLCashRpt.GROSSSALES.@value=grossSalesAmount.toString();	
			//XMLCashRpt.GROSSSALES.@value=grossSalesAmount.toString();	
			XMLCashRpt.NOTAXSALES.@tc=netSalesTcTaxExempt+netSalesTcNoTax;
			AuxBigDec=netSalesAmountNoTax.add(netSalesAmountTaxExempt);
			AuxBigDec=AuxBigDec.add(netSalesAmountDiscountTaxExempt);
			XMLCashRpt.NOTAXSALES.@value=AuxBigDec.toString();
			XMLCashRpt.NONTAXABLESALES.@value= netSalesAmountNeverTax.toString();
			//var taxSales = totalnetSalesAmount;//.subtract(netSalesAmountNeverTax);	// DES-167
			//taxSales=taxSales.subtract(new BigDecimal(XMLCashRpt.NOTAXSALES.@value));
			//28.01.2009	OI add it from reports.nps to get the same value.
			var taxSales = grossSalesAmount - Number(XMLCashRpt.NOTAXSALES.@value);  //- netSalesAmountNeverTax
			if(Country == "DE")
			{
				taxSales = totalnetSalesAmount;
				taxSales = taxSales.subtract(new BigDecimal(XMLCashRpt.NOTAXSALES.@value));
			}
			XMLCashRpt.TAXABLESALES.@tc=totTaxAmount;
			XMLCashRpt.TAXABLESALES.@amount=taxSales.toString();
			var totalProductSales	= totalnetSalesAmount.subtract(totalNonProductSales);
			XMLCashRpt.TOTALNETSALES.@value=totalnetSalesAmount.toString();
			//04.02.2009 OI we need a tax tag for cash report
			XMLCashRpt.TOTALTAX.@value=taxAmount;
			XMLCashRpt.NonProductSales.@value=totalNonProductSales.toString();
			XMLCashRpt.NonProductTax.@value=totNonProductTaxAmount;
			XMLCashRpt.ProductSales.@value=totalProductSales.toString();
			XMLCashRpt.ProductTax.@value=totProductTaxAmount;
			/*
			XMLCashRpt.GiftCardRedeem.@tc=qtyTenderIdArray[GIFT_CARD];
			XMLCashRpt.GiftCardRedeem.@amount=drawerAmountTenderIdArray[GIFT_CARD].toString();
			*/
			XMLCashRpt.CashlessSales.@tc=CashlessQty;
			XMLCashRpt.CashlessSales.@amount=(CashlessAmount.add(grossCashlessRefundsAmount)).toString();
			
			XMLCashRpt.GiftCouponSales.@tc = totalGiftCouponQty;
			XMLCashRpt.GiftCouponSales.@amount = totalGiftCouponAmount;
			XMLCashRpt.GiftCouponSales.@excess = totalGiftCouponExcess;
			
			XMLCashRpt.GiftCertificateSales.@tc = totalGiftCertificateQty;
			XMLCashRpt.GiftCertificateSales.@amount = totalGiftCertificateAmount;
			XMLCashRpt.GiftCertificateSales.@excess = totalGiftCertificateExcess;
			
			XMLCashRpt.GiftCardSales.@tc = totalGiftCardQty;
			XMLCashRpt.GiftCardSales.@amount = totalGiftCardAmount;
			XMLCashRpt.GiftCardSales.@excess = totalGiftCardExcess;
			
			XMLCashRpt.OtherPaymentSales.@tc = totalOtherPaymentQty;
			XMLCashRpt.OtherPaymentSales.@amount = totalOtherPaymentAmount;
			XMLCashRpt.OtherPaymentSales.@excess = totalOtherPaymentExcess;
			/*
			//03.02.2009 OI new Tags for e-cash
			XMLCashRpt.CashlessPaymentA.@tc=qtyTenderIdArray[E_CASH_A];
			XMLCashRpt.CashlessPaymentA.@amount=drawerAmountTenderIdArray[E_CASH_A].toString()
			XMLCashRpt.CashlessPaymentB.@tc=qtyTenderIdArray[E_CASH_B];
			XMLCashRpt.CashlessPaymentB.@amount=drawerAmountTenderIdArray[E_CASH_B].toString()
			XMLCashRpt.CashlessPaymentC.@tc=qtyTenderIdArray[E_CASH_C];
			XMLCashRpt.CashlessPaymentC.@amount=drawerAmountTenderIdArray[E_CASH_C].toString()
			XMLCashRpt.CashlessPaymentD.@tc=qtyTenderIdArray[E_CASH_D];
			XMLCashRpt.CashlessPaymentD.@amount=drawerAmountTenderIdArray[E_CASH_D].toString()
			XMLCashRpt.CashlessPaymentE.@tc=qtyTenderIdArray[E_CASH_E];
			XMLCashRpt.CashlessPaymentE.@amount=drawerAmountTenderIdArray[E_CASH_E].toString()
			*/
			XMLCashRpt.CashTransferIn.@tc=nodeTransfersInTransferCout;
			XMLCashRpt.CashTransferIn.@amount=nodeTransfersInTransferAmount.toString();
			XMLCashRpt.CashTransferOut.@tc=nodeTransfersOutTransferCout;
			XMLCashRpt.CashTransferOut.@amount=nodeTransfersOutTransferAmount.toString();
			
			/* this is other payment
			XMLCashRpt.BillableSales.@tc=qtyTenderIdArray[WME_SALES];
			XMLCashRpt.BillableSales.@amount=drawerAmountTenderIdArray[WME_SALES];
			//09.10.2008 OI add excess to BillableSales Teg
			XMLCashRpt.BillableSales.@excess=excessAmountTenderIdArray[WME_SALES];
			*/
			/*
			XMLCashRpt.GiftCertif.@tc=qtyTenderIdArray[WSE_IN];
			XMLCashRpt.GiftCertif.@amount=drawerAmountTenderIdArray[WSE_IN].toString();
			*/
			/* this is for other payment
			XMLCashRpt.GiftBook.@tc=qtyTenderIdArray[REC_SALES];
			XMLCashRpt.GiftBook.@amount=drawerAmountTenderIdArray[REC_SALES].toString();
			*/
			// Fault Gift Card Redeem,Cashless Sales and Billable Sales
			var computerCash	= difference.subtract(overringsAmount);
			computerCash		= computerCash.subtract(totAmountCashRefunds);
					
			//computerCash		= computerCash.subtract(drawerAmountTenderIdArray[GIFT_CARD]);	//09.10.2008 OI comment out
			computerCash		= computerCash.subtract(grossCashlessRefundsAmount);
			computerCash		= computerCash.add(nodeTransfersInTransferAmount);
			computerCash		= computerCash.subtract(nodeTransfersOutTransferAmount);
			//computerCash		= computerCash.subtract(drawerAmountTenderIdArray[WME_SALES]);	//09.10.2008 OI comment out
			//computerCash		= computerCash.subtract(drawerAmountTenderIdArray[WSE_IN]);		//09.10.2008 OI comment out
			//computerCash		= computerCash.subtract(drawerAmountTenderIdArray[REC_SALES]);	//09.10.2008 OI comment out
			
		
			   computerCash		= computerCash.subtract(totalGiftCouponAmount);
			   computerCash		= computerCash.subtract(totalGiftCertificateAmount);
			   computerCash		= computerCash.subtract(totalGiftCardAmount);
			   computerCash		= computerCash.subtract(totalOtherPaymentAmount);
			   computerCash		= computerCash.add(totalGiftCouponExcess);
			   computerCash		= computerCash.add(totalGiftCertificateExcess);
			   computerCash		= computerCash.add(totalGiftCardExcess);
			   computerCash		= computerCash.add(totalOtherPaymentExcess);
			   /*
			   computerCash		= computerCash.subtract(drawerAmountTenderIdArray[GIFT_CARD]);
			   computerCash		= computerCash.subtract(drawerAmountTenderIdArray[WME_SALES]);
			   computerCash		= computerCash.subtract(drawerAmountTenderIdArray[WSE_IN]);	
			   computerCash		= computerCash.subtract(drawerAmountTenderIdArray[REC_SALES]);  
			   */
		
			//28.01.2009 OI substract the e-cash to get the right value
			computerCash		=computerCash.subtract(CashlessAmount);
			//28.01.2009 OI	computerCashBD is never used
			//computerCashBD		=computerCash.subtract(CashlessAmount);
			XMLCashRpt.COMPUTEDCASH.@value=computerCash.toString();
			XMLCashRpt.CashSkims.@value=nodeTransfersOutskimAmount.toString();
			//OI 27.01.2010 add for 6.1.17
			XMLCashRpt.ChangeRounding.@value=trim(API.formatNumber(sumChangeRounding,".00",50));
			XMLCashRpt.ChangeRounding.@tc=qtyChangeRounding;
			
			var expectedCash = computerCash.add(initialFloat);
			
			//27.01.2010 add for 6.1.17
			expectedCash = expectedCash.subtract(sumChangeRounding);
			expectedCash = 	expectedCash.add(nodeAdditionalFloatAmount);
			
			expectedCash=expectedCash.subtract(nodeTransfersOutskimAmount);
			XMLCashRpt.Expectedcash.@value=expectedCash.toString();
			/*
			XMLCashRpt.CashCashUS.@tc=tcTenderIdArray[CASH_US];
			XMLCashRpt.CashCashUS.@amount=(drawerAmountTenderIdArray[CASH_US].subtract(initialFloat)).toString();
			XMLCashRpt.CouponA.@tc=qtyTenderIdArray[COUPON_A];
			XMLCashRpt.CouponA.@amount=drawerAmountTenderIdArray[COUPON_A].toString();
			XMLCashRpt.CouponB.@tc=qtyTenderIdArray[COUPON_B];
			XMLCashRpt.CouponB.@amount=drawerAmountTenderIdArray[COUPON_B].toString();
			XMLCashRpt.CouponC.@tc=qtyTenderIdArray[COUPON_C];
			XMLCashRpt.CouponC.@amount=drawerAmountTenderIdArray[COUPON_C].toString();
			XMLCashRpt.CouponD.@tc=qtyTenderIdArray[COUPON_D];
			XMLCashRpt.CouponD.@amount=drawerAmountTenderIdArray[COUPON_D].toString();
			XMLCashRpt.CouponE.@tc=qtyTenderIdArray[COUPON_E];
			XMLCashRpt.CouponE.@amount=drawerAmountTenderIdArray[COUPON_E].toString();
			*/
			if(-1!=reportType) {
			 	// Get tender information
				/*<Tender id="0" tc="1" qty="1" 
				initialFloat="0.00" drawerAmount="2.00" changeGivenCount="0" changeGivenAmount="0.00" 
				CashOutCount="0" CashOutAmount="0.00" refundCount="0" refundAmount="0.00" changeDifferenceCount="0" 
				changeDifferenceAmount="0.00" changeRoundingCount="0" changeRounding="0.00" excessCount="0" excessAmount="0.00"*/
				
				var nodesTender = nodeTenders.Tender;
				var nodesTenderSize = nodesTender.length();
				var iLoop;
				for(var iIndex = 0; iIndex < nodesTenderSize; iIndex++) {
					// look for tender id in previous
					for(iLoop = 0; iLoop < iIndex; iLoop++) {
						if(nodesTender[iIndex].@id==nodesTender[iLoop].@id) {
							// already counted
							break;
						}
					}
					if(iLoop >= iIndex) {
						// not counted before do the total
						resp=<Tender />;
						resp.@id = nodesTender[iIndex].@id; 
						resp.@tc = 0;
						resp.@qty = 0;
						resp.@initialFloat = 0;
						resp.@drawerAmount = 0;
						resp.@changeGivenCount = 0;
						resp.@changeGivenAmount = 0;
						resp.@CashOutCount = 0;
						resp.@refundCount = 0;
						resp.@refundAmount = 0;
						resp.@changeDifferenceCount = 0;
						resp.@changeDifferenceAmount = 0;
						resp.@changeRoundingCount = 0;
						resp.@changeRounding = 0;
						resp.@excessCount = 0;
						resp.@excessAmount = 0;
						for(iLoop = iIndex; iLoop < nodesTenderSize; iLoop++) {
							if(nodesTender[iIndex].@id==nodesTender[iLoop].@id)
							{
								resp.@tc =  Number(resp.@tc) + Number(nodesTender[iLoop].@tc);
								resp.@qty =  Number(resp.@qty) + Number(nodesTender[iLoop].@qty);
								resp.@initialFloat =  Number(resp.@initialFloat) + Number(nodesTender[iLoop].@initialFloat);
								resp.@drawerAmount =   Number(resp.@drawerAmount) + Number(nodesTender[iLoop].@drawerAmount);
								resp.@changeGivenCount =  Number(resp.@changeGivenCount) + Number(nodesTender[iLoop].@changeGivenCount);
								resp.@changeGivenAmount =  Number(resp.@changeGivenAmount) + Number(nodesTender[iLoop].@changeGivenAmount);
								resp.@CashOutCount =  Number(resp.@CashOutCount) + Number(nodesTender[iLoop].@CashOutCoun);
								resp.@CashOutAmount =  Number(resp.@CashOutAmount) + Number(nodesTender[iLoop].@CashOutAmount);
								resp.@refundCount =  Number(resp.@refundCount) + Number(nodesTender[iLoop].@refundCount);
								resp.@refundAmount =  Number(resp.@refundAmount) + Number(nodesTender[iLoop].@refundAmount);
								resp.@changeDifferenceCount =  Number(resp.@changeDifferenceCount) + Number(nodesTender[iLoop].@changeDifferenceCount);
								resp.@changeDifferenceAmount =  Number(resp.@changeDifferenceAmount) + Number(nodesTender[iLoop].@changeDifferenceAmount);
								resp.@changeRoundingCount =  Number(resp.@changeRoundingCount) + Number(nodesTender[iLoop].@changeRoundingCount);
								resp.@changeRounding =  Number(resp.@changeRounding) + Number(nodesTender[iLoop].@changeRounding);
								resp.@excessCount =  Number(resp.@excessCount) + Number(nodesTender[iLoop].@excessCount);
								resp.@excessAmount =  Number(resp.@excessAmount) + Number(nodesTender[iLoop].@excessAmount);
								
								//for foreign currency
								resp.@fInitialFloat =  Number(resp.@fInitialFloat) + Number(nodesTender[iLoop].@fInitialFloat);
								resp.@fDrawerAmount =   Number(resp.@fDrawerAmount) + Number(nodesTender[iLoop].@fDrawerAmount);
								resp.@fChangeGivenAmount =  Number(resp.@fChangeGivenAmount) + Number(nodesTender[iLoop].@fChangeGivenAmount);
								resp.@fCashOutAmount =  Number(resp.@fCashOutAmount) + Number(nodesTender[iLoop].@fCashOutAmount);
								resp.@fChangeDifferenceCount =  Number(resp.@fChangeDifferenceCount) + Number(nodesTender[iLoop].@fChangeDifferenceCount);
								resp.@fExcessAmount =  Number(resp.@fExcessAmount) + Number(nodesTender[iLoop].@fExcessAmount);
								
							}
						}
						XMLCashRpt.appendChild(resp);
					}
				}
	
				XMLCashRpt.chashTotals = nodeCash;
			}
			XMLCashRpt.Giftcardcashout.@tc=nodeCashOutTC;
			XMLCashRpt.Giftcardcashout.@amount=nodeCashOutAmount.toString();

			// OI 27.01.2010 add for 6.1.17
			XMLCashRpt.EFTcashout.@tc=nodeCashOutTC;
			XMLCashRpt.EFTcashout.@amount=nodeCashOutAmount;

			var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"totalSaleNetAmount\").@value";
			var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"CashReport\").Parameter.(@name==\"totalSaleNetAmount\").@value";
			var netSaleAverage = getConfigValue(storedbPath , posdbPath);
			var div1;
			if(netSaleAverage == "true") //we do tha average by using the net sale
			{
				div1 = new BigDecimal(Number(totalnetSalesAmount));
			}	
			else	//default  gross price 		
			{
				div1 = new BigDecimal(Number(totalnetSalesAmount)+Number(taxAmount));
			}
			var div2 = new BigDecimal(Number(totalTc));
			var unitPricePerTc	= (totalTc != 0) ? (div1.divide(div2,ROUND_MODE_PERCENT)) : 0; // Truncates value (ROUND_DOWN)

			XMLCashRpt.TotalTCAC.@tc=totalTc;
			XMLCashRpt.TotalTCAC.@amount=unitPricePerTc.toString();

			XMLCashRpt.NetsalesDThru.@tc=dtTc;
			XMLCashRpt.NetsalesDThru.@amount=dtNetAmount.toString();
			XMLCashRpt.PercentDThru.@value=dtPercent;
			XMLCashRpt.Cars.@value=dtCars;
		
			XMLCashRpt.NetsalesWThru.@tc=wtTc;
			XMLCashRpt.NetsalesWThru.@amount=wtNetAmount.toString();
			XMLCashRpt.PercentWThru.@value=wtPercent;
			
			XMLCashRpt.NetsalesBfast.@tc=breakFastDayMenunodesCashTc;
			XMLCashRpt.NetsalesBfast.@amount=breakFastDayMenunodesCashnetAmount.toString();
			XMLCashRpt.BreakfastPercent.@value=breakFastDayMenuPercent;
			XMLCashRpt.NetsalesEatIn.@tc=eiTc;
			XMLCashRpt.NetsalesEatIn.@amount=eiNetAmount.toString();
			XMLCashRpt.EatIntax.@value=eiTax;
			XMLCashRpt.NetsalesTakeOut.@tc=toTc;
			XMLCashRpt.NetsalesTakeOut.@amount=toNetAmount.toString();
			XMLCashRpt.TakeOuttax.@value=toTax;
			XMLCashRpt.TakeOutPercent.@value=toPercent;
			XMLCashRpt.NetsalesGarden.@tc=otherTc;
			XMLCashRpt.NetsalesGarden.@amount=otherNetAmount.toString();
			XMLCashRpt.Gardentax.@tc=otherTax;
			XMLCashRpt.Waste.@tc=wastenodesCashTc;
			XMLCashRpt.Waste.@amount=wastenodesCashnetAmount.toString();
			XMLCashRpt.PROMO.@tc=promonodesCashTc;
			XMLCashRpt.PROMO.@items=promoItems;
			//23.05.2011 OI replaced Number by BigDecimal because of ACSP9198776 					
			if(Country =="UK" || Country =="IE")
			{
				XMLCashRpt.PROMO.@amount=new BigDecimal(promonodesCashnetAmount);
			}
			else
			{
				XMLCashRpt.PROMO.@amount=new BigDecimal(promonodesCashnetAmount).add( new BigDecimal(promonodesCashTaxAmount));
			}
			XMLCashRpt.EmpMealdiscount.@tc=crewnodesCashTc;
			if(Country == "DE" || Country =="UK" || Country =="IE" || Country == "PT") //PT required to be net
			{
				XMLCashRpt.EmpMealdiscount.@amount=Number(crewDiscount);
			}
			else
			{
				XMLCashRpt.EmpMealdiscount.@amount=Number(crewDiscount) + Number(crewTaxDiscount);
			}
			XMLCashRpt.MgrMealdiscount.@tc=managernodesCashTc;
			if(Country == "DE" || Country == "UK" || Country =="IE" || Country == "PT") //PT required to be net
				XMLCashRpt.MgrMealdiscount.@amount=Number(managerDiscount);
			else
			{
				XMLCashRpt.MgrMealdiscount.@amount=Number(managerDiscount)+ Number(managerTaxDiscount);
			}
			XMLCashRpt.Amountdiscount.@tc=discountnodesCashTc.toString();
			XMLCashRpt.Amountdiscount.@amount=discountDiscount.toString();
			XMLCashRpt.Amountdiscount.@tax = discountDiscountTax.toString(); //not added in businesscomponentsWeb

			XMLCashRpt.RedBeforeTotal.@tc=tredItemsBeforeTl;
			XMLCashRpt.RedBeforeTotal.@amount=tredAmtBeforeTl;
			XMLCashRpt.AvgRedBeforeTotal.@value=tredAverageBeforeTl;
			XMLCashRpt.RedAfterTotal.@tc=tredsAfterTotal;//tredItemsAfterTl;
			XMLCashRpt.RedAfterTotal.@amount=tredsAmtAfterTotal;
			XMLCashRpt.AvgRedAfterTotal.@value=tredAverageAfterTl;
			XMLCashRpt.Draweropens.@value=unauthDrawerOpenings;
			
			/*add individual tags for all gift cerificate sold*/
					
			/* add individual tags for every tender*/
			//counters for number of tenders per category
			var arrayGroupTenders = new Array();
			arrayGroupTenders["TENDER_NATIVE"] = 1;
			arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"] = 1;
			arrayGroupTenders["TENDER_GIFT_COUPON"] = 1;
			arrayGroupTenders["TENDER_GIFT_CERT"] = 1;
			arrayGroupTenders["TENDER_GIFT_CARD"] = 1;
			arrayGroupTenders["TENDER_FOREIGN_CURRENCY"] = 1;
			arrayGroupTenders["TENDER_CREDIT_SALES"] = 1;
			arrayGroupTenders["TENDER_OTHER_PAYMENT"] = 1;
			arrayGroupTenders["TENDER_BOG"] = 1;
			
			var nodesTender = rootCash.TenderTable.TenderType; //take all tenders defined in the store
			var nodesTenderSize = nodesTender.length();
			for(var i = 0; i < nodesTenderSize; i++) 
			{
				var nodeTender = nodesTender[i];
				var tenderCategory = nodeTender.@category;
				switch (tenderCategory.toString())
				{
					case "TENDER_NATIVE":
					{
						//add drawer change tag
						XMLCashRpt.NativeCurrency.@tc=qtyTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.NativeCurrency.@amount=drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						XMLCashRpt.NativeCurrency.@excess= excessAmountTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.NativeCurrency.@change= changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						/*not for drawer change
						//add csh_TenderCategory tags
						XMLCashRpt.csh_NativeCurrencyQuantity = qtyTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.csh_NativeCurrencyAmount = drawerAmountTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.csh_NativeCurrencyChange = changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						XMLCashRpt.csh_NativeCurrencyExcess = excessAmountTenderIdArray[Number(nodeTender.@id)];
						*/
						arrayGroupTenders["TENDER_NATIVE"]++;
						break;
					}
					case "TENDER_ELECTRONIC_PAYMENT":
					{
						//add drawer change tag
						var cmd = "XMLCashRpt.CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						eval(cmd);
						var cmd = "XMLCashRpt.CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						/*not for drawer change
						//add csh_TenderCategory tags
						var cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+"Quantity ="+ qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+"Amount ="+ drawerAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+"Change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CashlessPayment"+arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]+"Excess ="+ excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						*/
						arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"]++;
						break;
					}
					case "TENDER_GIFT_COUPON":
					{
						//get the tender legacy  , this will be disponible in cash xml starting with 6.1.17
						var storedbPath = "StoreDB.TenderTypes.TenderType.(TenderId==\""+nodeTender.@id+"\").GiftCoupon.LegacyId";
						var type = getConfigValue(storedbPath , "");
	
						if(type.toString() =="GIFTCERTIFICATE")
						{
							var cmd = "XMLCashRpt.GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"Redeem.@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"Redeem.@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
							eval(cmd);
							var cmd = "XMLCashRpt.GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"Redeem.@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"Redeem.@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							/*not for drawer change
							//add csh_TenderCategory tags
							cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"RedeemQuantity = "+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"RedeemAmount="+drawerAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"RedeemChange= "+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GC"+arrayGroupTenders["TENDER_GIFT_CERT"]+"RedeemExcess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							*/
							arrayGroupTenders["TENDER_GIFT_CERT"]++;	
						}
						else if (type.toString() =="GIFTCARD")
						{
							var cmd = "XMLCashRpt.GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"Redeem.@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"Redeem.@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
							eval(cmd);
							var cmd = "XMLCashRpt.GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"Redeem.@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"Redeem.@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							/*not for drawer change
							//add csh_TenderCategory tags
							cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"RedeemQuantity = "+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"RedeemAmount="+drawerAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"RedeemChange= "+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_GCard"+arrayGroupTenders["TENDER_GIFT_CARD"]+"RedeemExcess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							*/
							arrayGroupTenders["TENDER_GIFT_CARD"]++;	
						}
						else
						{
							//add drawer change tag
							var cmd = "XMLCashRpt.Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
							eval(cmd);
							var cmd = "XMLCashRpt.Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							var cmd = "XMLCashRpt.Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							/*not for drawer change
							//add csh_TenderCategory tags
							var cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+"Quantity = "+ qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+"Amount = "+drawerAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+"Change = "+ changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_Coupon"+arrayGroupTenders["TENDER_GIFT_COUPON"]+"Excess = "+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							*/
							arrayGroupTenders["TENDER_GIFT_COUPON"]++;
						}
						break;
					}
					case "TENDER_FOREIGN_CURRENCY":
					{
						//add drawer change tag
						var cmd = "XMLCashRpt.ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						eval(cmd);
						var cmd = "XMLCashRpt.ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						/*not for drawer change
						//add csh_TenderCategory tags
						var cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+"Quantity = "+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+"Amount = "+drawerAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+"Change ="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_ForeignCurrency"+arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]+"Excess = "+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						*/
						arrayGroupTenders["TENDER_FOREIGN_CURRENCY"]++;
						break;
					}
					case "TENDER_CREDIT_SALES":
					{
						//add drawer change tag
						var cmd = "XMLCashRpt.CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						eval(cmd);
						var cmd = "XMLCashRpt.CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						/*not for drawer change
						//add csh_TenderCategory tags
						
						cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+"Quantity = "+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+"Amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+"Change= "+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						cmd = "XMLCashRpt.csh_CreditSale"+arrayGroupTenders["TENDER_CREDIT_SALES"]+"Excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						*/
						arrayGroupTenders["TENDER_CREDIT_SALES"]++;
						break;
					}
					case "TENDER_OTHER_PAYMENT":
					{
						//add drawer change tag
						var cmd = "XMLCashRpt.OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+".@tc="+qtyTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+".@amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)].toString();
						eval(cmd);
						var cmd = "XMLCashRpt.OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+".@excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						var cmd = "XMLCashRpt.OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+".@change="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
						eval(cmd);
						
						/*not for drawer change
						//if(Country !="DE")
						//{
							//add csh_TenderCategory tags
							var cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Quantity="+qtyTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Amount="+drawerAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Change ="+changeDifferenceAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Excess="+excessAmountTenderIdArray[Number(nodeTender.@id)];
							eval(cmd);
						//}
						/*else						
						{
							var cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Quantity=0";
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Amount=0.00";
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Excess =0.00";
							eval(cmd);
							
							cmd = "XMLCashRpt.csh_OtherPayment"+arrayGroupTenders["TENDER_OTHER_PAYMENT"]+"Change=0.00";
							eval(cmd);
						}
						*/
						arrayGroupTenders["TENDER_OTHER_PAYMENT"]++;
						break;
					}
					default : 
							break;
				}
			}
			//we need to store some auxialiry variables
			XMLCashRpt.csh_TenderElectronicPayment	= arrayGroupTenders["TENDER_ELECTRONIC_PAYMENT"];
			XMLCashRpt.csh_TenderCouponNo 	= arrayGroupTenders["TENDER_GIFT_COUPON"];
			XMLCashRpt.csh_TenderForeignCurrencyNo	= arrayGroupTenders["TENDER_FOREIGN_CURRENCY"];
			XMLCashRpt.csh_TenderCreditSaleNo	=	arrayGroupTenders["TENDER_CREDIT_SALES"];
			XMLCashRpt.csh_TenderOtherPaymentNo =	arrayGroupTenders["TENDER_OTHER_PAYMENT"];
			XMLCashRpt.csh_GCertRedeemNo =	arrayGroupTenders["TENDER_GIFT_CERT"];
			XMLCashRpt.csh_GCardRedeemNo =	arrayGroupTenders["TENDER_GIFT_CARD"];
			XMLCashRpt.csh_GCSoldNo =	arrGiftCardProdId.length;
			XMLCashRpt.csh_GCertSoldNo =	arrGiftCertProdId.length;
			if(nodeTenders != null) {
				var nodesTender = nodeTenders.Tender;
				var nodesTenderSize = nodesTender.length();
				
				for(var i = 0; i < nodesTenderSize; i++) {
					var resp=<csh_Tender/>;
					var nodeTender = nodesTender[i];	
				    var tcTenderId = getNumberAttribute(nodeTender, "id");
				    
					//verify if the tenders is not already in
					var allreadyIn = false;
					for(var j=0;j<i; j++)
					{
						if(nodesTender[j].@id == tcTenderId)
						{
							allreadyIn = true;
							break;
						}
					}
					
					if(allreadyIn ==false)
					{
						var tenderName = rootCash.TenderTable.TenderType.(@id==nodeTender.@id).@name;
						resp.csh_TenderName=tenderName.toString();
						resp.csh_TenderCategory = rootCash.TenderTable.TenderType.(@id==nodeTender.@id).@category.toString();
						resp.csh_TenderId=tcTenderId;
						resp.csh_TenderAmount=drawerAmountTenderIdArray[tcTenderId].toString(); //in foriegn if is the case
						resp.csh_TenderQty=Number(qtyTenderIdArray[tcTenderId]);
						//19.12.2008 oi more details
						resp.csh_TenderChange = changeDifferenceAmountTenderIdArray[tcTenderId].toString(); //in foriegn if is the case
						resp.csh_TenderExcess = excessAmountTenderIdArray[tcTenderId].toString();	//in foriegn currency if is the case
						XMLCashRpt.appendChild(resp);
					}
				}
	
			}
			
			
			//API.dbg("SOTEC: " + XMLCashRpt);
		}
	}
	
	
	//this function will get the translation index as defined in store-db or -1 if is not defined
	function getGiftIndex(productCode, giftCertificateTranslation)
	{
		//API.dbg("enter getGiftIndex "+productCode +", "+ giftCertificateTranslation);
		if(giftCertificateTranslation == "")
		{
			return -1;
		}
		var arrTransalations = giftCertificateTranslation.split(";");
		for(var i=0; i< arrTransalations.length; i++)
		{
			//API.dbg("enter for "+arrTransalations[i]);
			var arrItem = arrTransalations[i].split("|");
			//API.dbg("arrItem "+arrItem[0]+ " " +productCode + " " +arrItem[1]);
			if(arrItem[0]==productCode)
			{
				if(arrItem[1] != undefined)
				{
					return arrItem[1];
				}
				return -1; //something wrong with the parameter configuration in store-db
			}
		}
		return -1;
	}
	
	//This function will return the first available index for the gift certificate (index number that will be send to back office)
	function getAvailableGiftArrayIndex()
	{
		for(var i=1; i<20; i++)
		{
			if(arrGiftCertProdId[i] == undefined)
			{
				return i;
			}
		}
		return 20;
	}
	
	//This function will take the index  of a given gift certificate code from certSoldProduct array
	function getGiftCertPmixIndex(productCode)
	{
		for(var i=0; i< certSoldProduct.Product.length(); i++)  //first for mentioned in getAvailableGiftArrayIndex
		{
			var product = certSoldProduct.Product[i];
			if(Number(product.@id) == Number(productCode))
			{
				return i;
			}
		}
		return -1;
	}
	
	
	//This is a helper function that will order the gift certificate based on product code and based on the definitions available in store-db. (gift certificate that have a translation number in store-db)
	function orderGiftCertificate()
	{
		for(var i=0; i<giftCertCodes.length; i++) //order by product code
		{
			for(var j=i+1; j<giftCertCodes.length; j++) //order by product code
			{
				if(giftCertCodes[i] >giftCertCodes[j])
				{
					var temp = giftCertCodes[i];
					giftCertCodes[i] = giftCertCodes[j];
					giftCertCodes[j] =temp;
				}
			}
		}
		
		//the orders that have defined a translation in the store-db should be the first one in the list
		var lastChangeRow =0;
		for(var i=0; i<giftCertCodes.length; i++) //order by product code
		{
			var index = getGiftIndex(giftCertCodes[i], giftCertificateTranslation); //check to see if there is a product translation in store-db
			//API.dbg("index "+ index + " "+ i+ " lastChangeRow " +lastChangeRow );
			if(index != -1)  //we have an entry in the store-db parameter
			{
				if(lastChangeRow !=i) //we must make a change 
				{
					API.dbg("enter if last change");
					var temp = giftCertCodes[lastChangeRow];
					giftCertCodes[lastChangeRow] =giftCertCodes[i];
					giftCertCodes[i] = temp;
				}
				lastChangeRow++; //netx available position for a change
			}
		}
	}
	
	/** Get OperationKindId */
	function getOperationKindId(nodeCashStatistics,saleTypeName,typeId) 
	{ 
		var retunArray = Array(0,new BigDecimal("0.00"),new BigDecimal("0.00"),new BigDecimal("0.00"),new BigDecimal("0.00"),new BigDecimal("0.00"),new BigDecimal("0.00"));

		var nodesOperationKindAux;
		if(""==saleTypeName) {
			nodesOperationKindAux = nodeCashStatistics.SaleType.OperationKind; 
		}
		else {
			var cmd = "nodeCashStatistics.SaleType.(@name == \"" + saleTypeName + "\").OperationKind";
			nodesOperationKindAux = eval(cmd);
		}
		var cmd = "nodesOperationKindAux.(@id == \"" + typeId + "\")";
		var nodesOperationKind = eval(cmd);

		var nodesOperationKindSize = nodesOperationKind.length();
		for(var i = 0; i < nodesOperationKindSize; i++) {
			var nodeCashTotals = nodesOperationKind[i].CashTotals;
			if(nodeCashTotals != null) {
				var nodeCashAux = nodeCashTotals.Cash[0];
				if(nodeCashAux != null) {
					retunArray[0] += getNumberAttribute(nodeCashAux, "tc");
					retunArray[1]=retunArray[1].add(getBigDecimalAttribute(nodeCashAux, "netAmount"));
					retunArray[2]=retunArray[2].add(getBigDecimalAttribute(nodeCashAux, "netBeforeDiscount"));
					retunArray[3]=retunArray[3].add(getBigDecimalAttribute(nodeCashAux, "couponAmount"));
					retunArray[4]=retunArray[4].add(getBigDecimalAttribute(nodeCashAux, "taxAmount"));
					retunArray[5]=retunArray[5].add(getBigDecimalAttribute(nodeCashAux, "taxBeforeDiscount"));
					//OI 27.01.2010 add for 6.1.17
					retunArray[6] += getNumberAttribute(nodeCashAux, "couponTC");
				}
			}
		}
		return retunArray;
	}
			
	/** Get DayPartId */
	function getDayPartId(nodeCashStatistics,typeId) 
	{ 
		var retunArray = Array(0,new BigDecimal("0.00"),new BigDecimal("0.00"));	
		var nodesOperationKindAux = nodeCashStatistics.SaleType.DayPart; 
		var cmd = "nodesOperationKindAux.(@id == \"" + typeId + "\")";
		var nodesOperationKind = eval(cmd);
		var nodesOperationKindSize = nodesOperationKind.length();
		for(var i = 0; i < nodesOperationKindSize; i++) {
			var nodeCashTotals = nodesOperationKind[i].CashTotals;
			if(nodeCashTotals != null) {
				var nodeCashAux = nodeCashTotals.Cash[0];
				if(nodeCashAux != null) {
					retunArray[0] += getNumberAttribute(nodeCashAux, "tc");
					retunArray[1]=retunArray[1].add(getBigDecimalAttribute(nodeCashAux, "netAmount"));
					retunArray[2]=retunArray[1].add(getBigDecimalAttribute(nodeCashAux, "netBeforeDiscount"));
				}
			}
		}
		return retunArray;
	}
	
	/** Calculate total inital float on the given node */
	function calculateInitialFloat(nodeTenders) 
	{
		var total = new BigDecimal("0.00");
		if(nodeTenders != null) {
			for each (j in nodeTenders) {
				var nodesTender = j.Tender;
				for each (i in nodesTender) {
					//total += Number(i.@initialFloat);
					total = total.add(new BigDecimal(i.@initialFloat)); 
				}
			}
		}
		return (total);
	}
	
	/** Gets waste net amount */
	function getWasteNetAmount(nodeCashStatistics) 
	{
		var nodesOperationKind = nodeCashStatistics.OperationKind.(@id=="WASTE");
		var nodesOperationKindSize = nodesOperationKind.size;
		var total = new BigDecimal("0.00");
		for(var i = 0; i < nodesOperationKindSize; i++) {
			var nodeCashTotals = nodesOperationKind[i].CashTotals[0];
			if(nodeCashTotals != null) {
				var nodeCash = nodeCashTotals.Cash[0];
				if(nodeCash != null) {
					total=total.add(getBigDecimalAttribute(nodeCash, "netAmount"));
				}
			}
		}
		return total;
	}
	
	/** Gets the foreign drawer count */
	function getForeignCountAmt(nodeJapanData, foreignCurrency) 
	{
		var total = 0;
		var nodesCashCountForeign = nodeJapanData.CashCount.(@type=="FOREIGN")
		var nodesCashCountForeignSize = nodesCashCountForeign.length();
		for(var i = 0; i < nodesCashCountForeignSize; i++) {
			var nodeCashCount = nodesCashCountForeign[i];
			if(nodeCashCount.(@value) == foreignCurrency) {
				total += getNumberAttribute(nodeCashCount, "count")
			}
		}
		return total;
	}
	
	/** Calculates japan percentage by Some amount vs. Total Store Amount. */
	function calculatePercentage(amount, totalStoreAmount) 
	{
		API.dbg("procentaj "+ amount+ " " + totalStoreAmount);
		var r= new BigDecimal("0.00");
		if (Number(amount) == 0) {
			return(new BigDecimal("0.00"));
		}
		if (Number(totalStoreAmount) == 0) {
			return(new BigDecimal("0.00"));
		}
		r=amount.divide(totalStoreAmount,ROUND_MODE_PERCENT); //ROUND HALF DOWN 
		return(r.multiply(new BigDecimal("100.00")));
	}

	/** Gets the summ of day parts attributes */
	function getDayPartCashAttribute(nodeCashStatistics, dayPart, attributeName) 
	{
		var total = new BigDecimal("0.00");
		var nodesSaleType = nodeCashStatistics.SaleType;
		var nodesSaleTypeSize = nodesSaleType.length();
		for(var i = 0; i < nodesSaleTypeSize; i++) {
			var nodeSaleType = nodesSaleType[i];
			var nodeDayPartBF = nodeSaleType.DayPart.(@id==dayPart);
			if(nodeDayPartBF != null) {
				var nodeCash = nodeDayPartBF.Cash[0]; // Note that "Cash" is inside "CashTotals"
				total=total.add(getBigDecimalAttribute(nodeCash, attributeName));
			}
		}
		return total;
	}
	
	/** Gets the summ of given attribute values for given POD type */
	// productFlag is an optional parameter that indicates which kind of cash node we want
	// P - ProductSales, NP - NonProductSales and empty - cash node
	function getPodCashAttribute(startPoint, pod, attributeName, productFlag) 
	{
		var total = Number(0);
		if(startPoint != null) {
			if(0==startPoint.POS.length()) {
				var nodesPOS = startPoint;
			}
			else {
				var nodesPOS = startPoint.POS;
			}
			var nodesPOSsize = nodesPOS.length();
			for(var i = 0; i < nodesPOSsize; i++) {
				var nodePOS = nodesPOS[i].(@podShort==pod);
				if(nodePOS != null) {
					var nodeCashTotals;
					if("P"==productFlag) {
						nodeCashTotals = nodePOS.CashTotals.ProductSales;
					}
					else {
						if("NP"==productFlag) {
							nodeCashTotals = nodePOS.CashTotals.NonProductSales;
						}
						else {
							nodeCashTotals = nodePOS.CashTotals[0];
						}
					}
					var nodeCash = findFirst(nodeCashTotals, "Cash");
					total+=Number(getAttribute(nodeCash, attributeName));
				}
			}
		}
		return total;
	}

	/** Gets the summ of given attribute values for given POD type */
	// productFlag is an optional parameter that indicates which kind of cash node we want
	// P - ProductSales, NP - NonProductSales and empty - cash node
	function getBigDecPodCashAttribute(startPoint, pod, attributeName, productFlag) 
	{
		var total = new BigDecimal("0.00");
		if(startPoint != null) {
			if(0==startPoint.POS.length()) {
				var nodesPOS = startPoint;
			}
			else {
				var nodesPOS = startPoint.POS;
			}
			var nodesPOSsize = nodesPOS.length();
			for(var i = 0; i < nodesPOSsize; i++) {
				var nodePOS = nodesPOS[i].(@podShort==pod);
				if(nodePOS != null) {
					var nodeCashTotals;
					if("P"==productFlag) {
						nodeCashTotals = nodePOS.CashTotals.ProductSales;
					}
					else {
						if("NP"==productFlag) {
							nodeCashTotals = nodePOS.CashTotals.NonProductSales;
						}
						else {
							nodeCashTotals = nodePOS.CashTotals[0];
						}
					}
					var nodeCash = findFirst(nodeCashTotals, "Cash");
					total=total.add(getBigDecimalAttribute(nodeCash, attributeName));
				}
			}
		}
		return total;
	}

	
	/** Gets the petty-cash amount from a "CashDetails" node */
	function getPettyCashAmount(nodeCashDetails) 
	{
		var total = new BigDecimal("0.00");
		if(nodeCashDetails != null) {
			var nodeTransfersOut = nodeCashDetails.TransfersOut.(@type=="OTHER_PAYMENT");
			if(nodeTransfersOut != null) {
				var nodesTransferPettyCash = nodeTransfersOut.Transfer.(@destination=="PETTY_CASH");
				var size = nodesTransferPettyCash.length();
				for(var i = 0; i < size; i++) {
					total = total.add(new BigDecimal(nodesTransferPettyCash[i].(@amount)));
				}
			}
		}
		return total;
	}
	
	/** Gets the petty-cash count from a "CashDetails" node */
	function getPettyCashCount(nodeCashDetails) 
	{
		if(nodeCashDetails != null) {
			var nodeTransfersOut = nodeCashDetails.TransfersOut.(@type=="OTHER_PAYMENT");
			if(nodeTransfersOut != null) {
				var nodesTransferPettyCash = nodeTransfersOut.Transfer.(@destination=="PETTY_CASH");
				return nodesTransferPettyCash.length();
			}
		}
		return 0;
	}
	
	/** Calculates the gross amount of a "Cash" node */
	function getCashGrossAmount(nodeCash) 
	{
		if(nodeCash == null) {
			return 0;
		}
		var net = summNodesAttributeBigDecimalValues(nodeCash, "netAmount");
		var tax = summNodesAttributeBigDecimalValues(nodeCash, "taxAmount");
		net = net.add(tax);
		return net;
	}

	/**
	 * Gets the amount of McCards sold.
	 * @param startPoint product mix start point to look data (Can be the root, a POS, etc...)
	 * @param dayPart if not null, only the given day part will be included (LUNCH or BREAKFAST)
	 * @param saleType if not null, only the given sale type will be included (qtyEatIn or qtyTakeOut)
	 */
	function getmcCertSalesAmount(startPoint, dayPart, saleType) 
	{
		var total = new BigDecimal("0.00");
		if((startPoint == null) && (dayPart == null) && (saleType == null)){
			return total;
		}
		var nodeFamilyGroup = startPoint.FamilyGroup.(@groupName=="GIFT_COUPON");
		if(nodeFamilyGroup == null) {
			return total;
		}
		var nodesProduct = nodeFamilyGroup.Product;		

		var valueAmoutEatIn   = 0;
		var valueAmoutTakeOut = 0;
		var valueAmoutOther   = 0;
		for each (var i in nodesProduct) {
			var nodeOperationType = i.OperationType.(@operationType=="SALE");
			if(nodeOperationType != null) {
				if(dayPart == null) {
				    // All day parts
					var nodesPrice = nodeOperationType.Price;
				}else {
					// Just the given day part
					var nodesPrice = nodeOperationType.Price.(@dayPart==dayPart);
				}

				for each (var j in nodesPrice) {
					if(saleType == null) {
					// EatIn + TakeOut
						var qty = getPMixTotalQty(nodesPrice.PMix);
						nodePMix = nodesPrice.PMix;
						valueAmoutEatIn   += Number(nodePMix.@netAmtEatIn == null ? 0 : nodePMix.@netAmtEatIn);
						valueAmoutTakeOut += Number(nodePMix.@netAmtTakeOut == null ? 0 : nodePMix.@netAmtTakeOut);
						valueAmoutOther   += Number(nodePMix.@netAmtOther == null ? 0 : nodePMix.@netAmtOther);
					}else {
						// Just the given sale type
						var qty = getNumberAttribute(nodesPrice.PMix, saleType);
					}
					
					//total += (qty * getNumberAttribute(nodesPrice, "salePrice"));
					var aux = new BigDecimal("0.00");
					aux =getBigDecimalAttribute(nodesPrice, "salePrice");
					aux =aux.multiply(new BigDecimal(qty));
					total=total.add(aux);

				}
			}
		}
		return total;
	}
		
	/**
	 * Gets the amount of McCards redemeed
	 * @param startPoint CASH start point to look data (Can be the root, a POS, etc...)
	 */
	function getMcCardRedeemedAmount(startPoint) 
	{
		var total = new BigDecimal("0.00");
		if(startPoint == null) {
			return total;
		}
		var nodeTenders = startPoint.Tenders[0];
		if(nodeTenders == null) {
			return total;
		}
		var nodesTender = nodeTenders.getChildren();
		var nodesTenderSize = nodesTender.length();
		for(var i = 0; i < nodesTenderSize; i++) {
			var nodeTender = nodesTender[i];
			var tenderId = Number(nodeTender.@id);
			// 19: McCard 200
			// 20: McCard 500
			if(tenderId == MCCARD_1 || tenderId == MCCARD_2) {
				total=total.add(new BigDecimal(nodeTender.@drawerAmount));
			}
		}
		return total;
	}

	/**
	 * Gets the total tax amount of a "CashStatistics" node for the given operation type
	 */
	function getTotalTaxAmount(nodeCashStatistics, operationType) 
	{
		if(nodeCashStatistics == null) {
			return new BigDecimal("0.00");
		}
		var nodeSaleType = nodeCashStatistics.SaleType.(@name == operationType);
		if(nodeSaleType != null) {
			var nodeCashTotals = nodeSaleType.CashTotals[0];
			if(nodeCashTotals != null) {
				var nodeCash = nodeCashTotals.Cash[0];
				if(nodeCash != null) {
					return (new BigDecimal(nodeCash.@taxAmount));
				}
			}
		}
		return new BigDecimal("0.00");
	}

	/**
	 * Format tag brack for International Cash
	 */
	function FormatByTaxChain(rootTaxTable, tagName, nodeCashStatistics, saleTypeName, operationKindId, productFlag)
	{
		var nodesSaleType;
		var nodesOperationKind;
		var nodeBreakTaxes;

		if(""==saleTypeName) {
			nodesSaleType=nodeCashStatistics.SaleType;
		}
		else {
			var cmd = "nodeCashStatistics.SaleType.(@name == \"" + saleTypeName + "\")";
			nodesSaleType = eval(cmd);
		}
		if(""==operationKindId) {
			nodesOperationKind = nodesSaleType.OperationKind;
		}
		else {
			var cmd = "nodesSaleType.OperationKind.(@id == \"" + operationKindId + "\")";
			nodesOperationKind = eval(cmd);
		}

		var taxTable = rootTaxTable.TaxTable;
		var taxTableSize = taxTable.length();

		for(var iCount=0; iCount<taxTableSize; iCount ++) {
			var cmd;
			var evaluate;
			var iValue;
			var taxRateId = Number(taxTable[iCount].TaxRateId);
			var tagId = taxRateId;

			if("P"==productFlag) {
				nodeBreakTaxes = nodesOperationKind.CashTotals.ProductSales.Cash.Tax.(@id==taxRateId);
			}
			else {
				if("NP"==productFlag) {
					nodeBreakTaxes = nodesOperationKind.CashTotals.NonProductSales.Cash.Tax.(@id==taxRateId);
				}
				else {
					nodeBreakTaxes = nodesOperationKind.CashTotals.Cash.Tax.(@id==taxRateId);
				}
			}

			if(nodeBreakTaxes.length()>0) {
				//iValue = nodeBreakTaxes.@tc;
				iValue=0;
				for each (var nodeBT in nodeBreakTaxes) {
					iValue+=Number(nodeBT.@tc);
				}
			}
			else {
				iValue=0;
			}
			cmd = "XMLCashRpt." + tagName + tagId + ".Quantity="+Number(iValue);
			evaluate = eval(cmd);

			if(nodeBreakTaxes.length()>0) {
				//iValue = nodeBreakTaxes.@baseTaxAmount;
				iValue=new BigDecimal("0.00");
				for each (var nodeBT in nodeBreakTaxes) {
					iValue=iValue.add(new BigDecimal(nodeBT.@baseTaxAmount));
				}
			}
			else {
				iValue=new BigDecimal("0.00");
			}
			cmd = "XMLCashRpt." + tagName + tagId + ".Amount="+iValue;
			evaluate = eval(cmd);

			if(nodeBreakTaxes.length()>0) {
				//iValue = nodeBreakTaxes.@taxAmount;
				iValue=new BigDecimal("0.00");
				for each (var nodeBT in nodeBreakTaxes) {
					iValue=iValue.add(new BigDecimal(nodeBT.@taxAmount));
				}
			}
			else {
				iValue=new BigDecimal("0.00");
			}
			cmd = "XMLCashRpt." + tagName + tagId + ".Tax="+iValue;
			evaluate = eval(cmd);
		}
		return 0;
	}
}
	
	
	
//*****************************************************
//Cash Report
//*****************************************************

//**************report_isp.nps*************************
/**
 * PUBLIC
 * Implements the cash in drawers report.
 * Needed data types: CASH
 * @author myokomizo
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function reportCashInDrawer(config, data) 
{
	if(init(config, data, Array("CASH"), "CSDRW") != 0) {
		return getResponse();
	}	
	
	var lastPOS		= rootCash.POS;
	var indLastPOS	= lastPOS.length() - 1;
	var nodePOS		= lastPOS[0];
	var statusPOS	= getAttribute(nodePOS, "status");

	var currentOperator	= findCurrentOperator(rootCash);
	var operatorName	= getAttribute(currentOperator, "name");
	var totalExpected	= 0;

	// POS must be opened and an operator must be logged
	if( ( statusPOS != "OPLOGGED" ) || (currentOperator == null) ) {
		addLine("ERROR:There is not an Operator Logged");
		return getResponse();
	}
	addHeader(rootCash, "Cash In Drawer",RPTCASHINDRAWER);
	addOperation("Cashier Name",	operatorName,	false);
	addLine();
	
// 	Change requested in 23/03/2006		
//	totalExpected = addTendersSummary(rootCash, currentOperator);
//	totalExpected = totalExpected.subtract(addSkimsSummary(rootCash, currentOperator));
//	totalExpected = totalExpected.add(addInitialFloats(rootCash, currentOperator));
//	addtTotalExpectedCash(totalExpected);

	var initialFloat = Number(addInitialFloats(rootCash, currentOperator));		
	var totalCashTendered = Number(addTendersSummary(rootCash, currentOperator));	
	var totalSkims = Number(addSkimsSummary(rootCash, currentOperator));
	totalExpected  = initialFloat + totalCashTendered - totalSkims;

	addLine("-----------------         -------------");
	addLine("Initial Float              " + API.formatNumber(Number(initialFloat), "", 12));
	addLine("Cash Tendered       +      " + API.formatNumber(Number(totalCashTendered), "", 12));
	addLine("Skims               -      " + API.formatNumber(Number(totalSkims), "", 12));
	addLine("-----------------         -------------");	
	addLine("Expected Cash In Drawer    " + API.formatNumber(Number(totalExpected), "", 12));

	addFooter(rootCash);

	return getResponse();

	/** Adds an operation line */
	function addOperation(name, value, left) 
	{
		var line = API.setOnLeft(name, 18) + ": ";
		if(left) {
			line += API.setOnLeft(value, 19);
		}else {
			line += API.setOnRight(value, 19);
		}
		addLine(line);
	}
	/**
	 * Adds the tenders line separator
	 */
	function addTendersLine() 
	{
		addLine(API.replicate("-", 20) + " " + API.replicate("-", 5) + " " + API.replicate("-", 12));
	}
	/**
	 * Adds the total expected cash
	 * @param totalExpected total cash expected 
	 */
	function addtTotalExpectedCash(totalExpected) 
	{
		addInitialFloatsLine("=");
		addLineOperation("EXPECTED AMOUNT: ", null, totalExpected, "");
	}
	
	/**
	 * Adds the summary of tenders followed by the total of operations and its total amount
	 * @return total amount of tenders
	 */
	function addTendersSummary(rootCash, currentOperator) 
	{
		var tenderName;	
		var localAmount;
		var operations = 0;
		var nodesTenderSize = 0;
		var initialFloat = new BigDecimal("0.00");
		
		var nodeTenders		= findFirst(currentOperator, "Tenders");
		if(nodeTenders != null){
			var nodesTenders 	= nodeTenders[0].*;
			var nodesTenderSize = nodesTenders.length();
			var nodeTender 		= nodesTenders[0];
			operations 			= getNumberAttribute(nodeTender[0], "tc");
		}
		
		var nodeSkim		= findFirst(currentOperator, "TransfersOut");
		if(nodeSkim != null){
			var nodesSkim		= nodeSkim.Transfer;
			var nodesSkimSize	= nodesSkim.length();
		}
	
		var totalLocalAmount = new BigDecimal("0.00");
		var totalOperations  = new BigDecimal("0.00");
		var totalSkim 		 = new BigDecimal("0.00");
	
//		if( (nodesTenderSize > 0) && (operations > 0) ) { 
		if(nodesTenderSize > 0) {		
			totalSkim = getBigDecimalAttribute(nodeSkim, "amount");
	
//			addTendersLine();
//			addLine(API.setOnLeft("TENDERS", 20) + " " + API.setOnRight("OPERS", 5) + " " + API.setOnRight("LOCAL AMOUNT", 12));
//			addTendersLine();
	
			nodesTenderSize = 1; // Get only <TenderType id="0" name="US$" /> 
			for(var i = 0; i < nodesTenderSize; i++) {
				var nodeTender = nodesTenders[i];
				
				operations 		= getNumberAttribute(nodeTender, "tc");
				localAmount 	= getBigDecimalAttribute(nodeTender, "drawerAmount");
				initialFloat 	= getBigDecimalAttribute(nodeTender, "initialFloat");
				localAmount 	= localAmount.subtract(initialFloat);
				tenderId 		= getNumberAttribute(nodeTender, "id");
				// search the description of tender id
				tenderName 		= findTenderDescription(rootCash, tenderId);
				
				// assumes that all transfer out operations are maden in cash (TenderType 0) so skim amount is added only to cash amount
				if(tenderId=="0") {
					localAmount = localAmount.add(totalSkim);
				}
//				addLineOperation((i + 1) + " - " + tenderName, operations, localAmount,null);
	
				totalLocalAmount = totalLocalAmount.add(localAmount);
				totalOperations  = totalOperations.add(operations);
			}
//			addTendersLine();
//			addLineOperation("TOTAL:", totalOperations, totalLocalAmount, "");
//			addLine("");
		}
		return totalLocalAmount;
	}
	
	/**
	 * Adds the summary of skims followed by the total of operations and its total amount
	 * @return total amount of skims
	 */
	function addSkimsSummary(rootCash, currentOperator) 
	{
		var nodeCashDetails			= findFirst(currentOperator, "CashDetails");
		var nodesTransfersOut		= nodeCashDetails.TransfersOut;
		var nodesTransfersOutSize	= nodesTransfersOut.length();
		var totalTransfer			= new BigDecimal("0.00");
	
		if(nodesTransfersOutSize > 0) {
			for(var i = 0; i < nodesTransfersOutSize; i++) {
				var nodeTransferOut = nodesTransfersOut[i];
				var transferName 	= getAttribute(nodeTransferOut, "type");
				var transferAmount 	= getBigDecimalAttribute(nodeTransferOut, "amount");
				var transferQtty 	= getNumberAttribute(nodeTransferOut, "count");
				totalTransfer 		= totalTransfer.add(transferAmount);
	
//				addTendersLine();
//				addLine(API.setOnLeft(transferName, 20) + " " + API.setOnRight("OPERS", 5) + " " + API.setOnRight("LOCAL AMOUNT", 12));
//				addTendersLine();
	
				// assumes that all transfer out operations are maden in cash (TenderType 0)
				currencyName = findTenderDescription(rootCash, "0");
//				addLineOperation("1 - " + currencyName, transferQtty, transferAmount,null);
	
//				addTendersLine();
//				addLineOperation("TOTAL:", null, transferAmount, null);
//				addLine("");
			}
		}
		return totalTransfer;
	}

	/**
	 * Adds all initial floats
	 * @return total initial floats
	 */
	function addInitialFloats(rootCash, currentOperator) 
	{
		var nodeInitialFloat		= findFirst(currentOperator, "TransfersIn");
		var nodesInitialFloat		= nodeInitialFloat.Transfer;
		var nodesInitialFloatSize	= nodesInitialFloat.length();
	
		var tenderName;
	
		var totalLocalAmount= new BigDecimal("0.00");
		var localAmount 	= new BigDecimal("0.00");
		var initialFloat 	= new BigDecimal("0.00");
	
		if(nodesInitialFloatSize > 0) {
//			addTendersLine();
//			addLine(API.setOnLeft("INITIAL FLOATS", 26) + " " + API.setOnRight("LOCAL AMOUNT", 12));
//			addTendersLine();
	
			totalOperations  = getNumberAttribute(nodeInitialFloat, "count");
			totalLocalAmount = getBigDecimalAttribute(nodeInitialFloat, "amount");

			for(var i = 0; i < nodesInitialFloatSize; i++) {
				var nodeInitialFloat = nodesInitialFloat[i];
	
				localAmount = getBigDecimalAttribute(nodeInitialFloat, "amount");
				tenderId = getNumberAttribute(nodeInitialFloat, "tenderId");
				// search the description of tender id
				tenderName = findTenderDescription(rootCash, tenderId);
//				addLineOperation((i + 1) + " - " + tenderName, "1", localAmount,null);
			}
//			addTendersLine();
//			addLineOperation("TOTAL:", totalOperations, totalLocalAmount, "");
		}
		return totalLocalAmount;
	}

	/**
	 * Adds a given line type (initial float layout)
	 * @param type of line
	 */
	function addInitialFloatsLine(type) 
	{
		addLine(API.replicate(type, 26) + " " + API.replicate(type, 12));
	}
	/**
	 * Adds an operation line like this:
	 * "TOTAL ITEMS             114    6,145,756"
	 * @param name operation name ("TOTAL ITEMS")
	 * @param qty quantity ("114")
	 * @param value value ("6,145,756")
	 * @param numberFormat (optional) pass "" if you dont want to format the number, or any number format to use
	 */
	function addLineOperation(name, qty, value, numberFormat) 
	{
	
		if(!numberFormat) {
			numberFormat = "#,##0.00"; // Default value
		}
		if(numberFormat != "" && typeof(value) != "string" && value != null) {
			value = API.formatNumber(Number(value), numberFormat, 12);
		}else if(value == null) {
			value = "";
		}
		if(qty == null) { // Gives more space to 'name'
			// 26: name, 1: nothing, 12: value
			var line = API.setOnLeft(name, 26)
				+ " "
				+ API.setOnRight(value, 12);
		}else {
			// 20: name, 1: sep, 5: qtd, 1: nothing, 12: value
			var line = API.setOnLeft(name, 20)
			+ " "
			+ API.setOnRight(qty, 5)
			+ " "
			+ API.setOnRight(value, 12);
		}
		addLine(line);
	}
	
	/** Wraps XMLElement.findFirst() to ignore null nodes */
	function findTenderDescription(rootNode,tenderId) 
	{
	
		var cmd = "rootNode.TenderTable.TenderType.(@id == " + tenderId + ")";
		var value = eval(cmd);
		return value.@name;
	}
}
/* Finish function implements a generic CASH report */

/**
 * PUBLIC
 * Responsible for formating the PMix By Date report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportPMixByDate(config, data) 
{
	//By Date PMIX REPORT
	if(init(config, data, Array("CASH", "PMIX"), "PMXDT") != 0) {
		return getResponse();
	}		
	
	var root = rootPmix.POS;
    
	var posID = getPosId(); 
    if( (Country == "FR") && posID!= "N/A" && posID !=0) 	
	{
		genericPMixFR(config, data, root, RPTPMIXBYDATE);
	}
    else //other country the FR or FR request from waystation
    {
		genericPMix(config, data, root, RPTPMIXBYDATE);
	}

	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the PMix By Date StoreWide report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportPMixByDateSW(config, data) 
{
	//Consolidated PMIX REPORT
	if(init(config, data, Array("CASH", "PMIX"), "MXDSW") != 0) {
		return getResponse();
	}		

	var root = rootPmix;
	var posID = getPosId(); 
    if( (Country == "FR") && posID!= "N/A" && posID !=0) 	
	{
		genericPMixFR(config, data, root, RPTPMIXBYDATESW);
	}
    else //other country the FR or FR request from waystation
    {
		genericPMix(config, data, root, RPTPMIXBYDATESW);
	}
	
	
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the PMix By Period report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportPMixByPeriod(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "PMIX"), "MXPRD") != 0) {
		return getResponse();
	}	
	
	var root = rootPmix;
	var posID = getPosId(); 
    if( (Country == "FR") && posID!= "N/A" && posID !=0) 	
	{
		genericPMixFR(config, data, root, RPTPMIXBYPERIOD);
	}
    else //other country the FR or FR request from waystation
    {
		genericPMix(config, data, root, RPTPMIXBYPERIOD);
	}
	
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the PMix By Period StoreWide report.
 * Needed data types: CASH, PMIX
 * @author Celso
 */
function reportPMixByPeriodSW(config, data)
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "PMIX"), "MXPSW") != 0) {
		return getResponse();
	}

	var root = rootPmix;
	var posID = getPosId(); 
    if( (Country == "FR") && posID!= "N/A" && posID !=0) 	
	{
		genericPMixFR(config, data, root, RPTPMIXBYPERIODSW);
	}
    else //other country the FR or FR request from waystation
    {
		genericPMix(config, data, root, RPTPMIXBYPERIODSW);
	}
	return getResponse();
};


//**************end report_isp.nps**************************************

//*******************report.nps***************************************

function genericPMixFR(config, data, root, reportType)
{
	var pod = rootCash.@requestPod;
	//26.01.2009 OI change of group numbers.
	var arrFamilyGroups = new Array();
	arrFamilyGroups[0] = 0;	//BREAKFAST_ENTREE
	arrFamilyGroups[1] = 1;	//BREAKFAST_SIDE
	arrFamilyGroups[2] = 2;	//REGULAR_ENTREE
	arrFamilyGroups[3] = 3;	//FRIES
	arrFamilyGroups[4] = 4;	//DESSERT
	arrFamilyGroups[5] = 10; //SALADS  //BREAKFAST_MENU
	arrFamilyGroups[6] = 5;	//SHAKES
	arrFamilyGroups[7] = 6;	//BREAKFAST_DRINK
	arrFamilyGroups[8] = 7;	//REGULAR_DRINK
	arrFamilyGroups[9] = 8;	//NON_PRODUCT
	arrFamilyGroups[10] = 9;	//GIFT_COUPON
	arrFamilyGroups[11] = 11;	//REDEEMABLE_ITEMS
	
	
	var localFamilyArray = GetLocalFamily();
	var familyLength = localFamilyArray.length;
	
	/*
	localFamilyArray[0] ="BEST OF";
	localFamilyArray[1] ="SANDWICH";
	localFamilyArray[2] ="BO CRUDITES";	
	localFamilyArray[3] ="MAXI BO";
	localFamilyArray[4] ="NUGGETS";
	localFamilyArray[5] ="SAUCES NUGGETS";
	localFamilyArray[6] ="SALADES";
	localFamilyArray[7] ="SAUCES SALADES";
	localFamilyArray[8] ="HAPPY MEAL";
	localFamilyArray[9] ="FRITES";
	localFamilyArray[10] ="CONDIMENTS";
	localFamilyArray[11] ="POTATOES";
	localFamilyArray[12] ="BOISSONS CHAUDES";
	localFamilyArray[13] ="BOISSONS 25";
	localFamilyArray[14] ="BOISSONS 40";
	localFamilyArray[15] ="BOISSONS 50";
	localFamilyArray[16] ="BOISSONS 80";
	localFamilyArray[17] ="JUS ORANGE";
	localFamilyArray[18] ="BIERE";
	localFamilyArray[19] ="EAU MINERALE";
	localFamilyArray[20] ="SUNDAES";
	localFamilyArray[21] ="SHAKES";
	localFamilyArray[22] ="MC FLURRY";
	localFamilyArray[23] ="SNACKS";
	localFamilyArray[24] ="MC CAFE";
	localFamilyArray[25] ="PRODUITS MORNING";
	localFamilyArray[26] ="FORMULES MORNING";
	localFamilyArray[27] ="FORMULES MAXI MORNING";
	localFamilyArray[28] ="ANNIVERSAIRES";
	localFamilyArray[29] ="BO DUO";
	localFamilyArray[30] ="AUTRES";
	localFamilyArray[31] ="";
	*/
	
	var flagNet  = true; // flag to set if we have the net price or the gross price
	API.dbg("genericPMix Pmix: " + rootPmix);
	API.dbg("genericPMix Cash: " + rootCash);
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_PRODUCT_MIX"), reportType);

	//create xml with product family group information
	var xmlProduct = new XML("<productfamily/>");
		
	var hlp = new BusinessObjectHelper;
	for each (product in rootPmix.ProductTable.ProductInfo)
	{
		var arrProdCode = new Array();
		arrProdCode[0]= product.@id+"";

		//get the product information
		hlp.iterateProductDB(arrProdCode, product.@id+"");

		var resp = <product />;
		resp.@id= product.@id;
		if(productPMIXFamilyName !=null)
		{
			resp.@family = productPMIXFamilyName;
		}
		else
		{
			resp.@family = "";
		}
		xmlProduct.appendChild(resp);
	}
	API.dbg("localfamilygroup "+xmlProduct);
	//API.dbg("productname "+ rootPmix.ProductTable.ProductInfo.(@id == j.@id).@name);
				
     
	var managerTagCash = rootCash.CashStatistics.SaleType.OperationKind.(@id=="MANAGER").CashTotals.Cash;//.@tc
	var crewTagCash = rootCash.CashStatistics.SaleType.OperationKind.(@id=="CREW").CashTotals.Cash;//.@tc

	var managerCoupon = summNodesAttributeBigDecimalValues(managerTagCash,"couponAmount");
	//var crewCoupon = summNodesAttributeValues(managerTagCash,"crewAmount");
	//26.01.2009 OI crewAmount does not existand the tag was false
	var crewCoupon = summNodesAttributeBigDecimalValues(crewTagCash,"couponAmount");

	var qtdTCDiscard = rootCash.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");
	var qtdTCs = rootCash.CashTotals.Cash.@tc; 
	if(notCount100ValueMealGC == true)
	{
		 qtdTCs =  qtdTCs -	 summNodesAttributeValues(qtdTCDiscard,"tc"); 
	}
	//addLine("No. OF TCs:        " + qtdTCs);	
	addLine();                             
	//addLine("NAME    SOLD AMOUNT  TTL% PROM WST USED");  
	
	
	var headerLine =API.setOnLeft(API.getLocalMsg("MSG_PMIX_PRODUCT_NAME"),10)
		+ API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_QTY"), 4)	
		+ API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_CREW"), 4)			
		+ API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_PROMO"), 4)
		//+ API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_WASTE"), 4)
		+ " "	
		+ API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_TOTSALES"),9)
		+ " "	
		+ API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_TR"),6);
		//+ API.setOnRight(API.getLocalMsg("MSG_RECEIPT_PRODUCT_USED"), 5);
	
	addLine(headerLine);  
	addLine();               
	API.dbg("pmix "+ root);
	API.dbg("pmix product "+rootProducts);
	var rootProducts = root.FamilyGroup.(@groupName!="NON_PRODUCT" && @groupName != "GIFT_COUPON");
	var rootNonProducts = root.FamilyGroup.(@groupName=="NON_PRODUCT");
	var sumProducts = getTotalSum(rootProducts) + getTotalSum(rootNonProducts);	
	var sumProductsQty = getTotalQty(rootProducts) + getTotalQty(rootNonProducts);	
    API.dbg("pmix product "+rootProducts);
	API.dbg("pmix sumProductsQty "+ sumProductsQty + " products "+ getTotalQty(rootProducts) +"nonproducts " + getTotalQty(rootNonProducts) );
	// get information of the Products
	var valueMgrMealDct  = 0;
	var valueEmpMealDct  = 0;
	var valueOtherDct    = 0;
	var sumProductsSold  = 0;
	var sumProductsAmount= 0;
	var sumProductsTtl   = 0;
	var sumProductsProm  = 0; 
	var sumProductsWst   = 0; 
	var sumProductsUsed  = 0; 
	
	addLine(center(API.getLocalMsg("MSG_RECEIPT_PRODUCTS")));
	
	//product alimentaire
		// get information of the Non Products
	var sumProductsSold  = 0;
	var sumProductsAmount= 0;
	var sumProductsTtl   = 0;
	var sumProductsProm  = 0; 
	var sumProductsWst   = 0; 
	var sumProductsUsed  = 0; 
	var sumProductsCrew  = 0;
	
	lineRpt_array = new Array();
	for (var familyID=0; familyID <= familyLength; familyID++)
	{
		var totsold  = 0;
		var totamount= 0;
		var totttl   = 0;
		var totprom  = 0; 
		var totcrew  = 0;
		var totwst   = 0; 
		var totused  = 0; 
		var valueMgrNetAmt = 0;
		var valueEmpNetAmt = 0;
		var boolFound = false;  //true if we have at least one product from the selected local family group
		for each (i in rootProducts)  //family entery  eg BREAKFAST this will have all produts that belogs to this entery
		{
		   var nodeProduct = i.Product;
		   for each (j in nodeProduct) //the actual products
		   { 
		     	//API.dbg("productname "+ rootPmix.ProductTable.ProductInfo.(@id == j.@id).@name);
				var condition =false;
				if(familyID < familyLength)
					condition=localFamilyArray[familyID].name == (xmlProduct.product.(@id==j.@id).@family).toUpperCase();
				else //this is for products that don't have a valid family  we display them at the end
				{
					condition = (xmlProduct.product.(@id==j.@id).@family.toUpperCase().substring(0,5)!="GROUP")
				}	
			    if(condition)
				{
						//API.dbg(productPMIXFamilyName);
						boolFound = true;
						var name = rootPmix.ProductTable.ProductInfo.(@id == j.@id).@name;
						var eatinPrice   = j.@eatinPrice;
						var takeoutPrice = j.@takeoutPrice;
						var otherPrice   = j.Product.@otherPrice;
						var rootOperationType = j.OperationType;
						var qtdsold = 0;
						var qtdwst  = 0;
						var qtdprom = 0;
						var amount  = 0;
						var valuePrice = 0;
						var qtdInOut = 0;
						var qtdCrewMeal =0;
						var qtdrefund = 0;
					    for each (k in rootOperationType)
					    {

//				    var aux = Number(k.PMix.@qtyEatIn * eatinPrice) + Number(k.PMix.@qtyTakeOut * takeoutPrice) + Number(k.PMix.@qtyOther * otherPrice);
							var aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
							aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOut : k.PMix.@netBeforeDiscountTakeOut);	
							aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);
							if(flagNet == false)
							{							
							//MS we need gross price
								if(String(k.PMix.@netBeforeDiscountEatIn)!="" || String(k.PMix.@netBeforeDiscountTakeOut)!="" || String(k.PMix.@netBeforeDiscountOther)!="")
								{ //in case we have a discount the taxBeforeDiscount differs then the normalTax
									aux += Number(k.PMix.@taxBeforeDiscountTakeOut);
									aux += Number(k.PMix.@taxBeforeDiscountEatIn);
									aux += Number(k.PMix.@taxBeforeDiscountOther);
								}
								else
								{
									aux += Number(k.PMix.@taxTakeOut);
									aux += Number(k.PMix.@taxEatIn);
									aux += Number(k.PMix.@taxOther);
								}
							}
							
							if(k.@operationType == "REFUND"){
								amount  -= aux;
								qtdrefund += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							else{
								amount   += aux;
								//qtdInOut += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							
							if(k.@operationType == "DISCOUNT"){
								valueOtherDct += Number(k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
												 Number(k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
												 Number(k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);
								if(flagNet == false)
								{								
												 //02.02.2009 MS we need the tyx for gross values
									valueOtherDct += Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
												 Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
												 Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther);
								}
							}
							if(k.@operationType == "SALE") {
								if((k.PMix.@netBeforeDiscountEatIn != "") || (k.PMix.@netBeforeDiscountTakeOut != "") || (k.PMix.@netBeforeDiscountOther != "")) {
									valueOtherDct += Number(k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
													 Number(k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
													 Number(k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);
									if(flagNet == false)
									{	
													  //02.02.2009 MS we need the tyx for gross values
										valueOtherDct += Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
													 Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
													 Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther);
									}
								}
							}
							
							if(k.@operationType == "MANAGER"){
								valueMgrNetAmt =  Number(k.PMix.@netAmtEatIn + k.PMix.@netAmtTakeOut +  k.PMix.@netAmtOther);
								if(flagNet == false)
								{	
									//02.02.2009 MS we need the tyx for gross values
									valueMgrNetAmt += Number(k.PMix.@taxEatIn + k.PMix.@taxTakeOut +  k.PMix.@taxOther) ;
								}
								amount -=aux; //for manager and crew we do not count the amount 
								valueMgrMealDct += Number((k.PMix.@netBeforeDiscountEatIn + k.PMix.@netBeforeDiscountTakeOut + k.PMix.@netBeforeDiscountOther) - valueMgrNetAmt);
								if(flagNet == false)
								{	
												 //02.02.2009 MS we need the tyx for gross values
									valueMgrMealDct +=	 Number(k.PMix.@taxBeforeDiscountEatIn) +
													Number(k.PMix.@taxBeforeDiscountTakeOut) +
													Number(k.PMix.@taxBeforeDiscountOther);	
								}
								qtdCrewMeal += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
								
								//qtdsold = qtdInOut;
							}
							if(k.@operationType == "CREW"){
								valueEmpNetAmt = Number(k.PMix.@netAmtEatIn + k.PMix.@netAmtTakeOut + k.PMix.@netAmtOther);
								if(flagNet == false)
								{
												 //02.02.2009 MS we need the tyx for gross values
									valueEmpNetAmt += Number(k.PMix.@taxEatIn + k.PMix.@taxTakeOut + k.PMix.@taxOther);
								}
								valueEmpMealDct += Number((k.PMix.@netBeforeDiscountEatIn + k.PMix.@netBeforeDiscountTakeOut+ k.PMix.@netBeforeDiscountOther) - valueEmpNetAmt);
								if(flagNet == false)
								{
													 //02.02.2009 MS we need the tyx for gross values
									valueEmpMealDct += Number(k.PMix.@taxBeforeDiscountEatIn) +
													 Number(k.PMix.@taxBeforeDiscountTakeOut) +
													 Number(k.PMix.@taxBeforeDiscountOther);	
								}
								qtdCrewMeal += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
								amount -=aux; //for manager and crew we do not count the amount 
								//qtdsold = qtdInOut;
							}
							
							if(k.@operationType == "PROMO"){
								 amount   -= aux;
								 qtdprom += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							if(k.@operationType == "WASTE"){
								 amount   -= aux;
								 qtdwst  += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							if((k.@operationType == "SALE") || (k.@operationType == "DISCOUNT")){
								 qtdsold += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
						} //end operation type
						
						qtdsold -= qtdrefund;
						var ttl =  Math.abs(calculatePercentage(qtdsold,sumProductsQty));
						var used = qtdsold + qtdwst + qtdprom;
						
						addLineArray(lineRpt_array, name, qtdsold, qtdCrewMeal, qtdprom, qtdwst, amount, used); 
						//addOperationLine(false, name, qtdsold, qtdCrewMeal, qtdprom, amount, API.setOnRight(API.formatNumber(Number(ttl), "##0.0", 5), 5),  used);
						totsold   += Number(qtdsold);
						totamount += amount;
						totprom   += qtdprom;
						totcrew += qtdCrewMeal;
						totwst    += qtdwst;
						totused   += Number(used);
				}
		   }
		}
        //set the  total for the current local family
		if ( boolFound == true)
		{
		    printLine(totsold);
			lineRpt_array = new Array(); //reset the array;
			var valueTtl =  Math.abs(calculatePercentage(totsold, sumProductsQty));
			if(familyID == familyLength) //for products that do not have a valid family we have no description
			{
				description = "NONE";
			}
			else
			{
				description = localFamilyArray[familyID].description;
			}
			addOperationLine(true, description, totsold, totcrew, totprom, totwst, totamount, API.setOnRight(API.formatNumber(Number(valueTtl), "##0.00", 6), 7), totused);
			addLine();
			
			//total for products
			sumProductsSold  += totsold;
			sumProductsAmount+= totamount;
			sumProductsTtl   += totttl;
			sumProductsProm  += totprom; 
			sumProductsCrew  += totcrew;
			sumProductsWst   += totwst; 
			sumProductsUsed  += totused; 
		}
		
		
	}
	
	// get information of the Non Products
	var sumNonProductsSold  = 0;
	var sumNonProductsAmount= 0;
	var sumNonProductsTtl   = 0;
	var sumNonProductsProm  = 0; 
	var sumNonProductsWst   = 0; 
	var sumNonProductsUsed  = 0; 
	var sumNonProductsCrew 	= 0;
	
	addLine(center(API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS")));
	//26.01.2009 OI change the index because we have only one group for non products.
	
	if(rootNonProducts.length()){
				var nodeProduct = rootNonProducts.Product;
				var totsold  = 0;
				var totamount= 0;
				var totttl   = 0;
				var totprom  = 0; 
				var totcrew = 0;
				var totwst   = 0; 
				var totused  = 0; 
				for each (j in nodeProduct) { //just nonproducts 
					var name = rootPmix.ProductTable.ProductInfo.(@id == j.@id).@name;
					var eatinPrice   = j.@eatinPrice;
					var takeoutPrice = j.@takeoutPrice;
					var otherPrice   = j.Product.@otherPrice;
					var rootOperationType = j.OperationType;
					var qtdsold = 0;
					var qtdwst  = 0;
					var qtdprom = 0;
					var qtdCrewMeal =0;
					var amount  = 0;
					var valuePrice = 0;
					var qtdInOut = 0;			
					
					for each (k in rootOperationType) {

	//					var	aux = Number(k.PMix.@qtyEatIn * eatinPrice) + Number(k.PMix.@qtyTakeOut * takeoutPrice) + Number(k.PMix.@qtyOther * otherPrice);				
						var aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
							aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOut : k.PMix.@netBeforeDiscountTakeOut);					
							aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);					
							//02.02.2009 MS we need the gross amount
							if(flagNet ==  false)
							{
								if(String(k.PMix.@netBeforeDiscountEatIn)!="" || String(k.PMix.@netBeforeDiscountTakeOut)!="" || String(k.PMix.@netBeforeDiscountOther)!="")
								{
									aux += Number(k.PMix.@taxBeforeDiscountTakeOut);
									aux += Number(k.PMix.@taxBeforeDiscountEatIn);
									aux += Number(k.PMix.@taxBeforeDiscountOther);
								}
								else
								{
									aux += Number(k.PMix.@taxTakeOut);
									aux += Number(k.PMix.@taxEatIn);
									aux += Number(k.PMix.@taxOther);
								}
							}
					
						if(k.@operationType == "REFUND"){
							amount  -= aux;
							qtdsold -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
						}
						else{
							amount   += aux;
							qtdInOut = Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
						}
						if(k.@operationType == "DISCOUNT"){
							valueOtherDct += (k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
											 (k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
											 (k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);
							if(flagNet ==  false)
							{				 
										 //02.02.2009 MS we need the tyx for gross values
								valueOtherDct += Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
										 Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
										 Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther) ;		
							 }					 	
							
						}
						if(k.@operationType == "MANAGER"){
							valueMgrMealDct += (k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
											   (k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
											   (k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther)+
											   //02.02.2009 MS we need the tyx for gross values
											   Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
											   Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
											   Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther);
							qtdCrewMeal +=	Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);			   
							//qtdsold = qtdInOut;
						}
						if(k.@operationType == "CREW"){
							valueEmpMealDct += (k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
											   (k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
											   (k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);
							if(flagNet ==  false)
							{					   
											   //02.02.2009 MS we need the tyx for gross values
								valueEmpMealDct +=  Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
											   Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
											   Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther);
							}
							qtdCrewMeal +=	Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);						   
							//qtdsold = qtdInOut;
						}
						if(k.@operationType == "PROMO"){
							 amount   -= aux;
							 qtdprom += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
						}
						if(k.@operationType == "WASTE"){
							 amount   -= aux;
							 qtdwst  += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
						}
						if((k.@operationType == "SALE") || (k.@operationType == "DISCOUNT")){
							 qtdsold += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
						}
					}
					
					var ttl =  Math.abs(calculatePercentage(qtdsold,sumProductsQty));
					var used = qtdsold + qtdwst + qtdprom;
					addLineArray(lineRpt_array, name, qtdsold, qtdCrewMeal, qtdprom, qtdwst, amount, used); 
					//addOperationLine(false, name, qtdsold, qtdCrewMeal, qtdprom, amount, API.setOnRight(API.formatNumber(Number(ttl), "##0.0", 5), 5), used);
					totsold   += Number(qtdsold);
					totamount += amount;
					totprom   += qtdprom;
					totcrew   += qtdCrewMeal;
					totwst    += qtdwst;
					totused   += Number(used);
					totttl 	  += ttl;
				}
				printLine(totsold);
				lineRpt_array = new Array();				
				sumNonProductsSold  += totsold;
				sumNonProductsAmount+= totamount;
				sumNonProductsTtl   += totttl;
				sumNonProductsProm  += totprom; 
				sumNonProductsCrew  += totcrew;
				sumNonProductsWst   += totwst; 
				sumNonProductsUsed  += totused; 
			
			
			var name = API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS");
			addOperationLine(true, name, sumNonProductsSold, sumNonProductsCrew, sumNonProductsProm, sumNonProductsWst, sumNonProductsAmount, API.setOnRight(API.formatNumber(Number(sumNonProductsTtl), "##0.00", 6), 7), sumNonProductsUsed);
			addLine();
		}
		if(Number(sumNonProductsUsed) == 0)
		{
			var name = API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS");
			addOperationLine(true, name, 0, 0, 0, 0, 0, API.setOnRight(0, 5), 0);
			addLine();
		}
	
	
	// Calculate Summary information
	addLine(center(API.getLocalMsg("MSG_RECEIPT_SUMMARY")));
	
	var totSumSold  = sumNonProductsSold+sumProductsSold;
	var totSumAmount= sumNonProductsAmount+sumProductsAmount;
	var totSumTtl   = sumNonProductsTtl+sumProductsTtl;
	var totSumProm  = sumNonProductsProm+sumProductsProm; 
	var totSumWst   = sumNonProductsWst+sumProductsWst; 
	var totSumUsed  = sumNonProductsUsed+sumProductsUsed; 
	var totSumCrew  = sumNonProductsCrew+sumProductsCrew;
	
	var value = Math.abs(calculatePercentage(sumProductsSold,sumProductsQty));
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_T_PROD"), sumProductsSold, sumProductsCrew, sumProductsProm, sumProductsWst,sumProductsAmount, API.setOnRight(API.formatNumber(Number(value), "##0.00", 6), 7), sumProductsUsed);
	value = Math.abs(calculatePercentage(sumNonProductsSold,sumProductsQty));
	addOperationLine(false, API.getLocalMsg("MSG_RECEIPT_T_NPRD"), sumNonProductsSold, sumNonProductsCrew, sumNonProductsProm, sumNonProductsWst, sumNonProductsAmount, API.setOnRight(API.formatNumber(Number(value), "##0.00", 6), 7), sumNonProductsUsed);
	
	//total
	value = Math.abs(calculatePercentage(sumProductsQty, sumProductsQty));
	addOperationLine(true, API.getLocalMsg("MSG_RECEIPT_T_SUM"), totSumSold, totSumCrew, totSumProm, totSumWst, totSumAmount, API.setOnRight(API.formatNumber(Number(value), "##0.00", 6), 7), totSumUsed);
	
	/*
	addLine(SEP_SL);
	addLine("-Mgr Meal Dct           :" + " " + API.setOnRight(API.formatNumber(Number(valueMgrMealDct)-managerCoupon, "####0.00", 9), 9));
	addLine("-Emp Meal Dct           :" + " " + API.setOnRight(API.formatNumber(Number(valueEmpMealDct)-crewCoupon, "####0.00", 9), 9));
	addLine("-Other Dct              :" + " " + API.setOnRight(API.formatNumber(Number(valueOtherDct)+managerCoupon+crewCoupon, "####0.00", 9), 9));	
	addLine(SEP_SL);
	var totWithDisc = totSumAmount - (valueMgrMealDct + valueEmpMealDct + valueOtherDct);
	
	addLine("Total Less Discounts    :" + " " + API.setOnRight(API.formatNumber(Number(totWithDisc), "####0.00", 9), 9));		

	addLine();
	*/
	addFooter(rootCash);
	
	return;
	//is used to print all the product for a family.
	function printLine(totalqty)
	{
		for(var i=0 ;i<Number(lineRpt_array.length);i++)
		{
		    //name, qtySold, qtdCrewMeal, qtdprom, qtdwst, amount, used)  
		    var information = new Array();
			information = lineRpt_array[i].text.split(",");
			if(Number(information[1]) >0 || Number(information[2]) >0 || Number(information[3]) >0 )
			{
			//calculate the %
			addOperationLine(false, information[0], information[1], information[2], information[3], information[4], information[5], API.setOnRight(API.formatNumber(calculatePercentage(information[1], totalqty), "##0.00", 6), 7), information[6]);
			}
		}
	
	}
	
	function addLineArray(lineRpt_array, name, qtySold, qtdCrewMeal, qtdprom, qtdwst, amount, used) 
	{
	   var line = name +","+qtySold+","+qtdCrewMeal+","+qtdprom+","+qtdwst+","+amount+","+used;
       lineRpt_array.push({text:String(line)});
	}
	
	
	/** Calculates japan percentage by Some amount vs. Total Store Amount. */
	function calculatePercentage(amount, totalStoreAmount) 
	{
		return amount > 0 ? (amount / totalStoreAmount * 100) : 0;
	}
	
	/** Calculates Total Store Amount. */
	function getTotalSum(rootProducts)
	{
	var sumProductsAmount= 0;
	
	if(rootProducts.length()){
		for each (i in rootProducts) {
			var nodeProduct = i.Product;
			var totamount= 0;
			for each (j in nodeProduct) {
				var eatinPrice   = j.@eatinPrice;
				var takeoutPrice = j.@takeoutPrice;
				var otherPrice   = j.@otherPrice;
				var rootOperationType = j.OperationType;
				var amount = 0;
				for each (k in rootOperationType) {

//					var aux = Number(k.PMix.@qtyEatIn * eatinPrice) + Number(k.PMix.@qtyTakeOut * takeoutPrice) + Number(k.PMix.@qtyOther * otherPrice);
					var aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
					    aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOut : k.PMix.@netBeforeDiscountTakeOut);					
						aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);					
					if(flagNet ==false)
					{
						//MS we need gross price
						if(String(k.PMix.@netBeforeDiscountEatIn)!="" || String(k.PMix.@netBeforeDiscountTakeOut)!="" || String(k.PMix.@netBeforeDiscountOther)!="")
						{ //in case we have a discount the taxBeforeDiscount differs then the normalTax
							aux += Number(k.PMix.@taxBeforeDiscountTakeOut);
							aux += Number(k.PMix.@taxBeforeDiscountEatIn);
							aux += Number(k.PMix.@taxBeforeDiscountOther);
						}
						else
						{
							aux += Number(k.PMix.@taxTakeOut);
							aux += Number(k.PMix.@taxEatIn);
							aux += Number(k.PMix.@taxOther);
						}
					}
				
					if(k.@operationType == "REFUND"){
						amount  -= aux;
					}
					else{
						amount   += aux;
					}
					
					if(k.@operationType == "PROMO" || k.@operationType == "MANAGER" || k.@operationType == "CREW" || k.@operationType == "WASTE"){
						amount   -= aux;
					}
				}
				totamount += amount;
			}
			sumProductsAmount+= totamount;
		}
	}
	
	return sumProductsAmount;
	}
	
	/**Calculate the total qty*/
	function getTotalQty(rootProducts)
	{
	var sumProductsQtyF= 0;
	
	if(rootProducts.length()){
		for each (i in rootProducts) {
			var nodeProduct = i.Product;
			var totqty= 0;
			for each (j in nodeProduct) {
				API.dbg("getTotalQty prod id "+ j.@id + " "+ j.OperationType.PMix.@qtyEatIn);
				var eatinPrice   = j.@eatinPrice;
				var takeoutPrice = j.@takeoutPrice;
				var otherPrice   = j.@otherPrice;
				var rootOperationType = j.OperationType;
				var qty = 0;
				for each (k in rootOperationType) {
					
					if(k.@operationType == "SALE" || k.@operationType == "DISCOUNT")
					{
							 qty += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
					}
					if(k.@operationType == "REFUND")
					{
						qty -=Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
					}
				
				}
				API.dbg("getTotalQty prod qty "+ qty);
				totqty += qty;
				
			}
			API.dbg("getTotalQty prod totqty "+ totqty);
			sumProductsQtyF+= totqty;
			API.dbg("getTotalQty prod sumProductsQtyF "+ sumProductsQtyF);
		}
	}
	
	return sumProductsQtyF;
	}
	
	/**
	 * Adds an operation line like this:
	 * "HPY HM     1    1.18   1.9    0   0    1"
	 * @param name operation name ("TOTAL ITEMS")
	 * @param sold
	 * @param amount
	 * @param ttl
	 * @param prom
	 * @param wst	 	 
	 * @param used	 	 	 
	 */
	function addOperationLine(bold, name, sold, crew, prom, wst, amount, ttl, used) 
	{
		var value=0;
		
		if (Number(amount)<=999.99) {
			value= API.setOnRight(API.formatNumber(Number(amount), "##0.00", 6), 6);
		}
		else {
			if (Number(amount)<=9999.99) {
				value= API.setOnRight(API.formatNumber(Number(amount), "###0.00", 7), 7);
			}
			else {
				value= API.setOnRight(API.formatNumber(Number(amount), "####0.00", 6), 7);
			}
		}	
			
	
		// 7: name, 3: sep, 3: sold, 6: amount, 12: value
		var line = API.setOnLeft(String(name).substring(0, 8),10)
		+ API.setOnRight(sold, 4)	
		+ API.setOnRight(crew, 4)			
		+ API.setOnRight(prom, 4)
		//+ API.setOnRight(wst, 4)
		+ " "	
		+ API.setOnRight(value,8)
		+ " "	
		+ API.setOnLeft(ttl,8);
		//+ API.setOnRight(used, 4);

		if(bold ==true)
		{
			addBoldLine(line);
		}
		else
		{
			addLine(line);
		}
	}
	
	
}




/**
 * PRIVATE
 * This function implements a generic PMix report
 * Needed data types: CASH, PMIX
 * @author Celso
 */
function genericPMix(config, data, root, reportType)
{
   //set the net Fllag
   var flagNet;
   if(Country =="DE" || Country == "UK" || Country =="IE" || Country == "PT")
   {
		flagNet = true;
   }
   else
   {
		flagNet = false;
   }
   
	//MS 20.04.2011  PMIX have a different behavior in case of use of FVM. No discount information will be available
	//NOTE: germany is not using manager and crew value meal, the correction in case of FVM for this kind of transaction was not made!!!!!!!!
	storedbPath = "Configurations.Configuration.(@type==\"POS\").Section.(@name==\"Cash\").Parameter.(@name==\"FVM\").@value"; 
	var isFVMActive = getConfigValue(storedbPath , "") == "true";
	
	var pod = rootCash.@requestPod;
	//26.01.2009 OI change of group numbers.
	var arrFamilyGroups = new Array();
	/*
	if(Country == "UK" || Country =="IE")
	{
		arrFamilyGroups[0] = 0;	//BREAKFAST_ENTREE
		arrFamilyGroups[1] = 1;	//BREAKFAST_SIDE
		arrFamilyGroups[2] = 2;	//REGULAR_ENTREE
		arrFamilyGroups[3] = 3;	//FRIES
		arrFamilyGroups[4] = 4;	//DESSERT
		arrFamilyGroups[5] = 5;	//SALADS
		arrFamilyGroups[6] = 6;	//SHAKES
		arrFamilyGroups[7] = 7;	//BREAKFAST_DRINK
		arrFamilyGroups[8] = 8;	//REGULAR_DRINK
		arrFamilyGroups[9] = 9;	//NON_PRODUCT
		arrFamilyGroups[10] = 10;	//GIFT_COUPON
		arrFamilyGroups[11] = 11;	//REDEEMABLE_ITEMS
	}
	*/
	//else
	//{
		arrFamilyGroups[0] = 0;	//BREAKFAST_ENTREE
		arrFamilyGroups[1] = 1;	//BREAKFAST_SIDE
		arrFamilyGroups[2] = 2;	//REGULAR_ENTREE
		arrFamilyGroups[3] = 3;	//FRIES
		arrFamilyGroups[4] = 4;	//DESSERT
		arrFamilyGroups[5] = 10;	//SALADS  //BREAKFAST_MENU
		arrFamilyGroups[6] = 5;	//SHAKES
		arrFamilyGroups[7] = 6;	//BREAKFAST_DRINK
		arrFamilyGroups[8] = 7;	//REGULAR_DRINK
		arrFamilyGroups[9] = 8;	//NON_PRODUCT
		arrFamilyGroups[10] = 9;	//GIFT_COUPON
		arrFamilyGroups[11] = 11;	//REDEEMABLE_ITEMS
	//}
	API.dbg("genericPMix Pmix: " + root);
	API.dbg("genericPMix Cash: " + rootCash);
	
	addHeader(rootCash, API.getLocalMsg("MSG_RECEIPT_PRODUCT_MIX"), reportType);

	var managerTagCash = rootCash.CashStatistics.SaleType.OperationKind.(@id=="MANAGER").CashTotals.Cash;//.@tc
	var crewTagCash = rootCash.CashStatistics.SaleType.OperationKind.(@id=="CREW").CashTotals.Cash;//.@tc

	var managerCoupon = summNodesAttributeBigDecimalValues(managerTagCash,"couponAmount");
	//var crewCoupon = summNodesAttributeValues(managerTagCash,"crewAmount");
	var crewCoupon
	if(Country == "UK" || Country =="IE")
	{  
	  crewCoupon = summNodesAttributeBigDecimalValues(managerTagCash,"crewAmount");
	}
	else
	{	
		//26.01.2009 OI crewAmount does not existand the tag was false
		var crewCoupon = summNodesAttributeBigDecimalValues(crewTagCash,"couponAmount");
    }
	
	var qtdTCDiscard = rootCash.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash.(@netAmount=="0.00");
	var qtdTCs = rootCash.CashTotals.Cash.@tc;
	if(notCount100ValueMealGC == true)
	{
		qtdTCs = qtdTCs - summNodesAttributeValues(qtdTCDiscard,"tc");
	}
	
	

	addLine("No. OF TCs:        " + qtdTCs);	
	addLine();                             
	//addLine("NAME    SOLD AMOUNT  TTL% PROM WST USED");  
	addLine(API.getLocalMsg("MSG_RECEIPT_PRODUCT_MIX_HEADER"));  
	addLine();               
	
	var rootProducts = root.FamilyGroup.(@groupName!="NON_PRODUCT" && @groupName != "GIFT_COUPON");
	var rootNonProducts = root.FamilyGroup.(@groupName=="NON_PRODUCT");
	var sumProducts = getTotalSum(rootProducts) + getTotalSum(rootNonProducts);	
	//API.DbgMessageBox(sumProductsQty);
	// get information of the Products
	var valueMgrMealDct  = 0;
	var valueEmpMealDct  = 0;
	var valueOtherDct    = 0;
	var sumProductsSold  = 0;
	var sumProductsAmount= 0;
	var sumProductsTtl   = 0;
	var sumProductsProm  = 0; 
	var sumProductsWst   = 0; 
	var sumProductsUsed  = 0; 
	
	addLine(center(API.getLocalMsg("MSG_RECEIPT_PRODUCTS")));
	if(rootProducts.length() != 0)
	{
		for (var ig=0 ; ig<9; ig++)
		{
			var isIn = false;
		
			for each (i in rootProducts) {
				if(i.@groupCode == arrFamilyGroups[ig])
				{
					var nodeProduct = i.Product;
					var totsold  = 0;
					var totamount= 0;
					var totttl   = 0;
					var totprom  = 0; 
					var totwst   = 0; 
					var totused  = 0; 
					var valueMgrNetAmt = 0;
					var valueEmpNetAmt = 0;
					
					for each (j in nodeProduct) {
						var name = rootPmix.ProductTable.ProductInfo.(@id == j.@id).@name;
						var eatinPrice   = j.@eatinPrice;
						var takeoutPrice = j.@takeoutPrice;
						var otherPrice   = j.Product.@otherPrice;
						var rootOperationType = j.OperationType;
						var qtdsold = 0;
						var qtdwst  = 0;
						var qtdprom = 0;
						var amount  = 0;
						var valuePrice = 0;
						var qtdInOut = 0;
						var qtdrefund = 0;
						
						for each (k in rootOperationType) {

		//				    var aux = Number(k.PMix.@qtyEatIn * eatinPrice) + Number(k.PMix.@qtyTakeOut * takeoutPrice) + Number(k.PMix.@qtyOther * otherPrice);
						    var aux;
						    if(k.@operationType =="DISCOUNT")
							{
								if(isFVMActive == true)
								{
									aux = Number(k.PMix.@netAmtEatIn);
									aux += Number(k.PMix.@netAmtTakeOut);	
									aux += Number(k.PMix.@netAmtOther);
								}
								else
								{
									aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
									aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOut : k.PMix.@netBeforeDiscountTakeOut);	
									aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);
								}
							}	
							else
							{
						        aux = Number(k.PMix.@netAmtEatIn);
								aux += Number(k.PMix.@netAmtTakeOut);	
								aux += Number(k.PMix.@netAmtOther);
							}	
							
							if(flagNet ==false) 	//MS we need gross price
							{
								if(k.@operationType =="DISCOUNT")
								{ //in case we have a discount the taxBeforeDiscount differs then the normalTax
									if(isFVMActive == true)
									{
										aux += Number(k.PMix.@taxTakeOut);
										aux += Number(k.PMix.@taxEatIn);
										aux += Number(k.PMix.@taxOther);
									}
									else
									{
										aux += Number(k.PMix.@taxBeforeDiscountTakeOut);
										aux += Number(k.PMix.@taxBeforeDiscountEatIn);
										aux += Number(k.PMix.@taxBeforeDiscountOther);
									}
								}
								else
								{
									aux += Number(k.PMix.@taxTakeOut);
									aux += Number(k.PMix.@taxEatIn);
									aux += Number(k.PMix.@taxOther);
								}
							}
							if(k.@operationType == "REFUND"){
								amount  -= aux;
								qtdrefund += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							else{
								amount   += aux;
								qtdInOut += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							
							if(k.@operationType == "DISCOUNT"){
								valueOtherDct += Number(k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
												 Number(k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
												 Number(k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);	
								 if(flagNet == false)
								 {
									 //02.02.2009 MS we need the tyx for gross values
									 valueOtherDct += Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
									 Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
									 Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther);
								 }
								 if(isFVMActive == true)  //no information abut discount in case of FVM
								 {
									valueOtherDct =0;
								 }
							}
							/*MIHAI no need for this anymore
							if(k.@operationType == "SALE") {
								if((k.PMix.@netBeforeDiscountEatIn != "") || (k.PMix.@netBeforeDiscountTakeOut != "") || (k.PMix.@netBeforeDiscountOther != "")) {
									valueOtherDct += Number(k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
													 Number(k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
													 Number(k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);
									 if(flagNet == false)
									 {
										  //02.02.2009 MS we need the tyx for gross values
										 valueOtherDct += Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
										 Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
										 Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther);
									 }
								}
							}
							*/
							if(k.@operationType == "MANAGER"){
								valueMgrNetAmt =  Number(k.PMix.@netAmtEatIn) + Number(k.PMix.@netAmtTakeOut) +  Number(k.PMix.@netAmtOther);
								valueMgrMealDct += Number(k.PMix.@netBeforeDiscountEatIn) + Number(k.PMix.@netBeforeDiscountTakeOut) + Number(k.PMix.@netBeforeDiscountOther) - Number(valueMgrNetAmt);
								 if(flagNet == false)
								 {
									//02.02.2009 MS we need the tyx for gross values
									valueMgrNetAmt += Number(k.PMix.@taxEatIn) + Number(k.PMix.@taxTakeOut) +  Number(k.PMix.@taxOther) ;
									valueMgrMealDct += Number(k.PMix.@taxBeforeDiscountEatIn) + Number(k.PMix.@taxBeforeDiscountTakeOut) +
														Number(k.PMix.@taxBeforeDiscountOther)-
														(Number(k.PMix.@taxEatIn) + Number(k.PMix.@taxTakeOut) +  Number(k.PMix.@taxOther));	
								 }
								 if(Country =="AT")
								 {	
										//if (valueMgrNetAmt == 0 ) {
										//	qtdInOut -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
										//}
										if(valueMgrNetAmt != 0)
										{
											amount -= valueMgrNetAmt;
										}
										else
										{
											amount -= aux;
										}
		
								}
								qtdsold = qtdInOut;
								
							}
							if(k.@operationType == "CREW"){
								valueEmpNetAmt = Number(k.PMix.@netAmtEatIn) + Number(k.PMix.@netAmtTakeOut) + Number(k.PMix.@netAmtOther);
								valueEmpMealDct += Number(k.PMix.@netBeforeDiscountEatIn) + Number(k.PMix.@netBeforeDiscountTakeOut)+ Number(k.PMix.@netBeforeDiscountOther) - Number(valueEmpNetAmt);
								if(flagNet == false)
								{
									//02.02.2009 MS we need the tyx for gross values
									valueEmpNetAmt += Number(k.PMix.@taxEatIn) + Number(k.PMix.@taxTakeOut) + Number(k.PMix.@taxOther);
									valueEmpMealDct += Number(k.PMix.@taxBeforeDiscountEatIn) + Number(k.PMix.@taxBeforeDiscountTakeOut) +
													   Number(k.PMix.@taxBeforeDiscountOther) -
													   (Number(k.PMix.@taxEatIn) + Number(k.PMix.@taxTakeOut) + Number(k.PMix.@taxOther));
								}
								//API.dbg("crewdiscount "+valueEmpMealDct);		
								if(Country =="AT")
								{									
										//if (valueEmpNetAmt == 0 ) {
										//	qtdInOut -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
										//}
										if(valueEmpNetAmt != 0)
										{
											amount -= valueEmpNetAmt
										}else
										{
											amount -= aux;
										}
								}		
								qtdsold = qtdInOut;
								
							}
							
							if(k.@operationType == "PROMO"){
								 amount   -= aux;
								 qtdprom += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							if(k.@operationType == "WASTE"){
								 amount   -= aux;
								 qtdwst  += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							if((k.@operationType == "SALE") || (k.@operationType == "DISCOUNT")){
								 qtdsold += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
						}

						qtdsold -=qtdrefund;
						var ttl =  Math.abs(calculatePercentage(amount,sumProducts));
						var used = qtdsold + qtdwst + qtdprom;
						addOperationLine(name, qtdsold, qtdprom, qtdwst, amount, API.setOnRight(API.formatNumber(Number(ttl), "##0.0", 5), 5),  used);
						totsold   += Number(qtdsold);
						totamount += amount;
						totprom   += qtdprom;
						totwst    += qtdwst;
						totused   += Number(used);
					}
					
					var name = "GRP " +  API.setOnRight(i.@groupCode, 2)
					var valueTtl =  Math.abs(calculatePercentage(totamount,sumProducts));
					//addLine(SEP_SC);
					addLine();
					addOperationLine(name, totsold, totprom, totwst,  totamount, API.setOnRight(API.formatNumber(Number(valueTtl), "##0.0", 5), 5), totused);
					//addLine(SEP_SC);
					addLine();
					
					sumProductsSold  += totsold;
					sumProductsAmount+= totamount;
					sumProductsTtl   += totttl;
					sumProductsProm  += totprom; 
					sumProductsWst   += totwst; 
					sumProductsUsed  += totused; 
					isIn = true;
					break;
				}
			}	
			if(!isIn && Country != "DE" )
			{
				var name = "GRP " +  API.setOnRight(arrFamilyGroups[ig], 2)
				addLine();
				addOperationLine(name, 0, 0, 0,  0, API.setOnRight(0, 5), 0);
				addLine();
			}
		}
   
	}
    else
	{
		if(Country !="UK" && Country !="IE")
		{
			//addLine(center("PRODUCTS"));	
			addLine(SEP_SC);
			addOperationLine("GRP xx", 0, 0, 0, 0, API.setOnRight(API.formatNumber(Number(0), "##0.0", 5), 5), 0);
			addLine(SEP_SC);
			addLine();
		}
	}
	// get information of the Non Products
	var sumNonProductsSold  = 0;
	var sumNonProductsAmount= 0;
	var sumNonProductsTtl   = 0;
	var sumNonProductsProm  = 0; 
	var sumNonProductsWst   = 0; 
	var sumNonProductsUsed  = 0; 
	
	addLine(center(API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS")));
	var start=9;
	var end;
	if(Country =="UK" || Country =="IE")
	{
		end =12;
	}
	else
	{
		end =10;
	}
	//26.01.2009 OI change the index because we have only one group for non products.
	for (var ig = start; ig<end; ig++)
	{
		var isIn = false;
		if(rootNonProducts.length()){
			for each (i in rootNonProducts) {
				if(i.@groupCode == arrFamilyGroups[ig])
				{
					var nodeProduct = i.Product;
					var totsold  = 0;
					var totamount= 0;
					var totttl   = 0;
					var totprom  = 0; 
					var totwst   = 0; 
					var totused  = 0; 
					for each (j in nodeProduct) {
						var name = rootPmix.ProductTable.ProductInfo.(@id == j.@id).@name;
						var eatinPrice   = j.@eatinPrice;
						var takeoutPrice = j.@takeoutPrice;
						var otherPrice   = j.Product.@otherPrice;
						var rootOperationType = j.OperationType;
						var qtdsold = 0;
						var qtdwst  = 0;
						var qtdprom = 0;
						var amount  = 0;
						var valuePrice = 0;
						var qtdInOut = 0;			
						
						for each (k in rootOperationType) {

		//					var	aux = Number(k.PMix.@qtyEatIn * eatinPrice) + Number(k.PMix.@qtyTakeOut * takeoutPrice) + Number(k.PMix.@qtyOther * otherPrice);	
							var aux
							if(isFVMActive ==false)
							{
							    aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
							    aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOut : k.PMix.@netBeforeDiscountTakeOut);					
								aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);	
							}
							else
							{
								aux = Number(k.PMix.@netAmtEatIn);
							    aux += Number(k.PMix.@netAmtTakeOut);					
								aux += Number(k.PMix.@netAmtOther);	
						
							}
								if(flagNet == false)
								{
									//02.02.2009 MS we need the gross amount
									if(isFVMActive ==false && (String(k.PMix.@netBeforeDiscountEatIn)!="" || String(k.PMix.@netBeforeDiscountTakeOut)!="" || String(k.PMix.@netBeforeDiscountOther)!=""))
									{
										aux += Number(k.PMix.@taxBeforeDiscountTakeOut);
									    aux += Number(k.PMix.@taxBeforeDiscountEatIn);
									    aux += Number(k.PMix.@taxBeforeDiscountOther);
										//API.dbg("mihai123 discount "+aux);
									}
									else
									{
									    aux += Number(k.PMix.@taxTakeOut);
									    aux += Number(k.PMix.@taxEatIn);
									    aux += Number(k.PMix.@taxOther);
									}
							    }
							if(k.@operationType == "REFUND"){
								amount  -= aux;
			   				 	qtdsold -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							else{
								amount   += aux;
								qtdInOut = Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							if(k.@operationType == "DISCOUNT"){
								valueOtherDct += (k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
												 (k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
												 (k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);
								if(flagNet == false)
								{				 
									 //02.02.2009 MS we need the tyx for gross values
									 valueOtherDct += Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
									 Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
									 Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther) ;	
							   }	
								 							   
							   if(isFVMActive == true)
							   {
								  valueOtherDct =0;
							   }
								
							}
							if(k.@operationType == "MANAGER"){
								valueMgrMealDct += (k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
												   (k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
												   (k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);
								if(flagNet == false)
								{				   
								   //02.02.2009 MS we need the tyx for gross values
								   valueMgrMealDct += Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
								   Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
								   Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther);
								}	
								if(Country =="AT")
								 {	
										if (valueMgrNetAmt == 0 ) {
											qtdInOut -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
										}
										if(valueEmpNetAmt != 0)
										{
											amount -= valueEmpNetAmt
										}else
										{
											amount -= aux;
										}
		
								}								
								qtdsold = qtdInOut;
								
							}
							if(k.@operationType == "CREW"){
								valueEmpMealDct += (k.PMix.@netBeforeDiscountEatIn - k.PMix.@netAmtEatIn) +
												   (k.PMix.@netBeforeDiscountTakeOut - k.PMix.@netAmtTakeOut) +
												   (k.PMix.@netBeforeDiscountOther - k.PMix.@netAmtOther);
								if(flagNet == false)
								{					   
									//02.02.2009 MS we need the tyx for gross values
									valueEmpMealDct +=  Number(k.PMix.@taxBeforeDiscountEatIn - k.PMix.@taxEatIn) +
												   Number(k.PMix.@taxBeforeDiscountTakeOut - k.PMix.@taxTakeOut) +
												   Number(k.PMix.@taxBeforeDiscountOther - k.PMix.@taxOther);
								}
								if(Country =="AT")
								{									
										if (valueEmpNetAmt == 0 ) {
											qtdInOut -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
										}
										if(valueEmpNetAmt != 0)
										{
											amount -= valueEmpNetAmt
										}else
										{
											amount -= aux;
										}
								}					   
									//API.dbg("pmix crew meal "+k);
									//API.dbg("pmix crew meal price" +eatinPrice);
								qtdsold = qtdInOut;
								
							}
							if(k.@operationType == "PROMO"){
								 amount   -= aux;
			    				 qtdprom += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							if(k.@operationType == "WASTE"){
			    				 qtdwst  += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
							if((k.@operationType == "SALE") || (k.@operationType == "DISCOUNT")){
			    				 qtdsold += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							}
						}
						
						var ttl =  Math.abs(calculatePercentage(amount,sumProducts));
						var used = qtdsold + qtdwst + qtdprom;
						addOperationLine(name, qtdsold, qtdprom, qtdwst, amount, API.setOnRight(API.formatNumber(Number(ttl), "##0.0", 5), 5), used);
						totsold   += Number(qtdsold);
						totamount += amount;
						totprom   += qtdprom;
						totwst    += qtdwst;
						totused   += Number(used);
					}
					
					var name = "GRP " +  API.setOnRight(i.@groupCode, 2)
					var valueTtl =  Math.abs(calculatePercentage(totamount,sumProducts));
					//addLine(SEP_SC);
					addLine();
					addOperationLine(name, totsold, totprom, totwst, totamount, API.setOnRight(API.formatNumber(Number(valueTtl), "##0.0", 5), 5), totused);
					//addLine(SEP_SC);
					addLine();
					
					sumNonProductsSold  += totsold;
					sumNonProductsAmount+= totamount;
					sumNonProductsTtl   += totttl;
					sumNonProductsProm  += totprom; 
					sumNonProductsWst   += totwst; 
					sumNonProductsUsed  += totused; 
					isIn = true;
					break;
				}
			}
		}
		if(!isIn)
		{
			var name = "GRP " +  API.setOnRight(arrFamilyGroups[ig], 2)
			addLine();
			addOperationLine(name, 0, 0, 0,  0, API.setOnRight(0, 5), 0);
			addLine();
		}
	}
	
	// Calculate Summary information
	addLine(center(API.getLocalMsg("MSG_RECEIPT_SUMMARY")));
	
	var totSumSold  = sumNonProductsSold+sumProductsSold;
	var totSumAmount= sumNonProductsAmount+sumProductsAmount;
	var totSumTtl   = sumNonProductsTtl+sumProductsTtl;
	var totSumProm  = sumNonProductsProm+sumProductsProm; 
	var totSumWst   = sumNonProductsWst+sumProductsWst; 
	var totSumUsed  = sumNonProductsUsed+sumProductsUsed; 
	
	var value = Math.abs(calculatePercentage(sumNonProductsAmount,totSumAmount));	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_T_NPRD"), sumNonProductsSold, sumNonProductsProm, sumNonProductsWst, sumNonProductsAmount, API.setOnRight(API.formatNumber(Number(value), "##0", 3), 4)+"%", sumNonProductsUsed);
	
	value = Math.abs(calculatePercentage(sumProductsAmount,totSumAmount));	
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_T_PROD"), sumProductsSold, sumProductsProm, sumProductsWst, sumProductsAmount, API.setOnRight(API.formatNumber(Number(value), "##0", 3), 4)+"%", sumProductsUsed);
	
	value = Math.abs(calculatePercentage(totSumAmount,totSumAmount));
	addOperationLine(API.getLocalMsg("MSG_RECEIPT_T_SUM"), totSumSold, totSumProm, totSumWst, totSumAmount, API.setOnRight(API.formatNumber(Number(value), "##0", 3), 4)+"%", totSumUsed);

	addLine(SEP_SL);
	if(Country != "UK" && Country !="IE") //for uk we do not display the special meals informations
	{
		addLine("-Mgr Meal Dct           :" + " " + API.setOnRight(API.formatNumber(Number(valueMgrMealDct)-managerCoupon, "####0.00", 9), 9));
		addLine("-Emp Meal Dct           :" + " " + API.setOnRight(API.formatNumber(Number(valueEmpMealDct)-crewCoupon, "####0.00", 9), 9));
	}
	addLine("-Other Dct              :" + " " + API.setOnRight(API.formatNumber(Number(valueOtherDct)+Number(managerCoupon)+Number(crewCoupon), "####0.00", 9), 9));	
	addLine(SEP_SL);
	var totWithDisc = totSumAmount - (valueMgrMealDct + valueEmpMealDct + valueOtherDct);
	if(Country !="AT")
	{
		addLine("Total Less Discounts    :" + " " + API.setOnRight(API.formatNumber(Number(totWithDisc), "####0.00", 9), 9));		
	}
	addLine();
	addFooter(rootCash);
	
	return;
	
	/** Calculates japan percentage by Some amount vs. Total Store Amount. */
	function calculatePercentage(amount, totalStoreAmount) 
	{
		return amount > 0 ? (amount / totalStoreAmount * 100) : 0;
	}
	
	/** Calculates Total Store Amount. */
	function getTotalSum(rootProducts)
	{
	var sumProductsAmount= 0;
	
	if(rootProducts.length()){
		for each (i in rootProducts) {
			var nodeProduct = i.Product;
			var totamount= 0;
			for each (j in nodeProduct) {
				var eatinPrice   = j.@eatinPrice;
				var takeoutPrice = j.@takeoutPrice;
				var otherPrice   = j.@otherPrice;
				var rootOperationType = j.OperationType;
				var amount = 0;
				for each (k in rootOperationType) {

//					var aux = Number(k.PMix.@qtyEatIn * eatinPrice) + Number(k.PMix.@qtyTakeOut * takeoutPrice) + Number(k.PMix.@qtyOther * otherPrice);
					var aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
					    aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOut : k.PMix.@netBeforeDiscountTakeOut);					
						aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);					 if(flagNet ==false)
					{
						//02.02.2009 MS we need the gross amount
						if(String(k.PMix.@netBeforeDiscountEatIn)!="" || String(k.PMix.@netBeforeDiscountTakeOut)!="" || String(k.PMix.@netBeforeDiscountOther)!="")
						{
							aux += Number(k.PMix.@taxBeforeDiscountTakeOut);
							aux += Number(k.PMix.@taxBeforeDiscountEatIn);
							aux += Number(k.PMix.@taxBeforeDiscountOther);
							//API.dbg("mihai123 discount "+aux);
						}
						else
						{
							aux += Number(k.PMix.@taxTakeOut);
							aux += Number(k.PMix.@taxEatIn);
							aux += Number(k.PMix.@taxOther);
						}
					}	
					if(k.@operationType == "REFUND"){
						amount  -= aux;
					}
					else{
						amount   += aux;
					}
					
					if(k.@operationType == "PROMO"){
						amount   -= aux;
					}
				}
				totamount += amount;
			}
			sumProductsAmount+= totamount;
		}
	}
	
	return sumProductsAmount;
	}
	
	/**
	 * Adds a given line by Group
	 * @param title of group
 	 * @param root By Group
  	 * @param sum Products
	 */
	function addLineByGroup(title, rootByGroup, sumProducts)
	{
	
		addLine(center(title));

		var sumProductsSold  = 0;
		var sumProductsAmount= 0;
		var sumProductsTtl   = 0;
		var sumProductsProm  = 0; 
		var sumProductsWst   = 0; 
		var sumProductsUsed  = 0; 
		for each (i in rootByGroup) {
			var nodeProduct = i.Product;
			var totsold  = 0;
			var totamount= 0;
			var totttl   = 0;
			var totprom  = 0; 
			var totwst   = 0; 
			var totused  = 0; 
			for each (j in nodeProduct) {
				if(j.OperationType.@operationType == "MANAGER"){
					valueMgrMealDct += j.@eatinPrice;
				}
				if(j.OperationType.@operationType == "CREW"){
					valueEmpMealDct += j.@eatinPrice;
				}
				var name = rootPmix.ProductTable.ProductInfo.(@id == j.@id).@name;
				
				var rootOperationType = j.OperationType;
				var qtdsold = 0;
				var qtdwst  = 0;
				var qtdprom = 0;
				var amount  = 0;
				var valuePrice = 0;
				var qtdInOut = 0;				
				
				for each (k in rootOperationType) {
					valuePrice =  Number(k.Price.@salePrice);
					qtdInOut   =  Number(k.Price.PMix.@qtyEatIn) +  Number(k.Price.PMix.@qtyTakeOut);
				
					sold = qtdInOut;
					if(k.@operationType == "PROMO"){
	    				 qtdprom = qtdInOut;
					}
					if(k.@operationType == "WASTE"){
	    				 qtdwst  = qtdInOut;
					}
					if(k.@operationType == "SALE"){
	    				 qtdsold = qtdInOut;
					}
				}
				
				amount = valuePrice * qtdsold;
				var ttl =  calculatePercentage(amount,sumProducts);
				var used = qtdsold + qtdwst + qtdprom;
				addOperationLine(name, qtdsold, amount, API.setOnRight(API.formatNumber(Number(ttl), "#00.0", 5), 5), qtdprom, qtdwst, used);
				totsold   += Number(qtdsold);
				totamount += amount;
				totprom   += qtdprom;
				totwst    += qtdwst;
				totused   += Number(used);
			}
			
			var name = "GRP " +  API.setOnRight(i.@groupCode, 2)
			var valueTtl =  calculatePercentage(totamount,sumProducts);
			addLine(SEP_SC);
			addOperationLine(name, totsold, totamount, API.setOnRight(API.formatNumber(Number(valueTtl), "#00.0", 5), 5), totprom, totwst, totused);
			addLine(SEP_SC);
			addLine();
			
			sumProductsSold  += totsold;
			sumProductsAmount+= totamount;
			sumProductsTtl   += totttl;
			sumProductsProm  += totprom; 
			sumProductsWst   += totwst; 
			sumProductsUsed  += totused; 
		}
	}
	
	/**
	 * Adds an operation line like this:
	 * "HPY HM     1    1.18   1.9    0   0    1"
	 * @param name operation name ("TOTAL ITEMS")
	 * @param sold
	 * @param amount
	 * @param ttl
	 * @param prom
	 * @param wst	 	 
	 * @param used	 	 	 
	 */
	function addOperationLine(name, sold, prom, wst, amount, ttl, used) 
	{
		var value=0;
		
		if (Number(amount)<=999.99) {
			value= API.setOnRight(API.formatNumber(Number(amount), "##0.00", 6), 6);
		}
		else {
			if (Number(amount)<=9999.99) {
				value= API.setOnRight(API.formatNumber(Number(amount), "###0.00", 7), 7);
			}
			else {
				value= API.setOnRight(API.formatNumber(Number(amount), "####0.00", 8), 8);
			}
		}	
			
	
		if(Country =="DE")
		{
			// 7: name, 3: sep, 3: sold, 6: amount, 12: value
			var line = API.setOnLeft(String(name).substring(0, 7),7)
			+ API.setOnRight(sold, 5)		
			+ " "		
			+ value
			+ " "		
			+ ttl
			+ API.setOnRight(prom, 5)
			+ API.setOnRight(wst, 4)
			+ API.setOnRight(used, 5);
		}
		else
		{
			// 7: name, 3: sep, 3: sold, 6: amount, 12: value
			var line = API.setOnLeft(String(name).substring(0, 7),7)
			+ API.setOnRight(sold, 5)		
			+ API.setOnRight(prom, 4)
			+ API.setOnRight(wst, 4)
			+ " "	
			+ value
			+ " "	
			+ ttl
			+ API.setOnRight(used, 4);
		}
		addLine(line);
	}
}
/* Finish function implements a generic PMIX report */

/**
 * PUBLIC
 * Responsible for formating the PMix UPT By Date report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportPMixUPTByDate(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "PMIX"), "MUPTD") != 0) {
		return getResponse();
	}	
	
	var root = rootPmix;    
	var posID = getPosId(); 
	if( (Country == "FR") && posID!= "N/A" && posID !=0) 	
	{
		genericPMixUPTFR(config, data, root, RPTPMIXUPTBYDATE);
	}
    else //other country the FR or FR request from waystation
    {
		genericPMixUPT(config, data, root, RPTPMIXUPTBYDATE);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the PMix UPT By Date StoreWide report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportPMixUPTByDateSW(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "PMIX"), "UPTSW") != 0) {
		return getResponse();
	}	

	var root = rootPmix;    
	var posID = getPosId(); 
	if( (Country == "FR") && posID!= "N/A" && posID !=0) 	
	{
		genericPMixUPTFR(config, data, root, RPTPMIXUPTBYDATESW);
	}
    else //other country the FR or FR request from waystation
    {
		genericPMixUPT(config, data, root, RPTPMIXUPTBYDATESW);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the PMix UPT By Hour report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportPMixUPTByHour(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "PMIX"), "MXUHR") != 0) {
		return getResponse();
	}	

	var root = rootPmix;  
	var posID = getPosId(); 
	if( (Country == "FR" ) && posID!= "N/A" && posID !=0) 	
	{
		genericPMixUPTFR(config, data, root, RPTPMIXUPTBYHOUR);
	}
    else //other country the FR or FR request from waystation
    {
		genericPMixUPT(config, data, root, RPTPMIXUPTBYHOUR);
	}	
	
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the PMix UPT By Hour StoreWide report.
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function reportPMixUPTByHourSW(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "PMIX"), "MXUSW") != 0) {
		return getResponse();
	}	
	var root = rootPmix;    
	var posID = getPosId(); 
	if( (Country == "FR") && posID!= "N/A" && posID !=0) 	
	{
		genericPMixUPTFR(config, data, root, RPTPMIXUPTBYHOURSW);
	}
    else //other country the FR or FR request from waystation
    {
		genericPMixUPT(config, data, root, RPTPMIXUPTBYHOURSW);
	}	
	return getResponse();
};

/**
 * PUBLIC
 * This function implements a generic PMix UPT report for FR 
 * Needed data types: CASH, PMIX
 * @author Celso 
 */
function genericPMixUPTFR(config, data, root, reportType) 
{
    API.dbg("upt pmix hr rootHourlySales"+ rootHourlySales);
	var pod = rootCash.@requestPod;
	var title;
		
	var uptStartHour = "";
	var uptEndHour = ""; 
	
	lineRpt_array = new Array();
	
	var qtdTCDiscard = rootCash.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash;//.@tc
	var qtdTCs		 = rootCash.CashTotals.Cash.@tc; // - summNodesAttributeValues(qtdTCDiscard,"tc"); // - rootCash.CashTotals.GiftCouponSales.Cash.@tc;
	var nodesbegTime = new XML("<Segments />");
	switch(reportType) {
    case RPTPMIXUPTBYDATE:
   	   	 title = "P.Mix(x1000)";
   	   	 break;
    case RPTPMIXUPTBYHOUR:
	   	 title = "P.Mix(x1000)-Hr";
		 var uptHour = new Array()
		 var uptHour = rootConfig.CustomData.split(",");  //root.@requestTime.substring(0, 2);
		 API.dbg("uptHour "+uptHour);
		 uptStartHour = uptHour[0];
		 uptEndHour = uptHour[1];
		 if(Number(uptEndHour) < Number(uptStartHour))
		 {
			uptEndHour = (Number(uptEndHour) +2400)+"";
		 }
		 
		 
		 if(uptStartHour==""){
			uptStartHour = "0000";
		 }	 	
         if(uptEndHour == "")
		 {
			uptEndHour = "1000";
		 }

         //add the segments that correspond to the given interval
         for each (var segment in  rootHourlySales.DayPartitioning.Segment)		 
		 {
		    var beginTime = segment.@begTime;
			var endTime = segment.@endTime;
			if( Number(segment.@dayOffset) >0)
			{
			   beginTime = (Number(beginTime) +2400 * Number(segment.@dayOffset)) +"";
			   endTime  = ( Number(endTime) +2400 * Number(segment.@dayOffset)) +"";
			}
			
			//test if the segment is in the given interval
			if(Number(beginTime) >= Number(uptStartHour) && Number(endTime) <  Number(uptEndHour))
			{  //is in the interval we add the segment to the nodesbegtime
				nodesbegTime.appendChild(segment);
			}
		 }
		 //API.dbg("upt-hr "+nodesbegTime);
		 qtdTCs=0;
		 for each (begTime in nodesbegTime) {
		 	{
				qtdTCs += Number(rootHourlySales.StoreTotal.Sales.(@id==begTime.@id).@tc);
			}
		 }
       	 break;			
    case RPTPMIXUPTBYDATESW:
    	 title = "P.Mix(x1000)";
    	 break;
    case RPTPMIXUPTBYHOURSW:    
		 title = "P.Mix(x1000)-Hr";
		 var uptHour = new Array()
		 var uptHour = rootConfig.CustomData.split(",");  //root.@requestTime.substring(0, 2);
		 uptStartHour = uptHour[0];
		 uptEndHour = uptHour[1];
		 if(Number(uptEndHour) < Number(uptStartHour))
		 {
		    uptEndHour = (Number(uptEndHour) +2400)+"";
		 }
		 
		 if(uptStartHour==""){
			uptStartHour = "0000";
		 }	 	
         if(uptEndHour == "")
		 {
			uptEndHour = "1000";
		 }	

		 var nodesPOS = rootCash.POS;
		 var requestDay = getBusinessDate(nodesPOS);
		 //add the segments that correspond to the given interval
         for each (var segment in  rootHourlySales.DayPartitioning.Segment)		 
		 {
		    var beginTime = segment.@begTime;
			var endTime = segment.@endTime;
			if( segment.@dayOffset != requestDay)
			{
			   var offset = Number(segment.@dayOffset.substring(6,8)) -Number(requestDay.substring(6,8));
			   beginTime = (Number(beginTime) +2400 *offset) +"";
			   endTime  = ( Number(endTime) +2400 *offset) +"";
			}
			
			//test if the segment is in the given interval
			if(Number(beginTime) >= Number(uptStartHour) && Number(endTime) <  Number(uptEndHour))
			{  //is in the interval we add the segment to the nodesbegtime
				nodesbegTime.appendChild(segment);
			}
		 }
		 
		 //API.dbg("upt-hr segment SW "+nodesbegTime);
		 
		// var nodesbegTime = rootHourlySales.DayPartitioning.Segment.(Number(@begTime) >= Number(uptStartHour) && (		 
		// (Number(@endTime) + rootHourlySales.DayPartitioning.Segment.@dayOffset !=requestDay &&  (rootHourlySales.DayPartitioning.Segment.@dayOffset) !=0 ?  2400:0 ) <= Number(uptEndHour)));
		 qtdTCs=0;
		 for each (begTime in nodesbegTime) {
		 	{
				qtdTCs += Number(rootHourlySales.StoreTotal.Sales.(@id==begTime.@id).@tc);
			}
		 }
		 
       	 break;
    default:
   	     title = "ERROR";
       	 break;
	}
	//API.dbg("hourlysale "+ rootHourlySales);
	addHeader(rootCash, title, reportType);
	if(uptStartHour!=""){	 
		// addLine(center("Hour Fm "+ uptStartHour +" To " + uptEndHour + ":00"));
		 addLine();
	}

	if 	(qtdTCs == 0){
		addLine(center(API.getLocalMsg("MSG_RECEIPT_NO_DATA")));
		addLine();
		addFooter(rootCash);
		return;
	}
	
	// Body of Report 
	addLine(API.getLocalMsg("NUMBER_TOTAL_TRANS") +":"+ API.setOnRight(qtdTCs,8));	  
	addLine();
	
	//header line
addLine(API.setOnLeft(API.getLocalMsg("MSG_PMIX_PRODUCT_NAME"),7) + API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_QTY"), 8) + API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_TOTSALES"), 8) + API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_TR"), 9) + API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_UPT"), 7));
	
	var localFamilyArray = GetLocalFamily(); 
	var familyLength = localFamilyArray.length;
	/*
	localFamilyArray[0] ="BEST OF";
	localFamilyArray[1] ="SANDWICH";
	localFamilyArray[2] ="BO CRUDITES";	
	localFamilyArray[3] ="MAXI BO";
	localFamilyArray[4] ="NUGGETS";
	localFamilyArray[5] ="SAUCES NUGGETS";
	localFamilyArray[6] ="SALADES";
	localFamilyArray[7] ="SAUCES SALADES";
	localFamilyArray[8] ="HAPPY MEAL";
	localFamilyArray[9] ="FRITES";
	localFamilyArray[10] ="CONDIMENTS";
	localFamilyArray[11] ="POTATOES";
	localFamilyArray[12] ="BOISSONS CHAUDES";
	localFamilyArray[13] ="BOISSONS 25";
	localFamilyArray[14] ="BOISSONS 40";
	localFamilyArray[15] ="BOISSONS 50";
	localFamilyArray[16] ="BOISSONS 80";
	localFamilyArray[17] ="JUS ORANGE";
	localFamilyArray[18] ="BIERE";
	localFamilyArray[19] ="EAU MINERALE";
	localFamilyArray[20] ="SUNDAES";
	localFamilyArray[21] ="SHAKES";
	localFamilyArray[22] ="MC FLURRY";
	localFamilyArray[23] ="SNACKS";
	localFamilyArray[24] ="MC CAFE";
	localFamilyArray[25] ="PRODUITS MORNING";
	localFamilyArray[26] ="FORMULES MORNING";
	localFamilyArray[27] ="FORMULES MAXI MORNING";
	localFamilyArray[28] ="ANNIVERSAIRES";
	localFamilyArray[29] ="BO DUO";
	localFamilyArray[30] ="AUTRES";
	localFamilyArray[31] ="";
	var familyLenght = 32;
	*/
	
	//create xml with product family group information
	var xmlProduct = new XML("<productfamily/>");
	var hlp = new BusinessObjectHelper;
	for each (product in rootPmix.ProductTable.ProductInfo)
	{
		var arrProdCode = new Array();
		arrProdCode[0]= product.@id+"";

		//get the product information
		hlp.iterateProductDB(arrProdCode, product.@id+"");

		var resp = <product />;
		resp.@id= product.@id;
		if(productPMIXFamilyName!=null)
		{
			resp.@family = productPMIXFamilyName;
		}
		else
		{
			resp.@family = "";
		}
		xmlProduct.appendChild(resp);
	}
	
	var rootProducts = root.FamilyGroup.(@groupName!="NON_PRODUCT" && @groupName != "GIFT_COUPON");
	var rootNonProducts = root.FamilyGroup.(@groupName=="NON_PRODUCT");
	
	var sumPProducts = getTotalSum(rootProducts);
	var sumNonProducts = getTotalSum(rootNonProducts);	
	var sumPQty = getTotalQty(rootProducts);
	var sumNonQty =  getTotalQty(rootNonProducts);
	
	var sumProducts = Number(sumPProducts) + Number(sumNonProducts);	
	var sumQty = Number(sumPQty)  + Number(sumNonQty);	
	
	var pmixHourlyProducts = null;
	var pmixHourlyNonProducts = null;
	if(uptStartHour !="") //for pmix upt-hr
	{	
		pmixHourlyProducts = buildPmixHourly(true); //for products
		pmixHourlyNonProducts = buildPmixHourly(false); //for non products
		sumPProducts = getTotalSum(pmixHourlyProducts);
		sumNonProducts = getTotalSum(pmixHourlyNonProducts);	
		sumPQty = getTotalQty(pmixHourlyProducts);
		sumNonQty =  getTotalQty(pmixHourlyNonProducts);
		sumProducts = Number(sumPProducts) + Number(sumNonProducts);	
		sumQty = Number(sumPQty)  + Number(sumNonQty);	
	}
	
	//product alimentaire
	if(rootProducts.length()){
		addLine(center(API.getLocalMsg("MSG_RECEIPT_PRODUCTS")));
		var sumTotAmount = 0;
		var sumTotQtdSold = 0;
		var sumTotUpt = 0;
		for (var familyID=0; familyID <= familyLength ; familyID++)
		{		  
			var sumAmount   = 0;
			var sumQtdSold  = 0; 
			var sumValueUpt = 0; 
			for each (i in rootProducts) {
				var nodeProduct = i.Product;

				for each (j in nodeProduct) {
				    var flagUpt 	= false;
					var condition =false;
					if(familyID < familyLength)
						condition=localFamilyArray[familyID].name == (xmlProduct.product.(@id==j.@id).@family).toUpperCase();
					else //this is for products that don't have a valid family  we display them at the end
					{
						condition = (xmlProduct.product.(@id==j.@id).@family.toUpperCase().substring(0,5)!="GROUP")
					}	
					if(condition)
					{
						var idProd = j.@id;
						var name 		 = rootPmix.ProductTable.ProductInfo.(@id == idProd).@name;
						var eatinPrice   = j.@eatinPrice;
						var takeoutPrice = j.@takeoutPrice;
						var otherPrice   = j.Product.@otherPrice;
						var rootOperationType = j.OperationType;
						var qtdsold 	= 0;
						var qtdprom 	= 0;
						var qtdwst		= 0;
						var amount 		= 0;
						var qtdInOut 	= 0;
						

						if(uptStartHour =="")
						{	
							for each (k in rootOperationType) {
								var aux = 0;
								flagUpt = true;
								aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
								aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOu : k.PMix.@netBeforeDiscountTakeOut);							
								aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);								
								
								qtdInOut = Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
							
							
								if(k.@operationType == "REFUND"){
									amount  -= aux;
									qtdsold -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);	
								}
								else{
									amount   += aux;
//						qtdInOut = Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
								}

								if((k.@operationType == "MANAGER") || (k.@operationType == "CREW")){
									qtdsold -= 0;
									amount  -= aux;						
								}
								
								if(k.@operationType == "PROMO"){
									amount  -= aux;						 
									qtdprom += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);		   					}
								
								if(k.@operationType == "WASTE"){
									amount -=aux;
									qtdwst += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);		   				
								}
								if((k.@operationType == "SALE") || (k.@operationType == "DISCOUNT")){
				    				 qtdsold += qtdInOut;
								}
							}
					    }
						else  //we have a selected interval then we must read the information from hourly sale
						{
						   sumProduct(idProd, pmixHourlyProducts);
						}
					}
					if(flagUpt == true){ //we have an entry for this product
						addLineArray(lineRpt_array, name, amount, qtdsold); 
						sumAmount   += amount;
						sumQtdSold  += qtdsold;
						//sumValueUpt += valueUpt;
					}
				}
			}
			//add info for local familygroup
			if( Number(sumQtdSold) !=0 ) //we have at least one sale for the current family local group
			{
				//now we have the total items sold for the current family and we can calculate the UPT for each product in that familygroup
				calculateUPT(lineRpt_array, sumQtdSold, sumAmount);
				lineRpt_array = new Array(); //reset the array
				var valueUpt = (1000/qtdTCs)*sumQtdSold;
				var valueGpr =  sumQtdSold*100/ sumQty;
				var description ;
				if(familyID == familyLength) //for products that do not have a valid family we do not have a description
				{ 
					description  ="None";
				}
				else
					description = localFamilyArray[familyID].description;
				addLineUPTNew(true, description, sumQtdSold, sumAmount, valueGpr, valueUpt);
				addLine();
				//addLineArray(lineRpt_array, name, sumAmount, sumQtdSold, valueUpt);
				
				sumTotAmount += sumAmount;
				sumTotQtdSold += sumQtdSold;
				
			}
		}
		
	}	
	//product non alimentaire
	if( rootNonProducts.length())
	{
		addLine(center(API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS")));
	    var sumAmount   = 0;
		var sumQtdSold  = 0; 
		var sumValueUpt = 0; 
		for each (i in rootNonProducts) { //family nonproduct
			var nodeProduct = i.Product;

			for each (j in nodeProduct) { //actual products
				var idProd = j.@id;
				var name 		 = rootPmix.ProductTable.ProductInfo.(@id == idProd).@name;
				var eatinPrice   = j.@eatinPrice;
				var takeoutPrice = j.@takeoutPrice;
				var otherPrice   = j.Product.@otherPrice;
				var rootOperationType = j.OperationType;
				var qtdsold 	= 0;
				var qtdprom 	= 0;
				var qtdwst		= 0;
				var amount 		= 0;
				var qtdInOut 	= 0;
				
				if(uptStartHour =="")
				{				
					for each (k in rootOperationType) {
						flagUpt = true;
						aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
						aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOu : k.PMix.@netBeforeDiscountTakeOut);							
						aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);								
						
						qtdInOut = Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
					
						if(k.@operationType == "REFUND"){
							amount  -= aux;
							qtdsold -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);		   				
						}
						else{
							amount   += aux;
//						qtdInOut = Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
						}

						if((k.@operationType == "MANAGER") || (k.@operationType == "CREW")){
							qtdsold -= 0;
							amount  -= aux;						
						}
						
						if(k.@operationType == "PROMO"){
							amount  -= aux;						 
							qtdprom += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);		   				
						}
						
						if(k.@operationType == "WASTE"){
						    amount -= aux;
							qtdwst += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);		   				
							
						}
						if((k.@operationType == "SALE") || (k.@operationType == "DISCOUNT")){
							 qtdsold += qtdInOut;
						}
					}
				}
				else  //we have a selected interval then we must read the information from hourly sale
				{
				   sumProduct(idProd, pmixHourlyNonProducts);
				}
			
				if(flagUpt == true){ //we have an entry for this product
					//var valueUpt = (1000/qtdTCs)*qtdsold;
					addLineArray(lineRpt_array, name, amount, qtdsold);
					sumAmount   += Number(amount);
					sumQtdSold  += Number(qtdsold);
					//sumValueUpt += valueUpt;
				}
			}
		} //end for non product
		
		if( Number(sumQtdSold) >0 ) //we have at least one sale for the nonproducts
		{
			
			//now we have the total items sold for the current family and we can calculate the UPT for each product in that familygroup
			calculateUPT(lineRpt_array, sumQtdSold, sumAmount);
			lineRpt_array = new Array(); //reset the array
			var valueUpt = (1000/qtdTCs)*sumQtdSold;
			var valueGpr =  sumNonQty*100/ sumQty;
			addLineUPTNew(true, API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS"), sumNonQty, sumAmount, valueGpr, valueUpt);
			//addLineArray(lineRpt_array, name, sumAmount, sumQtdSold, valueUpt);
			addLine();
			sumTotAmount += sumAmount;
			sumTotQtdSold += sumQtdSold;
		}
		else
		{
			var name = API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS");
			addLineUPTNew(true, name, 0, 0, 0,  0);
			addLine();
		}
		
	 } 
	else
	{
		addLine(center(API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS")));
		var name = API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS");
		addLineUPTNew(true, name, 0, 0, 0,  0);
		addLine();
	}
	
	addLine();
	addLine(center(API.getLocalMsg("MSG_RECEIPT_SUMMARY")));
	// general infromation
	//product alimentaire
	var valueUpt = (1000/qtdTCs)*sumPQty;
	var valueGpr =  sumPQty*100/ sumQty;
	addLineUPTNew(false, API.getLocalMsg("MSG_RECEIPT_PRODUCTS"), sumPQty, sumPProducts, valueGpr, valueUpt);
	//product non alimentaire
	valueUpt = (1000/qtdTCs)*sumNonQty;
	valueGpr =  sumNonQty*100/ sumQty;
	addLineUPTNew(false, API.getLocalMsg("MSG_RECEIPT_NON_PRODUCTS"), sumNonQty, sumNonProducts, valueGpr, valueUpt);
	//total
	valueUpt = (1000/qtdTCs)*sumQty;
	valueGpr =  sumQty*100/ sumQty;
	addLineUPTNew(true, API.getLocalMsg("MSG_TOTAL"),  sumQty, sumProducts, valueGpr, valueUpt);
	addLine();
	addFooter(rootCash);
	
	return;
	
	function getTotalSum(rootProducts)
	{
	var sumProductsAmount= 0;
	
	if(rootProducts.length()){
		if(uptStartHour =="")
		{
			for each (i in rootProducts) {
				var nodeProduct = i.Product;
				var totamount= 0;
				for each (j in nodeProduct) {
					var eatinPrice   = j.@eatinPrice;
					var takeoutPrice = j.@takeoutPrice;
					var otherPrice   = j.@otherPrice;
					var rootOperationType = j.OperationType;
					var amount = 0;
					for each (k in rootOperationType) {
						var aux =0;
						aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
						aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOut : k.PMix.@netBeforeDiscountTakeOut);					
						aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);
				
						if(k.@operationType == "REFUND")
						{
							amount  -= aux;
						}
						else
						{
							amount   += aux;
						}
						if(k.@operationType == "PROMO" || k.@operationType == "MANAGER" || k.@operationType == "CREW" || k.@operationType == "WASTE")
						{
							amount   -= aux;
						}
					}
					totamount += amount;
				}
				sumProductsAmount+= totamount;
			}
		}
		else
		{
			for each (i in rootProducts) {
				var amount = 0;
				for each (k in i.OperationType)
				{    
					flagUpt = true;
					var aux = Number(k.PMix.@netAmount);
			
					if(k.@operationType == "REFUND"){
						amount  -= aux;
					}
					else{
						amount   += aux;
					}
					if(k.@operationType == "PROMO" || k.@operationType == "MANAGER" || k.@operationType == "CREW" || k.@operationType == "WASTE"  ){
						amount   -= aux;
					}
				}
			sumProductsAmount+= amount;
			}
		}
	}
		
	return sumProductsAmount;
	}
	
	
	function getTotalQty(rootProducts)
	{
	var sumProductsQTY= 0;
	
	if(rootProducts.length()){
		if(uptStartHour =="")
		{
			for each (i in rootProducts) {
				var nodeProduct = i.Product;
				var totqty= 0;
				for each (j in nodeProduct) {
					var eatinPrice   = j.@eatinPrice;
					var takeoutPrice = j.@takeoutPrice;
					var otherPrice   = j.@otherPrice;
					var rootOperationType = j.OperationType;
					var qty = 0;
					for each (k in rootOperationType) {
					
						aux = Number(String(k.PMix.@qtyEatIn)) +  Number(String(k.PMix.@qtyTakeOut)) + Number(String(k.PMix.@qtyOther)) ;    
					
					
						if(k.@operationType == "REFUND"){
							qty  -= aux;
						}
						else{
							qty   += aux;
						}
						
						if(k.@operationType == "PROMO" || k.@operationType == "MANAGER" || k.@operationType == "CREW" || k.@operationType == "WASTE"){
							qty   -= aux;
						}
					}
					totqty += qty;
				}
			sumProductsQTY+= totqty;
			}
				
		}
		else
		{
			for each (i in rootProducts) {
				var qty = 0;
				for each (k in i.OperationType)
				{    
					var aux = Number(k.PMix.@qtyEatIn) +  Number(k.PMix.@qtyTakeOut);
			
					if(k.@operationType == "REFUND"){
						qty  -= aux;
					}
					else{
						qty   += aux;
					}
					if(k.@operationType == "PROMO" || k.@operationType == "MANAGER" || k.@operationType == "CREW" || k.@operationType == "WASTE" ){
						qty   -= aux;
					}
				}
			sumProductsQTY+= qty;;
			}
		
		}
	}		
	return sumProductsQTY;
	}
	
	
	//this function calculate the GPR& and UPT relative to the total of a given local family
	function calculateUPT(linerpt_array, totalQtySold, totalAmountSold)
	{
	   for (var i=0; i<Number(linerpt_array.length);i++)
	   {
	     
		    var infomation = new Array();
			information = linerpt_array[i].text.split(","); 
			if(Number(information[2]) >0)
		    {
				var valueUPT = (1000/qtdTCs)*information[2];
				var valueGPR = information[2] *100/ totalQtySold;
				//print the line
				addLineUPTNew(false, information[0], information[2], information[1], valueGPR, valueUPT);
			}
	   }
	}
	
	//add a upt line to the report
	function addLineUPTNew(bold, name, qty, amount, gpr, upt)
	{
		var line = API.setOnLeft(String(name).substring(0, 6),7) + API.setOnRight(API.formatNumber(Number(qty), "###0", 8), 8) + API.setOnRight(API.formatNumber(Number(amount), "###0.00", 8), 8) + API.setOnRight(API.formatNumber(Number(gpr), "###0.0", 8), 9) + API.setOnRight(API.formatNumber(Number(upt), "###0", 4), 7);
		if(bold == true )
		{
			addBoldLine(line);
		}
		else
		{
			addLine(line);
		}
	}


	/**
	 * Adds an operation line like this:
	 * "           name,amount,sold "
           * We cannot print the line until we have the total for a family. Only then we can calculate the GPR and UPT for that product. We store the product in this array "				
       * @param array for put a format line
	 * @param name product
 	 * @param amount
	 * @param sold 	 	 
	 */ 
	function addLineArray(linerpt_array, name, amount, sold) 
	{
	   var line = name +","+amount+","+sold;
       linerpt_array.push({text:String(line)});
	}

	/*
         Start region for function used in case of a UPT-Hr report 
         we must take the information from horulysale not from rootPmix in this case		 
	*/
    
    //this function will build the pmix based on the information from hourly sale	
	//flag= true for products
	//flag  = false for non products
    function buildPmixHourly(flag)
	{
	   var pmixHourly = new XML("<Products/>");
		//nodesbegTime is generated  in the switch section
		for each (begTime in nodesbegTime) {
		   xmlSales = rootHourlySales.StoreTotal.Sales.(@id==begTime.@id);
		   for each (sale in xmlSales)
		   {
		      for each (var product in sale.Product)
		      {
			     if(flag ==true)
				 { 
				    if( searchProduct(product.@id, rootProducts) == true)  //test if this is a product
					{
						pmixHourly.appendChild(product);
					}
				 }
				 else //for non produts
				 {
				    if( searchProduct(product.@id, rootNonProducts) ==true) //test if this is non product
					{
						pmixHourly.appendChild(product);
					}
				 }
				 
			  }
		   }
		}
	   return pmixHourly;
	}

	//search if a product is alimentaire or nonalimentaire
	function searchProduct(prodcutID, rootProducts)
	{
		for each (i in rootProducts)
		{
			var nodeProduct = i.Product;
			for each (j in nodeProduct) 
			{
			   if(j.@id == prodcutID)
			   {
			     return true;
			   }
			}
		}
		return false;		
	}
	
	//this function will calulate the amount the qtsold, qtpromo, qtwst, and qtCrewMeal for a given product
    //in doing this the function will use a specially build xml from hourly sales	
    function sumProduct(productID, pmixHourly)
    {
	    amount =0;
		qtsold =0;
		qtprom =0;
		qtwst  =0;
		qtcrew =0;
	    var xmlPmix = new XML(pmixHourly);
        var products =  xmlPmix.Product.(@id==productID);
		
		for each (var product in products)
		{
		   for each (k in product.OperationType)
		   {    
		        flagUpt = true;
				var aux = Number(k.PMix.@netAmount);
				var qtdInOut =  Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut);
				var nodesprice = k.Price;
				
				if(k.@operationType == "REFUND")
				{
					amount  -= aux;
					qtdsold -= qtdInOut;
				}						
				else
				{
					amount   += aux;
				}

				if((k.@operationType == "MANAGER") || (k.@operationType == "CREW")){
					qtdsold -= 0;
					qtcrew  += qtdInOut; 
					amount  -= aux;						
				}
				
				if(k.@operationType == "PROMO")
				{
					amount  -= aux;		
					qtdprom += qtdInOut;		   				
				}
							
				if(k.@operationType == "WASTE")
				{
					qtdwst += qtdInOut;		   				
				}
				if((k.@operationType == "SALE") || (k.@operationType == "DISCOUNT"))
				{
					 qtdsold += qtdInOut;
				}
			}
		}
    }	
	
	/*
        END egion for function used in case of a UPT-Hr report 
         */
}



/**
 * PRIVATE
 * This function implements a generic PMix UPT report
 * Needed data types: CASH, PMIX
 * @author Celso
 */
function genericPMixUPT(config, data, root, reportType) 
{

	var pod = rootCash.@requestPod;
	var title;
	var uptHour = "";
	
	lineRpt_array = new Array();
	
	var qtdTCDiscard = rootCash.CashStatistics.SaleType.OperationKind.(@id=="MANAGER" || @id=="CREW" ).CashTotals.Cash;//.@tc
	var qtdTCs		 = rootCash.CashTotals.Cash.@tc
	if(notCount100ValueMealGC == true)
	{
		qtdTCs = qtdTCs - summNodesAttributeValues(qtdTCDiscard,"tc");
	}
	
	switch(reportType) {
    case RPTPMIXUPTBYDATE:
   	   	 title = "P.Mix(x1000)";
   	   	 break;
    case RPTPMIXUPTBYHOUR:
	   	 title = "P.Mix(x1000)-Hr";
		 uptHour = root.@requestTime.substring(0, 2);
		 
		 if(uptHour==""){
			uptHour = "00";
		 }	 		 
		 var nodesbegTime = rootHourlySales.DayPartitioning.Segment.(@begTime.substring(0,2)==uptHour);
		 qtdTCs=0;
		 for each (begTime in nodesbegTime) {
		 	if(String(rootHourlySales.StoreTotal.Sales.(@id==begTime.@id).Product.OperationType.(@operationType=="MANAGER" || @operationType=="CREW" )) == ""){
				qtdTCs += Number(rootHourlySales.StoreTotal.Sales.(@id==begTime.@id).@tc);
			}
		 }
       	 break;			
    case RPTPMIXUPTBYDATESW:
    	 title = "P.Mix(x1000)";
    	 break;
    case RPTPMIXUPTBYHOURSW:    
		 title = "P.Mix(x1000)-Hr";
		 uptHour = root.@requestTime.substring(0, 2);
		 
		 if(uptHour==""){
			uptHour = "00";
		 }	 		 
		 var nodesbegTime = rootHourlySales.DayPartitioning.Segment.(@begTime.substring(0,2)==uptHour);
		 qtdTCs=0;
		 for each (begTime in nodesbegTime) {
//		 	if(String(rootHourlySales.StoreTotal.Sales.(@id==begTime.@id).Product.OperationType.(@operationType=="MANAGER" || @operationType=="CREW" )) == ""){
			if(rootHourlySales.StoreTotal.Sales.(@id==begTime.@id).Product.OperationType.(@operationType=="MANAGER" || @operationType=="CREW" ).length() == 0){			
				qtdTCs += Number(rootHourlySales.StoreTotal.Sales.(@id==begTime.@id).@tc);
			}
		 }
		 
       	 break;
    default:
   	     title = "ERROR";
       	 break;
	}
	
	addHeader(rootCash, title, reportType);
	if(uptHour!=""){	 
		 addLine(center("Hour Fm "+ uptHour +":00 To " + (Number(uptHour)+1) + ":00"));
		 addLine();
	}

	if 	(qtdTCs == 0){
		addLine(center("No Data for the date requested"));
		addLine();
		addFooter(rootCash);
		return;
	}
	
	// Body of Report 
	addLine("No. OF TCs:       " + qtdTCs);	
	addLine("Item Code");                             
	addLine("           Sales       CT           UPT");              
	
	var	sumAmount   = 0;
	var	sumQtdSold  = 0;
	var	sumValueUpt = 0;
	
	var rootProducts = root.FamilyGroup.(@groupName != "GIFT_COUPON");
	if(rootProducts.length()){
		for each (i in rootProducts) {
			var nodeProduct = i.Product;

			for each (j in nodeProduct) {
				var idProd = j.@id;
				var name 		 = rootPmix.ProductTable.ProductInfo.(@id == idProd).@name;
				var eatinPrice   = j.@eatinPrice;
				var takeoutPrice = j.@takeoutPrice;
				var otherPrice   = j.Product.@otherPrice;
				var rootOperationType = j.OperationType;
				var qtdsold 	= 0;
				var qtdprom 	= 0;
				var qtdwst		= 0;
				var amount 		= 0;
				var qtdInOut 	= 0;
				var flagUpt 	= false;	
				
				for each (k in rootOperationType) {
					var aux = 0;
					if(uptHour!=""){
						var nodesprice = k.Price;
						for each (price in nodesprice){
							if(price.@saleTime == uptHour){
								flagUpt = true;
								aux = Number(String(price.PMix.@netBeforeDiscountEatIn)=="" ? price.PMix.@netAmtEatIn : price.PMix.@netBeforeDiscountEatIn);
								aux += Number(String(price.PMix.@netBeforeDiscountTakeOut)=="" ? price.PMix.@netAmtTakeOu : price.PMix.@netBeforeDiscountTakeOut);							
								aux += Number(String(price.PMix.@netBeforeDiscountOther)=="" ? price.PMix.@netAmtOther : price.PMix.@netBeforeDiscountOther);								
								
								qtdInOut += Number(price.PMix.@qtyEatIn) + Number(price.PMix.@qtyTakeOut) + Number(price.PMix.@qtyOther);
							}
						}
					}
					else{
						flagUpt = true;
						aux = Number(String(k.PMix.@netBeforeDiscountEatIn)=="" ? k.PMix.@netAmtEatIn : k.PMix.@netBeforeDiscountEatIn);
						aux += Number(String(k.PMix.@netBeforeDiscountTakeOut)=="" ? k.PMix.@netAmtTakeOu : k.PMix.@netBeforeDiscountTakeOut);							
						aux += Number(String(k.PMix.@netBeforeDiscountOther)=="" ? k.PMix.@netAmtOther : k.PMix.@netBeforeDiscountOther);								
						
						qtdInOut = Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
					}
				
					if(k.@operationType == "REFUND"){
						amount  -= aux;
						if((uptHour!="") && (flagUpt == true)){
		   				 	qtdsold -= Number(price.PMix.@qtyEatIn) + Number(price.PMix.@qtyTakeOut) + Number(price.PMix.@qtyOther);
		   				 }	
		   				else{
							qtdsold -= Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);		   				
		   				}
					}
					else{
						amount   += aux;
//						qtdInOut = Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);
					}

					if((k.@operationType == "MANAGER") || (k.@operationType == "CREW")){
						qtdsold -= 0;
						amount  -= aux;						
					}
					
					if(k.@operationType == "PROMO"){
						amount  -= aux;						 
						if((uptHour!="") && (flagUpt == true)){
		   				 	qtdprom += Number(price.PMix.@qtyEatIn) + Number(price.PMix.@qtyTakeOut) + Number(price.PMix.@qtyOther);
		   				} 
		   				else{
							qtdprom += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);		   				
		   				}
					}
					
					if(k.@operationType == "WASTE"){
						if((uptHour!="") && (flagUpt == true)){
		   				 	qtdwst += Number(price.PMix.@qtyEatIn) + Number(price.PMix.@qtyTakeOut) + Number(price.PMix.@qtyOther);
		   				}
		   				else{
							qtdwst += Number(k.PMix.@qtyEatIn) + Number(k.PMix.@qtyTakeOut) + Number(k.PMix.@qtyOther);		   				
		   				}
					}
					if((k.@operationType == "SALE") || (k.@operationType == "DISCOUNT")){
	    				 qtdsold += qtdInOut;
					}
				}
			
				if(flagUpt == true){
					var valueUpt = (1000/qtdTCs)*qtdsold;
					addLineArray(lineRpt_array, idProd, name, amount, qtdsold,  valueUpt);
					
					sumAmount   += amount;
					sumQtdSold  += qtdsold;
					sumValueUpt += valueUpt;
				}
			}
		}
	}
	
	addLineUPT(lineRpt_array);
	
	addLine("TOT. GENERAL:");
	// 10: sep. 6: name, 4: sep, 3: sold, 5: sep, 7: value
	var line = "        "
	+ API.setOnRight(API.formatNumber(Number(sumAmount), "###0.00", 8), 8)
	+ "    "
	+ API.setOnRight(sumQtdSold, 5)
	+ "      "
	+ API.setOnRight(API.formatNumber(Number(sumValueUpt), "###0.00", 8), 8)

	addLine(line);
	
	addLine();
	addFooter(rootCash);
	
	return;
	
	function addLineUPT(linerpt_array) 
	{
		linerpt_array.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));})		
		for(var i = 0; i < linerpt_array.length; i++) {
			addLine(String(linerpt_array[i].text));
		}
	}

	/**
	 * Adds an operation line like this:
	 * "            Sales       CT           UPT "
     * "3 CHB   								 "				
     * "     0.79        1        200.00         "
     * @param array for put a format line
     * @param id product
	 * @param name product
 	 * @param amount
	 * @param sold
	 * @param upt	 	 	 
	 */
	function addLineArray(linerpt_array, id, name, amount, sold,  upt) 
	{
	
		var line = API.setOnRight(id, 6) + " " + API.setOnLeft(String(name).substring(0, 6),6) + "\n";
		line += "        "
		+ API.setOnRight(API.formatNumber(Number(amount), "###0.00", 8), 8)
		+ "    "
		+ API.setOnRight(sold, 5)
		+ "      "
		+ API.setOnRight(API.formatNumber(Number(upt), "###0.00", 8), 8);
		
		linerpt_array.push({id:Number(id), text:String(line)});
	}
}

/* Finish function implements a generic PMIX UPT report */

/**
 * PUBLIC
 * Responsible for formating the Products Active List report.
 * Needed data types: CASH, PRODS
 * @author Celso Fernandes
 */
function reportProdActiveList(config, data) 
{
//	 Active Products List
//   * PRODS (Versao light e sem produtos inativos)
//   * PRODSFULL (Versao full e sem produtos inativos)
//   * PRODUCTDB (product-db.xml completo)
//   * NAMESDB (names-db.xml completo)

	round_array = new Array();
	round_array.push({id:0, text:"ROUND_UP"});
	round_array.push({id:1, text:"ROUND_DOWN"});
	round_array.push({id:2, text:"ROUND_CEILING"});
	round_array.push({id:3, text:"ROUND_FLOOR"});
	round_array.push({id:4, text:"ROUND_HALF_UP"});
	round_array.push({id:5, text:"ROUND_HALF_DOWN"});
	round_array.push({id:6, text:"ROUND_HALF_EVEN"});
	
	if(init(config, data, Array("CASH", "PRODS"), "PACTL") != 0){
		return getResponse();
	}	
	
	var pod = rootCash.@requestPod;
	addHeader(rootCash, "Product list - Active Only", RPTDUMMY);
	
	// Body of Report 
	addLine();
	addLine("        Tax Table");
	addLine("Index Rd Rate");

	for each (i in rootProduct.TaxTable.TaxType){
		var j = 0;	
		while (round_array[j].text != i.Rounding) j++;
		addLine("   " + API.formatNumber(Number(i.TaxId), "00", 2) + "  " + API.formatNumber(Number(round_array[j].id), "00", 2) + "  " + API.formatNumber(Number(i.TaxRate), "#0.00000", 8));
	}
	
	addLine();
	addLine();	
	addLine("        Product list");
	addLine();	
	addLine("Code  Product       ET TT   E.Pr   T.Pr");
	
	for each (i in rootProduct.ProductInfo){
		if(Number(i.@id) < 10000000)
			addLineArray(i.@id, i.@shortName, i.PriceList.Pricing.(@priceCode=="EATIN").@entry, i.PriceList.Pricing.(@priceCode=="TAKEOUT").@entry,  i.PriceList.Pricing.(@priceCode=="EATIN").@price, i.PriceList.Pricing.(@priceCode=="TAKEOUT").@price);
	}

	addLine();
	addFooter(rootCash);

	return getResponse();
	
	function addLineArray(id, name, et, tt,  epr, tpr)
	{

		var line = API.setOnRight(id, 5)
		+ " "
		+ API.setOnLeft(String(name).substring(0, 12),12)
		line += "  "
		+ API.setOnRight(API.formatNumber(Number(et), "00", 2), 2)
		+ " "
		+ API.setOnRight(API.formatNumber(Number(tt), "00", 2), 2)
		+ "  "
		+ API.setOnRight(API.formatNumber(Number(epr), "#0.00", 5), 5)
		+ "  "
		+ API.setOnRight(API.formatNumber(Number(tpr), "#0.00", 5), 5);
		
		addLine(line);
	}
	
};
/* Finish function implements a generic Products report */

/**
 * PUBLIC
 * Responsible for formating the Sale FCR report.
 * Needed data types: CASH, PMIX
 * @author Celso Fernandes
 */
function reportSaleFc(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "HOURLYSALES"), "RSLFC") != 0) {
		return getResponse();
	}	

	var root = rootHourlySales;    		
	var posID = getPosId(); 
	if( Country == "FR" ) 	
	{
		genericSaleFR(config, data, root, RPTSALEFC);
	}
    else //other country then FR 
    {
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
		var displayNew =getConfigValue(storedbPath , posdbPath) =="true";
		if(displayNew)
		{
			genericSaleNew(config, data, root, RPTSALEFC);
		}
		else
		{
			genericSale(config, data, root, RPTSALEFC);
		}
	}			
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Sale FCR StoreWide report.
 * Needed data types: CASH, HOURLYSALES
 * @author Celso 
 */
function reportSaleFcSW(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "HOURLYSALES"), "SFCSW") != 0) {
		return getResponse();
	}	

	var root = rootHourlySales;       
	var posID = getPosId(); 
	if( Country == "FR" ) 	
	{
		genericSaleFR(config, data, root, RPTSALEFCSW);
	}
    else //other country the FR 
    {
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
		var displayNew =getConfigValue(storedbPath , posdbPath) =="true";
		if(displayNew)
		{
			genericSaleNew(config, data, root, RPTSALEFCSW);
		}
		else
		{
			genericSale(config, data, root, RPTSALEFCSW);
		}
	}				
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Sale Hour report.
 * Needed data types: CASH, HOURLYSALES
 * @author Celso Fernandes
 */
function reportSaleHourByDate(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "HOURLYSALES"), "SHRDT") != 0) {
		return getResponse();
	}	

	var root = rootHourlySales;    
	var posID = getPosId(); 
	if( (Country == "FR")) 	
	{
		genericSaleFR(config, data, root, RPTSALEHOURBYDATE);
	}
    else //other country then FR 
    {
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
		var displayNew =getConfigValue(storedbPath , posdbPath) =="true";
		if(displayNew)
		{
			genericSaleNew(config, data, root, RPTSALEHOURBYDATE);
		}
		else
		{
			genericSale(config, data, root, RPTSALEHOURBYDATE);
		}
	}			
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Sale Hour StoreWide report.
 * Needed data types: CASH, HOURLYSALES
 * @author Celso Fernandes
 */
function reportSaleHourByDateSW(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "HOURLYSALES"), "SHDSW") != 0) {
		return getResponse();
	}	

	var root = rootHourlySales;    	
	var posID = getPosId(); 
	if( (Country == "FR") && posID!= "N/A" && posID !=0) 	
	{
		genericSaleFR(config, data, root, RPTSALEHOURBYDATESW);
	}
    else //other country then FR
    {
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
		var displayNew =getConfigValue(storedbPath , posdbPath) =="true";
		if(displayNew)
		{
			genericSaleNew(config, data, root, RPTSALEHOURBYDATESW);
		}
		else
		{
			genericSale(config, data, root, RPTSALEHOURBYDATESW);
		}
	}		
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Sale Average Ticket By Date report.
 * Needed data types: CASH, HOURLYSALES
 * @author Celso Fernandes
 */
function reportSaleAveTckByDate(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "HOURLYSALES"), "SATKD") != 0) {
		return getResponse();
	}	

	var root = rootHourlySales    		
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
	var displayNew =getConfigValue(storedbPath , posdbPath) =="true";
	if(displayNew)
	{
		genericSaleNew(config, data, root, RPTSALEAVETKCDATE);
	}
	else
	{
		genericSale(config, data, root, RPTSALEAVETKCDATE);
	}
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Sale Average Ticket By Date StoreWide report.
 * Needed data types: CASH, HOURLYSALES
 * @author Celso Fernandes
 */
function reportSaleAveTckByDateSW(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("CASH", "HOURLYSALES"), "STDSW") != 0) {
		return getResponse();
	}	

	var root = rootHourlySales;    	

	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ActivateNewView\").@value";
	var displayNew =getConfigValue(storedbPath , posdbPath) =="true";
	if(displayNew)
	{
		genericSaleNew(config, data, root,RPTSALEAVETKCDATESW);
	}
	else
	{
		genericSale(config, data, root, RPTSALEAVETKCDATESW);
	}
	return getResponse();
};



function genericSaleFR(config, data, root, reportType) 
{
   	API.dbg("test rootpmixhoursale "+root);
	API.dbg("test rootcashhoursale "+rootCash);
 	var GIFT_CARD_5$	= "8492";
 	var GIFT_CARD_10$	= "8493";
 	var GIFT_CARD_25$	= "8494";
 	var GIFT_CARD_50$	= "8495";
	
	var RELOAD_GIFT_CARD_5$	 	= "8496";
 	var RELOAD_GIFT_CARD_10$	= "8497";
 	var RELOAD_GIFT_CARD_25$	= "8498";
 	var RELOAD_GIFT_CARD_50$	= "8499";
 	
 	var GIFT_CERT_1$	 = "936";
 	var GIFT_CERT_5$	 = "937"; 	

    var pod = rootCash.@requestPod;
	
	
	var beginHour			= "0800";
	var endHour 			= "0300";
	var beginFirstRushHour 	= "1130";
	var endFirstRushHour 	= "1430";
	var beginSecondRushHour = "1830";
	var endSecondRushHour   = "2130";
	var cutting 			= "60";
	var rushHourCutting 	= "15";
	API.dbg("section hourlysales "+xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="HourlySalesReport"));
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"BeginHour\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"BeginHour\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);

	API.dbg("value length " +Number(value.length));
	if(value != "")
	{
		var beginHour = value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"EndHour\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"EndHour\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value!="")
	{
		endHour 			= value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour1Begin\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour1Begin\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);

	if( value!="")
	{
		beginFirstRushHour 	= value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour1End\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour1End\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
    if(	value !="")
	{
		endFirstRushHour 	= value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour2Begin\").@value";
	var posdbPath = "onfiguration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour2Begin\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="")
	{
		beginSecondRushHour = value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour2End\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour2End\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="" )
	{
		endSecondRushHour   = value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"Cutting\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"Cutting\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="")
	{
		cutting 			=  value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHourCutting\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHourCutting\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="")
	{
		rushHourCutting			= value;
	}
	
	//test cuttings values
	if(Number(cutting) <= 0)
	{
	   cutting ="60";
	}
	if(Number(rushHourCutting) <= 0)
	{
	   rushHourCutting ="15";
	}
	
	//do the rounding for start end and rush hours to be multiple of 15
	var modulo = Number(beginHour.substring(2,4))%15
	if(modulo != 0)
	{
		beginHour = beginHour.substring(0,2) + (Number(beginHour.substring(2,4)) -modulo)+"";
	}
	modulo = Number(endHour.substring(2,4))%15;
	if(modulo != 0)
	{
		endHour = endHour.substring(0,2) + (Number(endHour.substring(2,4)) -modulo)+"";
	}
	modulo = Number(beginFirstRushHour.substring(2,4))%15
	if(modulo != 0)
	{
		beginFirstRushHour = beginFirstRushHour.substring(0,2) + (Number(beginFirstRushHour.substring(2,4)) -modulo)+"";
	}
	modulo = Number(endFirstRushHour.substring(2,4))%15
	if(modulo != 0)
	{
		endFirstRushHour = endFirstRushHour.substring(0,2) + (Number(endFirstRushHour.substring(2,4)) -modulo)+"";
	}
	modulo = Number(beginSecondRushHour.substring(2,4))%15
	if(modulo != 0)
	{
		beginSecondRushHour = beginSecondRushHour.substring(0,2) + (Number(beginSecondRushHour.substring(2,4)) -modulo)+"";
	}
	modulo = Number(endSecondRushHour.substring(2,4))%15
	if(modulo != 0)
	{
		endSecondRushHour = endSecondRushHour.substring(0,2) + (Number(endSecondRushHour.substring(2,4)) -modulo)+"";
	}
	
	
	
	switch(reportType) {
    case RPTSALEFC:
   	   	 title = API.getLocalMsg("MSG_RECEIPT_FCR_SALES_REPORT");
   	   	 break;
    case RPTSALEFCSW:
	   	 title = API.getLocalMsg("MSG_RECEIPT_FCR_SALES_REPORT");
       	 break;			
    case RPTSALEHOURBYDATE:
    	 title = API.getLocalMsg("MSG_RECEIPT_HOURLY_SALES");
    	 break;
    case RPTSALEHOURBYDATESW:    
		 title = API.getLocalMsg("MSG_RECEIPT_HOURLY_SALES");
       	 break;
    case RPTSALEAVETKCDATE:
    	 title = API.getLocalMsg("MSG_RECEIPT_AVG_TICKET");
    	 break;
    case RPTSALEAVETKCDATESW:    
		 title = API.getLocalMsg("MSG_RECEIPT_AVG_TICKET");
       	 break;
    default:
   	     title = "ERROR";
       	 break;
	}

	addHeader(rootCash, title, reportType);
	
	
	var currentHour
	var currentMin
	var stopHour    
	var stopMinutes 
	if(Number(beginHour) > Number(beginFirstRushHour)) //we need to go to 24 and then from 0 to end hour
	{
	   beginFirstRushHour = Number(beginFirstRushHour) +2400 +"";
	}
	if(Number(beginHour) >  Number(endFirstRushHour))	
	{
	   endFirstRushHour =  Number(endFirstRushHour) +2400 +"";
	}
	
	
	
	if(Number(beginHour) > Number(beginSecondRushHour)) //we need to go to 24 and then from 0 to end hour
	{
	   beginSecondRushHour =Number(beginSecondRushHour) + 2400 +"";
	}
	if(Number(beginHour) > Number(endSecondRushHour))
	{
	   endSecondRushHour = Number(endSecondRushHour) +2400 +"";
	}
	
	if(Number(beginHour) >= Number(endHour)) //we need to go to 24 and then from 0 to end hour
	{
	   
	   currentHour = beginHour.substring(0,2);
	   currentMin = beginHour.substring(2,4);
	   stopHour    = Number(endHour.substring(0,2)) +24;
	   stopMinutes = Number(endHour.substring(2,4));
	}
	else
	{
		currentHour = beginHour.substring(0,2);
		currentMin = beginHour.substring(2,4);
		stopHour    = Number(endHour.substring(0,2));
		stopMinutes = Number(endHour.substring(2,4));
	}
	if(Number(stopMinutes) <10)
	{
		endHour=  stopHour+ "0" +stopMinutes;
	}
	else
	{
		endHour=  stopHour+ "" +stopMinutes;
	}
	//add the header
	var flagFC = false;
	if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW))
	{
		addLine("|" +API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_HOUR"),19)+" |"+API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_FC"),15)+" |");
		addLine("|" +API.setOnLeft(" ",19) +" |"+ API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_TRANZACTION"),6) + API.setOnLeft(API.getLocalMsg("MSG_PMIX_PRODUCT_TOTSALES"),9));
		flagFC = true;
	}
	else
	{
		addLine("|" +API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_HOUR"),12)+" |  "+API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_FC"),9)+"|  "+API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_DT"),9))+" |";
		addLine("|" +API.setOnLeft(" ",12) +" | "+ API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_TRANZACTION"),4) + API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_TOTSALES"),6)  +"| "+API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_TRANZACTION"),4) +API.setOnRight(API.getLocalMsg("MSG_PMIX_PRODUCT_TOTSALES"),6));
	}
	var currentTime = beginHour;
	var crewAmount	=0;
	var notRushHourCutting = cutting;
	var flagRush= false;

	var totAmountFC=0;
	var totAmountDT=0;
	var totTranzFC=0;
	var totTranzDT=0;
	var tranzactionCrew =0; 
	var crewAmount = 0;
	while (Number(currentTime) < Number(endHour))
    {
	      if(isRushHour(currentTime)) //for rush hour we have another cutting
		  {
			cutting = rushHourCutting;
			flagRush=true;
		  }
		  else  //is not rush hour we have the default cutting
		  {
		    if(flagRush ==true) //we just exit the rush hour 
		    {
			    //we must add until the first multiple of the defautl cutting.
			    //DefualtCutting- (currentHour- beginbHour)%defaultcutting
				var hour1 	= currentTime.substring(0,2);
				var min1  	= currentTime.substring(2,4);
				var hour2 	= beginHour.substring(0,2);
				var min2	= beginHour.substring(2,4);
				
				var difference = Number(hour1-hour2)*60 +Number(min1-min2);
				cutting = Number(notRushHourCutting)- difference%Number(notRushHourCutting);
				flagRush=false;
			}
			else
			{
			   cutting = notRushHourCutting;
			}   
		  }

		  if(flagRush ==true) //we are in the rush hour we must be sure we do not pass the rush hour because of the cutting
		  {
		      cutting = substractTimeRush(currentTime,cutting);
		  }
		  else
		  {
		      cutting = substractTime(currentTime,cutting); //we must be sure we do not add to much, to pass the start of rush hour or the endHour
		  }
		  var currentMinutes = Number(currentTime .substring(2,4));
		  var currentHour = Number(currentTime .substring(0,2));
		  
		  var nextMinutes = (currentMinutes  + Number(cutting))%60;
		  var nextHour;
		  if((currentMinutes  + Number(cutting))/60 >=1)
		  {
			nextHour = Number(currentHour)+ 1;
		  }
		  else
		  {
			nextHour = currentHour;
		  }
		  //get the date for the current interval
		  var amountFC 		=0;
		  var tranzactionFC =0;
		  var amountDT 		=0;
		  var tranzactionDT =0;
		  getData(currentHour, currentMinutes, nextHour, nextMinutes);
		  if(flagFC == true)
		  {
			addReportLine(currentHour, currentMinutes, nextHour, nextMinutes, tranzactionFC, amountFC, null, null);
		  }
		  else
		  {
			addReportLine(currentHour, currentMinutes, nextHour, nextMinutes, tranzactionFC, amountFC, tranzactionDT, amountDT);
		  }
		  totAmountFC += Number(amountFC);
		  totAmountDT += Number(amountDT);
		  totTranzFC  += Number(tranzactionFC);
		  totTranzDT  += Number(tranzactionDT);
		  
		  currentHour = nextHour;
		  currentMinutes = nextMinutes; 
		  var stringHour = currentHour;
		  var stringMinutes = currentMinutes;
		  if(Number(currentHour) <10)
		  {
		     stringHour = "0"+currentHour;
		  }
		  if(Number(currentMinutes) <10)
		  {
			stringMinutes = "0" +currentMinutes;
		  }
		  currentTime = stringHour+ "" + stringMinutes;
		 
    }
    
	//add total line
	addLine();
	if(flagFC != true)
	{
	addBoldLine(API.setOnLeft(API.getLocalMsg("MSG_TOTAL"),16)+ API.setOnLeft(totTranzFC,4) +API.setOnLeft(API.formatNumber(Number(totAmountFC), "##0.00", 6),6) +"  "+ API.setOnLeft(totTranzDT,4) +API.setOnLeft(API.formatNumber(Number(totAmountDT), "##0.00", 6),6) );
	}
	else
	{
		addBoldLine(API.setOnLeft(API.getLocalMsg("MSG_TOTAL"),17)+"  "+ API.setOnLeft(totTranzFC,6) +"  " +API.setOnLeft(API.formatNumber(Number(totAmountFC), "####0.00", 9),9));
	}
	addLine();
	
	//get the number of crew meals
	var tranzactionCrew=0;
	var amountCrew =0;

	for each (sale in rootCash.CashStatistics.SaleType)
	{
		var operation = sale.OperationKind.(@id=="MANAGER" || @id=="CREW");
		for each (tranzaction in operation)
		{
			tranzactionCrew += Number(tranzaction.CashTotals.Cash.@tc);
			amountCrew += Number(tranzaction.CashTotals.Cash.@netBeforeDiscount);
		}
	}
	
	
	//crew information
	addLine (API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_CrewTC"),20) +" "+ API.setOnRight(tranzactionCrew,8));
	addLine (API.setOnLeft(API.getLocalMsg("MSG_HOURLYSALE_CrewAmount"),20) +" "+ API.formatNumber(Number(amountCrew), "####0.00", 8));
	addLine();
	
	addFooter(rootCash);
	return;
	
	function  addReportLine(currentHour, currentMinutes , nextHour, nextMinutes, tranzactionFC, amountFC, tranzactionDT, amountDT)
	{
	   //the next current or next hour can be greater then 24 due to the logic in the while
	   if(currentHour >=24)
	   {
	     currentHour -=24;
	   }
	   if(nextHour >=24)
	   {
	     nextHour -= 24;
	   }
	   
	   //formatting  hh:mm
	   if(currentHour <10)
	   {
	     currentHour= "0"+ currentHour;
	   }
	   if(currentMinutes <10)
	   {
	     currentMinutes = "0"+ currentMinutes;
	   }
	   if(nextHour <10)
	   {
	     nextHour= "0"+ nextHour;
	   }
	   if(nextMinutes <10)
	   {
	     nextMinutes = "0"+ nextMinutes;
	   }
	   
	   if(tranzactionDT == null)
	   {
	   addLine(API.setOnLeft((currentHour +":"+ currentMinutes +"-"+nextHour+":"+nextMinutes), 20) +"  "+ API.setOnLeft((tranzactionFC),6)+"  "+API.setOnLeft(API.formatNumber(Number(amountFC), "##0.00", 6), 9));
	   }
	   else
	   {
		addLine(API.setOnLeft((currentHour +":"+ currentMinutes +"-"+nextHour+":"+nextMinutes),16) + API.setOnLeft((tranzactionFC),4)+API.setOnLeft(API.formatNumber(Number(amountFC), "##0.00", 6), 6)+ "  " +API.setOnLeft(tranzactionDT, 4) + API.setOnLeft(API.formatNumber(Number(amountDT), "##0.00", 6),6));
	   }
	}
	
	function getData(startHour, startMinutes, endHour, endMinutes)
	{
	   var sales = root.POD.(@podShort=="FC").StoreTotal;
	   for each (var sale  in sales.Sales)
	   {
	      var saleStart = root.DayPartitioning.Segment.(@id==sale.@id).@begTime;
		  var saleEnd	= root.DayPartitioning.Segment.(@id==sale.@id).@endTime;
		  if(Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) > 0 && Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) < 100) //for local report
		  {
		     saleStart = (2400 * Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) +  Number(saleStart)) +"";
			 saleEnd = (2400 * Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) +  Number(saleEnd)) +"";
			 //API.dbg("if dayoffset=1 "+saleStart +" "+saleEnd );
		  }
		  var nodesPOS = rootCash.POS;
		  if(Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) !=1 && root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset !=getBusinessDate(nodesPOS) &&  getBusinessDate(nodesPOS) !="N/A" && Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) !=0)  //for consolidate report
		  {
		     
		     var offset = Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset.substring(6,8)) -Number(getBusinessDate(nodesPOS).substring(6,8)); 
		     saleStart = (Number(offset)  *2400 +  Number(saleStart)) +"";
			 saleEnd = (Number(offset) * 2400 +  Number(saleEnd)) +"";
			
		  }
		  if(testIn(startHour, startMinutes, endHour, endMinutes, saleStart.substring(0,2), saleStart.substring(2,4), saleEnd.substring(0,2), saleEnd.substring(2,4)) ==true ) //we have valid data
		  {
		  
	        if(sale.Product.@id !=GIFT_CARD_5$ && sale.Product.@id !=GIFT_CARD_10$ && sale.Product.@id !=GIFT_CARD_25$ && sale.Product.@id !=GIFT_CARD_50$ && sale.Product.@id !=RELOAD_GIFT_CARD_5$ && sale.Product.@id != RELOAD_GIFT_CARD_10$ && sale.Product.@id !=RELOAD_GIFT_CARD_25$ &&
			 sale.Product.@id !=RELOAD_GIFT_CARD_50$ && sale.Product.@id !=GIFT_CERT_1$ && sale.Product.@id !=GIFT_CERT_5$)
			{			 
			     amountFC +=  Number(sale.@productNetAmount);
				if(notCount100ValueMealGC == true)
				{
					tranzactionFC += Number(sale.@extTC);
				}
				else
				{
					tranzactionFC += Number(sale.@tc);
				}
				 /*
				 for each (product in sale.Product)
				 {
					 for each (k in product.OperationType)
					 {
						 if(k.@operationType =="MANAGER" || k.@operationType =="CREW")
						 {
							crewAmount += Number(k.PMix.@netBeforeDiscount);
							tranzactionCrew++;
							tranzactionFC--;
						 }
					}			 
				 }*/	
		    }
		  }
	   }
	   
	   var sales = root.POD.(@podShort=="DT").StoreTotal;
	   for each (var sale  in sales.Sales)
	   {
	      var saleStart = root.DayPartitioning.Segment.(@id==sale.@id).@begTime;
		  var saleEnd	= root.DayPartitioning.Segment.(@id==sale.@id).@endTime;
		  if(Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) > 0 && Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) < 100) //for local report
		  {
		     saleStart = (2400 * Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) +  Number(saleStart)) +"";
			 saleEnd = (2400 * Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) +  Number(saleEnd)) +"";
		  }
		  var nodesPOS = rootCash.POS;
		  if(Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) !=1 && root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset !=getBusinessDate(nodesPOS) &&  getBusinessDate(nodesPOS) !="N/A"  && Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffset) !=0 )  //for consolidate report
		  {
		     var offset = Number(root.DayPartitioning.Segment.(@id==sale.@id).@dayOffsets.substring(6,8)) -Number(getBusinessDate(nodesPOS).substring(6,8)); 
		     saleStart = (Number(offset) *2400 +  Number(saleStart)) +"";
			 saleEnd = (Number(offset) *2400 +  Number(saleEnd)) +"";
		  }
	      if(testIn(startHour, startMinutes, endHour, endMinutes, saleStart.substring(0,2), saleStart.substring(2,4), saleEnd.substring(0,2), saleEnd.substring(2,4)) ==true ) //we have valid data
		  {
		   if(sale.Product.@id !=GIFT_CARD_5$ && sale.Product.@id !=GIFT_CARD_10$ && sale.Product.@id !=GIFT_CARD_25$ &&sale.Product.@id !=GIFT_CARD_50$ && sale.Product.@id !=RELOAD_GIFT_CARD_5$ && sale.Product.@id != RELOAD_GIFT_CARD_10$ && sale.Product.@id !=RELOAD_GIFT_CARD_25$ &&
			 sale.Product.@id !=RELOAD_GIFT_CARD_50$ && sale.Product.@id !=GIFT_CERT_1$ && sale.Product.@id !=GIFT_CERT_5$)
				{	
			     amountDT +=  Number(sale.@productNetAmount);
				 if(notCount100ValueMealGC == true)
				 {
					tranzactionDT += Number(sale.@extTC);
				 }
				 else
				 {
					tranzactionDT += Number(sale.@tc);
				 }
				 /*
				 for each (product in sale.Product)
				 {
					for each (k in product.OperationType)
					{
		                 if(k.@operationType =="MANAGER" || k.@operationType =="CREW")
						 {
							crewAmount += Number(k.PMix.@netBeforeDiscount);
							tranzactionCrew++;
							tranzactionDT--;
						 }
					}
				}*/					
			  }
		  }
	   }
	}
	
	function testIn(startHour, startMinutes, endHour, endMinutes, currentHour, currentMinutes)
	{
	   if(Number(startHour) < Number(currentHour) && Number(endHour) > Number(currentHour))
	   {
	      return true;
	   }
	   if(Number(startHour) == Number(currentHour) && Number(startMinutes) <= Number(currentMinutes) && Number(endHour) > Number(currentHour))
	   {
	      return true;
	   }
	   if(Number(startHour) < Number(currentHour) && Number(endMinutes) > Number(currentMinutes) && Number(endHour) == Number(currentHour))
	   {
	      return true;
	   }
	   if(Number(startHour) == Number(currentHour) && Number(startMinutes) <= Number(currentMinutes) && Number(endMinutes) > Number(currentMinutes) && Number(endHour) == Number(currentHour))
	   {
	      return true;
	   }
	   return false;
	}
	
	function isRushHour(currentTime)
	{
	
	   if(Number(currentTime) >= Number(beginFirstRushHour) && Number(currentTime) < Number(endFirstRushHour) )
	   {
			return true;
	   }
	    if(Number(currentTime) >= Number(beginSecondRushHour) && Number(currentTime) < Number(endSecondRushHour) )
	   {
			return true;
	   }
	   return false;
	}
	
	//this function verify if we need a special cutting in order to arrive at the beging of a rush hour
	function substractTime(currentTime, currentCutting)
	{
	   
	   var hour = currentTime.substring(0,2);
	  
	   
	   var min  =currentTime.substring(2,4);
	   
	
	   
	   var rushHour1 = beginFirstRushHour.substring(0,2);
	   var rushMin1 = beginFirstRushHour.substring(2,4);
	   
	   var rushHour2 = beginSecondRushHour.substring(0,2);
	   var rushMin2 = beginSecondRushHour.substring(2,4);
	   
	   var endSHour = endHour.substring(0,2);
	   var endMin = endHour.substring(2,4);
	   	   
	   if(Number(rushHour1 -hour) == 1 || Number(rushHour1 - hour) == 0)
	   {
	      var difference = 0;
	      if(rushHour1 - hour ==1)
		  {
		    difference = 60 + Number(rushMin1) -Number(min);
		  }
		  else
		  {
		     difference = Number(rushMin1) -Number(min);
		  }
	      if(difference <= Number(currentCutting) && difference >0)
			return difference;
	   }
	   
	   if(Number(rushHour2 -hour) == 1 || Number(rushHour2 - hour) == 0)
	   {
	      var difference = 0;
	      if(rushHour2 - hour ==1)
		  {
		    difference = 60 + Number(rushMin2) -Number(min);
		  }
		  else
		  {
		     difference = Number(rushMin2) -Number(min);
		  }
	      if(difference <= Number(currentCutting) && difference > 0)
			return difference;
	   }
	   
	   if(Number(endSHour -hour) == 1 || Number(endSHour - hour) == 0)
	   {
	      var difference = 0;
	      if(endSHour - hour ==1)
		  {
		    difference = 60 + Number(endMin) -Number(min);
			API.dbg("endHour hourlysale "+difference);
		  }
		  else
		  {
		     difference = Number(endMin) -Number(min);
		  }
	      if(difference <= Number(currentCutting) && difference > 0)
			return difference;
	   }
	   
	   return currentCutting; //no need for a special cutting
	}

    function substractTimeRush(currentTime, currentCutting) //this is for checking if we pass the rush hour end or end hour (if we have in the rush hour interval)
	{
	   var hour = currentTime.substring(0,2);
	  
	   var min  =currentTime.substring(2,4);
	   
	   var rushHour1 = endFirstRushHour.substring(0,2);
	   var rushMin1 = endFirstRushHour.substring(2,4);
	   
	   var rushHour2 = endSecondRushHour.substring(0,2);
	   var rushMin2 = endSecondRushHour.substring(2,4);
	   
	   var endSHour = endHour.substring(0,2);
	   var endMin =endHour.substring(2,4);
	   
	 
	   //calcualte the difference in minutes betwen the currentTime and the end of firstRushHour
	   if(Number(rushHour1 -hour) == 1 || Number(rushHour1 - hour) == 0)
	   {
	      var difference = 0;
	      if(rushHour1 - hour ==1)
		  {
		    difference = 60 + Number(rushMin1) -Number(min);
		  }
		  else
		  {
		     difference = Number(rushMin1) -Number(min);
		  }
	      if(difference <= Number(currentCutting) && difference >0) //if current cutting is greater then the difference then we must change the cutting 
			return difference; 
	   }
	    //calcualte the difference in minutes betwen the currentTime and the end of secondRushHour
	   if(Number(rushHour2 -hour) == 1 || Number(rushHour2 - hour) == 0)
	   {
	      var difference = 0;
	      if(rushHour2 - hour ==1)
		  {
		    difference = 60 + Number(rushMin2) -Number(min);
		  }
		  else
		  {
		     difference = Number(rushMin2) -Number(min);
		  }
	      if(difference <= Number(currentCutting) && difference > 0) //if current cutting is greater then the difference then we must change the cutting 
			return difference;
	   }
	   //calcualte the difference in minutes betwen the currentTime and the end Hour
	   if(Number(endSHour -hour) == 1 || Number(endSHour - hour) == 0)
	   {
	      var difference = 0;
	      if(endSHour - hour ==1)
		  {
		    difference = 60 + Number(endMin) -Number(min);
		  }
		  else
		  {
		     difference = Number(endMin) - Number(min);
		  }
	      if(difference <= Number(currentCutting) && difference > 0) //if current cutting is greater then the difference then we must change the cutting 
			return difference;
	   }
	   
	   return currentCutting; //no need for a special cutting
	}	
}





/*
23.04.2010 Mihai Secareanu
This function adds the rush hour interval and different cuttings
*/
function genericSaleNew(config, data, root, reportType)
{
	API.dbg("test rootpmixhoursale "+root);
	API.dbg("test rootcashhoursale "+rootCash);
	
	
 	var GIFT_CARD_5$	= "8492";
 	var GIFT_CARD_10$	= "8493";
 	var GIFT_CARD_25$	= "8494";
 	var GIFT_CARD_50$	= "8495";
	
	var RELOAD_GIFT_CARD_5$	 	= "8496";
 	var RELOAD_GIFT_CARD_10$	= "8497";
 	var RELOAD_GIFT_CARD_25$	= "8498";
 	var RELOAD_GIFT_CARD_50$	= "8499";
 	
 	var GIFT_CERT_1$	 = "936";
 	var GIFT_CERT_5$	 = "937"; 	
 	
	var pod = rootCash.@requestPod;
	var title;
	
	var podDT = root.POD.(@podShort=="DT");
	var podWT = root.POD.(@podShort=="WT");
	var podFC = root.POD.(@podShort=="FC");
	
	var	podFCDT = root.StoreTotal;

	switch(reportType) {
    case RPTSALEFC:
   	   	 title = API.getLocalMsg("MSG_RECEIPT_FCR_SALES_REPORT");
   	   	 break;
    case RPTSALEFCSW:
	   	 title = API.getLocalMsg("MSG_RECEIPT_FCR_SALES_REPORT");
       	 break;			
    case RPTSALEHOURBYDATE:
    	 title = API.getLocalMsg("MSG_RECEIPT_HOURLY_SALES");
    	 break;
    case RPTSALEHOURBYDATESW:    
		 title = API.getLocalMsg("MSG_RECEIPT_HOURLY_SALES");
       	 break;
    case RPTSALEAVETKCDATE:
    	 title = API.getLocalMsg("MSG_RECEIPT_AVG_TICKET");
    	 break;
    case RPTSALEAVETKCDATESW:    
		 title = API.getLocalMsg("MSG_RECEIPT_AVG_TICKET");
       	 break;
    default:
   	     title = "ERROR";
       	 break;
	}

	addHeader(rootCash, title, reportType);
	
	
	
	var nodesNotGiftSalesSize	= podFCDT.Sales.Product.(@id!=GIFT_CERT_1$  &&
										  @id!=GIFT_CERT_5$  &&
										  @id!=GIFT_CARD_5$  &&
										  @id!=GIFT_CARD_10$ &&
										  @id!=GIFT_CARD_25$ &&
										  @id!=GIFT_CARD_50$ &&
										  @id!=RELOAD_GIFT_CARD_5$ &&
										  @id!=RELOAD_GIFT_CARD_10$ &&
										  @id!=RELOAD_GIFT_CARD_25$ &&
										  @id!=RELOAD_GIFT_CARD_50$
										  ).length();	
	var nodesSalesSize 	= podFCDT.Sales.length();
	var nodesSales 		= podFCDT.Sales;
//	if((nodesNotGiftSalesSize == 0) || (nodesSales.@extTC == 0)) {
	if(nodesSales.@TC == 0) {	
		addLine(center("No TCs for reporting"));              
		addLine();
		addFooter(rootCash);
		return;
	}
	// Body of Report 
	if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) ||
		(reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)) {	
		if(API.getLocalMsg("MSG_REPORT_HSA_HEADER1") != "MSG_REPORT_HSA_HEADER1")
		{		
			addLine(API.getLocalMsg("MSG_REPORT_HSA_HEADER1"));
		}
		else
		{
			addLine(" Time   T/C Prod Sale      A/C    ACCUM");
		}
		if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)) {
			if(API.getLocalMsg("MSG_REPORT_HSA_HEADER2") != "MSG_REPORT_HSA_HEADER2")
			{
				addLine("      "+API.getLocalMsg("MSG_REPORT_HSA_HEADER2")+"        ");  
			}
			else
			{
				addLine("      ORTM ASTM CATM      TOTM        ");
			}             
		}
	}
	else{
		if(API.getLocalMsg("MSG_REPORT_HSA_HEADER3") != "MSG_REPORT_HSA_HEADER3")
		{
			addLine(API.getLocalMsg("MSG_REPORT_HSA_HEADER3"));	
		}
		else
		{
			addLine(" Time   T/C      Sale  DT T/C   DT Sale");	
		}
	}

	//get the timmings
	var startTime			= "0800";
	var endTime 			= "0300";
	var startRushHour1 		= "1130";
	var endRushHour1	 	= "1430";
	var startRushHour2		= "1830";
	var endRushHour2	    = "2130";
	var defaultCutting		= "60";
	var rushHourCutting 	= "15";
	var consolidate			= false;
	var showEmptySegments   = false;  //default  not show empty segments
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"BeginHour\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"BeginHour\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);

	if(value != "")
	{
		var startTime = value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"EndHour\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"EndHour\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value!="")
	{
		endTime 			= value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour1Begin\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour1Begin\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);

	if( value!="")
	{
		startRushHour1 	= value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour1End\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour1End\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
    if(	value !="")
	{
		endRushHour1 	= value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour2Begin\").@value";
	var posdbPath = "onfiguration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour2Begin\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="")
	{
		startRushHour2 = value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour2End\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHour2End\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="" )
	{
		endRushHour2   = value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"Cutting\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"Cutting\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="")
	{
		defaultCutting 			=  value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHourCutting\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"RushHourCutting\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="")
	{
		rushHourCutting	= value;
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"Consolidate\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"Consolidate\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="")
	{
		consolidate	= value =="true";
	}
	
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ShowEmptySegments\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"HourlySalesReport\").Parameter.(@name==\"ShowEmptySegments\").@value";
	var value =""+ getConfigValue(storedbPath , posdbPath);
	if( value !="")
	{
		showEmptySegments	= value =="true";
	}
	
	//test cuttings values
	if(Number(defaultCutting) <= 0 || (Number(defaultCutting) !=15 && Number(defaultCutting) !=30 && Number(defaultCutting) !=45))
	{
	   defaultCutting ="60";
	}
	if(Number(rushHourCutting) <= 0 || (Number(rushHourCutting) !=15 && Number(rushHourCutting) !=30 && Number(rushHourCutting)!=45))
	{
	   rushHourCutting ="15";
	}
	
		
	//do the rounding for start end and rush hours to be multiple of 15
	var modulo = Number(startTime.substring(2,4))%15
	if(modulo != 0)
	{
		startTime = startTime.substring(0,2) + (Number(startTime.substring(2,4)) -modulo)+"";
		while(String(startTime).length <4)
		{
			startTime =startTime+"0";
		}
	}
	modulo = Number(endTime.substring(2,4))%15;
	if(modulo != 0)
	{
		endTime = endTime.substring(0,2) + (Number(endTime.substring(2,4)) -modulo)+"";
		while(String(endTime).length <4)
		{
			endTime =endTime+"0";
		}
	}
	var modulo = Number(startRushHour1.substring(2,4))%15
	if(modulo != 0)
	{
		
		startRushHour1 = startRushHour1.substring(0,2) + (Number(startRushHour1.substring(2,4)) -modulo)+"";
		while(String(startRushHour1).length <4)
		{
			startRushHour1 =startRushHour1+"0";
		}
	}
	modulo = Number(endRushHour1.substring(2,4))%15;
	if(modulo != 0)
	{
		endRushHour1 = endRushHour1.substring(0,2) + (Number(endRushHour1.substring(2,4)) -modulo)+"";
		while(String(endRushHour1).length <4)
		{
			endRushHour1 =endRushHour1+"0";
		}
	}
	var modulo = Number(startRushHour2.substring(2,4))%15
	if(modulo != 0)
	{
		startRushHour2 = startRushHour2.substring(0,2) + (Number(startRushHour2.substring(2,4)) -modulo)+"";
		while(String(startRushHour2).length <4)
		{
			startRushHour2 =startRushHour2+"0";
		}
	}
	modulo = Number(endRushHour2.substring(2,4))%15;
	if(modulo != 0)
	{
		endRushHour2 = endRushHour2.substring(0,2) + (Number(endRushHour2.substring(2,4)) -modulo)+"";
		while(String(endRushHour2).length <4)
		{
			endRushHour2 =endRushHour2+"0";
		}
	}

	if(endTime <= startTime)
	{
		endTime = Number(endTime) + 2400;
	}
	
	API.dbg("startTime: "+startTime)
	API.dbg("startRushHour1: "+startRushHour1)
	API.dbg("endRushHour1: "+endRushHour1)
	API.dbg("startRushHour2: "+startRushHour2)
	API.dbg("endRushHour2: "+endRushHour2)
	API.dbg("endTime: "+endTime)
	API.dbg("defaultCutting: "+defaultCutting)
	API.dbg("rushHourCutting: "+rushHourCutting)

	var cuttingValue = getCuttingValue(startTime, startRushHour1, endRushHour1, startRushHour2, endRushHour2, defaultCutting, rushHourCutting);  //get the initial cutting value
	var currentEndTime  = getEndTime(startTime, startRushHour1, endRushHour1, startRushHour2, endRushHour2, endTime);  //get the current interval end
	
	
	var totFCDT 		= 0;
	var totProdSaleFCDT = 0;
	var totTaxAmountFCDT= 0;
	var totDT 			= 0;
	var totProdSaleDT 	= 0;
	var totTaxAmountDT 	= 0;
	var totAccum		= 0;
	var showLine 		= 0; //default not show empty segments
	
	for(var currentTime = startTime; Number(currentTime) < Number(endTime); currentTime = addMinutes(currentTime,cuttingValue, currentEndTime))
	{
		cuttingValue = getCuttingValue(currentTime, startRushHour1, endRushHour1, startRushHour2, endRushHour2, defaultCutting, rushHourCutting); // get the cutting value for the current time
		var currentEndTime  = getEndTime(currentTime, startRushHour1, endRushHour1, startRushHour2, endRushHour2, endTime);  //get the current interval end
		
		var tcFCDT 			= 0;
		var netAmountFCDT 	= 0;
		var taxAmountFCDT 	= 0;
		
		var tcDT 			= 0;
		var netAmountDT 	= 0;
		var taxAmountDT 	= 0;
		
		var tcDiscard = 0;
		var netAmountDiscard = 0;
		var taxAmountDiscard = 0;
		if(showEmptySegments == true) //for showing always the segment
		{
			showLine = 1;
		}
		else
		{
			showLine  =0;
		}
		for(var i = 0; i < nodesSalesSize; i++)  //now we get the sale for the current required interval based on defined cutting interval
		{
			//get the segment time
			var nodeSales = nodesSales[i];
			var idHour   = nodeSales.@id;
			var fullHour = root.DayPartitioning.Segment.(@id == idHour).@begTime;
			var dayOffset = root.DayPartitioning.Segment.(@id == idHour).@dayOffset;
			if(dayOffset != "0" && (!consolidate || (consolidate == true && fullHour < startTime))) //if is in another calendaristic day and we should not group this interval them
			{
			 // or if the given segment does not exist in the current day (because the start time was to high) then we need to add the day offset 
			 
			 //in case of store wide reports the day offset will be the business day and we must calculate it
			 if((dayOffset+"").length == 8 ) //a business day
			 {
				dayOffset = calculateDayOffset(dayOffset+"",root.@requestDate+"");
			 }
				fullHour =  2400* dayOffset + Number(fullHour);
			}
			if(Number(fullHour) >= Number(currentTime) &&  Number(fullHour) < addMinutes(currentTime,cuttingValue) && Number(fullHour) < Number(currentEndTime))	
			{
				var nodesProduct = nodeSales.Product;
				var nodesProductSize = nodesProduct.length();
				//add data 
				for(var j = 0; j < nodesProductSize; j++) 
				{			
					var nodesOperationType = nodesProduct[j].OperationType;
					var nodesDiscardMgrCrew = nodesProduct[j].(@id!=GIFT_CERT_1$  &&
												  @id!=GIFT_CERT_5$  &&
												  @id!=GIFT_CARD_5$  &&
												  @id!=GIFT_CARD_10$ &&
												  @id!=GIFT_CARD_25$ &&
												  @id!=GIFT_CARD_50$ &&
												  @id!=RELOAD_GIFT_CARD_5$ &&
												  @id!=RELOAD_GIFT_CARD_10$ &&
												  @id!=RELOAD_GIFT_CARD_25$ &&
												  @id!=RELOAD_GIFT_CARD_50$
												  ).OperationType.(@operationType=="MANAGER" || @operationType=="CREW").PMix.(@netAmount=="0.00");

					if(nodesDiscardMgrCrew.length() != 0){
						netAmountDiscard += summNodesAttributeValues(nodesDiscardMgrCrew.PMix,"netAmount");
						taxAmountDiscard += summNodesAttributeValues(nodesDiscardMgrCrew.PMix,"taxAmount");
					}
				}
				if(notCount100ValueMealGC == true)
				{
					tcFCDT 		  += Number(nodeSales.@extTC);
				}
				else
				{
					tcFCDT 		  += Number(nodeSales.@tc);
				}
				netAmountFCDT += Number(nodeSales.@productNetAmount);
				taxAmountFCDT += Number(nodeSales.@productTaxAmount);
				
				var nodesDT = podDT.StoreTotal.Sales.(@id==idHour);
				var nodesWT = podWT.StoreTotal.Sales.(@id==idHour);
				
				if((String(nodesDT) != "") || (String(nodesWT) != ""))
				{
					if(String(nodesDT) != "")
					{
						if(notCount100ValueMealGC == true)
						{
							tcDT 		  += Number(nodesDT.@extTC);
						}
						else
						{
							tcDT 		  += Number(nodesDT.@tc);
						}
						netAmountDT   += Number(nodesDT.@productNetAmount);
						taxAmountDT   += Number(nodesDT.@productTaxAmount);
					}
					else 
					{
						if(notCount100ValueMealGC == true)
						{
							tcDT 		  += Number(nodesWT.@extTC);
						}
						else
						{
							tcDT 		  += Number(nodesWT.@tc);
						}
						netAmountDT   += Number(nodesWT.@productNetAmount);
						taxAmountDT   += Number(nodesWT.@productTaxAmount);
					}
				}
				
				if (tcFCDT < 0)
				{
					tcFCDT = 0;
				} 
				if(showEmptySegments == false)
				{
					showLine = tcFCDT;
				}
				
			}			
		}
		totAccum 	  	+= netAmountFCDT;
		totFCDT 		+= tcFCDT;
		totProdSaleFCDT += netAmountFCDT;
		totTaxAmountFCDT+= taxAmountFCDT;
		totDT 			+= tcDT;
		totProdSaleDT 	+= netAmountDT;
		totTaxAmountDT	+= taxAmountDT;
		
		
		//add report line for interval  currentTime- currentTime_cuttingValue
		var translateTime = currentTime;
		if(Number(translateTime) > 2400)
		{
			translateTime = translateTime - 2400;
		}
		//ensure that the time will always be 4 digit long
		while(String(translateTime).length <4)
		{
			translateTime ="0"+translateTime;
		}
		var hourAux = String(translateTime).substring(0,2);
		var minAux =  String(translateTime).substring(2,4);
		if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) || (reportType == RPTSALEFC) || (reportType == RPTSALEFCSW))
		{	
			(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "   " + API.formatNumber(netAmountFCDT, "###0.00", 7) + "  " +API.formatNumber(netAmountFCDT/tcFCDT, "###0.00", 7) + "  " + API.formatNumber(Number(totAccum), "###0.00", 7)):0;
			if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW))
			{
				(showLine >  0) ? addLine("        " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "        " + API.formatNumber(0, "00", 2)):0;
			}
		}
		else
		{
			if(Country == "PT")
			{
				(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT, "####0.00", 8)):0;
			}
			else
			{
				(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT+taxAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT+taxAmountDT, "####0.00", 8)):0;
			}
		}
	}
	
	addLine();
	
	if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) ||
		(reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){	
		(totFCDT >  0) ? addLine(" Total " + API.formatNumber(Number(totFCDT), "###0", 4) + "  " + API.formatNumber(Number(totProdSaleFCDT), "####0.00", 8) + " " +API.formatNumber(Number(totProdSaleFCDT/totFCDT), "####0.00", 8) + " " + API.formatNumber(Number(totAccum), "####0.00", 8)):0;
		if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){
			addLine("        " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "        " + API.formatNumber(0, "00", 2));
		}
		addLine();
	}
	else{
		if(Country == "PT")
		{
			(showLine >  0) ? addLine(" Total " + API.formatNumber(Number(totFCDT), "###0", 4) + " " + API.formatNumber(Number(totProdSaleFCDT), "#####0.00", 9)+ "    " + API.formatNumber(Number(totDT), "###0", 4) + " " + API.formatNumber(Number(totProdSaleDT), "#####0.00", 9)):0;	
		}
		else
		{
			(showLine >  0) ? addLine(" Total " + API.formatNumber(Number(totFCDT), "###0", 4) + " " + API.formatNumber(Number(totProdSaleFCDT+totTaxAmountFCDT), "#####0.00", 9)+ "    " + API.formatNumber(Number(totDT), "###0", 4) + " " + API.formatNumber(Number(totProdSaleDT+totTaxAmountDT), "#####0.00", 9)):0;	
		}		
		
		//MS 11.02.2009 there are two sale type (EAT IN and TakeOut)
		//the delevied version was wrong because it doesn't take account of both sale type.
		var brkFastSales =new BigDecimal("0.00");
		var brkFastTCs=0;
		for (var t=0; t<Number(rootCash.CashStatistics.SaleType.length()); t++)
		{
			brkFastTCs   =Number(brkFastTCs) + Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@tc);
			brkFastTCs   =Number(brkFastTCs) + Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@tc);
			
			if(Country == "PT")
			{
				//brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU" || @id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@netAmount));
			}
			else
			{
				//brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU" || @id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@netAmount));
				//brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU" || @id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@taxAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@taxAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@taxAmount));
			}
		}
		addLine(" Breakfast TCs:   " + API.formatNumber(brkFastTCs, "#######0", 8));	
		addLine(" Breakfast Sales: " + API.formatNumber(Number(brkFastSales), "#####0.0", 8));	
	}
	addFooter(rootCash);
	
	if(Country == "UK")
	{
		//add legend
		addLegend("MSG_REPORT_HSA_LEGEND");
	}
	
	return;


	function getCuttingValue(currentTime, startRushHour1, endRushHour1, startRushHour2, endRushHour2, defaultCutting, rushHourCutting)
	{
		if(currentTime < startRushHour1 || currentTime >= endRushHour2)
		{
			return defaultCutting;
		}
		if(currentTime >= startRushHour1 && currentTime < endRushHour1)
		{
			return rushHourCutting;
		}
		if(currentTime >= endRushHour1 && currentTime < startRushHour2)
		{
			return defaultCutting;
		}
		if(currentTime >= startRushHour2 && currentTime < endRushHour2)
		{
			return rushHourCutting;
		}
	}

	function getEndTime(currentTime, startRushHour1, endRushHour1, startRushHour2, endRushHour2, endTime)
	{
		if(currentTime < startRushHour1)
		{
			return startRushHour1;
		}
		if(currentTime >= startRushHour1 && currentTime < endRushHour1)
		{
			return endRushHour1;
		}
		if(currentTime >= endRushHour1 && currentTime < startRushHour2)
		{
			return startRushHour2;
		}
		if(currentTime >= startRushHour2 && currentTime < endRushHour2)
		{
			return endRushHour2;
		}
		if(currentTime >= endRushHour2)
		{
			return endTime;
		}
	}

	//always will return a four digit string
	function addMinutes(currentTime, cutting, currentEndTime)
	{
		//NOTE: we alsways must have the currentTime as a multiple of cuttings there for in some cases it is possbile to ned a different cutting for one interval untill we will acomplish this condition
			
		//ensure that current Time is on 4 digits
		while(String(currentTime).length < 4)
		{
			currentTime= "0"+currentTime;
		}

		var hour = String(currentTime).substring(0,2);
		var min =  String(currentTime).substring(2,4);
		
		//test if current time is a multiple of the current cutting
		var specialCutting = (hour*60 + min) % cutting;
		if(specialCutting !=0)  //we will need a different cutting just for this interval untill the multiply condition will be accomplished
		{
			cutting = cutting - specialCutting;
		}
		
		min = Number(min)+ Number(cutting);
		if(Number(min) >= 60)
		{
			hour = Number(hour)+1;
			if(String(hour).length <2)
			{
				hour ="0"+hour;
			}
		}
		min = Number(min) % 60;
		if(String(min).length <2)
		{
			min ="0"+min;
		}
		var newTime = hour+""+min;
		if(Number(newTime) > currentEndTime) //in case the current cutting will enter in the rush hour interval we must not alow this
		{
			return currentEndTime;
		}
		else
		{		
			return  hour+""+min;
		}
	}
	
	function calculateDayOffset(dayOffset, askedBusinessday)
	{
		if(dayOffset == askedBusinessday)
		{
			return 0;
		}
		else
		{
			var year1 = dayOffset.substring(0,4);
			var year2 = askedBusinessday.substring(0,4);
			
			var month1 = dayOffset.substring(4,6);
			var month2 = askedBusinessday.substring(4,6);
			
			var day1 = dayOffset.substring(6,8);
			var day2 = askedBusinessday.substring(6,8);
			
			var d1 = new Date(year1, month1, day1);
			var d2 = new Date(year2, month2, day2);

			var dif = d1.valueOf() - d2.valueOf();
			var offset = dif /(1000*24*3600);
			return toInt(offset);
		}
	}
}


/**
 * PRIVATE
 * This function implements a generic Sale report
 * Needed data types: CASH, HOURLYSALES
 * @author Celso Fernandes
 */
function genericSale(config, data, root, reportType) 
{
	//TODO Hermann: in dieser Methode bitten den Header anpassen und die SOS Zeiten hinzufgen, sobald feststeht welche bentigt werden. 
	API.dbg("test rootpmixhoursale "+root);
	API.dbg("test rootcashhoursale "+rootCash);
	
	
 	var GIFT_CARD_5$	= "8492";
 	var GIFT_CARD_10$	= "8493";
 	var GIFT_CARD_25$	= "8494";
 	var GIFT_CARD_50$	= "8495";
	
	var RELOAD_GIFT_CARD_5$	 	= "8496";
 	var RELOAD_GIFT_CARD_10$	= "8497";
 	var RELOAD_GIFT_CARD_25$	= "8498";
 	var RELOAD_GIFT_CARD_50$	= "8499";
 	
 	var GIFT_CERT_1$	 = "936";
 	var GIFT_CERT_5$	 = "937"; 	
 	
	var pod = rootCash.@requestPod;
	var title;
	
	var podDT = root.POD.(@podShort=="DT");
	var podWT = root.POD.(@podShort=="WT");
	var podFC = root.POD.(@podShort=="FC");
	
	var	podFCDT = root.StoreTotal;

	switch(reportType) {
    case RPTSALEFC:
   	   	 title = API.getLocalMsg("MSG_RECEIPT_FCR_SALES_REPORT");
   	   	 break;
    case RPTSALEFCSW:
	   	 title = API.getLocalMsg("MSG_RECEIPT_FCR_SALES_REPORT");
       	 break;			
    case RPTSALEHOURBYDATE:
    	 title = API.getLocalMsg("MSG_RECEIPT_HOURLY_SALES");
    	 break;
    case RPTSALEHOURBYDATESW:    
		 title = API.getLocalMsg("MSG_RECEIPT_HOURLY_SALES");
       	 break;
    case RPTSALEAVETKCDATE:
    	 title = API.getLocalMsg("MSG_RECEIPT_AVG_TICKET");
    	 break;
    case RPTSALEAVETKCDATESW:    
		 title = API.getLocalMsg("MSG_RECEIPT_AVG_TICKET");
       	 break;
    default:
   	     title = "ERROR";
       	 break;
	}
	
	//API.dbg("SOTEC Test before addHeader");
	addHeader(rootCash, title, reportType);
	//API.dbg("SOTEC Test after addHeader");
	
	
	var nodesNotGiftSalesSize	= podFCDT.Sales.Product.(@id!=GIFT_CERT_1$  &&
										  @id!=GIFT_CERT_5$  &&
										  @id!=GIFT_CARD_5$  &&
										  @id!=GIFT_CARD_10$ &&
										  @id!=GIFT_CARD_25$ &&
										  @id!=GIFT_CARD_50$ &&
										  @id!=RELOAD_GIFT_CARD_5$ &&
										  @id!=RELOAD_GIFT_CARD_10$ &&
										  @id!=RELOAD_GIFT_CARD_25$ &&
										  @id!=RELOAD_GIFT_CARD_50$
										  ).length();	
	var nodesSalesSize 	= podFCDT.Sales.length();
	var nodesSales 		= podFCDT.Sales;
//	if((nodesNotGiftSalesSize == 0) || (nodesSales.@extTC == 0)) {
	if(nodesSales.@TC == 0) {	
		addLine(center("No TCs for reporting"));              
		addLine();
		addFooter(rootCash);
		return;
	}
	// Body of Report 
	if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) ||
		(reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)) {
		if(API.getLocalMsg("MSG_REPORT_HSA_HEADER1") != "MSG_REPORT_HSA_HEADER1")
		{		
			addLine(API.getLocalMsg("MSG_REPORT_HSA_HEADER1"));
		}
		else
		{
			addLine(" Time   T/C Prod Sale      A/C    ACCUM");
		}
		if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)) {
			if(API.getLocalMsg("MSG_REPORT_HSA_HEADER2") != "MSG_REPORT_HSA_HEADER2")
			{
				addLine(API.getLocalMsg("MSG_REPORT_HSA_HEADER2")+"        ");  
			}
			else
			{
				addLine("      ORTM ASTM CATM      TOTM        ");
			}
		}
	}
	else{
		if(API.getLocalMsg("MSG_REPORT_HSA_HEADER3") != "MSG_REPORT_HSA_HEADER3")
		{
			addLine(API.getLocalMsg("MSG_REPORT_HSA_HEADER3"));	
		}
		else
		{
			addLine(" Time   T/C      Sale  DT T/C   DT Sale");	
		}
	}
	
	var tcFCDT 			= 0;
	var netAmountFCDT 	= 0;
	var taxAmountFCDT 	= 0;
	
	var tcDT 			= 0;
	var netAmountDT 	= 0;
	var taxAmountDT 	= 0;

	var totFCDT 		= 0;
	var totProdSaleFCDT = 0;
	var totTaxAmountFCDT= 0;
	var totDT 			= 0;
	var totProdSaleDT 	= 0;
	var totTaxAmountDT 	= 0;
	var totAccum		= 0;

	var hMin = 0;
	var hMax = 24;
	

	if(Country == "DE") {
		hMin = 0;
		hMax = hMin + 1;
	}
	for(var h = hMin; h < hMax; h++)
	{
		var getHour = false;
		for(var i = 0; i < nodesSalesSize; i++) {
			var nodeSales = nodesSales[i];
			var nodeProxSales = nodesSales[i+1];
			var idHour   = nodeSales.@id;
			var tcDiscard = 0;
			var netAmountDiscard = 0;
			var taxAmountDiscard = 0;
			var nodesProduct = nodeSales.Product;
			var nodesProductSize = nodesProduct.length();
			
			var fullHour = root.DayPartitioning.Segment.(@id == idHour).@begTime;
			var hour = String(fullHour).substring(0,2);
			var min	 = String(fullHour).substring(2,4);

			if(h == hour || Country == "DE")
			{
				getHour = true;
				for(var j = 0; j < nodesProductSize; j++) {			
					var nodesOperationType = nodesProduct[j].OperationType;
					var nodesDiscardMgrCrew = nodesProduct[j].(@id!=GIFT_CERT_1$  &&
												  @id!=GIFT_CERT_5$  &&
												  @id!=GIFT_CARD_5$  &&
												  @id!=GIFT_CARD_10$ &&
												  @id!=GIFT_CARD_25$ &&
												  @id!=GIFT_CARD_50$ &&
												  @id!=RELOAD_GIFT_CARD_5$ &&
												  @id!=RELOAD_GIFT_CARD_10$ &&
												  @id!=RELOAD_GIFT_CARD_25$ &&
												  @id!=RELOAD_GIFT_CARD_50$
												  ).OperationType.(@operationType=="MANAGER" || @operationType=="CREW").PMix.(@netAmount=="0.00");

					if(nodesDiscardMgrCrew.length() != 0){
						netAmountDiscard += summNodesAttributeValues(nodesDiscardMgrCrew.PMix,"netAmount");
						taxAmountDiscard += summNodesAttributeValues(nodesDiscardMgrCrew.PMix,"taxAmount");
					}
				}
				
				if(notCount100ValueMealGC == true)
				{
					tcFCDT 		  += Number(nodeSales.@extTC);
				}
				else
				{
					tcFCDT 		  += Number(nodeSales.@tc);
				}
				netAmountFCDT += Number(nodeSales.@productNetAmount);
				taxAmountFCDT += Number(nodeSales.@productTaxAmount);
				
				var nodesDT = podDT.StoreTotal.Sales.(@id==idHour);
				var nodesWT = podWT.StoreTotal.Sales.(@id==idHour);
				
				if((String(nodesDT) != "") || (String(nodesWT) != "")) {
					if(String(nodesDT) != "") {
						if(notCount100ValueMealGC == true)
						{
							tcDT 		  += Number(nodesDT.@extTC);
						}
						else
						{
							tcDT 		  += Number(nodesDT.@tc);
						}
						netAmountDT   += Number(nodesDT.@productNetAmount);
						taxAmountDT   += Number(nodesDT.@productTaxAmount);
					}
					else {
						if(notCount100ValueMealGC == true)
						{
							tcDT 		  += Number(nodesWT.@extTC);
						}
						else
						{
							tcDT 		  += Number(nodesWT.@tc);
						}
						netAmountDT   += Number(nodesWT.@productNetAmount);
						taxAmountDT   += Number(nodesWT.@productTaxAmount);
					}
				}

				var idProxHour   = 0;
				var fullProxHour = 0;
				var proxHour 	 = 0;
				var proxMin		 = 0;
				
				if(nodeProxSales != null){
					idProxHour   = nodeProxSales.@id;
					fullProxHour = root.DayPartitioning.Segment.(@id == idProxHour).@begTime;
					proxHour = String(fullProxHour).substring(0,2);
					proxMin	 = String(fullProxHour).substring(2,4);
				}
				
				if (tcFCDT < 0) {
					tcFCDT = 0;
				} 
				var showLine = tcFCDT;
				
				if((Number(min) >= 0) && (Number(min) <= 29) && (Country == "DE")){	
					
					var hourAux = hour;
					var minAux = "30";
					
					if(nodeProxSales != null){
						if((Number(proxMin) >= 30) && (Number(proxMin) <= 59) ||(hour != proxHour)){
							totAccum 	  	+= netAmountFCDT;
							totFCDT 		+= tcFCDT;
							totProdSaleFCDT += netAmountFCDT;
							totTaxAmountFCDT+= taxAmountFCDT;
							totDT 			+= tcDT;
							totProdSaleDT 	+= netAmountDT;
							totTaxAmountDT	+= taxAmountDT;
							if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) ||
								(reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){	
								(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "   " + API.formatNumber(netAmountFCDT, "###0.00", 7) + "  " +API.formatNumber(netAmountFCDT/tcFCDT, "###0.00", 7) + "  " + API.formatNumber(Number(totAccum), "###0.00", 7)):0;
								if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){
									(showLine >  0) ? addLine("        " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "        " + API.formatNumber(0, "00", 2)):0;
								}
							}
							else{
								if(Country =="PT")  //PT requested NET
								{
									(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT, "####0.00", 8)):0;
								}
								else
								{
									(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT+taxAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT+taxAmountDT, "####0.00", 8)):0;
								}
							}
							tcFCDT 		  = 0;
							netAmountFCDT = 0;
							taxAmountFCDT = 0;
							tcDT 		  = 0;
							netAmountDT   = 0;
							taxAmountDT	  = 0;
						}				
					}
					else{
						totAccum 	  	+= netAmountFCDT;
						totFCDT 		+= tcFCDT;
						totProdSaleFCDT += netAmountFCDT;
						totTaxAmountFCDT+= taxAmountFCDT;
						totDT 			+= tcDT;
						totProdSaleDT 	+= netAmountDT;
						totTaxAmountDT	+= taxAmountDT;
						if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) ||
							(reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){	
							(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT, "####0.00", 8) + " " +API.formatNumber(netAmountFCDT/tcFCDT, "####0.00", 8) + " " + API.formatNumber(Number(totAccum), "####0.00", 8)):0;
							if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){
								(showLine >  0) ? addLine("        " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "        " + API.formatNumber(0, "00", 2)):0;
							}
						}
						else{
							if(Country =="PT")  //PT requested NET
							{
								(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT, "####0.00", 8)):0;
							}
							else
							{
								(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT+taxAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT+taxAmountDT, "####0.00", 8)):0;
							}
						}
							tcFCDT 		  = 0;
							netAmountFCDT = 0;
							taxAmountFCDT = 0;
							tcDT 		  = 0;
							netAmountDT   = 0;
							taxAmountDT	  = 0;
					}
				}
				else{
					var hourAux   = hour;
					if(Country == "DE") {
						hourAux = ((Number(hour) + 1) >= 24)? "00" : String((Number(hour) + 1));
					}		
					
					var minAux = "00";
					if(nodeProxSales != null){
						var cond = false;
						if(Country == "DE") {
							cond = (Number(proxMin) >= 0) && (Number(proxMin) <= 29);
						}
						if(hour != proxHour || cond){					
							totAccum 	  	+= netAmountFCDT;
							totFCDT 		+= tcFCDT;
							totProdSaleFCDT += netAmountFCDT;
							totTaxAmountFCDT+= taxAmountFCDT;
							totDT 			+= tcDT;
							totProdSaleDT 	+= netAmountDT;
							totTaxAmountDT	+= taxAmountDT;
							if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) ||
								(reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){	
								(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT, "####0.00", 8) + " " +API.formatNumber(netAmountFCDT/tcFCDT, "####0.00", 8) + " " + API.formatNumber(Number(totAccum), "####0.00", 8)):0;
								if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){
									(showLine >  0) ? addLine("        " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "        " + API.formatNumber(0, "00", 2)):0;
								}
							}
							else{
							if(Country =="PT")  //PT requested NET
							{
								(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT, "####0.00", 8)):0;
							}
							else
							{
								(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT+taxAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT+taxAmountDT, "####0.00", 8)):0;
							}
							}
							tcFCDT 		  = 0;
							netAmountFCDT = 0;
							taxAmountFCDT = 0;
							tcDT 		  = 0;
							netAmountDT   = 0;
							taxAmountDT	  = 0;
						}
					}
					else{
						totAccum 	  	+= netAmountFCDT;
						totFCDT 		+= tcFCDT;
						totProdSaleFCDT += netAmountFCDT;
						totTaxAmountFCDT+= taxAmountFCDT;
						totDT 			+= tcDT;
						totProdSaleDT 	+= netAmountDT;
						totTaxAmountDT	+= taxAmountDT;
						if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) ||
							(reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){	
							(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT, "####0.00", 8) + " " +API.formatNumber(netAmountFCDT/tcFCDT, "####0.00", 8) + " " + API.formatNumber(Number(totAccum), "####0.00", 8)):0;
							if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){
								(showLine >  0) ? addLine("        " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "        " + API.formatNumber(0, "00", 2)):0;
							}
						}
						else{
							if(Country =="PT")  //PT requested NET
							{
								(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT, "####0.00", 8)):0;	
							}
							else
							{
								(showLine >  0) ? addLine(" " + API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + API.formatNumber(tcFCDT, "###0", 4) + "  " + API.formatNumber(netAmountFCDT+taxAmountFCDT, "####0.00", 8) + "    " + API.formatNumber(tcDT, "###0", 4) + "  " + API.formatNumber(netAmountDT+taxAmountDT, "####0.00", 8)):0;	
							}				
						}
							tcFCDT 		  = 0;
							netAmountFCDT = 0;
							taxAmountFCDT = 0;
							tcDT 		  = 0;
							netAmountDT   = 0;
							taxAmountDT	  = 0;
					}
				}
			}
		}

		if(!getHour && (Country != "DE"))
		{
			 addLine(" " + API.formatNumber(h, "00", 2) + ":00 " + API.formatNumber(0, "###0", 4) + "  " + API.formatNumber(0, "####0.00", 8) + "    " + API.formatNumber(0, "###0", 4) + "  " + API.formatNumber(0, "####0.00", 8));	
		}
		
	}
		
	addLine();
	
	if((reportType == RPTSALEHOURBYDATE) || (reportType == RPTSALEHOURBYDATESW) ||
		(reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){	
		(totFCDT >  0) ? addLine(" Total " + API.formatNumber(Number(totFCDT), "###0", 4) + "  " + API.formatNumber(Number(totProdSaleFCDT), "####0.00", 8) + " " +API.formatNumber(Number(totProdSaleFCDT/totFCDT), "####0.00", 8) + " " + API.formatNumber(Number(totAccum), "####0.00", 8)):0;
		if((reportType == RPTSALEFC) || (reportType == RPTSALEFCSW)){
			addLine("        " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "   " + API.formatNumber(0, "00", 2) + "        " + API.formatNumber(0, "00", 2));
		}
		addLine();
	}
	else{
		if(Country =="PT")  //PT requested NET
		{
			(showLine >  0) ? addLine(" Total " + API.formatNumber(Number(totFCDT), "###0", 4) + " " + API.formatNumber(Number(totProdSaleFCDT), "#####0.00", 9)+ "    " + API.formatNumber(Number(totDT), "###0", 4) + " " + API.formatNumber(Number(totProdSaleDT), "#####0.00", 9)):0;
		}
		else
		{
			(showLine >  0) ? addLine(" Total " + API.formatNumber(Number(totFCDT), "###0", 4) + " " + API.formatNumber(Number(totProdSaleFCDT+totTaxAmountFCDT), "#####0.00", 9)+ "    " + API.formatNumber(Number(totDT), "###0", 4) + " " + API.formatNumber(Number(totProdSaleDT+totTaxAmountDT), "#####0.00", 9)):0;
		}		
		
		//MS 11.02.2009 there are two sale type (EAT IN and TakeOut)
		//the delevied version was wrong because it doesn't take account of both sale type.
		var brkFastSales =new BigDecimal("0.00");
		var brkFastTCs=0;
		for (var t=0; t<Number(rootCash.CashStatistics.SaleType.length()); t++)
		{
			brkFastTCs   =Number(brkFastTCs) + Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@tc);
			brkFastTCs   =Number(brkFastTCs) + Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@tc);
			
			API.dbg("SOTEC Test before PT specific line");
			if(Country =="PT")  //PT requested NET
			{
				//API.dbg("SOTEC: brkFastSales " + brkFastSales );
				//API.dbg("SOTEC: rootCash.CashStatistics.SaleType[t].DayPart " + rootCash.CashStatistics.SaleType[t].DayPart );
				//API.dbg("SOTEC: BREAKFAST_MENU " + Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@netAmount));
				//API.dbg("SOTEC: BREAKFAST_DAY_MENU " +  Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				//API.dbg("SOTEC: BREAKFAST_DAY_MENU " +  Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU" || @id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				//API.dbg("SOTEC: brkFastSales.add " + brkFastSales.add(Number("1.00")) );
				//brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU" || @id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@netAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
			}
			else
			{
				//brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU" || @id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@netAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@netAmount));
				//brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU" || @id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@taxAmount));	
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_DAY_MENU").CashTotals.Cash.@taxAmount));
				brkFastSales = brkFastSales.add(Number(rootCash.CashStatistics.SaleType[t].DayPart.(@id=="BREAKFAST_MENU").CashTotals.Cash.@taxAmount));
			}
			//API.dbg("SOTEC Test after PT specific line");
		}
		addLine(" Breakfast TCs:   " + API.formatNumber(brkFastTCs, "#######0", 8));	
		addLine(" Breakfast Sales: " + API.formatNumber(Number(brkFastSales), "#####0.0", 8));	
	}
	
	API.dbg("SOTEC Test before addFooter");
	
	addFooter(rootCash);
	
	if(Country == "UK")
	{
		//add legend
		addLegend("MSG_REPORT_HSA_LEGEND");
	}
	return;
	
	function addLineUPT(linerpt_array) 
	{
		linerpt_array.sort(function compareNumbers(a,b){return (Number(a.id) - Number(b.id));})		
		for(var i = 0; i < linerpt_array.length; i++) {
			addLine(String(linerpt_array[i].text));
		}
	}

	/**
	 * Adds an operation line like this:
	 * "            Sales       CT           UPT "
     * "3 CHB   								 "				
     * "     0.79        1        200.00         "
     * @param array for put a format line
     * @param id product
	 * @param name product
 	 * @param amount
	 * @param sold
	 * @param upt	 	 	 
	 */
	function addLineArray(linerpt_array, id, name, amount, sold,  upt) 
	{
	
		var line = API.setOnRight(id, 6) + " " + API.setOnLeft(String(name).substring(0, 6),6) + "\n";
		line += "         "
		+ API.setOnRight(API.formatNumber(Number(amount), "###0.00", 8), 8)
		+ "    "
		+ API.setOnRight(sold, 5)
		+ "      "
		+ API.setOnRight(API.formatNumber(Number(upt), "###0.00", 8), 8);
		
		linerpt_array.push({id:Number(id), text:String(line)});
	}
}
/* Finish function implements a generic SALE report */


//##########################
// Report Speed Of Service
//##########################
/**
 * PUBLIC
 * Responsible for formating the Sale FCR report By Date.
 * Needed data types: CASH, SOS
 * @author Celso Fernandes
 */
function reportSosFc(config, data) 
{
	if(init(config, data, Array("CASH","SOS"), "RSSFC") != 0){
		return getResponse();
	}	
	
	genericSos(config, data, rootSOS, RPTSOSFC);	
	
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the DRIVE-THRU SALES REPORT - HOURLY.
 * Needed data types: CASH, SOS
 * @author Celso 
 */
function reportSosDTHourly(config, data) 
{
	if(init(config, data, Array("CASH","SOS"), "SDTHL") != 0){
		return getResponse();	
	}	
	
	genericSos(config, data, rootSOS, RPTSOSDTHOUR);	
	
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the DRIVE THRU DIAGNOSTIC REPORT.
 * Needed data types: CASH, SOS
 * @author Celso 
 */
function reportSosDTDiagnostic(config, data) 
{

 	if(init(config, data, Array("CASH","SOS"), "SDTDC") != 0){
		return getResponse();
	}	
	genericSos(config, data, rootSOS, RPTSOSDTDIAG);

	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the KVS TIMING REPORT FOR PRIMARY (MFY).
 * Needed data types: CASH, SOS
 * @author Celso 
 */
 function reportSosMfy(config, data) 
 {
 
 	if(init(config, data, Array("CASH","SOS"), "RSMFY") != 0){
		return getResponse();
	}	
	if(Country =="UK")
	{
		genericSosMfy(config, data, rootSOS, RPTSOSMFY);
	}
	else
	{
		genericSos(config, data, rootSOS, RPTSOSMFY);
	}	
	return getResponse();
};



function genericSosMfy(config, data, root, reportType) 
{
	var flagIsPROD = 0;
	var title;
	var posFC = root.POS.(@podShort=="FC");
	var posWT = root.POS.(@podShort=="WT");
	var posDT = root.POS.(@podShort=="DT");
	var	posFCDT = root.StoreTotals;

	
	orderTarget = root.PresetsTable.@orderTarget;
	lineTarget	= root.PresetsTable.@lineTarget;
	cashTarget	= root.PresetsTable.@cashTarget;
	totalTarget	= root.PresetsTable.@totalTarget;
	storeTarget	= root.PresetsTable.@storeTarget;
	holdTarget	= root.PresetsTable.@holdTarget;
	presentationTarget= root.PresetsTable.@presentationTarget;
	
	/*get break fast time*/
	var startBreakFastValue;
	var stopBreakFastValue;
	
	//test if weekend weekend
	var businessday = root.@requestDate;
	var date = new Date(businessday.substring(0,4),businessday.substring(4,6)-1, businessday.substring(6,8),0,0,0);
	var dayoftheweek = date.getDay();
	if(Number(dayoftheweek) == 0 || Number(dayoftheweek) == 6)
	{
		var storedbPath = "StoreDB.StoreProfile.BusinessLimits.BreakfastStartTimeWeekEnd";
		var posdbPath = "StoreDB.(@imports==\"all\").StoreProfile.BusinessLimits.BreakfastStartTimeWeekEnd";
		startBreakFastValue =""+ getConfigValue(storedbPath , posdbPath);
		
		var storedbPath = "StoreDB.StoreProfile.BusinessLimits.BreakfastStopTimeWeekEnd";
		var posdbPath = "StoreDB.(@imports==\"all\").StoreProfile.BusinessLimits.BreakfastStopTimeWeekEnd";
		stopBreakFastValue =""+ getConfigValue(storedbPath , posdbPath);	
	}
	else
	{
		var storedbPath = "StoreDB.StoreProfile.BusinessLimits.BreakfastStartTimeWeekDay";
		var posdbPath = "StoreDB.(@imports==\"all\").StoreProfile.BusinessLimits.BreakfastStartTimeWeekDay";
		startBreakFastValue =""+ getConfigValue(storedbPath , posdbPath);
		
		var storedbPath = "StoreDB.StoreProfile.BusinessLimits.BreakfastStopTimeWeekDay";
		var posdbPath = "StoreDB.(@imports==\"all\").StoreProfile.BusinessLimits.BreakfastStopTimeWeekDay";
		stopBreakFastValue =""+ getConfigValue(storedbPath , posdbPath);
	}
	
	API.dbg("startBreakFastValue " +startBreakFastValue+ " stopBreakFastValue "+ stopBreakFastValue);
	var startBreakfastHour = startBreakFastValue.split(":")[0];
	var startBreakfastMin = startBreakFastValue.split(":")[1];
	var stopBreakfastHour =stopBreakFastValue.split(":")[0];
	var stopBreakfastMin =stopBreakFastValue.split(":")[1];
	API.dbg("startBreakfastHour " +startBreakfastHour+ " startBreakfastMin "+ startBreakfastMin);
	API.dbg("stopBreakfastHour " +stopBreakfastHour+ " stopBreakfastMin "+ stopBreakfastMin);
	var startBreakFast = Number(startBreakfastHour*100) + Number(startBreakfastMin);
	var stopBreakFast =  Number(stopBreakfastHour*100) + Number(stopBreakfastMin);
	
	
	// Check if is production
	if((posFC.length()!=0) || (posDT.length()!=0) || (posWT.length()!=0)) {	
//   	if((posFC.length()!=0) || (PosDT.length()!=0)) {
   	 	flagIsPROD = 0   // Local 
   	}		
   	else{
   		flagIsPROD = 1   // Prod 
   	}

//#####################################	
// Header Section	
//#####################################	
	var  rootPos;
	switch(reportType) {
		case RPTSOSMFY:       	 
			 title = API.getLocalMsg("MSG_REPORT_SOS_MFY_TITLE");
			 rootPos = rootSOSMFY.StoreTotals;
			 break;		
			 
		default:
			 title = "ERROR";
			 break;
	}
	
	//addLine(SEP_DL);
	addHeader(rootCash, title, reportType);

	//table header
	addLine(API.getLocalMsg("MSG_REPORT_SOS_MFY_HEADER"));
		
	if 	(rootPos.ServiceTime.length() == 0) {
		addLine();
		addLine(center("No Data for the date requested"));
		addLine();
		addFooter(rootCash);
		addLegend("MSG_REPORT_SOS_MFY_LEGEND");
		return;
	}
	
	var FCtotProdSale	= 0;
	var FCtotTc			= 0;
	var FCtotAvc_ac		= 0;
	var FCovra			= 0;
	var FCpvtotl		= 0;
	var FCtotAccum		= 0;
	var FCot			= 0;
	var FCcash			= 0;
	var FCpnst			= 0;
	var FCtotl			= 0;
	
	
	var totAvc_ac		= 0;
	var totAccum		= 0;
	var totAccumTc		= 0;
	var totAccumcars	= 0;
	var totAccumtts		= 0;
	var totAccumhld		= 0;
	
	var podot			= 0;
	var podlt			= 0;
	var podcash			= 0;
	var podpnst			= 0;
	var podhold			= 0;
	
	var totot			= 0;
	var totlt			= 0;
	var totcash			= 0;
	var totpnst			= 0;
	var totovrp			= 0;
	var totovtotl		= 0;
	var tothld			= 0;
	var tothold			= 0;
	var totpvtotl		= 0;
	
	var mfytcBtot 		= 0;
	var mfysnBtot 		= 0;
	var mfyavgBtot 		= 0;
	var mfyttsBtot 		= 0;
	var mfyovr50Btot 	= 0;
	var mfyovr35Btot 	= 0;
	var mfyundr25Btot 	= 0;
	
	var mfytcDtot 		= 0;
	var mfysnDtot 		= 0;
	var mfyavgDtot 		= 0;
	var mfyttsDtot 		= 0;
	var mfyovr50Dtot 	= 0;
	var mfyovr35Dtot 	= 0;
	var mfyundr25Dtot 	= 0;
	
	var mfytctot 		= 0;
	var mfysntot 		= 0;
	var mfyavgtot 		= 0;
	var mfyttstot 		= 0;
	var mfyovr50tot 	= 0;
	var mfyovr35tot 	= 0;
	var mfyundr25tot 	= 0;
	
	
	var totProdSale	 	= 0;
	var totTc			= 0;
	var totcars			= 0;
	
	var untilTotal		= 0;
	var untilStore		= 0;
	var untilRecall		= 0;
	var untilPay		= 0;
	var untilCloseDrawer= 0;
	var untilServe		= 0;
	var itemsCount		= 0;
	
	var tcOverOrderPreset= 0;
	var tcOverLinePreset = 0;
	var tcOverCashPreset = 0;
	var tcOverPresentationPreset=0;
	var tcOverTotalPreset= 0;
	var tcOverStorePreset= 0;
	
	var heldTime		= 0;
	var undoTime		= 0;
	var tcUnder25		= 0;
	var tcOver50		= 0;
	var tcOver35		= 0 ; //add for UK
	var tcHeld			= 0;
	var hotTc			= 0;
	var hotUntilStore	= 0;
	var hotUntilRecall	= 0;
	var tcOverHoldPreset = 0;
	
	
	
	
	var indSegment = 0;
	var nodesDayPart 	= root.DayPartitioning.Segment;	
	var nodesDayPartSize= Number(nodesDayPart.length());
	
	addLine(SEP_SL);
	addLine(API.getLocalMsg("MSG_REPORT_SOS_MFY_BREAKFAST"));
	addLine(SEP_SL);
	addReportSection(startBreakFast,stopBreakFast,true) ; // for breakfast
	
	addLine(SEP_SL);
	addLine(API.getLocalMsg("MSG_REPORT_SOS_MFY_DAYMENU"));
	addLine(SEP_SL);
	addReportSection(startBreakFast,stopBreakFast,false) ; // for day menu

	addLine(SEP_SL);
	addLine(API.setOnLeft(API.getLocalMsg("MSG_REPORT_SOS_MFY_TOTAL"),13) + 
		API.formatNumber(mfytctot, "##0", 3) + " " + 
		API.formatNumber(mfysntot, "##0", 3) + "  " + 
		API.formatNumber(mfysntot/totAccumTc,"#0.00", 5) + " " + 
		API.formatNumber(mfyttstot/totAccumTc,"##0", 3) + " " + 
		API.formatNumber(mfyovr35tot,"##0", 3)+ " " + 
		API.formatNumber(mfyovr50tot,"##0", 3));
	addLine(SEP_SL);	
	addLine();
	addFooter(rootCash);
	addLegend("MSG_REPORT_SOS_MFY_LEGEND");
	
	return;
	
	/*sectionType: true for breakfast */
	function addReportSection(startBreakFast,stopBreakFast,sectionType)
	{
		//get all segment that we need
		var arrSegment = getSegments(startBreakFast, stopBreakFast,sectionType);
		var arrSegmentLength = 	arrSegment.length;	
		var j;
		for(j = 0 ; j<=23; j++) 
		{
			for(var t = 0 ; t < arrSegmentLength; t++)
			{		
				currentHour = (root.DayPartitioning.Segment.(Number(@id) == arrSegment[t]).@begTime).substring(0,2);
				if(Number(currentHour) == j)  //we found one
				{
					var nodeServiceTime = root.StoreTotals.ServiceTime.(@segmentId==arrSegment[t]);
					if(flagIsPROD == 0) {
						nodeServiceTime = root.StoreTotals.ServiceTime.(@id==arrSegment[t]);
					}
					totTc 		  		+= Number(nodeServiceTime.@tc);
					totProdSale   		+= Number(nodeServiceTime.@totalAmount);
					totcars   			+= Number(nodeServiceTime.@cars);
				
					untilTotal			+= Number(nodeServiceTime.@untilTotal)/1000;
					untilStore			+= Number(nodeServiceTime.@untilStore)/1000;
					untilRecall			+= Number(nodeServiceTime.@untilRecall)/1000;
					untilPay			+= Number(nodeServiceTime.@untilPay)/1000;
					untilCloseDrawer	+= Number(nodeServiceTime.@untilCloseDrawer)/1000;
					untilServe			+= Number(nodeServiceTime.@untilServe)/1000;
					
					itemsCount			+= Number(nodeServiceTime.@itemsCount);
								
					tcOverOrderPreset	+= Number(nodeServiceTime.@tcOverOrderPreset);
					tcOverLinePreset	+= Number(nodeServiceTime.@tcOverLinePreset);
					tcOverCashPreset	+= Number(nodeServiceTime.@tcOverCashPreset);
					tcOverPresentationPreset+= Number(nodeServiceTime.@tcOverPresentationPreset);
					tcOverTotalPreset	+= Number(nodeServiceTime.@tcOverTotalPreset);
					tcOverStorePreset	+= Number(nodeServiceTime.@tcOverStorePreset);
					
					undoTime			+= Number(nodeServiceTime.ProductionTime.@undoTime)/1000;
					heldTime			+= Number(nodeServiceTime.ProductionTime.@heldTime)/1000;
					tcUnder25			+= Number(nodeServiceTime.ProductionTime.@tcUnder25);
					tcOver50			+= Number(nodeServiceTime.ProductionTime.@tcOver50);
					tcOver35			+= Number(nodeServiceTime.ProductionTime.@tcOverTotalTimeMFY35); //for uk but is just a dummy value now
					tcHeld				+= Number(nodeServiceTime.ProductionTime.@tcHeld);
					
					hotTc				+= Number(nodeServiceTime.ProductionTime.@hotTc);
					hotUntilStore		+= Number(nodeServiceTime.ProductionTime.@hotUntilStore)/1000;
					hotUntilRecall		+= Number(nodeServiceTime.ProductionTime.@hotUntilRecall)/1000;
					tcOverHoldPreset 	+= Number(nodeServiceTime.ProductionTime.@tcOverHoldPreset);
					//add line to the report
				}
			}	
			var mfytc		= totTc;
			var mfysn		= itemsCount
			var mfyavg		= (totTc!=0)?mfysn/mfytc:0;
			var mfytts		= (totTc!=0)?untilServe/totTc:0;
			var mfyovr50	= tcOver50;
			var mfyovr35	= tcOver35; //for uk
			var mfyundr25	= tcUnder25;
			
			totAccumTc	+= totTc;
			totAccumtts	+= mfytts;

			//display the line only if is in the required interval
			if(shouldDisplay(j*100, startBreakFast, stopBreakFast, sectionType))
			{
				//add repor tline
				var time= getTimeInterval(j,startBreakFast, stopBreakFast, sectionType);
				addLine(time + "  " +API.formatNumber(mfytc, "##0", 3)+" "+
				API.formatNumber(mfysn, "##0", 3) + "  " + 		
				API.formatNumber(mfyavg, "#0.00", 5) + " " + 			
				API.formatNumber(mfytts,"##0", 3) + " " + 
				API.formatNumber(mfyovr35,"##0", 3)+ " " + 
				API.formatNumber(mfyovr50,"##0", 3));
			}
		
			//total numbers
			if(sectionType == true)
			{
				mfytcBtot 		+= totTc;
				mfysnBtot 		+= itemsCount;
				mfyavgBtot 		+= mfyavg;
				mfyttsBtot 		+= untilServe;			
				mfyovr50Btot 	+= Number(mfyovr50);
				mfyovr35Btot 	+= Number(mfyovr35);
				mfyundr25Btot 	+= mfyundr25;
			}
			else
			{
				mfytcDtot 		+= totTc;
				mfysnDtot 		+= itemsCount;
				mfyavgDtot 		+= mfyavg;
				mfyttsDtot 		+= untilServe;			
				mfyovr50Dtot 	+= Number(mfyovr50);
				mfyovr35Dtot 	+= Number(mfyovr35);
				mfyundr25Dtot 	+= mfyundr25;
			}
			mfytctot 		+= totTc;
			mfysntot 		+= itemsCount;
			mfyavgtot 		+= mfyavg;
			mfyttstot 		+= untilServe;			
			mfyovr50tot 	+= mfyovr50;
			mfyovr35tot 	+= mfyovr35;
			mfyundr25tot 	+= mfyundr25;
						
			//reset hour segments
			totAvc_ac		= 0;
			
			totProdSale	 	= 0;
			totTc			= 0;
			totcars			= 0;
		
			untilTotal		= 0;
			untilStore		= 0;
			untilRecall		= 0;
			untilPay		= 0;
			untilCloseDrawer= 0;
			untilServe		= 0;
			
			itemsCount		= 0;
			
			tcOverOrderPreset	= 0;
			tcOverLinePreset	= 0;
			tcOverCashPreset	= 0;
			tcOverPresentationPreset=0;
			tcOverTotalPreset	= 0;
			tcOverStorePreset	= 0;
		
			heldTime		= 0;
			undoTime		= 0;
			tcUnder25		= 0;
			tcOver50		= 0;
			tcOver35		= 0;
			tcHeld			= 0;
			hotTc			= 0;
			hotUntilStore	= 0;
			hotUntilRecall	= 0;
			tcOverHoldPreset = 0;
		}
		//add total line
		if(sectionType == true)
		{
			avgTTS= 0;
			if(mfyttsBtot !=0)
			{
				avgTTS= mfyttsBtot/mfytcBtot;
			}
			addLine();
			addLine(API.setOnLeft(API.getLocalMsg("MSG_REPORT_SOS_MFY_TARGET_AVG"),28)+API.formatNumber(totalTarget/1000, "##0", 3));
			addLine(API.setOnLeft(API.getLocalMsg("MSG_REPORT_SOS_MFY_PARTIAL_TOTAL"),13) +API.formatNumber(mfytcBtot, "##0", 3)+" "+
				API.formatNumber(mfysnBtot, "##0", 3) + "  " + 		
				API.formatNumber(mfyavgBtot, "#0.00", 5) + " " + 			
				API.formatNumber(avgTTS,"##0", 3) + " " + 
				API.formatNumber(mfyovr35Btot,"##0", 3)+ " " + 
				API.formatNumber(mfyovr50Btot,"##0", 3));
		}
		else
		{
			avgTTS= 0;
			if(mfyttsDtot !=0)
			{
				avgTTS= mfyttsDtot/mfysnDtot;
			}
			addLine();
			addLine(API.setOnLeft(API.getLocalMsg("MSG_REPORT_SOS_MFY_TARGET_AVG"),28)+API.formatNumber(totalTarget/1000, "##0", 3));
			addLine(API.setOnLeft(API.getLocalMsg("MSG_REPORT_SOS_MFY_PARTIAL_TOTAL"),13) +API.formatNumber(mfytcDtot, "##0", 3)+" "+
				API.formatNumber(mfysnDtot, "##0", 3) + "  " + 		
				API.formatNumber(mfyavgDtot, "#0.00", 5) + " " + 			
				API.formatNumber(avgTTS,"##0", 3) + " " + 
				API.formatNumber(mfyovr35Dtot,"##0", 3)+ " " + 
				API.formatNumber(mfyovr50Dtot,"##0", 3));
		}		
			
	}
	
	function getTimeInterval(currentHour, startBreakFast, stopBreakFast, sectionType)
	{
		var time;
		var normalisedHour = currentHour*100;
		var displayHour = API.formatNumber(Number(currentHour), "00", 2);
		var displayHour1 = API.formatNumber(Number(currentHour+1), "00", 2);
		if(sectionType == true)
		{
			if(normalisedHour < Number(startBreakFast) && (normalisedHour+100) > Number(startBreakFast))
			{  //ex breafksat starts from 5:30 the first interval must be 05:30-06:00
				time= startBreakfastHour+":"+startBreakfastMin+"-"+displayHour1+":00";
			}
			else if(normalisedHour < Number(stopBreakFast) && (normalisedHour+100) > Number(stopBreakFast))
			{	//ex breafksat stops at 10:30 the last interval must be 10:00-10:30
				time= displayHour+":00-"+stopBreakfastHour+":"+stopBreakfastMin;
			}
			else //is a normal interval
			{
				time= displayHour+":00-"+displayHour1+":00";
			}
		}
		else //day part menu
		{
			if(normalisedHour < Number(startBreakFast) && (normalisedHour+100) > Number(startBreakFast))
			{  //ex breafksat starts from 5:30 the last interval must be 05:00-05:30
				time= displayHour+":00-"+startBreakfastHour+":"+startBreakfastMin;
			}
			else if(normalisedHour < Number(stopBreakFast) && (normalisedHour+100) > Number(stopBreakFast))
			{	//ex breafksat stops at 10:30 the firstinterval must be 10:30-11:00
				time= stopBreakfastHour+":"+stopBreakfastMin+"-"+displayHour1+":00";
			}
			else //is a normal interval
			{
				time= displayHour+":00-"+displayHour1+":00";
			}
		}
		return time;
	}
	
	function shouldDisplay(currentHour, startBreakFast, stopBreakFast, sectionType)
	{
		if(sectionType ==true) //breakfast
		{
			if(currentHour+100 > Number(startBreakFast) && currentHour < Number(stopBreakFast)) // is a break fast line we must display it
			{
				return true;
			}
			else
			{
				return false;
			}
		}
		else //day menu
		{
			if(currentHour <  Number(startBreakFast) || (currentHour+100) >  Number(stopBreakFast)) // is a break fast line we must display it
			{
				return true;
			}
			else
			{
				return false;
			}
		}
	}

	function getSegments(startBreakFast, stopBreakFast,sectionType)
	{
		var arrayOfSegments = new Array();
		var j=0;
		if(sectionType == true) //breakfast
		{
			for( var i=0; i< nodesDayPartSize; i++)
			{
				var segment = nodesDayPart[i];
				if(Number(segment.@begTime) >= Number(startBreakFast) && Number(segment.@begTime) < Number(stopBreakFast))
				{
					arrayOfSegments[j] = segment.@id;
					j++;
				}
			}
		}
		else //day menu we have differetn intervals
		{
			API.dbg("getSegments enter else "+ nodesDayPartSize+ " "+ startBreakFast+ " "+stopBreakFast);
			for( var i=0; i< nodesDayPartSize; i++)
			{
				var segment = nodesDayPart[i];
				if(Number(segment.@begTime) < Number(startBreakFast))
				{
					arrayOfSegments[j] = segment.@id;
					j++;
				}
				if(Number(segment.@begTime) >= Number(stopBreakFast))
				{
					arrayOfSegments[j] = segment.@id;
					j++;
				}
			}
		}
		return arrayOfSegments;
	}
	

}

/**
 * PRIVATE
 * This function implements a generic Sale SOS report
 * Needed data types: CASH, HOURLYSALES, SOS
 * @author Celso Fernandes
 */
function genericSos(config, data, root, reportType) 
{
	var flagIsPROD = 0;
	var title;
	var posFC = root.POS.(@podShort=="FC");
	var posWT = root.POS.(@podShort=="WT");
	var posDT = root.POS.(@podShort=="DT");
	var	posFCDT = root.StoreTotals;

	
	orderTarget = root.PresetsTable.@orderTarget;
	lineTarget	= root.PresetsTable.@lineTarget;
	cashTarget	= root.PresetsTable.@cashTarget;
	totalTarget	= root.PresetsTable.@totalTarget;
	storeTarget	= root.PresetsTable.@storeTarget;
	holdTarget	= root.PresetsTable.@holdTarget;
	presentationTarget= root.PresetsTable.@presentationTarget;
	
	// Check if is production
	if((posFC.length()!=0) || (posDT.length()!=0) || (posWT.length()!=0)) {	
//   	if((posFC.length()!=0) || (PosDT.length()!=0)) {
   	 	flagIsPROD = 0   // Local 
   	}		
   	else{
   		flagIsPROD = 1   // Prod 
   	}

//#####################################	
// Header Section	
//#####################################	
	var  rootPos;
	switch(reportType) {
    case RPTSOSFC:
	   	 title = "FCR Sales Report";
 		 if(flagIsPROD == 0) { 		// Local
			 if(posFC.length() !=0 ){
			 	 rootPos = posFC;
			 }
		 }
		 else{
		   	 rootPos = rootSOSFC.StoreTotals;		   	 
		 }
	   	 break;		

    case RPTSOSDTHOUR:       	 
	   	 title = "DRIVE-THRU SALES REPORT - HOURLY";
		 root= (((rootSOSDT!=null)?rootSOSDT:new XML()) + ((rootSOSWT!=null)?rootSOSWT:new XML()));
	   	 var rootPosDt = (posDT.length()!=0)?posDT:root.StoreTotals.(@productionNodeId=="DT");
		 var rootPosWt = (posWT.length()!=0)?posWT:root.StoreTotals.(@productionNodeId=="WT");
		 rootPos=((rootPosDt!=null)?rootPosDt:new XML()) + ((rootPosWt!=null)?rootPosWt:new XML());
       	 break;		
       	 
	case RPTSOSDTDIAG:       	 
	   	 title = "DRIVE THRU DIAGNOSTIC REPORT";
		 root= (((rootSOSDT!=null)?rootSOSDT:new XML()) + ((rootSOSWT!=null)?rootSOSWT:new XML()));
	   	 var rootPosDt = (posDT.length()!=0)?posDT:root.StoreTotals.(@productionNodeId=="DT");
		 var rootPosWt = (posWT.length()!=0)?posWT:root.StoreTotals.(@productionNodeId=="WT");
		 rootPos=((rootPosDt!=null)?rootPosDt:new XML()) + ((rootPosWt!=null)?rootPosWt:new XML());
       	 break;		
       	 
 	case RPTSOSMFY:       	 
	   	 title = "KVS TIMING REPORT FOR PRIMARY (MFY)";
	   	 rootPos = rootSOSMFY.StoreTotals;
       	 break;		
       	 
    default:
   	     title = "ERROR";
       	 break;
	}
	
	addLine(SEP_DL);
	addHeader(rootCash, title, reportType);

	if(reportType == RPTSOSFC) {	
		addLine("TIME  PRODSALE T/C     AVG OVRP OVTOTL");
		addLine("       ACCUM    OT    CASH PSNT   TOTL");
	}
	
	if(reportType == RPTSOSDTHOUR) {	
		addLine("TIME PRODSALE T/C  AVG OVRP OVTOTL HLD#");		
		addLine("    CARSV  OT  LT  CASH PSNT  TOTL HOLD");
	}
	
	if(reportType == RPTSOSMFY) {
			addLine("TIME     SN#   AVG#  TTS OVR50 UNDR25");		
	}
	
	if(reportType == RPTSOSDTDIAG) {	
		addLine("TIME  #   ORDER LINE CASH PSNT  POS  OV");	
		var strOv90 = totalTarget.substring(0, 2);
		addLine("     Cars TIME  TIME TIME TIME  TIME " + strOv90);
	}
	
	if 	(rootPos.ServiceTime.length() == 0) {
		addLine();
		addLine(center("No Data for the date requested"));
		addLine();
		addFooter(rootCash);
		return;
	}
	
	var FCtotProdSale	= 0;
	var FCtotTc			= 0;
	var FCtotAvc_ac		= 0;
	var FCovra			= 0;
	var FCpvtotl		= 0;
	var FCtotAccum		= 0;
	var FCot			= 0;
	var FCcash			= 0;
	var FCpnst			= 0;
	var FCtotl			= 0;
	
	
	var totAvc_ac		= 0;
	var totAccum		= 0;
	var totAccumTc		= 0;
	var totAccumcars	= 0;
	var totAccumtts		= 0;
	var totAccumhld		= 0;
	
	var podot			= 0;
	var podlt			= 0;
	var podcash			= 0;
	var podpnst			= 0;
	var podhold			= 0;
	
	var totot			= 0;
	var totlt			= 0;
	var totcash			= 0;
	var totpnst			= 0;
	var totovrp			= 0;
	var totovtotl		= 0;
	var tothld			= 0;
	var tothold			= 0;
	var totpvtotl		= 0;
	
	var mfytctot 		= 0;
	var mfysntot 		= 0;
	var mfyavgtot 		= 0;
	var mfyttstot 		= 0;
	var mfyovr50tot 	= 0;
	var mfyundr25tot 	= 0;
	
	var totProdSale	 	= 0;
	var totTc			= 0;
	var totcars			= 0;
	
	var untilTotal		= 0;
	var untilStore		= 0;
	var untilRecall		= 0;
	var untilPay		= 0;
	var untilCloseDrawer= 0;
	var untilServe		= 0;
	var itemsCount		= 0;
	
	var tcOverOrderPreset= 0;
	var tcOverLinePreset = 0;
	var tcOverCashPreset = 0;
	var tcOverPresentationPreset=0;
	var tcOverTotalPreset= 0;
	var tcOverStorePreset= 0;
	
	var heldTime		= 0;
	var undoTime		= 0;
	var tcUnder25		= 0;
	var tcOver50		= 0;
	var tcHeld			= 0;
	var hotTc			= 0;
	var hotUntilStore	= 0;
	var hotUntilRecall	= 0;
	var tcOverHoldPreset = 0;
	
	
	var indSegment = 0;
	var nodesDayPart 	= root.DayPartitioning.Segment;	
	var nodesDayPartSize= Number(nodesDayPart.length());
	
	//MS 12.08.2010 sort segments necessary in order to add past midnight segments
	for(var i =0; i< nodesDayPartSize; i++)
	{
		for(var j=i+1; j < nodesDayPartSize; j++)
		{
			if(Number(nodesDayPart[j].@begTime) <  Number(nodesDayPart[i].@begTime) )
			{
				var temp = nodesDayPart[j];
				nodesDayPart[j] = nodesDayPart[i];
				nodesDayPart[i]	=temp;
			}
		}
	}
	
//#####################################	
// Body Section	
//#####################################	
	// Set up line with the information
	for(var j = 0; j <= 23; j++) {
	
		var hourAux = j + 1;
		var minAux  = "00";
		var idDayPart = 0;
		var nodeSegment = 0;
		var hourSegment = 0;

		// Get ative day part		
		for(var k = 0; k < nodesDayPartSize; k++) {
			 if(Number(String(nodesDayPart[k].@begTime).substring(0,2)) == j){
				nodeSegment  = nodesDayPart[k];
				hourSegment  = String(nodeSegment.@begTime).substring(0,2);	
				indSegment = k;
				break;
			 }	
			else{
				hourSegment="99";
			}
		}
	
		// Join values by Segment
		while (Number(hourSegment) == Number(j)) {
			var idDayPart = nodeSegment.@id;
			// Check if is production
			var nodeServiceTime = rootPos.ServiceTime.(@segmentId==idDayPart);
			if(flagIsPROD == 0) {
				nodeServiceTime = rootPos.ServiceTime.(@id==idDayPart);
			}

			// Accumulate values by Segment
			
			totTc 		  		+= Number(nodeServiceTime.@tc);
			totProdSale   		+= Number(nodeServiceTime.@totalAmount);
			totcars   			+= Number(nodeServiceTime.@cars);
		
			untilTotal			+= Number(nodeServiceTime.@untilTotal)/1000;
			untilStore			+= Number(nodeServiceTime.@untilStore)/1000;
			untilRecall			+= Number(nodeServiceTime.@untilRecall)/1000;
			untilPay			+= Number(nodeServiceTime.@untilPay)/1000;
			untilCloseDrawer	+= Number(nodeServiceTime.@untilCloseDrawer)/1000;
			untilServe			+= Number(nodeServiceTime.@untilServe)/1000;
			
			itemsCount			+= Number(nodeServiceTime.@itemsCount);
						
			tcOverOrderPreset	+= Number(nodeServiceTime.@tcOverOrderPreset);
			tcOverLinePreset	+= Number(nodeServiceTime.@tcOverLinePreset);
			tcOverCashPreset	+= Number(nodeServiceTime.@tcOverCashPreset);
			tcOverPresentationPreset+= Number(nodeServiceTime.@tcOverPresentationPreset);
			tcOverTotalPreset	+= Number(nodeServiceTime.@tcOverTotalPreset);
			tcOverStorePreset	+= Number(nodeServiceTime.@tcOverStorePreset);
			
			undoTime			+= Number(nodeServiceTime.ProductionTime.@undoTime)/1000;
			heldTime			+= Number(nodeServiceTime.ProductionTime.@heldTime)/1000;
			tcUnder25			+= Number(nodeServiceTime.ProductionTime.@tcUnder25);
			tcOver50			+= Number(nodeServiceTime.ProductionTime.@tcOver50);
			tcHeld				+= Number(nodeServiceTime.ProductionTime.@tcHeld);
			
			hotTc				+= Number(nodeServiceTime.ProductionTime.@hotTc);
			hotUntilStore		+= Number(nodeServiceTime.ProductionTime.@hotUntilStore)/1000;
			hotUntilRecall		+= Number(nodeServiceTime.ProductionTime.@hotUntilRecall)/1000;
			tcOverHoldPreset 	+= Number(nodeServiceTime.ProductionTime.@tcOverHoldPreset);
			
			indSegment++;

			if(Number(indSegment) < Number(nodesDayPartSize)) {
				nodeSegment  	= nodesDayPart[indSegment];
				hourSegment 	= String(nodeSegment.@begTime).substring(0,2);	
			}
			else{
				hourSegment		="99";
			}
		}

		// Create line for each type of report
		if(reportType == RPTSOSFC) {
		    // Create line for Front Counter Sale Report
	  		totAvc_ac	=  (totTc!=0)?totProdSale/totTc:0;
			totAccum 	+= totProdSale;
	
			var ot		= (totTc!=0)?untilTotal/totTc:0;
			var lt		= 0;
			if((root.POS.@podShort=="HOT")){
				lt 		= (totTc!=0)?untilRecall/totTc:0;
			}
			var cash	= (totTc!=0)?(untilCloseDrawer - untilTotal)/totTc:0;
//			var pnst	= (totTc!=0)?(untilServe - untilTotal)/totTc:0;
			var pnst	= ((totTc!=0)&&(untilServe > untilCloseDrawer))?(untilServe - untilCloseDrawer)/totTc:0;	// SDE-1284			
			var totl	= (totTc!=0)?((untilServe > untilCloseDrawer)?untilServe:untilCloseDrawer)/totTc:0;			// SDE-1284
			var ovra	= tcOverPresentationPreset;
			var pvtotl	= tcOverTotalPreset;
			
			FCtotProdSale	+= Number(totProdSale);
			FCtotTc			+= Number(totTc);
			FCtotAvc_ac		+= Number(totAvc_ac);
			FCovra			+= Number(ovra);
			FCpvtotl		+= Number(pvtotl);
			FCtotAccum		+= Number(totAccum);
			FCot			+= Number(ot*totTc);
			FCcash			+= Number(cash*totTc);
			FCpnst			+= Number(pnst*totTc);
			FCtotl			+= Number(totl);
			
			addLine(API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + 
			API.formatNumber(totProdSale, "#######0", 8) + " " + 
			API.formatNumber(totTc, "##0", 3) + " " + 
			API.formatNumber(totAvc_ac, "###0.00", 7) + "  "  + 
			API.formatNumber(ovra, "##0", 3) + "    " + 
			API.formatNumber(pvtotl, "##0", 3));

			addLine("     " + 	API.formatNumber(totAccum, "######0", 7) + "   " + 
			API.formatNumber(ot, "##0", 3) + "     " + 
			API.formatNumber(cash, "##0", 3) + "  " + 
			API.formatNumber(pnst, "##0", 3) + "    " + 
			API.formatNumber(totl, "##0", 3));
		}
		
		
		if(reportType == RPTSOSDTHOUR) {	
			totAvc_ac	= (totTc!=0)?Number(totProdSale/totTc):0;			
			totAccum 	+= totProdSale;
			totAccumTc	+= totTc;
			totAccumcars+= totcars;
				
			var ot		= (totTc!=0)?untilStore/totTc:0;
			var lt		= (totTc!=0)?(untilRecall-untilStore) /totTc:0;
			var cash	= (totTc!=0)?(untilCloseDrawer - untilRecall)/totTc:0;
			var pnst	= ((totTc!=0)&&(untilServe > untilCloseDrawer))?(untilServe - untilCloseDrawer)/totTc:0;	// SDE-1284
			var totl	= ot + lt + cash + pnst;
			var ovrp	= tcOverPresentationPreset;
			var ovtotl	= tcOverTotalPreset;
			var hld		= Number(tcHeld); 
			var hold	= (hld!=0)?heldTime/hld:0;
			
			totAccumhld += hld;
			
			totot		+= Number(ot); 
			totlt		+= Number(lt); 
			totcash		+= Number(cash); 
			totpnst		+= Number(pnst); 
			totovrp		+= Number(ovrp); 
			totovtotl	+= Number(ovtotl); 
			tothld		+= Number(hld); 
			tothold		+= Number(hold); 
			totpvtotl	+= Number(totl); 
			
			podot		+= ot   * totTc;
			podlt		+= lt   * totTc;
			podcash		+= cash * totTc;
			podpnst		+= pnst * totTc;
			podhold		+= hold * hld;
			
			addLine(API.formatNumber(hourAux, "00", 2) + ":" + minAux + "  " + 
			API.formatNumber(totProdSale, "#####0", 6) + " " + 
			API.formatNumber(totTc, "##0", 3) + " " + 
			API.formatNumber(totAvc_ac, "#0.00", 5) + "  " + 
			API.formatNumber(ovrp,"##0", 3) + "   " + 
			API.formatNumber(ovtotl,"##0", 3) + "  " + 
			API.formatNumber(hld,"##0", 3));
			
			addLine("      " + API.formatNumber(totcars, "##0", 3) + " " + 
			API.formatNumber(ot, "##0", 3) + " " + 
			API.formatNumber(lt, "##0", 3) + "   " + 
			API.formatNumber(cash, "##0", 3) + "  " + 
			API.formatNumber(pnst, "##0", 3) + "   " + 
			API.formatNumber(totl, "##0", 3) + "  " + 
			API.formatNumber(hold, "##0", 3));
		}
		
		if(reportType == RPTSOSDTDIAG) {	
			var cars		= totcars;
			var orderTime	= (totTc!=0)?untilStore/totTc:0;
			var lineTime	= (totTc!=0)?(untilRecall-untilStore) /totTc:0;
			var cashTime	= (totTc!=0)?(untilCloseDrawer - untilRecall)/totTc:0;
			var psntTime	= ((totTc!=0)&&(untilServe > untilCloseDrawer))?(untilServe - untilCloseDrawer)/totTc:0;	// SDE-1284
			var posTime		= orderTime + lineTime + cashTime + psntTime;
			var ov90		= tcOverTotalPreset;
		
			addLine(API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + 
			API.formatNumber(cars, "##0", 3)+ "  " + 
			API.formatNumber(orderTime, "##0", 3)+ "  " + 
			API.formatNumber(lineTime, "##0", 3)+ "   " + 
			API.formatNumber(cashTime, "##0", 3) + "  " + 
			API.formatNumber(psntTime, "##0", 3) + "  " + 
			API.formatNumber(posTime, "##0", 3) + "  " + 
			API.formatNumber(ov90, "#0", 2));
		}
		
		if(reportType == RPTSOSMFY) {	
		
			var mfytc		= totTc;
			var mfysn		= itemsCount;
			var mfyavg		= (totTc!=0)?mfysn/mfytc:0;
			var mfytts		= (totTc!=0)?untilServe/totTc:0;
			var mfyovr50	= tcOver50;
			var mfyundr25	= tcUnder25;
			
			totAccumTc	+= totTc;
			totAccumtts	+= mfytts;


			addLine(API.formatNumber(hourAux, "00", 2) + ":" + minAux + "    " + 
			API.formatNumber(mfysn, "##0", 3) + " " + 
			//API.formatNumber(mfyavg,"##0", 3) + " " + 
			
			API.formatNumber(mfyavg, "#0.00", 5) + "  " + 			
			
			API.formatNumber(mfytts,"##0", 3) + "   " + 
			API.formatNumber(mfyovr50,"##0", 3)+ "    " + 
			API.formatNumber(mfyundr25,"##0", 3));
		
		
			mfytctot 		+= mfytc;
			mfysntot 		+= mfysn;
			mfyavgtot 		+= mfyavg;
//			mfyttstot 		+= mfytts;
			mfyttstot 		+= untilServe;			
			mfyovr50tot 	+= mfyovr50;
			mfyundr25tot 	+= mfyundr25;
			
		}
	
		totAvc_ac		= 0;
		
	  	totProdSale	 	= 0;
	  	totTc			= 0;
	  	totcars			= 0;
	
	  	untilTotal		= 0;
	  	untilStore		= 0;
	  	untilRecall		= 0;
	  	untilPay		= 0;
	  	untilCloseDrawer= 0;
	  	untilServe		= 0;
	  	
	  	itemsCount		= 0;
	  	
	  	tcOverOrderPreset	= 0;
	  	tcOverLinePreset	= 0;
	  	tcOverCashPreset	= 0;
	  	tcOverPresentationPreset=0;
	  	tcOverTotalPreset	= 0;
	  	tcOverStorePreset	= 0;
	
	  	heldTime		= 0;
	  	undoTime		= 0;
	  	tcUnder25		= 0;
	  	tcOver50		= 0;
	  	tcHeld			= 0;
	  	hotTc			= 0;
	  	hotUntilStore	= 0;
	  	hotUntilRecall	= 0;
	  	tcOverHoldPreset = 0;

	}
	
//#####################################	
// Footer Section	
//#####################################	
//				          1         2         3         4
//				 1234567890123456789012345678901234567890
	if(reportType == RPTSOSDTHOUR){	
		var totAccumAvc_ac = (totAccumTc!=0)?totAccum/totAccumTc:0;
		var totAccumot     = (totAccumTc!=0)?podot/totAccumTc:0; 
		var totAccumlt     = (totAccumTc!=0)?podlt/totAccumTc:0; 
		var totAccumcash   = (totAccumTc!=0)?podcash/totAccumTc:0; 
		var totAccumpnst   = (totAccumTc!=0)?podpnst/totAccumTc:0; 
		var totAccumpvtotl = totAccumot + totAccumlt + totAccumcash + totAccumpnst;
		
		var totAccumhold   = (totAccumhld!=0)?podhold/totAccumhld:0; 	
		
		addLine();
		addLine("TOTAL  " + 
		API.formatNumber(totAccum, "#####0", 6) + " " + 
		API.formatNumber(totAccumTc, "##0", 3) + " " + 
		API.formatNumber(totAccumAvc_ac, "#0.00", 5) + "  " + 
		API.formatNumber(totovrp,"##0", 3) + "   " + 
		API.formatNumber(totovtotl,"##0", 3) + "  " + 
		API.formatNumber(tothld,"##0", 3));
	    addLine("      " + 
	    API.formatNumber(totAccumcars, "##0", 3) + " " + 
	    API.formatNumber(totAccumot, "##0", 3) + " " + 
	    API.formatNumber(totAccumlt, "##0", 3) + "   " + 
	    API.formatNumber(totAccumcash, "##0", 3) + "  " + 
	    API.formatNumber(totAccumpnst, "##0", 3) + "   " + 
	    API.formatNumber(totAccumpvtotl, "##0", 3) + "  " + 
	    API.formatNumber(totAccumhold, "##0", 3));
	}
	
	if(reportType == RPTSOSDTDIAG){	
		var totlTarget = totalTarget/1000
		var pnstTarget = presentationTarget/1000			
		
		addLine();		
		addLine("PRESETS     " + 
		API.formatNumber(orderTarget/1000, "#0", 2)+"   "+
		API.formatNumber(lineTarget/1000, "#0", 2)+"    "+
		API.formatNumber(cashTarget/1000, "#0", 2)+"   "+
		API.formatNumber(presentationTarget/1000, "#0", 2)+"   "+
		API.formatNumber(totalTarget/1000, "#0", 2));
		addLine("           ORD   LT  CASH PSNT POS");
		addLine("           TIME      TIME TIME TIME");		
	}

	if(reportType == RPTSOSMFY){	
		addLine();
		addLine("TIME     SN#   AVG#  TTS OVR50 UNDR25");		
		addLine("         " + 
//		API.formatNumber(totAccumTc, "##0", 3) + "  " + 
		API.formatNumber(mfysntot, "##0", 3) + "  " + 
		API.formatNumber(mfysntot/totAccumTc,"#0.00", 5) + "  " + 
		API.formatNumber(mfyttstot/totAccumTc,"##0", 3) + "   " + 
		API.formatNumber(mfyovr50tot,"##0", 3)+ "    " + 
		API.formatNumber(mfyundr25tot,"##0", 3));
		
		addLine("GOALS                " + 
		API.formatNumber(totalTarget/1000, "##0", 3));
	}

	if((reportType == RPTSOSFC) ||(reportType == RPTSOSDTHOUR)){	
		if(reportType == RPTSOSFC) {		
			addLine("TIME  PRODSALE T/C     AVG OVRP OVTOTL");
			addLine("                OT    CASH PSNT   TOTL");

			addLine("      " + 
			API.formatNumber(FCtotProdSale, "#######0", 8) + " " + 
			API.formatNumber(FCtotTc, "##0", 3) + " " + 
			API.formatNumber(FCtotProdSale/FCtotTc, "###0.00", 7) + "  "  + 
			API.formatNumber(FCovra, "##0", 3) + "    " + 
			API.formatNumber(FCpvtotl, "##0", 3));
			
			addLine("     " +  "       " + "   " + 
			API.formatNumber(FCot/FCtotTc, "##0", 3) + "     " + 
			API.formatNumber(FCcash/FCtotTc, "##0", 3) + "  " + 
			API.formatNumber(FCpnst/FCtotTc, "##0", 3) + "    " + 
			API.formatNumber((FCot/FCtotTc)+(FCcash/FCtotTc)+(FCpnst/FCtotTc), "##0", 3));
			
		}
		addLine();
		    addLine("         PRESET        PRESET         ");
		var totlTarget = totalTarget/1000
		var pnstTarget = presentationTarget/1000			
		    addLine("         TOTL   " + 
		API.formatNumber(totlTarget, "#0", 2) + "     PSNT  " + 
		API.formatNumber(pnstTarget, "#0", 2));
	}

	addFooter(rootCash);
	
	return;
}

"CONSOLIDATED SERVICE REPORT"

/**
 * PUBLIC
 * Responsible for formating the SOS "Consolidate Service Report" from WayStation
 * Needed data types: CASH|SOS (from FC production)
 * @author Lsouza
 */
function reportSosWayCsr(config, data) {
	genericSosCsr(config, data, RPTSOSCSR, true);
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the SOS "D10 Consolidate Service Report" from WayStation
 * Needed data types: CASH|SOS (from FC production)
 * PLE-177
 * @author Lsouza
 */
function reportSosD10WayCsr(config, data) {
	genericSosCsr(config, data, RPTSOSD10CSR, true);
	return getResponse();
}
/**
 * PUBLIC
 * Responsible for formating the "Consolidate Service Report" from POS
 * Needed data types: CASH|SOS (from FC production)
 * @author Lsouza
 */
function reportSosCsr(config, data) {
	genericSosCsr(config, data, RPTSOSCSR);
	return getResponse();
}

/**
 * PUBLIC
 * Responsible for formating the SOS D10 "D10 Consolidate Service Report" from POS
 * Needed data types: CASH|SOS (from FC production)
 * PLE-177
 * @author Lsouza
 */
function reportSosD10Csr(config, data) {
	genericSosCsr(config, data, RPTSOSD10CSR);
	return getResponse();
}


/**
 * PUBLIC
 * Responsible for formating the CONSOLIDATED SERVICE REPORT.
 * Needed data types: CASH, SOS
 * @author Celso 
 */
function genericSosCsr(config, data, reportTitle, isWay) 
{
	if(init(config, data, Array("CASH","SOS"), "SSCSR") != 0){
		return getResponse();
	}	
	
	var accumpodfc	= 0;
	var accumpoddt	= 0;
	var accumpodkvs	= 0;
	
	var accumtcfc 	= 0;
	var accumtotlfc	= 0;
	var accumkvsttl	= 0;
	var accumtcdt 	= 0;
	var accumtotldt	= 0;
	var accumfcdtsale = 0;
	var accumfcsale = 0;
	var accumdtsale = 0;	
	var accummfysale =0;
	var accumtcmfy 	= 0;

	if (isWay){
		var title = "";
	}else{
		var ctx = new SessionContext;
		var title = ctx.get('sosRptTitle');		
	}
	
	var flagIsPROD = 1;
	var FC 	= 0;
	var DT 	= 1;
	var MFY = 2;
	
	if ((rootSOSFC == null) || ((rootSOSDT == null) && (rootSOSWT == null)) || (rootSOSMFY == null)) {
		addLine("ERROR: POS configuration error.\nCall support, error code = SSCSR-S");
		return getResponse();
	}
	
	var root = Array();
	root[FC] = rootSOSFC;
	root[DT]= (((rootSOSDT!=null)?rootSOSDT:new XML()) + ((rootSOSWT!=null)?rootSOSWT:new XML()));
   	root[MFY]= rootSOSMFY;
	
	if (reportTitle == RPTSOSD10CSR){
		reportTitle = "D10 Consolidated Service Report " + addTitle(title);
	}else{
		reportTitle = "CONSOLIDATED SERVICE REPORT " +  addTitle(title);
	} 
   	if(Country =="UK") //get title fro the proerty file 
	{
		reportTitle = API.getLocalMsg("MSG_REPORT_SOS_CSR_TITLE");
	}
 	
  	addHeader(rootCash, reportTitle, RPTSOSCSR);
//			          1         2         3        3 
//			 123456789012345678901234567890123456789
	if(API.getLocalMsg("MSG_REPORT_CSR_HEADER1") !="MSG_REPORT_CSR_HEADER1")
	{
		addLine(API.getLocalMsg("MSG_REPORT_CSR_HEADER1"));
	}
	else
	{
		addLine("TIME  --FC--- KVS -- DT--- --- TOTAL---");
	}
	if(API.getLocalMsg("MSG_REPORT_CSR_HEADER2") !="MSG_REPORT_CSR_HEADER2")
	{
		addLine("      "+API.getLocalMsg("MSG_REPORT_CSR_HEADER2"));
	}
	else
	{
		addLine("      T/C TOTL     T/C TOTL  T/C  SALES");
	}
	if(API.getLocalMsg("MSG_REPORT_CSR_HEADER3") !="MSG_REPORT_CSR_HEADER3")
	{
		addLine("            "+API.getLocalMsg("MSG_REPORT_CSR_HEADER3"));
	}
	else
	{
		addLine("        SALES       SALES              ");
	}
	// Create struct to store data about recurse	
	var tc   = Array();
	var totl = Array();
	var totProdSale = Array();
	
	for(var j = 0; j <= 23; j++) {
		tc[j]		   = Array(0,0,0);
		totl[j] 	   = Array(0,0,0);
		totProdSale[j] = Array(0,0,0);
	}
		
//#####################################	
// Front Counter data
//#####################################	
// Front Counter
	var indSegment = 0;
	var nodesDayPart 	= root[FC].DayPartitioning.Segment;	
	var nodesDayPartSize= Number(nodesDayPart.length());
	
	//MS 12.08.2010 sort segments necessary in order to add past midnight segments
	for(var i =0; i< nodesDayPartSize; i++)
	{
		for(var j=i+1; j < nodesDayPartSize; j++)
		{
			if(Number(nodesDayPart[j].@begTime) <  Number(nodesDayPart[i].@begTime) )
			{
				var temp = nodesDayPart[j];
				nodesDayPart[j] = nodesDayPart[i];
				nodesDayPart[i]	=temp;
			}
		}
	}
	
	for(var j = 0; j <= 23; j++) {
	
		var hourAux = j;
		var minAux  = "00";
		var idDayPart = 0;
		var nodeSegment = 0;
		var hourSegment = 0;
		
		// Get ative day part
		for(var k = 0; k < nodesDayPartSize; k++) {
			 if(Number(String(nodesDayPart[k].@begTime).substring(0,2)) == j){
				nodeSegment  = nodesDayPart[k];
				hourSegment  = String(nodeSegment.@begTime).substring(0,2);	
				indSegment = k;
				break;
			 }	
			else{
				hourSegment="99";
			}
		}
		
		// Get all DayPartitioning in a determinate hour
		while (Number(hourSegment) == Number(hourAux)){

			var idDayPart = nodeSegment.@id;

			if(flagIsPROD == 0){
				var nodeServiceTime  = root[FC].ServiceTime.(@id==idDayPart);
			}
			else{
				var nodeServiceTime  = root[FC].StoreTotals.ServiceTime.(@segmentId==idDayPart);
			}
						
			tc[j][FC] 		  		+= Number(nodeServiceTime.@tc);					
			totl[j][FC]	   			+= Number(nodeServiceTime.@totalTime)/1000;		// SDE-1284
			totProdSale[j][FC]   	+= Number(nodeServiceTime.@totalAmount);
			
			indSegment++;

			if(Number(indSegment) < nodesDayPartSize){	
				nodeSegment  = root[FC].DayPartitioning.Segment[indSegment];
				hourSegment  = String(nodeSegment.@begTime).substring(0,2);	
			}
			else{
				hourSegment		="99";
			}
		}
	}
	
//#####################################	
// Drive Thru data
//#####################################	
	indSegment = 0;
	nodesDayPart 	= root[DT].DayPartitioning.Segment;	
	nodesDayPartSize= Number(nodesDayPart.length());
	
	//MS 12.08.2010 sort segments necessary in order to add past midnight segments
	for(var i =0; i< nodesDayPartSize; i++)
	{
		for(var j=i+1; j < nodesDayPartSize; j++)
		{
			if(Number(nodesDayPart[j].@begTime) <  Number(nodesDayPart[i].@begTime) )
			{
				var temp = nodesDayPart[j];
				nodesDayPart[j] = nodesDayPart[i];
				nodesDayPart[i]	=temp;
			}
		}
	}
	for(var j = 0; j <= 23; j++) {
	
		var hourAux = j;
		var minAux  = "00";
		var idDayPart = 0;
		var nodeSegment = 0;
		var hourSegment = 0;
		
		// Get ative day part
		for(var k = 0; k < nodesDayPartSize; k++) {
			 if(Number(String(nodesDayPart[k].@begTime).substring(0,2)) == j){
				nodeSegment  = nodesDayPart[k];
				hourSegment  = String(nodeSegment.@begTime).substring(0,2);	
				indSegment = k;
				break;
			 }	
			else{
				hourSegment="99";
			}
		}

		// Get all DayPartitioning in a determinate hour
		while (Number(hourSegment) == Number(hourAux)){

			var idDayPart = nodeSegment.@id;

			if(flagIsPROD == 0){
				var nodeServiceTime  = root[DT].ServiceTime.(@id==idDayPart);
			}
			else{
				var nodeServiceTime  = root[DT].StoreTotals.ServiceTime.(@segmentId==idDayPart);
			}
						
			tc[j][DT] 		  		+= Number(nodeServiceTime.@tc);					
			totl[j][DT]	   			+= Number(nodeServiceTime.@totalTime)/1000;		// SDE-1284
			totProdSale[j][DT]   	+= Number(nodeServiceTime.@totalAmount);
			
			indSegment++;
			
			if(Number(indSegment) < Number(root[DT].DayPartitioning.Segment.length())){	
				nodeSegment  = root[DT].DayPartitioning.Segment[indSegment];
				hourSegment  = String(nodeSegment.@begTime).substring(0,2);	
			}
			else{
				hourSegment		="99";
			}
			
		}
	}
	
//#####################################	
// Made For You Data
//#####################################	
	indSegment = 0;
	nodesDayPart 	= root[MFY].DayPartitioning.Segment;	
	nodesDayPartSize= Number(nodesDayPart.length());
	
	//MS 12.08.2010 sort segments necessary in order to add past midnight segments
	for(var i =0; i< nodesDayPartSize; i++)
	{
		for(var j=i+1; j < nodesDayPartSize; j++)
		{
			if(Number(nodesDayPart[j].@begTime) <  Number(nodesDayPart[i].@begTime) )
			{
				var temp = nodesDayPart[j];
				nodesDayPart[j] = nodesDayPart[i];
				nodesDayPart[i]	=temp;
			}
		}
	}
	
	for(var j = 0; j <= 23; j++) {
		var hourAux = j;
		var minAux  = "00";
		var idDayPart = 0;
		var nodeSegment = 0;
		var hourSegment = 0;
		
		// Get ative day part
		for(var k = 0; k < nodesDayPartSize; k++) {
			 if(Number(String(nodesDayPart[k].@begTime).substring(0,2)) == j){
				nodeSegment  = nodesDayPart[k];
				hourSegment  = String(nodeSegment.@begTime).substring(0,2);	
				indSegment = k;
				break;
			 }	
			else{
				hourSegment="99";
			}
		}

		// Get all DayPartitioning in a determinate hour
		while (Number(hourSegment) == Number(hourAux)){

			var idDayPart = nodeSegment.@id;

			if(flagIsPROD == 0){
				var nodeServiceTime  = root[MFY].ServiceTime.(@id==idDayPart);
			}
			else{
				var nodeServiceTime  = root[MFY].StoreTotals.ServiceTime.(@segmentId==idDayPart);
			}
				
			tc[j][MFY] 		  		+= Number(nodeServiceTime.@tc);					
			totl[j][MFY]	   		+= Number(nodeServiceTime.@untilServe)/1000;
			totProdSale[j][MFY]   	+= Number(nodeServiceTime.@totalAmount);
			
			indSegment++;
			
			if(Number(indSegment) < Number(root[MFY].DayPartitioning.Segment.length())){	
				nodeSegment  = root[MFY].DayPartitioning.Segment[indSegment];
				hourSegment  = String(nodeSegment.@begTime).substring(0,2);	
			}
			else{
				hourSegment		="99";
			}
		}
	}
	
//#####################################	
// Body Section	
//#####################################	
	for(var j = 0; j <= 23; j++) {	
		var hourAux = j + 1;
		var minAux  = "00";
	
		var fcdttc 	 = tc[j][FC] + tc[j][DT];
		var fcdtsale = totProdSale[j][FC] + totProdSale[j][DT];
		var kvsttl   = 0;		

		var avgtotlfc  = (tc[j][FC]!= 0)?totl[j][FC]/tc[j][FC]:0;
		var avgtotldt  = (tc[j][DT]!= 0)?totl[j][DT]/tc[j][DT]:0;
		var avgtotlmfy = (tc[j][MFY]!= 0)?totl[j][MFY]/tc[j][MFY]:0;

		accumpodfc 	+= avgtotlfc * tc[j][FC];
		accumpoddt	+= avgtotldt * tc[j][DT];
		accumpodkvs	+= avgtotlmfy * (tc[j][FC]+ tc[j][DT]);		
		
		accumtcfc 	+= tc[j][FC];
		accumtotlfc	+= avgtotlfc;
		accumkvsttl	+= avgtotlmfy;
		accumtcdt 	+= tc[j][DT];
		accumtotldt	+= avgtotldt;
		accumfcsale += totProdSale[j][FC];
		accumdtsale += totProdSale[j][DT];
		accummfysale += totProdSale[j][MFY];
		accumfcdtsale += fcdtsale;
		accumtcmfy += tc[j][MFY];
		
		if(Country =="UK")
		{
			addLine(API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + 
			API.formatNumber(tc[j][FC], "##0", 3)+ " " + 
			API.formatNumber(totProdSale[j][FC], "####0", 5)+ " " + 
			API.formatNumber(tc[j][MFY], "###0", 4)+ " " + 
			API.formatNumber(tc[j][DT], "##0", 3) + " " + 
			API.formatNumber(totProdSale[j][DT], "####0", 5) + " " + 
			API.formatNumber(fcdttc, "##0", 3) + " " + 
			API.formatNumber(fcdtsale, "###0", 4));
			addLine("            " + 
			API.formatNumber(avgtotlfc, "##0", 3) + "  " + 
			API.formatNumber(avgtotlmfy, "##0", 3)+ "       "+
			API.formatNumber(avgtotldt, "##0", 3));
		}
		else
		{
			addLine(API.formatNumber(hourAux, "00", 2) + ":" + minAux + " " + 
			API.formatNumber(tc[j][FC], "##0", 3)+ " " + 
			API.formatNumber(avgtotlfc, "##0", 3)+ " " + 
			API.formatNumber(avgtotlmfy, "##0", 3)+ " " + 
			API.formatNumber(tc[j][DT], "##0", 3) + " " + 
			API.formatNumber(avgtotldt, "##0", 3) + "    " + 
			API.formatNumber(fcdttc, "#0", 2) + " " + 
			API.formatNumber(fcdtsale, "####0", 5));
			addLine("       " + 
			API.formatNumber(totProdSale[j][FC], "#####0", 6) + "      " + 
			API.formatNumber(totProdSale[j][DT], "#####0", 6));
		}

	}

//#####################################	
// Footer Section	
//#####################################	
	var accumfcdttc = accumtcfc + accumtcdt;
	var accumfcdttotl = accumtotlfc + accumtotldt;
		
	addLine();
	if(Country =="UK")
	{
		addLine("TOTAL " + 
		API.formatNumber(accumtcfc, "##0", 3)+ " " + 
		API.formatNumber(accumfcsale, "####0", 5)+ " " + 
		API.formatNumber(accumtcmfy, "###0", 4)+ " " + 
		API.formatNumber(accumtcdt, "##0", 3) + " " + 
		API.formatNumber(accumdtsale, "####0", 5) + " " + 
		API.formatNumber(accumfcdttc, "##0", 3) + " " + 
		API.formatNumber(accumfcdtsale, "###0", 4));
		addLine("            " + 
		API.formatNumber(accumpodfc/accumtcfc, "##0", 3) + "  " + 
		API.formatNumber(accumpodkvs/accumtcmfy, "##0", 3) + "       "+
		API.formatNumber(accumpoddt/accumtcdt, "##0", 3));;
	}
	else
	{
		addLine("TOTAL " + 
		API.formatNumber(accumtcfc, "##0", 3)+ " " + 
		API.formatNumber(accumpodfc/accumtcfc, "##0", 3)+ " " + 
		API.formatNumber(accumpodkvs/(accumtcfc+accumtcdt), "##0", 3)+ " " + 
		API.formatNumber(accumtcdt, "##0", 3) + " " + 
		API.formatNumber(accumpoddt/accumtcdt, "##0", 3) + "   " + 
		API.formatNumber(accumfcdttc, "##0", 3) + "  " + 
		API.formatNumber(accumfcdtsale, "####0", 5));
		addLine("       " + 
		API.formatNumber(accumfcsale, "#####0", 6) + "      " + 
		API.formatNumber(accumdtsale, "#####0", 6));
	}
	addFooter(rootCash);
	
	addLegend("MSG_REPORT_CSR_LEGEND");	
	//return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the SOS D10 "D10 Kiosk Sales Report" for WayStation
 * Needed data types: CASH|SOS (from FC production)
 * PLE-177
 * @author Lsouza
 */
function reportSosD10WayKiosk(config, data){
	return reportSosD10Kiosk(config, data, true);
}

/**
 * PUBLIC
 * Responsible for formating the SOS D10 "D10 Kiosk Sales Report"
 * Needed data types: CASH|SOS (from FC production)
 * PLE-177
 * @author Lsouza
 */
function reportSosD10Kiosk(config, data, isWay) {
	
	if(init(config, data, Array("CASH","SOS"), "RSKIOSK") != 0){
		return getResponse();
	}
	if (isWay){
		var title = ""; 
	}else{
		var ctx = new SessionContext;
		var title = ctx.get('sosRptTitle');	
	}
	
	addHeader(rootCash, "D10 Kiosk Sales Report " + addTitle(title));	
	addLine("TIME PRODSALE T/C   AVG  OVRP  OVTOTL ");
	addLine("        ACCUM    OT/CASH  PSNT   TOTL");
	var details = new StringBuffer();
	var totVoServiceTime    = {};
	var totVoProductionTime = {csoTotalAmount: 0,  csoUntilTotal: 0, csoUntilCloseDrawer: 0, csoUntilPay: 0, csoUntilServe: 0, csoTotalTime: 0, csoUntilStore: 0, csoUntilRecall: 0, csoTc: 0, csoTcOverTotalTimeCsoOrder: 0, csoTcOverPresentationTimeCsoOrder: 0};
	var totlTarget = rootSOS.PresetsTable.@overTotalTargetCsoOrder/1000;
	var pnstTarget = rootSOS.PresetsTable.@overPresentationTargetCsoOrder/1000;
	
	if (addDetails(rootSOS, totVoServiceTime, totVoProductionTime, addDetailLines)) {
		if (totVoProductionTime.csoTc > 0) {
			outputBuffer.append(details);
			addTotals();
			presetsTarget(totlTarget, pnstTarget);
		} else {
			addLine();
			addLine(center("No Data for the date requested"));
			addLine();
		}
	}
	addFooter(rootSOS);
	return getResponse();

	function addTotals() {
		
		addLine();
		addLine("TIME PRODSALE T/C   AVG  OVRP  OVTOTL ");
		addLine("                 OT/CASH  PSNT   TOTL");

 		var ovra	= totVoProductionTime.csoTcOverPresentationTimeCsoOrder;
		var pvtotl  = totVoProductionTime.csoTcOverTotalTimeCsoOrder;;
		var ot_cash = (((totVoProductionTime.csoUntilCloseDrawer!=0)?totVoProductionTime.csoUntilCloseDrawer:totVoProductionTime.csoUntilPay)/totVoProductionTime.csoTc)/1000;
		var csoUntilServe = totVoProductionTime.csoUntilServe/1000;
		var csoUntilCloseDrawer = totVoProductionTime.csoUntilCloseDrawer/1000;	
		var pnst    = (((totVoProductionTime.csoTc!=0)&&(csoUntilServe > csoUntilCloseDrawer))?(csoUntilServe - csoUntilCloseDrawer)/totVoProductionTime.csoTc:0) // SDE-1284
		var totl    = ((totVoProductionTime.csoTc!=0)?((totVoProductionTime.csoUntilServe > totVoProductionTime.csoUntilCloseDrawer)?totVoProductionTime.csoUntilServe:totVoProductionTime.csoUntilCloseDrawer)/totVoProductionTime.csoTc:0)/1000; // SDE-1284;

		var line1 = API.formatNumber(totVoProductionTime.csoTotalAmount, "######0", 10) + " " + 
				API.formatNumber(totVoProductionTime.csoTc, "##0", 5) + " " + 
				API.formatNumber(totVoProductionTime.csoTotalAmount / totVoProductionTime.csoTc, "###0.00", 6) + "  "  + 
				API.formatNumber(ovra, "##0", 4) + "    " + 
				API.formatNumber(pvtotl, "##0", 4);
	
		var line2 = ("   " + "       " + "   " + 
				API.formatNumber(ot_cash, "##0", 9) + "     " + 
				API.formatNumber(pnst, "##0", 2) + "    " + 
				API.formatNumber(totl, "##0", 3));
				
        addLine(line1);
		addLine(line2);
	}
	
	function addDetailLines(curHour, hSegments) {
		var vo    = {};
		var csoVo = {};

		for (var prop in totVoServiceTime) vo[prop] = 0;
		for (var prop in totVoProductionTime) csoVo[prop] = 0;
		
		var xmlProp = null;
		var emptySegment = true;

		for (var i = 0; i < hSegments.length; i++) {
			for (var prop in vo) vo[prop] += Number(hSegments[i].attribute(prop));
			var nodeProductionTime = hSegments[i].ProductionTime;
			if (nodeProductionTime) { // On KS Sales, this tag does not exist
				for (var prop in csoVo) csoVo[prop] += Number(nodeProductionTime.attribute(prop));
			}
		}
		var totAvc_ac               = 0;
		var totAccum	        	= 0;
		csoTotalAmount              = csoVo.csoTotalAmount;
		csoTc                       = csoVo.csoTc;
		csoUntilTotal               = csoVo.csoUntilTotal/1000;
		csoUntilCloseDrawer         = csoVo.csoUntilCloseDrawer/1000;
		csoUntilServe               = csoVo.csoUntilServe/1000;      
		csoUntilPay                 = csoVo.csoUntilPay/1000; 
	    // Create line for Front Counter Sale Report
		totAvc_ac	=  (csoTc!=0)?csoTotalAmount/csoTc:0;
		totAccum   += csoTotalAmount;
		// Add to totals
		for (var prop in totVoServiceTime) totVoServiceTime[prop] += vo[prop];
		for (var prop in totVoProductionTime) totVoProductionTime[prop] += csoVo[prop];
		
		var ot		= (csoTc!=0)?csoUntilTotal/csoTc:0;
		var cash	= (csoTc!=0)?(csoUntilCloseDrawer - csoUntilTotal)/csoTc:0;
		var ovra	= csoVo.csoTcOverPresentationTimeCsoOrder;
		var pvtotl  = csoVo.csoTcOverTotalTimeCsoOrder;
        var ot_cash = (((csoUntilCloseDrawer!=0)? csoUntilCloseDrawer: csoUntilPay)/csoTc);
		var pnst	= ((csoTc!=0)&&(csoUntilServe > csoUntilCloseDrawer))?(csoUntilServe - csoUntilCloseDrawer)/csoTc:0;	// SDE-1284			
		var totl	= (csoTc!=0)?((csoUntilServe > csoUntilCloseDrawer)? csoUntilServe:csoUntilCloseDrawer)/csoTc:0;			// SDE-1284

		var line1 = API.formatNumber(curHour +1, "00", 2) + ":00  " + 
				API.formatNumber(csoTotalAmount, "######0", 3) + " " + 
				API.formatNumber(csoTc, "##0", 5) + " " + 
				API.formatNumber(totAvc_ac, "###0.00", 6) + "  "  + 
				API.formatNumber(ovra, "##0", 4) + "    " + 
				API.formatNumber(pvtotl, "##0", 4);

		var line2 = ("   " + API.formatNumber(totVoProductionTime.csoTotalAmount, "######0", 7) + "   " + 
				API.formatNumber(ot_cash, "##0", 9) + "     " + 
				API.formatNumber(pnst, "##0", 2) + "    " + 
				API.formatNumber(totl, "##0", 4));
				
	
		details.append(line1);
		details.append("\n");
		details.append(line2);
		details.append("\n");
	}		
}

/**
 * PUBLIC
 * Responsible for formating the SOS D10 "D10 FCR Sales Report" for WayStation
 * Needed data types: CASH|SOS (from FC production)
 * PLE-177
 * @author Lsouza
 */
function reportSosD10WayFcr(config, data){
	return reportSosD10Fcr(config, data, true);
}

/**
 * PUBLIC
 * Responsible for formating the SOS D10 "D10 FCR Sales Report"
 * Needed data types: CASH|SOS (from FC production)
 * PLE-177
 * @author Lsouza
 */
function reportSosD10Fcr(config, data, isWay) {
	if(init(config, data, Array("CASH","SOS"), "RSFCR") != 0){
		return getResponse();
	}	
	if (isWay){
		var title = ""; 
	}else{
		var ctx = new SessionContext;
		var title = ctx.get('sosRptTitle');	
	}
	var details = new StringBuffer();
	if(Country=="UK")
	{
		var arrTitle = new Array(API.getLocalMsg("MSG_REPORT_SOSD10_FCR_TITLE1"),API.getLocalMsg("MSG_REPORT_SOSD10_FCR_TITLE2"));
		addHeader(rootCash, arrTitle, RPTSOSFC);
	}
	else
	{
		addHeader(rootCash, "D10 FCR Sales Report " + addTitle(title));
	}
	
	if(API.getLocalMsg("MSG_REPORT_SOSD10_FCR_HEADER1")!="MSG_REPORT_SOSD10_FCR_HEADER1")
	{
		addLine(API.getLocalMsg("MSG_REPORT_SOSD10_FCR_HEADER1"));
	}
	else
	{
		addLine("TIME PRODSALE T/C   AVG  OVRP  OVTOTL ");
	}
	if(API.getLocalMsg("MSG_REPORT_SOSD10_FCR_HEADER2")!="MSG_REPORT_SOSD10_FCR_HEADER2")
	{
		addLine("        "+API.getLocalMsg("MSG_REPORT_SOSD10_FCR_HEADER2"));
	}
	else
	{
		addLine("        ACCUM    OT/CASH  PSNT   TOTL");
	}
	
	var totVoServiceTime    = {tc: 0, untilTotal: 0, untilStore: 0, untilRecall: 0, untilCloseDrawer: 0, untilPay: 0, untilServe: 0, totalTime: 0, totalAmount: 0};
	var totVoProductionTime = {csoTotalAmount: 0,  csoUntilTotal: 0, csoUntilCloseDrawer: 0, csoUntilPay: 0, csoUntilServe: 0, csoTotalTime: 0, csoUntilStore: 0, csoUntilRecall: 0, csoTc: 0, tcOverTotalTimeFcOrder: 0, csoTcOverPresentationTimeFcOrder: 0,csoTcOverTotalTimeFcOrder: 0, tcOverPresentationTimeFcOrder: 0};
	var totlTarget = rootSOS.PresetsTable.@overTotalTargetFcOrder/1000;
	var pnstTarget = rootSOS.PresetsTable.@overPresentationTargetFcOrder/1000;
	
	var totAccum   = 0;	
	
	if (addDetails(rootSOS, totVoServiceTime, totVoProductionTime, addDetailLines)) {
		if ((totVoServiceTime.tc - totVoProductionTime.csoTc) > 0) {
			outputBuffer.append(details);
			addTotals();
			if(Country =="UK") //we cannot use the presetsTarget function because the format must be different based on the report
			{
				addLine();
				var line = API.setOnLeft(API.getLocalMsg("MSG_REPORT_SOSD10_TARGETS"),22);
				line = line+ API.getLocalMsg("MSG_REPORT_SOSD10_PSNT")+" "+ API.formatNumber(pnstTarget, "#0", 2);
				line = line+ " "+API.getLocalMsg("MSG_REPORT_SOSD10_TOTL")+" "+ API.formatNumber(totlTarget, "#0", 2)
				addLine(line);
			}
			else
			{
				presetsTarget(totlTarget, pnstTarget);
			}
		} else {
			addLine();
			addLine(center("No Data for the date requested"));
			addLine();
		}
	}
	
	addFooter(rootSOS);
	
	if(Country == "UK")
	{  //add legend
		addLegend("MSG_REPORT_SOSD10_FCR_LEGEND");
	}
	
	return getResponse();
	
	function addTotals() {
		addLine();
		if(API.getLocalMsg("MSG_REPORT_SOSD10_FCR_HEADER1")!="MSG_REPORT_SOSD10_FCR_HEADER1")
		{
			addLine(API.getLocalMsg("MSG_REPORT_SOSD10_FCR_HEADER1"));
		}
		else
		{
			addLine("TIME PRODSALE T/C   AVG  OVRP  OVTOTL ");
		}

		if(API.getLocalMsg("MSG_REPORT_SOSD10_FCR_HEADER3")!="MSG_REPORT_SOSD10_FCR_HEADER3")
		{
			addLine("              "+API.getLocalMsg("MSG_REPORT_SOSD10_FCR_HEADER3"));
		}
		else
		{
			addLine("                 OT/CASH  PSNT   TOTL");
		}
		
		var ovra        = totVoProductionTime.tcOverPresentationTimeFcOrder - totVoProductionTime.csoTcOverPresentationTimeFcOrder;
		var pvtotl      = totVoProductionTime.tcOverTotalTimeFcOrder - totVoProductionTime.csoTcOverTotalTimeFcOrder;
        var tc          = (totVoServiceTime.tc)-(totVoProductionTime.csoTc)
		var untilServe  = ((totVoServiceTime.untilServe) - (totVoProductionTime.csoUntilServe))/1000;
		var untilCloseDrawer = ((totVoServiceTime.untilCloseDrawer) - (totVoProductionTime.csoUntilCloseDrawer))/1000;
		var untilTotal = ((totVoServiceTime.untilTotal) - (totVoProductionTime.csoUntilTotal))/1000;
		var untilPay    = ((totVoServiceTime.untilPay) - (totVoProductionTime.csoUntilPay))/1000; 
		var totalAmount = ((totVoServiceTime.totalAmount) - (totVoProductionTime.csoTotalAmount));
		var ot_cash     = (((untilCloseDrawer!=0)?untilCloseDrawer:untilPay)/tc);
		var cash =0;
		var ot = 0;
		if(tc !=0)
		{
			ot			= untilTotal/tc;
			cash 		= (((untilCloseDrawer!=0)?untilCloseDrawer-untilTotal:untilPay-untilTotal)/tc);
		}
		var pnst        = (((tc!=0)&&(untilServe > untilCloseDrawer))?(untilServe - untilCloseDrawer)/tc:0) 
		var totl        = ((tc!=0)?((untilServe > untilCloseDrawer)?untilServe:untilCloseDrawer)/tc:0);

		var line1 = API.formatNumber(totalAmount, "######0", 10) + " " + 
				API.formatNumber(tc, "##0", 5) + " " + 
				API.formatNumber(totalAmount / tc, "####0.0", 6) + "  "  + 
				API.formatNumber(ovra, "##0", 4) + "    " + 
				API.formatNumber(pvtotl, "##0", 4);
	
		var line2;
		if(Country =="UK")
		{
			line2 = ("   " + "       " + "   " + 
				API.formatNumber(ot, "##0", 3) + " " + 
				API.formatNumber(cash, "##0", 5) + "    " + 
				API.formatNumber(pnst, "##0", 3) + "    " + 
				API.formatNumber(totl, "##0", 4));
		}
		else
		{
			line2 = ("   " + "       " + "   " + 
				API.formatNumber(ot_cash, "##0", 9) + "     " + 
				API.formatNumber(pnst, "##0", 2) + "    " + 
				API.formatNumber(totl, "##0", 4));
		}		
	    addLine(line1);
		addLine(line2);
	}
	
	function addDetailLines(curHour, hSegments) {
		var vo    = {};
		var csoVo = {};
		for (var prop in totVoServiceTime) vo[prop] = 0;
		for (var prop in totVoProductionTime) csoVo[prop] = 0;
		
		var xmlProp = null;
		var emptySegment = true;
		
		for (var i = 0; i < hSegments.length; i++) {
			for (var prop in vo) vo[prop] += Number(hSegments[i].attribute(prop));
			var nodeProductionTime = hSegments[i].ProductionTime;
			if (nodeProductionTime) { // On KS Sales, this tag does not exist
				for (var prop in csoVo) csoVo[prop] += Number(nodeProductionTime.attribute(prop));
			}
		}
		var totAvc_ac               = 0;
		csoTotalAmount              = vo.totalAmount - csoVo.csoTotalAmount;
		csoTc                       = vo.tc - csoVo.csoTc;
		csoUntilTotal               = (vo.untilTotal - csoVo.csoUntilTotal)/1000;
		csoUntilCloseDrawer         = (vo.untilCloseDrawer - csoVo.csoUntilCloseDrawer)/1000;
		csoUntilServe               = (vo.untilServe - csoVo.csoUntilServe)/1000;      
		csoUntilPay                 = (vo.untilPay - csoVo.csoUntilPay)/1000; 
		csoTcOverPresentationPreset = 0;
	    // Create line for Front Counter Sale Report
		totAvc_ac	=  (csoTc!=0)?csoTotalAmount/csoTc:0;
		totAccum   += csoTotalAmount;
		// Add to totals
		for (var prop in totVoServiceTime) totVoServiceTime[prop] += vo[prop];
		for (var prop in totVoProductionTime) totVoProductionTime[prop] += csoVo[prop];

		var ovra	= csoVo.tcOverPresentationTimeFcOrder - csoVo.csoTcOverPresentationTimeFcOrder;
		var pvtotl  = csoVo.tcOverTotalTimeFcOrder - csoVo.csoTcOverTotalTimeFcOrder;
        var ot_cash = (((csoUntilCloseDrawer!=0)? csoUntilCloseDrawer: csoUntilPay)/csoTc);    
		
		var ot= 0; //csoUntilCloseDrawer/csoTC;
		var cash =0;
		if(csoTc != 0)
		{
			ot			= csoUntilTotal/csoTc;
			cash 		= (((csoUntilCloseDrawer!=0)?csoUntilCloseDrawer-csoUntilTotal:csoUntilPay-csoUntilTotal)/csoTc);
		}
		
		var pnst	= ((csoTc!=0)&&(csoUntilServe > csoUntilCloseDrawer))?(csoUntilServe - csoUntilCloseDrawer)/csoTc:0;	// SDE-1284			
		var totl	= (csoTc!=0)?((csoUntilServe > csoUntilCloseDrawer)? csoUntilServe:csoUntilCloseDrawer)/csoTc:0;			// SDE-1284

		var line1 = API.formatNumber(curHour +1, "00", 2) + ":00 " + 
				API.formatNumber(csoTotalAmount, "######0", 4) + " " + 
				API.formatNumber(csoTc, "##0", 5) + " " + 
				API.formatNumber(totAvc_ac, "####0.0", 6) + "  "  + 
				API.formatNumber(ovra, "##0", 4) + "    " + 
				API.formatNumber(pvtotl, "##0", 4);
		var line2;		
		if(Country =="UK")
		{
			line2 = ("   " + API.formatNumber(totAccum, "######0", 7) + "   " + 
				API.formatNumber(ot, "##0", 3) + " " + 
				API.formatNumber(cash, "##0", 5) + "     " + 
				API.formatNumber(pnst, "##0", 2) + "    " + 
				API.formatNumber(totl, "##0", 4));
		}
		else
		{
			line2 = ("   " + API.formatNumber(totAccum, "######0", 7) + "   " + 
				API.formatNumber(ot_cash, "##0", 9) + "     " + 
				API.formatNumber(pnst, "##0", 2) + "    " + 
				API.formatNumber(totl, "##0", 4));
		}		
		details.append(line1);
		details.append("\n");
		details.append(line2);
		details.append("\n");
	}
}

/**
 * PUBLIC
 * Responsible for formating the SOS D10 "D10 Drive Thru Sales Report" for WayStation
 * Needed data types: CASH|SOS (from FC production)
 * PLE-177
 * @author Lsouza
 */
function reportSosD10WayDTRH(config, data){
	return reportSosD10DTRH(config, data, true);
}

/**
 * PUBLIC
 * Responsible for formating the SOS D10 "D10 Drive Thru Sales Report"
 * Needed data types: CASH|SOS (from DT production)
 * PLE-177
 * @author Lsouza
 */
function reportSosD10DTRH(config, data, isWay) {
	
	if(init(config, data, Array("CASH","SOS"), "RSDTRH") != 0){
		return getResponse();
	}
	if (isWay){
		var title = ""; 
	}else{
		var ctx = new SessionContext;
		var title = ctx.get('sosRptTitle');	
	}
	
	if(Country == "UK")
	{
		addHeader(rootCash, API.getLocalMsg("MSG_REPORT_SOSD10_DTH_TITLE"));
	}
	else
	{
		addHeader(rootCash, "D10 Drive Thru Sales Report " + addTitle(title));	
	}
	if(API.getLocalMsg("MSG_REPORT_SOSD10_DTH_HEADER1")!="MSG_REPORT_SOSD10_DTH_HEADER1")
	{
		addLine(API.getLocalMsg("MSG_REPORT_SOSD10_DTH_HEADER1"));
	}
	else
	{
		addLine("TIME PRODSALE T/C  AVG OVRP OVTOTL HLD#");	
	}
	if(API.getLocalMsg("MSG_REPORT_SOSD10_DTH_HEADER2")!="MSG_REPORT_SOSD10_DTH_HEADER2")
	{
		addLine("    "+API.getLocalMsg("MSG_REPORT_SOSD10_DTH_HEADER2"));
	}
	else
	{
		addLine("    CARSV  OT  LT  CASH/PSNT  TOTL HOLD");
	}
	var totVoServiceTime    = {cars: 0, tc: 0, untilTotal: 0, untilStore: 0, untilRecall: 0, untilCloseDrawer: 0, untilPay: 0, untilServe: 0, totalTime: 0, tcOverPresentationPreset: 0, tcOverTotalFC: 0, totalAmount: 0, tcOverTotalDT: 0, tcOverTotalPreset: 0};
	var totVoProductionTime = {tcOverCashPresentationPreset: 0, tcHeld: 0, heldTime: 0};
	var totlTarget = rootSOS.PresetsTable.@totalTarget/1000;
	var pnstTarget = rootSOS.PresetsTable.@presentationTarget/1000;

	if (addDetails(rootSOS, totVoServiceTime, totVoProductionTime, addDetailLines)) {
		addTotals();
		
		if(Country =="UK") //we cannot use the presetsTarget function because the format must be different based on the report
		{
			addLine();
			var line = API.setOnLeft(API.getLocalMsg("MSG_REPORT_SOSD10_TARGETS"),20);
			line = line+ API.getLocalMsg("MSG_REPORT_SOSD10_PSNT")+" "+ API.formatNumber(pnstTarget, "#0", 2);
			line = line+ " "+API.getLocalMsg("MSG_REPORT_SOSD10_TOTL")+" "+ API.formatNumber(totlTarget, "#0", 2)
			addLine(line);
		}
		else
		{
			presetsTarget(totlTarget, pnstTarget);
		}
	}
	addFooter(rootSOS);
	
	if(Country == "UK")
	{  //add legend
		addLegend("MSG_REPORT_SOSD10_DTH_LEGEND");
	}
	return getResponse();
	
	function addTotals() {

		addLine();
        var tc          = (totVoServiceTime.tc);
        var cars        = (totVoServiceTime.cars);
		var untilStore  = (totVoServiceTime.untilStore)/1000;
		var untilRecall = (totVoServiceTime.untilRecall)/1000;
		var untilCloseDrawer = (totVoServiceTime.untilCloseDrawer)/1000;
		var untilServe  = (totVoServiceTime.untilServe)/1000;
		var totalAmount = (totVoServiceTime.totalAmount);
		var tcHeld      = totVoProductionTime.tcHeld;
		var heldTime    = totVoProductionTime.heldTime;
		var totAvc_ac   = (tc!=0)?Number(totalAmount/tc):0;			

		var ot          = (tc!=0)?untilStore/tc:0;
		var lt          = (tc!=0)?(untilRecall-untilStore) /tc:0;
		var ovrp        = totVoProductionTime.tcOverCashPresentationPreset;
		var cash	    = (tc!=0)?(untilCloseDrawer - untilRecall)/tc:0;
		var psnt	    = ((tc!=0)&&(untilServe > untilCloseDrawer))?(untilServe - untilCloseDrawer)/tc:0;
		var cash_psnt   = cash + psnt;
		var totl        = ot + lt + cash_psnt;
		var ovtotl      = totVoServiceTime.tcOverTotalPreset;
		var hld	        = totVoProductionTime.tcHeld; 
		var hold        = ((hld!=0)?totVoProductionTime.heldTime/hld:0)/1000;
		var line1;
		if(Country =="UK")
		{
			line1 = addLine("TOTAL  " + 
				API.formatNumber(totalAmount, "#####0", 6) + " " + 
				API.formatNumber(tc, "##0", 3) + " " + 
				API.formatNumber(totAvc_ac, "#0.00", 5) + "  " + 
				API.formatNumber(ovrp,"##0", 3) + "   " + 
				API.formatNumber(ovtotl,"##0", 3) + "  " + 
				API.formatNumber(hld,"##0", 3));
			    addLine("      " + 
			    API.formatNumber(cars, "##0", 3) + " " + 
			    API.formatNumber(ot, "##0", 3) + " " + 
			    API.formatNumber(lt, "##0", 3) + "   " + 
			    API.formatNumber(cash, "##0", 0) + "  " + 
				API.formatNumber(psnt, "##0", 0) + "  " + 
			    API.formatNumber(totl, "###0", 4) + "  " + 
			    API.formatNumber(hold, "##0", 3));
		}
		else
		{
			line1 = addLine("TOTAL  " + 
				API.formatNumber(totalAmount, "#####0", 6) + " " + 
				API.formatNumber(tc, "##0", 3) + " " + 
				API.formatNumber(totAvc_ac, "#0.00", 5) + "  " + 
				API.formatNumber(ovrp,"##0", 3) + "   " + 
				API.formatNumber(ovtotl,"##0", 3) + "  " + 
				API.formatNumber(hld,"##0", 3));
			    addLine("      " + 
			    API.formatNumber(cars, "##0", 3) + " " + 
			    API.formatNumber(ot, "##0", 3) + " " + 
			    API.formatNumber(lt, "##0", 3) + "   " + 
			    API.formatNumber(cash_psnt, "##0", 0) + "  " + 
			    API.formatNumber(totl, "###0", 9) + "  " + 
			    API.formatNumber(hold, "##0", 3));
		}
	}
	
	function addDetailLines(curHour, hSegments) {
	    // Create line for D10 Drive thru Sale Report
		var vo = {};
		var pt = {};

		for (var prop in totVoServiceTime) vo[prop] = 0;
		for (var prop in totVoProductionTime) pt[prop] = 0;
		
		var xmlProp = null;
		var emptySegment = true;
		
		for (var i = 0; i < hSegments.length; i++) {
			for (var prop in vo) vo[prop] += Number(hSegments[i].attribute(prop));
			var nodeProductionTime = hSegments[i].ProductionTime;
			if (nodeProductionTime) { // On KS Sales, this tag does not exist
				for (var prop in pt) pt[prop] += Number(nodeProductionTime.attribute(prop));
			}
		}
		// Add to totals
		for (var prop in totVoServiceTime) totVoServiceTime[prop] += vo[prop];
		for (var prop in totVoProductionTime) totVoProductionTime[prop] += pt[prop];

		var totalAmount = (vo.totalAmount);
 	 	var tc          = (vo.tc);
		var totAvc_ac   = totAvc_ac = (tc!=0)?Number(totalAmount/tc):0;				
		var ovrp        = pt.tcOverCashPresentationPreset;
		var ovtotl      = vo.tcOverTotalPreset;
		var hld	        = pt.tcHeld; 
      	var cars        = (vo.cars);
		var untilStore  = (vo.untilStore)/1000;
		var untilRecall = (vo.untilRecall)/1000;
		var untilCloseDrawer = (vo.untilCloseDrawer)/1000;
		var untilServe  = (vo.untilServe)/1000;
		var ot          = (tc!=0)?untilStore/tc:0;
		var lt          = (tc!=0)?(untilRecall-untilStore) /tc:0;
		var cash	    = (tc!=0)?(untilCloseDrawer - untilRecall)/tc:0;
		var psnt	    = ((tc!=0)&&(untilServe > untilCloseDrawer))?(untilServe - untilCloseDrawer)/tc:0;
		var cash_psnt   = cash + psnt;
		var totl        = ot + lt + cash_psnt;
		var hold        = ((hld!=0)?pt.heldTime/hld:0)/1000;

		var line1 =  API.formatNumber(curHour +1, "00", 2) + ":00  " +
				API.formatNumber(totalAmount, "#####0", 6) + " " + 
				API.formatNumber(tc, "##0", 3) + " " + 
				API.formatNumber(totAvc_ac, "#0.00", 5) + "  " + 
				API.formatNumber(ovrp,"##0", 3) + "   " + 
				API.formatNumber(ovtotl,"##0", 3) + "  " + 
				API.formatNumber(hld,"##0", 3);
		var line2;
		
		if(Country =="UK")
		{
			line2 =	("      " + API.formatNumber(cars, "##0", 3) + " " + 
				API.formatNumber(ot, "##0", 3) + " " + 
				API.formatNumber(lt, "##0", 3) + "   " + 
				API.formatNumber(cash, "##0", 0) + "  " + 
				API.formatNumber(psnt, "##0", 0) + "  " + 
				API.formatNumber(totl, "###0", 4) + "  " + 
				API.formatNumber(hold, "##0", 3));
		}
		else
		{
			line2 =	("      " + API.formatNumber(cars, "##0", 3) + " " + 
				API.formatNumber(ot, "##0", 3) + " " + 
				API.formatNumber(lt, "##0", 3) + "   " + 
				API.formatNumber(cash_psnt, "##0", 0) + "  " + 
				API.formatNumber(totl, "##0", 9) + "  " + 
				API.formatNumber(hold, "##0", 3));
		}				
		addLine(line1);
		addLine(line2);
	}
}


function addLegend(msgName)
{
	startSmallFont();
	if(API.getLocalMsg(msgName) != msgName) //the message is defined
	{
		addLine(API.getLocalMsg(msgName));
	}
	else
	{
		return; //no message defined
	}
	//search for other messages
	exit = false;
	var i=1;
	while(exit == false)
	{
		if(API.getLocalMsg(msgName+i) != (msgName+i))
		{
			addLine(API.getLocalMsg(msgName+i));
			i++;
		}
		else
		{
			exit = true;
		}
	}
	endSmallFont();
}
/**
 * PRIVATE
 * Responsible for formating the D10 Concept SOS.
 * @author Lsouza 
 */
function addDetails(root, totVoServiceTime, totVoProductionTime, addDetailLines) {
		
		var hours 	 = new Array(24); 
		var accum    = 0;
		// Iterates over all segments, adding and consolidating values
		return iterateSosSegments(root, addDetailLines);
}

/**
 * PRIVATE
 * Iterates over SOS segments, calling the given callback at every one-hour.
 * @author Lsouza 
 */
function iterateSosSegments(root, callback) {

	if (root.StoreTotals.ServiceTime.length() == 0) {
		addLine();
		addLine(center("No Data for the date requested"));
		addLine();
		return false;
	}
	var part;
	if (!root || !(part = root.DayPartitioning)) {
		return; // Empty xml
	}
	var segments       = part.Segment;
	var storeTotals    = root.StoreTotals;
	var ProductionTime = part.ProductionTime;
	
	//MS 12.08.2010 sort segments by begTime necessry for having pastmidnigth segments
	for(var i =0; i< segments.length(); i++)
	{
		for(var j=i+1; j < segments.length(); j++)
		{
			if(Number(segments[j].@begTime) <  Number(segments[i].@begTime) )
			{
				var temp = segments[j];
				segments[j] = segments[i];
				segments[i]	=temp;
			}
		}
	}
	
	var curSeg = 0;
	for (hour = 0; hour < 24; hour++) {
		var found = false;
		while (curSeg < segments.length()) {
			var hSegments = new Array();
			var curHour = parseInt(Number(segments[curSeg].@begTime) / 100); //1545 -> 15
			if (curHour == parseInt(Number(hour))) {
				found = true;
				var curDayOffset = parseInt(Number(segments[curSeg].@dayOffset));
				while (curSeg < segments.length() 
					&& (parseInt(Number(segments[curSeg].@begTime) / 100)) == curHour
					/*&& (parseInt(Number(segments[curSeg].@dayOffset))) == curDayOffset*/) { //MS 12.08.2010 comment line in order to have also the past midnigth segments
					service = storeTotals.ServiceTime.(@segmentId == segments[curSeg].@id);
					hSegments.push(service);
					curSeg++;
				}
				callback(curHour, hSegments);
			} else {
				break;
			}
		}
		if (!found) {
			callback(hour, new Array());
		}
	}
	return true;	
}

/**
 * PRIVATE
 * Responsible for include the title in D10 SOS Reports.
 * @author Lsouza 
 */
function addTitle(title){

	var queues = "";
	if (title.length > 0 ) {
		var index = title.indexOf("(Class ");
		queues = title.substring(index + 7, title.length - 1);
	}
	return queues;
}

/**
 * PRIVATE
 * Responsible for formating the Presets Target for D10 reports.
 * @author Lsouza 
 */
function presetsTarget(totlTarget, pnstTarget) {
	
	addLine();
		
	addLine("         PRESET        PRESET         ");
	addLine("         TOTL   " + 
	API.formatNumber(totlTarget, "#0", 2) + "     PSNT  " + 
	API.formatNumber(pnstTarget, "#0", 2));
	
}

/* Finish function implements a generic SALE SOS report */


/**
 * PUBLIC
 * Responsible for formating the Time Punch report for a single user.
 * Needed data types: TIMEPUNCH
 * @author Gustavo 
 */
function reportSingleTimePunch(config, data) 
{
	
	//By Period PMIX REPORT
	if(init(config, data, Array("TIMEPUNCH"), "TIMREC") != 0) {
		return getResponse();
	}	
	var user=rootTimePunch.Users.User;
	addLine(SEP_DL);
	addLine(center(API.getLocalMsg("MSG_RECEIPT_TIME_PUNCH_RECEIPT")));
	addLine(center(API.getLocalMsg("MSG_RECEIPT_DATE") + API.formatDate(rootTimePunch.@requestDate,"MM/dd/yyyy") + "    " +API.getLocalMsg("MSG_RECEIPT_STORE") + "# " + rootConfig.StoreId));
	addLine(SEP_DL);
	addLine(API.getLocalMsg("MSG_RECEIPT_EMPLOYEE_ID")+user.@id);
	addLine(API.getLocalMsg("MSG_RECEIPT_EMPLOYEE_NAME")+user.@name);
	addLine();
	addLine("Time Punch Data");
	addLine("        Punch      Punch       Elapsed");
	addLine("          In        Out          Time");
	var bOpen=false;
	for each (timeInfo in user.Time) {
		addLine("        "+timeInfo.@intime+"      "+timeInfo.@outtime+"        "+timeInfo.@elapsed);
		if((timeInfo.@intime == "*****") || (timeInfo.@outtime == "*****")) {
			bOpen=true;
		}
	}
	addLine("                               -------");
	addLine("       Total Hours              "+((bOpen)?"*****":user.Total.@time));
	addLine();
	addLine("Note: Total hours may differ on ISP");
	addFooter(rootTimePunch);
	return getResponse();
};

/**
 * PUBLIC
 * Responsible for formating the Time Punch report for the store.
 * Needed data types: TIMEPUNCH
 * @author Gustavo 
 */
function reportGlobalTimePunch(config, data) 
{
	//By Period PMIX REPORT
	if(init(config, data, Array("TIMEPUNCH"), "TIMREC") != 0) {
		return getResponse();
	}	
	addLine(SEP_DL);
	addLine(center(API.getLocalMsg("MSG_RECEIPT_DAILY_TIME_PUNCH_REPORT")));
	addLine(center(API.getLocalMsg("MSG_RECEIPT_BUSINESS_DATE") + API.formatDate(rootTimePunch.@requestDate,"MM/dd/yyyy")));
	addLine(center(API.getLocalMsg("MSG_RECEIPT_TIME") + API.formatTime(rootTimePunch.@creationDate.substring(9,17),"HH:mm:ss")));
	addLine(center(API.getLocalMsg("MSG_RECEIPT_STORE") + "#: " + rootConfig.StoreId));
	addLine(SEP_DL);
	for each (user in rootTimePunch.Users.User) {
		addLine();
		addLine(API.getLocalMsg("MSG_RECEIPT_EMPLOYEE_ID")+user.@id);
		addLine(API.getLocalMsg("MSG_RECEIPT_EMPLOYEE_NAME")+user.@name);
		var lines=0;
		var times=API.getLocalMsg("MSG_RECEIPT_TIME_PUNCHES");
		for each (timeInfo in user.Time) {
			if((lines%2) == 1) {
				times+=",";
			}
			times+=timeInfo.@intime;
			if(timeInfo.@outtime != "*****") {
				times+="," + timeInfo.@outtime;
			}
			lines++;
			if((lines%2) == 0) {
				addLine(times);
				times="             ";
			}
		}
		addLine(times);
	}
	addLine();
	addFooter(rootTimePunch);
	return getResponse();
};

/**
 * Gets eatin+takeout+other quantity from a "PMix" node.
 * @param nodePMix "PMix" node
 * @return an int representing the total quantity.
 */
function getPMixTotalQty(nodePMix) 
{
	if(nodePMix != null) {
		var valueqtyEatIn   = 0;
		var valueqtyTakeOut = 0;
		var valueqtyOther   = 0;
		
		for each (var i in nodePMix) {
			valueqtyEatIn 	+= Number(i.@qtyEatIn);
			valueqtyTakeOut += Number(i.@qtyTakeOut);
			valueqtyOther 	+= Number(i.@qtyOther);
		}
		
		return new Number(valueqtyEatIn)
			+ new Number(valueqtyTakeOut)
			+ new Number(valueqtyOther);
	}else {
		return 0;
	}
}

//*******report_isp.nps*******************************
/**
 * Gets eatin+takeout+other netAmount from a "PMix" node.
 * @param nodePMix "PMix" node
 * @return an int representing the total netAmount.
 */
function getPMixTotalnetAmount(nodePMix) 
{
	if(nodePMix != null) {
		var valuenetAmount			= new BigDecimal("0.00");
/*
		var valuenetAmountEatIn	= new BigDecimal("0.00");
		var valuenetAmountTakeOut	= new BigDecimal("0.00");
		var valuenetAmountOther	= new BigDecimal("0.00");
*/
		for each (var i in nodePMix) {
			valuenetAmount=valuenetAmount.add(new BigDecimal(i.@netAmtEatIn));
			valuenetAmount=valuenetAmount.add(new BigDecimal(i.@netAmtTakeOut));
			valuenetAmount=valuenetAmount.add(new BigDecimal(i.@netAmtOther));
/*
			valuenetAmountEatIn=valuenetAmountEatIn.add(new BigDecimal(i.@netAmtEatIn));
			valuenetAmountTakeOut=valuenetAmountTakeOut.add(new BigDecimal(i.@netAmtTakeOut));
			valuenetAmountOther=valuenetAmountOther.add(new BigDecimal(i.@netAmtOther));
*/
		}
		return  (valuenetAmount);
/*
		return(new Number(valuenetAmountEatIn)
			+ new Number(valuenetAmountTakeOut)
			+ new Number(valuenetAmountOther));
*/
	}else {
		return new BigDecimal("0.00");
	}
}

/** Finds the currently logged operator */
function findCurrentOperator(rootNode) 
{
	for each (rootPos in rootNode.POS){
		flagTypePos    = String(rootPos.@podShort);	
		for each (i in rootPos.OperatorSession) {
			if(String(i.@logout) == "") { 
			return i;			
			}
		}
	}
	return null;
}

/** find outh whitch number of the report is this for current day **/
function findOperatorReportNumber(rootNode)
{
	var rpNumber = 1;
	for each (rootPos in rootNode.POS){
		flagTypePos    = String(rootPos.@podShort);	
		for each (i in rootPos.OperatorSession) {
			rpNumber = rpNumber + 1;
			if(String(i.@logout) == "") { 
			return rpNumber;			
			}
		}
	}
	return 1;
}

function findLastOperatorReportNumber(rootNode)
{
	var rpNumber = 1;
	if(Country == "FR")
	{
		rpNumber = 0;
	}
	var lastOper = null;
	var lastDate = "20000101 00:00:00";
	for each (rootPos in rootNode.POS){
		for each (i in rootPos.OperatorSession) {
			if(String(i.@logout) >= lastDate && Country !="FR") { 
				flagTypePos    = String(rootPos.@podShort);	
				lastDate = i.@logout;
				lastOper = i;
				rpNumber = rpNumber + 1;
			}
			if(String(i.@login) >= lastDate && Country == "FR")
			{
				flagTypePos    = String(rootPos.@podShort);	
				lastDate = i.@login;
				lastOper = i;
				rpNumber = rpNumber + 1;
			}
		}
	}
	return rpNumber;
}

/** Finds last logged operator */
function findLastOperator(rootNode) 
{
	var lastOper = null;
	var lastDate = "20000101 00:00:00";
	for each (rootPos in rootNode.POS){
		for each (i in rootPos.OperatorSession) {
			if(String(i.@logout) >= lastDate) { 
				flagTypePos    = String(rootPos.@podShort);	
				lastDate = i.@logout;
				lastOper = i;
			}
		}
	}
	return lastOper;
}

/** Adds the default header for reports */
function addHeader(rootNode, title, reportType) 
{
   var consolidate = false;
   if((reportType == RPTCASHCONSOLIDATED) || (reportType == RPTCASHBYPERIODSW) ||
				(reportType == RPTINTCASHCONSOLIDATED) ||
			    (reportType == RPTPMIXBYDATESW)     || (reportType  == RPTPMIXBYPERIODSW)||
			    (reportType == RPTPMIXUPTBYHOURSW)  || (reportType  == RPTPMIXUPTBYDATESW) ||
	   		    (reportType == RPTSALEFCSW) 		|| (reportType  == RPTSALEHOURBYDATESW)||
	   		    (reportType == RPTSALEAVETKCDATESW) || (reportType == RPTCASHENDDAYSTOREWIDE))
	{
		consolidate = true;
	}

	//var boHelper		= new BusinessObjectHelper;
	API.dbg("addHeader rootNode "+ rootNode);
	API.dbg("addHeader rootConfig " + rootConfig);
	 // API.dbg("Country "+Country +" flag " +flag);	
	var storeId			= Number(rootConfig.StoreId);
	var posId			= getPosId();
	var storeName		= rootConfig.StoreName;
	var managerId		= Number(rootConfig.Manager.@id);
	var nodesPOS		= rootNode.POS;
	var businessDate	= getBusinessDate(nodesPOS);
	//var taxNumber		= 
	if(businessDate != "N/A") {
		businessDate	= API.formatDate(businessDate, "dd/MM/yyyy"); //is MM/dd//YYY in report_isp.nps
	}
	
	//03.03.2009 OI add header Logo
	outputBuffer.append("<@McLogoPart1>");
	outputBuffer.append("<@McLogoPart2>");
	
	addLine(SEP_DL);
	if(Country != "DE" )
	{
		if(Country != "UK")
		{
		
			addDefaultHeader();
		}
		//addLine(center(storeName));
		if(title.length == 2)
		{
			addLine(center(title[0])); 
			startSmallFont();
			addLine(title[1]); 
			endSmallFont();
		}
		else
		{
			addLine(center(title));
		}
		
	}
	//addLine(center("BUSINESS DATE: " + businessDate));
	
	if(Country == "DE" )
	{
		if(posId != 0){
		addLine(center(API.getLocalMsg("MSG_RECEIPT_STORE")+ "# " + storeId + API.getLocalMsg("MSG_RECEIPT_POS")+ "# " + posId));
		}
		else{
			addLine(center(API.getLocalMsg("MSG_RECEIPT_STORE")+ "# " + storeId ));
		}

		addLine(center(storeName));
		addLine();
		addLine(center(API.getLocalMsg("MSG_RECEIPT_BUSINESSDAY")+ " " + businessDate));
		addLine();
		if((reportType == RPTSOSFC) || (reportType == RPTSOSDTHOUR) ||
		(reportType == RPTSOSDTDIAG) || (reportType  == RPTSOSMFY) || (reportType  == RPTSOSCSR)){
			var date = API.formatDateTime(rootNode.@creationDate, RECEIPT_DATE_FORMAT);
			addLine(center(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID")+": " + managerId + "   " + API.setOnRight(date, COLS-posId.length)));
		}
		else {
			addLine(center(API.getLocalMsg("MSG_RECEIPT_MANAGER_ID")+": " + managerId));
		}
		addLine();
		addLine("SUP-SIGN     MGR.SIGN    ASST/CREW-SIGN");
		addLine();
		addLine();
		if(title) {
			addLine(SEP_DL);
			addLine(center(title));
			if((reportType == RPTCASHCONSOLIDATED) || (reportType == RPTCASHBYPERIODSW) ||
				(reportType == RPTINTCASHCONSOLIDATED) ||
			    (reportType == RPTPMIXBYDATESW)     || (reportType  == RPTPMIXBYPERIODSW)||
			    (reportType == RPTPMIXUPTBYHOURSW)  || (reportType  == RPTPMIXUPTBYDATESW) ||
	   		    (reportType == RPTSALEFCSW) 		|| (reportType  == RPTSALEHOURBYDATESW)||
	   		    (reportType == RPTSALEAVETKCDATESW)){
					addLine(center("POD:" + (rootNode.@requestPOD==""?"ALL":rootNode.@requestPOD)));
			}
			addLine(SEP_DL);
		}
	}   
	else if(Country == "UK")
	{
		
		if(consolidate == true)
		{
			addLine(center(API.getLocalMsg("MSG_REPORT_HEADER_STW")));
		}
		/*
		else
		{
			if(Number(posId) !=0)
			{
				addLine(center("POS"+Number(posId)));
			}
			else
			{
				addLine(center(API.getLocalMsg("MSG_REPORT_FROM_WAYSTATION_WEB")));
			}
		}
		*/
		addLine(SEP_DL);
		
	}
	else
	{
		//france request
		var showDay=false;
		var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"ConsolidatedReport\").Parameter.(@name==\"addHeaderList\").@value";
		var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"ConsolidatedReport\").Parameter.(@name==\"addHeaderList\").@value";
		var addHeaderList =""+ getConfigValue(storedbPath , posdbPath);

		if((Country =="FR")) 
		{
			if(consolidate == true )
			{
				if (rootNode.@requestPOSList != "")
				{
					addLine(center(API.getLocalMsg("MSG_RECEIPT_POSES") +" "+rootNode.@requestPOSList));
				}
				else if (rootNode.@requestPOD != "")
				{
					addLine(center(API.getLocalMsg("MSG_RECEIPT_POSES") +" "+rootNode.@requestPOD));
				}
				else 
				{
					addLine(center(API.getLocalMsg("MSG_RECEIPT_POSES") +" "+ API.getLocalMsg("MSG_RECEIPT_ALLPOS")));
				}
			}
			if(businessDate != "N/A")
			{
				   //API.dbg("addHeader: "+ nodesPOS[0]);
				   var lineDay= API.getLocalMsg("MSG_RECEIPT_BUSINESSDAY") + " " + businessDate;
				   //API.dbg("addheader nodesPOS "+ nodesPOS.(@status !="CLOSED"));
				   if(nodesPOS.(@status !="CLOSED")+"" == "")
				   {
				      lineDay += "( " +API.getLocalMsg("MSG_DAY_CLOSE") +" )";
				   }
				   addLine(center(lineDay));
				   showDay = true;
			}
		}
		else if (Number(addHeaderList+"")==1 && consolidate == true) //for consolidate report if we have the option set in sotre wide we need to display the list of pos in the system	
		{
		    var posList ="";
			var posList1 ="";
			for each (i in nodesPOS) 
			{
				posList = posList + Number(i.@id) + " ";
				if(Number(posList.length) >25) //if the string si to long we cannot display it on the receipt
				{
				   posList1 =posList;
				   posList ="";
				}
				
			}	
			addLine(center(API.getLocalMsg("MSG_RECEIPT_POSES") +" " +posList1));
			addLine(center(posList));
			
		}
		if(showDay == false)
		{
			addLine(center(API.getLocalMsg("MSG_RECEIPT_BUSINESSDAY") + " " + businessDate));
		}
		
		if(posId != "N/A")
		{
			//addLine(center("STORE# " + storeId + " POS# " + posId));
			//addLine(center("POS# " + posId));
			addLine(center(API.getLocalMsg("MSG_RECEIPT_POS") + "# " + posId));	
		}
		else{
			//addLine(center("STORE# " + storeId ));
			addLine(center(API.getLocalMsg("MSG_RECEIPT_STORE") + "# " + storeId ));
		}
		var vatNumber = (xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="VAT").Parameter.(@name=="VatNumber")).@value;
		if(Country !="AT" && Country !="FR")
		{
			addLine(center(vatNumber));
		}
		addLine(SEP_DL);
	}
	/*if((reportType == RPTSOSFC) || (reportType == RPTSOSDTHOUR) ||
	   (reportType == RPTSOSDTDIAG) || (reportType  == RPTSOSMFY) || (reportType  == RPTSOSCSR)){
	    var date = API.formatDateTime(rootNode.@creationDate, RECEIPT_DATE_FORMAT);
		addLine(center("MANAGER: " + managerId + "   " + API.setOnRight(date, COLS-posId.length)));
	}
	else {
		addLine(center("MANAGER: " + managerId));
	}
	addLine();
	addLine("SUP-SIGN     MGR.SIGN    ASST/CREW-SIGN");
	addLine();
	addLine();*/
	
	//fr requestRPTPMIXUPTBYHOUR
	if(( (Number(reportType)  == Number(RPTPMIXUPTBYHOURSW)) || (Number(reportType)  == Number(RPTPMIXUPTBYHOUR)) )  && (Country =="FR" ))  //upt report: we need to add the time table to the report 
	{
		var uptHour = new Array();
		 var uptHour = rootConfig.CustomData.split(",");  //root.@requestTime.substring(0, 2);
		 var uptStartHour = uptHour[0].substring(0,2)+":"+ uptHour[0].substring(2,4);
		 var uptEndHour = uptHour[1].substring(0,2)+":"+ uptHour[1].substring(2,4);
		 
		 if(uptStartHour==":"){
			uptStartHour = "00:00";
		 }	
		 
         if(uptEndHour == "")
		 {
			uptEndHour = "01:00";
		 }	
		 addLine(center(API.getLocalMsg("MSG_RECEIPT_HEADER_INTERVAL") +" "+uptStartHour + " "+ API.getLocalMsg("MSG_RECEIPT_HEADER_INTERVAL_A")+" " + uptEndHour));
	}
	//for consolidated reports add the list of online and offline poses
	//france request
	if(consolidate == true && (Country == "FR" || Country =="DE" || Country =="IE"))
	{
			addLine(center(API.getLocalMsg("MSG_RECEIPT_CONSOLIDATE")));
			onlinePos = "";
			offlinePos = "";
			for each (i in nodesPOS) 
			{
				if(i.@businessDate !="" ) //we have some data on the requested date
				{
					onlinePos = onlinePos + Number(i.@id) + " ";
				}
				else //we do not have data for the requested date = POS OFFLINE
				{
					offlinePos = offlinePos + Number(i.@id) + " ";
				}
			}				
		if(onlinePos != "")
		{
			addLine(API.getLocalMsg("MSG_RECEIPT_LISTPOSONLINE") + onlinePos);
		}
		else
		{
		   addLine(API.getLocalMsg("MSG_RECEIPT_LISTPOSONLINE") + API.getLocalMsg("MSG_RECEIPT_EMPTYLISTPOS"));
		}
		
		if(offlinePos != "")
		{
			addLine(API.getLocalMsg("MSG_RECEIPT_LISTPOSOFFLINE") +offlinePos);
		}
		else
		{
			addLine(API.getLocalMsg("MSG_RECEIPT_LISTPOSOFFLINE") + API.getLocalMsg("MSG_RECEIPT_EMPTYLISTPOS"));
		}
		//finish adding the list of poss	
		addLine(SEP_DL);
	}
	
}

/** Adds the default footer for reports */
function addFooter(rootNode) 
{
	addLine(SEP_DL);
	//addLine(center("Printed on " + API.formatDateTime(rootNode.@creationDate)));
	if(Country =="UK")
	{
		var pos= getPosId();
		var line = API.getLocalMsg("MSG_RECEIPT_PRINTEDON") + " " + API.formatDateTime(rootNode.@creationDate);
		addLine(center(line));
		if(Number(pos)==0)
		{
			pos= API.getLocalMsg("MSG_REPORT_FROM_WAYSTATION");
		}
		line = " "+API.getLocalMsg("MSG_REPORT_SOURCE")+ " "+pos;
		addLine(center(line));
	}
	else
	{
		addLine(center(API.getLocalMsg("MSG_RECEIPT_PRINTEDON") + " " + API.formatDateTime(rootNode.@creationDate)));
	}
	addLine(SEP_DL);
}

/**
 * Finds the biggest business date on a list of POS nodes
 * @return business date in the format "yyyyMMdd HH:mm:ss"
 */
function getBusinessDate(nodesPos) 
{
	var nodesPosSize = nodesPos.length();
	var bestMillis = -1;
	var bestDate = "N/A";
	
	for(var i = 0; i < nodesPosSize; i++) {
		var nodePOS = nodesPos[i];
		var posDate = nodePOS.@businessDate;
		var posMillis = API.parseDateTime(posDate + " 00:00:00").getTime();
		if(posMillis > bestMillis) {
			bestMillis = posMillis;
			bestDate = posDate;
		}
	}
	return bestDate;
}
/**
 * Summs the values of the given attribute from all given nodes.
 * @nodes list of nodes to summ attributes
 * @attributeName name of the attribute to get value from
 * @return the summ of values of 0 if 'nodes' or 'attributeName' are null.
 */
function summNodesAttributeValues(nodes, attributeName) 
{
	if(nodes == null || attributeName == null) {
		return 0;
	}
	
	var total = 0;
	var size = nodes.length();
	if(size == 1){
		var cmd = "nodes.@" + attributeName;
		var value = eval(cmd);	
		total += Number(value);
	}
	else{
		for(var i = 0; i < size; i++) {
			var cmd = "nodes[" + i + "]" + ".@" + attributeName;
			var value = eval(cmd);
			total += Number(value);
		}
	}
	return total;
}

//
// Helper Functions
//

/*
 * Summs the values of the given attribute from all given nodes.
 * @nodes list of nodes to summ attributes
 * @attributeName name of the attribute to get value from
 * @return the summ of values of 0 if 'nodes' or 'attributeName' are null.
 */
function summNodesAttributeBigDecimalValues(nodes, attributeName) 
{
	if(nodes == null || attributeName == null) {
		return new BigDecimal("0.00");
	}
	
	var total = new BigDecimal("0.00");
	var size = nodes.length();
	
	if(size == 1){
		var cmd = "nodes.@" + attributeName;
		var value = new BigDecimal(eval(cmd));	
		//total += Number(value);
		total=total.add(value);
	}
	else{
		for(var i = 0; i < size; i++) {
			var cmd = "nodes[" + i + "]" + ".@" + attributeName;
			var value = new BigDecimal(eval(cmd));
			//total += Number(value);
			total=total.add(value);
		}
	}
	return total;
}

/** Parses 'val' to an integer, returning 0 if null or empty*/
function toInt(val) 
{
	if(!val || String(val) == "") {
		return 0;
	}
	// Must create a Number first because parseInt will resolve "010" as an octal number
	return parseInt(Number(val));
}
/** Prints a ruler to help developer align the report*/
function addRuler() 
{
	addLine("         1         2         3         4");
	addLine("1234567890123456789012345678901234567890");
}

/** Convenience method to center a string in the report */
function center(str) 
{
	return API.center(str, COLS);
}

/** Wraps XMLElement.getChild() to ignore null nodes */
function getChild(node, name) 
{
	return node == null ? null : node.name;
}

/** Wraps XMLElement.findFirst() to ignore null nodes */
function findFirst(node, name) 
{
	if(node == null || name == null) {
		return null;
	}
	var cmd = "node.." + name + "[0]";
	var value = eval(cmd);
	return value == null ? null : value;
}

/** Wraps XMLElement.findFirst() to ignore null nodes */
function find(node, attName, attValue) 
{
	if(node == null || attName == null || attValue == null) {
		return 0;
	}
	var cmd = "node.(@" + attName + " == " + attValue + ")";
	var value = eval(cmd);
	return node == null ? null : value;
}

/** Gets a numeric attribute in the form of a big-decimal, if not found, returns ZERO */
function getBigDecimalAttribute(node, attribute) 
{
	if(node != null) {
		var value = eval("node.@" + attribute) 
		if(value != null && value != "") {
			return new BigDecimal(value);
		}
	}
	return ZERO;
}

/** Gets an attribute value, if not found, returns "" */
function getAttribute(node, attribute) 
{
	if(node != null) {
		var value = eval("node.@" + attribute) 
		return String(value);
	}
	return "";
}
/** Gets a numeric attribute, if not found, returns 0 */
function getNumberAttribute(node, attribute) 
{
	if(node != null) {
		var cmd = "node.@" + attribute;
		var value = eval(cmd);
		if(value != null && value != "") {
			return Number(value);
		}
	}
	return 0;
}

/**Get the currency from STORE-DB*/
function getCurrency()
{
	//var posDB = new POSDB;
	//var currency = posDB.StoreDB.CurrencySymbol;
	//return currency;
	return "";
}

/** Returns a grill line description */
function getGrillDescription(nodeItemView, typeDescription) 
{
	var TYPE_COMMENT	= 6;
	// Item's description (name)
	
	
	var description = nodeItemView.longName;
	if (typeDescription == false) {
		var description = nodeItemView.description;
	}
	
	// Item's special modifiers
	switch (Number(nodeItemView.specialModifiers)) {
		case 1: return API.getLocalMsg("MSG_RECEIPT_LIGHT") + " " + description;
		case 2: return API.getLocalMsg("MSG_RECEIPT_ONLY") + " " + description;
	}
	// Default item quantity
	var defaultQtd = Number(nodeItemView.componentDefaultQtd);
	// Quantity that the item will have after grill eg.(1 cheese + (-1 cheese) -> zero)
	var quantity = defaultQtd + Number(nodeItemView.grilledQuantity);
	// The maximun quantity this item can have
	var maxQtd = Number(nodeItemView.componentMaxQtd);
	// Quantity that should be shown to user.
	var quantityToShow = Math.abs(Number(nodeItemView.grilledQuantity));
	var productType = nodeItemView.productType;

	if(defaultQtd == quantity) {
		return "(" + API.getLocalMsg("MSG_RECEIPT_ERROR") + " " + defaultQtd + ") " + description;
	}
	if(quantity == 0) {
		// If the item will have quantity of zero, we just show the remove sign. eg. "no cheese"
		return API.getLocalMsg("MSG_RECEIPT_NO") + " " + description;
	}
	if(defaultQtd == 0) {
		if(maxQtd == 1) {
			if(productType == TYPE_COMMENT) { // SDO-392
				return description;	
			}else {
				return API.getLocalMsg("MSG_RECEIPT_ADD") + " " + description;
			}
		}else {
			if(productType == TYPE_COMMENT) { // SDO-392
				if(nodeItemView.grilledQuantity == (defaultQtd+1)) {
					return description;	
				}
				else {
					if (quantityToShow == 1) {
						return API.getLocalMsg("MSG_RECEIPT_ADD") + " " + description;						
					} else {
						return API.getLocalMsg("MSG_RECEIPT_ADD") + " " + quantityToShow + " " + description;
					}
				}
			}else {
				if (quantityToShow == 1) {
					return API.getLocalMsg("MSG_RECEIPT_ADD") + " " + description;						
				} else {
					return API.getLocalMsg("MSG_RECEIPT_ADD") + " "+ quantityToShow + " " + description;
				}
				
			}
		}
	}else if(defaultQtd == 1) {
		if(maxQtd == 2) {
			return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;
		}else {
			if(productType == TYPE_COMMENT) { // SDO-392
				if(nodeItemView.grilledQuantity == (defaultQtd+1)) {
					return description;	
				}
				else {
					if (quantityToShow == 1) {
						return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;						
					} else {
						return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + quantityToShow + " " + description;
					}
				}
			}else {
				if (quantityToShow == 1) {
					return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;						
				} else {
					return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + quantityToShow + " " + description;
				}
			}
		}
	}else if(defaultQtd == 2) {
		if(maxQtd == 3 && quantity == 3) {
			return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;
		}else if(maxQtd > 3 && quantity > 2) {
			if(productType == TYPE_COMMENT) {// SDO-392
				if(nodeItemView.grilledQuantity == (defaultQtd+1)) {
					return description;	
				}
				else {
					if (quantityToShow == 1) {
						return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;						
					} else {
						return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + quantityToShow + " " + description;
					}
				}
			}else {
				if (quantityToShow == 1) {
					return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;						
				} else {
					return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + quantityToShow + " " + description;
				}
			}
		}else {
			if (quantityToShow == 1) {
				return API.getLocalMsg("MSG_RECEIPT_REM") + " " + description;						
			} else {
				return API.getLocalMsg("MSG_RECEIPT_REM") + " " + quantityToShow + " " + description;
			}
		}
	}else {
		if(maxQtd == (defaultQtd + 1) && quantity == maxQtd) {
			return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;
		}else if(quantity > defaultQtd) { 
			if(productType == TYPE_COMMENT) { // SDO-392
				if(nodeItemView.grilledQuantity == (defaultQtd+1)) {
					return description;	
				}
				else {
					if (quantityToShow == 1) {
						return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;						
					} else {
						return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + quantityToShow + " " + description;
					}
				}
			}else {
				if (quantityToShow == 1) {
					return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + description;						
				} else {
					return API.getLocalMsg("MSG_RECEIPT_XTRA") + " " + quantityToShow + " " + description;
				}
			}
		}else {
			if(productType == TYPE_COMMENT) { // SDO-392
				if(nodeItemView.grilledQuantity == (defaultQtd+1)) {
					return description;	
				}
				else {
					if (quantityToShow == 1) {
						return API.getLocalMsg("MSG_RECEIPT_REM") + " " + description;						
					} else {
						return API.getLocalMsg("MSG_RECEIPT_REM") + " " + quantityToShow + " " + description;
					}
				}
			}else {
				if (quantityToShow == 1) {
					return API.getLocalMsg("MSG_RECEIPT_REM") + " " + description;						
				} else {
					return API.getLocalMsg("MSG_RECEIPT_REM") + " " + quantityToShow + " " + description;
				}
			}
		}
	}
}

/** Adds the default header from store-db */
function addDefaultHeader() 
{
	var value = rootConfig.Header;
	
	//OI 01.09.2010 Check if we have a default or customized header
	//<Configuration type="Store.wide">
	//	<Section name="CustomizedReceiptHeader">
	//		<Parameter name="CSO" value="XXXXXXXXXX"/>
	//		<Parameter name="MCC" value="XXXXXXXXXX"/>
	//	</Section>
	//</Configuration>
	if(typeof(BusinessObjectHelper) != "undefined" && typeof(SessionContext) != "undefined")
	{
		//read POD type
		//<Configuration imports="POS">
		//	<Section name="PosType">
		//		<Parameter name="POD" value="MCC"/>
		//	</Section>
		//</Configuration>
		var ctx=new SessionContext;
		var pod=ctx.get("POD");

		var hlp = new BusinessObjectHelper;
		var CustomizedReceiptHeader = hlp.findParamInSectionWide(pod,"CustomizedReceiptHeader");
		if(CustomizedReceiptHeader != null && CustomizedReceiptHeader!= "")
		{
			//overwrite the default header
			value = CustomizedReceiptHeader;
		}
	}
	
	if(value != null && value != "") {
		var lines = String(value).split("\\n");
		for(var i = 0; i < lines.length; i++) {
			if(lines[i].length < COLS)
			{
				lines[i] = ltrim(lines[i]);
				lines[i] = rtrim(lines[i]);
				addLine(center(lines[i]));	
			}
			else { 
				addLine();
				lines[i] = ltrim(lines[i]);
				lines[i] = rtrim(lines[i]);
				addLine(lines[i]);
			}
		}
	}
}

/** Adds the default header from store-db */
function addDefaultFooter() 
{
	var value = rootConfig.Footer;
	
	//OI 01.09.2010 Check if we have a default or customized header
	//<Configuration type="Store.wide">
	//	<Section name="CustomizedReceiptFooter">
	//		<Parameter name="CSO" value="XXXXXXXXXX"/>
	//		<Parameter name="MCC" value="XXXXXXXXXX"/>
	//	</Section>
	//</Configuration>
	if(typeof(BusinessObjectHelper) != "undefined" && typeof(SessionContext) != "undefined")
	{
		//read POD type
		//<Configuration imports="POS">
		//	<Section name="PosType">
		//		<Parameter name="POD" value="MCC"/>
		//	</Section>
		//</Configuration>
		var ctx=new SessionContext;
		var pod=ctx.get("POD");

		var hlp = new BusinessObjectHelper;
		var CustomizedReceiptFooter = hlp.findParamInSectionWide(pod,"CustomizedReceiptFooter");
		if(CustomizedReceiptFooter != null && CustomizedReceiptFooter!= "")
		{
			//overwrite the default header
			value = CustomizedReceiptFooter;
		}
	}
	
	if(value != null && value != "") {
		var lines = String(value).split("\\n");
		for(var i = 0; i < lines.length; i++) {
			lines[i] = ltrim(lines[i]);
			lines[i] = rtrim(lines[i]);
			if(lines[i].length < COLS)
				addLine(center(lines[i]));
			else { 
				addLine();
				addLine(lines[i]);
			}
		}
	}
}


//--------------------------
// HB SOTEC
// Replace the Non UTF-8 (german character) 
//--------------------------
function UmlautReplaceBuffer (sStringBuffer)
{
var sNoUml = "";
var nreplace = 0;
var asUml = new Array ("", "", "", "", "","","");
var asUmlRepl = new Array ("ue", "Ue", "oe ", "Oe ", "ae", "Ae ","ss");

var sString = sStringBuffer.toString();
	for(var j = 0; j < sString.length; j++) {
    	for(var nUml = 0; nUml < asUml.length; nUml++) 
		{
			if (sString.charAt (j) == asUml [nUml]) 
			{
				var	printString = sString.substring(0,j)+ asUmlRepl[nUml] + sString.substring(j+2,Number(sString.length));
				sString = printString;
				//API.dbg("sstring "+sString);
			}
		}
	}
	API.dbg("sstring "+sString);
var transformBuffer = new StringBuffer();	
transformBuffer.append(sString); 
return transformBuffer;    
}    


function addFlag(sStringBuffer)
{
   var sString = sStringBuffer.toString();
   API.dbg("sStringBuffer.length"+ sString.length);
   API.dbg("flat addFlag "+ sString);
   var lineArray = sString.split("\n");
   var newString="";
   for(var i =0; i<Number(lineArray.length);i++)
   {
		var positionOff = Number(lineArray[i].indexOf("DoubleCharOff"));
		var positionOn = Number(lineArray[i].indexOf("DoubleCharOn"));
		var flag= 0;

		//API.dbg("addFlag positionOff :" + positionOff  + " positionOn :" + positionOn );
		if(Number(positionOff) != -1 )
		{
			if(Number(positionOff)!=0 && lineArray[i].charAt(positionOff-1)!="@") //is not a valid printer flag
			{
				var	printString = lineArray[i].substring(0,Number(positionOff))+"<@DoubleCharOff>"+lineArray[i].substring(Number(Number(positionOff)+13),Number(lineArray[i].length));
		    		newString = newString+ printString +"\n";
				flag=1;
			}
		}
		if(Number(positionOn) != -1)
		{
			if(Number(positionOn)!=0 && lineArray[i].charAt(positionOn-1)!="@") //is not a valid printer flag
			{
				var	printString = lineArray[i].substring(0,Number(positionOn))+"<@DoubleCharOn>"+lineArray[i].substring(Number(Number(positionOn)+12),Number(lineArray[i].length));
		  	  	newString = newString+ printString +"\n";
				flag =1;
			}
		}
		if(Number(flag) == 0)
		{
			newString = newString + lineArray[i]+ "\n";
		}
   }
    API.dbg("addFlag after replace"+ newString);
   var transformBuffer = new StringBuffer();	
   transformBuffer.append(newString); 
   return transformBuffer;    
}

/**
 * This function returns the resulting report and executes some memory cleanup.
 * @return the report response to kernel
 */
function getResponse() 
{

	/*this is needed for production receipt */
	if(typeof(xmlStoreDB) == "undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
	}
	var Country = (xmlStoreDB.StoreDB.StoreProfile.StoreDetails.Country).toUpperCase();
	
	outputBuffer = UmlautReplaceBuffer(outputBuffer);
	
	//for eurecs <DobuleChar
	var response  = outputBuffer;//addFlag(outputBuffer);
	if (outputBuffer != null) {
		// PLI-118 - Adds the printer configuration to the buffer if it really has something to be printed.
		//var size = ((outputBuffer)+"").length;
		//if (size > 0) {
		var buffer = new StringBuffer();
		buffer.append("<@InitCode>");
		
		if(Country == "DE")
		{
			buffer.append("<@MarginOn>");
		}
		else
		{
			buffer.append("<@MarginOff>");
		}
		buffer.append(outputBuffer);
		response = buffer;
		//}
	}

	// Make a cleanup so that the garbage collector can free
	// some memory when the script ends.
	rootConfig		= null;
	rootCash		= null;
	rootPmix		= null;
	rootHourlySales	= null;
	rootView		= null;
	rootSOS			= null;
	rootCustom		= null;
	rootProduct		= null;
	
	rootSOSFC		= null;
	rootSOSDT		= null;
	rootSOSWT		= null;
	rootSOSMFY		= null;
	
	rootTimePunch	= null;
		
	outputBuffer	= null;
	
	//transform the special chars
	//response= UmlautReplace(response);
	API.dbg("getResponse"+response);
	//PosPrintPreview(response); 
	return  response;
}
/** Appends a new line in the report. */
function addLine(line) 
{
	if(line != null) {
		outputBuffer.append(line);
	}
	outputBuffer.append("\n");
}
/** Appends a bold line in the report. */
function addBoldLine(line) 
{
	if(line != null) {
		startBold();
		outputBuffer.append(line);
		endBold();
	}
	outputBuffer.append("\n");
}
/** Appends a double-sized line in the report. */
function addSize2Line(line) 
{
	if(line != null) {
		startSize2();
		outputBuffer.append(line);
		endSize2();
	}
	outputBuffer.append("\n");
}
/** Appends a bold double-sized line in the report. */
function addBoldSize2Line(line) 
{
	if(line != null) {
		startBoldSize2();
		outputBuffer.append(line);
		endBoldSize2();
	}
	outputBuffer.append("\n");
}

/**
 * Initializes global variables.
 * @param config configuration xml data (StringBuffer)
 * @param array of data (StringBuffer[])
 * @param requiredDataTypes if this optional parameter is set, it will break
 * if any given required data is not present.
 */
function init(config, data, requiredDataTypes, functionName) 
{
	API.dbg ("Reports init - START");
	initGlobalt();
	API.dbg ("Reports init - Before new XML (COnfig) " + config);
	rootConfig = new XML(config);
	//get country information  if is not defined  (this is for website reports)
	if(typeof(Country) !== 'undefined' && (Country =="" || Country == null)) //in production the Country is not defined that's why we test it on here.
	{
		Country = rootConfig.Locale.split("_")[1];
		API.dbg("Country set from init "+ Country);
	}
	
	var bRequiredXML = Array(false, false, false, false, false, false, false, false, false, false, false);
	var matched = 0;
	var requiredDataTypesSize = requiredDataTypes != null ? requiredDataTypes.length : 0;
	API.dbg ("Reports init - after new XML");
	for(var i = 0; i < data.length; i++) {
		if(data[i] != null) {
//			API.dbgBreak();
			var xml = new XML(data[i]);
			var dataType = xml.@requestDataType.toLowerCase();			
        	API.dbg ("Reports init - dataType XML" + dataType);			
			if("cash" == dataType) {
				rootCash = xml;
			}else if("pmix" == dataType) {
				rootPmix = xml;
			}else if("view" == dataType) {
				rootView = xml;
			}else if("hourlysales" == dataType) {
				rootHourlySales = xml;
			}else if("openorders" == dataType) {
				rootOpenOrders = xml;
			}else if("sos" == dataType) {
				rootSOS = xml;
				if(rootSOS.StoreTotals.@productionNodeId.length() != 0){
					//var BOHelper=new BusinessObjectHelper();
					//var alias=BOHelper.getQueueAlias(rootSOS.StoreTotals.@productionNodeId);
					if(rootSOSDT==null) {					
						rootSOSDT = (rootSOS.StoreTotals.@productionNodeId.indexOf("DT") == 0)?rootSOS:null;
					}
					if(rootSOSWT==null) {					
						rootSOSWT = (rootSOS.StoreTotals.@productionNodeId.indexOf("WT") == 0)?rootSOS:null;
					}
					if(rootSOSFC==null) {
						rootSOSFC = (rootSOS.StoreTotals.@productionNodeId.indexOf("FCE") ==0)?rootSOS:null;
						if (rootSOSFC==null) {
					       		rootSOSFC = (rootSOS.StoreTotals.@productionNodeId.indexOf ("FC") == 0)?rootSOS:null;
					    }

					}
					if(rootSOSMFY==null) {					
						rootSOSMFY = (rootSOS.StoreTotals.@productionNodeId.indexOf("MFY") == 0)?rootSOS:null;
						if(rootSOSMFY==null) {					
							rootSOSMFY = (rootSOS.StoreTotals.@productionNodeId.indexOf("MFY") == 0)?rootSOS:null;
						}

					}
				}
			}else if("custom" == dataType) {
				rootCustom = xml;
			}else if("prods" == dataType) {
				rootProduct = xml;
			}else if("timepunch" == dataType) {
				rootTimePunch = xml;
			}
			for(var j = 0; j < requiredDataTypesSize; j++) {
				if(requiredDataTypes[j].toLowerCase() == dataType) {
					matched++;
					bRequiredXML[j]=true;
					break;
				}
			}
		}
	}

	API.dbg ("Reports init - check required data types");
	if(matched < requiredDataTypesSize) {
		var missingTypes="";
		for(var j = 0; j < requiredDataTypesSize; j++) {
			if(missingTypes.length != 0) {
				missingTypes+=" | ";
			}
			if(!bRequiredXML[j]) {
				missingTypes+=requiredDataTypes[j].toLowerCase();
			}
		}
		API.dbg("ERROR:Missing data type (" + missingTypes + ") for report function " +  functionName + ". Check Configuration.");
		missingTypes="";
		for(var j = 0; j < requiredDataTypesSize; j++) {
			if(!bRequiredXML[j]) {
				missingTypes+=requiredDataTypes[j].substr(0,1).toUpperCase();
			}
		}
		addLine("ERROR: POS configuration error.\nCall support,  error code = " +  functionName.substr(0,5) + "-" + missingTypes);
		return -1;
	}
	return 0;	
}

/**
 * Gets the pos identification - WhoAmI()
 */
function getPosId() 
{
	var posId = rootConfig.PosId[0];
	if(posId != null) {
		return new Number(posId.substring(3, 8));
	}else {
		return "N/A";
	}
}
/**
 * Adds a separator line.
 * @param separatorText Text to add in the center of the line, or null for nothing
 */
function addSeparator(separatorText) 
{
	if(separatorText != null) {
		addLine(API.center(SEP_DL, separatorText));
	}else {
		addLine(SEP_DL);
	}
}
/** Starts a text with inverted color */
function startInvertedColor() 
{
	outputBuffer.append("<@ReverseOn>");
}
/** Ends a text with inverted color */
function endInvertedColor() 
{
	outputBuffer.append("<@ReverseOff>");
}
/** Adds a Cut tag. The paper will be cut at that position.*/
function cutPaper() 
{
	outputBuffer.append("<@Cut>");
}
/** Starts a <B>bold</b> text */
function startBold() 
{
	outputBuffer.append("<@BoldOn>");
}
/** Ends a <B>bold</b> text */
function endBold() 
{
	outputBuffer.append("<@BoldOff>");
}
function startUnderLine() 
{
	outputBuffer.append("<@UnderLineOn>");
}
function endUnderLine() 
{
	outputBuffer.append("<@UnderLineOff>");
}
/** Starts a double-sized text*/
function startSize2() 
{
	outputBuffer.append("<@DoubleCharOn>");
}
/** Ends a double-sized text*/
function endSize2() 
{
	outputBuffer.append("<@DoubleCharOff>");
}
/*citizen printer print with small font*/
function startSmallFont() 
{
	outputBuffer.append("<@SmallCharOn>");
}
/**citizen printer end print with small font**/
function endSmallFont() 
{
	outputBuffer.append("<@SmallCharOff>");
}


/** Starts a bold double-sized text*/
function startBoldSize2() 
{
	startBold();
	startSize2();
}
/** Ends a bold double-sized text*/
function endBoldSize2() 
{
	endSize2();
	endBold();
}

/** Ends a bold double-sized text*/
function startBarCode() 
{
	outputBuffer.append("<@BarCodeOn>");
}

/** Ends a bold double-sized text*/
function endBarCode()
{
	outputBuffer.append("<@BarCodeOff>");
}

function startHorizontalDouble()
{
	outputBuffer.append("<@DoubleHorizontalOn>");
}
function endHorizontalDouble()
{
	outputBuffer.append("<@DoubleHorizontalOff>");
}


/** Remove spaces of String **/
function trim(s)
{
	return rtrim(ltrim(s));
}

/** Remove left spaces of String **/
function ltrim(s)
{
	var s= s+"";
	var l=0;
	while(l < s.length && s[l] == ' ')
	{	l++; }
	return s.substring(l, s.length);
}

/** Remove right spaces of String **/
function rtrim(s)
{
	var s=s+"";
	var r=s.length -1;
	while(r > 0 && s[r] == ' ')
	{	r-=1;	}
	return s.substring(0, r+1);
}

/**
 * Gets a resource string
 * @param resourceKey resource key
 */
function getStr(resourceKey) 
{
	if(RESOURCES[LANG] != null) {
		return RESOURCES[LANG][resourceKey];
	}else {
		return RESOURCES["en_US"][resourceKey]; // Default language
	}
}

if(!this["_resources_"]) { // Avoids having to initialize those fields every-time
	this["_resources_"] = true;
	// Number of columns
	var COLS = 39;
//                   Default separators (39 characters)
//			               1         2         3        3 
//			      123456789012345678901234567890123456789
	var SEP_DL = "======================================="; // double line
	var SEP_SL = "---------------------------------------"; // single line
	var SEP_UL = "_______________________________________"; //  under line
	var SEP_RR = "+++++++++++++Report reprint++++++++++++"; //  Report reprint	
	var SEP_ER = "+++++++++++++End of reprint++++++++++++"; //  End of reprint
	var SEP_SC = "***************************************"; //  asterisk			
	// Sale status
	var SALE_STATUS_CURRENT_SALE_VOIDED	= 1 << 11;
	var SALE_STATUS_LAST_SALE_VOIDED	= 1 << 12;
	// Transaction kinds
 	var TRANS_KIND_SALE				= 0;
	var TRANS_KIND_REFUND			= 1;
	var TRANS_KIND_WASTE			= 2;
	var TRANS_KIND_MANAGER_MEAL		= 3;
	var TRANS_KIND_CREW_MEAL		= 4;
	var TRANS_KIND_ALLOWANCE		= 5;
	// Tender kinds
	var TENDER_KIND_PAYMENT			= 0;
	var TENDER_KIND_ALLOWANCE		= 1;
	var TENDER_KIND_CREW_MEAL		= 2;
	var TENDER_KIND_MANAGER_MEAL	= 3;
	var TENDER_KIND_CHANGE			= 4;
	var TENDER_KIND_KEEP_CHANGE		= 5;
	var TENDER_KIND_BILLABLEREFUND	= 6;
	var TENDER_KIND_DISCOUNT_COUPON = 8;
	var TENDER_KIND_ORIGINAL_PAYMENT= 9;
	//Sale type description
	var SALETYPE = {}
	SALETYPE["0"] = "EAT-IN";
	SALETYPE["1"] = "TAKE-OUT";
	SALETYPE["2"] = "OTHERS";
	
	// Types of reports
	var RPTDUMMY					= 0
	var RPTOPERATRORLOGOUT			= 2;
	var RPTOPERATORLOGIN			= 3;
	var RPTENDOFDAY					= 4;
	var RPTREMDRWCHANGE				= 40;
	var RPTREMLOGIN					= 41;
	
	// Types of report CASH
	var RPTCASHIERFLASH				= 5;
	var RPTCASHDRAWERCHANGE			= 6;
	var RPTCASHIERCLOSEBYDATE		= 7;
	var RPTCASHBYPERIOD				= 8;
	var RPTCASHDAILYCLOSEBYDATE		= 9;
	var RPTCASHENDDAYSTOREWIDE		= 10;
	var RPTCASHACCUMULATED			= 11;
	var RPTCASHCONSOLIDATED			= 12;
	var RPTCASHINDRAWER				= 13;
	var RPTCASHBYPERIODSW			= 14;
	var RPTINTCASHCONSOLIDATED		= 41;
	
	// Types of report PMIX
	var RPTPMIXBYDATE				= 15;
	var RPTPMIXBYPERIOD				= 16;
	var RPTPMIXBYPERIODSW			= 17;
	var RPTPMIXBYDATESW				= 18;
	
	var RPTPMIXUPTBYDATE			= 19;
	var	RPTPMIXUPTBYDATESW			= 20;
	var	RPTPMIXUPTBYHOUR			= 21;
	var	RPTPMIXUPTBYHOURSW			= 22;
	
	// Types of report SALE
	var RPTSALEFC					= 24;
	var RPTSALEFCSW					= 25;
	var RPTSALEHOURBYDATE			= 26;
	var RPTSALEHOURBYDATESW			= 27;
	var RPTSALEAVETKCDATE			= 28;
	var RPTSALEAVETKCDATESW			= 29;

	var RPTSOSFC					= 30;
	var RPTSOSFCSW					= 31;
	var RPTSOSHOURBYDATE			= 32;
	var RPTSOSDTHOUR				= 33;
	var RPTSOSDTDIAG				= 34;
	var RPTSOSMFY					= 35;
	var RPTSOSCSR					= 36;
	var RPTSOSD10CSR                = 37;
	
	// Types of report Time Punch
	var RPSINGLETIMEPUNCH			= 50;
	var RPGLOBALTIMEPUNCH			= 51;
	
	// Common big-decimal value
	var ZERO = new BigDecimal("0");
	// Default number format
	var NUMBER_FORMAT = "#,###,##0.00";
	// Date format used at customer receipts
//	var RECEIPT_DATE_FORMAT = "dd/MM/yyyy HH:mm:ss";
	var RECEIPT_DATE_FORMAT = "MMM.dd''yy (EEE) HH:mm";	
	// Internationalized strings
	var RESOURCES = {};
	// ####################### English Resources ("en_US") #########################
	RESOURCES["en_US"] = {};
	RESOURCES["en_US"]["CURRENCY_SYMBOL"] = "US$";
}

	initGlobalt();

/**
 * PUBLIC
 * Implements the balance receipt
 * Needed data types: VIEW
 * @author Celso Fernandes
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function balanceReceipt(config, data) 
{
	initGlobalt();
	rootConfig = new XML(config);
	if(rootConfig.CustomData.length() == 0) {
		return new StringBuffer();
	}
	addLine(SEP_UL);
	startBold();
		// Adds the default receipt header from store-db
		addDefaultHeader();
	endBold();

	addLine();
	var posId = "KS# " + toInt(rootConfig.PosId.substring(3, 7)); // Eg: POS0001:89 - > KS#1
	var date = API.formatDateTime(rootConfig.@creationDate, RECEIPT_DATE_FORMAT);
	addLine(posId + API.setOnRight(date, COLS-posId.length));
	addGiftInfo();
	addLine();
	addLine(SEP_UL);
	return getResponse();
	
	/** Adds Cashless information (if any) and returns true if signature is required */
	function addGiftInfo() 
	{
		var custom = rootConfig.CustomData[0];
		var lines = String(custom).split("CASHLESS_GC:");
		for(var i = 1; i < lines.length; i++) {
			var fields = String(lines[i]).split("@");
			var provider = fields[0].replace("CASHLESS_GC", ""); // + " SALE";
			var providerSale = provider  + " SALE";
			var card = fields[1]; 		// Card #
			var expires = fields[2];	// Card expiration date
			var auth = fields[3];		// Authorization code
			var printFlag = fields[5];	// 
			var seq = fields[6];		// Sequence #
			var mer = fields[7];		// Merchant id
			var balance = API.formatNumber(fields[8], NUMBER_FORMAT, 12);	// Balance #			
			var amt = fields[9];		// Operation amount
			var vlr = fields[10];		// value
			var store = fields[11];		// store
			var msg = fields[12];		// Mensagem
				
			if(i == 1) {
				var strStore = "STORE# " + rootConfig.StoreId;
				var strMer = " MER# " + mer;
				addLine(strStore + API.setOnRight(strMer, COLS-strStore.length));
//				addLine("STORE# " + rootConfig.StoreId + " MER# " + mer);
			}
			
			startBold();
			addLine();
			addLine(center("GIFT CARD"));
			addLine(center("BALANCE RECEIPT"));
			endBold();
			
			addLine();

			addLine("ACCOUNT# " + card);
			addLine("AUTH CODE - " + auth  + " SEQ# " + seq);
			if(provider == "Gift Card") {
				startBold();
				addLine();			
				addLine(center("GIFT CARD BALANCE"));
				var trimBalance="$"+trim(balance)
				addLine(center(trimBalance));
				endBold();				
			}
			addLine();		
		}
		addLine(msg);
		addLine();		
		addLine(center("Keep this receipt for your records"));
	}	
}

/**
 * PUBLIC
 * Implements the cashout receipt
 * Needed data types: VIEW
 * @author Celso Fernandes
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function cashoutReceipt(config, data) 
{
	initGlobalt();
	rootConfig = new XML(config);
	if(rootConfig.CustomData.length() == 0) {
		return new StringBuffer();
	}
	addLine(SEP_UL);
	startBold();
		// Adds the default receipt header from store-db
		addDefaultHeader();
	endBold();

	startInvertedColor();
	addLine();
	startBold();
	addLine(center("**** GIFT CARD CASH OUT ****"));
	endBold();
	addLine();
	endInvertedColor();


	var posId = "KS# " + toInt(rootConfig.PosId.substring(3, 7)); // Eg: POS0001:89 - > KS#1
	var date = API.formatDateTime(rootConfig.@creationDate, RECEIPT_DATE_FORMAT);
	addLine(posId + API.setOnRight(date, COLS-posId.length));
	var secondCopy = String(outputBuffer);
	addCSOGiftInfo(true);
	addLine(SEP_UL);
	addLine();addLine();addLine();addLine();addLine();addLine();
	cutPaper();
	addLine(secondCopy);
	addCSOGiftInfo(false);

	addLine("______________________________________");
	addLine(API.getLocalMsg("MSG_RECEIPT_CUSTOMER_SIGNATURE"));
	addLine();
	addLine("______________________________________");
	addLine(API.getLocalMsg("MSG_RECEIPT_MANAGER_SIGNATURE"));
	addLine();
	addLine("______________________________________");
	addLine(API.getLocalMsg("MSG_RECEIPT_CREW_SIGNATURE"));
	addLine();
	addLine();


	return getResponse();
	
	/** Adds Cashless information (if any) and returns true if signature is required */
	function addCSOGiftInfo(firstCopy) 
	{
		var custom = rootConfig.CustomData[0];
		var lines = String(custom).split("CASHLESS_GC:");
		var fields = String(lines[1]).split("@");
		var provider = fields[0].replace("CASHLESS_GC", ""); // + " SALE";
		var providerSale = provider  + " SALE";
		var card = fields[1]; 		// Card #
		var expires = fields[2];	// Card expiration date
		var auth = fields[3];		// Authorization code
		var printFlag = fields[5];	// 
		var seq = fields[6];		// Sequence #
		var mer = fields[7];		// Merchant id
		var balance = API.formatNumber(fields[8], NUMBER_FORMAT, 12);	// Balance #			
		var amt = fields[9];		// Operation amount
		var vlr = fields[10];		// value
		var store = fields[11];		// store
		var msg = fields[12];		// Mensagem

//		var strStore = "STORE# " + rootConfig.StoreId;
//		var strMer = " MER# " + mer;
//		addLine(strStore + API.setOnRight(strMer, COLS-strStore.length));

		addLine();
		if(firstCopy==true) {
			var line = "QTY ITEM";
			line = line + API.setOnRight("TOTAL", COLS-line.length);
			addLine(line);
			var qty = API.setOnRight(1,3);
			var name = "GIFT CARD CASH OUT";
			var price = " " + API.formatNumber(Number(vlr), NUMBER_FORMAT, 8);
			line = API.setOnLeft(qty + " " + name, COLS-price.length) + price;
			addLine(line);
			addLine();
			addLine(API.setOnLeft("Sub total", COLS-9) + price);
			addLine(API.setOnLeft("Tax", COLS-4) + "0.00");
			addLine(API.setOnLeft("Total Refund", COLS-9) + price);
			addLine();
			addLine(API.setOnLeft("Cash Out Amount", COLS-9) + price);
		}
		else {
			var name = "GIFT CARD CASH OUT AMOUNT";
			var price = " " + API.formatNumber(Number(vlr), NUMBER_FORMAT, 8);
			line = API.setOnLeft(name, COLS-price.length) + price;
			addLine(line);	
		}
		addLine();
		addLine();
		
		addLine("MER# " + mer);
		addLine("ACCOUNT# " + card);
		addLine("AUTH CODE " + auth  + " SEQ# " + seq);
		if(provider == "Gift Card") {
			startBold();
			addLine();			
			addLine(center("GIFT CARD BALANCE"));
			var trimBalance="$"+trim(balance)
			addLine(center(trimBalance));
			endBold();			
		}
		addLine();		
		addLine(msg);
		addLine();		
	}	
}

/**
 * PUBLIC
 * Implements fnMountOrderId
 * Needed data types: VIEW
 * @author Celso Fernandes
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function fnMountOrderId(OrderId,Order,Major,Minor){

	return (OrderId=="") ? PosMountOrderIdJS("1",Order,Major,Minor) : OrderId;
	
}

/** PosMountOrderIdJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosMountOrderIdJS</b>\n
 * This BC checks if it's possible to void a sale!\n
 * In a workflow sequence it is called:<b>PosMountOrderIdJS NbrFormat szOrder szMajor szMinor</b>\n
 * In java script it should be called:<b>PosMountOrderIdJS(NbrFormat,szOrder,szMajor,szMinor)</b>\n
 * @param - NbrFormat - Number Format
 * @param - Order - POD + order number
 * @param - Major - major number
 * @param - Minor - minor number
 * Return - rval - OrderId
 */
function PosMountOrderIdJS(szNbrFormat,Order,Major,Minor) {

	/*needed for production*/
	if(typeof(xmlStoreDB) =="undefined")
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}
	if(xmlStoreDB == null)
	{
		xmlStoreDB = new XML(API.getStoredb());
		xmlPosDB = new XML(API.getPosdb());
	}
	/*
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"OrderNumberRange\").@value";
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Receipt\").Parameter.(@name==\"OrderNumberRange\").@value";
	var orderIDLength = getConfigValue(storedbPath , posdbPath);
	*/
	if(orderIDLength =="")
	{
		orderIDLength  =4; //4 is default
	}
	var OrderId="";
	switch(Number(szNbrFormat)) {
	default:
	case 1:
		while(Major.length < orderIDLength) {
			Major="0"+Major;
		}
		OrderId=Major.substr(Major.length-orderIDLength,orderIDLength);
		if(toInt(Minor) != 0) {
			OrderId+="/"+Minor;
		}
		break;
	case 2:
		while(Major.length < orderIDLength) {
			Major="0"+Major;
		}
		OrderId=Number(Order.substr(3,4))+Major.substr(Major.length-orderIDLength,orderIDLength);
		if(toInt(Minor) != 0) {
			OrderId+="/"+Minor;
		}
		break;
	}
	return(OrderId);
	
	/*
	* Helper function  this is already declared in businessCOmponentsLocal but is not seen at production level so it needs to be declare in here too.
	* Parameters: storeDbPath - path to the desired parameter in store-db
	*			  psoDbpath -path to the desired parameter in pos-db
	* Returns the value of a configuration parameter
	*/
	 function getConfigValue(storeDbPath, posDbPath)
	 {
		if(posDbPath!="" && posDbPath !=null)
		{
			var value = eval("xmlPosDB."+posDbPath);
			if(value+""!="")
			{
				return  value;
			}
		}
		return  eval("xmlStoreDB."+storeDbPath)+"";
			
	 }
}

/*
 * @author Mihai Secareanu -print the cashless receipt saved in a session.
*/
function PrintECashReceiptsFromMemoryJS()
{
	var hlp= new BusinessObjectHelper;
	var receipt =null;
	var ctx=new SessionContext; 
	receipt  = ctx.get("cashlessReceiptBuffer"); //get the cashless receipt that is printed on the current pos (kiosk)
	API.dbg("PrintECashReceiptsFromMemoryJS cashlessreceipt"+receipt);
	if(receipt !=null && receipt !="")
	{
		PosCreateReport ("VIEW", "recallReport@reports.nps", "NOPREVIEW|MANDATORY", receipt);
		receipt =null;
	}	
	
	//print cashless receipt on second printer if this is defined
	var receipt  = ctx.get("cashlessRemoteReceiptBuffer"); //get the cashless receipt that is printed on a remote printer if any
	if(receipt !=null && receipt !="")
	{
		var PrinterList = hlp.findParamInSectionWide("PrinterList", "PrintFromKioskOnCounter");
		var PrinterAliases = hlp.findParamInSectionWide("PrinterAliases", "PrintFromKioskOnCounter");
		PosCreateReport ("VIEW", "recallReport@reports.nps", "NOPREVIEW|MANDATORY|ALIAS", receipt, PrinterAliases, PrinterList);
	}
	return true;
}

/*
@author Mihai Secareanu - this function will print a remot stored in memory. 
The report will be send to the report in the custom data section.
*/
function recallReport(config, data)
{
	if(init(config, data, Array("VIEW"), "RECPT") != 0){
		return getResponse();
	}
	API.dbg(" recallReport rootConfig " +rootConfig.CustomData[0]);
	var receipt = new StringBuffer(rootConfig.CustomData[0]);
	receipt.append(rootConfig.CustomData[0]);
	return receipt;
}

/*
@author Mihai Secareanu - this function willmake some cleaning in case of cashlessReceipt report that do not return with getReponse()
*/
function clean()
{
	rootConfig		= null;
	rootCash		= null;
	rootPmix		= null;
	rootHourlySales	= null;
	rootView		= null;
	rootSOS			= null;
	rootCustom		= null;
	rootProduct		= null;
	
	rootSOSFC		= null;
	rootSOSDT		= null;
	rootSOSWT		= null;
	rootSOSMFY		= null;
	
	rootTimePunch	= null;
		
	outputBuffer	= null;
}


/**
 * PUBLIC
 * Implements the customer receipt
 * Needed data types: VIEW
 * @author Celso Fernandes - modified Hermann Buettner
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.StringBuffer config, java.lang.StringBuffer []data);
 */
function receiptCashless(config, data) 
{
	// Mihai Secareanu 22.03.2011 in case fiscal printer are used no receipt must be printed here
	if(isFiscalEnable == true)
	{
		outputBuffer = new StringBuffer();
		return  outputBuffer;
	}


	//var boHelper		= new BusinessObjectHelper;
	var ctx=new SessionContext;
	var saveToSession = ctx.get("CashlessReceiptSession"); //i this session property is set we have to store the receipt in memory. (valid values are remote and currentPos)
	//reset the session
	ctx.set("CashlessReceiptSession", "false");
	API.dbg("Sotec " + saveToSession + " PrintReceiptFirst " + PrintReceiptFirst);
	
	var LIGHT  = 1;
	var ONLY   = 2;
	var PODDT  = 1;	
	var PODMCC = 5;	
	var PODCSO = 8;	
	API.dbg ("receiptCashless START");
	var hlp = new BusinessObjectHelper; 
	var PrintReceiptFirst = hlp.findParamInSectionWide("PrintReceiptFirst","Cashless") == "true";
	var PrintRemoteReceiptFirst = hlp.findParamInSectionWide("PrintRemoteReceiptFirst","Cashless") == "true";
	
	if(init(config, data, Array("VIEW"), "RECPT") != 0){
		return getResponse();
	}	
	// Order information

//    var hlp = new BusinessObjectHelper; 
//    var Ordview = hlp.getCurrentView(); 

//    var ctx=new SessionContext; 
//    ctx.set(KEY_VIEW,Ordview.toString(),true); 

	var view			= rootView.View;
	var isRefund		= view.@transactionKind == TRANS_KIND_REFUND;
	var isBillableSale	= ((view.ItemTenderView.(code == TENDER_KIND_BILLABLEREFUND)).length() != 0);	
	var isWaste			= view.@transactionKind == TRANS_KIND_WASTE;
	var isOverring		= ((Number(view.@saleStatus) == SALE_STATUS_LAST_SALE_VOIDED) || (Number(view.@saleStatus) == SALE_STATUS_CURRENT_SALE_VOIDED));
	var isInProgress	= (Number(view.@saleStatus) == SALE_STATUS_CURRENT_SALE_VOIDED);
	var isKiosk     	= false; // DES-30 // var isKiosk     = (Number(view.@pod) == PODCSO) || isRcpKiosk;
	var isFromKiosk 	= (Number(view.@pod) == PODCSO);
	var isDTorMCC		= (Number(view.@pod) == PODDT || Number(view.@pod) == PODMCC);
	var custom 			= rootConfig.CustomData[0];
	var errKiosk 		= 0;
	var prnKiosk 		= 0;

	//mz 16.04.09: check if this is a cancellation receipt. If it is add CANCELLED on top of the receipt printed
	if(PosCheckSessionProperty("SignatureConfirmationCancelled", "true") && (Country =="UK" || Country =="IE"))
   	{
		startBoldSize2();
		addLine(API.center("CANCELLED", 18));
		endBoldSize2();
		PosSetSessionProperty("SignatureConfirmationCancelled", "false");
	}
	
//	API.dbg ("  CL data: " + data);
	if(Country =="DE" )
	{
		addLine(SEP_UL);
	}
	// since orders are sent after payment we get the incorrect order number here -> Remove by advice 26.10.2007
//	if(!isDTorMCC) {
//		orderIdBigger(view.@orderId);
//	} else {
//		addLine(API.center(view.@orderId, 40));
//	}

	//take the flag form store-db to see if we must display the defautl header
	var storedbPath = "Configurations.Configuration.(@type==\"Store.wide\").Section.(@name==\"Cashless\").Parameter.(@name==\"PrintDefaultHeader\").@value"; 
	var posdbPath = "Configuration.(@imports==\"Store.wide\").Section.(@name==\"Cashless\").Parameter.(@name==\"PrintDefaultHeader\").@value";
	var displayHeader = getConfigValue(storedbPath , posdbPath);	

	if(displayHeader =="true")
	{
		addLine(SEP_UL);
		addLine();	
		startBold(); {
			// Adds the default receipt header from store-db
			addDefaultHeader();
		} endBold();
		/*
		addLine();	
		
		startBold(); {
			addLine(API.center("KARTEN BELEG", 19));
		} endBold();
		*/
		//addLine(SEP_UL);
		addLine();
	}
	
	if(Country == "DE" || Country =="UK" || Country =="IE")
	{
		startBoldSize2();
		addLine(API.center(API.getLocalMsg("MSG_RECEIPT_CARD"), 19)); //"KARTEN BELEG" 
		endBoldSize2();
		addLine(SEP_UL);
	}


	//addLine();
	//startBoldSize2();
	//addLine(API.center("CASHLESS RECEIPT", 19));
	//endBoldSize2();
	//addLine(SEP_UL);
	
	var vatNumber="";
	if((isKiosk) && (custom != null)) {	
		var fields = String(custom).split(":");
		if(fields.length>=1) {
			errKiosk = fields[0];
			if(fields.length>=2) {
				prnKiosk = fields[1];
				if(prnKiosk==1) {
					addLine(center((isFromKiosk)?"kiosk duplicate":"duplicate"));
				}
				if(fields.length>=3) {
					vatNumber = fields[2];
					if(vatNumber == null) {
						vatNumber = (xmlStoreDB.Configurations.(Configuration.@type=="Store.wide").(Section.@name=="VAT").(Parameter.@name=="VatNumber")).@value;
					}
				}
			}
		}
	}
	else {
		vatNumber = custom;
		if(vatNumber == null) {
			vatNumber = (xmlStoreDB.Configurations.(Configuration.@type=="Store.wide").(Section.@name=="VAT").(Parameter.@name=="VatNumber")).@value;
		}
	}

	if(isRefund) {
		if(isBillableSale) {
			var billableSaleRefund = view.ItemTenderView;
			startInvertedColor();
				startBold();
				addLine(center(API.getLocalMsg("MSG_RECEIPT_BILLABLE_SALE_ADJUSTMENT_HEADER")));
				endBold();
				addLine();
			endInvertedColor();
			startBold(); {
				addLine(center(API.getLocalMsg("MSG_RECEIPT_NOTICE")));
				addLine(center(API.getLocalMsg("MSG_RECEIPT_THIS_BILLABLE_SALE_ADJUSTMENT_IS_FOR")));
				addLine(center(API.getLocalMsg("MSG_RECEIPT_ACCOUNTING_PURPOSES_ONLY")));
				addLine(center(API.getLocalMsg("MSG_RECEIPT_DO_NOT_GIVE_CASH")));
				addLine();
				addLine(API.getLocalMsg("MSG_RECEIPT_ORIG_BILLABLE_SALE_ORDER")+ view.@LSOrderId + "  " + getCurrency() + API.formatNumber(view.@LSTotAmount, "##0.00", 6));
			} endBold();
		}
		else {
			if((isRefund) && (view.Cashless.length() == 0)) {		
				startInvertedColor();
					startBoldSize2();
					addLine(API.getLocalMsg("MSG_RECEIPT_REFUND"));
					endBoldSize2();
				endInvertedColor();
			}
			else {
				addLine(center(API.getLocalMsg("MSG_RECEIPT_REFUND")));
			}
		}
		addLine();
	}

	var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
//    var majorMinor = fnMountOrderId("----",String(view.@orderKey),String(view.@major),String(view.@minor));
//	var kvsOrder = "#ORD " + API.formatNumber(majorMinor, "0000", 4);
    var kvsOrder = "        ";
	
	var posId
	if(Country == "DE" )
	{
		var posId = " -KS. " + toInt(view.@orderKey.substring(3, 7)) + "-"; // Eg: POS0001:89 - > KS#1
	}
	else
	{
		posId = " " + API.getLocalMsg("MSG_RECEIPT_REG")  + " "  + toInt(view.@orderKey.substring(3, 7)) + "-"; // Eg: POS0001:89 - > KS#1
	}
	var date = API.formatDateTime(rootView.@creationDate, "dd/MM/yyyy HH:mm:ss");
	var strLine = kvsOrder + posId;
	if(Country == "DE" )
	{
		addLine(strLine + API.setOnRight(date, COLS-strLine.length));
	}
//	addLine();
	
	var mfySide = "";
	var strSide = String(view.@productionSide);
	var str_1 = strSide.replace(" ","");
	if(str_1.length != 0) {
		if(isRefund) {
			mfySide = "";
		}else {
			var szSide =  (view.@productionSide.substring(0,4) + " " + view.@productionSide.substring(4,5)).toUpperCase();
			mfySide = "MFY " + szSide + " ";
		}
	}
	
	if(isWaste) {	
		kvsOrder = "";
	}
	var saleTypes	= Array(API.getLocalMsg("MSG_RECEIPT_IN"), API.getLocalMsg("MSG_RECEIPT_OUT"), API.getLocalMsg("MSG_RECEIPT_OTHER"));
	var saleType	= toInt(view.@type);
	if(isKiosk) {	
		var totalDue = Number(view.@totalDue);
		addLine(kvsOrder+"   "+saleTypes[saleType]);
		addLine(" ");		
		addLine(SEP_UL);		
	}
	var line = "ANZ ARTIKEL";
	line = line + API.setOnRight("TOTAL", COLS-line.length);
//	addLine(line);
//	addLine();
	
	
	// Adds sale items

	// Adds sub-total, tax an total information
//	addDetailLine("Subtotal",	subTotalAmt);
//	addDetailLine("Tax",		taxAmt);
	addCashlessInfo(isRefund);
//	if(isOverring) {
//		var majorMinor = fnMountOrderId(String(view.@orderId),String(view.@orderKey),String(view.@major),String(view.@minor));
//		addLine("**** Last Sale # " + majorMinor + " VOIDED****");
//		addLine("    ADJUSTMENT NOTE - OVERRING");
//	}
	
	if(Country == "DE")
	{
		startBold(); {
			addDefaultFooter();
		} endBold();
	}
	addLine(SEP_UL);	
	outputBuffer = addFlag(outputBuffer);
	
	//MS 28.03.2011 add the client cashless receipt if required
	if(combineOrderEcashReceipt == true && PosCheckSessionProperty("IsClientEcashReceipt", "true") ==true) //no need to print the first receipt, it will be printed at the end of order receipt with no cuts
	{
		var receipt = outputBuffer;
		ctx.set("cashlessReceiptBuffer",  receipt.toString(), true);
		clean();
		outputBuffer = new StringBuffer();
		return  outputBuffer;
	}
	
	if(PrintReceiptFirst ==true && saveToSession == "currentPos")
	{
		var receipt = outputBuffer;
		ctx.set("cashlessReceiptBuffer",  receipt.toString(), true);
		clean();
		outputBuffer = new StringBuffer();
		return  outputBuffer;
	}
	else if(PrintRemoteReceiptFirst ==true && saveToSession == "remote")
	{
		var receipt = outputBuffer;
		ctx.set("cashlessRemoteReceiptBuffer",  receipt.toString(), true);
		clean();
		outputBuffer = new StringBuffer();
		return  outputBuffer;
	}
	else //print the report
	{
		return getResponse();
	}
	/** Adds Cashless information (if any) and returns true if signature is required */
	function addCashlessInfo(isRefund) 
	{
		if(Country == "UK" || Country =="IE")
		{
			//05.03.2009 oi refund to false
			isRefund = false;
		}
		API.dbg(" CL  view.Cashless: " + view.Cashless);
		API.dbg(" CL rootConfig.CustomData[0]: " + rootConfig.CustomData[0]);
		
		if(view.Cashless.length() == 0 || Country == "FR"  || Country == "NL" ) {
            var custom = rootConfig.CustomData[0]; 
		}
		else {
    		var custom = view.Cashless;
    	}
//		API.dbg ("  CL custom: " + custom);
		
		var lines = String(custom).split("CASHLESS:");
		
		var msg="";
		for(var i = 1; i < lines.length; i++) {

//		    API.dbg ("  CL line: " + lines [i]);
		    
			var providerSale;
			var fields = String(lines[i]).split("@");
			
//			API.dbg ("  CL field 0: " + fields [0]);
			
			var provider = fields[0].replace("CASHLESS:", ""); // + " SALE";
			providerSale = provider;
//			if(isRefund) {
//				providerSale = provider  + " REFUND";
//			}else {
//				providerSale = provider  + " SALE";
//			}
			var card = " " + fields[1]; // Card #
			var expires = fields[2];	// Card expiration date
			var auth = fields[3];		// Authorization code
			var seq = fields[6];		// Sequence #
			var mer = fields[7];		// Merchant id
			var balance = API.formatNumber(Number(fields[8]), NUMBER_FORMAT, 12);	// Balance #
			var amt = fields[10];		// Operation amount
			if(fields[12].length!=0) {
				msg = fields[12];		    // Message
			}

//			API.dbg ("  cashlessReceipt: provider: " + provider);
//			addLine("MER# " + mer);
			
			var firstCopy = "";
			var secondCopy = "";
//			var needsSignature = fields[5] == "1";
            var needsSignature = false;
			
//			var line = "CARD ISSUER          ACCOUNT#";
            var line = "";
			firstCopy = firstCopy + line + "\n";
			
			if(isRefund) {
				secondCopy = secondCopy + line + "\n";
			}else {
				secondCopy = secondCopy + line + "  EXP DATE" + "\n";
			}			
			
//			line = API.setOnLeft(providerSale, 14) + card;
            line = providerSale + card;
			firstCopy = firstCopy + line + "\n";
			if(isRefund) {
				secondCopy = secondCopy + line + "\n";
			}else {
				secondCopy = secondCopy + line + "  " + expires + "\n";
			}			
			
			if(provider == "Gift Card") {
				line = "TRANSACTION AMOUNT" + API.setOnRight(amt, COLS-18);
				firstCopy = firstCopy + line + "\n";
				secondCopy = secondCopy + line + "\n";				
			}
			
//			line = "AUTHORIZATION CODE - " + auth + " SEQ# " + seq + "\n";
            line = ""
			firstCopy = firstCopy + line;
			secondCopy = secondCopy + line;
			
			if(provider == "Gift Card") {
				var trimBalance="$"+trim(balance)
				line = "\n<@BoldOn> GIFT CARD BALANCE\n      " + trimBalance + "<@BoldOff>";
				firstCopy = firstCopy + line;
				secondCopy = secondCopy + line;
			}
			
			firstCopy = firstCopy + "\n";
			secondCopy = secondCopy + "\n";
			if((needsSignature) || (isRefund)) {
				var auxQutputsecondCopy = outputBuffer + secondCopy;
				addLine(firstCopy);				
				if(needsSignature) {
					addLine(msg);
				}else {		
					if(Country !="UK" && Country !="IE")
					{
						/* Is refund */
						addLine();addLine();addLine();
						addLine(API.getLocalMsg("MSG_RECEIPT_AUTORIZED"));
						addLine(API.getLocalMsg("MSG_RECEIPT_SIGNATURE"));
						addLine();
						addLine(API.getLocalMsg("MSG_RECEIPT_ADDRESS"));
						addLine("___________________________________");
						addLine();
						addLine(API.getLocalMsg("MSG_RECEIPT_PHONE"));
						addLine("___________________________________");
						addLine();
						addLine(API.getLocalMsg("MSG_RECEIPT_REASON"));
						addLine("___________________________________");
					}
				}
				
				addLine();
				addLine(SEP_UL);
				addLine();addLine();addLine();addLine();addLine();addLine();
				if(!isKiosk) {	
					cutPaper();
				}
				addLine(auxQutputsecondCopy);				
				if(needsSignature) {
					addLine();
					addLine();
					addLine("___________________________________");
					addLine(API.getLocalMsg("MSG_RECEIPT_AUTHORIZED_SIGNATURE"));
					addLine();
					addLine(msg);
					msg="";
				}else {
					/* Is refund */
					if(Country !="UK" && Country !="IE")
					{
						addLine();addLine();addLine();
						addLine(API.getLocalMsg("MSG_RECEIPT_AUTORIZED"));
						addLine(API.getLocalMsg("MSG_RECEIPT_SIGNATURE"));
						addLine();
						addLine(API.getLocalMsg("MSG_RECEIPT_ADDRESS"));
						addLine("___________________________________");
						addLine();
						addLine(API.getLocalMsg("MSG_RECEIPT_PHONE"));
						addLine("___________________________________");
						addLine();
						addLine(API.getLocalMsg("MSG_RECEIPT_REASON"));
						addLine("___________________________________");
					}
				}			
			}else {
				addLine(firstCopy);
			}
		}
		addLine(msg);
	}
	
}	

function reportOpenOrders(config, data) 
{
	round_array = new Array();
	round_array.push({id:0, text:"ROUND_UP"});
	round_array.push({id:1, text:"ROUND_DOWN"});
	round_array.push({id:2, text:"ROUND_CEILING"});
	round_array.push({id:3, text:"ROUND_FLOOR"});
	round_array.push({id:4, text:"ROUND_HALF_UP"});
	round_array.push({id:5, text:"ROUND_HALF_DOWN"});
	round_array.push({id:6, text:"ROUND_HALF_EVEN"});
	
	if(init(config, data, Array("OPENORDERS"), "PACTL") != 0){
		return getResponse();
	}	
	
	var pod = rootOpenOrders.@requestPod;
	addHeader(rootOpenOrders, "Open Orders Report", RPTDUMMY);

	var operatorName = new Array();
	var cont_operator=0;
	var x=0;
	var flag=0;
	
	for each (i in rootOpenOrders.Orders.View){
		flag=0;
		for(x=0;x<cont_operator;x++){
			if(operatorName[x]==i.@operatorName){
				flag=1;
				break;
			}
		}

		if(flag==0){
			operatorName[cont_operator]=i.@operatorName;
			cont_operator++;
		}
	}

	var pod = new Array();
	var cont_pod=0;
	x=0;
	flag=0;

	for each (i in rootOpenOrders.Orders.View){
		flag=0;
		for(x=0;x<cont_pod;x++){
			if(pod[x]==i.@pod){
				flag=1;
				break;
			}
		}

		if(flag==0){
			pod[cont_pod]=i.@pod;
			cont_pod++;
		}
	}
	
	// Body of Report 
	var y=0;
	var order_count=0;
	var total_amount=0;

	for(x=0;x<cont_pod;x++){
		addLine("Type: " + convertPOD(pod[x]) + " Total");
	
		for(y=0;y<cont_operator;y++){
			addLine("Srvr: " + operatorName[y]);
			addLine("Order     Total  Opened   Time");

			for each (i in rootOpenOrders.Orders.View){
				if(operatorName[y]==i.@operatorName && pod[x]==i.@pod){
					addLineArray(i.@orderId,i.@grossAmount,i.@saleTime,Math.floor(Math.abs(((Number(i.ViewTimes.@totalTime)-Number(i.ViewTimes.@orderTime))/1000))));
					order_count++;
					total_amount = Number(total_amount) + Number(i.@grossAmount);
				}
			}
		}
	}

	addLine(SEP_DL);
	addLine(center("Order Totals"));
	addLine(SEP_DL);
	
	addLine("Order Count: " + order_count);
	addLine("Total Amount: " + API.formatNumber(Number(total_amount), "####0.00", 8));

	addLine();
	addFooter(rootOpenOrders);

	return getResponse();

	function convertPOD(pod)
	{
		switch(Number(pod)){
			case 0:
				return "FRONT_COUNTER";
				break;
			case 1:
				return "DRIVE_THRU";
				break;
			case 2:
				return "WALK_THROUGH";
				break;
			case 3:
				return "DELIVERY";
				break;
			case 4:
				return "COLDKIOSK";
				break;
			case 5:
				return "MCCAFE";
				break;
			case 6:
				return "MCEXPRESS";
				break;
			case 7:
				return "COLDKIOSK_DRINK";
				break;
			case 8:
				return "CSO";
				break;
			case 9:
				return "HOT";
				break;
			case 11:
				return "LOCAL";
				break;
			case 20:
				return "MCD";
				break;
			case 21:
				return "CHIPOTLE";
				break;
			case 22:
				return "BOSTON_MARKET";
				break;
			case 23:
				return "DONATOS";
				break;
			case 24:
				return "POD_UNDEFINED";
				break;
			default:
				return pod;
		}
	}
	
	function addLineArray(order, total, opened, time)
	{
		var second = (((Number(time)/60)-Math.floor(Number(time)/60))*60)>=10?Math.floor(((Number(time)/60)-Math.floor(Number(time)/60))*60):"0"+Math.floor(((Number(time)/60)-Math.floor(Number(time)/60))*60);
		var line = API.setOnRight(order, 1)
		+ "   "
		+ API.setOnRight(total, 10)
		+ "   "
		+ API.setOnRight(opened.substring(0,2) + ":" + opened.substring(2,4), 5)
		+ "   "
		+ API.setOnLeft(Math.floor(Number(time)/60) + ":" + second,12)
		
		addLine(line);
	}
};



/**
 * LOCAL
 * @brief Consolidates or removes the autocondiment (AC) items from the given view. (Part of feature PLE-194)
 * @param acDisplayProperty - property which defines where the AC items will be displayed, valid properties: 'receipt' or 'picklist'.
 * @signature public java.lang.StringBuffer reportCashInDrawer(java.lang.String acDisplayProperty);
 * @author Kalil Garcia
 */
 function lConsolidateACItems(acDisplayProperty) {
	try {
		API.dbg("Reports.nps:lConsolidateACItems() - Consolidating AC items based on display property: [" + acDisplayProperty + "]...");
		var view 			= rootView.View;
		var acItemsList 	= new Array();
		// Removes all the auto-condiment items from the view.
		for (var j = 0; j < view.ItemView.length(); ++j) {
			var isAC 		= view.ItemView[j].AutoCondiment;
			var acDisplay 	= view.ItemView[j].ACDisplay;
			if (isAC=='true') {
				if (canDisplayACItem(acDisplay, acDisplayProperty)) {
					var acItemView 		= view.ItemView[j];
					var parentsQty 		= getParentsQuantity(view, j, new Number(acItemView.level));
					acItemView.quantity *= parentsQty;
					acItemView.level 	= 0; 	// Auto-condiment must be in the level zero.
					consolidateACItem(acItemView);
				}
				delete view.ItemView[j]; 
			}
		} 	
		// Removes the AC zombie parents.
		removeACZombieParents(view);
		// Re-adds the joined auto-condiment items to the view.
		for (var x=0; x < acItemsList.length; x++) {
			view.appendChild(acItemsList[x]);
		}
	} catch(ex) {
		API.dbg("Could not consolidate auto-condiments on the view, due to: " + ex);
	}
	
	/*
	 * Removes the AC zombie parents.
	 * @since - PLE-194
	 * @author - Kalil
	 */
	function removeACZombieParents(view) {
		for (var j=0; j<view.ItemView.length(); ++j) {
			var acDNAPath		= new Number(view.ItemView[j].acDNAPath);
			var isLastElement 	= (j == view.ItemView.length() - 1);
			if (acDNAPath==1) {
				if (!hasChild(j)) {
					// Has no child and it was linked to an AC item, lets check if it is a zombie parent.
					if (removeZombieParent(j)) {
						// Lets reset it and starts again, we dont know if we left the grandparent as a zombie.
						j=-1;
					}
				}
			}
		}
		// Lets remove the DNA information.
		for (var j = 0; j < view.ItemView.length(); ++j) {
			var acDNAPath = new Number(view.ItemView[j].acDNAPath);
			if (acDNAPath == 1) {
				delete view.ItemView[j].acDNAPath;
			}
		}
		
		/*
		 * Verifies if the given item index has children items.
		 * @since - PLE-194
		 * @author - Kalil
		 */
		 function hasChild(curIndex) {
			var level = new Number(view.ItemView[curIndex].level);
			var isLastElement = (j == view.ItemView.length() - 1);
			if ((!isLastElement) && (level < new Number(view.ItemView[curIndex+1].level))) {
				return true;
			}
			return false;
		}

		/*
		 * Removes the zombie parent. It will only be preserved if it has at least one of the following characteristics:
		 * 		1) OPENED CHOICE (MUST SHOW OPENED CHOICES)
		 * 		2) GRILLED ITEMS (MUST SHOW GRILLED PRODUCTS)
		 * 		3) NON ZERO PRICE (COST NOT INCLUSE)
		 *      4) QUANTITY GREATER THAN ZERO (MUST SHOW VOID ITEM)
		 *		5) PROMO QUANTITY NOT EQUALS TO ZERO (MUST SHOW PROMOTED ITEMS)
		 * @since - PLE-194
		 * @author - Kalil
		 */
		function removeZombieParent(index) {
			var quantity = new Number(view.ItemView[index].quantity);
			var promoQty = new Number(view.ItemView[index].quantityPromo);
			var totalPrice = new Number(view.ItemView[index].totalPrice);
			var totalPriceBP = new Number(view.ItemView[index].BPTotalPrice);
			var isGrillLine = view.ItemView[index].isGrillLine;
			var productType = new Number(view.ItemView[index].productType);	// OPEN CHOICE=4
			if ((totalPriceBP == 0) 	&& 
				(promoQty == 0) 		&& 
				(quantity > 0) 			&& 
				(productType != 4) 		&& 
				(isGrillLine == 'false')&& 
				(totalPrice == 0)) {
				delete view.ItemView[index]; 
				return true;
			} else {
				return false;
			}
		}
	}
	
	/*
	 * Calculates the parents quantity. 
	 * @since - PLE-194
	 * @author - Kalil
	 */	
	 function getParentsQuantity(view, curIndex, curLevel) {
		try {
			var qty = 1;
			for (var x=curIndex;x>=0;x--) {
				if (new Number(view.ItemView[x].level) < curLevel) {
					curLevel = new Number(view.ItemView[x].level);
					qty *= new Number(view.ItemView[x].quantity);
					// Creates the AC DNA indicating the genealogy path, so we 
					// can find the its possible zombie parents.
					view.ItemView[x].acDNAPath = "1"; 
					if (curLevel == 0) {
						break;
					}
				}
			}
			return qty;
		} catch (ex) {
			API.dbg("FATAL ERROR: Could not calculate parents quantity for auto-condiments, due to: " + ex);
			return 1; // At least keeps the AC default quantity.
		}
	}	
	
	/*
	 * Verifies if the ACDisplay tag has the given display property value, such as: 'receipt' or 'picklist'.
	 */	
	 function canDisplayACItem(acDisplay, type) {
		var props = acDisplay.split("|");
		for (var w=0;w<props.length;w++) {
			if (props[w]==type) {
				return true;
			}
		}
		return false;
	}
	
	/*
	 * Consolidates the incoming order items.
	 */
	function consolidateACItem(acItemView) {
		var sz = acItemsList.length;
		for (var x=0; x < sz; x++) {
			var item = acItemsList[x];
			if (item.productCode == acItemView.productCode) {
				item.quantity = new Number(item.quantity) + new Number(acItemView.quantity);
				return;
			}
		}
		// Item was not found in the list, lets add it.
		acItemsList[sz] = acItemView;
	}	
}



/**  **/
function getPODText(intPODNumber)
{
	var PODFC = 0;
	var PODDT  = 1;
	var PODWT = 2;
	var PODDLV = 3;
	var PODCK= 4;
	var PODMCC = 5;	
	var PODCSO = 8;
	var PODHOT = 9;
	var POStype = "";
	switch(intPODNumber)
	{
		case PODFC:
			POStype = API.getLocalMsg("MSG_RECEIPT_FC");
			break;
		case PODDT:
			POStype = API.getLocalMsg("MSG_RECEIPT_DT");
			break;
		case PODWT:
			POStype = API.getLocalMsg("MSG_RECEIPT_WT");
			break;
		case PODDLV:
			POStype = API.getLocalMsg("MSG_RECEIPT_DLV");
			break;
		case PODCK:
			POStype = API.getLocalMsg("MSG_RECEIPT_CK");
			break;
		case PODMCC:
			POStype = API.getLocalMsg("MSG_RECEIPT_MCC");
			break;
		case PODCSO:
			POStype = API.getLocalMsg("MSG_RECEIPT_CSO");
			break;
		case PODHOT:
			POStype = API.getLocalMsg("MSG_RECEIPT_HOT");
			break;
		default:
			POStype = "";
	}

	return POStype;
}

/*helper function */
/* Get the localfamily groups defined in store.db
*
*RETURN : array of localfamily name and description (Gropup1 Best OF 
*/
function GetLocalFamily()
{
	var sectionFamily = xmlStoreDB.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="LocalFamilyGroups");

	var numberOfFamily = sectionFamily.Parameter.length();
	var arrayFamilyDesc = new Array();
	for(var i=0; i< numberOfFamily; i++)
	{
		var name = (sectionFamily.Parameter[i].@name).toUpperCase();
		var description = (sectionFamily.Parameter[i].@value).substring(0,8);
		arrayFamilyDesc.push({name:String(name), description:String(description)});
	}
	return arrayFamilyDesc;
	
}

//code for Portugal contest 
function generateContestCode(count, storeID, regID, codeDT)
{
	var lenStore = String(storeID).length;
	if (lenStore > 4) {
		// if storeID more than 4 characters, take the last 4 only
		storeID = storeID.substr(lenStore - 4, 4);
	}
	var currentDate=new Date(); 
	var year = currentDate.getFullYear();
	year =(year+"").substring(2);
	var month = API.setZerosOnLeft(Number(currentDate.getMonth())+1,2) ;
	var day = API.setZerosOnLeft(currentDate.getDate(),2);
	var hour = API.setZerosOnLeft(currentDate.getHours(),2);
	var minutes = API.setZerosOnLeft(currentDate.getMinutes(),2);
	var seconds = API.setZerosOnLeft(currentDate.getSeconds(),2);
    var preCode = year + month + day + hour + minutes + seconds+ API.setZerosOnLeft(storeID,4) + regID;
	API.dbg("uailde debug: before "+preCode);
	preCode = alterPosition(preCode, count, codeDT);
	API.dbg("uailde debug: after "+preCode);
	var code = changeCode(count, 0, codeDT);
	var pair = 0;
	var notPair = 0;
	
	var p1 = preCode[0]+""+preCode[1];
	notPair = Number(notPair) + Number(p1);
	code = code + changeCode(p1, count, codeDT);

	var p2 = preCode[2]+""+preCode[3]; 
	pair = Number(pair) + Number(p2);
	code = code+ changeCode(p2,count, codeDT);
	
	var p3 = preCode[4]+""+preCode[5];
	notPair = Number(notPair) + Number(p3);
	code = code + changeCode(p3, count, codeDT);

	var p4 = preCode[6]+""+preCode[7]; 
	pair = Number(pair) + Number(p4);
	code = code+ changeCode(p4,count, codeDT);
	
	var p5 = preCode[8]+""+preCode[9];
	notPair = Number(notPair) + Number(p5);
	code = code + changeCode(p5, count, codeDT);
	
	var p6 = preCode[10]+""+preCode[11]; 
	pair = Number(pair) + Number(p6);
	code = code+ changeCode(p6,count, codeDT);
	
	var p7 = preCode[12]+""+preCode[13];
	notPair = Number(notPair) + Number(p7);
	code = code + changeCode(p7, count, codeDT);
	
	var p8 = preCode[14]+""+preCode[15]; 
	pair = Number(pair) + Number(p8);
	code = code+ changeCode(p8,count, codeDT);

	var p9 = preCode[16]+""+preCode[17];
	notPair = Number(notPair) + Number(p9);
	code = code + changeCode(p9, count, codeDT);
	var checkDigit = toInt(fmod(toInt(pair/3) + toInt(notPair/2),10));
	API.dbg("uailde debug: "+count+ " " +checkDigit+ " "+pair+" "+notPair);
	//API.DbgMessageBox("checkDigit " + checkDigit);
	code = code + changeCode(checkDigit, count, codeDT);
	API.dbg("uailde code: "+code);
	return code;
	
}
function alterPosition(code, count, codeDT)
{
	var arrCountTable = new Array();
	if (codeDT) {
		arrCountTable[0] = "6c0h2d1e7b3a98f5g4";
		arrCountTable[1] = "gh0f5a39dc87e46b21";
		arrCountTable[2] = "97a32hdf8gcb4506e1";
		arrCountTable[3] = "1fb2768495hga0c3ed";
		arrCountTable[4] = "0f298ea47g53bdh16c";
		arrCountTable[5] = "89ea32g7hc560d4b1f";
		arrCountTable[6] = "e8023hdcg47a1bf659";
		arrCountTable[7] = "40g6cd283bha7e5f91";
		arrCountTable[8] = "ehcdgf03825796b1a4";
		arrCountTable[9] = "9524e0hcg8ba6df713";
		arrCountTable[10] = "fh7d1b5a3c4g9602e8";
		arrCountTable[11] = "fh5370d8e61bg2c49a";
		arrCountTable[12] = "h4912ef7b3a605c8dg";
		arrCountTable[13] = "c10265g78fbde349ah";
		arrCountTable[14] = "2d8af4951c0egh67b3";
		arrCountTable[15] = "5ag14h0832f6bdc9e7";
		arrCountTable[16] = "e2d3846570fgb19hca";
		arrCountTable[17] = "19574h6da0ef23gb8c";
		arrCountTable[18] = "8c0da9eb36g57fh421";
		arrCountTable[19] = "2bh8c4501agd396fe7";
		arrCountTable[20] = "b97aegd830146h2c5f";
		arrCountTable[21] = "cefg47810925b6a3hd";
		arrCountTable[22] = "e768gh24acf9b3d501";
		arrCountTable[23] = "8f1hcgb9e25d0763a4";
		arrCountTable[24] = "5e3bgca94h6df78120";
		arrCountTable[25] = "ea213c8dgh67fb5049";
		arrCountTable[26] = "946dcf8ge517ah23b0";
		arrCountTable[27] = "34b0d96f8c7ag15e2h";
		arrCountTable[28] = "bgfd82a0h71364c95e";
		arrCountTable[29] = "361a7f094eg5db2h8c";
		arrCountTable[30] = "h9e14bf38c6a275g0d";
		arrCountTable[31] = "fc18gebh07632d954a";
		arrCountTable[32] = "6895f2hcdb3eg74a10";
		arrCountTable[33] = "6e85cd129bfh30g74a";
		arrCountTable[34] = "d81e7cbg4395f6a02h";
		arrCountTable[35] = "a74bc1e08926fhd3g5";
		arrCountTable[36] = "251c0egafd46h3b897";
		arrCountTable[37] = "c594b217gh38adf0e6";
		arrCountTable[38] = "e2685d7g94f3ca1h0b";
		arrCountTable[39] = "e74g0af9dch65132b8";
		arrCountTable[40] = "12e8bd07654c9gfah3";
		arrCountTable[41] = "abc5f0329417de8h6g";
		arrCountTable[42] = "51h86c27d09bega34f";
		arrCountTable[43] = "d756b09gh21efa4c83";
		arrCountTable[44] = "gcd4b85219aef6h037";
		arrCountTable[45] = "a6bh0974g32dce8f51";
		arrCountTable[46] = "2g701d4b8e6ch93fa5";
		arrCountTable[47] = "c8f0a5b2914dh63eg7";
		arrCountTable[48] = "g128hf49b5a3de076c";
		arrCountTable[49] = "bd063825g9cae41hf7";
		arrCountTable[50] = "a2cgfhd6b51839e704";
		arrCountTable[51] = "018e9736d25cb4gafh";
		arrCountTable[52] = "2549f3h0c1d6bge78a";
		arrCountTable[53] = "8cdge45f239ha1067b";
		arrCountTable[54] = "f5d81ac74bg90362eh";
		arrCountTable[55] = "a41dch08g6e92f35b7";
		arrCountTable[56] = "f4bd62g7he5310a98c";
		arrCountTable[57] = "eg5bh10dc9f87a6342";
		arrCountTable[58] = "f5ehcg6917a0bd2384";
		arrCountTable[59] = "41f98ceda56023b7hg";
		arrCountTable[60] = "hgfbd2038165a74c9e";
		arrCountTable[61] = "348abe279h1df05g6c";
		arrCountTable[62] = "ab72cefd809g3514h6";
		arrCountTable[63] = "h8709cf5age41d23b6";
		arrCountTable[64] = "0hfe538219gda64c7b";
		arrCountTable[65] = "c9geh653d1b4287fa0";
		arrCountTable[66] = "h18d4g2a0b9e635cf7";
		arrCountTable[67] = "250g6c18bd7ae493hf";
		arrCountTable[68] = "g3b6179c4ad08hef25";
		arrCountTable[69] = "4891da6273eb0h5gcf";
		arrCountTable[70] = "80736eg2f14bchda95";
		arrCountTable[71] = "deg4h3abf2610c7985";
		arrCountTable[72] = "39cae04d2g7bh5618f";
		arrCountTable[73] = "9f2de04631cga57h8b";
		arrCountTable[74] = "c1e8h4d32a0gf7956b";
		arrCountTable[75] = "h4bd3a70gf1c256e98";
		arrCountTable[76] = "9f721adeb5hg6c0843";
		arrCountTable[77] = "56g7148c92fdhbea03";
		arrCountTable[78] = "f5390e412ghb68dac7";
		arrCountTable[79] = "830d9b6fa74g1e25hc";
		arrCountTable[80] = "d5fe142hag3607cb89";
		arrCountTable[81] = "de95f8bgc2a3670h41";
		arrCountTable[82] = "e2fgdb458a079h36c1";
		arrCountTable[83] = "50g39hd7f2cb6e14a8";
		arrCountTable[84] = "5dh89gfb7c3e26a140";
		arrCountTable[85] = "042f5a6e3g918bhd7c";
		arrCountTable[86] = "hdca0g34f285e1b679";
		arrCountTable[87] = "10g63b5ah49def728c";
		arrCountTable[88] = "ah7cd5g04b3e9f6182";
		arrCountTable[89] = "behga39d71f85406c2";
		arrCountTable[90] = "ahb89136g275f0c4de";
		arrCountTable[91] = "h356cdbe248f079a1g";
		arrCountTable[92] = "5fa089c236h4d1be7g";
		arrCountTable[93] = "16b7g0e59a4fc8h2d3";
		arrCountTable[94] = "d8h7346gb19fac025e";
		arrCountTable[95] = "093a2hed1b654fg8c7";
		arrCountTable[96] = "c7ebf3hg2d1849506a";
		arrCountTable[97] = "25c6f741ad9hbe83g0";
		arrCountTable[98] = "3eac249d805f7bh61g";
		arrCountTable[99] = "0975adh21c6384bgef";
	} else {
		arrCountTable[0] = "095c8ae3g276bh41fd"
		arrCountTable[1] = "9726cdeb4h1a5f80g3"
		arrCountTable[2] = "3e584f019c7bhg2a6d"
		arrCountTable[3] = "0ba968g7d1cfh54e32"
		arrCountTable[4] = "6cd23e705g1ahf948b"
		arrCountTable[5] = "7123c85ba0gh496efd"
		arrCountTable[6] = "7f30d6e8cg5a1942hb"
		arrCountTable[7] = "9a035g287d6eb1hfc4"
		arrCountTable[8] = "0b9a58g7ced6f3412h"
		arrCountTable[9] = "c57ehd641gb2f38a09"
		arrCountTable[10] = "g6d459af8c27e301bh"
		arrCountTable[11] = "ae384hg712c5b09d6f"
		arrCountTable[12] = "29bda3657f0h4c8ge1"
		arrCountTable[13] = "4fedac2bh5g1398076"
		arrCountTable[14] = "39hb4e2df7c61a5g08"
		arrCountTable[15] = "gabd4he328c19f6075"
		arrCountTable[16] = "8615acd03g9hb47f2e"
		arrCountTable[17] = "78g13e065b4c9hfda2"
		arrCountTable[18] = "ha8479f6c0beg52d31"
		arrCountTable[19] = "e29ad3f7c68h51g40b"
		arrCountTable[20] = "764a9hfg23815d0ebc"
		arrCountTable[21] = "gd8012b5h793caef64"
		arrCountTable[22] = "a59hf781d2cg463be0"
		arrCountTable[23] = "4d150g3b9ae2f768hc"
		arrCountTable[24] = "94bch2fdgae0836571"
		arrCountTable[25] = "ec81456gbf32ad097h"
		arrCountTable[26] = "168e2hb5d7a490cgf3"
		arrCountTable[27] = "e75614c38a92bh0fgd"
		arrCountTable[28] = "gac130b95728de64fh"
		arrCountTable[29] = "17e3f8bcd504a9h2g6"
		arrCountTable[30] = "6bcda14g0f9e5h3287"
		arrCountTable[31] = "f135bcd6h49ge8027a"
		arrCountTable[32] = "b568hc9gf37e4a1d20"
		arrCountTable[33] = "db6agh0f835e91c427"
		arrCountTable[34] = "3e584f012ac7bhg69d"
		arrCountTable[35] = "e4bfa8d3126c57hg09"
		arrCountTable[36] = "3edc961b5a4gf0287h"
		arrCountTable[37] = "b18h35a064f29gdce7"
		arrCountTable[38] = "3gh8176e4cf0bad529"
		arrCountTable[39] = "c54302a7d69b1hg8fe"
		arrCountTable[40] = "h5d70ag9b382f61ce4"
		arrCountTable[41] = "3fgh8417ecd052ab96"
		arrCountTable[42] = "4961d2ceg70habf385"
		arrCountTable[43] = "h39e40b12d76agf58c"
		arrCountTable[44] = "08edbhg61459fa23c7"
		arrCountTable[45] = "e9fgh5821406dca37b"
		arrCountTable[46] = "5bcda163gh9470f2e8"
		arrCountTable[47] = "8fg4d679h5aec03b21"
		arrCountTable[48] = "17f082cbd4a6h39e5g"
		arrCountTable[49] = "a7ed315c28h4b06fg9"
		arrCountTable[50] = "1e8g79hb2c4a5fd036"
		arrCountTable[51] = "h831794c05b2a6dgfe"
		arrCountTable[52] = "d193e6c57h4gb2f8a0"
		arrCountTable[53] = "hbce510f4392adg786"
		arrCountTable[54] = "ecf7bh01ga46829d53"
		arrCountTable[55] = "0eh76ga13bdf58c249"
		arrCountTable[56] = "1cab69h8dfe7g45230"
		arrCountTable[57] = "6029b81hdfag34ec57"
		arrCountTable[58] = "h5c1d69ab3g287f04e"
		arrCountTable[59] = "b18hed5ag6f902c473"
		arrCountTable[60] = "g720193bh48a6cf5ed"
		arrCountTable[61] = "bh071c5a3f42e968dg"
		arrCountTable[62] = "2d1fg73065bch49ea8"
		arrCountTable[63] = "a837cef250b1d69h4g"
		arrCountTable[64] = "h140beg68a37dfc529"
		arrCountTable[65] = "f6cgb9e4h237d801a5"
		arrCountTable[66] = "a5cd03gehb194768f2"
		arrCountTable[67] = "3ah640bef87dc5192g"
		arrCountTable[68] = "68b7034cfhae1925dg"
		arrCountTable[69] = "810heg6f39257dc4ba"
		arrCountTable[70] = "afg569hb3814d20c7e"
		arrCountTable[71] = "d6c790ebhg45af8231"
		arrCountTable[72] = "da59fghe824607bc31"
		arrCountTable[73] = "403ba2e57fh19cg68d"
		arrCountTable[74] = "5geadf3ch20b189674"
		arrCountTable[75] = "gac03b9572fde8614h"
		arrCountTable[76] = "ag5c6h24e9d130b8f7"
		arrCountTable[77] = "3b0965f28g71ac4ehd"
		arrCountTable[78] = "4d86ce9h5a7fgb0321"
		arrCountTable[79] = "067ef81cha4b93gd25"
		arrCountTable[80] = "4gh09528fe173cd6ab"
		arrCountTable[81] = "1hcg4563e92af0b8d7"
		arrCountTable[82] = "ceh6a9b13g87df2054"
		arrCountTable[83] = "cg0h392a4e1df685b7"
		arrCountTable[84] = "1def62h4cabg308975"
		arrCountTable[85] = "12h7da5g608fbe493c"
		arrCountTable[86] = "ef21d08937h64g5cba"
		arrCountTable[87] = "c078b1d5a46f32he9g"
		arrCountTable[88] = "f8e9b2gd1067cha453"
		arrCountTable[89] = "geh9d1230c68a4bf75"
		arrCountTable[90] = "c7b1h9a3f48ge065d2"
		arrCountTable[91] = "b423h1906c58agf7ed"
		arrCountTable[92] = "7d236e805h1agc9fb4"
		arrCountTable[93] = "fec0h756abgd394128"
		arrCountTable[94] = "17896f2hce50a3dbg4"
		arrCountTable[95] = "8hcagb0d139e2f4765"
		arrCountTable[96] = "bh67a0c4935e2gd1f8"
		arrCountTable[97] = "edbhg649af5827301c"
		arrCountTable[98] = "5hbc13af64e8907gd2"
		arrCountTable[99] = "4d0fab3597g86ceh12"
	}
	var i = 0;
	var newCode ="";
	var position = 0;

	while (i < 18) {
		var flag=  arrCountTable[count][i];
		position = flag;

		if (flag == "a") {
			position = 10;
		}
		if (flag == "b") {
			position = 11;
		}
		if (flag == "c") {
			position = 12;
		}
		if (flag == "d") {
			position = 13;
		}
		if (flag == "e") {
			position = 14;
		}
		if (flag == "f") {
			position = 15;
		}
		if (flag == "g") {
			position = 16;
		}
		if (flag == "h") {
			position = 17;
		}
		
		newCode = newCode+code[position];
		i++;
	}

	return newCode;
}

function changeCode(oldCode, position, codeDT)
{
	var arrChangeTable= new Array();
	if (codeDT) {
		arrChangeTable[0] = "DMEXQALWFPNHRZYGVCKUJ";
		arrChangeTable[1] = "WXKMAECNHVFUDLPZGQRYJ";
		arrChangeTable[2] = "JWEYAUNXQKDMVPHZGLRFC";
		arrChangeTable[3] = "DXMWCZHKEYVURQPJGLFNA";
		arrChangeTable[4] = "PYRHWJKUACDEQGXZNMVFL";
		arrChangeTable[5] = "RNMJPVDHFKACEXYWGLUZQ";
		arrChangeTable[6] = "YGHNWCRDQXZJLUFMPEKAV";
		arrChangeTable[7] = "AWHUZQDYLECKJNVRMPXGF";
		arrChangeTable[8] = "LFPJCHZKQWYRMUANDVXGE";
		arrChangeTable[9] = "NXKCUMRQGLHYAZPFVWEJD";
		arrChangeTable[10] = "JVUGQHREZWMCFPYLNAKXD";
		arrChangeTable[11] = "CHWUDYXNLRGMZEKVFJQPA";
		arrChangeTable[12] = "MNWFJHLPUYGDACVRKXEZQ";
		arrChangeTable[13] = "VMXNEADYLQURJWHGKCFPZ";
		arrChangeTable[14] = "JGNLAQFDPKZHYXVMECRUW";
		arrChangeTable[15] = "YPQWKHFZJXLCUGANVRMDE";
		arrChangeTable[16] = "PJDREZYMGCKAVUWQXHLFN";
		arrChangeTable[17] = "FDUNAQMCPXERLZYVGHJKW";
		arrChangeTable[18] = "VMDRHLAXNPYQUFCJGKEWZ";
		arrChangeTable[19] = "UMPJLVGNDCXFHAYERKZQW";
		arrChangeTable[20] = "DJGXMWCVPHQRZLYKNAFUE";
		arrChangeTable[21] = "UGFHRJCAKEYMXWDLNQVPZ";
		arrChangeTable[22] = "RJVYXPKMFCAHDGWLZUNQE";
		arrChangeTable[23] = "JVRDUFKWMHXCNEPGZALQY";
		arrChangeTable[24] = "PNHJDEQRKXGFWYULCZMAV";
		arrChangeTable[25] = "PUHDMGQLCRYKVNZFAJXEW";
		arrChangeTable[26] = "AVRWLQZMGNCFYPUDKJXHE";
		arrChangeTable[27] = "EWDQVFGLHYJNCXAPKRZUM";
		arrChangeTable[28] = "QPLGNUYKMRDCJFWAVHEZX";
		arrChangeTable[29] = "PZWLCUQRHYNDMEAFJKXGV";
		arrChangeTable[30] = "DNVQJCFGHZUYXLEAPWRKM";
		arrChangeTable[31] = "HWUMVCNRGYEQZPJLADKFX";
		arrChangeTable[32] = "ZUVYJMCAXLHPWEGNDRFKQ";
		arrChangeTable[33] = "HNEXYWZQUPMJDLKAGVCFR";
		arrChangeTable[34] = "JUGCMVXWYLERKPQAHFDZN";
		arrChangeTable[35] = "JDAXNHZLGUVWEKQMYFRPC";
		arrChangeTable[36] = "NJXAYRPWHFQKCDLUMZGVE";
		arrChangeTable[37] = "DGXNRKELVAJZCHWMFQYPU";
		arrChangeTable[38] = "EPGVRCXJLAMWDZYFUNQKH";
		arrChangeTable[39] = "CGDEXLWUQRMYKHFPNAJZV";
		arrChangeTable[40] = "WDGJVANKUCQHXMLFPYZER";
		arrChangeTable[41] = "KRXNHQDFPEMUGLACVYJZW";
		arrChangeTable[42] = "ZWYNHCJDEMRVUAQGXFPKL";
		arrChangeTable[43] = "EGCXVKWFHYQNMRPDZJUAL";
		arrChangeTable[44] = "LPVKAMWJYQZHCRENGFXDU";
		arrChangeTable[45] = "VQFLWYDMZAHUNGEPCJKXR";
		arrChangeTable[46] = "VFDHMJGZXLAQYUPNECRKW";
		arrChangeTable[47] = "CZYGWQXUDANERPMHFVJKL";
		arrChangeTable[48] = "MPXHFWVQNRJLEDKCGAYUZ";
		arrChangeTable[49] = "NDLUCXFGPKEJWQRHYAVZM";
		arrChangeTable[50] = "HJRVUCLKXDMNQZWAPFGYE";
		arrChangeTable[51] = "FCMWVKYJHURLPNQZADEGX";
		arrChangeTable[52] = "KPEWXUJCHLQDMYNVGARFZ";
		arrChangeTable[53] = "CGWFENUQVKPAXRDZLJYMH";
		arrChangeTable[54] = "PJLHMFCARKDEYUGXVNZWQ";
		arrChangeTable[55] = "RWHVKCZFXLUQYEADPJMNG";
		arrChangeTable[56] = "AWZMVDLRJQYFPEGHUNXCK";
		arrChangeTable[57] = "HCGNVWJKEMLDUFYZPRXQA";
		arrChangeTable[58] = "NHKMQZUCXARGEYFJWDPLV";
		arrChangeTable[59] = "GYKUPAXQCZLMJEWVFNRDH";
		arrChangeTable[60] = "WXRAKLDPYEUVQFNJZGMCH";
		arrChangeTable[61] = "NGPZEYLUDJVFKXWQCMRHA";
		arrChangeTable[62] = "AYMFGRZQDKCNWUEJLPHXV";
		arrChangeTable[63] = "GFQPRMNDHLZAKEWUYVJXC";
		arrChangeTable[64] = "QAYHVNZDWLEPFKJURMXCG";
		arrChangeTable[65] = "LFXGQRHWPEJUCDMVZAYKN";
		arrChangeTable[66] = "PDHMRKLAYZCWGFNEVUQJX";
		arrChangeTable[67] = "NRKGWAVEPYJXQHUFCMZLD";
		arrChangeTable[68] = "LFXGQRHWPEJUCDMVZAYKN";
		arrChangeTable[69] = "PDHMRKLAYZCWGFNEVUQJX";
		arrChangeTable[70] = "NRKGWAVEPYJXQHUFCMZLD";
		arrChangeTable[71] = "QGHLCUDVFXYNRJEWMKZAP";
		arrChangeTable[72] = "CVFPDHGAYRWUZEMQLNXKJ";
		arrChangeTable[73] = "XWZEMPFRVLCHKNGJAYQUD";
		arrChangeTable[74] = "RMGLYDKAEXVWPZJUNCFHQ";
		arrChangeTable[75] = "HCYKELZDAXUPFRVMWQNGJ";
		arrChangeTable[76] = "LDRVFXCMUZNYJQKGWPHAE";
		arrChangeTable[77] = "PWDANRZXVGMHELQKYCUJF";
		arrChangeTable[78] = "HQKXUYGEWVLZCMRJDAPNF";
		arrChangeTable[79] = "GAUXDKLYMPNCQVERFWZHJ";
		arrChangeTable[80] = "GHVWNMDPKJZAQXELRCUFY";
		arrChangeTable[81] = "PRMJHNFQCEVUYDKZAWXGL";
		arrChangeTable[82] = "UYDAZPVLGKXWECHQRMJNF";
		arrChangeTable[83] = "DZQWMJKHPGULRVFXYCEAN";
		arrChangeTable[84] = "LNJDGRVUXPMEYQFWKZACH";
		arrChangeTable[85] = "RCXUNLEFWZKDGVHAQYMPJ";
		arrChangeTable[86] = "ZKFLJXEQCYPNMVHGDARUW";
		arrChangeTable[87] = "RXYLPNDCJGHZMAEKQWVFU";
		arrChangeTable[88] = "XZKYFPUMWAEJLGHCNRQVD";
		arrChangeTable[89] = "PDGMVRHZUCYNXJLEAQWKF";
		arrChangeTable[90] = "HVEQKFYXGMCLWNJRPAUZD";
		arrChangeTable[91] = "ACPWYQVHDFUEKNJZRGLXM";
		arrChangeTable[92] = "RYQUGFEAZWCLXNMHVPDKJ";
		arrChangeTable[93] = "MGDRFZQNVKXWYLUHJEPCA";
		arrChangeTable[94] = "KXAHUGEZJCRFYDQPLMWVN";
		arrChangeTable[95] = "XRDJCHQZAEYWLVGMFUKNP";
		arrChangeTable[96] = "PDEFHMRJKNQVYCAZWXLUG";
		arrChangeTable[97] = "UJXNYGZKVRFLMPEWQHCAD";
		arrChangeTable[98] = "KLHZEXMRGUVJNDPQAYFCW";
		arrChangeTable[99] = "APEKMCZHGVDWUNFJQXYRL";
	} else {
		arrChangeTable[0] = "VRMXZQKDCJPGHWFELUNAY"
		arrChangeTable[1] = "UWNKEJRQDGZCPAFXYMLVH"
		arrChangeTable[2] = "CEHDUXYZKNRGMWVFALJQP"
		arrChangeTable[3] = "DNYXUCALEJMKQZPRGHWFV"
		arrChangeTable[4] = "HYKDLMPXAUQWJCGNFVERZ"
		arrChangeTable[5] = "DMXGEYNURVJQPCFAKLZHW"
		arrChangeTable[6] = "MQVPEJLXAUZGKFNHYWRCD"
		arrChangeTable[7] = "KQJGPNZRXYDLMFVCWEUHA"
		arrChangeTable[8] = "YQZACKNGEJLDXPVUHRWFM"
		arrChangeTable[9] = "MXGQNHYDCEURAZLPKVWJF"
		arrChangeTable[10] = "LNUMDHGJWYCRFEQZPVKXA"
		arrChangeTable[11] = "EUQRLPANWDVZXCMKHYFGJ"
		arrChangeTable[12] = "RKUVWEHAYDFXQJNLPCZGM"
		arrChangeTable[13] = "QPYZAXJMFHWKVCNRUGELD"
		arrChangeTable[14] = "CHPRUJFXNZQWMGVYEDALK"
		arrChangeTable[15] = "UFNVMKRDWACHPQGJYZXLE"
		arrChangeTable[16] = "NHPRUAFXVZCMEKJYGWLQD"
		arrChangeTable[17] = "UCLWNDHKZRYFJMEPGXVAQ"
		arrChangeTable[18] = "UCJMREQGVYPAHXDLNKWZF"
		arrChangeTable[19] = "QDLRKHPAYZEMNGVUWFJCX"
		arrChangeTable[20] = "FZJEAGLDXQPWUCVKYMNHR"
		arrChangeTable[21] = "DELQCHVUGYZNMXKWPFRJA"
		arrChangeTable[22] = "UGZXFHAJMWDLYVKENRCQP"
		arrChangeTable[23] = "PYZJKARGNEHQWFDVMUCXL"
		arrChangeTable[24] = "MKHQPALYCZFGNEJWDXRUV"
		arrChangeTable[25] = "HEXDLMNKAUWJYPCFGVRZQ"
		arrChangeTable[26] = "PWDFGCNXUKMJALREQHVYZ"
		arrChangeTable[27] = "FLECKJVRUYGZNXMPDWQAH"
		arrChangeTable[28] = "KWAFDRZJUVPNQEMLYCXGH"
		arrChangeTable[29] = "VGAXFEPMJWDNHLYKCRQUZ"
		arrChangeTable[30] = "MRVUZGHYJAPXQENLDWCKF"
		arrChangeTable[31] = "HYACPJFNMWXELGRUDKZQV"
		arrChangeTable[32] = "WXGEJVAMLZQRFPDNHYKCU"
		arrChangeTable[33] = "WJCYHZKDPXENLMGVAFUQR"
		arrChangeTable[34] = "KXMCJZDQLAYUPHWNEGVRF"
		arrChangeTable[35] = "PCLYZFGNEJWDMXURVHQAK"
		arrChangeTable[36] = "QKLZRNYXHUFAMVEPCDJWG"
		arrChangeTable[37] = "GJPNFLZMQXWKUHRVYEDAC"
		arrChangeTable[38] = "AMDRZQUGCPNJFLYVXKHWE"
		arrChangeTable[39] = "WXEPVZLUDMNJHKRYGFQCA"
		arrChangeTable[40] = "PDWRCALXHEQYJUFGNMZVK"
		arrChangeTable[41] = "VWDCUZLEKYHFXGJAMQRPN"
		arrChangeTable[42] = "ZGHRUYJAPXMQENLDWCKVF"
		arrChangeTable[43] = "HYGACPJFNMWXELDRUKZQV"
		arrChangeTable[44] = "XYJZGLWDPNMCRAVHKEUFQ"
		arrChangeTable[45] = "XZGFDPHNCLMJYAEQVKWUR"
		arrChangeTable[46] = "FNZAQGWEVXKUDJYRHMLPC"
		arrChangeTable[47] = "YAUPHNWZLDVFXMKQGCJER"
		arrChangeTable[48] = "LYQNXAREMVDPCWFJUZKHG"
		arrChangeTable[49] = "JRDHVKZGXANYWQMFULCEP"
		arrChangeTable[50] = "GXFZANHEMLVWDKCQRJYPU"
		arrChangeTable[51] = "GHUJQWFMZYLCERPKXANDV"
		arrChangeTable[52] = "AMVQJZLCHGYFRPENDKXWU"
		arrChangeTable[53] = "RQXEFWHYMVKNCLJAUGZPD"
		arrChangeTable[54] = "VKUMNCWRAZHPXJEFLDYGQ"
		arrChangeTable[55] = "CMAQZUVHWYGFNKXELPDRJ"
		arrChangeTable[56] = "NAHEWMYPVLRFUXDCQZKJG"
		arrChangeTable[57] = "LUVEFKWMCJZDQAYPHNXGR"
		arrChangeTable[58] = "JZHCDQKFPNXELYGUVWRAM"
		arrChangeTable[59] = "WDZQHJUKGMANYLEVPXRCF"
		arrChangeTable[60] = "ZLECKDNFRAHMQPGJUXYWV"
		arrChangeTable[61] = "XFQRWHYMLNCKJEVAGPZDU"
		arrChangeTable[62] = "MLNGDWCKJZRHVXAYFUPEQ"
		arrChangeTable[63] = "MVQJACLZGFRKENPHDUXYW"
		arrChangeTable[64] = "JNRPWEVGXLUMAKHDZFYQC"
		arrChangeTable[65] = "EWXZLFCKJVRUYAHDNQGMP"
		arrChangeTable[66] = "WPVGEUJXALRDKZFMQNCYH"
		arrChangeTable[67] = "JWEKDAHUQRXFGZMLNYCVP"
		arrChangeTable[68] = "GCLDJNFZURYEWXKVAHPQM"
		arrChangeTable[69] = "YXZRNGMWVKDFUHLPQECJA"
		arrChangeTable[70] = "KQZACYRNGXJEWDPMLHVFU"
		arrChangeTable[71] = "UFNVMJRDAGPCHXWYLEKQZ"
		arrChangeTable[72] = "UMYNVARKEDJQGPXWLFCZH"
		arrChangeTable[73] = "JQUVDKGYPARNHWFLCXEZM"
		arrChangeTable[74] = "GULJRWMZHPYKXQAENVFDC"
		arrChangeTable[75] = "EMYDPFVCRWJUQLHANGXZK"
		arrChangeTable[76] = "MEFHVNKURDACGJQLYZXPW"
		arrChangeTable[77] = "CNWRJALDPZFUGQEYMKHXV"
		arrChangeTable[78] = "EGMLDJXKNVUHQFPRWCAYZ"
		arrChangeTable[79] = "MZPELDFUNCAWRYQKGJXVH"
		arrChangeTable[80] = "WGRDEKLUFJNAHCYXZVPQM"
		arrChangeTable[81] = "ZEQNCDUGKFVMJPXAWYLHR"
		arrChangeTable[82] = "CMXWRZLDHJPYNAQFGVEUK"
		arrChangeTable[83] = "QMUZPJDCHFNGXLWKRAYVE"
		arrChangeTable[84] = "CELQHVUGYZNMXDKFRJWPA"
		arrChangeTable[85] = "LWYGUJRKMZHPVXNQAEFDC"
		arrChangeTable[86] = "QZAKLCUGPFHRXEWNVJDYM"
		arrChangeTable[87] = "DCZHGRPQWYFAKLUMJEVNX"
		arrChangeTable[88] = "MRDAPQGUYHLNEXKJVCZWF"
		arrChangeTable[89] = "KAYUWZHDLCFXJGRPVMNQE"
		arrChangeTable[90] = "CADWULZRYKPGEJXQVHFMN"
		arrChangeTable[91] = "HEZPUVWNKDJRQGCMAYFXL"
		arrChangeTable[92] = "MVXYUGNKCEWARLZDJFHPQ"
		arrChangeTable[93] = "XDWUCALJKPYZQFNEGVMHR"
		arrChangeTable[94] = "PAGMEFHVNKRCJQLYZWXUD"
		arrChangeTable[95] = "MPWALRFUEDHQJYNZVCXGK"
		arrChangeTable[96] = "EQJGPUKXFMWHVNYCLRDAZ"
		arrChangeTable[97] = "CKWAMDRZPUGNQJFYLEVXH"
		arrChangeTable[98] = "ZQRVGAXFEPMNUWDYKLJCH"
		arrChangeTable[99] = "CNWRKDMPAGUFXYLJVEQHZ"
	}
	var newCode = 0;
	if(position[0]== "0" && Number(position)!=0)
	{
		position = position.substring(1);
	}

	if(Number(oldCode) > 20)
	{
		secondCode = toInt(oldCode/21);
		oldCode = oldCode - 21* secondCode;
		if(oldCode[0] == "0" && Number(oldCode)!=0)
		{
			oldCode = oldCode.substring(1);
		}
		if(secondCode == 4)
		{
			secondCode = 6;
		}
		if(secondCode == 3)
		{
			secondCode = 4;
		}
		if(secondCode == 2) 
		{
			secondCode = 3;
		} 
		if(secondCode == 1)
		{
			secondCode = 2;
		}
		newCode = secondCode + arrChangeTable[position][Number(oldCode)];
		if(arrChangeTable[position][oldCode] ==undefined)
		{
			API.dbg("UAILDE "+oldCode);
		}
		
	}
	else
	{
		if(oldCode[0] =="0" && Number(oldCode) !=0)
		{
			oldCode = oldCode.substring(1);
		}
		newCode = arrChangeTable[position][Number(oldCode)];
		if(newCode ==undefined)
		{
			API.dbg("else UAILDE "+ oldCode);
		}
	}
	return newCode;
}

function fmod(x,y)
{
	if(x == y)
	{
		return 0;
	}
	if(x < y)
	   return x;
	 else  //eg 23.5 fmod 10
	 {
		var step= y;
		while(x >= y)
		{
			y =Number(y)+Number(step);
		}
		//eg y=30;
		return x - (y-step);  //23.5 -(30-10) =3.5	
	 }
}

/*
Author: Mihai Secareanu
Date: 22.10.2010
Description: this function is used for signing the portugal receipts
*/
function rsa_signReceipt(documentCode, storeID, posID, orderId, grossTotal, bussinessDay, actualDay, actualTime,  previousSignature, isRefund)
{
	API.dbg("rsa_signReceipt enter");
	PosSetSessionProperty("rsa_sign_ok", "0");  //reset this each time we enter the signing process , this will have value 1 if the sign was ok (needed for dual point duplicates)
	/*not used in anymore we take the data from the sale view
	var currentDate = new Date();
	var month = Number(currentDate.getMonth()) +1;
	if(month<10)
	{
		month = "0"+month;
	}
	var day = Number(currentDate.getDate());
	if(day<10)
	{
		day = "0"+day;
	}
	var hour = Number(currentDate.getHours());
	if(hour<10)
	{
		hour = "0"+hour;
	}
	var minutes = Number(currentDate.getMinutes());
	if( minutes<10)
	{
		minutes = "0"+minutes;
	}
	var seconds = Number(currentDate.getSeconds());
	if(seconds<10)
	{
		seconds = "0"+seconds;
	}
	*/
	invoicedate = actualDay.substring(0,4) + "-"+actualDay.substring(4,6) +"-"+ actualDay.substring(6,8);  //currentDate.getFullYear()+"-"+month+"-"+day;
	systemEntryDate = invoicedate+"T"+ actualTime.substring(0,2)+ ":"+ actualTime.substring(2,4)+ ":"+ actualTime.substring(4,6);  //hour+":"+minutes+":"+seconds;
	var storeIDSign = storeID.substring((storeID+"").length-4, (storeID+"").length);
	while((orderId+"").length <4)
	{
		orderId = "0"+orderId;
	}
	API.dbg("ordernumber "+storeIDSign+ " " + posID+ " " + orderId);
	
	//business day far aminute fara secunde
	var orderIdSign = bussinessDay+""+storeIDSign+""+posID+"/"+orderId+"T";  //put a T at the end because otherwise it will be converted into a number
	grossTotal = formatGrossTotal(grossTotal);
	API.dbg("PT  receipt signature: call with parameters");
	API.dbg("previous signature "+ previousSignature);
	//API.dbg("ordernumber "+storeID+ " " + posID+ " " + orderId);
	API.dbg("grossTotal "+ grossTotal);
	API.dbg("orderIdSign "+ +(orderIdSign+"").toString());
	API.dbg("documentCode "+ documentCode);
	API.dbg("systemEntryDate "+ systemEntryDate);
	API.dbg("invoicedate "+ invoicedate);
	
	if(previousSignature == null)
	{
		previousSignature ="0";  //must be 0 because if is empty it will not be passed as parameter (0 is not considered as a parameter in the dll for the previous signature
	}
	
	var result =npTCLEvalEx("RSA_Sign "+invoicedate+" "+systemEntryDate+" "+documentCode+" "+orderIdSign.substring(0, orderIdSign.length-1)+" "+grossTotal+" "+ previousSignature+" "+ privatekeyPath+ " "+ publickeyPath+" "+"1");
	
	API.dbg("sign result "+result);
	errorCode ="";
	
	if(result == null || result == "undefined"  || result == undefined)
	{ //the dll was not loaded 
		errorCode = "10";
	}
	else
	{
		errorCode = result.substr(0,2);
	}
	API.dbg("errorCode "+errorCode);
	switch (errorCode)
	{
		case "01":  //cannot find private file
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_NO_PRIVATEFILE"));
				return "-1";
			}
		case "02": 	 //new rsa object error
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_INV_PRIVATEKEY"));
				return "-1";
			}
		case "03": //PEM_read_RSAPrivateKey
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_INV_PRIVATEKEY"));
				return "-1";
			}
		case "04":	
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_SHA1_FAILED"));
				return "-1";
			}
		case "05":	
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_RSA_FAILED"));
				return "-1";
			}	
		case "06":
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_NO_PUBLICKEYFILE"));
				return "-1";
			}	
		case"07":	//new rsa object error
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_INV_PUBLICKEY"));
				return "-1";
			}
		case "08":	//pem_read_rsa_pubkey error
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_INV_PUBLICKEY"));
				return "-1";
			}	
		case "09":	
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_VERIFICATION_FAILED"));
				return "-1";
			}	
		case"10":	
			{
				PosShowMessage(API.getLocalMsg("ERROR_SIGN_GENERIC_ERROR"));
				return "-1";
			}	
		default:
				break;
	}		
	//everything is ok we must save the signature to tlog (return value 00;
	var code = systemEntryDate +";"+documentCode+ " "+orderIdSign.substring(0, orderIdSign.length-1)+";"+grossTotal;
	PosSetSessionProperty("messageCode", code,true);
	var resultTlog = result.substring(3,result.length);
	resultTlog = resultTlog.replace(/\n/gi,""); //remove new lines from the result
	
	if(isRefund == true)
	{
		PosSetSessionProperty("receipt_signature_refund", resultTlog, true);
	}
	else
	{
		PosSetSessionProperty("receipt_signature", resultTlog, true);
	}
	//build the string that we need to show on the receipt
	addLine(center(resultTlog[0]+""+resultTlog[10]+""+resultTlog[20]+""+resultTlog[30]));
	//addLine(center(API.getLocalMsg("SIGN_MESSAGE")));
	//addLine(center(certNumber));
	addLine();
	
	PosSetSessionProperty("rsa_sign_ok", "1"); //set this to know that the last rsa_sign was succesful
	return "0"; 
		
}

/*
Author: Mihai Secareanu 
Date: 25.10.2010
Description: auxiliar function required for formating the gross total according to the PT sign requires  ( dot decimal separator and no thousands separator)
*/
function formatGrossTotal(grossTotal)
{
	//first search for separator characters
	var separators= new Array();
	var j=0;
	for(var i=0; i< grossTotal.length; i++)
	{
		if(grossTotal[i] ==" ")
		{
			separators[j] = " ";
			j++;
		}
		else if(grossTotal[i] ==",")
		{
			separators[j] = ",";
			j++;
		}
		else if(grossTotal[i] ==".")
		{
			separators[j] = ".";
			j++;
		}
	}
	
	if(separators.length == 1  && separators[j] == ",")  //replace , with .
	{
		grossTotal = grossTotal.replace(",","."); //decimal separator
	}
	
	if(separators.length == 2)
	{
		grossTotal = grossTotal.replace(separators[0],""); //thousands separator
		grossTotal = grossTotal.replace(separators[1],"."); //decimal separator
	}
	return grossTotal;
}

/*
// @brief Prints Reduction-After-Tender receipt
// @param config - 
// @param data - 
// @param return - 
*/
function receiptRAT( config, data) 
{
    // Flaviu 20110504
    //API.DbgMessageBox("receiptRAT");
    return receptReduction( config, data, API.getLocalMsg("MSG_RECEIPT_REDUCTION_RAT"));
}

/*
/// @brief Prints Reduction-Before-Tender receipt
/// @param config - 
/// @param data - 
/// @param return - 
*/
function receiptRBT( config, data) 
{
    // Flaviu 20110504
    //API.DbgMessageBox("receiptRBT");
    return receptReduction( config, data, API.getLocalMsg("MSG_RECEIPT_REDUCTION_RBT"));
}

/*
/// @brief Gets the root view - used by function receptReduction
/// @param config - 
/// @param data - 
/// @param return - 
*/
function getReceiptView( config, data)
{
    // Flaviu 20110504
	if ( init( config, data, Array( "VIEW"), "RECPT") == 0)
    {
		// Part of feature PLE-194 : Auto condiment - By KFG
		lConsolidateACItems( "receipt");
        return rootView.View;
	}

    return null;
}

/*
/// @brief Gets the unit price
/// @param prodCode - product code
/// @param baseItemCode - base / main item code (ex. menu item)
/// @param view - current view
*/
function getUnitPrice( prodCode, baseItemCode, view)
{
    // Flaviu 20110504
    //API.DbgMessageBox("getUnitPriceSum baseItemCode=" + baseItemCode + " view=" + view);
    var result;
    var items = view.ItemView.( itemCode == baseItemCode);
    if ( items.length() == 0)
    {
        result = new BigDecimal( items.unitPrice);
    }
    else if ( items[0].productCode != prodCode)
    {
        // search for one specific product of meal
	    for each( var item in items)
        {
            if ( item.productCode == prodCode)
            {
                result = new BigDecimal( item.unitPrice);
                break;
            }
	    }
    }
    else
    {
        result = new BigDecimal( 0); // sum for meal items
	    for each( var item in items)
        {
            result = result.add( new BigDecimal( item.unitPrice));
	    }
    }

    //API.DbgMessageBox("getUnitPrice " + result);
    return result;
}

/*
/// @brief Prints the Reduction Receipt
/// @param config - 
/// @param data - 
/// @param name - name of the receipt
/// @param return - 
*/
function receptReduction( config, data, name)
{
    // Flaviu 20110504
    var result;
    var ctx = new SessionContext;
    var prodCode  = ctx.get( "reduction_product_code");
    //API.DbgMessageBox("receptReduction prodCode=" + prodCode);
    if ( prodCode != null)
    {
        getReceiptView( config, data);
        var hlp = new BusinessObjectHelper;
        var crtView = new XML( hlp.getCurrentView());
        var items = crtView.ItemView.( productCode == prodCode);       
        var item = ( items.length() > 0) ? items[ 0] : items;
        var sumUnitPrice = getUnitPrice( prodCode, item.itemCode, crtView);
        var productName = item.longName;
        var managerId = ctx.get( "reduction_manger_id");
        var reducedQuantity = ctx.get( "reduction_product_quantity");
        if ( reducedQuantity < 0)
        {
            reducedQuantity *= -1;
        }
        var reducedTotalPrice = sumUnitPrice.multiply( new BigDecimal( reducedQuantity));
        var posId = Number( crtView.@orderKey.substring( 3, 7));
        var halfCols = COLS / 2;
        var now = new Date();
        var date =  API.setZerosOnLeft( now.getDate(), 2)  + "/" + API.setZerosOnLeft( now.getMonth(), 2) + "/" + now.getFullYear() + " " +
                    API.setZerosOnLeft( now.getHours(), 2) + ":" + API.setZerosOnLeft( now.getMinutes(), 2) + ":" + API.setZerosOnLeft( now.getSeconds(), 2);
        // API.DbgMessageBox( "receptReduction p=" + prodCode + " q=" + reducedQuantity + " mid=" + managerId);
        // API.DbgMessageBox( "prod name=" + productName + "\nunit price=" + productUnitPrice + "\nquantity=" + reducedQuantity + "\nreduced total=" + reducedTotalPrice);
        // --------------------------------------------------------------------
        // McDonald's Zaandam
        // Kon. Julianaweg 45
        // 1502 DZ ZAANDAM
        // Tel: +31 75 631884
        addDefaultHeader();                                                                 
        // Reduction before/after total
        addLine( API.center( name, COLS));                                                    
        // Business Day:  22/04/2011
        addLine( API.center( API.getLocalMsg( "MSG_RECEIPT_BUSINESSDAY") + " " + API.formatDate( crtView.@businessDay, "MM/dd/yyyy"), COLS));
        // POS# 4
        addLine( API.center( API.getLocalMsg( toInt( posId) != 0 ? "MSG_RECEIPT_POS" : "MSG_RECEIPT_STORE") + "# " + posId, COLS));
        // ============================
        addLine( SEP_DL);
        // 4 Big Mac                        12.80
        addLine( API.setOnLeft( reducedQuantity + " " + productName, halfCols) + API.setOnRight( reducedTotalPrice, halfCols));
        // empty line
        addLine();
        if ( managerId != null)
        {
            // Manager ID        :                 90
            addLine( API.setOnLeft( API.getLocalMsg( "MSG_RECEIPT_MANAGER_ID"), halfCols) + ":" + API.setOnRight( managerId, halfCols));
            // Manager Name      :         OFOSUES J.
            addLine( API.setOnLeft( API.getLocalMsg( "MSG_RECEIPT_MANAGER_NAME"), halfCols) + ":" + API.setOnRight( hlp.getUserInfo( managerId, "1"), halfCols));
            // empty line
            addLine();
            ctx.set( "reduction_manger_id", null);
        }
        // Signature:____________________________
        addLine( API.getLocalMsg( "MSG_RECEIPT_SIGNATURE"));
        // empty line
        addLine();
        // ======================================
        // Printed on 22/04/2011 15:20:15
        // ======================================
	    addLine(SEP_DL);
	    addLine(center(API.getLocalMsg("MSG_RECEIPT_PRINTEDON") + " " + date));
	    addLine(SEP_DL);
        // --------------------------------------------------------------------  

        // clears all context reduction variables
        ctx.set( "reduction_product_code", null, false);
        ctx.set( "reduction_product_quantity", null, false);
        ctx.set( "reduction_clear_void_choice", null, false);
        ctx.set( "reduction_call_report", null, false);
        result = getResponse();
	}
    else
    {
        result = new StringBuffer()
    }

    return result;
}
/* signed aut version 9-9076
 * authority id = coe
 * authority level = 40
 * authority name = NewPOS COE developer
 * group = npi
 * validity = 2010-04-18
 * signature type = slash_star
 * time stamp (GMT) = Wed Jul 20 07:36:30 2011
 * certificate = 393735312d3739343700c582b20ed61e6f60e863e6a6a51ea663d824e28f6a5f42d1578795b8130c427d20bc6355e9178de262f5fc1660860266c8290010
 * =================================================================================================================================
*/
